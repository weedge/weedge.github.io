<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>æ—¶é—´é£˜è¿‡</title>
    <link>https://weedge.github.io/</link>
    <description>Recent content on æ—¶é—´é£˜è¿‡</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>zh-cn</language>
    <lastBuildDate>Sun, 26 Feb 2023 20:16:30 +0800</lastBuildDate>
    
        <atom:link href="https://weedge.github.io/index.xml" rel="self" type="application/rss+xml" />
    
    
    <item>
      <title>About</title>
      <link>https://weedge.github.io/about/</link>
      <pubDate>Sun, 20 Jan 2013 21:38:52 +0800</pubDate>
      
      <guid>https://weedge.github.io/about/</guid>
      
        <description>
&lt;link rel=&#34;stylesheet&#34; href=&#34;https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css&#34;&gt;
&lt;style type=&#34;text/css&#34;&gt;.dark-theme .aplayer{background:#212121}.dark-theme .aplayer.aplayer-withlist .aplayer-info{border-bottom-color:#5c5c5c}.dark-theme .aplayer.aplayer-fixed .aplayer-list{border-color:#5c5c5c}.dark-theme .aplayer .aplayer-body{background-color:#212121}.dark-theme .aplayer .aplayer-info{border-top-color:#212121}.dark-theme .aplayer .aplayer-info .aplayer-music .aplayer-title{color:#fff}.dark-theme .aplayer .aplayer-info .aplayer-music .aplayer-author{color:#fff}.dark-theme .aplayer .aplayer-info .aplayer-controller .aplayer-time{color:#eee}.dark-theme .aplayer .aplayer-info .aplayer-controller .aplayer-time .aplayer-icon path{fill:#eee}.dark-theme .aplayer .aplayer-list{background-color:#212121}.dark-theme .aplayer .aplayer-list::-webkit-scrollbar-thumb{background-color:#999}.dark-theme .aplayer .aplayer-list::-webkit-scrollbar-thumb:hover{background-color:#bbb}.dark-theme .aplayer .aplayer-list li{color:#fff;border-top-color:#666}.dark-theme .aplayer .aplayer-list li:hover{background:#4e4e4e}.dark-theme .aplayer .aplayer-list li.aplayer-list-light{background:#6c6c6c}.dark-theme .aplayer .aplayer-list li .aplayer-list-index{color:#ddd}.dark-theme .aplayer .aplayer-list li .aplayer-list-author{color:#ddd}.dark-theme .aplayer .aplayer-lrc{text-shadow:-1px -1px 0 #666}.dark-theme .aplayer .aplayer-lrc:before{background:-moz-linear-gradient(top, #212121 0%, rgba(33,33,33,0) 100%);background:-webkit-linear-gradient(top, #212121 0%, rgba(33,33,33,0) 100%);background:linear-gradient(to bottom, #212121 0%, rgba(33,33,33,0) 100%);filter:progid:DXImageTransform.Microsoft.gradient( startColorstr=&#39;#212121&#39;, endColorstr=&#39;#00212121&#39;,GradientType=0 )}.dark-theme .aplayer .aplayer-lrc:after{background:-moz-linear-gradient(top, rgba(33,33,33,0) 0%, rgba(33,33,33,0.8) 100%);background:-webkit-linear-gradient(top, rgba(33,33,33,0) 0%, rgba(33,33,33,0.8) 100%);background:linear-gradient(to bottom, rgba(33,33,33,0) 0%, rgba(33,33,33,0.8) 100%);filter:progid:DXImageTransform.Microsoft.gradient( startColorstr=&#39;#00212121&#39;, endColorstr=&#39;#cc212121&#39;,GradientType=0 )}.dark-theme .aplayer .aplayer-lrc p{color:#fff}.dark-theme .aplayer .aplayer-miniswitcher{background:#484848}.dark-theme .aplayer .aplayer-miniswitcher .aplayer-icon path{fill:#eee}&lt;/style&gt;
&lt;script src=&#34;https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js&#34;&gt;&lt;/script&gt;

&lt;script src=&#34;https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js&#34;&gt;&lt;/script&gt;&lt;meting-js auto=&#34;https://music.163.com/#/playlist?id=2154992214&#34; theme=&#34;#2980b9&#34;&gt;&lt;/meting-js&gt;
&lt;h4 id=&#34;äººç”Ÿ&#34;&gt;äººç”Ÿ&lt;/h4&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;â€œç‰©æ¥é¡ºåº”ï¼Œæœªæ¥ä¸è¿ï¼Œå½“æ—¶ä¸æ‚ï¼Œæ—¢è¿‡ä¸æ‹â€ &amp;ndash; æ›¾å›½è—©&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&amp;ldquo;Yesterday is a history, tomorrow is a mystery, only today is a gift, that is why we call it present. &amp;quot; &amp;ndash; åŠŸå¤«ç†ŠçŒ« (inner peace)&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;!-- raw HTML omitted --&gt;&lt;strong&gt;Hope is the good thing and maybe the best of things And no good things ever dies&lt;/strong&gt;&lt;!-- raw HTML omitted --&gt;
~ Andy Dufresne â€“ Shawshank Redemption&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h4 id=&#34;è§„å¾‹&#34;&gt;è§„å¾‹&lt;/h4&gt;
&lt;ol&gt;
&lt;li&gt;â€è·¯æ¼«æ¼«å…¶ä¿®è¿œå…®ï¼Œå¾å°†ä¸Šä¸‹è€Œæ±‚ç´¢â€œ &amp;ndash; å±ˆåŸã€Šç¦»éªšã€‹&lt;/li&gt;
&lt;li&gt;&amp;ldquo;ä¼—é‡Œå¯»ä»–åƒç™¾åº¦ã€‚è“¦ç„¶å›é¦–ï¼Œé‚£äººå´åœ¨ï¼Œç¯ç«é˜‘çŠå¤„&amp;rdquo; &amp;ndash; è¾›å¼ƒç–¾ã€Šé’ç‰æ¡ˆÂ·å…ƒå¤•ã€‹&lt;/li&gt;
&lt;li&gt;&amp;ldquo;é“ç”Ÿä¸€ï¼Œä¸€ç”ŸäºŒï¼ŒäºŒç”Ÿä¸‰ï¼Œä¸‰ç”Ÿä¸‡ç‰©&amp;rdquo; &amp;ndash; è€å­ã€Š&lt;a href=&#34;https://baike.baidu.com/item/%E9%81%93%E5%BE%B7%E7%BB%8F/327138&#34;&gt;é“å¾·ç»&lt;/a&gt;ã€‹&lt;/li&gt;
&lt;li&gt;&amp;ldquo;&lt;strong&gt;ä¸‡ç‰©ä¹‹å§‹ï¼Œå¤§é“è‡³ç®€ï¼Œè¡åŒ–è‡³ç¹&lt;/strong&gt;&amp;rdquo; &amp;ndash; è€å­ã€Š&lt;a href=&#34;https://baike.baidu.com/item/%E9%81%93%E5%BE%B7%E7%BB%8F/327138&#34;&gt;é“å¾·ç»&lt;/a&gt;ã€‹&lt;/li&gt;
&lt;/ol&gt;
</description>
      
    </item>
    
    <item>
      <title>OpenAIä½“éªŒ</title>
      <link>https://weedge.github.io/post/doraemon/openai/</link>
      <pubDate>Sun, 26 Feb 2023 20:16:30 +0800</pubDate>
      
      <guid>https://weedge.github.io/post/doraemon/openai/</guid>
      
        <description>&lt;iframe frameborder=&#34;no&#34; border=&#34;0&#34; marginwidth=&#34;0&#34; marginheight=&#34;0&#34; width=330 height=86 src=&#34;//music.163.com/outchain/player?type=2&amp;id=1428273917&amp;auto=1&amp;height=66&#34;&gt;&lt;/iframe&gt;



&lt;p&gt;OpenAI chatGPT å¾ˆç«ï¼Œä½“éªŒäº†ä¸€æŠŠï¼Œå“‡å“¦ä¹‹åï¼Œå¿ƒæƒ³è¿™ä¸ªä¼šæˆä¸ºå†…å®¹åˆ›é€ çš„è¾…åŠ©å·¥å…·ï¼Œç›®å‰å¤§éƒ¨åˆ†æ˜¯é€šè¿‡æœç´¢å¯»æ‰¾æ¥è§£ç­”éš¾é¢˜ï¼Œä»¥åå¯èƒ½æ”¶æ•›åˆ°å…·ä½“åº”ç”¨åœºæ™¯ä¸­äº†ï¼Œä¸è¿‡åº•å±‚å¯èƒ½è¿˜æ˜¯æŒæ¡å¤§æ•°æ®å…¬å¸æ¥æä¾›æ¨¡å‹èµ„æºã€‚&lt;/p&gt;
&lt;p&gt;æŒ‰é€‚ç”¨æ–¹ä½¿ç”¨å¤§è‡´åˆ†ä¸ºå¦‚ä¸‹åœºæ™¯ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;ä¼ä¸šToBå¸¸åº”ç”¨åœ¨SaasåŠå…¬è½¯ä»¶ï¼Œä½ä»£ç ï¼Œå®¢æœï¼Œç”Ÿç‰©åŒ»ç–—ï¼Œæ•™è‚²å½“ä¸­ï¼Œæ¯”å¦‚å¾®è½¯åŠå…¬è½¯ä»¶ï¼Œnotionç­‰ç›¸å…³ç¬”è®°è½¯ä»¶, é£ä¹¦ï¼Œé’‰é’‰ï¼Œä¼ä¸šå¾®ä¿¡ç­‰åŠå…¬èŠå¤©ï¼Œæ–‡æ¡£ï¼Œè§†å±ä¼šè®®ç­‰è½¯ä»¶ï¼Œä»¥åŠé“¶è¡Œæ™ºèƒ½å®¢æœï¼Œç”Ÿç‰©è›‹ç™½è´¨ç”Ÿæˆå’ŒåŸºå› æµ‹åºé¢†åŸŸç­‰ç­‰ï¼›ä»˜è´¹æ¨¡å¼ï¼Œå¼€æ”¾çš„æ¨¡å‹Passå¹³å°æä¾›æ¨¡å‹è®­ç»ƒï¼Œä»¥åŠå¾®è°ƒï¼Œäº¤äº’apiç­‰ï¼›æŒ‰ä½¿ç”¨èµ„æºå’Œæ›´å¥½çš„ä½“éªŒè´¨é‡é€Ÿåº¦æ¥æ”¶è´¹ï¼Œæ¯”å¦‚å›½å†…BATï¼›ä¸Šå±‚SaaSæœåŠ¡é€šè¿‡ç§Ÿæˆ·ä½¿ç”¨æ›´å¤šå®ç”¨ä¾¿åˆ©åŠŸèƒ½ç»„åˆ(ä¸‰æ–¹èµ„æºå’Œå†…éƒ¨èµ„æºæ•´åˆ)æ¥ä»˜è´¹ã€‚&lt;/li&gt;
&lt;li&gt;ToCä¸»è¦æ˜¯UGCçš„åœºæ™¯ï¼Œéšç€å¤šæ¨¡äº¤äº’åœºæ™¯ä¸‹çš„å¤§æ¨¡å‹å‡ºç°ï¼ŒAIGCæ–¹é¢çš„åº”ç”¨åº”è¯¥ä¼šæ›´å¤šï¼Œæ™®é€šç©å®¶æ›´å¤šï¼Œæƒ³è±¡ç©ºé—´åº”è¯¥ä¹Ÿæ›´å¤§ï¼Œè¿™å—æ¯”ToBè¦å¤§çš„å¤šï¼Œè€Œä¸”è¾ƒä¸ºé€šç”¨ï¼Œæœ‰UGCå¤§æ•°æ®å…¬å¸æ‰å¯èƒ½å‡ºå¤§æ¨¡å‹å§ï¼Œå¹¶ä¸”å¼€æ”¾ç»™ä¸Šæ¸¸åº”ç”¨ç©å®¶ä½¿ç”¨ï¼ŒæŒ‰åŠŸèƒ½ä½“éªŒè´¨é‡æ¥ä»˜è´¹ï¼›æ¯”å¦‚å›½å†…æŠ–éŸ³ï¼Œå¾®ä¿¡è¿™äº›appåº”ç”¨ï¼Œä»¥åŠå’Œä¼ä¸šåˆä½œçš„å®éªŒå®¤ã€‚å¯èƒ½è¿˜ä¼šæœ‰å…¶ä»–å¥½ç©çš„æ™ºèƒ½ç¡¬ä»¶å‡ºç°ã€‚&lt;/li&gt;
&lt;li&gt;å¯èƒ½è¿˜æœ‰æ•°æ®åº“æ–¹å‘ï¼Œç»“åˆç”¨æˆ·ç»å¸¸è¾“å…¥æŸ¥è¯¢ï¼Œç»“åˆæ•°æ®åº“äº§å“ç‰¹æ€§è¿›è¡Œæ™ºèƒ½è¡¥å¿çº é”™ä¼˜åŒ–æ¨èç­‰ï¼Œç±»ä¼¼tabnine, &lt;a href=&#34;https://docs.github.com/en/copilot&#34;&gt;Copilot&lt;/a&gt; è¿™ç±»å‹å·¥å…·ï¼Œåæ­£ä¸Šå±‚äº¤äº’ç±»çš„åœºæ™¯åº”è¯¥éƒ½å¯ä»¥æ¸—é€åˆ°ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;æ€»çš„æ¦‚æ‹¬ç©å®¶åˆ†ä¸º3ç§ï¼šåº•å±‚å¤§æ¨¡å‹ -&amp;gt; å®šåˆ¶åœºæ™¯ä¸‹çš„æ•°æ®æ¨¡å‹å¾®è°ƒ -&amp;gt; ä¸Šå±‚åº”ç”¨ç™¾èŠ±é½æ”¾ï¼›&lt;/p&gt;
&lt;p&gt;æƒ³è±¡ç©ºé—´æœ‰é™ï¼Œæœªæ¥æ˜¯æ€æ ·ï¼Œä»¥ä¸Šè¯´çš„å¯èƒ½æœ‰è¯¯:)ï¼Œanywayï¼ŒJust Do IT~&lt;/p&gt;
&lt;p&gt;PS: æ¢¯å­ä¸è¦é€‰æ‹©é¦™æ¸¯ï¼Œå¯ä»¥ä½¿ç”¨ç¾å›½çš„èŠ‚ç‚¹ï¼›openaiå¦‚ä½•æ³¨å†Œå¯ä»¥googleä¸€ä¸‹ï¼Œæ•™ç¨‹å¾ˆå¤šï¼Œæ³¨å†Œçš„é‚®ç®±ç”¨çš„gmailï¼Œä½¿ç”¨ &lt;a href=&#34;https://sms-activate.org/&#34;&gt;https://sms-activate.org/&lt;/a&gt; ä»£ç†æ¥å—çŸ­ä¿¡éªŒè¯ç ï¼Œå¯ä»¥é€‰æ‹©ğŸ‡®ğŸ‡³å°åº¦ã€‚&lt;/p&gt;
&lt;p&gt;chatGPTä½“éªŒæŒºæœ‰æ„æ€çš„ï¼Œå¦‚æœé—®ä¸€äº›ç†æ€§é€»è¾‘ç›¸å…³çš„case, æ¯”å¦‚è‡ªç„¶è¯­è¨€å¤„ç†æ€ä¹ˆå­¦ä¹ ç›¸å…³çš„è¯­ä¹‰ï¼Œå¯ä»¥ç»™å‡ºç›¸åŒçš„å‚è€ƒæ ‡å‡†ç­”æ¡ˆï¼Œé€»è¾‘å¥—è·¯æ»¡æ»¡ï¼Œè€Œä¸”è¿˜å¯ä»¥çº æ­£é”™åˆ«å­—æ„å›¾ï¼Œ(å…³äºå¦‚ä½•å­¦ä¹ çš„æ¨¡ç‰ˆå¥—è·¯ï¼Œå¯ä»¥ç”¨æ¥å»ºä¸ªæ€ç»´å¯¼å›¾ï¼Œç„¶åè‡ªå·±å¡«å……å­¦ä¹ å†…å®¹ç¬”è®°ï¼Œæˆ–è€…pptä¹‹ç±»çš„ç­‰ç­‰)ï¼›å¦‚æœé—®ä¸€äº›æ„Ÿæ€§çš„case, æ¯”å¦‚ä¸€æ®µæ­Œè¯ï¼Œä¸€é¦–è¯—æ­Œï¼Œä¼šç»™å‡ºç›¸åº”çš„åœºæ™¯ï¼Œæ–‡å­—è¿˜æŒºä¼˜ç¾çš„ï¼Œä¸€ä¸ªå­—ç»ï¼Œæ‡‚ä½ çš„ã€‚æ„Ÿè§‰AIå¾ˆé€‚åˆé€»è¾‘å¥—è·¯ï¼Œä½†æ˜¯äººç±»çš„æƒ…æ„Ÿæ˜¯å¾ˆéš¾ç¢ç£¨çš„å“ˆï¼Œäººå¿ƒéš¾æµ‹å˜›ï¼›å½“ç„¶æé—®ä¹Ÿæ˜¯æ¯”è¾ƒé‡è¦çš„ï¼Œä¹Ÿæœ‰äº›bad caseï¼Œæ¯”å¦‚ï¼š&amp;ldquo;ä»€ä¹ˆæ˜¯å¿«ä¹æ˜Ÿçƒ&amp;rdquo;ï¼Œéœ€è¦å¤šæ²Ÿé€šï¼Œè®©å®ƒç†è§£ä¸Šä¸‹æ–‡ï¼ˆåªèƒ½æ„ä¼šä¸èƒ½è¨€ä¼ -äººç±»ä¸“å±åŠŸèƒ½ï¼Œå®ƒå€’åƒä¸ªä¸‰ä½“äººï¼‰ï¼Œç»§ç»­è¿½é—®ï¼Œä¼šå‡ºç°ä¸€æœ¬æ­£ç»çš„é”™è¯¯å›ç­”ï¼Œæ˜æ˜æ˜¯èƒ¡æ­Œï¼Œèˆ’æ·‡ï¼Œå¼ è‰ºå…´ç­‰å°æœ‹å‹~&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://raw.githubusercontent.com/weedge/mypic/master/doraemon/openai-case.png&#34; alt=&#34;openai-case&#34;&gt;&lt;/p&gt;
&lt;p&gt;openaiä½¿ç”¨GPTæ¨¡å‹(å…¬å¼€ä½¿ç”¨çš„æ˜¯GPT-3ä»¥ä¸Š), åº•å±‚å…·ä½“å¯¹åº”çš„å¤§æ¨¡å‹å·²ç»è®­ç»ƒå¥½äº†ï¼Œæä¾›openAPIç»™åº”ç”¨å¼€å‘è€…æ¥è¿›è¡Œå¾®è°ƒæ¨¡å‹ä½¿ç”¨ã€‚&lt;/p&gt;
&lt;p&gt;ä½œä¸ºä¸€ä¸ªå¼€å‘è€…ï¼Œå½“ç„¶æƒ³åœ¨é€šè¿‡å¼€æ”¾çš„apiæ¥ä½¿ç”¨openaiæ¨¡å‹å•¦ï¼›å¦‚æœæ˜¯ç ”ç©¶äººå‘˜ï¼Œè™½ç„¶æœ¨æœ‰å¤§æ•°æ®å’ŒæœåŠ¡å™¨è®¡ç®—èµ„æºæ¥ç©ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨openaiå¼€æ”¾çš„GPT-3ä»¥åŠä»¥ä¸Šçš„æ¨¡å‹æ¥å¾®è°ƒã€‚&lt;/p&gt;
&lt;p&gt;ä»¥ä¸‹æ˜¯chatGPT å¯¹ä½¿ç”¨çš„å›ç­”(è¿™ä¸ªå°±ç›¸å½“äºæ˜¯æ™ºèƒ½å®¢æœåœºæ™¯)ï¼Œæä¾›çš„å¼€æ”¾çš„(text/image/audio/video)å¤šæ¨¡äº¤äº’apiä½¿ç”¨å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;GPT-3, GPT-3.5 &amp;hellip; æ¨¡å‹ï¼Œç”¨äºæ¨¡å‹å‚æ•°å¾®è°ƒï¼›æ–‡æœ¬è¡¥å…¨ï¼Œç¼–è¾‘ï¼›ä»¥åŠæœç´¢(ç›¸å…³æ€§æ’åº)ï¼Œèšç±»(ç›¸ä¼¼æ€§åˆ†ç»„)ï¼Œæ¨è(æ¨èç›¸å…³æ–‡æœ¬)ï¼Œå¼‚å¸¸æ£€æµ‹(è¯†åˆ«ç›¸å…³æ€§å¾ˆå°çš„å¼‚å¸¸å€¼)ï¼Œå¤šæ ·æ€§æµ‹è¯•(åˆ†æç›¸ä¼¼æ€§åˆ†å¸ƒ)ï¼Œåˆ†ç±»(æœ€ç›¸ä¼¼çš„æ ‡ç­¾åˆ†ç±»)ç­‰embeddingï¼Œé€šè¿‡å‘é‡åˆ—è¡¨è¡¨ç¤ºï¼Œè®¡ç®—æ–‡æœ¬ç›¸å…³æ€§(å‘é‡è·ç¦»)ï¼›ä¸»è¦ç”¨äºæ–‡æœ¬ç±»äº¤äº’ï¼Œä»¥åŠåŸºäºä¸Šä¸‹æ–‡èŠå¤©åœºæ™¯ï¼›&lt;/li&gt;
&lt;li&gt;Codex api é€šè¿‡æè¿°æ–‡æœ¬æç¤º&lt;strong&gt;Prompt&lt;/strong&gt;ç”Ÿæˆå¯¹åº”ä»£ç ï¼›è¿™ä¸ªæŒºé€‚åˆå¼€å‘äººå‘˜çš„ï¼Œå¯¹äºæ–°è¯­è¨€çš„æ–°æ‰‹ï¼Œç»“åˆideï¼Œè®°äº‹æœ¬é€šè¿‡Promptæç¤ºè¯è¯­æ¥ç”Ÿæˆç›¸å…³ä»£ç è¿˜æ˜¯æŒºçˆ½çš„ï¼Œè‡³å°‘ä¸ç”¨å»google æ¥å›æ‰¾ç¡®è®¤æ˜¯å¦æ˜¯éœ€è¦æ–¹æ¡ˆä»£ç ï¼Œæœç´¢åˆ™å¯ä»¥ç”¨äºå…œåº•æ–¹æ¡ˆï¼›&lt;/li&gt;
&lt;li&gt;DALL-E /2 api é€šè¿‡æè¿°æ–‡æœ¬æç¤º&lt;strong&gt;Prompt&lt;/strong&gt;ç”Ÿæˆå›¾ç‰‡æˆ–è€…ç¼–è¾‘åŸå§‹å›¾ç‰‡ ï¼›æ’ç”»ï¼Œè®¾è®¡å¸ˆ è¾…åŠ©ç±»å·¥å…·ï¼Œå¤§æ¦‚æ„æ€è‰å›¾ï¼›&lt;/li&gt;
&lt;li&gt;éŸ³é¢‘è½¬æ¢ä¸ºæ–‡æœ¬, ä½¿ç”¨å¼€æºå¤§å‹ v2 &lt;a href=&#34;https://openai.com/blog/whisper/&#34;&gt;Whisper æ¨¡å‹&lt;/a&gt;ã€‚ è¿™ä¸ªç”¨åœ¨ç¡¬ä»¶è®¾å¤‡ä¸ŠæŒºå¥½çš„ï¼Œç¡¬ä»¶æ“ä½œç³»ç»Ÿå¦‚æœæœ‰å¼€æ”¾å£å­å¯ä»¥å¼€å‘çš„è¯ï¼Œç›´æ¥å°±å¯ä»¥å¯¹æ¥ä¸Šèµ‹èƒ½äº†ã€‚å°†éŸ³é¢‘è½¬å½•æˆéŸ³é¢‘æ‰€ä½¿ç”¨çš„ä»»ä½•è¯­è¨€ï¼›å°†éŸ³é¢‘ç¿»è¯‘å¹¶è½¬å½•æˆè‹±æ–‡ï¼›&lt;/li&gt;
&lt;li&gt;è§†é¢‘ç±»çš„apiæš‚æ—¶è¿˜æ²¡æœ‰ï¼›&lt;/li&gt;
&lt;li&gt;éœ€è¦ç”Ÿæˆ &lt;a href=&#34;https://platform.openai.com/account/api-keys&#34;&gt;api-keys&lt;/a&gt; ç”¨äºapiæ¥å£è°ƒç”¨æ—¶ä½¿ç”¨ï¼›&lt;/li&gt;
&lt;li&gt;æä¾›äº†ä¸åŒå¼€å‘è¯­è¨€çš„ &lt;a href=&#34;https://platform.openai.com/docs/libraries/community-libraries&#34;&gt;clientåº“&lt;/a&gt; ï¼Œé»˜è®¤åŒ…æ‹¬ï¼špython,nodejs, è¿˜æœ‰å…¶ä»–è¯­è¨€ä¸‰æ–¹åŒ…ï¼Œæ¯”å¦‚golang: &lt;a href=&#34;https://github.com/sashabaranov/go-gpt3&#34;&gt;sashabaranov/go-gpt3&lt;/a&gt; ; ä»¥åŠapi é”™è¯¯è¯´æ˜ï¼›&lt;/li&gt;
&lt;li&gt;å¯ä»¥åœ¨ &lt;a href=&#34;https://platform.openai.com/playground&#34;&gt;playground&lt;/a&gt; ä¸­ç¼–è¾‘æè¿°æ–‡æœ¬æç¤º&lt;strong&gt;Prompt&lt;/strong&gt;å¯¹æ¨¡å‹æ¥å£è°ƒè¯•æµ‹è¯•ï¼Œè¿˜å¯ä»¥ç”¨è¯­éŸ³ç”Ÿæˆæè¿°æ–‡æœ¬(speech to text)ï¼Œé€‚åˆç«¯åˆ°ç«¯çš„è¯­éŸ³æ™ºèƒ½è®¾å¤‡ï¼›&lt;/li&gt;
&lt;li&gt;è€Œä¸”åœ¨ &lt;a href=&#34;https://platform.openai.com/examples&#34;&gt;openai examples&lt;/a&gt; ä¸­æä¾›å„ç§åº”ç”¨åœºæ™¯æ ·ä¾‹å’ŒQ&amp;amp;Aï¼›&lt;/li&gt;
&lt;li&gt;æ–‡æ¡£ä¸­è¿˜ä»‹ç»äº†æœ€ä½³å®è·µï¼š&lt;a href=&#34;https://platform.openai.com/docs/guides/safety-best-practices&#34;&gt;&lt;strong&gt;&lt;!-- raw HTML omitted --&gt;å®‰å…¨æœ€ä½³å®è·µ&lt;!-- raw HTML omitted --&gt;&lt;/strong&gt;&lt;/a&gt; å’Œ &lt;a href=&#34;https://platform.openai.com/docs/guides/production-best-practices&#34;&gt;&lt;strong&gt;&lt;!-- raw HTML omitted --&gt;ç”Ÿäº§æœ€ä½³å®è·µ&lt;!-- raw HTML omitted --&gt;&lt;/strong&gt;&lt;/a&gt; ï¼›&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;img src=&#34;https://raw.githubusercontent.com/weedge/mypic/master/doraemon/openai.png&#34; alt=&#34;openai&#34;&gt;&lt;/p&gt;
&lt;p&gt;åƒå›½å†…BATåœ¨è¿™å—ä¹Ÿæ—©å·²å¼€å§‹å¸ƒå±€äº†ï¼Œå¤§æ¦‚16,17å¹´å·¦å³å°±å·²ç»å¼€å§‹æ­å»ºæ™ºèƒ½å¹³å°åº•åº§ï¼Œåªä¸è¿‡è¢«å›½å¤–chatGPT â€œå¤§åŠ›å‡ºå¥‡è¿¹â€ ç»™å¼•çˆ†äº†ï¼›å¤§æ¨¡å‹çš„è®­ç»ƒéœ€è¦å¤§é‡çš„æ•°æ®å’Œå‚æ•°è°ƒæ•´ï¼Œè€Œä¸”éœ€è¦æ¶ˆè€—å¤§é‡æœåŠ¡å™¨è®¡ç®—èµ„æºï¼Œç‰¹åˆ«æ˜¯GPU ã€‚åƒç™¾åº¦çš„ &lt;a href=&#34;https://wenxin.baidu.com/&#34;&gt;æ–‡å¿ƒå¤§æ¨¡å‹&lt;/a&gt; ï¼ˆå¡‘é€ äº†ä¸€ä¸ªäºŒæ¬¡å…ƒcreateå¤§ä¼šï¼‰ ; ä¸­å›½ç´ æœ‰åŸºå»ºç‹‚é­”ä¹‹ç§°ï¼Œå¸Œæœ›èƒ½åœ¨ä¸­å›½ç‰ˆçš„&amp;quot;å¤§åŠ›ç¥ä¸¸&amp;quot;ä¸Šå‡ºå¥‡è¿¹ã€‚&lt;/p&gt;
&lt;p&gt;é™„å­¦ä¹ demo:&lt;/p&gt;
&lt;p&gt;openaiæä¾›äº†å¼€æ”¾æ¥å£ï¼Œå€Ÿè¿™ä¸ªAIä¸œé£ï¼Œæ¨è¿›ä¸‹å·¥ç¨‹æ–¹é¢çš„ç†Ÿç»ƒã€‚å¤§éƒ¨åˆ†æ˜¯dev/app/fin opså·¥ä½œï¼Œä¸šåŠ¡ç”±åº”ç”¨åœºæ™¯å’Œideaæ¥å†³å®šã€‚&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;æœ¬åœ°å‘½ä»¤è¡Œäº¤äº’&lt;/p&gt;
&lt;p&gt;ç›®çš„ï¼š&lt;!-- raw HTML omitted --&gt;å¿«é€Ÿç†Ÿæ‚‰openaiçš„è°ƒç”¨æ¥å£è¿›è¡Œå‚æ•°è®¾ç½®ï¼Œ æˆ–è€…å¯¹æ¨¡å‹è¿›è¡Œå¾®è°ƒè®­ç»ƒã€‚&lt;!-- raw HTML omitted --&gt;&lt;/p&gt;
&lt;p&gt;æºç åœ°å€ï¼š&lt;a href=&#34;https://github.com/weedge/craftsman/tree/main/doraemon/openai&#34;&gt;https://github.com/weedge/craftsman/tree/main/doraemon/openai&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-fallback&#34; data-lang=&#34;fallback&#34;&gt;git clone  https://github.com/weedge/craftsman &amp;amp;&amp;amp; cd craftsman/doraemon/openai
# cmd chat Q&amp;amp;A
export OPENAI_API_SK=
make run
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ol start=&#34;2&#34;&gt;
&lt;li&gt;
&lt;p&gt;webäº¤äº’(ä½¿ç”¨AWS &lt;a href=&#34;https://serverlessland.com/&#34;&gt;&lt;strong&gt;Serverless&lt;/strong&gt;&lt;/a&gt;  æ¶æ„æ­å»º)â˜ï¸æ™ºèƒ½åº•åº§+ä¸Šå±‚è½»/å¾®åº”ç”¨ï¼Œé€‚åˆå¿«é€Ÿè¿­ä»£çš„ä¸šåŠ¡ï¼Œjust code serverless biz logic handler func run on the could  &lt;a href=&#34;https://docs.aws.amazon.com/lambda/latest/dg/lambda-runtimes.html&#34;&gt;lambda runtime&lt;/a&gt;, like shell/c++/rust use &lt;a href=&#34;https://docs.aws.amazon.com/lambda/latest/dg/runtimes-walkthrough.html&#34;&gt;custom runtime&lt;/a&gt; ç‰¹åˆ«æ˜¯rust lambda runtime æ˜¯å¼€æºçš„ï¼Œå€¼å¾—å…³æ³¨ï¼Œå¯¹äºä½¿ç”¨è¿è¡Œæ—¶è¯­è¨€æ¥è¿›è¡Œæ— æœåŠ¡åŒ–å¹³å°åŒ–æ”¹é€ ï¼Œæ¯”å¦‚æ•°æ®æ¨¡å‹è®­ç»ƒæ˜¯çš„pipelineï¼Œæ•°æ®åº“cloudå¹³å°ï¼Œè€Œä¸”åœ¨awså†…éƒ¨å¤§é‡ä½¿ç”¨ï¼ŒRust å·²è¿…é€Ÿæˆä¸ºå¤§è§„æ¨¡æ„å»ºåŸºç¡€è®¾æ–½çš„å…³é”®è¯­è¨€ï¼Œ&lt;a href=&#34;https://firecracker-microvm.github.io/&#34;&gt;Firecracker&lt;/a&gt; æ˜¯ä¸€ç§å¼€æºè™šæ‹ŸåŒ–æŠ€æœ¯ï¼Œä¸º&lt;a href=&#34;https://aws.amazon.com/lambda/&#34;&gt;AWS Lambda&lt;/a&gt;å’Œå…¶ä»–æ— æœåŠ¡å™¨äº§å“æä¾›æ”¯æŒã€‚ awsæŠ½è±¡å‡ºæ¥çš„æœåŠ¡ï¼Œå¤æ‚éƒ½ç•™åœ¨åé¢ï¼Œç®€å•äº¤äº’ç•™ç»™ç”¨æˆ·ï¼ŒæŒ‰ä¸šåŠ¡åœºæ™¯è‡ªç”±ç»„è£…infrastructureã€‚æ™ºèƒ½åº•åº§éœ€è¦è¿™æ ·çš„æŠ½è±¡å·¥ç¨‹ç»™ä¸Šå±‚åº”ç”¨èµ‹èƒ½ã€‚&lt;/p&gt;
&lt;p&gt;ç›®çš„ï¼š &lt;!-- raw HTML omitted --&gt;ç†Ÿæ‚‰aws serverless äº‹ä»¶é©±åŠ¨æ•´ä½“æ¶æ„ï¼Œä»¥åŠæ•´ä½“lambda runtimeè¿è¡ŒåŸç†ï¼› åœ¨æ•°æ®åº“cloud æˆ–è€…å†…éƒ¨/å¤–éƒ¨passå¹³å°åœºæ™¯ä¸­ï¼Œæä¾›ç»™å®¢æˆ·ä½¿ç”¨serverlessæ¥å®ç°å…·ä½“ä¸šåŠ¡é€»è¾‘ã€‚awsåœ¨è¿™å—åšçš„æ·±å…¥ï¼Œé€šè¿‡å­¦ä¹ ä»¥ä¾¿è¿™äº›æ€æƒ³ç”¨äºå®é™…å·¥ä½œåœºæ™¯ä¸­ã€‚&lt;!-- raw HTML omitted --&gt;&lt;/p&gt;
&lt;p&gt;æºç åœ°å€ï¼š&lt;a href=&#34;https://github.com/weedge/craftsman/tree/main/cloud/aws/cdk/serverless-openai-chatbot&#34;&gt;https://github.com/weedge/craftsman/tree/main/cloud/aws/cdk/serverless-openai-chatbot&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;ä½¿ç”¨awsæ— æœåŠ¡lambdaç³»ç»Ÿè®¾æ–½æ¶æ„å¦‚ä¸‹ï¼š(pushæ¨¡å—å¼‚æ­¥å¯¹æ¥openai æ¨é€ç»“æœï¼Œè¿™é‡Œåˆ†ä¸åŒå¼€æ”¾è¯­è¨€ï¼Œæ˜¯ä¸ºäº†ç†Ÿæ‚‰lambdaå¯¹ä¸åŒè¯­è¨€runtimeï¼Œå…·ä½“è¯­è¨€æ ¹æ®å…¬å¸ç»„ç»‡åº”ç”¨åœºæ™¯è€Œå®šï¼Œä¸è¿‡ golangæŒºé€‚åˆpushæœåŠ¡çš„ï¼Œåˆ†channelæ²»ä¹‹)&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://raw.githubusercontent.com/weedge/mypic/master/doraemon/aws-serverless-openai-chatbot.drawio.png&#34; alt=&#34;architecture&#34;&gt;&lt;/p&gt;
&lt;p&gt;æŒ‰ç…§demo readme é…ç½®å¥½æ–‡ä»¶ï¼Œåç«¯æœåŠ¡å¯ä»¥ä¸€é”®éƒ¨ç½²è¿™ä¸ªdemoåº”ç”¨ï¼Œç¬¬ä¸€æ¬¡éƒ¨ç½²è¿‡ç¨‹å¯èƒ½æ¯”è¾ƒé•¿ï¼Œä¸»è¦æ˜¯ç”¨dockerå®¹å™¨æ¥CI lambdaä¸åŒè¯­è¨€æ‰€ä¾èµ–çš„åº“ï¼Œç”¨äºéƒ¨ç½²è‡³aws lambdaå®¹å™¨ç¯å¢ƒä¸­ï¼›å‰æ®µé™æ€èµ„æºåˆ™éœ€è¦æ‰‹åŠ¨é…ç½®, çœ‹ &lt;a href=&#34;https://docs.aws.amazon.com/AmazonS3/latest/userguide/HostingWebsiteOnS3Setup.html&#34;&gt;Tutorial: Configuring a static website on Amazon S3&lt;/a&gt; è¿™ä¸ªæ•™ç¨‹å°±å¯ä»¥ï¼Œé…ç½®å¥½åå¯æä¾›å¯¹è±¡å­˜å‚¨S3åŸŸåä½¿ç”¨ï¼Œå¦‚æœéœ€è¦é…ç½®å…¬å¸ç»„ç»‡åŸŸåï¼Œä½¿ç”¨CDNåŠ é€Ÿï¼Œåˆ™è‡ªè¡ŒæŸ¥çœ‹ç›¸å…³æ–‡æ¡£è§£å†³~&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;k8séƒ¨ç½²æ–¹å¼&lt;/p&gt;
&lt;p&gt;ç›®çš„ï¼š&lt;!-- raw HTML omitted --&gt;ç†Ÿæ‚‰k8sèµ„æºå·¥ç¨‹åŒ–éƒ¨ç½²ï¼Œäº†è§£æ•´ä½“ç”Ÿæ€ï¼Œ ç†Ÿç»ƒç›¸å…³å·¥å…·åŠåŸç†ã€‚&lt;!-- raw HTML omitted --&gt;&lt;/p&gt;
&lt;p&gt;æºç åœ°å€ï¼š&lt;a href=&#34;https://github.com/weedge/craftsman/tree/main/doraemon/ai-creator&#34;&gt;https://github.com/weedge/craftsman/tree/main/doraemon/ai-creator&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Tips: æŠ€æœ¯ä¸Š ä¸è¦æŠŠopenAI æ”¾å¤§äº†ï¼Œå¯¹äºå·¥ç¨‹åŒ–æ–¹é¢æ¥è¯´åªæ˜¯å¤šäº†ä¸€é¡¹æ–¹ä¾¿è°ƒè¯•çš„æ™ºèƒ½åŒ–æ¥å£ï¼ŒåŠ ä¸Šäº†æ›´å¤šçš„èµ‹èƒ½ï¼Œåº”ç”¨ä¸Šç©å‡ºèŠ±ï¼Œä¹Ÿåªæ˜¯åœ¨åŸæœ‰çš„äº§å“åŠŸèƒ½ä¸Šå®šåˆ¶åŒ–æ•°æ®åœºæ™¯æ¨¡å‹çš„å¾®è°ƒï¼Œè‡³äºç®—æ³•æ¨¡å‹ï¼Œå¤§éƒ¨åˆ†éƒ½å¼€æºï¼Œå…³é”®æ˜¯å¤§æ•°æ®åœºæ™¯ä¸‹çš„è®­ç»ƒèµ„æºè°ƒåº¦è°ƒä¼˜ï¼Œå‚ç›´é¢†åŸŸåœºæ™¯ä¸‹ç”¨äºå‚æ•°å¾®è°ƒè®­ç»ƒçš„æ•°æ®å§ï¼›å¯¹è¾¹ç¼˜æ¨¡å‹åœ¨è¾¹ç¼˜ç«¯è‡ªé€‚åº”å­¦ä¹ è°ƒä¼˜æ¨ç†ï¼Œå ç”¨å°‘çš„èµ„æºå°±èƒ½å¿«é€Ÿå“åº”çš„æ¨¡å‹ï¼Œå¯èƒ½ç¦»æœºå™¨äººæ™ºèƒ½ä¸è¿œäº†ã€‚&lt;/p&gt;
&lt;p&gt;é™„2 å¥½ç©çš„ç½‘ç«™ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;a href=&#34;https://www.notion.so/product/ai&#34;&gt;https://www.notion.so/product/ai&lt;/a&gt; ç¬”è®°æ€è·¯æ™ºèƒ½å¥—è·¯&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://www.midjourney.com/&#34;&gt;https://www.midjourney.com/&lt;/a&gt; éœ€è¦æ³¨å†ŒDiscord ä¸‹é€šè¿‡èŠå¤©å‘½ä»¤äº¤äº’ ç”Ÿæˆå›¾ç‰‡&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://piggy.to/&#34;&gt;https://piggy.to/&lt;/a&gt; uiè®¾è®¡å¸ˆ&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://soundraw.io/&#34;&gt;https://soundraw.io/&lt;/a&gt;  å¯»æ‰¾éŸ³ä¹çµæ„Ÿ&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://typeset.io/&#34;&gt;https://typeset.io/&lt;/a&gt; è¯»è®ºæ–‡ç¥å™¨&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;æºæ‰‹AIå‰è¡Œï¼Œæ•ˆç‡ä¼˜å…ˆï¼Œå‹ç¼©æ—¶é—´æˆæœ¬~&lt;/p&gt;
&lt;p&gt;é™„3 openai å®˜æ–¹æä¾›çš„åº”ç”¨ç±»äº§å“ï¼Œ&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;a href=&#34;https://chat.openai.com/&#34;&gt;chatGPT&lt;/a&gt;: è¿™ä¸ªå¤§å®¶éƒ½çŸ¥é“ä¸€æ¬¾ç«çˆ†åº”ç”¨äº§å“ï¼Œå‘ç°ç¤¾äº¤æ°¸è¿œæ˜¯äººç±»æ°¸æ’éœ€æ±‚å“ˆï¼›&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://labs.openai.com/&#34;&gt;DALLÂ·E 2&lt;/a&gt;ï¼šä½¿ç”¨æ–‡æœ¬ç”Ÿæˆå›¾ç‰‡ï¼›æœ‰ç›¸å…³çš„æç¤ºæ–‡æœ¬æ¨èï¼Œä½“éªŒæ›´å¥½ï¼›&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://www.yabble.com/&#34;&gt;yabble&lt;/a&gt;ï¼šæ•°æ®æ´å¯Ÿ(insights)ï¼Œè¿›è¡Œå½’çº³ç»ˆç»“ï¼Œå¹¶ä¸”å¸®åŠ©è§„åˆ’æ—¥ç¨‹ï¼Œæå‡ºå»ºè®®ï¼›å°åŠ©æ‰‹ç±»å‹å·¥å…·ï¼Œç½‘ä¸Šæœ‰ç”¨æ¥åˆ†æç‚’è‚¡çš„~ï¼›&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://openai.com/research/jukebox&#34;&gt;jukebox&lt;/a&gt;ï¼šä½¿ç”¨æ–‡æœ¬ç”ŸæˆéŸ³ä¹ï¼›æ¶‰åŠåˆ°éŸ³ä¹ç‰ˆæƒï¼Œæ•°æ®èµ„æºå¯èƒ½ä¸å¥½å¼„~ï¼›&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://waymark.com/&#34;&gt;waymark&lt;/a&gt;ï¼šä½¿ç”¨æ–‡æœ¬ç”Ÿæˆè§†é¢‘ï¼›ä¸»è¦ç”¨äºåˆ¶ä½œç”µè§†å¹¿å‘Šå’Œæ•°å­—è§†é¢‘å¹¿å‘Šï¼›&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;ä»¥ä¸Šåº”ç”¨äº§å“åº•å±‚å¤§æ¨¡å‹å¤§å¤šæ˜¯åŸºäºGPTç›¸å…³æœ€æ–°æ¨¡å‹ï¼Œå®˜ç½‘æä¾›çš„GPT-3: &lt;a href=&#34;https://openai.com/blog/gpt-3-apps&#34;&gt;https://openai.com/blog/gpt-3-apps&lt;/a&gt;ä»‹ç»ã€‚&lt;/p&gt;
&lt;h2 id=&#34;reference&#34;&gt;reference&lt;/h2&gt;
&lt;p&gt;&lt;a href=&#34;https://openai.com/product&#34;&gt;https://openai.com/product&lt;/a&gt; (å¯ä»¥å…ˆäº†è§£æ¸…æ¥šopenaiè‡ªå·±çš„åº”ç”¨æ ¹æºäº§å“ï¼Œåç»­æœ‰æ—¶é—´æ•´ç†ä¸‹ï¼Œæ„Ÿå…´è¶£çš„è¯ï¼Œç„¶åå»å‘æ•£å§)&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://openai.com/blog&#34;&gt;https://openai.com/blog&lt;/a&gt; (æŠ€æœ¯å®…ï¼Œå¯ä»¥è®¢é˜…ä¸€æ³¢)&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://platform.openai.com/docs/introduction/overview&#34;&gt;https://platform.openai.com/docs/introduction/overview&lt;/a&gt; (é€‚åˆå¼€å‘ï¼Œæ¨¡å‹å¾®è°ƒ)&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://platform.openai.com/examples/&#34;&gt;https://platform.openai.com/examples/&lt;/a&gt; (æ‰¾çµæ„Ÿ)&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://gpt3demo.com/&#34;&gt;https://gpt3demo.com/&lt;/a&gt; ï¼ˆæ½˜å¤šæ‹‰ç›’å­ï¼‰&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/mli/paper-reading#%E8%87%AA%E7%84%B6%E8%AF%AD%E8%A8%80%E5%A4%84%E7%90%86---transformer&#34;&gt;https://github.com/mli/paper-reading#è‡ªç„¶è¯­è¨€å¤„ç†-transformer&lt;/a&gt; (èƒŒåæ¨¡å‹åŸç†å¯¼è¯»)&lt;/p&gt;</description>
      
    </item>
    
    <item>
      <title>Go tips-ç¬”è®°: ä¼˜åŒ– 91-100 mistakes</title>
      <link>https://weedge.github.io/post/notions/go-tips/go-tips-12-optimizations/</link>
      <pubDate>Thu, 23 Feb 2023 10:26:23 +0800</pubDate>
      
      <guid>https://weedge.github.io/post/notions/go-tips/go-tips-12-optimizations/</guid>
      
        <description>&lt;h2 id=&#34;å¼•è¨€&#34;&gt;å¼•è¨€&lt;/h2&gt;
&lt;p&gt;åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œç¼–å†™å¯è¯»ã€æ¸…æ™°çš„ä»£ç æ¯”ç¼–å†™ç»è¿‡ä¼˜åŒ–ä½†æ›´å¤æ‚ã€æ›´éš¾ç†è§£çš„ä»£ç è¦å¥½ï¼Œä¸è¦è¿‡æ—©çš„ä¼˜åŒ–ã€‚å»ºè®®éµå¾ªè½¯ä»¶å·¥ç¨‹å¸ˆ Wes Dyer çš„è¿™å¥åè¨€ï¼š&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;em&gt;Make it correct, make it clear, make it concise, make it fast, in that order.&lt;/em&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;å¹¶ä¸æ„å‘³ç€ç¦æ­¢ä¸ºé€Ÿåº¦å’Œæ•ˆç‡ä¼˜åŒ–åº”ç”¨ç¨‹åº, äº†è§£å¹¶æŒæ¡è¿™äº›ä¼˜åŒ–ç‚¹ï¼Œä»¥å¤‡ä¸æ—¶ä¹‹éœ€ï¼›æ–‡ä¸­ç»™å‡ºäº†å¸¸è§çš„ä¼˜åŒ–æŠ€æœ¯ï¼›æœ‰äº›ç‰¹å®šäº Go å†…å­˜æ¨¡å‹ï¼Œå†…å­˜åˆ†é…ï¼ŒGPMè°ƒåº¦æ¨¡å‹ï¼›æœ‰äº›æ˜¯å…³äºäº†è§£ç¡¬ä»¶æœ‰åŠ©äºå†™å‡ºå¥½çš„ä»£ç (é€‚ç”¨äºä¸åŒè¯­è¨€)ï¼Œå…¶ä¸­ä¼šæœ‰ç¡¬ä»¶æ–¹é¢çš„æœ¯è¯­ï¼Œå¯ä»¥ç»“åˆwikiè¿›è¡Œå­¦ä¹ ï¼›&lt;/p&gt;
&lt;h2 id=&#34;ç¬”è®°&#34;&gt;ç¬”è®°&lt;/h2&gt;
&lt;h3 id=&#34;91ä¸äº†è§£-cpu-ç¼“å­˜&#34;&gt;91.ä¸äº†è§£ CPU ç¼“å­˜&lt;/h3&gt;
&lt;p&gt;&lt;em&gt;Mechanical sympathy(æœºæ¢°åŒæƒ…)&lt;/em&gt;  æ¥è‡ªä¸‰å±Š F1 ä¸–ç•Œå† å†› Jackie Stewart åˆ›é€ çš„ä¸€ä¸ªæœ¯è¯­&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;em&gt;You donâ€™t have to be an engineer to be a racing driver, but you do have to have mechanical sympathy.&lt;/em&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;ç®€è€Œè¨€ä¹‹ï¼Œå½“äº†è§£ç³»ç»Ÿçš„è®¾è®¡ç”¨é€”æ—¶ï¼Œæ— è®ºæ˜¯ F1 èµ›è½¦ã€é£æœºè¿˜æ˜¯è®¡ç®—æœºï¼Œéƒ½å¯ä»¥ä¸è®¾è®¡ä¿æŒä¸€è‡´ä»¥è·å¾—æœ€ä½³æ€§èƒ½ã€‚å¯¹ CPU ç¼“å­˜å·¥ä½œæ–¹å¼çš„æœºæ¢°åŒæƒ…å¯ä»¥å¸®åŠ©ä¼˜åŒ– Go åº”ç”¨ç¨‹åºã€‚&lt;/p&gt;
&lt;h4 id=&#34;cpuæ¶æ„-cpu-architecture&#34;&gt;CPUæ¶æ„ CPU architecture&lt;/h4&gt;
&lt;p&gt;&lt;img src=&#34;https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781617299599/files/Images/CH12_F01_Harsanyi.png&#34; alt=&#34;https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781617299599/files/Images/CH12_F01_Harsanyi.png&#34;&gt;&lt;/p&gt;
&lt;p&gt;ä¸Šå›¾ä¸ºç®€å•çš„Intel Core i5-7300u cpuæ¶æ„å›¾ï¼›&lt;a href=&#34;https://en.wikichip.org/wiki/intel/core_i5/i5-7300u&#34;&gt;https://en.wikichip.org/wiki/intel/core_i5/i5-7300u&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;æ¯ä¸ªç‰©ç†æ ¸å¿ƒï¼ˆCore0å’ŒCore1ï¼‰è¢«åˆ†æˆä¸¤ä¸ªé€»è¾‘æ ¸å¿ƒHyper-Threadingï¼ˆT0å’ŒT1ï¼‰ã€‚&lt;/p&gt;
&lt;p&gt;L1 ç¼“å­˜åˆ†ä¸ºä¸¤ä¸ªå­ç¼“å­˜ï¼šç”¨äºæ•°æ®çš„ L1D å’Œç”¨äºæŒ‡ä»¤çš„ L1Iï¼ˆæ¯ä¸ª 32 KBï¼‰ã€‚å½“ CPU æ‰§è¡Œåº”ç”¨ç¨‹åºæ—¶ï¼Œç¼“å­˜ä¸ä»…ä»…ä¸æ•°æ®ç›¸å…³ï¼Œå®ƒè¿˜å¯ä»¥ç¼“å­˜ä¸€äº›æŒ‡ä»¤ï¼ŒL2, L3å…¶åŸç†ç›¸åŒï¼šåŠ å¿«æ•´ä½“æ‰§è¡Œé€Ÿåº¦ã€‚&lt;/p&gt;
&lt;p&gt;å†…å­˜ä½ç½®ç¦»é€»è¾‘æ ¸å¿ƒè¶Šè¿‘ï¼Œè®¿é—®é€Ÿåº¦è¶Šå¿«ï¼ˆå‚è§&lt;a href=&#34;http://mng.bz/o29v&#34;&gt;http://mng.bz/o29v&lt;/a&gt;ï¼‰ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;L1ï¼šçº¦1ns&lt;/li&gt;
&lt;li&gt;L2ï¼šæ¯”L1æ…¢çº¦4å€&lt;/li&gt;
&lt;li&gt;L3ï¼šæ¯”L1æ…¢10å€å·¦å³&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;CPU ç¼“å­˜çš„ç‰©ç†ä½ç½®ä¹Ÿå¯ä»¥è§£é‡Šè¿™äº›å·®å¼‚ã€‚L1 å’Œ L2 æ˜¯ç§°ä¸º&lt;em&gt;on-die(ç‰‡ä¸Š)&lt;/em&gt;ï¼Œè¿™æ„å‘³ç€å®ƒä»¬ä¸å¤„ç†å™¨çš„å…¶ä½™éƒ¨åˆ†å±äºåŒä¸€å—ç¡…ç‰‡ã€‚ç›¸åï¼ŒL3 æ˜¯&lt;em&gt;off-die(ç‰‡å¤–)ã€‚&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;å¯¹äºä¸»å­˜å‚¨å™¨ï¼ˆRAMï¼‰ï¼Œå¹³å‡è®¿é—®é€Ÿåº¦æ¯” L1 æ…¢ 50 åˆ° 100 å€ã€‚å¯ä»¥è®¿é—®å­˜å‚¨åœ¨ L1 ä¸Šçš„å¤šè¾¾ 100 ä¸ªå˜é‡ï¼Œåªéœ€è®¿é—®ä¸€æ¬¡ä¸»å†…å­˜çš„ä»·æ ¼ã€‚å› æ­¤ï¼Œä½œä¸º Go å¼€å‘äººå‘˜ï¼Œæ”¹è¿›çš„ä¸€ç§é€”å¾„æ˜¯ç¡®ä¿åº”ç”¨ç¨‹åºä½¿ç”¨ CPU ç¼“å­˜ã€‚è¿›ä¸€ä¸äº†è§£å¯ä»¥æŸ¥çœ‹ä»¥ä¸‹è§†é¢‘ï¼š&lt;/p&gt;

&lt;div style=&#34;position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;&#34;&gt;
  &lt;iframe src=&#34;https://www.youtube.com/embed/vgPFzblBh7w&#34; style=&#34;position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;&#34; allowfullscreen title=&#34;YouTube Video&#34;&gt;&lt;/iframe&gt;
&lt;/div&gt;

&lt;h4 id=&#34;ç¼“å­˜è¡Œ-cache-line&#34;&gt;ç¼“å­˜è¡Œ Cache Line&lt;/h4&gt;
&lt;p&gt;ç¼“å­˜è¡Œçš„æ¦‚å¿µå¯¹äºç†è§£è‡³å…³é‡è¦ã€‚ä½†åœ¨ä»‹ç»å®ƒä»¬æ˜¯ä»€ä¹ˆä¹‹å‰ï¼Œäº†è§£ä¸ºä»€ä¹ˆéœ€è¦å®ƒä»¬ã€‚&lt;/p&gt;
&lt;p&gt;å½“è®¿é—®ç‰¹å®šçš„å†…å­˜ä½ç½®æ—¶(ä¾‹å¦‚ é€šè¿‡è¯»å–å˜é‡)ï¼Œåœ¨ä¸ä¹…çš„å°†æ¥å¯èƒ½ä¼šå‘ç”Ÿä»¥ä¸‹æƒ…å†µä¹‹ä¸€ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å°†å†æ¬¡å¼•ç”¨ç›¸åŒçš„ä½ç½®ï¼›æ—¶é—´å±€éƒ¨æ€§ã€‚&lt;/li&gt;
&lt;li&gt;é™„è¿‘çš„å†…å­˜ä½ç½®å°†è¢«å¼•ç”¨ï¼›ç©ºé—´å±€éƒ¨æ€§ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;ä¸¤è€…éƒ½æ˜¯å±€éƒ¨æ€§åŸåˆ™ &lt;em&gt;locality of reference&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;æ—¶é—´å±€éƒ¨æ€§æ˜¯éœ€è¦ CPU ç¼“å­˜çš„éƒ¨åˆ†åŸå› ï¼šåŠ é€Ÿå¯¹ç›¸åŒå˜é‡çš„é‡å¤è®¿é—®ã€‚ç”±äºç©ºé—´å±€éƒ¨æ€§ï¼ŒCPU ä¼šå¤åˆ¶ç¼“å­˜è¡Œå°†åŒ…æ‹¬å•ä¸ªå˜é‡çš„ç¼“å­˜è¡Œä»ä¸»å­˜å¤åˆ¶åˆ°é«˜é€Ÿç¼“å­˜ï¼Œå¹¶åŠ è½½åˆ°å¯„å­˜å™¨ä¸­æ‰§è¡Œã€‚&lt;/p&gt;
&lt;p&gt;é«˜é€Ÿç¼“å­˜è¡Œæ˜¯å›ºå®šå¤§å°çš„è¿ç»­å†…å­˜æ®µï¼Œé€šå¸¸ä¸º 64 å­—èŠ‚ï¼ˆ8 ä¸ª&lt;code&gt;int64&lt;/code&gt;å˜é‡ï¼‰ã€‚æ¯å½“ CPU å†³å®šç¼“å­˜ RAM ä¸­çš„å†…å­˜å—æ—¶ï¼Œå®ƒä¼šå°†å†…å­˜å—å¤åˆ¶åˆ°ç¼“å­˜è¡Œã€‚å› ä¸ºå†…å­˜æ˜¯æœ‰å±‚æ¬¡ç»“æ„çš„ï¼Œæ‰€ä»¥å½“CPUè¦è®¿é—®ä¸€ä¸ªç‰¹å®šçš„å†…å­˜ä½ç½®æ—¶ï¼Œå®ƒé¦–å…ˆæ£€æŸ¥L1ï¼Œç„¶åæ˜¯L2ï¼Œç„¶åæ˜¯L3ï¼Œæœ€åï¼Œå¦‚æœä½ç½®ä¸åœ¨é‚£äº›ç¼“å­˜ä¸­ï¼Œåˆ™åœ¨ä¸»å†…å­˜ä¸­ã€‚&lt;/p&gt;
&lt;p&gt;ä¸¾ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œ éå†å®¹é‡ä¸º16çš„sliceåˆ‡ç‰‡s []int64;  è¿™ä¸ªå†…å­˜åœ°å€è¿˜æ²¡åœ¨ç¼“å­˜ä¸­ï¼›ç¨‹åºå¼€å§‹éå†ï¼Œcpuå†³å®šç¼“å­˜è¿™ä¸ªs[0]è¿™ä¸ªå˜é‡ï¼Œä¼šå¤åˆ¶æ•´ä¸ªå†…å­˜å—å¤åˆ¶åˆ°ç¼“å­˜è¡Œï¼Œç¼“å­˜è¡Œä¸­åŒ…å«äº†8ä¸ªint64ï¼Œ0åˆ°7çš„æ•°æ®å°†ä¼šåœ¨cpu cacheä¸­å‘½ä¸­ï¼›è®¿é—®s[8]æ—¶åŒç†ï¼›è¿­ä»£16ä¸ªint64å…ƒç´ å¯¼è‡´2æ¬¡å¼ºåˆ¶ç¼“å­˜æœªå‘½ä¸­(&lt;em&gt;compulsory miss&lt;/em&gt;)å’Œ 14 æ¬¡ç¼“å­˜å‘½ä¸­ã€‚&lt;/p&gt;
&lt;p&gt;CPUç¼“å­˜ç­–ç•¥æœ‰ä¸ªå¤§è‡´çš„äº†è§£ï¼šæœ‰æ—¶ç¼“å­˜æ˜¯åŒ…å®¹æ€§çš„ï¼ˆä¾‹å¦‚ï¼ŒL2 æ•°æ®ä¹Ÿå­˜åœ¨äº L3 ä¸­ï¼‰ï¼Œæœ‰æ—¶ç¼“å­˜æ˜¯æ’ä»–æ€§çš„ï¼ˆä¾‹å¦‚ï¼ŒL3 ç§°ä¸ºå—å®³è€…ç¼“å­˜ï¼Œå› ä¸ºå®ƒåªåŒ…å«ä» L2 é€å‡ºçš„æ•°æ®ï¼‰ï¼›è¿™äº›ç­–ç•¥è¢« CPU ä¾›åº”å•†éšè—èµ·æ¥ï¼›å¤§è‡´äº†è§£ä¸‹å³å¯ã€‚&lt;/p&gt;
&lt;p&gt;å¦‚æœæ„Ÿå…´è¶£ï¼Œå¯ä»¥é€šè¿‡ &lt;strong&gt;&lt;a href=&#34;https://en.wikipedia.org/wiki/CPU_cache&#34;&gt;https://en.wikipedia.org/wiki/CPU_cache&lt;/a&gt;&lt;/strong&gt; è¿›ä¸€æ­¥äº†è§£ï¼Œæ¯”è¾ƒç¡¬æ ¸ã€‚&lt;/p&gt;
&lt;h4 id=&#34;ç»“æ„åˆ‡ç‰‡ä¸åˆ‡ç‰‡ç»“æ„-slice-of-structs-vs-struct-of-slices&#34;&gt;ç»“æ„åˆ‡ç‰‡ä¸åˆ‡ç‰‡ç»“æ„ Slice of structs vs. struct of slices&lt;/h4&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;kd&#34;&gt;type&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;Foo&lt;/span&gt; &lt;span class=&#34;kd&#34;&gt;struct&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
	&lt;span class=&#34;nx&#34;&gt;a&lt;/span&gt; &lt;span class=&#34;kt&#34;&gt;int64&lt;/span&gt;
	&lt;span class=&#34;nx&#34;&gt;b&lt;/span&gt; &lt;span class=&#34;kt&#34;&gt;int64&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;span class=&#34;kd&#34;&gt;type&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;Bar&lt;/span&gt; &lt;span class=&#34;kd&#34;&gt;struct&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
	&lt;span class=&#34;nx&#34;&gt;a&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;[]&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int64&lt;/span&gt;
	&lt;span class=&#34;nx&#34;&gt;b&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;[]&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int64&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;å¯¹[]Foo å’Œ Bar.a å®¹é‡é•¿åº¦ä¸º16çš„åˆ‡ç‰‡éå†ï¼Œéå†æ•°æ®ç»“æ„åˆ‡ç‰‡ æ¯” éå†åˆ‡ç‰‡ç»“æ„ æ…¢ï¼Œ å› ä¸ºcache lineçš„ç©ºé—´å±€éƒ¨æ€§åŸç†ï¼ŒåŠ è½½åˆ‡ç‰‡ç»“æ„æ›´ç´§å‡‘ï¼Œéœ€è¦æ›´å°‘çš„ç¼“å­˜è¡Œæ¥è¿­ä»£ï¼Œå¦‚å›¾æ‰€ç¤ºï¼š&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781617299599/files/Images/CH12_F04_Harsanyi.png&#34; alt=&#34;https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781617299599/files/Images/CH12_F04_Harsanyi.png&#34;&gt;&lt;/p&gt;
&lt;h4 id=&#34;å¯é¢„æµ‹æ€§-predictability&#34;&gt;å¯é¢„æµ‹æ€§ Predictability&lt;/h4&gt;
&lt;p&gt;è¦ç†è§£è¿™ä¸€ç‚¹ï¼Œå¿…é¡»äº†è§£è·¨æ­¥stridingçš„æ¦‚å¿µã€‚è·¨æ­¥ä¸ CPU å¦‚ä½•å¤„ç†æ•°æ®æœ‰å…³ã€‚å…±æœ‰ä¸‰ç§ä¸åŒç±»å‹çš„æ­¥å¹…(stride)&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;em&gt;å•ä½æ­¥å¹…Unit stride&lt;/em&gt;ï¼šå…¨éƒ¨æƒ³è¦è®¿é—®çš„å€¼æ˜¯è¿ç»­åˆ†é…çš„ï¼šä¾‹å¦‚ï¼Œåˆ‡ç‰‡[]int64å…ƒç´ ã€‚è¿™ä¸ªæ­¥å¹…å¯¹äº CPU æ¥è¯´æ˜¯å¯é¢„æµ‹çš„å¹¶ä¸”æ˜¯æœ€æœ‰æ•ˆçš„ï¼Œå› ä¸ºå®ƒéœ€è¦æœ€å°‘æ•°é‡çš„ç¼“å­˜è¡Œæ¥éå†å…ƒç´ ã€‚&lt;/li&gt;
&lt;li&gt;&lt;em&gt;æ’å®šæ­¥å¹…Constant stride&lt;/em&gt;ï¼šå¯¹äº CPU æ¥è¯´ä»ç„¶æ˜¯å¯é¢„æµ‹çš„ï¼šä¾‹å¦‚ï¼Œä¸€ä¸ªåˆ‡ç‰‡æ¯ä¸¤ä¸ªå…ƒç´ è¿­ä»£ä¸€æ¬¡ã€‚æ­¤æ­¥å¹…éœ€è¦æ›´å¤šç¼“å­˜è¡Œæ¥éå†æ•°æ®ï¼Œå› æ­¤å®ƒçš„æ•ˆç‡ä½äºå•ä½æ­¥å¹…ã€‚&lt;/li&gt;
&lt;li&gt;&lt;em&gt;éå•ä½æ­¥å¹…Non-unit stride&lt;/em&gt; ï¼šCPU æ— æ³•é¢„æµ‹çš„è·¨æ­¥ï¼šä¾‹å¦‚ï¼Œé“¾è¡¨æˆ–æŒ‡é’ˆåˆ‡ç‰‡ã€‚å› ä¸º CPU ä¸çŸ¥é“æ•°æ®æ˜¯å¦è¿ç»­åˆ†é…ï¼Œæ‰€ä»¥å®ƒä¸ä¼šè·å–ä»»ä½•ç¼“å­˜è¡Œã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img src=&#34;https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781617299599/files/Images/CH12_F06_Harsanyi.png&#34; alt=&#34;https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781617299599/files/Images/CH12_F06_Harsanyi.png&#34;&gt;&lt;/p&gt;
&lt;p&gt;ç”±äºä¸åŒçš„æ­¥å¹…å’Œç›¸ä¼¼çš„ç©ºé—´å±€éƒ¨æ€§ï¼Œè¿­ä»£é“¾è¡¨æ¯”å€¼çš„åˆ‡ç‰‡è¦æ…¢å¾—å¤šã€‚ç”±äºæ›´å¥½çš„ç©ºé—´å±€éƒ¨æ€§ï¼Œé€šå¸¸åº”è¯¥æ”¯æŒå•ä½æ­¥å¹…è€Œä¸æ˜¯æ’å®šæ­¥å¹…ã€‚ä½†æ˜¯å½“CPU éƒ½æ— æ³•é¢„æµ‹éå•ä½æ­¥é•¿ï¼Œæ— è®ºæ•°æ®å¦‚ä½•åˆ†é…ï¼Œéƒ½ä¼šæœ‰æ€§èƒ½ä¸Šçš„å½±å“ã€‚&lt;/p&gt;
&lt;p&gt;åˆ°ç›®å‰ä¸ºæ­¢ï¼Œå·²ç»è®¨è®ºäº† CPU ç¼“å­˜é€Ÿåº¦å¾ˆå¿«ä½†æ¯”ä¸»å†…å­˜å°å¾—å¤šã€‚å› æ­¤ï¼ŒCPU éœ€è¦ä¸€ç§ç­–ç•¥æ¥å°†å†…å­˜å—æå–åˆ°ç¼“å­˜è¡Œã€‚æ­¤ç­–ç•¥ç§°ä¸º&lt;em&gt;ç¼“å­˜æ”¾ç½®ç­–ç•¥&lt;/em&gt;ï¼Œå¹¶ä¸”ä¼šæ˜¾ç€å½±å“æ€§èƒ½ã€‚&lt;/p&gt;
&lt;h4 id=&#34;ç¼“å­˜æ”¾ç½®ç­–ç•¥-cache-placement-policy&#34;&gt;ç¼“å­˜æ”¾ç½®ç­–ç•¥ Cache placement policy&lt;/h4&gt;
&lt;p&gt;å½“ CPU å†³å®šå¤åˆ¶ä¸€ä¸ªå†…å­˜å—å¹¶å°†å…¶æ”¾å…¥ç¼“å­˜æ—¶ï¼Œå®ƒå¿…é¡»éµå¾ªç‰¹å®šçš„ç­–ç•¥ã€‚å‡è®¾ä¸€ä¸ª 32 KB çš„ L1D ç¼“å­˜å’Œä¸€ä¸ª 64 å­—èŠ‚çš„ç¼“å­˜è¡Œï¼Œå¦‚æœä¸€ä¸ªå—è¢«éšæœºæ”¾å…¥ L1Dï¼ŒCPU åœ¨æœ€åçš„æƒ…å†µä¸‹å°†ä¸å¾—ä¸è¿­ä»£ 512 ä¸ªç¼“å­˜è¡Œæ¥è¯»å–ä¸€ä¸ªå˜é‡ã€‚è¿™ç§ç¼“å­˜æ˜¯ç§°ä¸º&lt;em&gt;å®Œå…¨ç»“åˆ(fully associative)&lt;/em&gt;ã€‚&lt;/p&gt;
&lt;p&gt;ä¸ºäº†æé«˜ä» CPU ç¼“å­˜è®¿é—®åœ°å€çš„é€Ÿåº¦ï¼Œè®¾è®¡äººå‘˜åˆ¶å®šäº†æœ‰å…³ç¼“å­˜æ”¾ç½®çš„ä¸åŒç­–ç•¥ã€‚è·³è¿‡å†å²ï¼Œè®¨è®ºå½“ä»Šä½¿ç”¨æœ€å¹¿æ³›çš„ç­–ç•¥ï¼šé›†åˆå…³è”ç¼“å­˜ç­–ç•¥(&lt;em&gt;set-associative cache)&lt;/em&gt; ï¼Œå®ƒä¾èµ–ç¼“å­˜åˆ†åŒºã€‚&lt;/p&gt;
&lt;p&gt;å…·ä½“å‚è€ƒä»¥ä¸‹èµ„æ–™è¿›ä¸€æ­¥äº†è§£ï¼š&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://en.wikipedia.org/wiki/Cache_placement_policies&#34;&gt;https://en.wikipedia.org/wiki/Cache_placement_policies&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://lwn.net/Articles/250967/&#34;&gt;https://lwn.net/Articles/250967/&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://coolshell.cn/articles/20793.html&#34;&gt;https://coolshell.cn/articles/20793.html&lt;/a&gt; (ç»“åˆæ–‡ç« ä¸­&lt;a href=&#34;https://github.com/haoel/cpu-cache&#34;&gt;c++ä»£ç &lt;/a&gt;)&lt;/p&gt;
&lt;p&gt;ä¸ºäº†ä¾¿äºç†è§£ï¼Œä¸¾ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œæœ‰ä¸€ä¸ªçŸ©é˜µ äºŒç»´æ•°ç»„arr [4][32]int64  4è¡Œ32åˆ—å­˜æ”¾int64ï¼Œä»ä¸­å–å‡ºå‰8åˆ—res [4][8]int64ï¼›å‡è®¾L1Dç¼“å­˜å¤§å°512B,  ç¼“å­˜è¡Œcache line 64Bï¼Œ æœ‰8ä¸ªcache lineï¼›&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781617299599/files/Images/CH12_F07_Harsanyi.png&#34; alt=&#34;https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781617299599/files/Images/CH12_F07_Harsanyi.png&#34;&gt;&lt;/p&gt;
&lt;p&gt;å›¾ä¸­æ‰€ç¤ºè¯¥çŸ©é˜µå¦‚ä½•å­˜å‚¨åœ¨å†…å­˜ä¸­ã€‚è¿™é‡Œä½¿ç”¨äºŒè¿›åˆ¶è¡¨ç¤ºæ¥è¡¨ç¤ºå†…å­˜å—åœ°å€,ä¸ºç®€å•èµ·è§ï¼Œä½¿ç”¨ 13 ä½è¡¨ç¤ºä¸€ä¸ªåœ°å€ï¼›ç°è‰²å—ä»£è¡¨è¿­ä»£çš„å‰ 8 ä¸ªint64å…ƒç´ ï¼Œå…¶ä½™å—åœ¨è¿­ä»£æœŸé—´è¢«è·³è¿‡ã€‚æ¯ä¸ªä¸»å­˜å†…å­˜å—åŒ…å« 64 ä¸ªå­—èŠ‚ï¼Œå› æ­¤å—å†…åŒ…å« 8 ä¸ªint64å…ƒç´ ã€‚ç¬¬ä¸€ä¸ªå†…å­˜å—ä» 0x0000000000000 å¼€å§‹ï¼Œç¬¬äºŒä¸ªä» 0001000000000ï¼ˆäºŒè¿›åˆ¶ä¸º 512ï¼‰å¼€å§‹ï¼Œä¾æ­¤ç±»æ¨ã€‚ ä»¥åŠå¯ä»¥å®¹çº³ 8 è¡Œçš„ç¼“å­˜cacheã€‚&lt;/p&gt;
&lt;p&gt;ä½¿ç”¨é›†åˆå…³è”ç¼“å­˜ç­–ç•¥(&lt;em&gt;set-associative cache)&lt;/em&gt;ï¼Œç¼“å­˜è¢«åˆ’åˆ†ä¸ºé›†åˆã€‚å‡è®¾ç¼“å­˜æ˜¯N-wayé›†åˆå…³è”çš„(N=2)ï¼Œè¿™æ„å‘³ç€æ¯ä¸ªé›†åˆåŒ…å«ä¸¤è¡Œã€‚ä¸€ä¸ªå†…å­˜å—åªèƒ½å±äºä¸€ä¸ªé›†åˆï¼Œå…¶æ”¾ç½®ä½ç½®ç”±å…¶å†…å­˜åœ°å€å†³å®šã€‚è¦ç†è§£è¿™ä¸€ç‚¹ï¼Œå¿…é¡»å°†å†…å­˜å—åœ°å€åˆ†è§£ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å—&lt;em&gt;åç§»é‡&lt;/em&gt;æ˜¯åŸºäºå—å¤§å°ã€‚è¿™é‡Œçš„å—å¤§å°æ˜¯ 512 å­—èŠ‚ï¼Œ512 ç­‰äº 2^9ã€‚å› æ­¤ï¼Œåœ°å€çš„å‰ 9 ä½ä»£è¡¨å—åç§»é‡ï¼ˆboï¼‰ã€‚&lt;/li&gt;
&lt;li&gt;é›†åˆ&lt;em&gt;ç´¢å¼•&lt;/em&gt;è¡¨ç¤ºåœ°å€æ‰€å±çš„é›†åˆã€‚å› ä¸ºç¼“å­˜æ˜¯ä¸¤è·¯é›†åˆå…³è”çš„å¹¶ä¸”åŒ…å« 8 è¡Œï¼Œæ‰€ä»¥æœ‰ 8 / 2 = 4 ä¸ªé›†åˆã€‚æ­¤å¤–ï¼Œ4 ç­‰äº 2^2ï¼Œå› æ­¤æ¥ä¸‹æ¥çš„ä¸¤ä½ä»£è¡¨é›†åˆç´¢å¼• (si)ã€‚&lt;/li&gt;
&lt;li&gt;åœ°å€çš„å…¶ä½™éƒ¨åˆ†ç”±æ ‡è®°ä½ (tb) ç»„æˆã€‚ä¸ºç®€å•èµ·è§ä½¿ç”¨ 13 ä½è¡¨ç¤ºä¸€ä¸ªåœ°å€ã€‚è®¡ç®— tb ä½æ•° = 13 â€“ bo â€“ siã€‚è¿™æ„å‘³ç€å‰©ä¸‹çš„ä¸¤ä½ä»£è¡¨æ ‡è®°ä½ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;å‡è®¾è¯¥å‡½æ•°å¯åŠ¨å¹¶å°è¯•è¯»å–&lt;code&gt;s[0][0]&lt;/code&gt;å±äºåœ°å€ 0000000000000 çš„åœ°å€ã€‚ç”±äºè¯¥åœ°å€å°šæœªå‡ºç°åœ¨ç¼“å­˜ä¸­ï¼Œå› æ­¤ CPU è®¡ç®—å…¶é›†åˆç´¢å¼•å¹¶å°†å…¶å¤åˆ¶åˆ°ç›¸åº”çš„ç¼“å­˜é›†åˆã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781617299599/files/Images/CH12_F08_Harsanyi.png&#34; alt=&#34;https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781617299599/files/Images/CH12_F08_Harsanyi.png&#34;&gt;&lt;/p&gt;
&lt;p&gt;å¦‚å‰æ‰€è¿°ï¼Œ9 ä½è¡¨ç¤ºå—åç§»é‡ï¼šå®ƒæ˜¯æ¯ä¸ªå†…å­˜å—åœ°å€çš„æœ€å°å…¬å…±å‰ç¼€ã€‚ç„¶åï¼Œ2ä½è¡¨ç¤ºé›†åˆç´¢å¼•ã€‚åœ°å€ä¸º 0000000000000 æ—¶ï¼Œsi ç­‰äº 00ã€‚å› æ­¤ï¼Œè¯¥å†…å­˜å—è¢«å¤åˆ¶åˆ°Set 0ã€‚&lt;/p&gt;
&lt;p&gt;å½“å‡½æ•°ä» è¯»å–&lt;code&gt;s[0][1]&lt;/code&gt;åˆ°æ—¶&lt;code&gt;s[0][7]&lt;/code&gt;ï¼Œæ•°æ®å·²ç»åœ¨ç¼“å­˜ä¸­ã€‚CPU æ˜¯æ€ä¹ˆçŸ¥é“çš„ï¼ŸCPU è®¡ç®—å†…å­˜å—çš„èµ·å§‹åœ°å€ï¼Œè®¡ç®—é›†åˆç´¢å¼•å’Œæ ‡è®°ä½ï¼Œç„¶åæ£€æŸ¥Set 0 ä¸­æ˜¯å¦å­˜åœ¨ 00ã€‚&lt;/p&gt;
&lt;p&gt;æ¥ä¸‹æ¥å‡½æ•°è¯»å–&lt;code&gt;s[1][0]&lt;/code&gt;ï¼Œè¿™ä¸ªåœ°å€è¿˜æ²¡æœ‰è¢«ç¼“å­˜ã€‚å› æ­¤å¤åˆ¶å†…å­˜å— 0100000000000 æ—¶å‘ç”Ÿç›¸åŒçš„æ“ä½œ&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781617299599/files/Images/CH12_F09_Harsanyi.png&#34; alt=&#34;https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781617299599/files/Images/CH12_F09_Harsanyi.png&#34;&gt;&lt;/p&gt;
&lt;p&gt;è¯¥å†…å­˜çš„é›†åˆç´¢å¼•ç­‰äº 00ï¼Œå› æ­¤å®ƒä¹Ÿå±äºSet 0ã€‚ç¼“å­˜è¡Œè¢«å¤åˆ¶åˆ°Set 0 ä¸­çš„ä¸‹ä¸€ä¸ªå¯ç”¨è¡Œã€‚ç„¶åï¼Œå†æ¬¡ä» è¯»å–åˆ°å¯¼è‡´ç¼“å­˜&lt;code&gt;s[1][1]&lt;/code&gt;å‘½ä¸­&lt;code&gt;s[1][7]&lt;/code&gt;ã€‚&lt;/p&gt;
&lt;p&gt;ç°åœ¨äº‹æƒ…å˜å¾—æœ‰è¶£äº†ã€‚è¯¥å‡½æ•°è¯»å–&lt;code&gt;s[2][0]&lt;/code&gt;ï¼Œå¹¶ä¸”è¯¥åœ°å€ä¸å­˜åœ¨äºç¼“å­˜ä¸­ã€‚æ‰§è¡Œç›¸åŒçš„æ“ä½œ&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781617299599/files/Images/CH12_F10_Harsanyi.png&#34; alt=&#34;https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781617299599/files/Images/CH12_F10_Harsanyi.png&#34;&gt;&lt;/p&gt;
&lt;p&gt;é›†åˆç´¢å¼•å†æ¬¡ç­‰äº 00ã€‚ä½†æ˜¯ï¼Œ Set0 å·²æ»¡ï¼ŒCPU ä¼šæ›¿æ¢ç°æœ‰ç¼“å­˜è¡Œä¹‹ä¸€ä»¥å¤åˆ¶å†…å­˜å— 1000000000000ã€‚&lt;/p&gt;
&lt;p&gt;ç¼“å­˜æ›¿æ¢ç­–ç•¥(&lt;a href=&#34;https://en.wikipedia.org/wiki/Cache_replacement_policies&#34;&gt;Cache replacement policies&lt;/a&gt;)å–å†³äº CPUï¼Œä½†å®ƒé€šå¸¸æ˜¯ä¼ª LRU ç­–ç•¥ï¼ˆçœŸæ­£çš„ LRU [æœ€è¿‘æœ€å°‘ä½¿ç”¨] ä¼šå¤ªå¤æ‚è€Œæ— æ³•å¤„ç†ï¼‰ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå‡è®¾å®ƒæ›¿æ¢äº†ç¬¬ä¸€ä¸ªç¼“å­˜è¡Œï¼š0000000000000ã€‚å½“è¿­ä»£ç¬¬ 3 è¡Œæ—¶ä¼šé‡å¤è¿™ç§æƒ…å†µï¼šå†…å­˜åœ°å€ 1100000000000 ä¹Ÿæœ‰ä¸€ä¸ªç­‰äº 00 çš„é›†åˆç´¢å¼•ï¼Œå¯¼è‡´æ›¿æ¢ç°æœ‰çš„ç¼“å­˜è¡Œã€‚&lt;/p&gt;
&lt;p&gt;ç°åœ¨ï¼Œå‡è®¾åŸºå‡†æµ‹è¯•æ‰§è¡Œå‡½æ•°ï¼Œå…¶ä¸­ä¸€ä¸ªåˆ‡ç‰‡æŒ‡å‘ä»åœ°å€ 0000000000000 å¼€å§‹çš„ç›¸åŒçŸ©é˜µã€‚æ¯æ¬¡åŸºå‡†æµ‹è¯•ï¼Œå½“å‡½æ•°è¯»å–æ—¶ï¼Œ&lt;code&gt;s[0][0]&lt;/code&gt;åœ°å€ä¸åœ¨ç¼“å­˜ä¸­ï¼›è¯¥å—å·²è¢«æ›¿æ¢ã€‚&lt;/p&gt;
&lt;p&gt;åŸºå‡†æµ‹è¯•å°†å¯¼è‡´æ›´å¤šçš„ç¼“å­˜æœªå‘½ä¸­ï¼Œè€Œä¸æ˜¯ä»ä¸€ä¸ªæ‰§è¡Œåˆ°å¦ä¸€ä¸ªæ‰§è¡Œä½¿ç”¨ CPU ç¼“å­˜ã€‚è¿™ç§ç±»å‹çš„ç¼“å­˜æœªå‘½ä¸­ç§°ä¸º*å†²çªæœªå‘½ä¸­conflict missï¼›*å¦‚æœæœªå¯¹ç¼“å­˜è¿›è¡Œåˆ†åŒºï¼Œåˆ™ä¸ä¼šå‘ç”Ÿæœªå‘½ä¸­ã€‚è¿­ä»£çš„æ‰€æœ‰å˜é‡éƒ½å±äºä¸€ä¸ªé›†åˆç´¢å¼•ä¸º00çš„å†…å­˜å—ã€‚å› æ­¤ï¼Œåªä½¿ç”¨ä¸€ä¸ªç¼“å­˜é›†åˆï¼Œè€Œä¸æ˜¯åˆ†å¸ƒåœ¨æ•´ä¸ªç¼“å­˜ä¸­ã€‚&lt;/p&gt;
&lt;p&gt;ä¹‹å‰è®¨è®ºäº†æ­¥å¹…&lt;em&gt;stride&lt;/em&gt;çš„æ¦‚å¿µï¼Œ CPU å¦‚ä½•éå†æ•°æ®ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œè¿™ä¸ªæ­¥å¹…æ˜¯ç§°ä¸º*ä¸´ç•Œæ­¥å¹…critical strideï¼›*å®ƒå¯¼è‡´è®¿é—®å…·æœ‰ç›¸åŒé›†åˆç´¢å¼•çš„å†…å­˜åœ°å€ï¼Œå­˜å‚¨åˆ°ç›¸åŒçš„ç¼“å­˜é›†åˆä¸­ã€‚&lt;/p&gt;
&lt;p&gt;Intel å¤§å¤šæ•°å¤„ç†å™¨çš„å­˜æ”¾æ•°æ®çš„L1Déƒ½æ˜¯32KBï¼Œ8-Way ç»„ç›¸è”ï¼ŒCache Line æ˜¯64 Bytesã€‚&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;32KBå¯ä»¥åˆ†æˆï¼Œ32KB / 64 = 512 æ¡ Cache Lineã€‚&lt;/li&gt;
&lt;li&gt;å› ä¸ºæœ‰8 Wayï¼Œäºæ˜¯ä¼šæ¯ä¸€Way æœ‰ 512 / 8 = 64 æ¡ Cache Lineã€‚&lt;/li&gt;
&lt;li&gt;äºæ˜¯æ¯ä¸€è·¯å°±æœ‰ 64 x 64 = 4096 Byts çš„å†…å­˜ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;å›åˆ°å‰é¢&lt;a href=&#34;https://weedge.github.io/post/go-tips/go-tips-11-testing/#89%E7%BC%96%E5%86%99%E4%B8%8D%E5%87%86%E7%A1%AE%E7%9A%84%E5%9F%BA%E5%87%86&#34;&gt;#89&lt;/a&gt; çœŸå®ç¤ºä¾‹ä¸­ï¼Œä½¿ç”¨ä¸¤ä¸ªå‡½æ•°&lt;code&gt;calculateSum512&lt;/code&gt;å’Œ&lt;code&gt;calculateSum513&lt;/code&gt;ã€‚åŸºå‡†æµ‹è¯•åœ¨ 32 KB 8-way set-associative L1D cacheä¸Šæ‰§è¡Œï¼Œæ€»å…± 64 ç»„ã€‚å› ä¸ºç¼“å­˜è¡Œæ˜¯ 64 å­—èŠ‚ï¼Œæ‰€ä»¥æ¯ä¸€è·¯æ­¥é•¿ç­‰äº 64 Ã— 64 å­—èŠ‚ = 4 KBï¼›ä»£è¡¨512 ä¸ª&lt;code&gt;int64&lt;/code&gt;ç±»å‹å…ƒç´ ã€‚å› æ­¤ï¼Œè¾¾åˆ°äº† 512 åˆ—çŸ©é˜µçš„&lt;em&gt;ä¸´ç•Œæ­¥å¹…critical stride&lt;/em&gt;ï¼Œç¼“å­˜åˆ†å¸ƒå¾ˆå·®(&lt;em&gt;å†²çªæœªå‘½ä¸­conflict miss&lt;/em&gt;)ã€‚åŒæ—¶ï¼Œå¦‚æœçŸ©é˜µåŒ…å« 513 åˆ—ï¼Œåˆ™ä¸ä¼šå¯¼è‡´&lt;em&gt;ä¸´ç•Œæ­¥å¹…&lt;/em&gt;ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆè§‚å¯Ÿåˆ°ä¸¤ä¸ªåŸºå‡†ä¹‹é—´å­˜åœ¨å¦‚æ­¤å·¨å¤§å·®å¼‚çš„åŸå› ã€‚è¿™ä¸ªåŒæ ·é€‚ç”¨äºåœ¨intel CPUæ¶æ„ä¸Šè¿è¡Œçš„å…¶ä»–è¯­è¨€ã€‚&lt;/p&gt;
&lt;p&gt;æ€»ä¹‹ï¼Œå¿…é¡»æ„è¯†åˆ°ç°ä»£ç¼“å­˜æ˜¯åˆ†åŒºçš„ã€‚æ ¹æ®æ­¥å¹…ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹åªä½¿ç”¨ä¸€ç»„ï¼Œè¿™å¯èƒ½ä¼šæŸå®³åº”ç”¨ç¨‹åºæ€§èƒ½å¹¶å¯¼è‡´å†²çªæœªå‘½ä¸­ã€‚è¿™ç§æ­¥å¹…ç§°ä¸ºä¸´ç•Œæ­¥å¹…ã€‚å¯¹äºæ€§èƒ½å¯†é›†å‹åº”ç”¨ç¨‹åºï¼Œåº”è¯¥é¿å…å…³é”®æ­¥éª¤æ¥å……åˆ†åˆ©ç”¨ CPU ç¼“å­˜ã€‚&lt;/p&gt;
&lt;p&gt;tips: åº”è¯¥æ³¨æ„åŸºå‡†æµ‹è¯•çš„ç»“æœåœ¨ä¸åŒåº•å±‚CPUæ¶æ„è€Œæœ‰æ‰€ä¸åŒã€‚æ³¨æ„å¼€å‘æµ‹è¯• å’Œ ç”Ÿäº§ç¯å¢ƒä¸‹çš„CPUæ¶æ„ä¸€è‡´ï¼Œå¦‚æœæœ‰å¯¹è®¡ç®—å¯†é›†å‹çš„è°ƒä¼˜ï¼Œæœ€å¥½åœ¨ç”Ÿäº§ç¯å¢ƒå¾…éƒ¨ç½²çš„æœºå™¨ä¸Šéƒ½è¿›è¡ŒåŸºå‡†æµ‹è¯•ä¸€ä¸‹ã€‚&lt;/p&gt;
&lt;h3 id=&#34;92ç¼–å†™å¯¼è‡´ä¼ªå…±äº«false-sharingçš„å¹¶å‘ä»£ç &#34;&gt;92.ç¼–å†™å¯¼è‡´ä¼ªå…±äº«(false sharing)çš„å¹¶å‘ä»£ç &lt;/h3&gt;
&lt;p&gt;ç”±äºå¤šæ ¸å¤„ç†å™¨cpuä¹‹é—´ç‹¬ç«‹çš„L1/L2 cacheï¼Œä¼šå‡ºç°cache lineä¸ä¸€è‡´çš„é—®é¢˜ï¼Œä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæœ‰ç›¸å…³åè®®æ¨¡å‹ï¼Œå¸¸ç”¨MESIåè®®ï¼ŒMESI é€šè¿‡ è¿™ä¸ªç½‘ç«™æ¨¡æ‹Ÿæ›´ç›´è§‚çš„äº†è§£ &lt;a href=&#34;https://www.scss.tcd.ie/Jeremy.Jones/VivioJS/caches/MESIHelp.htm&#34;&gt;https://www.scss.tcd.ie/Jeremy.Jones/VivioJS/caches/MESIHelp.htm&lt;/a&gt;ï¼›ä¸ºäº†ä¿è¯ä¸€ä¸ªcoreä¸Šä¿®æ”¹çš„cache lineæ•°æ®åŒæ­¥åˆ°å…¶ä»–coreçš„cache lineä¸Šï¼Œåˆ™éœ€è¦MESIåè®®æ¥ä¿è¯ï¼Œå¦‚æœåŒä¸€ä¸ªcache lineä¸Šæœ‰ä¸ªä¸¤ä¸ªå˜é‡sum1 å’Œ sum2 ä¹‹é—´è™½ç„¶æ²¡æœ‰ç›¸äº’ä¾èµ–é€»è¾‘ï¼Œä½†æ˜¯å½“ä¿®æ”¹sum1 æˆ–è€…sum2 æ—¶ï¼Œéœ€è¦åŒæ­¥åŒä¸€å—cache lineçš„å†…å®¹ï¼Œå¯¼è‡´ å³ä½¿æ²¡æœ‰ç›¸äº’å…³ç³»çš„å˜é‡åœ¨åŒä¸€cache lineä¸­ï¼Œ éœ€è¦å½¼æ­¤å…±äº«åŒæ­¥ï¼Œä»è€Œå‡ºç°æ‰€è¯´çš„&lt;em&gt;ä¼ªå…±äº« flase sharing&lt;/em&gt;ã€‚ä¼ªå…±äº«å› ä¸ºcache lineçš„åŒæ­¥ä¼šå¸¦æ¥ä¸€äº›cpu æ—¶é’Ÿå‘¨æœŸçš„æ€§èƒ½æŸå¤±ã€‚&lt;/p&gt;
&lt;p&gt;äº†è§£ä¼ªå…±äº«çš„æƒ…å†µï¼ŒçŸ¥é“å¦‚ä½•ç ´è§£äº†ï¼Œç›´æ¥è®©sum1å’Œsum2 æ”¾ç½®åœ¨ä¸åŒçš„cache lineå°±å¯ä»¥ï¼›æ¯”å¦‚ä¸€ä¸ªç»“æ„ä½“ä¸­sum1å’Œsum2 çš„å­˜æ”¾ç»“æ„ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;kd&#34;&gt;type&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;Result2&lt;/span&gt; &lt;span class=&#34;kd&#34;&gt;struct&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
	&lt;span class=&#34;nx&#34;&gt;sumA&lt;/span&gt; &lt;span class=&#34;kt&#34;&gt;int64&lt;/span&gt;
	&lt;span class=&#34;nx&#34;&gt;_&lt;/span&gt;    &lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;56&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;byte&lt;/span&gt; &lt;span class=&#34;c1&#34;&gt;// a cache line 64B 
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;	&lt;span class=&#34;nx&#34;&gt;sumB&lt;/span&gt; &lt;span class=&#34;kt&#34;&gt;int64&lt;/span&gt; &lt;span class=&#34;c1&#34;&gt;// sumB in other cache line
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;è¿˜æœ‰ä¸€ç§è§£å†³æ–¹æ¡ˆæ˜¯é‡æ–°è®¾è®¡ç®—æ³•çš„ç»“æ„ã€‚ä¾‹å¦‚ï¼Œä¸æ˜¯è®©ä¸¤ä¸ª goroutines å…±äº«ç›¸åŒçš„ç»“æ„ï¼Œé€šè¿‡channelä¼ é€’å®ƒä»¬çš„æœ¬åœ°ç»“æœã€‚ç»“æœåŸºå‡†ä¸å¡«å……å¤§è‡´ç›¸åŒã€‚&lt;/p&gt;
&lt;p&gt;å¹¶å‘ç¼–ç¨‹ä¸­ï¼Œæ“ä½œcpu L1/L2 cache æ—¶ï¼Œå› ä¸ºå¤šæ ¸åŒæ­¥cacheçš„æœ€å°å•å…ƒæ˜¯cache lineï¼Œæ‰€ä»¥å½“ç¼“å­˜è¡Œåœ¨ä¸¤ä¸ªå†…æ ¸ä¹‹é—´å…±äº«æ—¶ï¼Œè‡³å°‘ä¸€ä¸ª goroutine æ˜¯ writer æ—¶ï¼Œå°±ä¼šå‘ç”Ÿä¼ªå…±äº«ã€‚å¦‚æœéœ€è¦ä¼˜åŒ–ä¾èµ–äºå¹¶å‘çš„åº”ç”¨ç¨‹åºï¼Œåº”è¯¥æ£€æŸ¥æ˜¯å¦å­˜åœ¨ä¼ªå…±äº«çš„ä»£ç ï¼Œä¼—æ‰€å‘¨çŸ¥è¿™ç§æ¨¡å¼ä¼šé™ä½åº”ç”¨ç¨‹åºæ€§èƒ½ã€‚å¯ä»¥é€šè¿‡å¡«å……æˆ–é€šä¿¡æ¥é˜²æ­¢è™šå‡å…±äº«ã€‚&lt;/p&gt;
&lt;h3 id=&#34;93ä¸è€ƒè™‘æŒ‡ä»¤çº§å¹¶è¡Œæ€§-instruction-level-parallelism&#34;&gt;93.ä¸è€ƒè™‘æŒ‡ä»¤çº§å¹¶è¡Œæ€§ instruction-level parallelism&lt;/h3&gt;
&lt;p&gt;è¿™ä¸ªå¾ˆå¤§ä¸€éƒ¨åˆ†å–å†³äºç¼–ç¨‹è¯­è¨€çš„ç¼–è¯‘å™¨è½¯ä»¶ï¼Œç¼–è¯‘ä¼˜åŒ–ä¹‹åä»£ç æŒ‡ä»¤æ˜¯å¦å¯ä»¥å……åˆ†åˆ©ç”¨æŒ‡ä»¤çº§å¹¶è¡Œ&lt;em&gt;instruction-level parallelism&lt;/em&gt;ï¼ˆILPï¼‰ï¼›ä»¥åŠåœ¨ç¡¬ä»¶cpuä¸Šè¿›è¡ŒæŒ‡ä»¤çº§å¹¶è¡Œ(ILP)ï¼›&lt;/p&gt;
&lt;p&gt;tips: ä¸¤è€…ç»“åˆæ•ˆæœæ›´ä½³ï¼Œå¯¹äºä¸Šå±‚åº”ç”¨ä½¿ç”¨è¯­è¨€çš„å¼€å‘è€…ï¼Œäº†è§£å…¶èƒŒåçš„åŸç†å³å¯ï¼Œåœ¨åº”ç”¨ç¨‹åºä¸Šçš„æ€§èƒ½ä¼˜åŒ–å¯èƒ½æ•ˆæœä¸å¤§ï¼Œå› ä¸ºéšç€ç¼–è¯‘å™¨å‡çº§å¯èƒ½ä¼šå…¼é¡¾äº†åº”ç”¨ç¨‹åºä¸Šå¯¹ILPè€ƒè™‘ä¼˜åŒ–ã€‚ä¸è¿‡äº†è§£åŸç†å¯ä»¥æœ‰åŠ©äºä¸Šå±‚å®è§‚å±‚é¢çš„æ€è€ƒå¹¶è¡Œï¼Œç”¨äºå€Ÿé‰´å˜›~ï¼Œå¾®è§‚åˆ°å®è§‚(3ä½“é‡Œç»å¸¸æµ®ç°çš„è¯æ±‡ï¼Œé™ç»´æ‰“å‡»)&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://en.wikipedia.org/wiki/Compiler&#34;&gt;ç¼–è¯‘å™¨&lt;/a&gt;å’Œ&lt;a href=&#34;https://en.wikipedia.org/wiki/Central_processing_unit&#34;&gt;CPU&lt;/a&gt;è®¾è®¡äººå‘˜çš„ç›®æ ‡æ˜¯å°½å¯èƒ½å¤šåœ°è¯†åˆ«å’Œåˆ©ç”¨ ILPã€‚æ™®é€šç¨‹åºé€šå¸¸æ˜¯åœ¨é¡ºåºæ‰§è¡Œæ¨¡å‹ä¸‹ç¼–å†™çš„ï¼Œå…¶ä¸­æŒ‡ä»¤ä¸€æ¡æ¥ä¸€æ¡åœ°æ‰§è¡Œï¼Œå¹¶æŒ‰ç…§ç¨‹åºå‘˜æŒ‡å®šçš„é¡ºåºæ‰§è¡Œã€‚ILP å…è®¸ç¼–è¯‘å™¨å’Œå¤„ç†å™¨é‡å æ‰§è¡Œå¤šæ¡æŒ‡ä»¤ï¼Œç”šè‡³å¯ä»¥æ”¹å˜æŒ‡ä»¤æ‰§è¡Œçš„é¡ºåºã€‚cpuåˆ©ç”¨ILPæ‰§è¡ŒæŒ‡ä»¤æ—¶ï¼Œå½“è¡¨ç°å‡º&lt;a href=&#34;https://en.wikipedia.org/wiki/Data_dependence&#34;&gt;æ•°æ®ä¾èµ–æ€§&lt;/a&gt;çš„æŒ‡ä»¤åœ¨æµæ°´çº¿çš„ä¸åŒé˜¶æ®µä¿®æ”¹æ•°æ®æ—¶ï¼Œå°±ä¼šå‘ç”Ÿ&lt;a href=&#34;https://en.wikipedia.org/wiki/Hazard_(computer_architecture)&#34;&gt;æ•°æ®å†’é™©å±å®³&lt;/a&gt;ã€‚å¿½ç•¥æ½œåœ¨çš„æ•°æ®å±å®³ä¼šå¯¼è‡´&lt;a href=&#34;https://en.wikipedia.org/wiki/Race_condition&#34;&gt;ç«äº‰æ¡ä»¶&lt;/a&gt;ï¼ˆä¹Ÿç§°ä¸ºç«äº‰å±å®³ï¼‰ï¼Œè¿›è€Œè§¦å‘æ§åˆ¶é£é™©ï¼›ä¸ºäº†é¿å…æ§åˆ¶é£é™©å‘ç”Ÿï¼Œå¯ä»¥é€šè¿‡&lt;a href=&#34;https://en.wikipedia.org/wiki/Branch_predictor&#34;&gt;é¢„æµ‹åˆ†æ”¯&lt;/a&gt;æ¥è§£å†³ã€‚&lt;/p&gt;
&lt;p&gt;äº†è§£åˆ©ç”¨ILPçš„å¾®æ¶æ„æŠ€æœ¯è§wiki: &lt;a href=&#34;https://en.wikipedia.org/wiki/Instruction-level_parallelism&#34;&gt;https://en.wikipedia.org/wiki/Instruction-level_parallelism&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;åœ¨Goä¸­ï¼Œå¯ä»¥é€šè¿‡ &lt;a href=&#34;https://research.swtch.com/mm&#34;&gt;https://research.swtch.com/mm&lt;/a&gt; æ¥äº†è§£åœ¨è¿™æ–¹é¢çš„æ€è€ƒ&lt;/p&gt;
&lt;h3 id=&#34;94ä¸çŸ¥é“æ•°æ®å¯¹é½&#34;&gt;94.ä¸çŸ¥é“æ•°æ®å¯¹é½&lt;/h3&gt;
&lt;p&gt;æ•°æ®å¯¹é½æ˜¯ä¸€ç§å®‰æ’æ•°æ®åˆ†é…æ–¹å¼ä»¥åŠ é€Ÿ CPU è®¿é—®å†…å­˜çš„æ–¹æ³•ã€‚ä¸äº†è§£è¿™ä¸ªæ¦‚å¿µä¼šå¯¼è‡´é¢å¤–çš„å†…å­˜æ¶ˆè€—ç”šè‡³æ€§èƒ½ä¸‹é™ã€‚&lt;/p&gt;
&lt;p&gt;tips: è¿™ä¸ªå±äºè€ç”Ÿå¸¸è°ˆçš„é—®é¢˜äº†ï¼Œå°¤å…¶åœ¨cè¯­è¨€å¼€å‘çš„ç¨‹åºä¸­ï¼Œæ•°æ®å¯¹é½ï¼Œç›´æ¥é€šè¿‡åœ°å€+åç§»å¤§å°æ¥æŒ‡å‘å¯¹åº”å†…å­˜æ•°æ®ï¼Œè¿›è¡Œè¯»å†™æ“ä½œï¼›golangå¾ˆå¤šæ€æƒ³æ¥è‡ªcï¼Œè‡ªç„¶ä¹Ÿä¼šæœ‰ï¼Œåªä¸è¿‡æ›´åŠ å‹å¥½ï¼Œunsafeå½¢å¼æ¥æ“ä½œæŒ‡é’ˆã€‚&lt;/p&gt;
&lt;p&gt;åœ¨ 64 ä½cpuæ¶æ„ä¸Š,å¤„ç†æœ€å°å•ä½æ˜¯8å­—èŠ‚çš„åœ°å€ï¼Œå¦‚æœæ²¡æœ‰æ•°æ®å¯¹é½ï¼Œå˜é‡jåˆ†é…å¯ä»¥åˆ†å¸ƒåœ¨ä¸¤ä¸ªåœ°å€ä¸Šã€‚å¦‚æœ CPU æƒ³è¦è¯»å–jï¼Œåˆ™éœ€è¦ä¸¤æ¬¡è€Œä¸æ˜¯ä¸€æ¬¡å†…å­˜è®¿é—®ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781617299599/files/Images/CH12_F22_Harsanyi.png&#34; alt=&#34;https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781617299599/files/Images/CH12_F22_Harsanyi.png&#34;&gt;&lt;/p&gt;
&lt;p&gt;ä¸ºé˜²æ­¢è¿™ç§æƒ…å†µï¼Œå˜é‡çš„å†…å­˜åœ°å€åº”è¯¥æ˜¯å…¶è‡ªèº«å¤§å°çš„å€æ•°ã€‚è¿™å°±æ˜¯æ•°æ®å¯¹é½çš„æ¦‚å¿µã€‚åœ¨ Go ä¸­ï¼Œå¯¹é½ä¿è¯å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;byte&lt;/code&gt;, &lt;code&gt;uint8&lt;/code&gt;, &lt;code&gt;int8&lt;/code&gt;: 1 å­—èŠ‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;uint16&lt;/code&gt;, &lt;code&gt;int16&lt;/code&gt;: 2 å­—èŠ‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;uint32&lt;/code&gt;, &lt;code&gt;int32&lt;/code&gt;, &lt;code&gt;float32&lt;/code&gt;: 4 å­—èŠ‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;uint64&lt;/code&gt;, &lt;code&gt;int64&lt;/code&gt;, &lt;code&gt;float64&lt;/code&gt;, &lt;code&gt;complex64&lt;/code&gt;: 8 å­—èŠ‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;complex128&lt;/code&gt;: 16 å­—èŠ‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;æ‰€æœ‰è¿™äº›ç±»å‹éƒ½ä¿è¯å¯¹é½ï¼šå®ƒä»¬çš„åœ°å€æ˜¯å®ƒä»¬å¤§å°çš„å€æ•°ã€‚ä¾‹å¦‚ï¼Œä»»ä½•&lt;code&gt;int32&lt;/code&gt;å˜é‡çš„åœ°å€éƒ½æ˜¯ 4 çš„å€æ•°ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781617299599/files/Images/CH12_F23_Harsanyi.png&#34; alt=&#34;https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781617299599/files/Images/CH12_F23_Harsanyi.png&#34;&gt;&lt;/p&gt;
&lt;p&gt;è¿™æ ·ä¸Šé¢çš„æƒ…å†µï¼ŒæŒ‰åœ¨å­—èŠ‚å¯¹é½ï¼Œå‡ºç°ä¸¤ç§æƒ…å†µï¼š&lt;/p&gt;
&lt;p&gt;ç¬¬ä¸€ç§æƒ…å†µï¼Œåœ¨iä¹‹å‰åˆ†é…äº†ä¸€ä¸ª32ä½å˜é‡ã€‚å› æ­¤iå’Œjè¢«è¿ç»­åˆ†é…ã€‚&lt;/p&gt;
&lt;p&gt;ç¬¬äºŒç§æƒ…å†µï¼Œåœ¨iä¹‹å‰æ²¡æœ‰åˆ†é…32ä½å˜é‡ï¼›iè¢«åˆ†é…åœ¨ä¸€ä¸ªè¯çš„å¼€å¤´ã€‚ä¸ºäº†æ•°æ®å¯¹é½ï¼ˆåœ°å€æ˜¯ 64 çš„å€æ•°ï¼‰ï¼Œiä¸èƒ½ä¸ä¸‹ä¸€ä¸ª 64 çš„å€æ•°jä¸€èµ·åˆ†é…ã€‚ç°è‰²æ¡†è¡¨ç¤º 32 ä½å¡«å……ã€‚&lt;/p&gt;
&lt;p&gt;æ‰€ä»¥äº†è§£äº†å­—èŠ‚å¯¹é½ä¹‹åï¼Œåœ¨è®¾è®¡æ•°æ®ç»“æ„çš„æ—¶å€™ï¼Œéœ€è¦æ¸…æ¥šï¼Œæ•°æ®ç»“æ„é€šè¿‡ç¼–è¯‘å™¨ä¼˜åŒ–ç¼–è¯‘ä¹‹åæ–¹ä¾¿cpuè®¿é—® çš„æ•°æ®å¯¹é½ç»“æ„ï¼Œæ‰€å å†…å­˜å¤§å°ï¼›é˜²æ­¢å‡ºç°æœ¬æ¥ä¸éœ€è¦è¿™ä¹ˆå¤šå†…å­˜ç©ºé—´çš„è®¾è®¡ã€‚å°¤å…¶åœ¨è®¾è®¡éå¸¸ä¾èµ–ç¼“å­˜å­˜å‚¨çš„é¡¹ç›®ä¸­ã€‚ç”³è¯·å†…å­˜ç©ºé—´è¶Šå¤šè¶Šé¢‘ç¹ï¼Œå¯¹äºGoæ¥è¯´ï¼Œå°†å¸¦æ¥æ›´å¤šçš„GC, å½±å“æ•´ä½“åº”ç”¨æ€§èƒ½ã€‚&lt;/p&gt;
&lt;p&gt;è¿˜æœ‰ä¸€ä¸ªå¥½å¤„æ˜¯ï¼Œè€ƒè™‘äº†å­—èŠ‚å¯¹é½åçš„åˆç†ç»“æ„ä½“(æ‰€å å†…å­˜ç©ºé—´çš„ç»“æ„ä½“å¤§å°æœ€å°æƒ…å†µï¼Œ&lt;strong&gt;ç»“æ„ä½“ä¸­çš„å­—æ®µæŒ‰å¤§å°é™åºå¯¹å®ƒä»¬è¿›è¡Œæ’åºå¯¹é½&lt;/strong&gt;)ï¼›åˆ©ç”¨cache å±€éƒ¨æ€§åŸç†ï¼Œå¯ä»¥åœ¨cpu cache lineä¸­å­˜æ”¾æ›´å¤šçš„å¯¹è±¡ï¼Œè¿™æ ·åœ¨éå†å¯¹è±¡æ—¶ï¼Œéœ€è¦æ›´å°‘çš„ç¼“å­˜è¡Œæ€»æ•°ï¼Œæ€§èƒ½æ›´å¥½ã€‚&lt;/p&gt;
&lt;h3 id=&#34;95ä¸äº†è§£æ ˆä¸å †&#34;&gt;95.ä¸äº†è§£æ ˆä¸å †&lt;/h3&gt;
&lt;p&gt;åœ¨ Go ä¸­ï¼Œå˜é‡å¯ä»¥åˆ†é…åœ¨æ ˆä¸Šæˆ–å †ä¸Šã€‚è¿™ä¸¤ç§ç±»å‹çš„å†…å­˜æ ¹æœ¬ä¸åŒï¼Œå½±å“æ•°æ®å¯†é›†å‹åº”ç”¨ç¨‹åºã€‚éœ€è¦äº†è§£æ ˆå’Œå †è¿™äº›æ¦‚å¿µï¼Œä»¥åŠç¼–è¯‘å™¨å†³å®šå˜é‡åˆ†é…ä½ç½®æ‰€éµå¾ªçš„è§„åˆ™ã€‚&lt;/p&gt;
&lt;h4 id=&#34;æ ˆä¸å †&#34;&gt;æ ˆä¸å †&lt;/h4&gt;
&lt;p&gt;é¦–å…ˆï¼Œè®¨è®ºä¸€ä¸‹æ ˆå’Œå †çš„åŒºåˆ«ã€‚æ ˆæ˜¯å®ƒæ˜¯ä¸€ç§åè¿›å…ˆå‡º (LIFO) æ•°æ®ç»“æ„ï¼Œç”¨äºå­˜å‚¨ç‰¹å®š goroutine çš„æ‰€æœ‰å±€éƒ¨å˜é‡ã€‚å½“ä¸€ä¸ª goroutine å¯åŠ¨æ—¶ï¼Œå®ƒä¼šè·å¾— 2 KB çš„è¿ç»­å†…å­˜ä½œä¸ºå®ƒçš„æ ˆç©ºé—´ï¼ˆè¿™ä¸ªå¤§å°éšç€æ—¶é—´çš„æ¨ç§»è€Œå˜åŒ–å¹¶ä¸”å¯èƒ½ä¼šå†æ¬¡æ”¹å˜ï¼‰ã€‚ä½†æ˜¯ï¼Œæ­¤å¤§å°åœ¨è¿è¡Œæ—¶ä¸æ˜¯å›ºå®šçš„ï¼Œå¯ä»¥æ ¹æ®éœ€è¦å¢å¤§å’Œç¼©å°ï¼ˆä½†å®ƒå§‹ç»ˆåœ¨å†…å­˜ä¸­ä¿æŒè¿ç»­ï¼Œä»è€Œä¿ç•™æ•°æ®å±€éƒ¨æ€§ï¼‰ã€‚&lt;/p&gt;
&lt;p&gt;tips: Go åœ¨1.3ä¹‹å‰æ ˆæ‰©å®¹é‡‡ç”¨çš„æ˜¯åˆ†æ®µæ ˆï¼ˆSegemented Stackï¼‰ï¼Œåœ¨æ ˆç©ºé—´ä¸å¤Ÿçš„æ—¶å€™æ–°ç”³è¯·ä¸€ä¸ªæ ˆç©ºé—´ç”¨äºè¢«è°ƒç”¨å‡½æ•°çš„æ‰§è¡Œï¼Œ æ‰§è¡Œåé”€æ¯æ–°ç”³è¯·çš„æ ˆç©ºé—´å¹¶å›åˆ°è€çš„æ ˆç©ºé—´ç»§ç»­æ‰§è¡Œï¼Œå½“å‡½æ•°å‡ºç°é¢‘ç¹è°ƒç”¨ï¼ˆé€’å½’ï¼‰æ—¶å¯èƒ½ä¼šå¼•å‘hot splitã€‚ä¸ºäº†é¿å…hot split, 1.3ä¹‹åé‡‡ç”¨çš„æ˜¯è¿ç»­æ ˆï¼ˆContiguous Stackï¼‰ï¼Œæ ˆç©ºé—´ä¸è¶³çš„æ—¶å€™ç”³è¯·ä¸€ä¸ª2å€äºå½“å‰å¤§å°çš„æ–°æ ˆï¼Œå¹¶æŠŠæ‰€æœ‰æ•°æ®æ‹·è´åˆ°æ–°æ ˆï¼Œ æ¥ä¸‹æ¥çš„æ‰€æœ‰è°ƒç”¨æ‰§è¡Œéƒ½å‘ç”Ÿåœ¨æ–°æ ˆä¸Šã€‚&lt;/p&gt;
&lt;p&gt;å½“ Go è¿›å…¥ä¸€ä¸ªå‡½æ•°æ—¶ï¼Œä¼šåˆ›å»ºä¸€ä¸ªæ ˆå¸§ï¼Œä»£è¡¨å†…å­˜ä¸­åªæœ‰å½“å‰å‡½æ•°æ‰èƒ½è®¿é—®çš„ä¸€ä¸ªåŒºé—´ã€‚&lt;/p&gt;
&lt;p&gt;é€šè¿‡ä¸€ä¸ªç®€å•ç¤ºä¾‹æ¥ä»‹ç»stackçš„æŒ‡ä»¤æ‰§è¡Œè¿‡ç¨‹&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781617299599/files/Images/CH12_F27_Harsanyi.png&#34; alt=&#34;https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781617299599/files/Images/CH12_F27_Harsanyi.png&#34;&gt;&lt;/p&gt;
&lt;p&gt;ä¸ºäº†ç®€åŒ–ï¼Œå›¾ä¸­stackæ²¡æœ‰ä½¿ç”¨æ±‡ç¼–æŒ‡ä»¤æ¥è¡¨æ˜ï¼Œæ‰§è¡Œäº†&lt;code&gt;main&lt;/code&gt;ï¼Œæ‰€ä»¥ä¸ºè¿™ä¸ªå‡½æ•°åˆ›å»ºäº†ä¸€ä¸ªæ ˆå¸§ï¼Œ&lt;code&gt;a&lt;/code&gt;å’Œ&lt;code&gt;b&lt;/code&gt;éƒ½åˆ†é…åœ¨æ ˆä¸Šï¼Œvalidä¸ºæœ‰æ•ˆåœ°å€ï¼Œinvalidä¸ºæ— æ•ˆåœ°å€ã€‚æ ˆä»é«˜åœ°å€å¾€åœ°å€ç©ºé—´å¢é•¿ï¼Œå…¶ä¸­åŸºå‡†æŒ‡é’ˆå¯„å­˜å™¨BP æ¥ç»´æŠ¤æ ˆåŸºåœ°å€ ï¼Œæ ˆæŒ‡é’ˆå¯„å­˜å™¨SP æŒ‡å‘æ ˆé¡¶åœ°å€ï¼› è‡³äºæ±‡ç¼–ç›¸å…³çš„ç»†èŠ‚è§å®˜æ–¹æ–‡æ¡£æŸ¥é˜…è§£é‡Šï¼š&lt;strong&gt;&lt;a href=&#34;https://go.dev/doc/asm&#34;&gt;https://go.dev/doc/asm&lt;/a&gt;&lt;/strong&gt;ã€‚æŸ¥çœ‹å‘½ä»¤å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-fallback&#34; data-lang=&#34;fallback&#34;&gt;GOOS=linux GOARCH=amd64 go tool compile -S -L -N -l -m 12-optimizations/95-stack-heap/main.go | less
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;img src=&#34;https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781617299599/files/Images/CH12_F28_Harsanyi.png&#34; alt=&#34;https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781617299599/files/Images/CH12_F28_Harsanyi.png&#34;&gt;&lt;/p&gt;
&lt;p&gt;è°ƒç”¨&lt;code&gt;sumValue&lt;/code&gt;åˆ›å»ºä¸€ä¸ªæ–°çš„æ ˆå¸§ã€‚x,yä¸ºå€¼ä¼ é€’åˆ†åˆ«èµ‹å€¼ï¼Œx+yå(ç®€å•èµ·è§ï¼Œæ“ä½œæŒ‡ä»¤æœªç»™å‡º)ï¼Œzèµ‹å€¼; å…ˆå‰çš„æ ˆå¸§&lt;code&gt;(main)&lt;/code&gt;åŒ…å«ä»è¢«è§†ä¸ºæœ‰æ•ˆçš„åœ°å€ï¼Œä½†æ— æ³•è®¿é—®aå’Œbå¯¹å…¶æ“ä½œï¼Œå¦‚æœæ˜¯æŒ‡é’ˆä¼ é€’åˆ™å¯ä»¥è·å–åœ°å€å¯¹å…¶æ“ä½œã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781617299599/files/Images/CH12_F29_Harsanyi.png&#34; alt=&#34;https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781617299599/files/Images/CH12_F29_Harsanyi.png&#34;&gt;&lt;/p&gt;
&lt;p&gt;æ‰§è¡Œå®Œå‡ºå‡½æ•°ï¼Œå‡ºæ ˆï¼ŒsumValueæ ˆå¸§è¢«æ“¦é™¤ï¼Œæ›¿æ¢ä¸ºåŸæ¥çš„mainæ ˆå¸§ï¼Œxå·²ç»è¢«æ“¦é™¤ï¼Œyå’Œzä»åœ¨å†…å­˜ä¸­åˆ†é…ï¼Œä½†æ˜¯æ— æ³•è®¿é—®ã€‚&lt;/p&gt;
&lt;p&gt;æ³¨æ„ æ ˆ&lt;code&gt;sumValue&lt;/code&gt;å¸§å¹¶æœªä»å†…å­˜ä¸­å®Œå…¨åˆ é™¤ã€‚å½“å‡½æ•°è¿”å›æ—¶ï¼ŒGo ä¸ä¼šèŠ±æ—¶é—´é‡Šæ”¾å˜é‡æ¥å›æ”¶å¯ç”¨ç©ºé—´ã€‚ä½†æ˜¯è¿™äº›ä»¥å‰çš„å˜é‡ä¸èƒ½å†è¢«è®¿é—®ï¼Œå½“æ¥è‡ªçˆ¶å‡½æ•°çš„æ–°å˜é‡è¢«åˆ†é…åˆ°æ ˆæ—¶ï¼Œå®ƒä»¬å–ä»£äº†ä¹‹å‰çš„åˆ†é…ã€‚ä»æŸç§æ„ä¹‰ä¸Šè¯´ï¼Œæ ˆæ˜¯è‡ªæ¸…æ´çš„ï¼›å®ƒä¸éœ€è¦é¢å¤–çš„æœºåˆ¶ï¼Œä¾‹å¦‚ GCã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781617299599/files/Images/CH12_F30_Harsanyi.png&#34; alt=&#34;https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781617299599/files/Images/CH12_F30_Harsanyi.png&#34;&gt;&lt;/p&gt;
&lt;p&gt;æŠŠè°ƒç”¨å‡½æ•°æ”¹æˆæŒ‡é’ˆè¿”å›æ—¶ï¼Œz å¦‚æœ ç»§ç»­åˆ†é…åœ¨æ ˆä¸Šçš„è¯ï¼Œå‡½æ•°è¿”å›åï¼Œzä¸åœ¨æœ‰æ•ˆï¼Œmainæ ˆå¸§ç»§ç»­å¢é•¿ï¼Œä¼šæ“¦é™¤æ‰z, è¿™æ ·cæŒ‡å‘çš„åœ°å€ç©ºé—´å·²ç»ä¸å­˜åœ¨äº†ï¼Œå˜æˆäº†é”™ä½çš„æ‚¬æŒ‚æŒ‡é’ˆï¼Œå¦‚æœä½¿ç”¨cè¿›è¡Œæ“ä½œä¼šå‡ºç°å¼‚å¸¸(Cè¯­è¨€ä¸­ï¼Œä¼šå‡ºç°Segmentation fault)ï¼Œæ‰€ä»¥åœ¨Goä¸­ï¼Œä¸ºäº†ä»£ç å®‰å…¨ï¼Œåœ¨ç¼–è¯‘çš„æ—¶å€™ï¼Œå°†z åŸæœ¬åœ¨æ ˆä¸Šåˆ†é…çš„ç©ºé—´ï¼Œé€ƒé€¸åˆ†é…åˆ°äº†å †ä¸Šã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781617299599/files/Images/CH12_F31_Harsanyi.png&#34; alt=&#34;https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781617299599/files/Images/CH12_F31_Harsanyi.png&#34;&gt;&lt;/p&gt;
&lt;p&gt;å †å†…å­˜ç©ºé—´æ˜¯æ‰€æœ‰goroutineçš„å…±äº«æ± ï¼Œç”±Goçš„å†…å­˜åˆ†é…å™¨æ¥ç®¡ç†ï¼Œå…·ä½“è§&lt;a href=&#34;https://medium.com/@ankur_anand/a-visual-guide-to-golang-memory-allocator-from-ground-up-e132258453ed&#34;&gt;Go Memory Allocator&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;ä¸‰ä¸ªåç¨‹&lt;code&gt;G1&lt;/code&gt;,&lt;code&gt;G2&lt;/code&gt;å’Œ&lt;code&gt;G3&lt;/code&gt;éƒ½æœ‰è‡ªå·±çš„æ ˆï¼Œå…±äº«åŒä¸€ä¸ªå †è¿›è¡Œå†…å­˜åˆ†é…ç®¡ç†ã€‚&lt;/p&gt;
&lt;p&gt;tips: åœ¨Goä¸­ï¼Œä¸ºäº†åŠ é€Ÿå†…å­˜åˆ†é…ï¼ŒGolangè‡ªå·±ç»´æŠ¤äº†ç±»ä¼¼https://github.com/google/tcmalloc çš„å†…å­˜åˆ†é…å™¨æ¥ç®¡ç†ï¼Œæ¯ä¸ªè¿è¡Œæ—¶Péƒ½æœ‰ä¸€ä¸ªæœ¬åœ°mcacheï¼Œç”¨äºæ‰§è¡ŒçŠ¶æ€çš„åç¨‹Gåˆ†é…å†…å­˜ç©ºé—´ï¼Œå¯¹åº”å¤šçº¿ç¨‹ä¸­å†…å­˜tcmallocçš„åˆ†é…æœºåˆ¶ï¼Œçº¿ç¨‹æœ¬åœ°mcacheã€‚&lt;/p&gt;
&lt;p&gt;æ ˆæ˜¯è‡ªæ¸…æ´çš„ï¼Œå¹¶ç”±å•ä¸ª goroutine è®¿é—®ã€‚ç›¸åï¼Œå †ä¸Šåˆ†é…çš„å¯¹è±¡éœ€è¦é€šè¿‡GCæ ‡æ³¨æ‰«æè¿›è¡Œæ¸…ç†ã€‚å †åˆ†é…è¶Šå¤šå¯¹è±¡ï¼Œå¯¹ GC æ–½åŠ çš„å‹åŠ›å°±è¶Šå¤§ã€‚å½“ GC è¿è¡Œæ—¶ï¼Œä¼šä½¿ç”¨å¤§çº¦ 25% çš„å¯ç”¨ CPU å®¹é‡ï¼Œå¹¶ä¸”å¯èƒ½ä¼šäº§ç”Ÿæ¯«ç§’çº§çš„â€œåœæ­¢ä¸–ç•Œâ€å»¶è¿Ÿï¼ˆåº”ç”¨ç¨‹åºæš‚åœçš„é˜¶æ®µï¼‰ã€‚å…·ä½“è§å®˜æ–¹æ–‡æ¡£ï¼š &lt;a href=&#34;https://tip.golang.org/doc/gc-guide&#34;&gt;gc-guide&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;åœ¨åŸºå‡†å‹æµ‹çš„ç»“æœä¸­ï¼Œä½¿ç”¨çš„testing.B.ReportAllocså‡½æ•°, æˆ–è€…ä½¿ç”¨å‚æ•°-benchmem ï¼Œæ˜¾ç¤ºäº†å †åˆ†é…æƒ…å†µï¼ˆæ ˆåˆ†é…ä¸è®¡ç®—åœ¨å†…ï¼‰ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;B/op:&lt;/code&gt;æ¯ä¸ªæ“ä½œåˆ†é…å¤šå°‘å­—èŠ‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;allocs/op:&lt;/code&gt;æ¯ä¸ªæ“ä½œæœ‰å¤šå°‘åˆ†é…&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;tips:&lt;/p&gt;
&lt;p&gt;ç”±äºGoä¸­çš„ç”¨æˆ·æ ˆç©ºé—´æ˜¯è‡ªåŠ¨æ‰©ç¼©å®¹çš„ï¼Œéœ€è¦æ³¨æ„æ¯ä¸ªåç¨‹goroutineæ ˆæ‰©å®¹å¯¹å†…å­˜ç©ºé—´çš„å½±å“ï¼Œç‰¹åˆ«æ˜¯åœ¨é•¿è¿æ¥çš„åœºæ™¯ï¼Œå•æœºè¿æ¥æ•°åœ¨100wçº§åˆ«çš„æ—¶å€™ï¼Œå°½é‡ä¿æŒæ¯ä¸ªgoroutine å¤„ç†å‡½æ•°çš„é€»è¾‘åœ¨2kbå†…(åŠŸèƒ½èŒè´£åˆ†ç¦»)ï¼Œé˜²æ­¢æ ˆæ‰©å®¹ï¼Œå¯¼è‡´å†…å­˜æŒ‡æ•°çº§æš´æ¶¨ã€‚&lt;/p&gt;
&lt;p&gt;æ ˆæ‰©å®¹äº†ï¼Œé•¿æ—¶é—´æ²¡æœ‰è¿è¡Œï¼Œä¸ºäº†æé«˜å†…å­˜åˆ©ç”¨ç‡ï¼Œåœ¨GCè§¦å‘çš„æ—¶å€™ï¼Œè®¡ç®—å½“å‰æ ˆä½¿ç”¨çš„ç©ºé—´ï¼Œå°äºæ ˆç©ºé—´çš„1/4ï¼Œä¼šè§¦å‘æ ˆç¼©å®¹æ“ä½œåˆ°åŸæ¥çš„1/2ï¼Œæœ€å°åˆ°2kbï¼Œä¸ä¼šå†ç¼©å®¹ï¼›ä½†åœ¨ç¼©å®¹è¿‡ç¨‹ä¸­ä¼šå­˜åœ¨æ ˆæ‹·è´å’Œå†™å±éšœ(write barrier)ï¼Œå¯¹äºä¸€äº›å‡†å®æ—¶åº”ç”¨å¯èƒ½ä¼šå­˜åœ¨ä¸€äº›å½±å“ã€‚ å¥½åœ¨goæä¾›äº†å¯è®¾ç½®çš„å‚æ•°ï¼Œå¯ä»¥é€šè¿‡è®¾ç½®ç¯å¢ƒå˜é‡ GODEBUG=gcshrinkstackoff=1 æ¥å…³é—­æ ˆç¼©å®¹ã€‚å…³é—­æ ˆç¼©å®¹åï¼Œ éœ€è¦æ‰¿æ‹…æ ˆæŒç»­å¢é•¿çš„é£é™©ï¼Œåœ¨å…³é—­å‰éœ€è¦æ…é‡è€ƒè™‘ã€‚&lt;/p&gt;
&lt;h4 id=&#34;é€ƒé€¸åˆ†æ-é‡è¦&#34;&gt;é€ƒé€¸åˆ†æ (é‡è¦)&lt;/h4&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/golang/go/blob/go1.20/src/cmd/compile/internal/escape/escape.go&#34;&gt;é€ƒé€¸åˆ†æ(escape analysis)&lt;/a&gt; åœ¨ç¨‹åºç¼–è¯‘é˜¶æ®µæ ¹æ®ç¨‹åºä»£ç ä¸­çš„æ•°æ®å˜é‡ï¼Œå¯¹ä»£ç ä¸­å“ªäº›å˜é‡éœ€è¦åœ¨æ ˆä¸Šåˆ†é…ï¼Œå“ªäº›å˜é‡éœ€è¦åœ¨å †ä¸Šåˆ†é…è¿›è¡Œé™æ€åˆ†æçš„æ–¹æ³•ï¼›Go è¯­è¨€çš„é€ƒé€¸åˆ†æéµå¾ªä»¥ä¸‹ä¸¤ä¸ªä¸å˜æ€§ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;æŒ‡å‘æ ˆå¯¹è±¡çš„æŒ‡é’ˆä¸èƒ½å­˜å‚¨åœ¨å †ä¸­ï¼ˆpointers to stack objects cannot be stored in the heapï¼‰ï¼›&lt;/li&gt;
&lt;li&gt;æŒ‡å‘æ ˆå¯¹è±¡çš„æŒ‡é’ˆä¸èƒ½è¶…è¿‡è¯¥æ ˆå¯¹è±¡çš„å­˜æ´»æœŸï¼ˆpointers to a stack object cannot outlive that objectï¼‰ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;tips: å‘ç”Ÿé€ƒé€¸æ—¶ï¼Œåº•å±‚ä¼šä½¿ç”¨runtime.newobjectè°ƒç”¨&lt;a href=&#34;https://github.com/golang/go/blob/go1.20/src/runtime/malloc.go#L878&#34;&gt;&lt;strong&gt;mallocgc&lt;/strong&gt;&lt;/a&gt;é€šè¿‡å†…å­˜åˆ†é…å™¨æ¥ç®¡ç†åˆ†é…ï¼›&lt;/p&gt;
&lt;p&gt;æ— æ³•åœ¨æ ˆä¸Šå®Œæˆåˆ†é…æ—¶ï¼Œå®ƒä¼šåœ¨å †ä¸Šå®Œæˆ, æ¯”å¦‚ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å¦‚æœå±€éƒ¨å˜é‡å¤ªå¤§è€Œä¸é€‚åˆæ ˆã€‚&lt;/li&gt;
&lt;li&gt;å¦‚æœå±€éƒ¨å˜é‡çš„å¤§å°æœªçŸ¥ã€‚ä¾‹å¦‚ï¼Œ&lt;code&gt;s := make([]int, 10)&lt;/code&gt;å¯èƒ½ä¸ä¼šé€ƒé€¸åˆ°å †ä¸­ï¼Œä½†&lt;code&gt;s := make([]int, n)&lt;/code&gt;ä¼šï¼Œå› ä¸ºå®ƒçš„å¤§å°æ˜¯åŸºäºå˜é‡çš„ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;c1&#34;&gt;// go run -gcflags=&amp;#39;-m=1 -l -L -S -N&amp;#39;
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;test1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
	&lt;span class=&#34;nx&#34;&gt;a&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;make&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;([]&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;8193&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;c1&#34;&gt;// &amp;gt;64kb a and a.Data escape to heap
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;	&lt;span class=&#34;nf&#34;&gt;printSliceLocalAndDataPointAddr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
	&lt;span class=&#34;nx&#34;&gt;aa&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;make&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;([]&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;8192&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;c1&#34;&gt;// &amp;lt;=64kb aa and aa.Data don&amp;#39;t escape to heap
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;	&lt;span class=&#34;nf&#34;&gt;printSliceLocalAndDataPointAddr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;aa&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
	&lt;span class=&#34;nx&#34;&gt;aaa&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;make&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;([]&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;8192&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;c1&#34;&gt;// &amp;lt;=64kb aaa and aaa.Data don&amp;#39;t escape to heap
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;	&lt;span class=&#34;nf&#34;&gt;printSliceLocalAndDataPointAddr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;aaa&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
	&lt;span class=&#34;nx&#34;&gt;aaa&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;append&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;aaa&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;c1&#34;&gt;// happen runtime.growslice; aaa don&amp;#39;t escape to heapï¼Œbut aaa.Data move to heap
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;	&lt;span class=&#34;nf&#34;&gt;printSliceLocalAndDataPointAddr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;aaa&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
	&lt;span class=&#34;c1&#34;&gt;// so if make a slice, &amp;lt;=64kb please init cap, eg: make([]int, 0, 8192) allocate in stack
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;
	&lt;span class=&#34;nx&#34;&gt;bb&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1024&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;1024&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;10&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;byte&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{}&lt;/span&gt;  &lt;span class=&#34;c1&#34;&gt;// don&amp;#39;t move to heap
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;	&lt;span class=&#34;nx&#34;&gt;bbb&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1024&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;1024&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;11&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;byte&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{}&lt;/span&gt; &lt;span class=&#34;c1&#34;&gt;// move to heap
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;
	&lt;span class=&#34;nx&#34;&gt;n&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;
	&lt;span class=&#34;nx&#34;&gt;s&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;make&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;([]&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;n&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;c1&#34;&gt;// escapes to heap
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;	&lt;span class=&#34;nx&#34;&gt;_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;_&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;s&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;aa&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;aaa&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;bb&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;bbb&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;

&lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;printSliceLocalAndDataPointAddr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;p&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[]&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
	&lt;span class=&#34;nb&#34;&gt;println&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;addr of local slice = &amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;p&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
	&lt;span class=&#34;nx&#34;&gt;pd&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;reflect&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;SliceHeader&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;unsafe&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Pointer&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;p&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;))&lt;/span&gt;
	&lt;span class=&#34;nb&#34;&gt;println&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;slice data =&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;unsafe&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Pointer&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;pd&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Data&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;))&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;æŒ‡å‘æ ˆå¯¹è±¡çš„æŒ‡é’ˆä¸èƒ½åœ¨æ ˆå¯¹è±¡å›æ”¶åå­˜æ´»ï¼›interfaceæ“ä½œä»¥åŠè¿”å›å‡½æ•°ä¸­å±€éƒ¨å˜é‡çš„æŒ‡é’ˆï¼Œ æ¯”å¦‚ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;c1&#34;&gt;// go tool compile -m=1 -l -L -S -N   use -m=2 , -m3, -m4 see more
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;a&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;s&#34;&gt;&amp;#34;hi&amp;#34;&lt;/span&gt;
&lt;span class=&#34;nx&#34;&gt;fmt&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Printf&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;%s&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;c1&#34;&gt;// a escapes to heap
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;
&lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;sum&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;x&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;y&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
	&lt;span class=&#34;nx&#34;&gt;z&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;x&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;+&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;y&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
	&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;z&lt;/span&gt; &lt;span class=&#34;c1&#34;&gt;// moved to heap: z
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;

&lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;noescape&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;p&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;unsafe&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Pointer&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;unsafe&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Pointer&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// p does not escape
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;	&lt;span class=&#34;nx&#34;&gt;x&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;uintptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;p&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
	&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;unsafe&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Pointer&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;x&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;^&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;leakNoEscape&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;p&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt; &lt;span class=&#34;c1&#34;&gt;// leaking param: p to result ~r0 level=0
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;	&lt;span class=&#34;nx&#34;&gt;x&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;p&lt;/span&gt;
	&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;x&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;escape&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;p&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
	&lt;span class=&#34;nx&#34;&gt;x&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;p&lt;/span&gt; &lt;span class=&#34;c1&#34;&gt;// x escapes to heap
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;	&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;x&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;å¦‚æœæŒ‡å‘æ ˆå¯¹è±¡çš„æŒ‡é’ˆå­˜åœ¨äºæ ˆä¸­ï¼›è¿™ä¸ä¼šåˆ†é…åˆ°å †ä¸Šï¼Œæ¯”å¦‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781617299599/files/Images/CH12_F32_Harsanyi.png&#34; alt=&#34;https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781617299599/files/Images/CH12_F32_Harsanyi.png&#34;&gt;&lt;/p&gt;
&lt;p&gt;x, y çš„å€¼(å¯¹è±¡åœ°å€)ï¼Œä»¥åŠæŒ‡å‘å¯¹è±¡ a å’Œ b. éƒ½åœ¨æ ˆä¸Šï¼Œæ‰€ä»¥ä¸ä¼šåˆ†é…åœ¨å †ä¸Šã€‚&lt;/p&gt;
&lt;p&gt;ä»¥ä¸‹æ˜¯å˜é‡å¯ä»¥é€ƒé€¸åˆ°å †çš„å…¶ä»–æƒ…å†µï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å…¨å±€å˜é‡ï¼Œå› ä¸ºå¤šä¸ª goroutines å¯ä»¥è®¿é—®å®ƒä»¬ã€‚&lt;/li&gt;
&lt;li&gt;å‘é€åˆ°channelçš„æŒ‡é’ˆï¼š&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;kd&#34;&gt;type&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;Foo&lt;/span&gt; &lt;span class=&#34;kd&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;s&lt;/span&gt; &lt;span class=&#34;kt&#34;&gt;string&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;span class=&#34;nx&#34;&gt;ch&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;make&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;chan&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Foo&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;span class=&#34;nx&#34;&gt;foo&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Foo&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;s&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;s&#34;&gt;&amp;#34;x&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt; &lt;span class=&#34;c1&#34;&gt;// escapes to heap
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;ch&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;foo&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;ç”±å‘é€åˆ°é€šé“çš„å€¼å¼•ç”¨çš„å˜é‡ï¼š&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;kd&#34;&gt;type&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;Foo&lt;/span&gt; &lt;span class=&#34;kd&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;s&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;string&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;span class=&#34;nx&#34;&gt;ch&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;make&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;chan&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;Foo&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;span class=&#34;nx&#34;&gt;s&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;s&#34;&gt;&amp;#34;x&amp;#34;&lt;/span&gt; &lt;span class=&#34;c1&#34;&gt;// moved to heap
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;bar&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;Foo&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;s&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;s&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;span class=&#34;nx&#34;&gt;ch&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;bar&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;ä»¥ä¸Šé€ƒé€¸åˆ†æçš„æµ‹è¯•éšç€ç¼–è¯‘å™¨çš„å‡çº§ï¼Œå¯èƒ½åœ¨æœªæ¥çš„ Go ç‰ˆæœ¬ä¸­å‘ç”Ÿå˜åŒ–ã€‚ä¸ºäº†ç¡®è®¤å‡è®¾ï¼Œå¯ä»¥ä½¿ç”¨ &lt;code&gt;go build -gcflags &amp;quot;-m=2&amp;quot;&lt;/code&gt; -m=3,-m4 æ¥è¿›è¡Œè¯¦ç»†åˆ†æã€‚&lt;/p&gt;
&lt;p&gt;äº†è§£å †å’Œæ ˆä¹‹é—´çš„æ ¹æœ¬åŒºåˆ«å¯¹äºä¼˜åŒ– Go åº”ç”¨ç¨‹åºè‡³å…³é‡è¦ã€‚å †åˆ†é…å¯¹äº Go è¿è¡Œæ—¶å¤„ç†æ¥è¯´æ›´ä¸ºå¤æ‚ï¼Œå¹¶ä¸”éœ€è¦å…·æœ‰ GC çš„å¤–éƒ¨ç³»ç»Ÿæ¥é‡Šæ”¾æ•°æ®ã€‚åœ¨æŸäº›æ•°æ®å¯†é›†å‹åº”ç”¨ç¨‹åºä¸­ï¼Œå †ç®¡ç†å¯å æ€» CPU æ—¶é—´æ¶ˆè€—çš„ 20% æˆ– 30%ã€‚å¦ä¸€æ–¹é¢ï¼Œæ ˆæ˜¯è‡ªæ¸…æ´çš„ï¼Œå¹¶ä¸”å¯¹å•ä¸ª goroutine è€Œè¨€æ˜¯æœ¬åœ°çš„ï¼Œä»è€Œä½¿åˆ†é…é€Ÿåº¦æ›´å¿«ã€‚å› æ­¤ï¼Œä¼˜åŒ–å†…å­˜åˆ†é…å¯ä»¥è·å¾—å¾ˆå¤§çš„æŠ•èµ„å›æŠ¥ã€‚&lt;/p&gt;
&lt;p&gt;ç†è§£é€ƒé€¸åˆ†æçš„è§„åˆ™å¯¹äºç¼–å†™æ›´é«˜æ•ˆçš„ä»£ç ä¹Ÿå¾ˆé‡è¦ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œå‘ä¸‹å…±äº«ç•™åœ¨æ ˆä¸Šï¼Œè€Œå‘ä¸Šå…±äº«é€ƒé€¸åˆ°å †ä¸­ã€‚è¿™åº”è¯¥å¯ä»¥é˜²æ­¢å¸¸è§é”™è¯¯ï¼Œä¾‹å¦‚æƒ³è¦è¿”å›æŒ‡é’ˆçš„è¿‡æ—©ä¼˜åŒ–ï¼Œä¾‹å¦‚â€œé¿å…å¤åˆ¶â€ã€‚é¦–å…ˆå…³æ³¨å¯è¯»æ€§å’Œè¯­ä¹‰ï¼Œç„¶ååœ¨éœ€è¦æ—¶ä¼˜åŒ–åˆ†é…ã€‚&lt;/p&gt;
&lt;p&gt;tips: æƒ³æ›´æ·±å…¥äº†è§£é€ƒé€¸åˆ†æï¼Œå¯ä»¥ä¸€èµ·å­¦ä¹ è¿™ç¯‡è®ºæ–‡ï¼š&lt;a href=&#34;http://www.wingtecher.com/themes/WingTecherResearch/assets/papers/ICSE20.pdf&#34;&gt;Escape from Escape Analysis of Golang&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&#34;96ä¸çŸ¥é“å¦‚ä½•å‡å°‘åˆ†é…&#34;&gt;96.ä¸çŸ¥é“å¦‚ä½•å‡å°‘åˆ†é…&lt;/h3&gt;
&lt;p&gt;å‡å°‘åˆ†é…æ˜¯åŠ é€Ÿ Go åº”ç”¨ç¨‹åºçš„å¸¸è§ä¼˜åŒ–æŠ€æœ¯ã€‚å·²ç»æ¶µç›–äº†ä¸€äº›å‡å°‘å †åˆ†é…æ•°é‡çš„æ–¹æ³•ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æœªä¼˜åŒ–çš„å­—ç¬¦ä¸²è¿æ¥ï¼ˆé”™è¯¯ &lt;a href=&#34;https://weedge.github.io/post/notions/go-tips/go-tips-05-strings/#39%E4%BC%98%E5%8C%96%E4%B8%8D%E8%B6%B3%E7%9A%84%E5%AD%97%E7%AC%A6%E4%B8%B2%E8%BF%9E%E6%8E%A5&#34;&gt;#39&lt;/a&gt;ï¼‰ï¼šä½¿ç”¨&lt;code&gt;strings.Builder&lt;/code&gt;æ›¿ä»£&lt;code&gt;+&lt;/code&gt;è¿ç®—ç¬¦æ¥è¿æ¥å­—ç¬¦ä¸²ã€‚&lt;/li&gt;
&lt;li&gt;æ— ç”¨çš„å­—ç¬¦ä¸²è½¬æ¢ï¼ˆé”™è¯¯ &lt;a href=&#34;https://weedge.github.io/post/notions/go-tips/go-tips-05-strings/#40%E6%97%A0%E7%94%A8%E7%9A%84%E5%AD%97%E7%AC%A6%E4%B8%B2%E8%BD%AC%E6%8D%A2&#34;&gt;#40&lt;/a&gt;ï¼‰ï¼šå°½å¯èƒ½é¿å…è½¬æ¢&lt;code&gt;[]byte&lt;/code&gt;æˆå­—ç¬¦ä¸²ã€‚&lt;/li&gt;
&lt;li&gt;åˆ‡ç‰‡å’Œæ˜ å°„åˆå§‹åŒ–æ•ˆç‡ä½ä¸‹ï¼ˆé”™è¯¯ &lt;a href=&#34;https://weedge.github.io/post/notions/go-tips/go-tips-03-data-types/#21%E5%88%87%E7%89%87%E5%88%9D%E5%A7%8B%E5%8C%96%E6%95%88%E7%8E%87%E4%BD%8E%E4%B8%8B&#34;&gt;#21&lt;/a&gt; å’Œ &lt;a href=&#34;https://weedge.github.io/post/notions/go-tips/go-tips-03-data-types/#27%E4%BD%8E%E6%95%88%E7%9A%84map%E5%88%9D%E5%A7%8B%E5%8C%96&#34;&gt;#27&lt;/a&gt;ï¼‰ï¼šå¦‚æœé•¿åº¦å·²çŸ¥ï¼Œåˆ™é¢„åˆ†é…åˆ‡ç‰‡å’Œæ˜ å°„ã€‚&lt;/li&gt;
&lt;li&gt;æ›´å¥½çš„æ•°æ®ç»“æ„å¯¹é½ä»¥å‡å°‘ç»“æ„å¤§å°ï¼ˆé”™è¯¯ &lt;a href=&#34;https://weedge.github.io/post/notions/go-tips/go-tips-12-optimizations/#94%E4%B8%8D%E7%9F%A5%E9%81%93%E6%95%B0%E6%8D%AE%E5%AF%B9%E9%BD%90&#34;&gt;#94&lt;/a&gt;ï¼‰ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;å¦å¤–è¿˜æœ‰ä¸‰ç§å‡å°‘å†…å­˜åˆ†é…çš„å¸¸è§æ–¹å¼ï¼š&lt;/p&gt;
&lt;h4 id=&#34;api-è®¾è®¡&#34;&gt;API è®¾è®¡&lt;/h4&gt;
&lt;p&gt;åªè¦æ¶‰åŠåˆ°I/Oè¯»å†™ï¼Œä¼šå¤§é‡ä½¿ç”¨åˆ°åœ¨ioåº“https://pkg.go.dev/ioä¸­ï¼Œå®šä¹‰çš„è¯»Reader / å†™Writeræ¥å£, å¯¹åº”çš„APIæ–¹æ³•ï¼Œè®¾è®¡æ—¶ä¸ºä»€ä¹ˆä½¿ç”¨[]byte ä½œä¸ºä¼ å…¥å‚æ•°ï¼Œè¿”å›è¯»å–äº†å¤šå°‘ï¼Œ è€Œä¸ä½¿ç”¨è¯»å–å¤šå°‘æ¥è¿”å›å¯¹åº”[]byteå‘¢ï¼Ÿ&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;kd&#34;&gt;type&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;Reader&lt;/span&gt; &lt;span class=&#34;kd&#34;&gt;interface&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
    &lt;span class=&#34;nf&#34;&gt;Read&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;p&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;[]&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;byte&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;n&lt;/span&gt; &lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;err&lt;/span&gt; &lt;span class=&#34;kt&#34;&gt;error&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;span class=&#34;kd&#34;&gt;type&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;Reader&lt;/span&gt; &lt;span class=&#34;kd&#34;&gt;interface&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
    &lt;span class=&#34;nf&#34;&gt;Read&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;n&lt;/span&gt; &lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;p&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;[]&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;byte&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;err&lt;/span&gt; &lt;span class=&#34;kt&#34;&gt;error&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;å¦‚æœä½¿ç”¨åˆ‡ç‰‡[]byteè¿”å›çš„æ–¹å¼ï¼ŒReadå‡½æ•°å†…éƒ¨ä¼šè¯»å–å‡½æ•°å±€éƒ¨å˜é‡çš„åˆ‡ç‰‡èµ‹å€¼ç»™è¿”å›çš„åˆ‡ç‰‡ï¼Œ ç±»ä¼¼å¦‚ä¸‹æ“ä½œï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;kd&#34;&gt;type&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;HiString&lt;/span&gt; &lt;span class=&#34;kd&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{}&lt;/span&gt;
&lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;m&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;HiString&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;Read&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;n&lt;/span&gt; &lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;p&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;[]&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;byte&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;err&lt;/span&gt; &lt;span class=&#34;kt&#34;&gt;error&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
	&lt;span class=&#34;nx&#34;&gt;s&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;[]&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;byte&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;4&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;5&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;6&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;7&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
	&lt;span class=&#34;nx&#34;&gt;p&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;s&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[:&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;n&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt; &lt;span class=&#34;c1&#34;&gt;//[]byte{...} escapes to heap
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;	&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;è¿™æ ·å‡½æ•°å±€éƒ¨å˜é‡ä¼šé€ƒé€¸åˆ°å †ä¸Šåˆ†é…ï¼Œè¿™æ ·å¸¦äº†é¢å¤–çš„gcå½±å“ï¼Œè€Œä¸”ioåº“çš„æ¥å£ç»å¸¸ä¼šè¢«ä¸åŒå¯¹è±¡å®ä¾‹åŒ–ä½¿ç”¨åˆ°ã€‚æ‰€ä»¥Go çš„è®¾è®¡è€…ä½¿ç”¨å‘ä¸‹å…±äº«çš„æ–¹æ³•æ¥é˜²æ­¢è‡ªåŠ¨å°†åˆ‡ç‰‡è½¬ä¹‰åˆ°å †ä¸­ï¼›ç”±è°ƒç”¨è€…æä¾›è¯»å†™çš„åˆ‡ç‰‡[]byteï¼Œè‡³äºæ˜¯å¦åˆ†é…åœ¨å †ä¸Šè¿˜æ˜¯æ ˆä¸Šï¼Œè¿™å–å†³äºè°ƒç”¨è€…æ¥å¤„ç†å®ƒï¼Œè€Œä¸æ˜¯ç›´æ¥è¿”å›ï¼Œå¯¼è‡´é€ƒé€¸å‘ç”Ÿçš„å¯èƒ½ã€‚&lt;/p&gt;
&lt;p&gt;æœ‰æ—¶ï¼Œå³ä½¿æ˜¯ API çš„å¾®å°å˜åŒ–ä¹Ÿä¼šå¯¹åˆ†é…äº§ç”Ÿç§¯æå½±å“ã€‚åœ¨è®¾è®¡ API æ—¶ï¼Œäº†è§£é€ƒé€¸åˆ†æè§„åˆ™ï¼Œå¹¶åœ¨éœ€è¦æ—¶ä½¿ç”¨å®ƒ&lt;code&gt;-gcflags&lt;/code&gt;æ¥ç†è§£ç¼–è¯‘å™¨çš„å†³ç­–ã€‚&lt;/p&gt;
&lt;h4 id=&#34;ä¾èµ–ç¼–è¯‘å™¨ä¼˜åŒ–&#34;&gt;ä¾èµ–ç¼–è¯‘å™¨ä¼˜åŒ–&lt;/h4&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;c1&#34;&gt;// go tool compile -m=1 -l -L -S -N see if use runtime.slicebytetostring
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;m&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;kd&#34;&gt;map&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;string&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{}&lt;/span&gt;
&lt;span class=&#34;nx&#34;&gt;bytes&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;[]&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;byte&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;span class=&#34;nx&#34;&gt;key&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;string&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;bytes&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;c1&#34;&gt;// m[string(key)] would be more efficient than k := string(key); m[k] (SA6001)go-staticcheck
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;_&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;m&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;key&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;

&lt;span class=&#34;nx&#34;&gt;_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;_&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;m&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;string&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;bytes&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)]&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;å¦‚ä¸Šä»£ç ï¼Œé€šè¿‡linterç›¸å…³é™æ€ç¼–è¯‘æ£€æŸ¥å·¥å…·å¯ä»¥æç¤ºå‡º ç›´æ¥ä½¿ç”¨m[string(key)]çš„æ–¹å¼æ¯”k := string(key); m[k] æ•ˆç‡æ›´é«˜ä¸€äº›ï¼Œå› ä¸ºç¼–è¯‘å™¨å¯¹m[string(key)] è¿›è¡Œäº†ä¼˜åŒ–ï¼Œä¸ä¼šè°ƒç”¨runtime.slicebytetostring è¿›è¡Œå¤åˆ¶è½¬åŒ–ï¼Œæ‰§è¡Œæ•ˆç‡æ›´å¿«ï¼Œä¹Ÿä¸ä¼šå¸¦äº†é¢å¤–å†…å­˜åˆ†é…ã€‚&lt;/p&gt;
&lt;h4 id=&#34;æ± åŒ–syncpool&#34;&gt;æ± åŒ–sync.Pool&lt;/h4&gt;
&lt;p&gt;å½“å¤„ç†çš„å¯¹è±¡ï¼Œåˆ†é…åœ¨å †ä¸Šï¼Œä¸”é¢‘ç¹è¢«åˆ›å»ºä½¿ç”¨ï¼Œè¿™æ ·ä¼šè§¦å‘é¢‘ç¹gcï¼Œå¯¹è¿™äº›ä¸´æ—¶å¯¹è±¡æ ‡è®°æ‰«æï¼Œä¼šå¸¦æ¥é¢å¤–æ€§èƒ½å½±å“ï¼Œæ‰€ä»¥åœ¨Goå¼•å…¥äº†sync.Poolï¼Œå¤ç”¨ä¸´æ—¶å¯¹è±¡ï¼Œå‡å°‘é¢‘ç¹åˆ›å»ºï¼Œå¹¶ä¸”åœ¨æ± ä¸­çš„ä¸´æ—¶å¯¹è±¡ä¸€æ®µæ—¶é—´ä¸åœ¨ä½¿ç”¨æ—¶ï¼Œä¼šä»å¯¹è±¡æ± ä¸­ç§»å‡ºï¼Œå¹¶è¢«gcå›æ”¶ï¼Œåˆç†çš„è§¦å‘æœºåˆ¶ç”±gcæ¥ç®¡ç†ï¼Œè¿›è€Œå‡å°‘é¢‘ç¹gcã€‚è€Œä¸”sync.Pool æœ¬èº«å°±æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå¤šä¸ª goroutine å¯ä»¥å¹¶å‘åœ°è°ƒç”¨Getæ–¹æ³•å­˜å–å¯¹è±¡ï¼›sync.Pool ä¸å¯åœ¨ä½¿ç”¨ä¹‹åå†å¤åˆ¶ä½¿ç”¨ï¼Œå¼•å…¥äº†noCopyæœºåˆ¶ï¼Œå¯ä»¥é€šè¿‡go vetæ¥æ£€æŸ¥ã€‚&lt;/p&gt;
&lt;p&gt;sync.Poolæœ‰ä¸¤ä¸ªå…¬å¼€æ–¹æ³•Getï¼Œ Put ä»¥åŠåˆå§‹åŒ–Poolæ˜¯çš„New å‡½æ•°æˆå‘˜ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781617299599/files/Images/CH12_F34_Harsanyi.png&#34; alt=&#34;https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781617299599/files/Images/CH12_F34_Harsanyi.png&#34;&gt;&lt;/p&gt;
&lt;p&gt;Get æ–¹æ³•åˆ†ä¸ºä¸¤ç§æƒ…å†µï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;poolä¸ºç©ºï¼Œé€šè¿‡è‡ªå®šä¹‰çš„Newæ–¹æ³•åˆ›å»ºä¸€ä¸ªæ–°å¯¹è±¡ï¼Œæ³¨æ„è¿™ä¸ªå¯¹è±¡æ˜¯åŒä¸€ç±»å‹ï¼›ç„¶åè¿”å›åˆšåˆ›å»ºçš„å¯¹è±¡ï¼Œé™¤äº†è¿”å›å€¼æ˜¯æ­£å¸¸å®ä¾‹åŒ–çš„å¯¹è±¡ï¼ŒGet æ–¹æ³•çš„è¿”å›å€¼è¿˜å¯èƒ½ä¼šæ˜¯ä¸€ä¸ª nilï¼ˆPool.New å­—æ®µæ²¡æœ‰è®¾ç½®ï¼Œåˆæ²¡æœ‰ç©ºé—²å…ƒç´ å¯ä»¥è¿”å›ï¼‰ï¼Œæ‰€ä»¥åœ¨ä½¿ç”¨çš„æ—¶å€™ï¼Œéœ€è¦åˆ¤æ–­ã€‚å½“æ²¡æœ‰è®¾ç½® New å­—æ®µï¼Œæ²¡æœ‰æ›´å¤šçš„ç©ºé—²å…ƒç´ å¯è¿”å›æ—¶ï¼ŒGet æ–¹æ³•å°†è¿”å› nilï¼Œè¡¨æ˜å½“å‰æ²¡æœ‰å¯ç”¨çš„å…ƒç´ ã€‚&lt;/li&gt;
&lt;li&gt;poolä¸ä¸ºç©ºï¼Œ ç›´æ¥ä»æ± å­ä¸­é€‰ä¸€ä¸ªå¤ç”¨å¯¹è±¡è¿”å›&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Putï¼š å°†å¯¹è±¡é‡ç½®ä¸ºåˆå§‹å¯¹è±¡ï¼Œæ”¾å…¥æ± å­ä¸­(poolLocalInternalç»“æ„)ï¼Œå¦‚æœæ”¾å…¥å¯¹è±¡ä¸ºnilï¼Œåˆ™ä¼šå¿½ç•¥æ‰ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;c1&#34;&gt;// Local per-P Pool appendix.
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;type&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;poolLocalInternal&lt;/span&gt; &lt;span class=&#34;kd&#34;&gt;struct&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
	&lt;span class=&#34;nx&#34;&gt;private&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;any&lt;/span&gt;       &lt;span class=&#34;c1&#34;&gt;// Can be used only by the respective P.
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;	&lt;span class=&#34;nx&#34;&gt;shared&lt;/span&gt;  &lt;span class=&#34;nx&#34;&gt;poolChain&lt;/span&gt; &lt;span class=&#34;c1&#34;&gt;// Local P can pushHead/popHead; any P can popTail.
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;private: ä»…è¢«æœ¬åœ°Pä½¿ç”¨ï¼Œäº’æ–¥ Put/Get&lt;/p&gt;
&lt;p&gt;shared: poolChain(lock-free queue)ï¼š ä¸€ä¸ªæœ¬åœ°çš„ P ä½œä¸ºç”Ÿäº§è€…ï¼ˆProducerï¼‰pushHead/popHead (Put/Get)ï¼Œå¤šä¸ª P ä½œä¸ºæ¶ˆè´¹è€…ï¼ˆConsumerï¼‰popTail (Get)&lt;/p&gt;
&lt;p&gt;å…·ä½“è§æºç åˆ†æï¼š&lt;a href=&#34;https://github.com/golang/go/blob/go1.20/src/sync/pool.go&#34;&gt;go1.20/src/sync/pool.go&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;åœ¨é¢‘ç¹è¯»å†™IOåœºæ™¯ä¸‹ï¼Œsync.Pool  å¸¸ç”¨ä½œ buffer poolï¼ˆç¼“å†²æ± ï¼‰æ¥æå‡è¯»å†™æ€§èƒ½ã€‚ç±»ä¼¼è¿™ç§å°è£…ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;kd&#34;&gt;var&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;bufferPool&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;sync&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Pool&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
	&lt;span class=&#34;nx&#34;&gt;New&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;any&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
		&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;bytes&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Buffer&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{}&lt;/span&gt;
	&lt;span class=&#34;p&#34;&gt;},&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;

&lt;span class=&#34;c1&#34;&gt;// GetBuffer returns a buffer from the pool.
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;GetBuffer&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;buf&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;bytes&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Buffer&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
	&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;bufferPool&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Get&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;().(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;bytes&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Buffer&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;

&lt;span class=&#34;c1&#34;&gt;// PutBuffer returns a buffer to the pool.
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// The buffer is reset before it is put back into circulation.
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;PutBuffer&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;buf&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;bytes&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Buffer&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
	&lt;span class=&#34;nx&#34;&gt;buf&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Reset&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
	&lt;span class=&#34;nx&#34;&gt;bufferPool&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Put&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;buf&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;sync.Poolä¸é€‚åˆé•¿æ—¶é—´ä¸ä¼šé‡Šæ”¾çš„èµ„æº æ¯”å¦‚é•¿è¿æ¥ï¼›å› ä¸ºsync.Poolæ± åŒ–çš„å¯¹è±¡å¯èƒ½ä¼šè¢«åƒåœ¾å›æ”¶æ‰ï¼Œå¯¹äºæ•°æ®åº“é•¿è¿æ¥ç­‰åœºæ™¯æ˜¯ä¸åˆé€‚ã€‚&lt;/p&gt;
&lt;p&gt;å¦‚æœç»å¸¸åˆ†é…å¾ˆå¤šåŒç±»å‹çš„å¯¹è±¡ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨sync.Pool. å®ƒæ˜¯ä¸€ç»„ä¸´æ—¶å¯¹è±¡ï¼Œå¯ä»¥é˜²æ­¢é‡å¤é‡æ–°åˆ†é…åŒä¸€ç§æ•°æ®ï¼›å¹¶ä¸”sync.Poolå¯ä»¥å®‰å…¨åœ°åŒæ—¶è¢«å¤šä¸ª goroutines ä½¿ç”¨ã€‚&lt;/p&gt;
&lt;h3 id=&#34;97ä¸ä¾èµ–å†…è”&#34;&gt;97.ä¸ä¾èµ–å†…è”&lt;/h3&gt;
&lt;p&gt;å†…è”æ˜¯å°†è¾ƒå°çš„å‡½æ•°ç»„åˆåˆ°å®ƒä»¬å„è‡ªçš„è°ƒç”¨è€…ä¸­çš„è¡Œä¸ºã€‚åœ¨è®¡ç®—çš„æ—©æœŸï¼Œè¿™ç§ä¼˜åŒ–é€šå¸¸æ˜¯æ‰‹åŠ¨æ‰§è¡Œçš„ã€‚å¦‚ä»Šï¼Œå†…è”æ˜¯åœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­è‡ªåŠ¨æ‰§è¡Œçš„ä¸€ç±»åŸºæœ¬ä¼˜åŒ–ä¹‹ä¸€ã€‚&lt;/p&gt;
&lt;p&gt;å†…è”å¾ˆé‡è¦æœ‰ä¸¤ä¸ªåŸå› ã€‚é¦–å…ˆæ˜¯å®ƒæ¶ˆé™¤äº†å‡½æ•°è°ƒç”¨æœ¬èº«çš„å¼€é”€ã€‚ç¬¬äºŒä¸ªæ˜¯å®ƒå…è®¸ç¼–è¯‘å™¨æ›´æœ‰æ•ˆåœ°åº”ç”¨å…¶ä»–ä¼˜åŒ–ç­–ç•¥,æ¯”å¦‚æ ˆä¸­å†…è”(Go 1.9 å¼•å…¥ Mid-stack inlining)ï¼›&lt;/p&gt;
&lt;p&gt;äº†è§£æ›´å¤šMid-stack inliningç›¸å…³å†…å®¹ï¼š &lt;a href=&#34;https://go.googlesource.com/proposal/+/master/design/19348-midstack-inlining.md&#34;&gt;ææ¡ˆ&lt;/a&gt;  , HN ä¸Šçš„è®¨è®ºä»¥åŠPPT: &lt;a href=&#34;https://news.ycombinator.com/item?id=13803447&#34;&gt;Mid-stack inlining in the Go compiler&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;è¿™ç§ä¼˜åŒ–æŠ€æœ¯æ˜¯å…³äºåŒºåˆ†å¿«è·¯å¾„å’Œæ…¢è·¯å¾„ã€‚å¦‚æœå¯ä»¥å†…è”å¿«é€Ÿè·¯å¾„ä½†ä¸èƒ½å†…è”æ…¢é€Ÿè·¯å¾„ï¼Œå¯ä»¥å°†æ…¢é€Ÿè·¯å¾„æå–åˆ°ä¸“ç”¨å‡½æ•°ä¸­ã€‚å¦‚æœæ²¡æœ‰è¶…å‡ºå†…è”é¢„ç®—ï¼Œå‡½æ•°å°±æ˜¯å†…è”çš„å€™é€‰è€…ã€‚&lt;/p&gt;
&lt;p&gt;äº†è§£å†…è”å¦‚ä½•å·¥ä½œä»¥åŠå¦‚ä½•è®¿é—®ç¼–è¯‘å™¨çš„å†³å®šï¼Œå¯ä»¥æˆä¸ºä½¿ç”¨å¿«é€Ÿè·¯å¾„å†…è”æŠ€æœ¯è¿›è¡Œä¼˜åŒ–çš„é€”å¾„ã€‚å¦‚æœæ‰§è¡Œå¿«é€Ÿè·¯å¾„ï¼Œåˆ™åœ¨ä¸“ç”¨å‡½æ•°ä¸­æå–æ…¢é€Ÿè·¯å¾„å¯é˜²æ­¢å‡½æ•°è°ƒç”¨ã€‚ä¾‹å¦‚ï¼šsyncåº“ä¸­ä½¿ç”¨Mutex.Lock Mutex.UnLockï¼›&lt;a href=&#34;http://Once.Do&#34;&gt;Once.Do&lt;/a&gt; ç”¨åˆ°äº†å¿«é€Ÿè·¯å¾„å†…è”æŠ€æœ¯è¿›è¡Œä¼˜åŒ–ã€‚&lt;/p&gt;
&lt;p&gt;tips: å…·ä½“ä¼˜åŒ–æ”¶ç›Šï¼Œéƒ½éœ€è¦è¿›è¡ŒåŸºå‡†å‹æµ‹ä¸ºå‡†&lt;/p&gt;
&lt;h3 id=&#34;98ä¸ä½¿ç”¨-go-è¯Šæ–­å·¥å…·-é‡è¦&#34;&gt;98.ä¸ä½¿ç”¨ Go è¯Šæ–­å·¥å…· ï¼ˆé‡è¦ï¼‰&lt;/h3&gt;
&lt;p&gt;Go æä¾›äº†ä¸€äº›ä¼˜ç§€çš„è¯Šæ–­å·¥å…·æ¥å¸®åŠ©æ·±å…¥äº†è§£åº”ç”¨ç¨‹åºçš„æ‰§è¡Œæƒ…å†µï¼Œé‡ç‚¹ä»‹ç»æœ€é‡è¦çš„éƒ¨åˆ†ï¼šå‰–æProfiling å’Œ æ‰§è¡Œè·Ÿè¸ªå™¨ Execution Tracerã€‚å…·ä½“æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£ï¼š &lt;strong&gt;&lt;a href=&#34;https://go.dev/doc/diagnostics&#34;&gt;https://go.dev/doc/diagnostics&lt;/a&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Profiling å¯¹è¿è¡Œä¸­çš„ä»£ç é‡‡ç”¨åŸºäºå®šæ—¶å™¨çš„é‡‡æ ·ã€‚å…¶ç¼ºç‚¹æ˜¯ï¼Œé‡‡æ ·åªèƒ½æä¾›ä¸€ä¸ªå…³äºç›®æ ‡çš„ç²—ç•¥çš„å›¾åƒï¼Œå¹¶ä¸”å¯èƒ½ä¼šé—æ¼äº‹ä»¶ã€‚ æ¯”å¦‚cpuæ•°æ®çš„é‡‡é›†ï¼Œç”±äºæ¯æ¬¡é‡‡é›†éƒ½ä¼šè§¦å‘ä¸€æ¬¡SIGPROF ä¿¡å·ä¸­æ–­ï¼Œæ”¶é›†å½“æ—¶çš„è°ƒç”¨å †æ ˆï¼›ä¼šå¯¹è¢«é‡‡é›†çš„ç³»ç»Ÿå¸¦æ¥é¢å¤–çš„è´Ÿè½½å½±å“ï¼Œåœ¨é‡‡é›†cpuæ•°æ®é¢‘ç‡ä¸€èˆ¬æ§åˆ¶æ¯«ç§’çº§åˆ«ï¼Œæ‰€ä»¥å­˜åœ¨é‡‡é›†ç²¾åº¦çš„å½±å“ï¼›å¯¹äºå¾®å¦™çº§åˆ«çš„é‡‡æ ·ï¼Œç°åœ¨è¿˜ä¸æ”¯æŒï¼Œæœ‰ä¸ªæ”¹è¿›çš„ &lt;a href=&#34;https://go.googlesource.com/proposal/+/refs/changes/08/219508/2/design/36821-perf-counter-pprof.md&#34;&gt;ææ¡ˆ&lt;/a&gt; ï¼Œè¿˜æœªåˆå¹¶ã€‚&lt;/p&gt;
&lt;p&gt;Execution Tracerç”¨æ¥æ•è·å„ç§è¿è¡Œæ—¶äº‹ä»¶ã€‚è°ƒåº¦ã€ç³»ç»Ÿè°ƒç”¨ã€åƒåœ¾æ”¶é›†ã€å †å¤§å°å’Œå…¶ä»–äº‹ä»¶ç”±è¿è¡Œæ—¶æ”¶é›†ï¼Œå¹¶å¯é€šè¿‡ go å·¥å…·è·Ÿè¸ªè¿›è¡Œå¯è§†åŒ–ã€‚æ‰§è¡Œè·Ÿè¸ªå™¨æ˜¯ä¸€ç§æ£€æµ‹å»¶è¿Ÿå’Œåˆ©ç”¨ç‡é—®é¢˜çš„å·¥å…·ï¼Œå¯ä»¥ç”¨æ¥æ£€æŸ¥ CPU çš„ä½¿ç”¨æƒ…å†µï¼Œä»¥åŠåœ¨ç½‘ç»œæˆ–ç³»ç»Ÿè°ƒç”¨æ—¶goroutine æŠ¢å çš„åŸå› ã€‚&lt;/p&gt;
&lt;h4 id=&#34;åˆ†æ-profiling&#34;&gt;åˆ†æ Profiling&lt;/h4&gt;
&lt;p&gt;åˆ†ææä¾›äº†å¯¹åº”ç”¨ç¨‹åºæ‰§è¡Œçš„æ´å¯ŸåŠ›ã€‚èƒ½å¤Ÿè§£å†³æ€§èƒ½é—®é¢˜ã€æ£€æµ‹äº‰ç”¨ã€å®šä½å†…å­˜æ³„æ¼ç­‰ã€‚é€šè¿‡å¦‚ä¸‹å‡ ä¸ªé‡‡é›†ç±»å‹æ”¶é›†ï¼Œå¹¶é€šè¿‡go tool pprof åˆ†æï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;cpu: ç¡®å®šåº”ç”¨ç¨‹åºå°†æ—¶é—´èŠ±åœ¨å“ªé‡Œ&lt;/li&gt;
&lt;li&gt;threadcreate: åˆ›å»ºçš„çº¿ç¨‹æ•°, è¿™ä¸ªé‡‡é›†ç‚¹ï¼Œ2013å¹´ &lt;a href=&#34;https://github.com/golang/go/issues/17280&#34;&gt;https://github.com/golang/go/issues/17280&lt;/a&gt; è¿™ä¸ªissue å·²ç»ä¸å¯ç”¨äº†ï¼Œæ–°çš„è¿˜æœªmergedã€‚&lt;/li&gt;
&lt;li&gt;goroutineï¼šæŠ¥å‘Šæ­£åœ¨è¿›è¡Œçš„ goroutines çš„å †æ ˆè·Ÿè¸ª&lt;/li&gt;
&lt;li&gt;heapï¼šæŠ¥é“å †å†…å­˜åˆ†é…ä»¥ç›‘è§†å½“å‰å†…å­˜ä½¿ç”¨æƒ…å†µå¹¶æ£€æŸ¥å¯èƒ½çš„å†…å­˜æ³„æ¼&lt;/li&gt;
&lt;li&gt;mutexï¼šæŠ¥å‘Šé”æŸ¥çœ‹ä»£ç ä¸­ä½¿ç”¨çš„äº’æ–¥ä½“çš„è¡Œä¸ºä»¥åŠåº”ç”¨ç¨‹åºæ˜¯å¦åœ¨é”å®šè°ƒç”¨ä¸ŠèŠ±è´¹äº†å¤ªå¤šæ—¶é—´çš„äº‰ç”¨&lt;/li&gt;
&lt;li&gt;blockï¼šæ˜¾ç¤º goroutines é˜»å¡ç­‰å¾…åŒæ­¥åŸè¯­çš„ä½ç½®&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Goä¸­æä¾›3ç§æ–¹å¼ä½¿ç”¨pprofæ¥é‡‡æ ·æ•°æ®ï¼Œé€šè¿‡go tool pprof å·¥å…·æ¥åˆ†æï¼Œå…·ä½“è§æ–‡æ¡£è¯´æ˜ï¼š &lt;a href=&#34;https://github.com/google/pprof/blob/main/doc/README.md&#34;&gt;https://github.com/google/pprof/blob/main/doc/README.md&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;ä½¿ç”¨è¿è¡Œæ—¶pprofåŒ… æ¥å£APIæ¥é‡‡æ ·æ•°æ®&lt;/strong&gt;ï¼š &lt;a href=&#34;https://pkg.go.dev/runtime/pprof&#34;&gt;https://pkg.go.dev/runtime/pprof&lt;/a&gt; ï¼›æ¥å£ apiåˆ†æé‡‡æ ·æ•°æ®ç±»å‹å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;goroutine    - stack traces of all current goroutines
heap         - a sampling of memory allocations of live objects
allocs       - a sampling of all past memory allocations
threadcreate - stack traces that led to the creation of new OS threads
block        - stack traces that led to blocking on synchronization primitives
mutex        - stack traces of holders of contended mutexes
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;å…·ä½“è§æºç ï¼š&lt;a href=&#34;https://github.com/golang/go/blob/go1.20/src/runtime/pprof/pprof.go&#34;&gt;go1.20/src/runtime/pprof/pprof.go&lt;/a&gt;ï¼Œå¯ä»¥ä½¿ç”¨Profileç»“æ„æ¥è¿›è¡ŒäºŒæ¬¡å¼€å‘,æ–°å¢é‡‡æ ·ç±»å‹ã€‚è¿è¡Œæ—¶åˆ†æé€‚ç”¨äºæ²¡æœ‰ HTTP æ¥å£çš„åº”ç”¨ç¨‹åºï¼Œé€šå¸¸ç”¨äºåº“ã€‚å¿…é¡»åœ¨ä¸»å‡½æ•°ä¸­æ”¾ç½®ä¸€ä¸ªå¯åŠ¨å’Œåœæ­¢å‡½æ•°å¥æŸ„ã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;ä½¿ç”¨ç½‘ç»œnet/http pprofåŒ… httpæ¥å£æ¥é‡‡æ ·æ•°æ®&lt;/strong&gt;ï¼š &lt;a href=&#34;http://pkg.go.dev/net/http/pprof&#34;&gt;https: //pkg.go.dev/net/http/pprof&lt;/a&gt;ï¼› http apiæ¥å£é‡‡æ ·æ•°æ®ç±»å‹å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;import _ &lt;span class=&#34;s2&#34;&gt;&amp;#34;net/http/pprof&amp;#34;&lt;/span&gt;
go func&lt;span class=&#34;o&#34;&gt;()&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;{&lt;/span&gt;
	log.Println&lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;http.ListenAndServe&lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;localhost:6060&amp;#34;&lt;/span&gt;, nil&lt;span class=&#34;o&#34;&gt;))&lt;/span&gt;
&lt;span class=&#34;o&#34;&gt;}()&lt;/span&gt;
&lt;span class=&#34;c1&#34;&gt;# use 6060 port&lt;/span&gt;
&lt;span class=&#34;c1&#34;&gt;# cpu seconds=30s , debug=1&lt;/span&gt;
http://localhost:6060/debug/pprof/profile?seconds&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;30&lt;span class=&#34;p&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;debug&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;1&lt;/span&gt;
http://localhost:6060/debug/pprof/heap
http://localhost:6060/debug/pprof/block
http://localhost:6060/debug/pprof/mutex
http://localhost:6060/debug/pprof/goroutine?debug&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;1&lt;/span&gt;
http://localhost:6060/debug/pprof/allocs?debug&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;1&lt;/span&gt;
http://localhost:6060/debug/pprof/threadcreate?debug&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;1&lt;/span&gt;

http://localhost:6060/debug/pprof/cmdline?debug&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;1&lt;/span&gt;

&lt;span class=&#34;c1&#34;&gt;# view all pprof&lt;/span&gt;
http://localhost:6060/debug/pprof
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;ç½‘ç»œåˆ†ææ›´é€‚åˆä¾èµ– HTTP çš„ API åº”ç”¨ç¨‹åºã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;ä½¿ç”¨åŸºå‡†å‹æµ‹æ¥é‡‡æ ·æ•°æ®ï¼š&lt;/strong&gt; &lt;a href=&#34;https://pkg.go.dev/cmd/go#hdr-Testing_flags&#34;&gt;https://pkg.go.dev/cmd/go#hdr-Testing_flags&lt;/a&gt; ï¼Œæ²¡æœ‰goroutineçš„é‡‡æ ·ï¼Œå¯ä»¥å€ŸåŠ© traceå·¥å…·æ¥åˆ†ægoroutineçš„ç»†ç²’åº¦è°ƒåº¦æƒ…å†µï¼Œä½¿ç”¨ -trace trace.out ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;c1&#34;&gt;# sampling&lt;/span&gt;
go &lt;span class=&#34;nb&#34;&gt;test&lt;/span&gt; -v -bench&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;Benchmark_parallelMergesortV1$  -count&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;1&lt;/span&gt; -benchtime&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;1s -benchmem -cpuprofile cpu.out -memprofile mem.out -mutexprofile mutex.out -blockprofile block.out ./08-concurrency-foundations/56-faster/
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;æœ€ç»ˆé‡‡é›†çš„æ ·æœ¬æ•°æ®, è¿™äº›æ•°æ®ç”±pbæ ¼å¼ç¼–ç (pbæ ¼å¼æ•°æ®ç»å¸¸ç”¨äºå¤§æ•°æ®åœºæ™¯ï¼Œæ•°æ®å ç”¨ç©ºé—´ä½)ï¼Œ pprof è¯»å– profile.proto æ ¼å¼çš„åˆ†ææ ·æœ¬é›†åˆå¹¶ç”ŸæˆæŠ¥å‘Šä»¥å¯è§†åŒ–å’Œå¸®åŠ©åˆ†ææ•°æ®ã€‚å®ƒå¯ä»¥ç”Ÿæˆæ–‡æœ¬å’Œå›¾å½¢æŠ¥å‘Šï¼ˆé€šè¿‡ä½¿ç”¨ç‚¹å¯è§†åŒ–åŒ…ï¼‰ã€‚é€šè¿‡å‘½ä»¤ go tool pprof æ¥åˆ†æï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;c1&#34;&gt;# text cmd pprof or use web cmd in pprof view need graphviz&lt;/span&gt;
go tool pprof cpu.out
go tool pprof mem.out
go tool pprof mutex.out
go tool pprof block.out

&lt;span class=&#34;c1&#34;&gt;# http webui pprof view see flamegraph&lt;/span&gt;
go tool pprof -http&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;:8080&amp;#34;&lt;/span&gt; cpu.out

&lt;span class=&#34;c1&#34;&gt;# if use net/http/pprof; use http api fetch sample data **.pb.gz file to pprof&lt;/span&gt;
&lt;span class=&#34;c1&#34;&gt;# fetch cpu profiling&lt;/span&gt;
 go tool pprof http://localhost:6060/debug/pprof/profile?seconds&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;30&lt;span class=&#34;p&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;debug&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;1&lt;/span&gt;

 go tool pprof http://localhost:6060/debug/pprof/heap
 go tool pprof http://localhost:6060/debug/pprof/block
 go tool pprof http://localhost:6060/debug/pprof/mutex
 go tool pprof http://localhost:6060/debug/pprof/goroutine?debug&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;1&lt;/span&gt;
 go tool pprof http://localhost:6060/debug/pprof/allocs?debug&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;1&lt;/span&gt;
 go tool pprof http://localhost:6060/debug/pprof/threadcreate?debug&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;1&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h4 id=&#34;cpuåˆ†æ&#34;&gt;CPUåˆ†æ&lt;/h4&gt;
&lt;p&gt;CPU åˆ†æå™¨ä¾èµ–äºæ“ä½œç³»ç»Ÿå’Œä¿¡å·ã€‚å½“å®ƒè¢«æ¿€æ´»æ—¶ï¼Œåº”ç”¨ç¨‹åºé»˜è®¤è¦æ±‚æ“ä½œç³»ç»Ÿæ¯ 10 æ¯«ç§’ä¸­æ–­ä¸€æ¬¡ï¼Œé€šè¿‡ä¸€ä¸ª&lt;code&gt;SIGPROF&lt;/code&gt;ä¿¡å·ã€‚å½“åº”ç”¨ç¨‹åºæ”¶åˆ°ä¸€ä¸ª æ—¶&lt;code&gt;SIGPROF&lt;/code&gt;ï¼Œå®ƒä¼šæš‚åœå½“å‰æ´»åŠ¨å¹¶å°†æ‰§è¡Œè½¬ç§»åˆ°æ¢æŸ¥å™¨ã€‚æ¢æŸ¥å™¨æ”¶é›†è¯¸å¦‚å½“å‰ goroutine æ´»åŠ¨ä¹‹ç±»çš„æ•°æ®ï¼Œå¹¶æ±‡æ€»å¯ä»¥æ£€ç´¢çš„æ‰§è¡Œç»Ÿè®¡ä¿¡æ¯ã€‚ç„¶åå®ƒåœæ­¢ï¼Œå¹¶ç»§ç»­æ‰§è¡Œç›´åˆ°ä¸‹ä¸€ä¸ª&lt;code&gt;SIGPROF&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;å¯ä»¥è®¿é—® /debug/pprof/profile ç«¯ç‚¹æ¥æ¿€æ´» CPU åˆ†æã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œè®¿é—®æ­¤ç«¯ç‚¹ä¼šæ‰§è¡Œ 30 ç§’çš„ CPU åˆ†æã€‚åœ¨ 30 ç§’å†…ï¼Œåº”ç”¨ç¨‹åºæ¯ 10 æ¯«ç§’ä¸­æ–­ä¸€æ¬¡ã€‚è¯·æ³¨æ„ï¼Œå¯ä»¥æ›´æ”¹è¿™ä¸¤ä¸ªé»˜è®¤å€¼ï¼šå¯ä»¥ä½¿ç”¨å‚æ•°&lt;code&gt;seconds&lt;/code&gt;å°†åˆ†æåº”è¯¥æŒç»­å¤šé•¿æ—¶é—´ä¼ é€’ç»™ç«¯ç‚¹ï¼ˆä¾‹å¦‚ï¼Œ/debug/pprof/profile?seconds=15ï¼‰ï¼Œå¯ä»¥æ›´æ”¹ä¸­æ–­ç‡ï¼ˆç”šè‡³å°äº 10 æ¯«ç§’ï¼‰ã€‚ä½†åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œ10 æ¯«ç§’åº”è¯¥è¶³å¤Ÿäº†ï¼Œåœ¨å‡å°è¿™ä¸ªå€¼ï¼ˆæ„å‘³ç€å¢åŠ é€Ÿç‡ï¼‰æ—¶ï¼Œåº”è¯¥æ³¨æ„ä¸è¦æŸå®³æ€§èƒ½ã€‚30 ç§’åï¼Œä¸‹è½½ CPU åˆ†æå™¨çš„ç»“æœã€‚&lt;/p&gt;
&lt;p&gt;å¯ä»¥ä¸ºä¸åŒçš„å‡½æ•°é™„åŠ æ ‡ç­¾ã€‚ä¾‹å¦‚ï¼Œæƒ³è±¡ä¸€ä¸ªä»ä¸åŒå®¢æˆ·ç«¯è°ƒç”¨çš„é€šç”¨å‡½æ•°ã€‚è¦è·Ÿè¸ªä¸¤ä¸ªå®¢æˆ·èŠ±è´¹çš„æ—¶é—´ï¼Œå¯ä»¥ä½¿ç”¨&lt;code&gt;pprof.Labels&lt;/code&gt;.Go 1.9 å¼€å§‹å¼•å…¥ &lt;strong&gt;&lt;a href=&#34;https://github.com/golang/proposal/blob/master/design/17280-profile-labels.md&#34;&gt;profiler labels&lt;/a&gt;ï¼Œ&lt;/strong&gt; å¯¹äºç‰¹æ®Šè°ƒä¼˜æ€§èƒ½ï¼Œæ¯”å¦‚æŸä¸ªç®—æ³•æ¨¡å‹ï¼Œæˆ–è€…çº¿ä¸Šç‰¹æ®Šåœºæ™¯è§¦å‘çš„æ€§èƒ½é—®é¢˜ï¼Œåœ¨è¿™äº›ç‰¹æ®Šé€»è¾‘æ®µï¼Œå•ç‹¬æ‰“ä¸Šä¸€ä¸ªtag label è¿›è¡Œprofilingçš„æ”¶é›†ï¼Œé€šè¿‡pprof å·¥å…·åˆ†æï¼Œå¯ä»¥é€šè¿‡tagç›¸å…³å‘½ä»¤æ¥è¿‡æ»¤å‡ºæ ·æœ¬æ•°æ®åˆ†æã€‚ä½¿ç”¨ &lt;strong&gt;&lt;a href=&#34;http://godoc.org/github.com/rakyll/goutil/pprofutil&#34;&gt;pprofutil&lt;/a&gt;&lt;/strong&gt; åŒ…è‡ªåŠ¨å°† HTTP è·¯å¾„æ ‡ç­¾æ·»åŠ åˆ°å¤„ç†ç¨‹åºã€‚&lt;/p&gt;
&lt;h4 id=&#34;heapå †åˆ†æ&#34;&gt;Heapå †åˆ†æ&lt;/h4&gt;
&lt;p&gt;å †åˆ†æå¯ä»¥è·å¾—æœ‰å…³å½“å‰å †ä½¿ç”¨æƒ…å†µçš„ç»Ÿè®¡ä¿¡æ¯ã€‚ä¸ CPU åˆ†æä¸€æ ·ï¼Œå †åˆ†æä¹Ÿæ˜¯åŸºäºæ ·æœ¬çš„ã€‚å¯ä»¥æ›´æ”¹æ­¤é€Ÿç‡ï¼Œä½†ä¸åº”è¯¥è¿‡äºç»†åŒ–ï¼Œå› ä¸ºé™ä½é€Ÿç‡è¶Šå¤šï¼Œå †åˆ†ææ”¶é›†æ•°æ®æ‰€éœ€çš„å·¥ä½œå°±è¶Šå¤šã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œæ ·æœ¬åœ¨æ¯ 512 KB å †åˆ†é…çš„ä¸€æ¬¡åˆ†é…ä¸­è¿›è¡Œåˆ†æã€‚&lt;/p&gt;
&lt;p&gt;å †åˆ†æè¿˜å¯ä»¥æŸ¥çœ‹ä¸åŒçš„æ ·æœ¬ç±»å‹ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;alloc_objects&lt;/code&gt;å…¨éƒ¨çš„åˆ†é…çš„å¯¹è±¡æ•°&lt;/li&gt;
&lt;li&gt;&lt;code&gt;alloc_space&lt;/code&gt;å…¨éƒ¨çš„åˆ†é…çš„å†…å­˜é‡&lt;/li&gt;
&lt;li&gt;&lt;code&gt;inuse_objects&lt;/code&gt;æ•°å­—å·²åˆ†é…ä½†å°šæœªé‡Šæ”¾çš„å¯¹è±¡&lt;/li&gt;
&lt;li&gt;&lt;code&gt;inuse_space&lt;/code&gt;æ•°é‡å·²åˆ†é…ä½†å°šæœªé‡Šæ”¾çš„å†…å­˜&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;å †åˆ†æçš„å¦ä¸€ä¸ªéå¸¸æœ‰ç”¨çš„åŠŸèƒ½æ˜¯è·Ÿè¸ªå†…å­˜æ³„æ¼ã€‚ä½¿ç”¨åŸºäº GC çš„è¯­è¨€ï¼Œé€šå¸¸çš„è¿‡ç¨‹å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;è§¦å‘ GCã€‚&lt;/li&gt;
&lt;li&gt;ä¸‹è½½å †åˆ†ææ•°æ®ã€‚&lt;/li&gt;
&lt;li&gt;ç­‰å¾…å‡ ç§’é’Ÿ/åˆ†é’Ÿã€‚&lt;/li&gt;
&lt;li&gt;è§¦å‘å¦ä¸€ä¸ª GCã€‚&lt;/li&gt;
&lt;li&gt;ä¸‹è½½å¦ä¸€ä¸ªå †åˆ†ææ•°æ®ã€‚&lt;/li&gt;
&lt;li&gt;æ¯”è¾ƒè¿™ä¸¤ä¸ªé‡‡é›†çš„åˆ†ææ–‡ä»¶ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;åœ¨ä¸‹è½½æ•°æ®ä¹‹å‰å¼ºåˆ¶æ‰§è¡Œ GC æ˜¯ä¸€ç§é˜²æ­¢é”™è¯¯å‡è®¾çš„æ–¹æ³•ã€‚ä¾‹å¦‚ï¼Œå¦‚æœåœ¨æ²¡æœ‰å…ˆè¿è¡Œ GC çš„æƒ…å†µä¸‹çœ‹åˆ°ä¿ç•™å¯¹è±¡çš„å³°å€¼ï¼Œæ— æ³•ç¡®å®šè¿™æ˜¯æ³„æ¼è¿˜æ˜¯ä¸‹ä¸€æ¬¡ GC å°†æ”¶é›†çš„å¯¹è±¡ã€‚&lt;/p&gt;
&lt;p&gt;ä½¿ç”¨&lt;code&gt;pprof&lt;/code&gt;ï¼Œå¯ä»¥ä¸‹è½½å †åˆ†ææ–‡ä»¶å¹¶åŒæ—¶å¼ºåˆ¶æ‰§è¡Œ GCã€‚Goä¸­çš„è¿‡ç¨‹å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;è½¬åˆ° /debug/pprof/heap?gc=1ï¼ˆè§¦å‘ GC å¹¶ä¸‹è½½é‡‡é›†çš„æ ·æœ¬æ–‡ä»¶ï¼‰ã€‚&lt;/li&gt;
&lt;li&gt;ç­‰å¾…å‡ ç§’é’Ÿ/åˆ†é’Ÿã€‚&lt;/li&gt;
&lt;li&gt;å†æ¬¡è½¬åˆ° /debug/pprof/heap?gc=1ã€‚&lt;/li&gt;
&lt;li&gt;ç”¨äº&lt;code&gt;go tool pprof -http=:8080 -diff_base &amp;lt;file2&amp;gt; &amp;lt;file1&amp;gt;&lt;/code&gt;æ¯”è¾ƒä¸¤ä¸ªé‡‡é›†æ–‡ä»¶ï¼š&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;strong&gt;æ³¨æ„&lt;/strong&gt; ä¸å †ç›¸å…³çš„å¦ä¸€ç§åˆ†æç±»å‹æ˜¯&lt;code&gt;allocs&lt;/code&gt;ï¼Œå®ƒæŠ¥å‘Šåˆ†é…ã€‚å †åˆ†ææ˜¾ç¤ºå †å†…å­˜çš„å½“å‰çŠ¶æ€ã€‚è¦äº†è§£è‡ªåº”ç”¨ç¨‹åºå¯åŠ¨ä»¥æ¥è¿‡å»çš„å†…å­˜åˆ†é…æƒ…å†µï¼Œå¯ä»¥ä½¿ç”¨åˆ†é…åˆ†æã€‚å¦‚å‰æ‰€è¿°ï¼Œç”±äºæ ˆåˆ†é…å¾ˆä¾¿å®œï¼Œå› æ­¤å®ƒä»¬ä¸å±äºæ­¤åˆ†æçš„ä¸€éƒ¨åˆ†ï¼Œè¯¥åˆ†æä»…å…³æ³¨å †ã€‚&lt;/p&gt;
&lt;p&gt;tips: å…³äºæ€§èƒ½åˆ†æï¼Œæ–¹æ³•è®ºï¼Œå…³æ³¨çš„æŒ‡æ ‡ï¼Œå¯ä»¥åœ¨ &lt;a href=&#34;https://www.brendangregg.com/systems-performance-2nd-edition-book.html&#34;&gt;&lt;strong&gt;æ€§èƒ½ä¹‹å·…&lt;/strong&gt;&lt;/a&gt; è¿™æœ¬ä¹¦ä¸­æ‰¾åˆ°ç›¸å…³ä»‹ç»ï¼Œæœ¬è´¨ä¸Šéƒ½æ˜¯åœ¨ç³»ç»Ÿå±‚é¢ç›‘æ§ï¼Œåˆ†æï¼Œå®šä½ã€‚&lt;/p&gt;
&lt;h4 id=&#34;goroutinesåˆ†æ&#34;&gt;Goroutinesåˆ†æ&lt;/h4&gt;
&lt;p&gt;è¯¥&lt;code&gt;goroutine&lt;/code&gt;é…ç½®æ–‡ä»¶æŠ¥å‘Šåº”ç”¨ç¨‹åºä¸­æ‰€æœ‰å½“å‰ goroutine çš„å †æ ˆè·Ÿè¸ªã€‚å¯ä»¥ä½¿ç”¨ debug/pprof/goroutine/?debug=0 ä¸‹è½½ä¸€ä¸ªæ–‡ä»¶å¹¶go tool pprofå†æ¬¡é‡‡é›†åˆ†æï¼Œ å¯ä»¥åˆ†ææ˜¯å¦golangåœ¨æŒç»­ä¸Šæ¶¨ï¼Œè¿›è€Œåˆ¤æ–­æ˜¯å¦æ³„éœ²ã€‚å¯ä»¥æŸ¥çœ‹ goroutine åˆ†æå™¨æ•°æ®ä»¥äº†è§£ç³»ç»Ÿçš„å“ªä¸€éƒ¨åˆ†æ˜¯å¯ç–‘çš„ã€‚&lt;/p&gt;
&lt;h4 id=&#34;blockåˆ†æ&#34;&gt;Blockåˆ†æ&lt;/h4&gt;
&lt;p&gt;é…ç½®æ–‡ä»¶&lt;code&gt;block&lt;/code&gt;æŠ¥å‘Šæ­£åœ¨è¿›è¡Œçš„ goroutines é˜»å¡ç­‰å¾…åŒæ­¥åŸè¯­çš„ä½ç½®ã€‚å¯èƒ½æ€§åŒ…æ‹¬&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;åœ¨æ— ç¼“å†²é€šé“ä¸Šå‘é€æˆ–æ¥æ”¶&lt;/li&gt;
&lt;li&gt;å‘é€åˆ°ä¸€ä¸ªå®Œæ•´çš„é¢‘é“&lt;/li&gt;
&lt;li&gt;ä»ç©ºé¢‘é“æ¥æ”¶&lt;/li&gt;
&lt;li&gt;äº’æ–¥é”äº‰ç”¨&lt;/li&gt;
&lt;li&gt;ç½‘ç»œæˆ–æ–‡ä»¶ç³»ç»Ÿç­‰å¾…&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Blockåˆ†æè¿˜è®°å½•äº† goroutine ç­‰å¾…çš„æ—¶é—´ï¼Œå¯ä»¥é€šè¿‡ debug/pprof/block è®¿é—®ã€‚å¦‚æœæ€€ç–‘æ€§èƒ½å› é˜»æ­¢è°ƒç”¨è€Œå—åˆ°æŸå®³ï¼Œæ­¤é‡‡æ ·åˆ†ææ–‡ä»¶å¯èƒ½ä¼šéå¸¸æœ‰ç”¨ã€‚&lt;/p&gt;
&lt;p&gt;&lt;code&gt;block&lt;/code&gt;é»˜è®¤æƒ…å†µä¸‹ä¸å¯ç”¨é‡‡æ ·åˆ†ææ–‡ä»¶ï¼šå¿…é¡»è°ƒç”¨æ‰èƒ½&lt;code&gt;runtime.SetBlockProfileRate&lt;/code&gt;å¯ç”¨å®ƒã€‚æ­¤å‡½æ•°æ§åˆ¶æŠ¥å‘Šçš„ goroutine é˜»å¡äº‹ä»¶çš„æ¯”ä¾‹ã€‚ä¸€æ—¦å¯ç”¨ï¼Œåˆ†æå™¨å°†ç»§ç»­åœ¨åå°æ”¶é›†æ•°æ®ï¼Œå³ä½¿ä¸è°ƒç”¨ debug/pprof/block ã€‚å¦‚æœæƒ³è®¾ç½®ä¸€ä¸ªé«˜é€Ÿç‡ï¼Œé‚£ä¹ˆè¦å°å¿ƒï¼Œä»¥å…æŸå®³æ€§èƒ½ã€‚&lt;/p&gt;
&lt;h4 id=&#34;å®Œæ•´çš„-goroutine-æ ˆdump&#34;&gt;å®Œæ•´çš„ goroutine æ ˆdump&lt;/h4&gt;
&lt;p&gt;å¦‚æœé‡åˆ°æ­»é”æˆ–æ€€ç–‘ goroutines å¤„äºé˜»å¡çŠ¶æ€ï¼Œåˆ™å®Œæ•´çš„ goroutine æ ˆdump (debug/pprof/goroutine/?debug=2) ä¼šåˆ›å»ºæ‰€æœ‰å½“å‰ goroutine å †æ ˆè·Ÿè¸ªçš„dumpæ•°æ®ã€‚è¿™æœ‰åŠ©äºä½œä¸ºåˆ†æé¦–æ¬¡æ­¥éª¤&lt;/p&gt;
&lt;h4 id=&#34;mutexåˆ†æ&#34;&gt;Mutexåˆ†æ&lt;/h4&gt;
&lt;p&gt;å¦‚æœæ€€ç–‘åº”ç”¨ç¨‹åºèŠ±è´¹å¤§é‡æ—¶é—´ç­‰å¾…é”å®šäº’æ–¥é‡ï¼Œä»è€ŒæŸå®³æ‰§è¡Œï¼Œå¯ä»¥ä½¿ç”¨mutexåˆ†æã€‚&lt;/p&gt;
&lt;p&gt;åœ¨ç”Ÿäº§ç¯å¢ƒå»ºè®®å¯ç”¨&lt;code&gt;pprof&lt;/code&gt;ï¼Œåœ¨å‘ç°æ€§èƒ½é—®é¢˜ï¼Œå»¶æ—¶ï¼Œè´Ÿè½½ï¼Œå†…å­˜ç©ºé—´ä¸Šæ¶¨ç­‰é—®é¢˜ï¼Œå¯ä»¥é‡‡é›†å¯¹åº”ç°åœºä¿¡æ¯è¿›è¡Œåˆ†æï¼Œå¯¹äºcpuçš„é‡‡é›†ä¼šå¯¼è‡´æ€§èƒ½ä¸‹é™ï¼Œä½†ä»…åœ¨å¯ç”¨å®ƒä»¬æœŸé—´æ‰ä¼šå‘ç”Ÿã€‚&lt;/p&gt;
&lt;p&gt;tips: é€šè¿‡ &lt;strong&gt;&lt;a href=&#34;https://go.dev/blog/pprof&#34;&gt;https://go.dev/blog/pprof&lt;/a&gt;&lt;/strong&gt; å­¦ä¹ pprof å…¥é—¨å¾ˆåˆé€‚ï¼Œdemo: &lt;a href=&#34;https://github.com/rsc/benchgraffiti&#34;&gt;https://github.com/rsc/benchgraffiti&lt;/a&gt;&lt;/p&gt;
&lt;h4 id=&#34;æ‰§è¡Œè·Ÿè¸ªå™¨-execution-tracer&#34;&gt;æ‰§è¡Œè·Ÿè¸ªå™¨ Execution Tracer&lt;/h4&gt;
&lt;p&gt;traceå’Œpprofä¸€æ ·ï¼Œä¹Ÿæœ‰ä¸‰ç§æ–¹å¼ï¼š&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;ä½¿ç”¨è¿è¡Œæ—¶traceåŒ… æ¥å£APIæ¥é‡‡æ ·æ•°æ®&lt;/strong&gt;ï¼šhttps://pkg.go.dev/runtime/trace æ¥å£apiæ¥æ”¶é›†å¼€å§‹åˆ°ç»“æŸåŒºé—´çš„traceä¿¡æ¯ï¼Œå’Œ runtime/pprof åŒ…ä¸€æ ·å°†é‡‡é›†çš„traceä¿¡æ¯å†™å…¥æ–‡ä»¶ï¼Œæˆ–è€…äºŒæ¬¡å¼€å‘å†™å…¥ç½‘ç»œio, pushåˆ°ä¸‰æ–¹å¹³å°å»åˆ†æï¼Œå¸¸ç”¨è¯­å¾®æœåŠ¡çš„å¯è§†åŒ–åˆ†æç›‘æ§ã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;ä½¿ç”¨ç½‘ç»œnet/http pprofåŒ… httpæ¥å£æ¥é‡‡æ ·æ•°æ®&lt;/strong&gt;ï¼š &lt;a href=&#34;http://pkg.go.dev/net/http/pprof&#34;&gt;https: //pkg.go.dev/net/http/pprof&lt;/a&gt;ï¼› å’Œpprof httpæ¥å£ä¸€æ ·ï¼Œé‡‡é›†traceçš„ä¸‹è½½æ¥å£ï¼Œå¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;http://localhost:6060/debug/pprof/trace?seconds&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;5&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;strong&gt;ä½¿ç”¨åŸºå‡†å‹æµ‹æ¥é‡‡æ ·æ•°æ®ï¼š&lt;/strong&gt; &lt;a href=&#34;https://pkg.go.dev/cmd/go#hdr-Testing_flags&#34;&gt;https://pkg.go.dev/cmd/go#hdr-Testing_flags&lt;/a&gt;  ä½¿ç”¨ -trace trace.out&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;c1&#34;&gt;# sampling&lt;/span&gt;
go &lt;span class=&#34;nb&#34;&gt;test&lt;/span&gt; -v -bench&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;Benchmark_parallelMergesortV1$ -count&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;1&lt;/span&gt; -benchtime&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;1s ./08-concurrency-foundations/56-faster/ -trace&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;trace.out
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;å°†é‡‡é›†åˆ°çš„traceæ•°æ®é€šè¿‡ go tool trace å¯¹é‡‡é›†æ•°æ®æ–‡ä»¶ trace.out è¿›è¡Œå¯è§†åŒ–åˆ†æã€‚åœ¨å¯è§†åŒ–é¡µé¢å°±å¯ä»¥çœ‹åˆ°å¯¹åº”åˆ†æçš„ä¿¡æ¯ï¼Œæœ‰å¯¹åº”è¯´æ˜ï¼Œå…¶åˆ†æçš„ä¿¡æ¯å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;è¿è¡Œ goroutines çš„äº‹ä»¶æ—¶é—´è¡¨ï¼šæŸ¥çœ‹æ•´ä½“æ—¶é—´æ®µçš„traceä¿¡æ¯ï¼Œçº¿ç¨‹æ•°ï¼Œåç¨‹æ•°ï¼Œå †ï¼ŒGCæ—¶é—´ç­‰ç­‰ï¼› goroutine åˆ†æï¼ŒæŸ¥çœ‹æ¯ä¸ªgoroutineçš„æ‰§è¡Œæ—¶é—´ï¼ŒåŒ…æ‹¬ç½‘ç»œç­‰å¾…ï¼ŒåŒæ­¥block, ç³»ç»Ÿè°ƒç”¨ï¼Œè°ƒåº¦ç­‰å¾…ï¼ŒGCæ¸…æ‰«ï¼ŒGCæš‚åœ(SWT)&lt;/li&gt;
&lt;li&gt;æŸ¥çœ‹è°ƒç”¨é“¾è·¯å³æ¯ä¸ªå‡½æ•°è€—æ—¶delayï¼ŒåŒ…æ‹¬net ç½‘ç»œio, block é˜»å¡io, syscall ç³»ç»Ÿè°ƒç”¨ï¼Œsched åç¨‹è°ƒåº¦æƒ…å†µï¼Œè¿™äº›profile å¯ä»¥å¯¼å‡ºï¼Œè¿›è¡Œå•ç‹¬åˆ†æ&lt;/li&gt;
&lt;li&gt;ä½¿ç”¨&lt;a href=&#34;https://pkg.go.dev/runtime/trace&#34;&gt;https://pkg.go.dev/runtime/trace&lt;/a&gt; åŒ…å¼€å‘ï¼Œå…·ä½“åœ¨æ¨¡å—åŒºåŸŸRegionï¼Œæ‘¸ä¸ªä»»åŠ¡taskä¸‹çš„ç›‘æ§ä¿¡æ¯ï¼Œå¼€æ”¾å‡ºæ¥ï¼Œæ ¹æ®ç”¨æˆ·åœºæ™¯è‡ªå®šä»¥å¼€å‘ã€‚æ˜¾ç¤ºçš„æ¯ä¸ªç›´æ–¹å›¾æ¡¶éƒ½åŒ…å«ä¸€ä¸ªæ ·æœ¬è·Ÿè¸ªè®°å½•äº‹ä»¶åºåˆ—ï¼Œä¾‹å¦‚ goroutine åˆ›å»ºã€æ—¥å¿—äº‹ä»¶å’Œå­åŒºåŸŸå¼€å§‹/ç»“æŸæ—¶é—´ã€‚&lt;/li&gt;
&lt;li&gt;åƒåœ¾æ”¶é›†æŒ‡æ ‡, Minimum mutator utilizationã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;è€Œä¸”å¯ä»¥é€šè¿‡&lt;code&gt;go tool trace -pprof=TYPE trace.out &amp;gt; TYPE.pprof&lt;/code&gt; å°†ä¸åŒé‡‡é›†ç±»å‹çš„æ•°æ®ä»traceæ•°æ®ä¸­å¯¼å‡ºï¼Œè¿›è€Œå¯ä»¥é€šè¿‡go tool pprofè¿›è¡Œå•ç‹¬åˆ†æï¼Œå¯¼å‡ºæ•°æ®ç±»å‹å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;c1&#34;&gt;# net: network blocking profile&lt;/span&gt;
&lt;span class=&#34;c1&#34;&gt;# sync: synchronization blocking profile&lt;/span&gt;
&lt;span class=&#34;c1&#34;&gt;# syscall: syscall blocking profile&lt;/span&gt;
&lt;span class=&#34;c1&#34;&gt;# sched: scheduler latency profile&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;profilingå’Œtracerç»“åˆä½¿ç”¨ï¼š æ¯”å¦‚ ä½¿ç”¨profilingåˆ†æå·¥å…·æ¥åˆ†æå†…å­˜æˆ– CPU ä½¿ç”¨ç‡è¿‡é«˜çš„åŸå› ï¼›ç„¶åé€šè¿‡tracer å·¥å…·æ¥åˆ†ææ¯ä¸ªgoroutineçš„è°ƒåº¦æƒ…å†µï¼Œä»¥åŠæ—¶é—´æ®µçš„æ‰§è¡Œæƒ…å†µï¼Œæ˜¯å¦å‘ç”ŸGC, æ˜¯å¦æœ‰ç³»ç»Ÿè°ƒç”¨ç­‰ç­‰ã€‚traceç²’åº¦æ›´ç»†ï¼Œä½†æ˜¯åˆ†ææ›´è€—æ—¶ã€‚&lt;/p&gt;
&lt;p&gt;tips:  å…·ä½“è¿›ä¸€æ­¥å®è·µï¼Œå¯ä»¥ä¸€èµ·å­¦ä¹ ï¼ŒæŒæ¡åŸç†ï¼Œç†Ÿç»ƒå·¥å…·ï¼š&lt;/p&gt;
&lt;p&gt;Felix GeisendÃ¶rfer  &lt;strong&gt;&lt;a href=&#34;https://github.com/DataDog/go-profiler-notes/blob/main/guide/README.md&#34;&gt;The Busy Developerâ€™s Guide to Go Profiling, Tracing and Observability&lt;/a&gt;&lt;/strong&gt; ä¸­çš„profiling, tracing, obç›¸å…³å®éªŒnotesï¼›&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://swtch.com/~rsc/&#34;&gt;Russ Cox&lt;/a&gt; å…³äº &lt;a href=&#34;https://research.swtch.com/telemetry&#34;&gt;&lt;strong&gt;telemetry&lt;/strong&gt;&lt;/a&gt; å¼•å…¥ go toolchain(å·¥å…·é“¾)ç›¸å…³çš„è®¾è®¡æ€è€ƒ; è®¨è®ºéå¸¸æ´»è·ƒï¼Œä¸æ—¶ä¿±è¿›å‘€~ å¾ˆæœŸå¾…è¿™ä¸ªåŠŸèƒ½ã€‚å¯ä»¥æ‰“é€šgolangå¼€å‘çš„åº”ç”¨ç¨‹åº å’Œ OTEL ç›¸å…³ç›‘æ§ç³»ç»Ÿçš„æ•°æ®æ ¼å¼äº¤äº’ï¼Œè¿›è¡ŒåŒä¸€æ ‡å‡†ç®¡ç†ã€‚&lt;/p&gt;
&lt;h3 id=&#34;99ä¸äº†è§£-gc-çš„å·¥ä½œåŸç†&#34;&gt;99.ä¸äº†è§£ GC çš„å·¥ä½œåŸç†&lt;/h3&gt;
&lt;p&gt;åƒåœ¾æ”¶é›†å™¨ï¼ˆGCï¼‰æ˜¯Go è¯­è¨€çš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼Œè·Ÿè¸ªå’Œé‡Šæ”¾ä¸å†éœ€è¦çš„å †åˆ†é…ã€‚äº†è§£ GC çš„å·¥ä½œåŸç†æœ‰åŠ©äºä¼˜åŒ–åº”ç”¨ç¨‹åºã€‚&lt;/p&gt;
&lt;h4 id=&#34;æ¦‚å¿µç®€ä»‹&#34;&gt;æ¦‚å¿µç®€ä»‹&lt;/h4&gt;
&lt;p&gt;è·Ÿè¸ªåƒåœ¾å›æ”¶ï¼Œå…¶é€šè¿‡å¾ªç€æŒ‡é’ˆæ¥æ ‡è¯†æ­£åœ¨ä½¿ç”¨çš„ã€æ‰€è°“çš„æ´»åŠ¨å¯¹è±¡ï¼Œé€šè¿‡æ´»åŠ¨å¯¹è±¡æ„å»ºçš„å¯¹è±¡å›¾ï¼Œ&lt;/p&gt;
&lt;p&gt;GCæ˜¯åŸºäºæ ‡è®°æ¸…é™¤ç®—æ³•ï¼Œä¸»è¦æ˜¯mark-sweep 2ä¸ªé˜¶æ®µï¼Œå°†markæ“ä½œè¿›è¡Œè¿›ä¸€åˆ†è§£ï¼Œå…¶è¿‡ç¨‹å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;p&gt;Mark setup (func Stack scan) â†’ Make (concurrent make and assist make, make  termination) â†’ concurrent Sweep ï¼› å…¶ä¸­ å¼€å§‹Mark setupçš„æ—¶å€™ä¼šæœ‰éå¸¸çŸ­æš‚çš„STW(å¹³å‡æ¯ 10 åˆ° 30 å¾®ç§’),  æ ‡è®°ç»ˆæ­¢(make  termination) ä¹Ÿä¼šæœ‰STW, è¿›è¡Œæ”¶å°¾å·¥ä½œæ—¶é—´ç¨é•¿ï¼Œå¯ä»¥ç®€å•è®¤ä¸ºï¼ŒSTWå‘ç”Ÿåœ¨markçš„å¼€å§‹å’Œç»“æŸ(å¼€å§‹æ—¶æ‰¾åˆ°æ‰«æå¼€å§‹çš„åˆå§‹ä½ç½®ï¼Œå¼€å¯å†™å±éšœï¼›ç»“æŸæ—¶å…³é—­å†™å±éšœï¼Œè¿›è¡Œæ”¶å°¾)&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;Mark æ ‡è®°é˜¶æ®µï¼šéå†å †çš„æ‰€æœ‰å¯¹è±¡ï¼Œé‡‡ç”¨ &lt;a href=&#34;https://github.com/rubinius/rubinius-website-archive/blob/cf54187d421275eec7d2db0abd5d4c059755b577/_posts/2013-06-22-concurrent-garbage-collection.markdown&#34;&gt;&lt;strong&gt;ä¸‰è‰²æ ‡è®°ç®—æ³•&lt;/strong&gt;&lt;/a&gt; (Go 1.5å¼•å…¥)ï¼Œæ ‡è®°æ˜¯å¦è¿˜åœ¨ä½¿ç”¨ã€‚&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;mark setup:  å³markå¼€å§‹å‰çš„å‡†å¤‡å·¥ä½œï¼Œæ‰¾åˆ°goroutineä¸­å‡½æ•°æ ˆå¸§ä¸­çš„æ‰«æä½ç½®ï¼Œ æ‰“å¼€å†™å±éšœ(write barrierï¼Œå‰é¢å·²ç»ä»‹ç»è¿‡)ï¼Œå…è®¸åœ¨åƒåœ¾å›æ”¶æœŸé—´åœ¨å †ä¸Šä¿æŒæ•°æ®å®Œæ•´æ€§ï¼Œå› ä¸ºå›æ”¶å™¨å’Œåº”ç”¨ç¨‹åºçš„ goroutine å°†åŒæ—¶è¿è¡Œã€‚è¦æ‰“å¼€å†™ä¿æŠ¤ï¼Œå¿…é¡»åœæ­¢è¿è¡Œçš„æ¯ä¸ªåº”ç”¨ç¨‹åº goroutineï¼Œäº§ç”ŸSTW,é€šå¸¸éå¸¸å¿«ï¼Œå¹³å‡æ¯ 10 åˆ° 30 å¾®ç§’ï¼›ä½†æ˜¯æœ‰ç‰¹æ®Šæƒ…å†µï¼Œç´§å¯†å¾ªç¯æ¯”å¦‚ä¸€ä¸ªæ­»å¾ªç¯æˆ–è€…å¾ªç¯æ—¶é—´é•¿ï¼Œæ²¡æœ‰è°ƒç”¨å‡½æ•°è§¦å‘ï¼Œè¿›è€Œå¯èƒ½å¯¼è‡´åƒåœ¾å›æ”¶æ— æ³•å¼€å§‹ï¼›&lt;/li&gt;
&lt;li&gt;concurrent mark: åœ¨å¼€å¯å†™ä¿æŠ¤å™¨åï¼Œå¼€å§‹å¹¶å‘æ ‡è®°é˜¶æ®µã€‚é¦–å…ˆï¼Œå›æ”¶å™¨ä¸ºå…¶è‡ªèº«ä¿ç•™äº† 25% å¯ç”¨ CPU å®¹é‡ ã€‚ä½¿ç”¨ Goroutine æ‰§è¡Œå›æ”¶å·¥ä½œï¼Œå¹¶éœ€è¦åº”ç”¨ç¨‹åº Goroutine ä½¿ç”¨çš„ç›¸åŒçš„ P å’Œ Mã€‚å¼€å§‹æ ‡è®°å †å†…å­˜ä¸­ä»åœ¨ä½¿ç”¨çš„å€¼ã€‚è¯¥å·¥ä½œé¦–å…ˆé€šè¿‡æ£€æŸ¥æ‰€æœ‰ç°æœ‰ Goroutine çš„æ ˆå¸§ä»¥æ‰¾åˆ°æŒ‡å‘å †å†…å­˜çš„æ ¹æŒ‡é’ˆã€‚ç„¶åä»è¿™äº›æ ¹æŒ‡é’ˆéå†å¯¹è±¡å›¾ è¿›è¡Œæ ‡è®°ã€‚&lt;/li&gt;
&lt;li&gt;assist mark: å¦‚æœæ”¶é›†å™¨ç¡®å®šå®ƒéœ€è¦å‡ç¼“åˆ†é…ï¼Œå®ƒå°†ä¼šæ‹›å‹Ÿåº”ç”¨ç¨‹åºçš„ Goroutine ååŠ© Marking å·¥ä½œï¼Œè¿™ç§°ä¸º Mark Assistã€‚ä»»ä½•åº”ç”¨ç¨‹åº Goroutine åœ¨ Mark Assist ä¸­çš„æ—¶é—´é‡ä¸å®ƒå¯¹å †å†…å­˜çš„æ•°æ®æ·»åŠ é‡æˆæ¯”ä¾‹ï¼Œå¯ä»¥æ›´å¿«åœ°å®Œæˆæ”¶é›†ï¼›å¦‚æœä»»æ„ä¸€æ¬¡æ”¶é›†æœ€ç»ˆéœ€è¦å¤§é‡çš„ Mark Assistï¼Œæ”¶é›†å™¨å¯ä»¥æ›´æ—©å¼€å§‹ä¸‹ä¸€æ¬¡åƒåœ¾æ”¶é›†ï¼Œä»¥å‡å°‘ä¸‹ä¸€æ¬¡æ”¶é›†æ‰€éœ€çš„ Mark Assist æ•°é‡(éœ€è¦è¾…åŠ©markçš„ä»»åŠ¡å¤šï¼Œéœ€è¦ææ—©å¼€å§‹)ã€‚&lt;/li&gt;
&lt;li&gt;make  terminationï¼š ä¸€æ—¦æ ‡è®°å·¥ä½œå®Œæˆï¼Œå¼€å§‹æ ‡è®°ç»ˆæ­¢ã€‚è¿™ä¸ªé˜¶æ®µå°†å…³é—­å†™å±éšœï¼Œæ‰§è¡Œå„ç§æ¸…ç†ä»»åŠ¡ä»¥åŠè®¡ç®—ä¸‹ä¸€ä¸ªå›æ”¶ç›®æ ‡çš„æ—¶åˆ»ã€‚åœ¨æ ‡è®°é˜¶æ®µå¤„äºç´§å¯†å¾ªç¯çš„åç¨‹ä¹Ÿå¯èƒ½å¯¼è‡´æ ‡è®°ç»ˆæ­¢ STW å»¶è¿Ÿå»¶é•¿ã€‚å›æ”¶å®Œæˆåï¼Œåº”ç”¨ç¨‹åºåç¨‹å¯ä»¥å†æ¬¡ä½¿ç”¨æ¯ä¸ªPï¼Œåº”ç”¨ç¨‹åºGoroutineå¯ä»¥å……åˆ†ä½¿ç”¨cupèµ„æºã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;Sweep æ¸…é™¤é˜¶æ®µ&lt;/strong&gt;ï¼šä»æ ¹å¼€å§‹éå†å¯¹è±¡å›¾å¹¶é‡Šæ”¾ä¸å†è¢«å¼•ç”¨çš„å¯¹è±¡å—ï¼Œæ¸…é™¤æ“ä½œæ˜¯å¹¶å‘çš„ï¼›é‡Šæ”¾çš„è¿‡ç¨‹æ˜¯å¼‚æ­¥çš„ï¼Œä¸æ˜¯çœŸæ­£çš„æ¸…é™¤ï¼›å½“åº”ç”¨ç¨‹åºgoroutineå°è¯•åœ¨å †å†…å­˜ä¸­åˆ†é…æ–°å†…å­˜æ—¶ï¼Œä¼šè§¦å‘è¯¥æ“ä½œï¼Œæ¸…ç†å¯¼è‡´çš„å»¶è¿Ÿå’Œååé‡é™ä½è¢«åˆ†æ•£åˆ°æ¯æ¬¡å†…å­˜åˆ†é…æ—¶ã€‚&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;ps: æ•´ä½“æ€æƒ³å¯ä»¥å€Ÿé‰´&lt;/p&gt;
&lt;p&gt;æ•´ä½“GCç®—æ³•å¦‚ä¸‹ï¼šfromï¼š&lt;a href=&#34;https://go.dev/talks/2015/go-gc.pdf&#34;&gt;https://go.dev/talks/2015/go-gc.pdf&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://raw.githubusercontent.com/weedge/mypic/master/2015-go-gc.png?raw=true&#34; alt=&#34;https://raw.githubusercontent.com/weedge/mypic/master/2015-go-gc.png&#34;&gt;&lt;/p&gt;
&lt;p&gt;Go GC è¿˜åŒ…æ‹¬ä¸€ç§åœ¨æ¶ˆè€—é«˜å³°åé‡Šæ”¾å†…å­˜çš„æ–¹æ³•ã€‚å‡è®¾åº”ç”¨ç¨‹åºåŸºäºä¸¤ä¸ªé˜¶æ®µï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å¯¼è‡´é¢‘ç¹åˆ†é…å¤§çš„å †ç©ºé—´çš„åˆå§‹åŒ–é˜¶æ®µ&lt;/li&gt;
&lt;li&gt;å…·æœ‰é€‚åº¦åˆ†é…å°çš„å †ç©ºé—´çš„è¿è¡Œæ—¶é˜¶æ®µ&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Go å°†å¦‚ä½•è§£å†³å¤§çš„heapç©ºé—´å›æ”¶åï¼Œè¿˜ä¼šç»§ç»­ä½¿ç”¨å‘¢ï¼Ÿè¿™æ˜¯ä½œä¸º GC ä¸­çš„å‘¨æœŸæ¸…ç† &lt;em&gt;periodic scavenger&lt;/em&gt;  æ‰€è€ƒè™‘çš„é—®é¢˜(å…·ä½“å¯ä»¥çœ‹&lt;a href=&#34;https://cs.opensource.google/go/go/+/refs/tags/go1.20:src/runtime/mgcscavenge.go&#34;&gt;go1.20:src/runtime/mgcscavenge.go&lt;/a&gt; ä»£ç äº†è§£)ã€‚ä¸€æ®µæ—¶é—´åï¼ŒGC æ£€æµ‹åˆ°ä¸å†éœ€è¦è¿™ä¹ˆå¤§çš„å †ç©ºé—´ï¼Œå› æ­¤å®ƒä¼šé‡Šæ”¾ä¸€äº›å†…å­˜å¹¶å°†å…¶è¿”å›ç»™ OSã€‚&lt;/p&gt;
&lt;p&gt;tips:&lt;/p&gt;
&lt;p&gt;å¦‚æœGC &lt;em&gt;periodic scavenger&lt;/em&gt; ä¸å¤Ÿå¿«å‘¢ï¼Œå¯ä»¥ä½¿ç”¨æ‰‹åŠ¨å¼ºåˆ¶å°†å†…å­˜è¿”å›ç»™æ“ä½œç³»ç»Ÿ&lt;code&gt;debug.FreeOSMemory()&lt;/code&gt;ï¼›ä½†æ˜¯è¿™æ ·æœ‰äº›é—®é¢˜ï¼Œéœ€è¦æ…é‡ä½¿ç”¨ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ä¸€æ¬¡å°†å†…å­˜éƒ½å½’è¿˜ç»™ç³»ç»Ÿï¼Œè¿™ä¸ªæ“ä½œå¤ªé‡äº†ã€‚ä¼šæœ‰å»¶è¿ŸæŠ–åŠ¨ï¼Œå› ä¸ºæ¶‰åŠåˆ° lock&lt;/li&gt;
&lt;li&gt;éœ€è¦ç”¨æˆ·è‡ªå·±è°ƒè¿™ä¸ªå‡½æ•°ï¼Œå¯¹ä»£ç æ˜¯æœ‰ä¾µå…¥æ€§&lt;/li&gt;
&lt;li&gt;å†æ¬¡é‡ç”¨å†…å­˜çš„æ—¶å€™ä¼šæœ‰è¾ƒå¤šå¼€é”€ï¼Œå› ä¸ºæœ‰ page fault&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;é€šè¿‡pprof/heapé‡‡é›†åˆ°çš„æ•°æ®ï¼Œåœ¨ç›‘æ§æŸ¥çœ‹ RSS(è¿›ç¨‹/çº¿ç¨‹ä½¿ç”¨çš„ç‰©ç†å†…å­˜) çš„å€¼ æ¯” æ­£å¸¸è®¡ç®—çš„Goåº”ç”¨è¿›ç¨‹ä½¿ç”¨çš„å†…å­˜ç©ºé—´è¦å¤§ï¼Œä¸»è¦åŸå› æ˜¯ Go GCä¹‹åå†…å­˜ç©ºé—´æ²¡æœ‰é©¬ä¸Šè¿”å›ç»™OS, è€Œæ˜¯ç­‰åˆ°GC &lt;em&gt;periodic scavenger&lt;/em&gt; è§¦å‘ä¹‹åæ‰ä¼šé‡Šæ”¾å†…å­˜ç©ºé—´åˆ°OSä¸­, GCä¹‹åæœªå½’è¿˜çš„å†…å­˜ç©ºé—´å¤§å°ä¸ºï¼šHeapIdle(ç©ºé—²å†…å­˜å¤§å°) - HeapReleased(å·²é‡Šæ”¾å½’è¿˜ç»™OSå†…å­˜å¤§å°)ï¼›&lt;/p&gt;
&lt;p&gt;é‡è¦çš„é—®é¢˜æ˜¯ï¼ŒGC ä½•æ—¶è¿è¡Œï¼ŸGo ä¸­æä¾›ä¸¤ç§æ–¹å¼è®¾ç½® GOGC ç¯å¢ƒå˜é‡ or debug.SetGCPercent ä»¥åŠ  debug.SetMaxHeap :&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;GOGC (debug.SetGCPercent )&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;ä¸ Java ç­‰å…¶ä»–è¯­è¨€ç›¸æ¯”ï¼ŒGo é…ç½®ä»ç„¶ç›¸å½“ç®€å•ã€‚å®ƒä¾èµ–äºå•ä¸€ç¯å¢ƒå˜é‡ï¼š&lt;code&gt;GOGC&lt;/code&gt;. è¯¥å˜é‡å®šä¹‰äº†è‡ªä¸Šæ¬¡ GC åè§¦å‘å¦ä¸€æ¬¡ GC ä¹‹å‰å †å¢é•¿çš„ç™¾åˆ†æ¯”ï¼›é»˜è®¤å€¼ä¸º 100%ã€‚&lt;/p&gt;
&lt;p&gt;çœ‹ä¸€ä¸ªå…·ä½“çš„ä¾‹å­ï¼Œå‡è®¾ GC åˆšåˆšè¢«è§¦å‘ï¼Œå½“å‰å †å¤§å°ä¸º 128 MBã€‚é»˜è®¤&lt;code&gt;GOGC=100&lt;/code&gt;ï¼Œåˆ™åœ¨å †å¤§å°è¾¾åˆ° 256 MB æ—¶è§¦å‘ä¸‹ä¸€æ¬¡ GCã€‚æ¯å½“å †å¤§å°ç¿»å€æ—¶ï¼Œé»˜è®¤æƒ…å†µä¸‹éƒ½ä¼šæ‰§è¡Œä¸€æ¬¡ GCã€‚æ­¤å¤–ï¼Œå¦‚æœåœ¨è¿‡å» 2 åˆ†é’Ÿå†…æœªæ‰§è¡Œ GCï¼ŒGo å°†å¼ºåˆ¶æ‰§è¡Œä¸€æ¬¡ã€‚&lt;/p&gt;
&lt;p&gt;åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨&lt;code&gt;GOGC&lt;/code&gt;ä½¿ç”¨æ—¶éœ€è¦æ³¨æ„ï¼Œåˆ†æè¿›è¡Œå¾®è°ƒ(å–å†³äºå…·ä½“åœºæ™¯ï¼Œæœºå™¨æ€§èƒ½)ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å‡å°‘é˜ˆå€¼ï¼Œä¼šå‡ä½ å †ç©ºé—´ å¢é•¿ï¼Œä½†æ˜¯å¢åŠ äº† GC çš„å‹åŠ›ã€‚&lt;/li&gt;
&lt;li&gt;å¢åŠ é˜ˆå€¼ï¼Œä¼šå¢åŠ  å †ç©ºé—´ å¢é•¿ï¼Œä½†æ˜¯å‡å°‘äº† GC çš„å‹åŠ›ã€‚(é€‚ç”¨äºfree å†…å­˜ç©ºé—´å¤§çš„åœºæ™¯ï¼Œå› ä¸ºæ¸…æ‰«æ˜¯å¼‚æ­¥è§¦å‘çš„~)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;tips: é€šè¿‡è®¾ç½®&lt;code&gt;GOGC=off&lt;/code&gt;æˆ–è€…&lt;code&gt;debug.SetGCPercent(-1)&lt;/code&gt;å…³é—­&lt;code&gt;GC&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;debug.SetMaxHeap&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;å¯¹å†…å­˜ä¸è¶³ï¼ˆOOMï¼‰çš„æƒ…å†µéå¸¸æ•æ„Ÿçš„åœºæ™¯ï¼Œç›´æ¥è‡ªå®šä¸€ä¸ªä½¿ç”¨å †å¤§å°çš„ä¸Šé™ï¼Œå¯ä»¥ç»“åˆ&lt;code&gt;debug.SetGCPercent(-1)&lt;/code&gt;æ‰‹åŠ¨å…³é—­&lt;code&gt;GC&lt;/code&gt; ä½¿ç”¨ï¼Œåˆ°è¾¾æœ€å¤§é™åˆ¶ï¼Œåˆ™è§¦å‘GC,  å¯¹äºå†…å­˜ä½¿ç”¨æ¯”è¾ƒæœ‰è§„å¾‹çš„åœºæ™¯é€‚åˆä½¿ç”¨ï¼Œå¦‚æœé¢‘ç¹å¾ˆå¿«åˆ°è¾¾æœ€å¤§é™åˆ¶ï¼Œåˆ™ä¼šé¢‘ç¹GCï¼Œå¾—ä¸å¿å¤±äº†ã€‚&lt;/p&gt;
&lt;h4 id=&#34;gc-è·Ÿè¸ª&#34;&gt;GC è·Ÿè¸ª&lt;/h4&gt;
&lt;p&gt;å¯ä»¥é€šè¿‡è®¾ç½®æ‰“å° GC è·Ÿè¸ª&lt;code&gt;GODEBUG&lt;/code&gt;ç¯å¢ƒå˜é‡ï¼Œä¾‹å¦‚åœ¨è¿è¡ŒåŸºå‡†æµ‹è¯•æ—¶ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;nv&#34;&gt;GODEBUG&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;gctrace&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;1&lt;/span&gt; go &lt;span class=&#34;nb&#34;&gt;test&lt;/span&gt; -bench&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;. -v
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;tips: å‘½ä»¤ä¸­çš„ç¯å¢ƒå˜é‡GODEBUGå€¼ å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼š&lt;a href=&#34;https://pkg.go.dev/runtime#hdr-Environment_Variables&#34;&gt;Environment_Variables&lt;/a&gt; è®¾ç½®ï¼Œä»¥åŠæŸ¥çœ‹è¾“å‡ºæ ¼å¼å…·ä½“å†…å®¹è¯´æ˜ã€‚æ¯æ¬¡ GC è¿è¡Œæ—¶å¯ç”¨ä¸€ä¸ªè·Ÿè¸ª&lt;code&gt;gctrace&lt;/code&gt;éƒ½ä¼šå†™å…¥&lt;code&gt;stderr&lt;/code&gt;ã€‚&lt;/p&gt;
&lt;p&gt;å¿…é¡»äº†è§£ GC çš„è¡Œä¸ºæ–¹å¼æ‰èƒ½å¯¹å…¶è¿›è¡Œä¼˜åŒ–ã€‚å¯ä»¥ä½¿ç”¨&lt;code&gt;GOGC&lt;/code&gt;æ¥é…ç½®ä¸‹ä¸€ä¸ª GC å‘¨æœŸä½•æ—¶è¢«è§¦å‘ã€‚åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œä¿æŒå®ƒå°±&lt;code&gt;100&lt;/code&gt;è¶³å¤Ÿäº†ã€‚ä½†æ˜¯ï¼Œå¦‚æœåº”ç”¨ç¨‹åºå¯èƒ½é¢ä¸´å¯¼è‡´é¢‘ç¹ GC å’Œå»¶è¿Ÿå½±å“çš„è¯·æ±‚å³°å€¼ï¼Œå¯ä»¥å¢åŠ è¯¥å€¼ã€‚æœ€åï¼Œåœ¨å¼‚å¸¸è¯·æ±‚é«˜å³°çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨å°†è™šæ‹Ÿå †å¤§å°ä¿æŒåœ¨æœ€å°å€¼çš„æŠ€å·§ã€‚&lt;/p&gt;
&lt;p&gt;tips: ä¸Šé¢åªæ˜¯ç®€å•æ¦‚æ‹¬çš„ä»‹ç»äº†ä¸‹ï¼Œéšç€æ—¶é—´æ¨ç§»å¯èƒ½ä¸å‡†ç¡®ï¼ŒGoä¸­GCæ˜¯ä¸€ä¸ªå¤æ‚çš„è¿‡ç¨‹ï¼Œå…·ä½“ç»†èŠ‚ï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹æ–‡æ¡£ä¸€èµ·å®è·µå­¦ä¹ ï¼š&lt;/p&gt;
&lt;p&gt;äº†è§£GCç»†èŠ‚å…¥é—¨:  &lt;strong&gt;&lt;a href=&#34;https://tip.golang.org/doc/gc-guide?continueFlag=bf311ba190bf0d160b5d3461e092f0f4&#34;&gt;A Guide to the Go Garbage Collector&lt;/a&gt;&lt;/strong&gt;  &lt;strong&gt;&lt;a href=&#34;https://go.dev/blog/ismmkeynote&#34;&gt;Getting to Go: The Journey of Go&amp;rsquo;s Garbage Collector&lt;/a&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;äº†è§£é€šè¿‡GC Traceå®šä½é—®é¢˜: &lt;a href=&#34;https://www.ardanlabs.com/blog/2018/12/garbage-collection-in-go-part1-semantics.html&#34;&gt;&lt;strong&gt;Garbage Collection In Go : Part I - Semantics&lt;/strong&gt;&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&#34;100ä¸äº†è§£åœ¨-docker-å’Œ-kubernetes-ä¸­è¿è¡Œ-go-çš„å½±å“&#34;&gt;100.ä¸äº†è§£åœ¨ Docker å’Œ Kubernetes ä¸­è¿è¡Œ Go çš„å½±å“&lt;/h3&gt;
&lt;p&gt;æ ¹æ® 2021 å¹´ Go å¼€å‘äººå‘˜è°ƒæŸ¥ ( &lt;a href=&#34;https://go.dev/blog/survey2021-results&#34;&gt;https://go.dev/blog/survey2021-results&lt;/a&gt; )ï¼Œä½¿ç”¨ Go ç¼–å†™æœåŠ¡æ˜¯æœ€å¸¸è§çš„ç”¨é€”ã€‚åŒæ—¶ï¼ŒKubernetes æ˜¯éƒ¨ç½²è¿™äº›æœåŠ¡çš„æœ€å¹¿æ³›ä½¿ç”¨çš„å¹³å°ã€‚äº†è§£åœ¨ Docker å’Œ Kubernetes ä¸­è¿è¡Œ Go çš„å«ä¹‰éå¸¸é‡è¦ï¼Œä»¥é˜²æ­¢å‡ºç° CPU èŠ‚æµç­‰å¸¸è§æƒ…å†µã€‚&lt;/p&gt;
&lt;p&gt;GOMAXPROCSå˜é‡å®šä¹‰äº†è´Ÿè´£åŒæ—¶æ‰§è¡Œç”¨æˆ·çº§ä»£ç çš„æ“ä½œç³»ç»Ÿçº¿ç¨‹çš„é™åˆ¶ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå®ƒè®¾ç½®ä¸º OS-apparent é€»è¾‘ CPU æ ¸å¿ƒæ•°ã€‚è¿™åœ¨ Docker å’Œ Kubernetes çš„ä¸Šä¸‹æ–‡ä¸­æ„å‘³ç€ä»€ä¹ˆï¼Ÿ&lt;/p&gt;
&lt;p&gt;å‡è®¾ Kubernetes é›†ç¾¤ç”±å…«ä¸ªæ ¸å¿ƒèŠ‚ç‚¹ç»„æˆã€‚å½“ä¸€ä¸ªå®¹å™¨éƒ¨ç½²åœ¨ Kubernetes ä¸­æ—¶ï¼Œå¯ä»¥å®šä¹‰ä¸€ä¸ª CPU é™åˆ¶ï¼Œä»¥ç¡®ä¿ä¸€ä¸ªåº”ç”¨ç¨‹åºä¸ä¼šè€—å°½å®¿ä¸»æœºçš„æ‰€æœ‰èµ„æºã€‚ä¾‹å¦‚ï¼Œä»¥ä¸‹é…ç½®å°† CPU çš„ä½¿ç”¨é™åˆ¶ä¸º 4,000 millicpuï¼ˆæˆ– millicoresï¼‰ï¼Œå› æ­¤å››ä¸ª CPU å†…æ ¸&lt;/p&gt;
&lt;p&gt;å¯ä»¥å‡è®¾åœ¨éƒ¨ç½²åº”ç”¨ç¨‹åºæ—¶ï¼ŒGOMAXPROCSå°†åŸºäºè¿™äº›é™åˆ¶ï¼Œå› æ­¤å€¼ä¸º4. ä½†äº‹å®å¹¶éå¦‚æ­¤ï¼›å®ƒè¢«è®¾ç½®ä¸ºä¸»æœºä¸Šçš„é€»è¾‘æ ¸å¿ƒæ•°ï¼š8ã€‚é‚£ä¹ˆï¼Œæœ‰ä»€ä¹ˆå½±å“å‘¢ï¼Ÿ&lt;/p&gt;
&lt;p&gt;Kubernetes ä½¿ç”¨å®Œå…¨å…¬å¹³è°ƒåº¦å™¨ (CFS) ä½œä¸ºè¿›ç¨‹è°ƒåº¦ç¨‹åºã€‚CFS è¿˜ç”¨äºå¯¹ Pod èµ„æºå®æ–½ CPU é™åˆ¶ã€‚åœ¨ç®¡ç† Kubernetes é›†ç¾¤æ—¶ï¼Œç®¡ç†å‘˜å¯ä»¥é…ç½®è¿™ä¸¤ä¸ªå‚æ•°ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;cpu.cfs_period_usï¼ˆå…¨å±€è®¾ç½®ï¼‰&lt;/li&gt;
&lt;li&gt;cpu.cfs_quota_usï¼ˆæ¯ä¸ª Podè®¾ç½®ï¼‰&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;å‰è€…å®šä¹‰äº†ä¸€ä¸ªæ—¶æœŸï¼Œåè€…å®šä¹‰äº†ä¸€ä¸ªé…é¢ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå‘¨æœŸè®¾ç½®ä¸º 100 æ¯«ç§’ã€‚åŒæ—¶ï¼Œé»˜è®¤é…é¢å€¼æ˜¯åº”ç”¨ç¨‹åºåœ¨ 100 æ¯«ç§’å†…å¯ä»¥æ¶ˆè€—å¤šå°‘ CPU æ—¶é—´ã€‚é™åˆ¶è®¾ç½®ä¸ºå››ä¸ªæ ¸å¿ƒï¼Œè¿™æ„å‘³ç€ 400 ms (4 Ã— 100 ms)ã€‚å› æ­¤ï¼ŒCFS å°†ç¡®ä¿åº”ç”¨ç¨‹åºä¸ä¼šåœ¨ 100 æ¯«ç§’å†…æ¶ˆè€—è¶…è¿‡ 400 æ¯«ç§’çš„ CPU æ—¶é—´ã€‚&lt;/p&gt;
&lt;p&gt;æƒ³è±¡ä¸€ä¸ªåœºæ™¯ï¼Œå¤šä¸ª goroutine å½“å‰æ­£åœ¨å››ä¸ªä¸åŒçš„çº¿ç¨‹ä¸Šæ‰§è¡Œã€‚æ¯ä¸ªçº¿ç¨‹è¢«å®‰æ’åœ¨ä¸åŒçš„æ ¸å¿ƒï¼ˆ1ã€3ã€4 å’Œ 8ï¼‰ä¸Šï¼›&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781617299599/files/Images/CH12_F49_Harsanyi.png&#34; alt=&#34;https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781617299599/files/Images/CH12_F49_Harsanyi.png&#34;&gt;&lt;/p&gt;
&lt;p&gt;åœ¨ç¬¬ä¸€ä¸ª 100 ms æœŸé—´ï¼Œæœ‰å››ä¸ªçº¿ç¨‹å¤„äºå¿™ç¢ŒçŠ¶æ€ï¼Œå› æ­¤æ¶ˆè€—äº† 400 ms ä¸­çš„ 400ï¼š100% çš„é…é¢ã€‚åœ¨ç¬¬äºŒä¸ªæ—¶æœŸï¼Œæ¶ˆè€—äº† 400 æ¯«ç§’ä¸­çš„ 360 æ¯«ç§’ï¼Œä¾æ­¤ç±»æ¨ã€‚ä¸€åˆ‡éƒ½å¾ˆå¥½ï¼Œå› ä¸ºåº”ç”¨ç¨‹åºæ¶ˆè€—çš„èµ„æºå°‘äºé…é¢ã€‚&lt;/p&gt;
&lt;p&gt;ä½†æ˜¯ï¼Œè®°ä½GOMAXPROCSè®¾ç½®ä¸º8ã€‚å› æ­¤ï¼Œåœ¨æœ€åçš„æƒ…å†µä¸‹ï¼Œå¯ä»¥æœ‰å…«ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½å®‰æ’åœ¨ä¸åŒçš„æ ¸å¿ƒä¸Šã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781617299599/files/Images/CH12_F50_Harsanyi.png&#34; alt=&#34;https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781617299599/files/Images/CH12_F50_Harsanyi.png&#34;&gt;&lt;/p&gt;
&lt;p&gt;å¯¹äºæ¯ 100 æ¯«ç§’ï¼Œé…é¢è®¾ç½®ä¸º 400 æ¯«ç§’ã€‚å¦‚æœå…«ä¸ªçº¿ç¨‹å¿™äºæ‰§è¡Œ goroutineï¼Œ50 æ¯«ç§’åï¼Œè¾¾åˆ° 400 æ¯«ç§’çš„é…é¢ï¼ˆ8 Ã— 50 æ¯«ç§’ = 400 æ¯«ç§’ï¼‰ã€‚ä¼šæœ‰ä»€ä¹ˆåæœï¼ŸCFS å°†é™åˆ¶ CPU èµ„æºã€‚å› æ­¤ï¼Œåœ¨å¦ä¸€ä¸ªå‘¨æœŸå¼€å§‹ä¹‹å‰ä¸ä¼šåˆ†é…æ›´å¤šçš„ CPU èµ„æºã€‚æ¢å¥è¯è¯´ï¼Œåº”ç”¨ç¨‹åºå°†æš‚åœ 50 æ¯«ç§’ã€‚&lt;/p&gt;
&lt;p&gt;ä¾‹å¦‚ï¼Œå¹³å‡å»¶è¿Ÿä¸º 50 æ¯«ç§’çš„æœåŠ¡æœ€å¤šå¯èƒ½éœ€è¦ 150 æ¯«ç§’æ‰èƒ½å®Œæˆã€‚è¿™å¯èƒ½æ˜¯å»¶è¿Ÿçš„ 300% æƒ©ç½šã€‚&lt;/p&gt;
&lt;p&gt;é¦–å…ˆï¼Œè¯·å…³æ³¨ Go &lt;a href=&#34;https://github.com/golang/go/issues/33803&#34;&gt;issue 33803&lt;/a&gt;ã€‚ä¹Ÿè®¸åœ¨ Go çš„æœªæ¥ç‰ˆæœ¬ä¸­ï¼ŒGOMAXPROCSå°†æ”¯æŒ CFSã€‚&lt;/p&gt;
&lt;p&gt;ä»Šå¤©çš„è§£å†³æ–¹æ¡ˆæ˜¯ä¾èµ–äºç”±ä¼˜æ­¥è°ƒç”¨automaxprocsï¼ˆ&lt;a href=&#34;http://github.com/uber-go/automaxprocs&#34;&gt;github.com/uber-go/automaxprocs&lt;/a&gt;ï¼‰ã€‚å¯ä»¥é€šè¿‡&lt;a href=&#34;http://xn--go-hf3c1a925dgwxre7e7sa.uber.org/automaxprocs%E5%9C%A8&#34;&gt;go.uber.org/automaxprocs&lt;/a&gt; åœ¨main.go ä¸­æ·»åŠ ä¸€ä¸ªç©ºç™½å¯¼å…¥æ¥ä½¿ç”¨è¿™ä¸ªåº“ï¼›å®ƒä¼šè‡ªåŠ¨è®¾ç½®GOMAXPROCSä»¥åŒ¹é… Linux å®¹å™¨ CPU é…é¢ã€‚åœ¨å‰é¢çš„ç¤ºä¾‹ä¸­ï¼ŒGOMAXPROCSå°†è®¾ç½®ä¸º4è€Œä¸æ˜¯8ï¼Œå› æ­¤å°†æ— æ³•è¾¾åˆ° CPU è¢«èŠ‚æµçš„çŠ¶æ€ã€‚&lt;/p&gt;
&lt;p&gt;ç›®å‰Go ä¸æ”¯æŒ CFSã€‚GOMAXPROCSåŸºäºä¸»æœºè€Œä¸æ˜¯å®šä¹‰çš„ CPU é™åˆ¶ã€‚å› æ­¤ï¼Œå¯èƒ½ä¼šè¾¾åˆ° CPU è¢«èŠ‚æµçš„çŠ¶æ€ï¼Œä»è€Œå¯¼è‡´é•¿æ—¶é—´çš„æš‚åœå’Œæ˜¾ç€çš„å»¶è¿Ÿå¢åŠ ç­‰å®è´¨æ€§å½±å“ã€‚åœ¨ Go å˜å¾—æ”¯æŒ CFS ä¹‹å‰ï¼Œä¸€ç§è§£å†³æ–¹æ¡ˆæ˜¯ä¾é automaxprocsè‡ªåŠ¨è®¾ç½®GOMAXPROCSä¸ºå®šä¹‰çš„é…é¢ã€‚&lt;/p&gt;
&lt;h2 id=&#34;æ¦‚æ‹¬&#34;&gt;æ¦‚æ‹¬&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;äº†è§£å¦‚ä½•ä½¿ç”¨ CPU ç¼“å­˜å¯¹äºä¼˜åŒ–å— CPU é™åˆ¶çš„åº”ç”¨ç¨‹åºå¾ˆé‡è¦ï¼Œå› ä¸º L1 ç¼“å­˜æ¯”ä¸»å†…å­˜å¿«å¤§çº¦ 50 åˆ° 100 å€ã€‚&lt;/li&gt;
&lt;li&gt;äº†è§£é«˜é€Ÿç¼“å­˜è¡Œæ¦‚å¿µå¯¹äºç†è§£å¦‚ä½•åœ¨æ•°æ®å¯†é›†å‹åº”ç”¨ç¨‹åºä¸­ç»„ç»‡æ•°æ®è‡³å…³é‡è¦ã€‚CPU ä¸ä¼šé€å­—è·å–å†…å­˜ï¼›ç›¸åï¼Œå®ƒé€šå¸¸å°†å†…å­˜å—å¤åˆ¶åˆ° 64 å­—èŠ‚çš„ç¼“å­˜è¡Œã€‚è¦å……åˆ†åˆ©ç”¨æ¯ä¸ªå•ç‹¬çš„ç¼“å­˜è¡Œï¼Œåˆ©ç”¨å¥½ç©ºé—´å±€éƒ¨æ€§ã€‚&lt;/li&gt;
&lt;li&gt;è®© CPU å¯ä»¥é¢„æµ‹ä»£ç ä¹Ÿæ˜¯ä¼˜åŒ–æŸäº›åŠŸèƒ½çš„æœ‰æ•ˆæ–¹æ³•ã€‚ä¾‹å¦‚ï¼Œå•ä½æˆ–æ’å®šæ­¥å¹…å¯¹äº CPU æ˜¯å¯é¢„æµ‹çš„ï¼Œä½†éå•ä½æ­¥å¹…ï¼ˆä¾‹å¦‚ï¼Œé“¾è¡¨ï¼‰æ˜¯ä¸å¯é¢„æµ‹çš„ã€‚&lt;/li&gt;
&lt;li&gt;ä¸ºé¿å…å…³é”®æ­¥å¹…ï¼Œä»è€Œåªä½¿ç”¨ç¼“å­˜çš„ä¸€å°éƒ¨åˆ†ï¼Œè¯·æ³¨æ„ç¼“å­˜æ˜¯åˆ†åŒºçš„ã€‚&lt;/li&gt;
&lt;li&gt;äº†è§£false sharingå¯¹å¹¶å‘ç¨‹åºçš„å½±å“ï¼Œä¼ªå…±äº«å› ä¸ºcache lineçš„åŒæ­¥ä¼šå¸¦æ¥ä¸€äº›cpu æ—¶é’Ÿå‘¨æœŸçš„æ€§èƒ½æŸå¤±ã€‚&lt;/li&gt;
&lt;li&gt;ä½¿ç”¨æŒ‡ä»¤çº§å¹¶è¡Œ (ILP) æ¥ä¼˜åŒ–ä»£ç çš„ç‰¹å®šéƒ¨åˆ†ï¼Œä»¥å…è®¸ CPU æ‰§è¡Œå°½å¯èƒ½å¤šçš„å¹¶è¡ŒæŒ‡ä»¤ã€‚è¯†åˆ«æ•°æ®å±å®³æ˜¯ä¸»è¦æ­¥éª¤ä¹‹ä¸€ã€‚&lt;/li&gt;
&lt;li&gt;å¯ä»¥é€šè¿‡è®°ä½åœ¨ Go ä¸­åŸºæœ¬ç±»å‹ä¸å®ƒä»¬è‡ªå·±çš„å¤§å°å¯¹é½æ¥é¿å…å¸¸è§é”™è¯¯ã€‚ä¾‹å¦‚ï¼Œè¯·è®°ä½ï¼ŒæŒ‰å¤§å°é™åºé‡ç»„ç»“æ„çš„å­—æ®µå¯ä»¥å¯¼è‡´æ›´ç´§å‡‘çš„ç»“æ„ï¼ˆæ›´å°‘çš„å†…å­˜åˆ†é…å’Œå¯èƒ½æ›´å¥½çš„ç©ºé—´å±€éƒ¨æ€§ï¼‰ã€‚&lt;/li&gt;
&lt;li&gt;åœ¨ä¼˜åŒ– Go åº”ç”¨ç¨‹åºæ—¶ï¼Œç†è§£å †å’Œæ ˆä¹‹é—´çš„æ ¹æœ¬åŒºåˆ«ä¹Ÿåº”è¯¥æ˜¯ä½ çš„æ ¸å¿ƒçŸ¥è¯†çš„ä¸€éƒ¨åˆ†ã€‚æ ˆåˆ†é…å‡ ä¹æ˜¯å…è´¹çš„ï¼Œè€Œå †åˆ†é…é€Ÿåº¦è¾ƒæ…¢å¹¶ä¸”ä¾èµ–äº GC æ¥æ¸…ç†å†…å­˜ã€‚&lt;/li&gt;
&lt;li&gt;å‡å°‘åˆ†é…ä¹Ÿæ˜¯ä¼˜åŒ– Go åº”ç”¨ç¨‹åºçš„ä¸€ä¸ªé‡è¦æ–¹é¢ã€‚è¿™å¯ä»¥é€šè¿‡ä¸åŒçš„æ–¹å¼å®Œæˆï¼Œä¾‹å¦‚ä»”ç»†è®¾è®¡ API ä»¥é˜²æ­¢å…±äº«ï¼Œäº†è§£å¸¸è§çš„ Go ç¼–è¯‘å™¨ä¼˜åŒ–ï¼Œä»¥åŠä½¿ç”¨sync.Pool.&lt;/li&gt;
&lt;li&gt;ä½¿ç”¨å¿«é€Ÿè·¯å¾„å†…è”æŠ€æœ¯æœ‰æ•ˆåœ°å‡å°‘è°ƒç”¨å‡½æ•°çš„æ‘Šé”€æ—¶é—´ã€‚&lt;/li&gt;
&lt;li&gt;ä¾é åˆ†æå’Œæ‰§è¡Œè·Ÿè¸ªå™¨æ¥äº†è§£åº”ç”¨ç¨‹åºçš„æ‰§è¡Œæ–¹å¼å’Œè¦ä¼˜åŒ–çš„éƒ¨åˆ†ã€‚&lt;/li&gt;
&lt;li&gt;äº†è§£å¦‚ä½•è°ƒæ•´ GC å¯ä»¥å¸¦æ¥å¤šç§å¥½å¤„ï¼Œä¾‹å¦‚æ›´æœ‰æ•ˆåœ°å¤„ç†çªç„¶å¢åŠ çš„è´Ÿè½½ã€‚&lt;/li&gt;
&lt;li&gt;ä¸ºå¸®åŠ©é¿å…åœ¨ Docker å’Œ Kubernetes ä¸­éƒ¨ç½²æ—¶å‡ºç° CPU èŠ‚æµï¼Œè¯·è®°ä½ Go ä¸æ”¯æŒ CFSã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;æ€»ç»“&#34;&gt;æ€»ç»“&lt;/h2&gt;
&lt;p&gt;æ€»å…±èŠ±äº†10å¤©å·¦å³æŠŠ 100-go-mistakes-and-how-to-avoid-them è¿™æœ¬ä¹¦çœ‹å®Œï¼Œå¯¹äºä¸€äº›æ–‡ä¸­ä¸å¤Ÿå‡å…¥çš„åœ°æ–¹ï¼Œè¿›è¡ŒæŒ–æ˜äº†ä¸‹ï¼Œäº†è§£å¼„æ¸…æ¥šäº†èƒŒåçš„åŸç†ï¼ŒçŸ¥å…¶ç„¶çŸ¥å…¶æ‰€ä»¥ç„¶ä¹‹åï¼Œæœ‰äº›mistakeæ˜¯ä¸€äº›å…±æ€§çš„é—®é¢˜ï¼Œè€Œä¸”å¯¹äºæ–‡ä¸­æ¯ä¸ªmistakeï¼Œéƒ½åº”å»å®è·µæ“ä½œä¸€ä¸‹ï¼Œç†Ÿæ‚‰åˆ©ç”¨å¥½Goç›¸å…³å·¥å…·ï¼Œç¼–è¯‘ï¼Œæµ‹è¯•ï¼Œæ„å»ºç­‰ç­‰ï¼Œæ–‡ä¸­å¤§éƒ¨åˆ†æ˜¯è¯­è¨€å±‚é¢çš„ï¼Œå·¥ç¨‹æ–¹é¢ä¹Ÿæœ‰äº›ï¼Œç‰¹åˆ«åƒæœ€åä»‹ç»çš„åœ¨K8S dockerä¸­CPUå¯¹Goè¯­è¨€æœ¬èº«çš„å½±å“ï¼Œå®é™…é‡åˆ°ä¹‹åæ‰ä¼šå°è±¡æ›´æ·±ï¼Œåº”è¯¥ä»é”™è¯¯ä¸­å»æ€»ç»“ï¼Œè€Œä¸æ˜¯æ€»ç»“ä¹‹åç»§ç»­çŠ¯é”™ï¼Œå¦‚æ­¤æŠ˜è¿”ï¼Œæ„ä¹‰ä¸å¤§ï¼›ä»é”™è¯¯ç‚¹ä¸­å¤šæŒ–æ˜åº•å±‚é€»è¾‘å¤šæ€è€ƒæ€»ç»“ã€‚&lt;/p&gt;
&lt;p&gt;åŸä¹¦åœ°å€ï¼š &lt;a href=&#34;https://learning.oreilly.com/library/view/100-go-mistakes/9781617299599/&#34;&gt;https://learning.oreilly.com/library/view/100-go-mistakes/9781617299599/&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;TIPSï¼š æ–‡ä¸­å¯¹äºchannel ä»‹ç»çš„æ¯”è¾ƒå°‘ï¼Œæ¯”å¦‚channel åœ¨ç”Ÿäº§(å‘é€)å’Œæ¶ˆè´¹(æ¥å—)ä¹‹é—´ï¼Œ1:1,1:N,M:1,M:Nåœºæ™¯ä¸‹å¦‚ä½•å…³é—­; è¿˜æœ‰GPMçš„è°ƒåº¦æ¨¡å‹çš„è¯¦ç»†ä»‹ç»ï¼Œä»¥åŠå†…å­˜åˆ†é…å™¨(è¿™å—åœ¨æ¯ä¸ªç‰ˆæœ¬ä¸­ç›¸å¯¹è¿­ä»£æ¯”è¾ƒå¤šï¼Œæœ€å¥½ç»“åˆå½“å‰å¼€å‘ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨çš„Goç‰ˆæœ¬å¯¹å…¶æºç åˆ†æ) æ²¡æœ‰è¯¦ç»†æ¶‰åŠåˆ°ï¼Œå¯å‚è€ƒè¿™äº›èµ„æ–™æ‰©å±•ï¼š &lt;a href=&#34;https://go101.org/article/channel-closing.html&#34;&gt;channel-closing&lt;/a&gt; , &lt;a href=&#34;https://www.google.com.hk/search?q=kavya%20golang#fpstate=ive&amp;amp;vld=cid:089b5108,vid:KBZlN0izeiY&#34;&gt;Understanding Channels&lt;/a&gt; , &lt;a href=&#34;https://medium.com/@ankur_anand/a-visual-guide-to-golang-memory-allocator-from-ground-up-e132258453ed&#34;&gt;Go Memory Allocator&lt;/a&gt; ï¼Œ&lt;a href=&#34;https://www.ardanlabs.com/blog/2018/08/scheduling-in-go-part2.html&#34;&gt;scheduling-in-go&lt;/a&gt;&lt;/p&gt;</description>
      
    </item>
    
    <item>
      <title>Go tips-ç¬”è®°: æµ‹è¯• 82-90 mistakes</title>
      <link>https://weedge.github.io/post/notions/go-tips/go-tips-11-testing/</link>
      <pubDate>Mon, 20 Feb 2023 14:26:23 +0800</pubDate>
      
      <guid>https://weedge.github.io/post/notions/go-tips/go-tips-11-testing/</guid>
      
        <description>&lt;h2 id=&#34;å¼•è¨€&#34;&gt;å¼•è¨€&lt;/h2&gt;
&lt;p&gt;æµ‹è¯•æ˜¯é¡¹ç›®ç”Ÿå‘½å‘¨æœŸçš„ä¸€ä¸ªé‡è¦æ–¹é¢ã€‚å®ƒæä¾›äº†æ— æ•°çš„å¥½å¤„ï¼Œä¾‹å¦‚å»ºç«‹å¯¹åº”ç”¨ç¨‹åºçš„ä¿¡å¿ƒã€å……å½“ä»£ç æ–‡æ¡£ä»¥åŠä½¿é‡æ„æ›´å®¹æ˜“ã€‚ä¸å…¶ä»–ä¸€äº›è¯­è¨€ç›¸æ¯”ï¼ŒGo å…·æœ‰å¼ºå¤§çš„ç¼–å†™æµ‹è¯•åŸè¯­ã€‚ä¸»è¦è®¨è®ºæµ‹è¯•è¿‡ç¨‹å˜å¾—è„†å¼±ã€æ•ˆç‡ä½ä¸‹å’Œå‡†ç¡®æ€§ä½çš„å¸¸è§é”™è¯¯ã€‚è¿™ç±»é—®é¢˜å±äºå·¥ç¨‹è§„èŒƒå®è·µï¼Œæœ‰äº›caseåŒæ ·é€‚ç”¨äºå…¶ä»–è¯­è¨€ã€‚&lt;/p&gt;
&lt;p&gt;Go ä¸­æä¾› go test å·¥å…·æ¥æ‰§è¡Œæµ‹è¯•ï¼Œå¯ä»¥æŸ¥çœ‹å…·ä½“çš„å¼€å‘æ–‡æ¡£ï¼š &lt;strong&gt;&lt;a href=&#34;https://pkg.go.dev/cmd/go#hdr-Testing_flags&#34;&gt;https://pkg.go.dev/cmd/go#hdr-Testing_flags&lt;/a&gt;&lt;/strong&gt;  é‡Œé¢ä»‹ç»äº†æ¯ä¸ªæ¨¡å¼çš„å…·ä½“ä½¿ç”¨æ–¹å¼ï¼Œä½¿ç”¨å¥½è¿™äº›æµ‹è¯•æ¨¡å¼flagï¼Œå¯ä»¥æ›´å¿«æ‰§è¡Œæˆ–æ›´å¥½åœ°å‘ç°å¯èƒ½é”™è¯¯ï¼Œè¿›è€Œä¿è¯ä»£ç è´¨é‡ï¼Œå·¥ç¨‹ä»£ç ç¨³å®šæ€§å»ºè®¾ä¸Šçš„é‡è¦ä¸€ç¯ã€‚Goä¸­æ”¯æŒ4ç§æµ‹è¯•å‡½æ•°ï¼šå•æµ‹å‡½æ•°ï¼ŒåŸºå‡†å‹æµ‹å‡½æ•°ï¼Œæ¨¡ç³Šæµ‹è¯•ï¼Œä»¥åŠæ‰“å°è¾“å‡ºæ ·ä¾‹æµ‹è¯•ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;TestXxx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;t&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;testing&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;...&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;BenchmarkXxx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;b&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;testing&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;B&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;...&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;FuzzXxx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;f&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;testing&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;F&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;...&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;ExampleXxx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
	&lt;span class=&#34;nf&#34;&gt;Println&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;The output of\\nthis example.&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
	&lt;span class=&#34;c1&#34;&gt;// Output: The output of
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;	&lt;span class=&#34;c1&#34;&gt;// this example.
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&#34;ç¬”è®°&#34;&gt;ç¬”è®°&lt;/h2&gt;
&lt;h3 id=&#34;82ä¸å¯¹æµ‹è¯•è¿›è¡Œåˆ†ç±»&#34;&gt;82.ä¸å¯¹æµ‹è¯•è¿›è¡Œåˆ†ç±»&lt;/h3&gt;
&lt;p&gt;åŠŸèƒ½æµ‹è¯•å¤§è‡´åˆ†ä¸ºå•å…ƒæµ‹è¯•ï¼Œé›†æˆæµ‹è¯•ï¼Œä»¥åŠç«¯åˆ°ç«¯çš„æµ‹è¯•ï¼Œå•å…ƒæµ‹è¯•åˆ™æ˜¯ç¨‹åºæµ‹è¯•caseè¦†ç›–ç‡çš„ä¿éšœï¼Œåˆ—ä¸¾Goä¸­3ç§å¸¸è§çš„æµ‹è¯•åˆ†ç±»æ–¹æ³•&lt;/p&gt;
&lt;h4 id=&#34;build-tags&#34;&gt;Build tags&lt;/h4&gt;
&lt;p&gt;build tags çš„ä¸€äº›ä½¿ç”¨åœºæ™¯ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æµ‹è¯•ç¯å¢ƒä½¿ç”¨ mock æœåŠ¡ï¼›è€Œæ­£å¼ç¯å¢ƒä½¿ç”¨çœŸå®æ•°æ®&lt;/li&gt;
&lt;li&gt;å…è´¹ç‰ˆã€ä¸“ä¸šç‰ˆå’Œä¼ä¸šç‰ˆæä¾›ä¸åŒçš„åŠŸèƒ½&lt;/li&gt;
&lt;li&gt;ä¸åŒæ“ä½œç³»ç»Ÿçš„å…¼å®¹æ€§å¤„ç†ã€‚é€šå¸¸ç”¨äºè·¨å¹³å°ï¼Œä¾‹å¦‚ windowsï¼Œlinuxï¼Œmac ä¸åŒå…¼å®¹å¤„ç†é€»è¾‘ã€‚&lt;/li&gt;
&lt;li&gt;go ä½ç‰ˆæœ¬çš„å…¼å®¹å¤„ç†&lt;/li&gt;
&lt;li&gt;å¯¹æµ‹è¯•ç”¨ä¾‹è¿›è¡Œåˆ†ç±»æµ‹è¯•&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;é€šè¿‡åœ¨æµ‹è¯•æ–‡ä»¶ä¸­åŠ ä¸Šå¯¹åº”çš„æµ‹è¯•åˆ†ç±»æ ‡ç­¾ï¼Œåœ¨æµ‹è¯•çš„æ—¶å€™æ–¹ä¾¿å¯¹ä¸€ç±»tagè¿›è¡Œæµ‹è¯•ï¼Œè€Œä¸éœ€è¦è·‘å…¨éƒ¨æµ‹è¯•ç”¨ä¾‹, æ¯”å¦‚æ‰“ä¸Š mock æ ‡ç­¾è¿›è¡Œç”¨äº mock ä¸€ç±»æµ‹è¯•&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;//go:build !&lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;mock1 &lt;span class=&#34;o&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; mock2&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;||&lt;/span&gt; mock3 &lt;span class=&#34;o&#34;&gt;||&lt;/span&gt; !&lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;mock4 &lt;span class=&#34;o&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; mock5&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;
// +build !mock1 !mock2 mock3 !mock4 !mock5
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;tips: è¿™ä¸ªæ˜¯ä¸ºäº†ä¸¾ä¸ªä¾‹å­ï¼Œå…·ä½“æµ‹è¯•tagéœ€è¦å› åœºæ™¯é€»è¾‘æ‰“ä¸Šï¼Œç¡®ä¿æµ‹è¯•æ–‡ä»¶tagæ— æ­§ä¹‰ã€‚&lt;/p&gt;
&lt;p&gt;ä» Go 1.17 å¼€å§‹ï¼Œè¯­æ³•&lt;code&gt;//+build foo&lt;/code&gt;è¢«æ›¿æ¢ä¸º&lt;code&gt;//go:build foo&lt;/code&gt;. ç›®å‰&lt;code&gt;gofmt&lt;/code&gt;åŒæ­¥ä¸¤ç§å½¢å¼ä»¥å¸®åŠ©è¿ç§»ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;c1&#34;&gt;# é»˜è®¤ä»…è¿è¡ŒåŒ…ä¸­tagä¸ºç©ºçš„æµ‹è¯•case&lt;/span&gt;
go &lt;span class=&#34;nb&#34;&gt;test&lt;/span&gt; -v .
&lt;span class=&#34;c1&#34;&gt;# ä»…è¿è¡ŒåŒ…ä¸­ mock3 çš„æµ‹è¯•case&lt;/span&gt;
go &lt;span class=&#34;nb&#34;&gt;test&lt;/span&gt; --tags&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;mock3 -v .
&lt;span class=&#34;c1&#34;&gt;# ä»…è¿è¡ŒåŒ…ä¸­ mock1 &amp;amp;&amp;amp; mock2 çš„æµ‹è¯•case&lt;/span&gt;
go &lt;span class=&#34;nb&#34;&gt;test&lt;/span&gt; --tags&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;mock1,mock2 -v .
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h4 id=&#34;ç¯å¢ƒå˜é‡&#34;&gt;ç¯å¢ƒå˜é‡&lt;/h4&gt;
&lt;p&gt;ä½¿ç”¨build tagæ–¹å¼æ„å»ºæµ‹è¯•ç”¨ï¼Œéšç€tagçš„å¢åŠ ï¼Œå¯èƒ½ä¼šéšè—æ‰å…¶ä¸­çš„é”™è¯¯ï¼Œè€Œä¸”éœ€è¦å»æŸ¥çœ‹æµ‹è¯•æ–‡ä»¶ä¸­çš„tagæœ‰å“ªäº›ã€‚ç¯å¢ƒå˜é‡è¿™ç§æ–¹å¼æ˜¯build tags çš„è¡¥å……å§ï¼Œå¯¹äºæ²¡æœ‰è®¾ç½®ç¯å¢ƒå˜é‡çš„æƒ…å†µä¸‹ï¼Œæ˜ç¡®æ˜¾ç¤ºå“ªäº›æµ‹è¯•æ˜¯è·³è¿‡çš„æµ‹è¯•ï¼Œæ¯”å¦‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt; os.Getenv&lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;INTEGRATION&amp;#34;&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt; !&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;true&amp;#34;&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;{&lt;/span&gt;
		t.Skip&lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;skipping integration test&amp;#34;&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;
	&lt;span class=&#34;o&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;tips: tagæ˜¯æµ‹è¯•æ–‡ä»¶ç²’åº¦åˆ†ç±»(Go æ„å»ºå·¥å…·æ”¯æŒ)ï¼Œç¯å¢ƒå˜é‡æ˜¯æµ‹è¯•ä»£ç ç²’åº¦åˆ†ç±»(æ‰‹åŠ¨ä»£ç é€»è¾‘)&lt;/p&gt;
&lt;h4 id=&#34;short-æ¨¡å¼&#34;&gt;Short æ¨¡å¼&lt;/h4&gt;
&lt;p&gt;å¦ä¸€ç§å¯¹æµ‹è¯•è¿›è¡Œåˆ†ç±»çš„æ–¹æ³•ä¸å®ƒä»¬çš„é€Ÿåº¦æœ‰å…³ã€‚å¯èƒ½ä¸å¾—ä¸å°†çŸ­æœŸè¿è¡Œçš„æµ‹è¯•ä¸é•¿æœŸè¿è¡Œçš„æµ‹è¯•åŒºåˆ†å¼€æ¥ã€‚&lt;/p&gt;
&lt;p&gt;ä½œä¸ºè¯´æ˜ï¼Œå‡è®¾æœ‰ä¸€ç»„å•å…ƒæµ‹è¯•ï¼Œå…¶ä¸­ä¸€ä¸ªæ˜¯å‡ºäº†åçš„æ…¢ã€‚æƒ³å¯¹æ…¢é€Ÿæµ‹è¯•è¿›è¡Œåˆ†ç±»ï¼Œè¿™æ ·å°±ä¸å¿…æ¯æ¬¡éƒ½è¿è¡Œå®ƒï¼ˆå°¤å…¶æ˜¯åœ¨ä¿å­˜æ–‡ä»¶åè§¦å‘ï¼‰ï¼Œä½¿ç”¨testing.ShortåŒºåˆ†å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;TestLongRunning&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;t&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;testing&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
	&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;testing&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Short&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
		&lt;span class=&#34;nx&#34;&gt;t&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Skip&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;skipping long-running test&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
	&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
	&lt;span class=&#34;c1&#34;&gt;// ...
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;è¿è¡Œæµ‹è¯•æ˜¯ï¼Œé€šè¿‡-short å‚æ•°æ¥æ‰§è¡Œè·³è¿‡&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;go &lt;span class=&#34;nb&#34;&gt;test&lt;/span&gt; -v -short .
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;è¿™ä¸‰ç§æ–¹å¼å¯ä»¥ç»„åˆä½¿ç”¨ï¼Œä¾‹å¦‚ï¼Œé¡¹ç›®åŒ…å«é•¿æ—¶é—´è¿è¡Œçš„å•å…ƒæµ‹è¯•ï¼Œåˆ™ä½¿ç”¨æ„å»ºæ ‡è®°æˆ–ç¯å¢ƒå˜é‡å¯¹æµ‹è¯•è¿›è¡Œåˆ†ç±»ï¼ˆä¾‹å¦‚ï¼Œä½œä¸ºå•å…ƒæµ‹è¯•ï¼Œmockæµ‹è¯•ï¼Œæˆ–è€…é›†æˆæµ‹è¯•ï¼‰å’Œä½¿ç”¨çŸ­æ¨¡å¼æ¥è·³è¿‡é•¿æ—¶é—´è¿è¡Œçš„æµ‹è¯•ã€‚&lt;/p&gt;
&lt;h3 id=&#34;83ä¸å¯ç”¨--race&#34;&gt;83.ä¸å¯ç”¨ -race&lt;/h3&gt;
&lt;p&gt;å¯¹äºå¹¶å‘ç¨‹åºä»£ç çš„æµ‹è¯•ï¼Œéœ€è¦æ£€æµ‹æ˜¯å¦å­˜åœ¨data raceï¼Œ éœ€è¦ä½¿ç”¨ -race æ¨¡å¼æ¥æ„å»ºæµ‹è¯•ï¼Œæ¯”å¦‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;k&#34;&gt;go&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;test&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;race&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/...&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;è¿™ç§æ–¹æ³•ä½¿å¯ç”¨ç«äº‰æ£€æµ‹å™¨ï¼Œå®ƒå¯ä»¥æ£€æµ‹ä»£ç ä»¥æ•è·æ½œåœ¨çš„æ•°æ®ç«äº‰(æ²¡æœ‰æ‰“ä¸Š!raceæ ‡è®°çš„æ–‡ä»¶)ã€‚å¯ç”¨æ—¶ï¼Œå®ƒå¯¹å†…å­˜å’Œæ€§èƒ½æœ‰æ˜¾ç€å½±å“ï¼Œå› æ­¤å¿…é¡»åœ¨ç‰¹å®šæ¡ä»¶ä¸‹ä½¿ç”¨ï¼Œä¾‹å¦‚æœ¬åœ°æµ‹è¯•æˆ– CIã€‚åœ¨ç”Ÿäº§ä¸­ï¼Œåº”è¯¥é¿å…å®ƒï¼ˆæˆ–è€…åªåœ¨é‡‘ä¸é›€å‘å¸ƒçš„æƒ…å†µä¸‹ä½¿ç”¨)ã€‚&lt;/p&gt;
&lt;p&gt;ç«äº‰æ£€æµ‹å™¨æ— æ³•æ•æ‰åˆ°è¯¯æŠ¥ï¼ˆæ˜æ˜¾çš„æ•°æ®ç«äº‰å¹¶ä¸æ˜¯çœŸå®çš„ï¼‰ã€‚å› æ­¤ï¼Œå¦‚æœæ”¶åˆ°è­¦å‘Šï¼Œå°±çŸ¥é“ä»£ç åŒ…å«æ•°æ®ç«äº‰ã€‚ç›¸åï¼Œå®ƒæœ‰æ—¶ä¼šå¯¼è‡´æ¼æŠ¥ï¼ˆç¼ºå°‘å®é™…çš„æ•°æ®ç«äº‰ï¼‰ã€‚å¯¹äºæ¼æŠ¥çš„æƒ…å†µï¼Œå¯ä»¥å°½å¯èƒ½å¤šçš„è¿­ä»£æ¥æ£€æµ‹ã€‚&lt;/p&gt;
&lt;h3 id=&#34;84ä¸ä½¿ç”¨æµ‹è¯•æ‰§è¡Œæ¨¡å¼&#34;&gt;84.ä¸ä½¿ç”¨æµ‹è¯•æ‰§è¡Œæ¨¡å¼&lt;/h3&gt;
&lt;h4 id=&#34;-parallel&#34;&gt;-parallel&lt;/h4&gt;
&lt;p&gt;é»˜è®¤æƒ…å†µä¸‹ go test åœ¨ä¸åŒçš„ package ä¹‹é—´æ˜¯å¹¶è¡Œæ‰§è¡Œæµ‹è¯•ï¼Œåœ¨æ¯ä¸ª package å†…éƒ¨æ˜¯ä¸²è¡Œæ‰§è¡Œæµ‹è¯•ã€‚å¦‚æœæƒ³è¦åœ¨ package å†…éƒ¨å¼€å¯å¹¶è¡Œæµ‹è¯•ï¼Œéœ€è¦åœ¨æµ‹è¯•å‡½æ•°ä¸­æ˜¾å¼æ‰§è¡Œ t.Parallel() å‘Šè¯‰ go test è¿™ä¸ªå‡½æ•°å¯ä»¥ä¸å…¶ä»–æµ‹è¯•å¹¶è¡Œæ‰§è¡Œï¼Œä¸€æ—¦å¼€å¯å¹¶è¡Œæµ‹è¯•ï¼Œä¸€å®šè¦ç¡®ä¿æµ‹è¯•å‡½æ•°ä¹‹é—´çš„èµ„æºç«äº‰çš„é—®é¢˜å·²ç»å¾—åˆ°æ­£ç¡®çš„è§£å†³ã€‚æ‰§è¡Œ go test -parallel n æ¥åˆ¶å®šnä¸ªæµ‹è¯•å‡½æ•°å¹¶è¡Œæ‰§è¡Œ(éœ€è¦å†æ˜¾ç¤ºè°ƒç”¨äº†t.Parrallel)ã€‚å¯¹äºæ‰§è¡Œæ…¢çš„æµ‹è¯•å‡½æ•°ï¼Œç›¸äº’ä¹‹é—´æ²¡æœ‰èµ„æºç«äº‰ï¼Œå¯ä»¥åŠ å…¥t.Parrallel æ¥åŒæ—¶æ‰§è¡Œï¼Œæé«˜æµ‹è¯•çš„æ‰§è¡Œé€Ÿåº¦ã€‚&lt;/p&gt;
&lt;h4 id=&#34;-shuffle&#34;&gt;-shuffle&lt;/h4&gt;
&lt;p&gt;ä» Go 1.17 å¼€å§‹å¼•å…¥ï¼Œå¯ä»¥éšæœºåŒ–æµ‹è¯•å’ŒåŸºå‡†æµ‹è¯•çš„æ‰§è¡Œé¡ºåºï¼Œ è®¾ç½®ä¸º&lt;code&gt;on&lt;/code&gt;æˆ–&lt;code&gt;off&lt;/code&gt;å¯ç”¨æˆ–ç¦ç”¨éšæœºæµ‹è¯•ï¼›ç¼–å†™æµ‹è¯•æ—¶çš„æœ€ä½³åšæ³•æ˜¯å°†å®ƒä»¬éš”ç¦»å¼€æ¥ã€‚ä¾‹å¦‚ï¼Œå®ƒä»¬ä¸åº”ä¾èµ–äºæ‰§è¡Œé¡ºåºæˆ–å…±äº«å˜é‡ã€‚è¿™äº›éšè—çš„ä¾èµ–å…³ç³»å¯èƒ½æ„å‘³ç€ä¸€ä¸ªå¯èƒ½çš„æµ‹è¯•é”™è¯¯ï¼Œæˆ–è€…æ›´ç³Ÿçš„æ˜¯ï¼Œä¸€ä¸ªåœ¨æµ‹è¯•æœŸé—´ä¸ä¼šè¢«æ•è·çš„é”™è¯¯ã€‚&lt;/p&gt;
&lt;p&gt;åº”è¯¥å¯¹ç°æœ‰çš„æµ‹è¯•æ ‡å¿—ä¿æŒè°¨æ…ï¼Œå¹¶éšæ—¶äº†è§£æœ€æ–° Go ç‰ˆæœ¬çš„æ–°åŠŸèƒ½ã€‚è¿è¡Œparallelæµ‹è¯•æˆ–è€…å°†æµ‹è¯•åˆ†å†ä¸åŒçš„åŒ…ä¸­ï¼Œå¯ä»¥å‡å°‘è¿è¡Œæ‰€æœ‰æµ‹è¯•çš„æ€»ä½“æ‰§è¡Œæ—¶é—´ã€‚shuffleæµ‹è¯•å¯ä»¥å¸®åŠ©å‘ç°éšè—çš„ä¾èµ–å…³ç³»ï¼Œè¿™äº›ä¾èµ–å…³ç³»å¯èƒ½æ„å‘³ç€åœ¨ä»¥ç›¸åŒé¡ºåºè¿è¡Œæµ‹è¯•æ—¶å‡ºç°æµ‹è¯•é”™è¯¯ï¼Œç”šè‡³ä¸å¯è§çš„é”™è¯¯ã€‚&lt;/p&gt;
&lt;h3 id=&#34;85ä¸ä½¿ç”¨è¡¨é©±åŠ¨æµ‹è¯•&#34;&gt;85.ä¸ä½¿ç”¨è¡¨é©±åŠ¨æµ‹è¯•&lt;/h3&gt;
&lt;p&gt;è¿™ä¸ªåœ¨vscode, goland IDEä¸­å·²ç»é›†æˆäº†ï¼Œå¯¹åº”å‡½æ•°ç”Ÿæˆå¯¹åº”å•æµ‹å‡½æ•°æ—¶ï¼Œä¼šè‡ªåŠ¨ç»™å‡ºè¡¨é©±åŠ¨æµ‹è¯•æ¨¡ç‰ˆï¼Œç¼–å†™æµ‹è¯•ç”¨ä¾‹ï¼Œç”¨äºè¦†ç›–å‡½æ•°åˆ†æ”¯åœºæ™¯ï¼›å¦‚æœä¸æ˜¯ç”¨è¡¨é©±åŠ¨æµ‹è¯•çš„è¯ï¼Œ ä¼šå‡ºç°å¤§é‡çš„å†—ä½™å‡½æ•°ï¼Œè€Œä¸”è¡¨è¾¾å«ä¹‰ä¹Ÿä¼šç›¸å¯¹æ¨¡ç³Šï¼Œç›´æ¥æ”¾å…¥ä¸€ä¸ªæµ‹è¯•å‡½æ•°ä¸­æ¥ç¼–å†™ç”¨ä¾‹æµ‹è¯•å³å¯ï¼Œä¹Ÿä¾¿äºå¯¹æ•´ä¸ªå‡½æ•°çš„æµ‹è¯•è¦†ç›–ã€‚é€šè¿‡t.Runæ¥æ‰§è¡Œè¿™äº›æµ‹è¯•ç”¨ä¾‹ï¼Œè¿›è¡ŒæœŸæœ›å€¼æ¯”è¾ƒï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥ä½¿ç”¨t.Parallel() é€šè¿‡parallel æ¨¡å¼æ¥åŠ é€Ÿæµ‹è¯•ï¼Œä»¥åŠé€šè¿‡shuffleæ¥éšæœºæµ‹è¯•ã€‚&lt;/p&gt;
&lt;h3 id=&#34;86åœ¨å•å…ƒæµ‹è¯•ä¸­ä½¿ç”¨timesleep&#34;&gt;86.åœ¨å•å…ƒæµ‹è¯•ä¸­ä½¿ç”¨time.Sleep&lt;/h3&gt;
&lt;p&gt;åœ¨æµ‹è¯•å¹¶å‘ç¼–ç¨‹æ—¶ï¼Œå¯èƒ½å­˜åœ¨ç«äº‰æ¡ä»¶race condition çš„åœºæ™¯ï¼Œå¯¼è‡´ç¨‹åºçš„æ‰§è¡Œé¡ºåºä¸åŒï¼Œè¿›å…¥å½±å“æµ‹è¯•çš„å‡†ç¡®æ€§ï¼Œå¦‚æœä½¿ç”¨time.Sleep ä¹‹åæ¥æ–­è¨€å€¼ï¼Œ å¯èƒ½ä¼šæœ‰ä¸åŒçš„ç»“æœï¼Œæ˜¯ä¸ç¡®å®šæ€§çš„ï¼Œæ‰€ä»¥ï¼Œå°½é‡ä½¿ç”¨ç®¡é“åŒæ­¥çš„æ–¹å¼æ¥è¿›è¡Œæ–­è¨€æµ‹è¯•ï¼›å¦‚æœåŒæ­¥ä¸å¯èƒ½åšåˆ°çš„è¯ï¼Œ å¯ä»¥é‡è¯•è¿›è¡Œæ–­è¨€ï¼Œæ¯”å¦‚å¸¸ç”¨çš„testify æµ‹è¯•åŒ…ï¼Œä½¿ç”¨Eventuallyå‡½æ•°å®ç°äº†æœ€ç»ˆåº”è¯¥æˆåŠŸçš„æ–­è¨€ï¼Œè¿™æ¯”ä½¿ç”¨è¢«åŠ¨ç¡çœ æ›´å¥½çš„é€‰æ‹©æ¥æ¶ˆé™¤æµ‹è¯•ä¸­çš„éç¡®å®šæ€§ã€‚&lt;/p&gt;
&lt;h3 id=&#34;87æ²¡æœ‰æœ‰æ•ˆåœ°å¤„ç†æ—¶é—´-api&#34;&gt;87.æ²¡æœ‰æœ‰æ•ˆåœ°å¤„ç†æ—¶é—´ API&lt;/h3&gt;
&lt;p&gt;å¯¹äºå‡½æ•°ä¸­æœ‰time.Now()è·å–å½“å‰æ—¶é—´ï¼Œè€Œæµ‹è¯•æ˜¯ä¹Ÿä¾èµ–å½“å‰æ—¶é—´çš„å¤„ç†ï¼Œå¯¼è‡´é‚£ä¸ªæ—¶é—´ç‚¹å¯èƒ½ä¼šå­˜åœ¨å·®å¼‚ï¼Œä¸€ç§æ–¹å¼æ˜¯æä¾›å…¨å±€å…±äº«å˜é‡ï¼Œå¦‚æœä½¿ç”¨å¹¶è¡Œæµ‹è¯•çš„ï¼Œå…¨éƒ¨å…±äº«å˜é‡ä¼šå¼•å…¥æ•°æ®ç«äº‰ï¼Œå¯¼è‡´æ— æ³•å¹¶è¡Œæµ‹è¯•ï¼Œæ‰€ä»¥æœ€å¥½çš„æ–¹å¼ï¼Œä¿®æ”¹ä¸‹æ‰€è¦æµ‹è¯•çš„å‡½æ•°ï¼Œå»æ‰time.Now()çš„ä¾èµ–ï¼Œä½¿ç”¨time.Timeç±»å‹ä½œä¸ºä¼ å…¥å‚æ•°ï¼Œæœ‰å‡½æ•°ä½¿ç”¨æ–¹ä¸€èµ·æ¥å®šä¹‰ï¼Œè¿™æ ·å¯æ–¹ä¾¿æµ‹è¯•ã€‚&lt;/p&gt;
&lt;h3 id=&#34;88ä¸ä½¿ç”¨æµ‹è¯•å®ç”¨ç¨‹åºåŒ…&#34;&gt;88.ä¸ä½¿ç”¨æµ‹è¯•å®ç”¨ç¨‹åºåŒ…&lt;/h3&gt;
&lt;p&gt;httptest å’Œ iotest æ˜¯ä¸¤ä¸ªå¸¸ç”¨çš„åŒ…ï¼Œåº”è¯¥åˆ©ç”¨èµ·æ¥ï¼Œæ„é€ äºhttp å’Œ io ç›¸å…³å‡½æ•°çš„æµ‹è¯•ã€‚&lt;/p&gt;
&lt;h4 id=&#34;httptest&#34;&gt;httptest&lt;/h4&gt;
&lt;p&gt;httptest åŒ…ä¸éœ€è¦é€šè¿‡å»ºç«‹ç½‘ç»œè¿æ¥å°±å¯ä»¥è¿›è¡Œæµ‹è¯•ï¼Œä¸»è¦ç”¨æ¥æµ‹è¯•æœåŠ¡ç«¯çš„http api handler å‡½æ•° ä»¥åŠ å®¢æˆ·ç«¯çš„http callerå‡½æ•°ã€‚å…·ä½“æŸ¥çœ‹å¼€å‘æ–‡æ¡£ï¼šhttps://pkg.go.dev/net/http/httptest&lt;/p&gt;
&lt;p&gt;å¯¹äºæµ‹è¯•æœåŠ¡ä¸­api Handlerçš„åœºæ™¯ï¼Œåªéœ€è¦é€šè¿‡httptest.NewRequest æ¥æ„å»ºapiçš„è¯·æ±‚æ•°æ®çš„Readerï¼Œä»¥åŠä½¿ç”¨httptest.NewRecorder æ¥åˆ›å»ºä¸€ä¸ªå¾€è¯·æ±‚apiä¸­å†™å…¥å“åº”æ•°æ®çš„Writer, è¿™æ ·åœ¨å†™æµ‹è¯•ç”¨ä¾‹æ—¶å€™ï¼Œ ç›´æ¥æ¨¡æ‹Ÿæ¥å£è¯·æ±‚æ•°æ®ï¼Œç¼–å†™ç›¸å…³çš„æµ‹è¯•case,  æµ‹è¯•çš„api handler è¿”å›çš„æ•°æ® å¯ä»¥ä»Writerä¸­è·å–åˆ°ï¼Œè¿›è€Œå¯ä»¥åšæ¥å£å“åº”æ•°æ®çš„æ–­è¨€å‡è®¾ï¼Œæ¯”å¦‚ è¿”å›çŠ¶æ€ç ï¼Œå“åº”bodyæ•°æ®ï¼Œ å“åº”å¤´ä¸­çš„æ•°æ®ã€‚&lt;/p&gt;
&lt;p&gt;å¯¹äºæµ‹è¯•å®¢æˆ·ç«¯ä¸­ç›¸å…³çš„http client callerå‡½æ•°ï¼Œ é€šè¿‡httptest.NewServerå»ºç«‹å¯¹åº”api handleræœåŠ¡, å®¢æˆ·ç«¯ç›¸å…³çš„http client &lt;a href=&#34;http://xn--callerhttp-uh4py1d60ohkhow7ewtwc.Client.Do&#34;&gt;callerå‡½æ•°å¯ä»¥ä½¿ç”¨http.Client.Do&lt;/a&gt; å¯¹server.URLè¿›è¡Œè°ƒç”¨äº†ï¼Œè¿›è€Œå¯ä»¥å¯¹è¿”å›çš„å€¼è¿›è¡Œæ–­è¨€æµ‹è¯•ã€‚è¿˜å¯ä»¥ä½¿ç”¨httptest.NewTLSServer å»ºç«‹ä¸€ä¸ªTLSçš„æµ‹è¯•æœåŠ¡ã€‚&lt;/p&gt;
&lt;p&gt;grpcä¹Ÿæœ‰å¯¹åº”çš„æµ‹è¯•åº“grpc/test åº“ï¼Œæ— éœ€å»ºç«‹ç½‘ç»œè¿æ¥å³å¯æµ‹è¯•ï¼Œå…·ä½“æŸ¥çœ‹å¼€å‘æ–‡æ¡£ï¼šhttps://pkg.go.dev/google.golang.org/grpc/test&lt;/p&gt;
&lt;h4 id=&#34;iotest&#34;&gt;iotest&lt;/h4&gt;
&lt;p&gt;è¯¥ioteståŒ… ( &lt;a href=&#34;https://pkg.go.dev/testing/iotest&#34;&gt;https://pkg.go.dev/testing/iotest&lt;/a&gt; ) å®ç°äº†io Reader ï¼ŒWriterï¼Œ Closer ç­‰æ¥å£ï¼Œ ç”¨äºæµ‹è¯•ä½¿ç”¨io ç›¸å…³æ¥å£çš„æ–¹æ³•æµ‹è¯•ï¼›&lt;/p&gt;
&lt;h3 id=&#34;89ç¼–å†™ä¸å‡†ç¡®çš„åŸºå‡†&#34;&gt;89.ç¼–å†™ä¸å‡†ç¡®çš„åŸºå‡†&lt;/h3&gt;
&lt;p&gt;å¯¹äºæ€§èƒ½ä¼˜åŒ–ï¼Œä¸èƒ½ç›²çŒœï¼Œéœ€è¦ç¼–å†™åŸºå‡†å‹æµ‹æ¥ åˆ†æè¯„ä¼° å…·ä½“æ€§èƒ½ï¼Œç„¶è€Œç¼–å†™åŸºå‡†æµ‹è¯•å¹¶ä¸ç®€å•ã€‚ç¼–å†™ä¸å‡†ç¡®çš„åŸºå‡†å¹¶æ ¹æ®å®ƒä»¬åšå‡ºé”™è¯¯çš„å‡è®¾å¯èƒ½éå¸¸ç®€å•ã€‚ä½¿ç”¨go test -bench &lt;code&gt;regexp&lt;/code&gt; åŒ¹é…å¯¹åº”BenchmarkXxxxå‡½æ•°è¿›è¡ŒåŸºå‡†å‹æµ‹ï¼Œé»˜è®¤è¿è¡Œ1s, è¿è¡Œæ—¶é—´é€šè¿‡-benchtime æ¥è°ƒæ•´ï¼Œå…¶ä»–æ€§èƒ½åˆ†æçš„å‚æ•°è§å¼€å‘æ–‡æ¡£ã€‚ä»¥ä¸‹å‡ ç§å¸¸è§ç¼–å†™ä¸å‡†ç¡®åŸºå‡†å‹æµ‹çš„æƒ…å†µï¼š&lt;/p&gt;
&lt;h4 id=&#34;ä¸é‡ç½®æˆ–æš‚åœå®šæ—¶å™¨&#34;&gt;ä¸é‡ç½®æˆ–æš‚åœå®šæ—¶å™¨&lt;/h4&gt;
&lt;p&gt;åœ¨åŸºå‡†å‹æµ‹æ—¶ï¼Œå¯èƒ½ä¼šæ‰§è¡Œä¸€ä¸ªè€—æ—¶é•¿çš„åˆå§‹å‡†å¤‡é€»è¾‘ï¼Œæ¯”å¦‚å‡†å¤‡å¤§é‡çš„æ•°æ®ç”¨äºåŸºå‡†å‹æµ‹ï¼Œè¿™ä¸ªæ—¶å€™éœ€è¦å¼•å…¥ testing.B.ResetTimer() æ¥é‡ç½®æ—¶é—´ï¼Œåœ¨å¼€å§‹åŸºå‡†å‹æµ‹ï¼Œä»æµ‹è¯•ç»“æœä¸­ä¸¢å¼ƒè¿™éƒ¨åˆ†è€—æ—¶è®¾ç½®ï¼› è¿˜æœ‰ä¸€ç§æƒ…å†µæ˜¯åœ¨åŸºå‡†å‹æµ‹çš„å¾ªç¯é‡Œï¼Œè¿™éœ€è¦ä½¿ç”¨testing.B.StopTimer()åœæ­¢æ—¶é—´ï¼Œå¤„ç†å®Œå‡†å¤‡é€»è¾‘ï¼Œåœ¨ä½¿ç”¨testing.B.StartTimer()å¼€å§‹æ—¶é—´æ¥å¤„ç†åŸºå‡†æµ‹è¯•å‡½æ•°ã€‚&lt;/p&gt;
&lt;h4 id=&#34;å¯¹å¾®åŸºå‡†åšå‡ºé”™è¯¯çš„å‡è®¾&#34;&gt;å¯¹å¾®åŸºå‡†åšå‡ºé”™è¯¯çš„å‡è®¾&lt;/h4&gt;
&lt;p&gt;å¯¹äºåŸºå‡†æµ‹è¯•ï¼Œä¸èƒ½åªç”¨ä¸€è½®æˆ–å‡ è½®åŸºå‡†å®éªŒï¼Œå°±åšå‡ºäº†å‡è®¾ï¼›åŸºå‡†æµ‹è¯•å—å½“å‰æœºå™¨è¿è¡Œæ—¶ç¯å¢ƒçš„å½±å“ï¼Œcpuï¼Œå†…å­˜è´Ÿè½½æƒ…å†µç­‰ï¼›æ‰€ä»¥åœ¨è¿›è¡ŒåŸºå‡†å‹æµ‹è¯•ï¼Œå¦‚æœæµ‹è¯•çš„å€¼æœ‰æ‰€åå¤±ï¼Œåº”è¯¥æŒ‰ç…§æ¦‚ç‡è®ºä¸­çš„å¤§æ•°å®šå¾‹ï¼Œå°†å‹æµ‹çš„æ—¶é—´æ”¾é•¿(-benchtime è°ƒæ•´)ï¼Œè€Œä¸”æµ‹è¯•çš„æ¬¡æ•°å¯ä»¥å¢åŠ äº›(-count è°ƒæ•´)ï¼Œ å°†è¿™äº›æ€§èƒ½æ•°æ®ï¼Œé€šè¿‡benchstat &lt;a href=&#34;https://pkg.go.dev/golang.org/x/perf/cmd/benchstat&#34;&gt;https://pkg.go.dev/golang.org/x/perf/cmd/benchstat&lt;/a&gt; å·¥å…·æ¥ å¯¹æ¯”åˆ†æ å‰åbenchmarkçš„ç»Ÿè®¡æ•°æ®, å¦‚æœå¯¹æ¯”ç»“æœè¯¯å·®å¾ˆå°ï¼Œåˆ™è¯´æ˜æ€§èƒ½æ— å·®å¼‚ã€‚åŸºå‡†æµ‹è¯•å¿…é¡»åŸºäºåœ¨åˆç†ç¯å¢ƒä¸­é€šè¿‡å¤šæ¬¡æ ·æœ¬å–è¯è¿›è¡ŒA/B æ¯”è¾ƒä¹‹åæ‰èƒ½ç»™å‡ºæ¯”è¾ƒæ­£ç¡®çš„ç»“æœã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;k&#34;&gt;go&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;install&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;golang&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;org&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;x&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;perf&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;cmd&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;benchstat&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;@&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;latest&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;go&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;test&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;run&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;NONE&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;bench&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;BenchmarkAtomicStoreInt32&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;count&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;10&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;benchtime&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;3&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;s&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;benchmem&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;11&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;testing&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;89&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;benchmark&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;wrong&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;assumptions&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;tee&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;a&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;smp1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;txt&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;go&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;test&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;run&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;NONE&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;bench&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;BenchmarkAtomicStoreInt32&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;count&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;10&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;benchtime&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;3&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;s&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;benchmem&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;11&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;testing&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;89&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;benchmark&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;wrong&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;assumptions&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;tee&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;a&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;smp2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;txt&lt;/span&gt;
&lt;span class=&#34;nx&#34;&gt;benchstat&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;smp1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;txt&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;smp2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;txt&lt;/span&gt;

&lt;span class=&#34;k&#34;&gt;go&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;test&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;run&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;NONE&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;bench&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;BenchmarkAtomicStore&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;count&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;10&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;benchtime&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;3&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;s&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;benchmem&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;11&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;testing&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;89&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;benchmark&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;wrong&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;assumptions&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;tee&lt;/span&gt;  &lt;span class=&#34;nx&#34;&gt;smp&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;txt&lt;/span&gt;
&lt;span class=&#34;nx&#34;&gt;benchstat&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;smp&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;txt&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h4 id=&#34;ä¸æ³¨æ„ç¼–è¯‘å™¨ä¼˜åŒ–&#34;&gt;ä¸æ³¨æ„ç¼–è¯‘å™¨ä¼˜åŒ–&lt;/h4&gt;
&lt;p&gt;è¿™ä¸ªcase åœ¨Goä¸­æœ‰å¯¹åº”issueï¼ˆhttps://github.com/golang/go/issues/14813ï¼‰; benchmarkçš„å‡½æ•°ä»£ç æ¯”è¾ƒç®€å•ï¼Œè¢«å†…è”åˆ°åŸºå‡†å‹æµ‹æ–‡ä»¶ä¸­ï¼Œå¯¼è‡´æµ‹è¯•ä¸ºç©ºçš„ï¼Œè¿™æ ·å¯¼è‡´ç©ºçš„åŸºå‡†å‹æµ‹åœ¨æ‰§è¡Œï¼Œæ¯æ¬¡opæ—¶é—´ç›¸å½“äºä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸæ—¶é—´ï¼Œå¦‚ä½•é¿å…ç¼–è¯‘å™¨ä¼˜åŒ–æ¬ºéª—åŸºå‡†æµ‹è¯•ç»“æœçš„æ¨¡å¼ï¼š&lt;/p&gt;
&lt;p&gt;å°†è¢«æµ‹å‡½æ•°çš„ç»“æœåˆ†é…ç»™å±€éƒ¨å˜é‡ï¼Œç„¶åå°†æœ€æ–°ç»“æœåˆ†é…ç»™å…¨å±€å˜é‡ï¼Œå…ˆåˆ†é…å±€éƒ¨å˜é‡åœ¨æ ˆä¸Šï¼Œä¸å½±å“æµ‹è¯•ï¼Œè€Œå°†å±€éƒ¨å˜é‡å¤åˆ¶ç»™å…¨å±€å˜é‡ï¼Œåˆ†é…åœ¨å †ä¸Šï¼Œä»¥é˜²ç¼–è¯‘å™¨ä¼˜åŒ–è¿›è¡Œinline å¤„ç†ã€‚&lt;/p&gt;
&lt;p&gt;è¿˜æœ‰ä¸€ç§æ–¹å¼æ˜¯ç›´æ¥ä½¿ç”¨//go:noinline æ ‡è®°å‡½æ•°ï¼Œåœ¨ç¼–è¯‘é˜¶æ®µé˜²æ­¢inlineã€‚&lt;/p&gt;
&lt;h4 id=&#34;è¢«è§‚å¯Ÿè€…æ•ˆåº”æ„šå¼„&#34;&gt;è¢«è§‚å¯Ÿè€…æ•ˆåº”æ„šå¼„&lt;/h4&gt;
&lt;p&gt;åœ¨åŸºå‡†å‹æµ‹ä¸€ä¸ªCPU-Boundçš„å‡½æ•°æ—¶ï¼Œéœ€è¦æ³¨æ„cpu cache å±€éƒ¨æ€§åŸç†å¯¹åŸºå‡†å‹æµ‹çš„å½±å“ï¼›ä¸ºäº†é˜²æ­¢cpu cacheå¯¹åŸºå‡†å‹æµ‹çš„å½±å“ï¼Œå¯ä»¥åœ¨æ¯æ¬¡æµ‹è¯•å‰ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„æµ‹è¯•æ•°æ®ç”¨äºæµ‹è¯•ï¼Œæ¯”å¦‚åŸºå‡†å‹æµ‹çŸ©é˜µè¿ç®—å‡½æ•°ï¼Œåœ¨æ¯æ¬¡æµ‹è¯•å‰ï¼Œæ–°å»ºä¸€ä¸ªæµ‹è¯•çŸ©é˜µæ•°æ®ã€‚&lt;/p&gt;
&lt;h3 id=&#34;90æ²¡æœ‰æ¢ç´¢æ‰€æœ‰çš„-go-æµ‹è¯•åŠŸèƒ½&#34;&gt;90.æ²¡æœ‰æ¢ç´¢æ‰€æœ‰çš„ Go æµ‹è¯•åŠŸèƒ½&lt;/h3&gt;
&lt;p&gt;å·¥æ¬²å–„å…¶äº‹å¿…å…ˆåˆ©å…¶å™¨ï¼Œå……åˆ†æŒæ¡go testå·¥å…·æœ‰åŠ©äºå†™å‡ºé«˜è´¨é‡çš„ä»£ç ã€‚&lt;/p&gt;
&lt;h4 id=&#34;ä»£ç è¦†ç›–ç‡&#34;&gt;ä»£ç è¦†ç›–ç‡&lt;/h4&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;c1&#34;&gt;# è¾“å‡ºæµ‹è¯•è¦†ç›–æ–‡ä»¶&lt;/span&gt;
go &lt;span class=&#34;nb&#34;&gt;test&lt;/span&gt; -coverprofile&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;coverage.out ./...
&lt;span class=&#34;c1&#34;&gt;# åˆ†ææµ‹è¯•è¦†ç›–æ–‡ä»¶&lt;/span&gt;
go tool cover -html&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;coverage.out
&lt;span class=&#34;c1&#34;&gt;# ä¸€ä¸ªåŒ…åœ¨å¦å¤–ä¸€ä¸ªåŒ…ä¸­ä¼šæµ‹è¯•åˆ°ï¼Œéœ€è¦è¡¨æ˜æµ‹è¯•è¦†ç›–åˆ°çš„åŒ…&lt;/span&gt;
go &lt;span class=&#34;nb&#34;&gt;test&lt;/span&gt; -coverpkg&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;./... -coverprofile&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;coverage.out ./...
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;tips: åœ¨è¿½è¸ªä»£ç è¦†ç›–ç‡æ—¶è¦ä¿æŒè°¨æ…ã€‚æ‹¥æœ‰ 100% çš„æµ‹è¯•è¦†ç›–ç‡å¹¶ä¸æ„å‘³ç€åº”ç”¨ç¨‹åºæ²¡æœ‰é”™è¯¯ï¼›éœ€æ­£ç¡®æ¨ç†æµ‹è¯•æ¶µç›–çš„å†…å®¹ã€‚&lt;/p&gt;
&lt;h4 id=&#34;ä»ä¸åŒçš„åŒ…è¿›è¡Œæµ‹è¯•&#34;&gt;ä»ä¸åŒçš„åŒ…è¿›è¡Œæµ‹è¯•&lt;/h4&gt;
&lt;p&gt;è¿™ç§åœ¨ä¸šåŠ¡åŠŸèƒ½å‡½æ•°æµ‹è¯•ï¼Œæˆ–è€…å¯¹å¤–éƒ¨è¿›è¡Œæµ‹è¯•ï¼Œ å…³æ³¨åŒ…çš„å…¬å¼€apiè¡Œä¸ºè€Œä¸æ˜¯å†…éƒ¨çš„å…·ä½“å®ç°ç»†èŠ‚ï¼Œä¸“æ³¨äºæµ‹è¯•æš´éœ²çš„è¡Œä¸ºã€‚ å¸¸ç”¨çš„æµ‹è¯•å¦‚BDD å¼€å‘ï¼Œ åªå…³æ³¨åŒ…çš„å…¬å¼€è¡Œä¸ºï¼Œ æ¯”å¦‚&lt;a href=&#34;https://onsi.github.io/ginkgo/&#34;&gt;ginkgo&lt;/a&gt; ï¼›ç¼–å†™çš„æµ‹è¯•ç”¨ä¾‹æ–‡ä»¶å¯ä»¥ä¸ç”¨å’Œæµ‹è¯•å‡½æ•°åœ¨åŒä¸€ä¸ªåŒ…å†…ï¼Œå¯ä»¥å•ç‹¬å®šä¹‰æµ‹è¯•æ–‡ä»¶å¤¹ï¼Œå¯¹ä¸åŒåŒ…æ¥è¿›è¡Œæµ‹è¯•ç”¨ä¾‹çš„å¼€å‘ã€‚&lt;/p&gt;
&lt;h4 id=&#34;helperåŠŸèƒ½å‡½æ•°&#34;&gt;helperåŠŸèƒ½å‡½æ•°&lt;/h4&gt;
&lt;p&gt;åœ¨è¿›è¡Œæµ‹è¯•æ˜¯ï¼Œéœ€è¦æµ‹è¯•å‰çš„å‡†å¤‡ï¼Œè¿™äº›å‡†å¤‡å·¥ä½œé€»è¾‘helperåŠŸèƒ½å‡½æ•°ï¼Œç”¨äºåˆå§‹åŒ–ä¸€äº›å¯¹è±¡æ¥æµ‹è¯•ï¼Œå‚æ•°éœ€è¦ä¼ å…¥*testing.T,  åœ¨åˆå§‹é€»è¾‘ä¸­åˆ¤è¯»åˆå§‹çš„é”™è¯¯æƒ…å†µï¼Œå¦‚æœé”™è¯¯ç›´æ¥è°ƒç”¨t.Fatalé€€å‡ºå³å¯ï¼Œåªè¿”å›å¯¹åº”æµ‹è¯•å¯¹è±¡ï¼Œè¿™æ ·å¯ä»¥æ–¹ä¾¿å¤ç”¨ï¼Œæ— éœ€åœ¨å¤„ç†é”™è¯¯ï¼Œæ–¹ä¾¿å…¶ä»–æµ‹è¯•åœºæ™¯ä½¿ç”¨ã€‚è¿™ä¸ªå±äºä»£ç è´¨é‡é—®é¢˜å•¦ã€‚&lt;/p&gt;
&lt;h4 id=&#34;å®‰è£…setupå’Œæ‹†å¸teardown&#34;&gt;å®‰è£…(setup)å’Œæ‹†å¸(teardown)&lt;/h4&gt;
&lt;p&gt;å¦‚æœå•ä¸ªæµ‹è¯•åˆå§‹æ‰§è¡Œå®Œæµ‹è¯•åéœ€è¦æ¸…ç†ä¸€äº›åˆå§‹èµ„æºï¼Œå¯ä»¥ä½¿ç”¨ testing.T.Cleanupå‡½æ•°æ¥åšå•æµ‹çš„æ”¶å°¾å·¥ä½œï¼›å¤šä¸ªè°ƒç”¨å…¥æ ˆæ“ä½œï¼Œå•æµ‹å®Œå‡ºæ ˆæ‰§è¡Œã€‚&lt;/p&gt;
&lt;p&gt;å¦‚æœæµ‹è¯•æ–‡ä»¶éƒ½ä¾èµ–äºåˆå§‹åŒ–ä¹‹åæ‰å¼€å§‹æµ‹è¯•çš„è¯ï¼Œ å¯ä»¥æ”¾åœ¨å…¨éƒ¨æµ‹è¯•å¼€å§‹ä¹‹å‰çš„ä½ç½®è¿›è¡Œæµ‹è¯•çš„setupï¼›åœ¨å…¨éƒ¨æµ‹è¯•ç»“æŸåå¯¹åˆå§‹åŒ–çš„èµ„æºè¿›è¡Œé‡Šæ”¾teardownï¼› å¯ä»¥é€šè¿‡åœ¨TestMainä¸­å®šä¹‰æ•´ä½“é€»è¾‘å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;TestMain&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;m&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;testing&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;M&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
	&lt;span class=&#34;nf&#34;&gt;setupHelper&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
	&lt;span class=&#34;nx&#34;&gt;code&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;m&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Run&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt; &lt;span class=&#34;c1&#34;&gt;// run all test func
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;	&lt;span class=&#34;nf&#34;&gt;teardownHelper&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt; 
	&lt;span class=&#34;nx&#34;&gt;os&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Exit&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;code&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;initHelper&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;t&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;testing&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
	&lt;span class=&#34;nx&#34;&gt;t&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Cleanup&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;println&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;})&lt;/span&gt;
	&lt;span class=&#34;nx&#34;&gt;t&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Cleanup&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;println&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;})&lt;/span&gt; &lt;span class=&#34;c1&#34;&gt;// first to cleanup
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;	&lt;span class=&#34;c1&#34;&gt;// init
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;	&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt; 
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;è¿™ç§æ–¹å¼åœ¨æµ‹è¯•å¼€å‘æ¡†æ¶åŒ…ä¸­ç»å¸¸ä½¿ç”¨åˆ°ï¼Œæ¯”å¦‚ginkgoä¸­çš„BeforeSuiteå’ŒAfterSuiteå‡½æ•°ï¼Œåœ¨æµ‹è¯•å‰åæ‰§è¡Œã€‚&lt;/p&gt;
&lt;h2 id=&#34;æ¦‚æ‹¬&#34;&gt;æ¦‚æ‹¬&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;ä½¿ç”¨æ„å»ºæ ‡å¿—ã€ç¯å¢ƒå˜é‡æˆ– -shortæ¨¡å¼å¯¹æµ‹è¯•è¿›è¡Œåˆ†ç±»å¯ä»¥ä½¿æµ‹è¯•è¿‡ç¨‹æ›´åŠ é«˜æ•ˆã€‚å¯ä»¥ä½¿ç”¨æ„å»ºæ ‡å¿—æˆ–ç¯å¢ƒå˜é‡ï¼ˆä¾‹å¦‚ï¼Œå•å…ƒæµ‹è¯•ä¸é›†æˆæµ‹è¯•ï¼‰åˆ›å»ºæµ‹è¯•ç±»åˆ«ï¼Œå¹¶åŒºåˆ†çŸ­æœŸè¿è¡Œæµ‹è¯•å’Œé•¿æœŸè¿è¡Œæµ‹è¯•ä»¥ç¡®å®šè¦æ‰§è¡Œçš„æµ‹è¯•ç±»å‹ã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;race&lt;/code&gt;å¼ºçƒˆå»ºè®®åœ¨ç¼–å†™å¹¶å‘åº”ç”¨ç¨‹åºæ—¶å¯ç”¨è¯¥æ ‡å¿—ã€‚è¿™æ ·åšå¯ä»¥æ•æ‰åˆ°å¯èƒ½å¯¼è‡´è½¯ä»¶é”™è¯¯çš„æ½œåœ¨æ•°æ®ç«äº‰ï¼›å¼€å¯raceæ£€æµ‹ä¼šæ¶ˆè€—å†…å­˜ï¼Œä¸€èˆ¬åœ¨å¼€å‘æµ‹è¯•ï¼ŒCI, é‡‘ä¸é›€å‘å¸ƒ(é¢„å‘ç¯å¢ƒ)çš„æ—¶å€™ä½¿ç”¨ã€‚&lt;/li&gt;
&lt;li&gt;ä½¿ç”¨&lt;code&gt;parallel&lt;/code&gt;æ ‡å¿—æ˜¯åŠ é€Ÿæµ‹è¯•çš„æœ‰æ•ˆæ–¹æ³•ï¼Œå°¤å…¶æ˜¯é•¿æ—¶é—´è¿è¡Œçš„æµ‹è¯•ã€‚&lt;/li&gt;
&lt;li&gt;ä½¿ç”¨&lt;code&gt;shuffle&lt;/code&gt;æ ‡å¿—å¸®åŠ©ç¡®ä¿æµ‹è¯•å¥—ä»¶ä¸ä¾èµ–äºå¯èƒ½éšè—é”™è¯¯çš„é”™è¯¯å‡è®¾ã€‚&lt;/li&gt;
&lt;li&gt;è¡¨é©±åŠ¨æµ‹è¯•æ˜¯å°†ä¸€ç»„ç±»ä¼¼æµ‹è¯•åˆ†ç»„ä»¥é˜²æ­¢ä»£ç é‡å¤å¹¶ä½¿æœªæ¥æ›´æ–°æ›´æ˜“äºå¤„ç†çš„æœ‰æ•ˆæ–¹æ³•ã€‚&lt;/li&gt;
&lt;li&gt;é¿å…time.Sleepä½¿ç”¨åŒæ­¥æ¥ä½¿æµ‹è¯•æ›´ç¨³å®šã€æ›´å¥å£®ã€‚ä½¿ç”¨channelæ¥è¿›è¡ŒåŒæ­¥ï¼Œå¦‚æœæ— æ³•åŒæ­¥ï¼Œè¯·è€ƒè™‘é‡è¯•æ–¹æ³•ã€‚&lt;/li&gt;
&lt;li&gt;äº†è§£å¦‚ä½•ä½¿ç”¨æ—¶é—´ API å¤„ç†å‡½æ•°æ˜¯ä½¿æµ‹è¯•ä¸é‚£ä¹ˆä¸ç¨³å®šçš„å¦ä¸€ç§æ–¹æ³•ã€‚å¯ä»¥ä½¿ç”¨æ ‡å‡†æŠ€æœ¯ï¼Œä¾‹å¦‚å°†æ—¶é—´ä½œä¸ºéšè—ä¾èµ–é¡¹çš„ä¸€éƒ¨åˆ†å¤„ç†æˆ–è¦æ±‚å®¢æˆ·æä¾›æ—¶é—´ã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;httptest&lt;/code&gt;åŒ…æœ‰åŠ©äºå¤„ç† HTTP åº”ç”¨ç¨‹åºã€‚å®ƒæä¾›äº†ä¸€ç»„å®ç”¨ç¨‹åºæ¥æµ‹è¯•å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;iotest&lt;/code&gt;åŒ…æœ‰åŠ©äºç¼–å†™&lt;code&gt;io.Reader&lt;/code&gt;å’Œæµ‹è¯•åº”ç”¨ç¨‹åºæ˜¯å¦å®¹é”™ã€‚&lt;/li&gt;
&lt;li&gt;å…³äºåŸºå‡†ï¼š
&lt;ul&gt;
&lt;li&gt;ä½¿ç”¨æ—¶é—´æ–¹æ³•æ¥ä¿æŒåŸºå‡†çš„å‡†ç¡®æ€§ã€‚&lt;/li&gt;
&lt;li&gt;åœ¨å¤„ç†å¾®åŸºå‡†æ—¶ï¼Œå¢åŠ &lt;code&gt;benchtime&lt;/code&gt;æˆ–ä½¿ç”¨è¯¸å¦‚&lt;code&gt;benchstat&lt;/code&gt;æ­¤ç±»çš„å·¥å…·ä¼šæœ‰æ‰€å¸®åŠ©ã€‚&lt;/li&gt;
&lt;li&gt;å¦‚æœæœ€ç»ˆè¿è¡Œåº”ç”¨ç¨‹åºçš„ç³»ç»Ÿä¸è¿è¡Œå¾®åŸºå‡†æµ‹è¯•çš„ç³»ç»Ÿä¸åŒï¼Œè¯·æ³¨æ„å¾®åŸºå‡†æµ‹è¯•çš„ç»“æœã€‚&lt;/li&gt;
&lt;li&gt;ç¡®ä¿è¢«æµ‹å‡½æ•°ä¼šäº§ç”Ÿå‰¯ä½œç”¨ï¼Œä»¥é˜²æ­¢ç¼–è¯‘å™¨ä¼˜åŒ–å¯¼è‡´åŸºå‡†æµ‹è¯•ç»“æœä¸Šæœ‰è¯¯å·®ã€‚&lt;/li&gt;
&lt;li&gt;ä¸ºé˜²æ­¢è§‚å¯Ÿè€…æ•ˆåº”ï¼Œå¼ºåˆ¶åŸºå‡†é‡æ–°åˆ›å»º CPU-Boundå‡½æ•°ä½¿ç”¨çš„æ•°æ®ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;ä½¿ç”¨å¸¦æ ‡å¿—çš„ä»£ç è¦†ç›–ç‡&lt;code&gt;coverprofile&lt;/code&gt;å¯ä»¥å¿«é€ŸæŸ¥çœ‹ä»£ç çš„å“ªä¸€éƒ¨åˆ†éœ€è¦æ›´å¤šå…³æ³¨ã€‚&lt;/li&gt;
&lt;li&gt;å°†å•å…ƒæµ‹è¯•æ”¾åœ¨ä¸åŒçš„åŒ…ä¸­ï¼Œä»¥å¼ºåˆ¶ç¼–å†™ä¸“æ³¨äºæš´éœ²è¡Œä¸ºè€Œéå†…éƒ¨çš„æµ‹è¯•ã€‚&lt;/li&gt;
&lt;li&gt;ä½¿ç”¨&lt;code&gt;testing.T&lt;/code&gt;å˜é‡è€Œä¸æ˜¯ç»å…¸å˜é‡æ¥å¤„ç†é”™è¯¯&lt;code&gt;if err != nil&lt;/code&gt;ä½¿ä»£ç æ›´çŸ­ä¸”æ›´æ˜“äºé˜…è¯»ã€‚&lt;/li&gt;
&lt;li&gt;å¯ä»¥ä½¿ç”¨è®¾ç½®å®‰è£…å’Œæ‹†å¸åŠŸèƒ½æ¥é…ç½®å¤æ‚çš„ç¯å¢ƒï¼Œä¾‹å¦‚åœ¨é›†æˆæµ‹è¯•çš„æƒ…å†µä¸‹ã€‚&lt;/li&gt;
&lt;/ul&gt;</description>
      
    </item>
    
    <item>
      <title>Go tips-ç¬”è®°: æ ‡å‡†åº“ 75-81 mistakes</title>
      <link>https://weedge.github.io/post/notions/go-tips/go-tips-10-standard-lib/</link>
      <pubDate>Sun, 19 Feb 2023 14:26:23 +0800</pubDate>
      
      <guid>https://weedge.github.io/post/notions/go-tips/go-tips-10-standard-lib/</guid>
      
        <description>&lt;h2 id=&#34;å¼•è¨€&#34;&gt;å¼•è¨€&lt;/h2&gt;
&lt;p&gt;ä»ç¨‹åºä¸­äº§ç”Ÿçš„é”™è¯¯ä¸­å¤§å¤šæ˜¯ä½¿ç”¨å§¿åŠ¿çš„ä¸å¯¹ï¼Œä»¥åŠæ²¡æœ‰ä»”ç»†é˜…è¯»æ ‡å‡†åº“ç›¸å…³åŒ…çš„å¼€å‘æ–‡æ¡£ï¼ŒæœªæŸ¥çœ‹æºç å¯¼è‡´ï¼Œä½†æ˜¯æ²¡æœ‰å®è·µè¿‡è¿™äº›é—®é¢˜ï¼Œå³ä½¿ç†Ÿè¯»æ–‡æ¡£å’Œæºç ä¹Ÿå¯èƒ½é¿å…ä¸äº†ã€‚ç¬”è®°ä¸­ä¼šä»¥ä¹¦ä¸­çš„mistakeä¸ºåˆ‡å…¥ç‚¹ï¼Œç»“åˆæºç å‡å…¥åˆ†æå…¶èƒŒåäº§ç”Ÿçš„åŸå› ï¼Œä»¥åŠæå‡ºè§£å†³æ–¹æ¡ˆæ¥é¿å…ã€‚&lt;/p&gt;
&lt;h2 id=&#34;ç¬”è®°&#34;&gt;ç¬”è®°&lt;/h2&gt;
&lt;h3 id=&#34;75æä¾›é”™è¯¯çš„æŒç»­æ—¶é—´&#34;&gt;75.æä¾›é”™è¯¯çš„æŒç»­æ—¶é—´&lt;/h3&gt;
&lt;p&gt;è®°ä½ä½¿ç”¨&lt;code&gt;time.Duration&lt;/code&gt;API å’Œæä¾›&lt;code&gt;int64&lt;/code&gt;ä¸€ä¸ªæ—¶é—´å•ä½, é»˜è®¤æœ€å°æ—¶é—´å•ä½æ˜¯å¾®å¦™&lt;/p&gt;
&lt;h3 id=&#34;76timeafter-å’Œå†…å­˜æ³„æ¼-é‡è¦&#34;&gt;76.time.After å’Œå†…å­˜æ³„æ¼ ï¼ˆé‡è¦ï¼‰&lt;/h3&gt;
&lt;p&gt;å¸¸è§é—®é¢˜ä¹‹ä¸€ï¼Œå°†time.Afterå‡½æ•°è¿›è¡Œå¾ªç¯è°ƒç”¨ï¼Œå¯¼è‡´å†…å­˜æ³„éœ²ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;k&#34;&gt;for&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
		&lt;span class=&#34;k&#34;&gt;select&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
		&lt;span class=&#34;k&#34;&gt;case&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;event&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;lt;-&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;ch&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;
			&lt;span class=&#34;nf&#34;&gt;handle&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;event&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
		&lt;span class=&#34;k&#34;&gt;case&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;lt;-&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;time&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;After&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;time&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Hour&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;):&lt;/span&gt;
			&lt;span class=&#34;nx&#34;&gt;log&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Println&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;warning: no messages received&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
		&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
	&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;é€šè¿‡time.Afteræºç å¯ä»¥çœ‹å‡ºï¼Œæ¯æ¬¡ä¼šé€šè¿‡time.NewTimeræ–°å»ºä¸€ä¸ªtimer, ä½†æ˜¯time.Afterè¿”å›çš„æ˜¯ä¸€ä¸ªC â† chan Time åªè¯»channelï¼Œä¸èƒ½é‡Šæ”¾æ‰æ¯æ¬¡æ–°å»ºçš„timer, å¯ä»¥ä½¿ç”¨Stopï¼Œå¦‚æœä¸€ç›´å¾ªç¯ä½¿ç”¨ï¼ŒGo 1.15 ä¸­ï¼Œæ¯æ¬¡è°ƒç”¨ä½¿ç”¨å¤§çº¦ 200 å­—èŠ‚çš„å†…å­˜ï¼Œå¦‚æœè®¾ç½®çš„æ—¶é—´é—´éš”å°ï¼Œæ¯”å¦‚æ¯å°æ—¶500wæ¡ï¼Œåˆ™åœ¨ä¸€å°æ—¶æ¶ˆè€—1Gå·¦å³çš„å†…å­˜ç©ºé—´ã€‚&lt;/p&gt;
&lt;p&gt;é‚£å¦‚æœç›´æ¥ä½¿ç”¨time.NewTimeræ¥å¤„ç†ï¼Œéœ€è¦å¤„ç†å¥½Stopå’ŒResetçš„æƒ…å†µï¼š&lt;/p&gt;
&lt;p&gt;ä¸€ç§æ–¹å¼æ˜¯ç›´æ¥æ¯æ¬¡å¾ªç¯ä¸­NewTimer, ç„¶åä½¿ç”¨Stopæ–¹æ³•ä»æœ€å°å †timeræ•°ç»„ä¸­åˆ é™¤åº•å±‚çš„è¿è¡Œæ—¶timer(å¦‚æœtimer æ²¡æœ‰expire åˆ°æœŸ ä»¥åŠæœ‰å¤ç”¨timer reuse active timer)ï¼Œè¿™æ ·å¯ä»¥é˜²æ­¢å†…å­˜æ³„éœ²ï¼Œä½†æ˜¯è¿™äº›timerç»“æ„å¯¹è±¡éœ€è¦GCæ¥æ ‡è®°æ‰«æé‡Šæ”¾ï¼Œå¸¦æ¥äº†é¢å¤–çš„GCå‹åŠ›ä»¥åŠæœ€å°å †timerç®¡ç†å‹åŠ›ï¼›è¿™é‡Œéœ€è¦æ³¨æ„Stopæ–¹æ³•çš„ä½¿ç”¨ï¼ŒæŒ‰ç…§ &lt;a href=&#34;https://golang.org/pkg/time/#Timer.Stop&#34;&gt;Timer.Stop æ–‡æ¡£&lt;/a&gt; çš„ä½¿ç”¨è¯´æ˜ï¼Œæ¯æ¬¡è°ƒç”¨ Stop åéœ€è¦åˆ¤æ–­è¿”å›å€¼ï¼Œå¦‚æœè¿”å› falseï¼ˆè¡¨ç¤º Stop å¤±è´¥ï¼ŒTimer å·²ç»åœ¨ Stop å‰åˆ°æœŸï¼‰åˆ™éœ€è¦æ’æ‰ï¼ˆdrainï¼‰ä¸€æ¬¡ channel ä¸­çš„Timeæ•°æ®(C æ˜¯é•¿åº¦ä¸º1çš„ç¼“å†²channel)ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;!&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;t&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Stop&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
	&lt;span class=&#34;o&#34;&gt;&amp;lt;-&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;t&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;C&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;ä½†æ˜¯å¦‚æœä¹‹å‰ç¨‹åºå·²ç»ä» channel ä¸­æ¥æ”¶è¿‡äº‹ä»¶ï¼Œé‚£ä¹ˆä¸Šè¿° &lt;code&gt;&amp;lt;-t.C&lt;/code&gt; å°±ä¼šå‘ç”Ÿé˜»å¡ã€‚å¯èƒ½çš„è§£å†³åŠæ³•æ˜¯å€ŸåŠ© select è¿›è¡Œ &lt;strong&gt;éé˜»å¡&lt;/strong&gt; æ’æ”¾ï¼ˆdrainingï¼‰ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;!&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;t&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Stop&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
	&lt;span class=&#34;k&#34;&gt;select&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
	&lt;span class=&#34;k&#34;&gt;case&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;lt;-&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;t&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;C&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;c1&#34;&gt;// try to drain the channel
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;	&lt;span class=&#34;k&#34;&gt;default&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;
	&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;ä½†æ˜¯å› ä¸º channel çš„å‘é€å’Œæ¥æ”¶å‘ç”Ÿåœ¨ä¸åŒçš„ goroutineï¼Œæ‰€ä»¥ &lt;a href=&#34;https://github.com/golang/go/issues/14383&#34;&gt;å­˜åœ¨ç«äº‰æ¡ä»¶&lt;/a&gt;ï¼ˆrace conditionï¼‰ï¼Œæœ€ç»ˆå¯èƒ½å¯¼è‡´ channel ä¸­çš„äº‹ä»¶æœªè¢«æ’æ‰ã€‚å› ä¸ºsendTimer å’Œ æ“ä½œStopå‡½æ•°æ˜¯åœ¨ä¸¤ä¸ªgoroutineä¸­æ‰§è¡Œï¼Œå½“timeråˆšå¥½åˆ°æœŸï¼Œå·²ä»æœ€å°å †ä¸­åˆ é™¤ï¼Œæ“ä½œStopå‡½æ•°è¿”å›false,  åœ¨æ‰§è¡Œ â†t.C æ¥å—æ“ä½œå’Œ sendTime å‘é€æ“ä½œ åˆ†åˆ«åœ¨ä¸¤ä¸ªgoroutineä¸­æ‰§è¡Œç›¸äº’ä¹‹é—´æ‰§è¡Œæ˜¯æ— åºçš„ï¼Œå¯èƒ½ä¼šå‘ç”Ÿå…ˆä»t.Cæ¥å—æ•°æ®ï¼Œæ²¡æœ‰ï¼Œç”±äºæ˜¯éé˜»å¡ç»§ç»­æ‰§è¡Œï¼Œè¿™ä¸ªæ—¶å€™sendTimeå‘é€ä¸€æ¡Timeæ•°æ®åˆ°Cä¸­ï¼Œåé¢æ‰§è¡ŒResetè™½ç„¶é‡ç½®ä¸€ä¸ªTimer, ä½†æ˜¯åœ¨select + case â†timer.Cæ—¶ï¼ŒCä¸­æœ‰æ•°æ®é€‰ä¸­ç›´æ¥æ‰§è¡Œäº†ï¼Œå’Œé€šè¿‡Reseté‡ç½®çš„ä¸€ä¸ªTimeré—´éš”æ—¶é—´æ‰§è¡Œçš„é¢„æœŸæœŸæœ›ä¸åŒï¼Œè¿™æ ·å­˜åœ¨race conditionï¼Œä½†æ˜¯è¿™ç§æƒ…å†µå‡ºç°æœºç‡æ¯”è¾ƒä½ï¼Œå¯å‚è€ƒ &lt;a href=&#34;https://github.com/golang/go/issues/11513#issuecomment-157062583&#34;&gt;Russ Cox çš„å›å¤&lt;/a&gt; ï¼Œç›®å‰ Timer å¯èƒ½åˆç†çš„ä½¿ç”¨æ–¹å¼æ˜¯ï¼šç¨‹åºéœ€è¦ç»´æŠ¤ä¸€ä¸ªçŠ¶æ€å˜é‡(åœ¨åŒä¸€ä¸ªgoroutineä¸­)ï¼Œç”¨äºè®°å½•å®ƒæ˜¯å¦å·²ç»ä» channel ä¸­æ¥æ”¶è¿‡äº‹ä»¶ï¼Œè¿›è€Œä½œä¸º Stop ä¸­ draining æ“ä½œçš„åˆ¤æ–­ä¾æ®ã€‚å¯ä»¥è®¢é˜…&lt;a href=&#34;https://groups.google.com/g/golang-dev/c/c9UUfASVPoU&#34;&gt;golang-dev&lt;/a&gt;ç»„æŸ¥çœ‹ç›¸å…³è¿›å±•ã€‚&lt;/p&gt;
&lt;p&gt;å¦å¤–ä¸€ç§æ–¹å¼æ˜¯æŠŠ NewTimer æ”¾åœ¨å¾ªç¯å¤–ï¼Œåœ¨forå¾ªç¯ä¸­é€šè¿‡Resetå‡½æ•°æ¥å¤ç”¨åŸæœ‰Timerç»“æ„ï¼ŒæŒ‰ç…§ &lt;a href=&#34;https://golang.org/pkg/time/#Timer.Reset&#34;&gt;Timer.Reset æ–‡æ¡£&lt;/a&gt; çš„ä½¿ç”¨è¯´æ˜ï¼Œè¦æ­£ç¡®åœ° Reset Timerï¼Œé¦–å…ˆéœ€è¦æ­£ç¡®åœ° Stop Timerï¼›å› æ­¤ Reset çš„é—®é¢˜è·Ÿ Stop åŸºæœ¬ç›¸åŒã€‚&lt;/p&gt;
&lt;p&gt;tipsï¼š å…·ä½“è¯¦æƒ…è§æºç å®¢è§‚åˆ†æï¼š&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/golang/go/blob/go1.20/src/time/sleep.go&#34;&gt;go1.20/src/time/sleep.go&lt;/a&gt; (timeæ ‡å‡†ä¸­æä¾›ä½¿ç”¨çš„Timer)&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/golang/go/blob/go1.20/src/runtime/time.go&#34;&gt;go1.20/src/runtime/time.go&lt;/a&gt; (è¿è¡Œæ—¶çš„timer)&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/golang/go/blob/go1.20/src/runtime/runtime2.go&#34;&gt;go1.20/src/runtime/runtime2.go&lt;/a&gt; , &lt;a href=&#34;https://github.com/golang/go/blob/go1.20/src/runtime/proc.go&#34;&gt;go1.20/src/runtime/proc.go&lt;/a&gt;(pç»“æ„ä¸Šæœ€å°å››å‰å † timeræ•°ç»„, ä»¥åŠè¿è¡Œæ—¶ç›¸å…³timerçš„è°ƒåº¦ï¼›è°ƒç”¨æµç¨‹ï¼šfindRunnable/stealWork â†’ checkTimers â†’ runtimer â†’ runOneTimer â†’ f (sendTime or goFunc) , lock freeçš„æ–¹å¼è°ƒç”¨f, CASåŸå­æ“ä½œtimerçš„çŠ¶æ€)&lt;/p&gt;
&lt;p&gt;æ¯æ¬¡æ–°ç”ŸæˆTimerçš„æ—¶å€™ï¼Œä¼šå¾€pä¸Šçš„æœ€å°å †ä¸Šæ·»åŠ timer(O(logN))ï¼Œå°†ç­‰å¾…å¯è¯»äº‹ä»¶æ”¾å…¥netpollå¼‚æ­¥äº‹ä»¶ä¸­ç›‘å¬ï¼Œnetpollæ˜¯åœ¨ç¨‹åºå¯åŠ¨æ—¶åˆå§‹åŒ–ç»‘å®šä¸€ä¸ªå•ç‹¬çš„Mè¿›è¡Œäº‹ä»¶è½®è®­ï¼›Go1.14ä¹‹å‰ä½¿ç”¨timerprocå‡½æ•°ä¼šè°ƒç”¨ä¸€äº›ç³»ç»Ÿè°ƒç”¨æ¥æ¥è®© goroutine è¿›å…¥ç¡çœ çŠ¶æ€å¹¶å”¤é†’ goroutineï¼Œç³»ç»Ÿè°ƒç”¨æ„å‘³ç€å®ƒä¸ºæ­¤ç”ŸæˆOSçº¿ç¨‹ï¼Œå¦‚æœåˆ›å»ºtimeræ¯”è¾ƒå¤šï¼Œé‚£å°±ä¼šå‘ç”Ÿæ¯”è¾ƒå¤šçš„ç³»ç»Ÿè°ƒç”¨ï¼Œå¤§å¤§é™ä½æ€§èƒ½ï¼›ä¹‹åæ”¹æˆå¼‚æ­¥äº‹ä»¶è½®è®­æœºåˆ¶netpollçš„æ–¹å¼å¤šè·¯å¤ç”¨ï¼Œåªéœ€è¦ä¸€ä¸ªOSçº¿ç¨‹æ¥ç›‘å¬äº‹ä»¶å³å¯ï¼›ç³»ç»Ÿè°ƒç”¨å› ç³»ç»Ÿå¹³å°è€Œå¼‚ï¼Œé€šè¿‡runtime.nanotime1å‡½æ•°è¿›è¡Œäº†å°è£…ï¼›&lt;/p&gt;
&lt;p&gt;å¦‚æœæ—¶é—´åˆ°äº†ï¼Œå°†æœ€å°å †é¡¶timeråˆ é™¤(O(logN))ï¼Œé€šè¿‡netpoll å¼‚æ­¥äº‹ä»¶æœºåˆ¶ å°† å¯æ‰§è¡Œçš„Gè°ƒåº¦åˆ°runnextä¸­ï¼Œç„¶åç»‘å®šMè¿è¡Œfï¼›&lt;/p&gt;
&lt;h3 id=&#34;77å¸¸è§çš„-json-å¤„ç†é”™è¯¯-é‡è¦&#34;&gt;77.å¸¸è§çš„ JSON å¤„ç†é”™è¯¯ (é‡è¦)&lt;/h3&gt;
&lt;h4 id=&#34;case1-ç±»å‹åµŒå…¥å¯¼è‡´çš„æ„å¤–è¡Œä¸º&#34;&gt;case1 ç±»å‹åµŒå…¥å¯¼è‡´çš„æ„å¤–è¡Œä¸º&lt;/h4&gt;
&lt;p&gt;éœ€è¦äº†è§£json.Marshal æ–¹æ³•ï¼Œåœ¨å¯¹ç»“æ„ç±»å‹å¯¹è±¡è¿›è¡ŒMarshalæ“ä½œæ—¶ï¼Œå¦‚æœå®ç°äº†json.Marshaleræ¥å£æ–¹æ³•MarshalJSONï¼Œ åˆ™ä¼šè°ƒç”¨å¯¹åº”MarshalJSONæ–¹æ³•è¿›è¡Œencodeæ“ä½œï¼Œå¯ä»¥çœ‹å…·ä½“æºç ï¼š &lt;a href=&#34;https://github.com/golang/go/blob/go1.20/src/runtime/proc.go&#34;&gt;go1.20/src/encoding/json/encode.go&lt;/a&gt; ï¼ˆè°ƒç”¨æµç¨‹ï¼šMarshalâ†’ marshal â†’ reflectValue â†’ valueEncoder â†’ typeEncoder â†’ newTypeEncoder â†’ marshalerEncoder â†’ MarshalJSON)  ; æ‰€ä»¥åœ¨json.Marshalæ“ä½œçš„æ—¶å€™éœ€è¦æ³¨æ„ç»“æ„ä½“çš„åµŒå…¥æˆå‘˜æ˜¯å¦å®ç°äº†json.Marshaleræ¥å£æ–¹æ³•MarshalJSONï¼Œ æ¯”å¦‚ï¼š time.Time å®ç°äº†MarshalJSONè¿™ä¸ªæ–¹æ³•ï¼› å¦‚æœä¸æƒ³ç›´æ¥ä½¿ç”¨ç»„åˆåµŒå…¥æˆå‘˜çš„æ–¹æ³•ï¼Œåˆ™å°†å…¶å®šä¹‰ä¸ºå¯¹åº”ç±»å‹æˆå‘˜ï¼Œæˆ–è€…å®ç°MarshalJSONæ–¹æ³•è¦†ç›–åµŒå…¥æˆå‘˜çš„å®ç°ï¼›&lt;/p&gt;
&lt;p&gt;tips: å¯¹ç»“æ„ç±»å‹å¯¹è±¡è¿›è¡ŒUnMarshalæ“ä½œä¹Ÿæ˜¯åŒæ ·æƒ…å†µã€‚&lt;/p&gt;
&lt;h4 id=&#34;case2-json-å’Œå•è°ƒæ—¶é’Ÿ&#34;&gt;case2 JSON å’Œå•è°ƒæ—¶é’Ÿ&lt;/h4&gt;
&lt;p&gt;å¯¹åŒ…å«ä¸€ä¸ªtime.Timeç±»å‹çš„ç»“æ„encodeæˆ–decodeï¼Œæœ‰æ—¶ä¼šé‡åˆ°æ„æƒ³ä¸åˆ°çš„æ¯”è¾ƒé”™è¯¯ã€‚&lt;/p&gt;
&lt;p&gt;é¦–å…ˆéœ€è¦å¼„æ¸…æ¥šæ“ä½œç³»ç»Ÿå¤„ç†ä¸¤ç§ä¸åŒçš„æ—¶é’Ÿç±»å‹ï¼šwall clock(æŒ‚é’Ÿ)å’Œ monotonic clock(å•è°ƒæ—¶é’Ÿ)ã€‚æŒ‚é’Ÿç”¨äºç¡®å®šä¸€å¤©ä¸­çš„å½“å‰æ—¶é—´ã€‚æ­¤æ—¶é’Ÿå¯èƒ½ä¼šæœ‰æ‰€å˜åŒ–ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæ—¶é’Ÿä½¿ç”¨åŒæ­¥ç½‘ç»œæ—¶é—´åè®® (NTP)ï¼Œå®ƒå¯ä»¥åŠæ—¶å‘åæˆ–å‘å‰è·³è½¬ã€‚ä¸åº”è¯¥ä½¿ç”¨æŒ‚é’Ÿæµ‹é‡æŒç»­æ—¶é—´ï¼Œå› ä¸ºå¯èƒ½ä¼šé‡åˆ°å¥‡æ€ªçš„è¡Œä¸ºï¼Œä¾‹å¦‚è´ŸæŒç»­æ—¶é—´(æ¶¦ç§’é‡ç½®çš„æƒ…å†µ)ã€‚è¿™å°±æ˜¯æ“ä½œç³»ç»Ÿæä¾›ç¬¬äºŒç§æ—¶é’Ÿç±»å‹çš„åŸå› ï¼šå•è°ƒæ—¶é’Ÿã€‚å•è°ƒæ—¶é’Ÿä¿è¯æ—¶é—´æ€»æ˜¯å‘å‰ç§»åŠ¨å¹¶ä¸”ä¸å—æ—¶é—´è·³è·ƒçš„å½±å“ã€‚å®ƒå¯èƒ½ä¼šå—åˆ°é¢‘ç‡è°ƒæ•´çš„å½±å“ï¼ˆä¾‹å¦‚ï¼Œå¦‚æœæœåŠ¡å™¨æ£€æµ‹åˆ°æœ¬åœ°çŸ³è‹±é’Ÿçš„ç§»åŠ¨é€Ÿåº¦ä¸ NTP æœåŠ¡å™¨ä¸åŒï¼‰ï¼Œä½†ä¸ä¼šå—åˆ°æ—¶é—´è·³è·ƒçš„å½±å“ã€‚&lt;/p&gt;
&lt;p&gt;ä»¥å‰Go TimeåŒ…çš„ç›¸å…³æ—¶é—´è¯»å–å‡½æ•°å®ç°ä»…è¯»å–ç³»ç»ŸæŒ‚é’Ÿï¼Œä»ä¸è¯»å–å•è°ƒæ—¶é’Ÿï¼Œä»è€Œåœ¨æ—¶é’Ÿé‡ç½®æ—¶å¯¼è‡´æµ‹é‡ä¸æ­£ç¡®ã€‚æ¯”å¦‚ ä¸€ä¸ª Go ç¨‹åºåœ¨é—°ç§’æœŸé—´æµ‹é‡è´Ÿçš„ç»è¿‡æ—¶é—´å¯¼è‡´&lt;a href=&#34;https://blog.cloudflare.com/how-and-why-the-leap-second-affected-cloudflare-dns/&#34;&gt;CloudFlare æœ€è¿‘çš„ DNS ä¸­æ–­&lt;/a&gt;. ç»´åŸºç™¾ç§‘&lt;a href=&#34;https://en.wikipedia.org/wiki/Leap_second#Examples_of_problems_associated_with_the_leap_second&#34;&gt;ä¸é—°ç§’ç›¸å…³çš„é—®é¢˜ç¤ºä¾‹åˆ—è¡¨&lt;/a&gt;ç°åœ¨åŒ…æ‹¬ CloudFlare çš„ä¸­æ–­ï¼Œå¹¶å°† Go çš„æ—¶é—´ API åˆ—ä¸ºæ ¹æœ¬åŸå› ã€‚é™¤äº†é—°ç§’é—®é¢˜ä¹‹å¤–ï¼ŒGo è¿˜æ‰©å±•åˆ°éç”Ÿäº§ç¯å¢ƒä¸­çš„ç³»ç»Ÿï¼Œè¿™äº›ç¯å¢ƒä¸­çš„æ—¶é’Ÿå¯èƒ½ä¸å¤ªå¥½è°ƒèŠ‚ï¼Œå› æ­¤æ—¶é’Ÿé‡ç½®æ›´é¢‘ç¹ã€‚Go å¿…é¡»ä¼˜é›…åœ°å¤„ç†æ—¶é’Ÿé‡ç½®ã€‚Goè¯­è¨€ä½œè€…Russ Coxæå‡ºäº†ææ¡ˆè®¾è®¡**&lt;a href=&#34;https://github.com/golang/proposal/blob/master/design/12914-monotonic.md&#34;&gt;Proposal: Monotonic Elapsed Time Measurements in Go&lt;/a&gt;**  (golangçš„å¼€å‘è§„èŒƒå’Œææ¡ˆè®¾è®¡æ–‡æ¡£å€¼å¾—å€Ÿé‰´å­¦ä¹ çš„ï¼ŒèƒŒæ™¯åŸå› ï¼ŒéªŒè¯è¯„ä¼°å½±å“é¢ï¼Œå°½é‡å‘å‰å…¼å®¹ï¼Œææ¡ˆé€šè¿‡ï¼Œå†å®‰æ’å¼€å‘è®¡åˆ’)ï¼› å°†monotonic clock å•è°ƒæ—¶é’Ÿå¼•å…¥time.Timeç»“æ„ä½“ä¸­ï¼Œå…·ä½“CR: &lt;a href=&#34;https://go-review.googlesource.com/c/go/+/36255&#34;&gt;https://go-review.googlesource.com/c/go/+/36255&lt;/a&gt; ï¼Œ HNä¹Ÿæœ‰å¯¹åº”è®¨è®ºï¼š &lt;a href=&#34;https://news.ycombinator.com/item?id=13566110&#34;&gt;https://news.ycombinator.com/item?id=13566110&lt;/a&gt; ;&lt;/p&gt;
&lt;p&gt;tipsï¼š æµ‹é‡æŒç»­æ—¶é—´ï¼Œä½¿ç”¨å•è°ƒæ—¶é’Ÿï¼›ä»…å¯¹&lt;strong&gt;æœ¬åœ°æŒç»­æ—¶é—´æµ‹é‡&lt;/strong&gt;æœ‰æ•ˆï¼›ä¸¤ä¸ªä¸åŒæœåŠ¡å™¨çš„å•è°ƒæ—¶é’Ÿæ ¹æ®å®šä¹‰æ˜¯ä¸åŒæ­¥çš„ã€‚å› æ­¤ï¼ŒåŸºäºè¿™äº›æ—¶é’Ÿæµ‹é‡åˆ†å¸ƒå¼æ‰§è¡Œå°†ä¸å‡†ç¡®ï¼›è¿™å°±æ¶‰åŠåˆ°åˆ†å¸ƒå¼æ—¶é’ŸåŒæ­¥çš„é—®é¢˜äº†ã€‚&lt;/p&gt;
&lt;p&gt;okäº†è§£äº†èƒŒæ™¯ï¼Œå›å½’æ­£é¢˜ï¼Œæ¯”å¦‚å¯¹ä¸€ä¸ªç»“æ„ä½“æœ‰time.Timeç±»å‹æˆå‘˜ï¼Œtime.Timeå¯èƒ½åŒæ—¶åŒ…å«ä¸€ä¸ªæŒ‚é’Ÿå’Œä¸€ä¸ªå•è°ƒæ—¶é—´ï¼Œä½¿ç”¨time.Nowæ–¹æ³•è¿”å›çš„æ—¶é—´å°±åŒ…æ‹¬æŒ‚é’Ÿè¯»æ•°å’Œå•è°ƒæ—¶é’Ÿè¯»æ•°ï¼Œå…·ä½“è§timeåŒ…å¼€å‘æ–‡æ¡£ï¼šhttps://pkg.go.dev/time#section-documentation; ä»¥åŠæŸ¥çœ‹æºç å®¢è§‚åˆ†æï¼š&lt;a href=&#34;https://github.com/golang/go/blob/go1.20/src/time/time.go&#34;&gt;go1.20/src/time/time.go&lt;/a&gt; ï¼ˆNowâ†’time.nowâ†’runtime.now in assembly â†’ å¦‚æœå¯ä»¥ä½¿ç”¨vdso è°ƒç”¨ runtimeÂ·vdsoClockgettimeSym å‡å°‘ç³»ç»Ÿè°ƒç”¨æå‡æ€§èƒ½ï¼Œå¦åˆ™æ‰§è¡Œç³»ç»Ÿè°ƒç”¨SYSCALL SYS_clock_gettime(228) æŒ‡ä»¤ï¼Œè§ï¼š&lt;strong&gt;&lt;a href=&#34;https://github.com/torvalds/linux/blob/master/arch/x86/entry/syscalls/syscall_64.tbl&#34;&gt;linuxç³»ç»Ÿè°ƒç”¨æŒ‡ä»¤é›†&lt;/a&gt;&lt;/strong&gt;ï¼‰ã€‚time.Nowè¿”å›çš„Durationå€¼æ‰“å°å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;mi&#34;&gt;2023&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;mo&#34;&gt;02&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;19&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;15&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;37&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;mf&#34;&gt;08.218505&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0800&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;CST&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;m&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;mf&#34;&gt;0.000118444&lt;/span&gt;
&lt;span class=&#34;o&#34;&gt;------------------------------------&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;--------------&lt;/span&gt;
             &lt;span class=&#34;nx&#34;&gt;Wall&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;time&lt;/span&gt;               &lt;span class=&#34;nx&#34;&gt;Monotonic&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;time&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;åœ¨æ‰§è¡Œjson.UnMarshal è§£ç åŒ…æ¶µtime.Timeç±»å‹å…¬å¼€æˆå‘˜ç»“æ„ä½“è¿›è¡Œæ ¼å¼åŒ–è§£ææ—¶ï¼Œ ä¹Ÿä¼šè°ƒç”¨time.Timeçš„UnMarshalJSONå‡½æ•°ï¼Œæœ€ç»ˆä¼šè°ƒç”¨Time.stripMono, å»æ‰Monotonic timeï¼›å¯¼è‡´å‰åç»“æ„ä½“å¯¹è±¡ä¸ä¸€è‡´ï¼Œä¸€ä¸ªä»time.Nowä¸­è¿”å›æœ‰Monotonic timeï¼Œè§£æåçš„æ²¡æœ‰ï¼›é€šè¿‡Time.Truncateæ–¹æ³•ï¼Œå»æ‰Monotonic timeï¼Œå¯ä»¥è§£å†³ï¼›éœ€è¦æ³¨æ„å¸¦æœ‰time.Timeçš„ç»“æ„ä½“åœ¨encode/decodeæ—¶ï¼Œå‰åå¯¹è±¡ä¼šä¸ä¸€è‡´çš„æƒ…å†µï¼›&lt;/p&gt;
&lt;h4 id=&#34;case3-any-map&#34;&gt;case3 any map&lt;/h4&gt;
&lt;p&gt;anyæ˜¯ç©ºæ¥å£interface{}çš„åˆ«åï¼Œåœ¨å¯¹map[string]anyç±»å‹å¯¹è±¡è¿›è¡Œ json.UnMarshalæ—¶ï¼Œjsonå­—ç¬¦ä¸²ä¸­çš„æ•´æ•°ç±»å‹ä¼šè§£ææˆé»˜è®¤çš„float64ç±»å‹ï¼Œè¿™æ ·å¯èƒ½ä¼šå¯¼è‡´æ•°æ®åˆ¤æ–­æ—¶å‡ºç°é—®é¢˜ï¼Œå¯¹ç±»å‹è½¬æ¢åšå‡ºé”™è¯¯çš„å‡è®¾å¯èƒ½ä¼šå¯¼è‡´ goroutine panicã€‚&lt;/p&gt;
&lt;h3 id=&#34;78å¸¸è§çš„-sql-é”™è¯¯&#34;&gt;78.å¸¸è§çš„ SQL é”™è¯¯&lt;/h3&gt;
&lt;p&gt;è¯¥&lt;code&gt;database/sql&lt;/code&gt;åŒ…æä¾›SQLï¼ˆæˆ–ç±»ä¼¼ SQLï¼‰æ•°æ®åº“çš„æ ‡å‡†é€šç”¨æ¥å£ï¼›ä¾èµ–å…·ä½“æ•°æ®æ“ä½œï¼Œç”±ä¸‰æ–¹æ¥å®ç°ï¼›æ¥å£ä¸å®ç°åˆ†ç¦»çš„å¾ˆå¥½ä¾‹å­ï¼›&lt;/p&gt;
&lt;p&gt;tipsï¼šåœ¨è®¾è®¡é€šç”¨ä¸­å°å’Œå¹³å°é¡¹ç›®ä¸­çš„æ¨¡å—æ—¶ï¼Œç»å¸¸éœ€è¦å°†æŠ½è±¡ä¸å®ç°åˆ†ç¦»ï¼Œé©±åŠ¨åŒ–è®¾è®¡ï¼Œæ–¹ä¾¿å…·ä½“é¢†åŸŸåœºæ™¯çš„å®šåˆ¶åŒ–å¼€å‘ã€‚&lt;/p&gt;
&lt;p&gt;å…·ä½“æŸ¥çœ‹å¼€å‘æ–‡æ¡£ï¼šhttps://pkg.go.dev/database/sqlï¼›åœ¨ä½¿ç”¨è¿™ä¸ªåŒ…æ—¶çœ‹åˆ°ä¸€äº›æ¨¡å¼æˆ–é”™è¯¯ä¹Ÿå¾ˆå¸¸è§ï¼›æ·±å…¥ç ”ç©¶äº”ä¸ªå¸¸è§é”™è¯¯caseã€‚&lt;/p&gt;
&lt;h4 id=&#34;case1-å¿˜è®°-sqlopen-ä¸ä¸€å®šå»ºç«‹åˆ°æ•°æ®åº“çš„è¿æ¥-å·¥ç¨‹è§„èŒƒ&#34;&gt;case1 å¿˜è®° sql.Open ä¸ä¸€å®šå»ºç«‹åˆ°æ•°æ®åº“çš„è¿æ¥ (å·¥ç¨‹è§„èŒƒ)&lt;/h4&gt;
&lt;p&gt;Open å¯èƒ½åªæ˜¯éªŒè¯å…¶å‚æ•°è€Œä¸åˆ›å»ºä¸æ•°æ®åº“çš„è¿æ¥ã€‚è¦éªŒè¯æ•°æ®æºåç§°æ˜¯å¦æœ‰æ•ˆï¼Œè¯·è°ƒç”¨ Pingã€‚åœ¨ä½¿ç”¨çš„æ—¶å€™ï¼Œå’Œæ•°æ®åº“è¿›è¡Œäº¤äº’çš„æ—¶å€™æ‰å»ºç«‹è¿æ¥ã€‚æ¯”å¦‚go-redis &lt;a href=&#34;https://github.com/redis/go-redis/issues/2085&#34;&gt;issues-2085&lt;/a&gt; , è¿™ä¸ªissueæ˜¯å› ä¸ºä½¿ç”¨go-redis v8 ç‰ˆæœ¬ é€šè¿‡pingè¯·æ±‚è®¿é—® 7.0 redis redis-clusterï¼Œ v8ç‰ˆæœ¬è¿˜ä¸æ”¯æŒæ–°çš„åè®®è¿”å›çš„æ•°æ®å¯¼è‡´ï¼Œéœ€è¦å‡çº§ä½¿ç”¨go-redis v9ç‰ˆæœ¬æ¥æ”¯æŒï¼Œæ‰€ä»¥ä½¿ç”¨pingåŠŸèƒ½å³å¯ä»¥æµ‹è¯•ç”Ÿæˆæœ‰æ•ˆè¿æ¥ï¼Œè€Œä¸”å¯ä»¥éªŒè¯å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯åè®®çš„ä¸€è‡´æ€§ã€‚&lt;/p&gt;
&lt;h4 id=&#34;case2-å¿˜è®°ä½¿ç”¨è¿æ¥æ± -å·¥ç¨‹è§„èŒƒ&#34;&gt;case2 å¿˜è®°ä½¿ç”¨è¿æ¥æ±  (å·¥ç¨‹è§„èŒƒ)&lt;/h4&gt;
&lt;p&gt;åº”ä¸ºæ•°æ®åº“æ˜¯åº•å±‚å­˜å‚¨æ•°æ®èµ„æºï¼Œå¦‚æœä¸é™åˆ¶ä½¿ç”¨æœ‰é™çš„åº•å±‚æ•°æ®åº“è¿æ¥èµ„æºï¼Œä¼šå¢åŠ åº•å±‚æ•°æ®åº“æœåŠ¡çš„è´Ÿè½½ï¼›éœ€è¦è®¾ç½®è¿æ¥æ± ï¼Œè¿›è¡Œè¿æ¥å¤ç”¨ï¼Œä»¥åŠç»“åˆæ•°æ®åº“æœåŠ¡èƒ½åŠ›é™åˆ¶è®¾ç½®æœ€å¤§è¿æ¥æ•°ï¼Œå…·ä½“å‚æ•°ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;SetMaxOpenConns&lt;/code&gt;æœ€å¤§é™åº¦æ‰“å¼€çš„æ•°æ®åº“è¿æ¥æ•°ï¼ˆé»˜è®¤å€¼&lt;code&gt;unlimited&lt;/code&gt;ï¼‰ï¼›è®¾ç½®&lt;code&gt;SetMaxOpenConns&lt;/code&gt;å¯¹äºç”Ÿäº§çº§åº”ç”¨ç¨‹åºå¾ˆé‡è¦ã€‚å› ä¸ºé»˜è®¤å€¼æ˜¯æ— é™çš„ï¼Œåº”è¯¥è®¾ç½®å®ƒä»¥ç¡®ä¿å®ƒé€‚åˆåº•å±‚æ•°æ®åº“å¯ä»¥å¤„ç†çš„å†…å®¹ã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;SetMaxIdleConns&lt;/code&gt;æœ€å¤§é™åº¦ç©ºé—²è¿æ¥æ•°ï¼ˆé»˜è®¤å€¼&lt;code&gt;2&lt;/code&gt;ï¼‰ï¼›å¦‚æœåº”ç”¨ç¨‹åºç”Ÿæˆå¤§é‡å¹¶å‘è¯·æ±‚ï¼Œåˆ™åº”å¢åŠ &lt;code&gt;SetMaxIdleConns&lt;/code&gt;(default: )çš„å€¼ã€‚&lt;code&gt;2&lt;/code&gt;å¦åˆ™ï¼Œåº”ç”¨ç¨‹åºå¯èƒ½ä¼šç»å†é¢‘ç¹çš„é‡æ–°è¿æ¥ã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;SetConnMaxIdleTime&lt;/code&gt;æœ€å¤§é™åº¦è¿æ¥å…³é—­å‰å¯ä»¥ç©ºé—²çš„æ—¶é—´é‡ï¼ˆé»˜è®¤å€¼&lt;code&gt;unlimited&lt;/code&gt;ï¼‰ï¼›å¦‚æœåº”ç”¨ç¨‹åºå¯èƒ½é¢ä¸´å¤§é‡è¯·æ±‚ï¼Œé‚£ä¹ˆè®¾ç½®å°±å¾ˆé‡è¦ã€‚å½“åº”ç”¨ç¨‹åºè¿”å›åˆ°æ›´å’Œå¹³çš„çŠ¶æ€æ—¶ï¼Œå¸Œæœ›ç¡®ä¿åˆ›å»ºçš„è¿æ¥æœ€ç»ˆè¢«é‡Šæ”¾ã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;SetConnMaxLifetime&lt;/code&gt;æœ€å¤§é™åº¦è¿æ¥åœ¨å…³é—­ä¹‹å‰å¯ä»¥ä¿æŒæ‰“å¼€çŠ¶æ€çš„æ—¶é—´ï¼ˆé»˜è®¤å€¼&lt;code&gt;unlimited&lt;/code&gt;ï¼‰ï¼›å¦‚æœè¿æ¥åˆ°è´Ÿè½½å¹³è¡¡çš„æ•°æ®åº“æœåŠ¡å™¨ï¼Œè®¾ç½®ä¼šå¾ˆæœ‰å¸®åŠ©ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè¦ç¡®ä¿åº”ç”¨ç¨‹åºæ°¸è¿œä¸ä¼šä½¿ç”¨è¿æ¥å¤ªä¹…ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;å¦‚æœåº”ç”¨ç¨‹åºé¢ä¸´ä¸åŒçš„ç”¨ä¾‹ï¼Œå¯ä»¥ä½¿ç”¨å¤šä¸ªè¿æ¥æ± ã€‚è¿™äº›å€¼éœ€è¦æ ¹æ®ä¸åŒç¯å¢ƒè¿›è¡Œé…ç½®ï¼Œå¯¹è¿™äº›å€¼è¿›è¡Œå¯é…ç½®åŒ–ç®¡ç†ï¼Œæˆ–è€…æ”¾åœ¨é…ç½®ä¸­å¿ƒã€‚&lt;/p&gt;
&lt;h4 id=&#34;case3-ä¸ä½¿ç”¨prepareè¯­å¥-å·¥ç¨‹è§„èŒƒ&#34;&gt;case3 ä¸ä½¿ç”¨Prepareè¯­å¥ (å·¥ç¨‹è§„èŒƒ)&lt;/h4&gt;
&lt;p&gt;ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œåº”è¯¥ä½¿ç”¨Prepareå¯¹sql è¿›è¡Œé¢„å¤„ç†ï¼Œä»¥é˜²sql æ³¨å…¥ï¼Œå¹¶ä¸”é‡å¤çš„sqlè¯­å¥ä¸éœ€è¦é‡æ–°è§£æå¤„ç†ã€‚&lt;/p&gt;
&lt;h4 id=&#34;case4-é”™è¯¯å¤„ç†ç©ºå€¼---å·¥ç¨‹è§„èŒƒ&#34;&gt;case4 é”™è¯¯å¤„ç†ç©ºå€¼   (å·¥ç¨‹è§„èŒƒ)&lt;/h4&gt;
&lt;p&gt;åœ¨è®¾è®¡æ•°æ®åº“è¡¨æ—¶ï¼Œå¦‚æœå…è®¸å­—æ®µä¸ºNULLçš„è¯ï¼›æŸ¥è¯¢è¿™ä¸ªå­—æ®µscan rowæ—¶ï¼Œéœ€è¦è€ƒè™‘NULLçš„æƒ…å†µï¼Œå¦‚æœç›´æ¥ä½¿ç”¨ç±»å‹ï¼Œåˆ™ä¼šæŠ¥é”™ï¼› è§£å†³æ–¹æ³•ï¼Œä½¿ç”¨æŒ‡é’ˆç±»å‹ï¼Œä»¥åŠsqlåŒ…ä¸­å°è£…çš„ç±»å‹sql.NullXXX&lt;/p&gt;
&lt;p&gt;æ¯”æŒ‡é’ˆç±»å‹æ›´æ¸…æ¥šåœ°è¡¨è¾¾äº†æ„å›¾ã€‚&lt;/p&gt;
&lt;h4 id=&#34;case5-ä¸å¤„ç†è¡Œè¿­ä»£é”™è¯¯--å·¥ç¨‹è§„èŒƒ&#34;&gt;case5 ä¸å¤„ç†è¡Œè¿­ä»£é”™è¯¯  (å·¥ç¨‹è§„èŒƒ)&lt;/h4&gt;
&lt;p&gt;è¿™æ˜¯è¦ç‰¢è®°çš„æœ€ä½³å®è·µï¼šå› ä¸º&lt;code&gt;rows.Next&lt;/code&gt;å¯ä»¥åœ¨éå†æ‰€æœ‰è¡Œæˆ–å‡†å¤‡ä¸‹ä¸€è¡Œæ—¶å‘ç”Ÿé”™è¯¯æ—¶åœæ­¢ï¼Œæ‰€ä»¥åº”è¯¥åœ¨è¿­ä»£åä½¿ç”¨&lt;code&gt;rows.Err&lt;/code&gt;è¿›è¡Œæ£€æŸ¥ã€‚&lt;/p&gt;
&lt;h3 id=&#34;79ä¸å…³é—­ä¸´æ—¶èµ„æº&#34;&gt;79.ä¸å…³é—­ä¸´æ—¶èµ„æº&lt;/h3&gt;
&lt;p&gt;å¼€å‘è€…ç»å¸¸åœ¨ä»£ç ä¸­çš„æŸä¸ªç‚¹å…³é—­ç”³è¯·çš„ä¸´æ—¶èµ„æºï¼Œä»¥é¿å…ç£ç›˜æˆ–å†…å­˜ï¼Œè¿æ¥ç­‰èµ„æºæ³„æ¼ã€‚ç»“æ„é€šå¸¸å®ç°&lt;code&gt;io.Closer&lt;/code&gt;æ¥å£è¡¨ç¤ºå¿…é¡»å…³é—­ä¸´æ—¶èµ„æºã€‚åˆ—ä¸¾3ä¸ªä¸å…³é—­ä¸´æ—¶èµ„æºçš„case:&lt;/p&gt;
&lt;h4 id=&#34;case1-http-response-body-é‡è¦&#34;&gt;case1 HTTP Response body ï¼ˆé‡è¦ï¼‰&lt;/h4&gt;
&lt;p&gt;å¦‚æœä½¿ç”¨Goè¯­è¨€ç¼–å†™HTTPåè®®ç›¸å…³çš„ä»£ç ï¼Œç»å¸¸ä¼šé‡åˆ°çš„é—®é¢˜ï¼Œå¿˜è®°å…³é—­è¿”å›çš„http.Response.Body,  å¯¼è‡´èµ„æºæ³„éœ²ï¼Œå…¶å®å¼€å‘æ–‡æ¡£ä¸­å·²ç»ç»™å‡ºäº†è¯´æ˜ &lt;a href=&#34;https://pkg.go.dev/net/http#Response.Body&#34;&gt;https://pkg.go.dev/net/http#Response.Body&lt;/a&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;nx&#34;&gt;The&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;http&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;Client&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;and&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;Transport&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;guarantee&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;that&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;Body&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;is&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;always&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;non&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;kc&#34;&gt;nil&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;even&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;on&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;responses&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;without&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;a&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;body&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;or&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;responses&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;with&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;a&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;zero&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;length&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;body&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;  &lt;span class=&#34;nx&#34;&gt;It&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;is&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;the&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;caller&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;&amp;#39;&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;s&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;responsibility&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;to&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;close&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;Body&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;  &lt;span class=&#34;nx&#34;&gt;The&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;default&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;HTTP&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;client&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;&amp;#39;&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;s&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;Transport&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;may&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;not&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;reuse&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;HTTP&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;mf&#34;&gt;1.&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;x&lt;/span&gt; &lt;span class=&#34;s&#34;&gt;&amp;#34;keep-alive&amp;#34;&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;TCP&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;connections&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;the&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;Body&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;is&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;not&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;read&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;to&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;completion&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;and&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;closed&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;httpå®¢æˆ·ç«¯å’Œä¼ è¾“ä¿è¯Bodyæ€»æ˜¯éç©ºçš„ï¼Œå³ä½¿å“åº”æ²¡æœ‰Bodyæˆ–è€…å“åº”çš„Bodyé•¿åº¦ä¸ºé›¶ã€‚å…³é—­Bodyæ˜¯è°ƒç”¨è€…çš„è´£ä»»ã€‚å¦‚æœ&lt;strong&gt;Bodyæ²¡æœ‰è¯»åˆ°å®Œæˆå¹¶ä¸”å…³é—­ï¼Œç¼ºçœHTTPå®¢æˆ·ç«¯çš„ä¼ è¾“(DefaultTransport é»˜è®¤æ‰“å¼€äº†Keep-Alive)ä¸èƒ½å¤ç”¨HTTP/1.x &amp;ldquo;keep-alive&amp;quot;tcp è¿æ¥&lt;/strong&gt;ã€‚å¹¶ä¸”æŸ¥çœ‹æºç åˆ†æï¼š&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/golang/go/blob/go1.20/src/net/http/client.go&#34;&gt;go1.20/src/net/http/client.go&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/golang/go/blob/go1.20/src/net/http/transport.go&#34;&gt;go1.20/src/net/http/transport.go&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/golang/go/blob/go1.20/src/net/http/transfer.go&#34;&gt;go1.20/src/net/http/transfer.go&lt;/a&gt; (body Read from bufio Read)&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/golang/go/blob/go1.20/src/bufio/bufio.go&#34;&gt;go1.20/src/bufio/bufio.go&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;è°ƒç”¨æµç¨‹ï¼šåˆå§‹åŒ–Client, è°ƒç”¨ Client.Do/do (Get/Post/Headæ–¹æ³•NewRequestä¹‹åéƒ½ä¼šè°ƒç”¨Doæ–¹æ³•ï¼‰â†’ Client.send â†’ send â†’  Transport.RoundTrip æ¥å£æ–¹æ³• â†’  Transport.roundTrip&lt;/p&gt;
&lt;p&gt;â†’ Transport.getConn â†’ Transport.queueForDial -ã€‹ go Transport.dialConnFor â†’ go persistConn.readLoop ï¼ˆå°†è¿æ¥å“åº”æ•°æ®å†™å…¥transferReader Bodyä¸­, å‘é€responseAndErrorç»™roundTripï¼‰ å’Œ  go persistConn.writeLoop  (å¾€è¿æ¥ä¸­å†™è¯·æ±‚æ•°æ®,å°†writeErrç»“æœåˆ†åˆ«å‘é€ä¸€ä»½åˆ°writeErrChä¸­ï¼Œç”±readLoopæ¥æ”¶å¤„ç†ï¼Œå‘é€ä¸€ä»½ç»™roundTripå¤„ç†)&lt;/p&gt;
&lt;p&gt;â†’ persistConn.roundTrip (å‘é€persistConn.requestAndChan åˆ° reqchä¸­,ç”¨äºreadLoopæ¥æ”¶ï¼›å‘é€writeRequeståˆ°writechä¸­ï¼Œç”±writeLoop æ¥æ”¶ï¼›ä»writeErrCh å¤„ç†writeé”™è¯¯ï¼›ä»responseAndError chanä¸­å¤„ç†readé”™è¯¯)&lt;/p&gt;
&lt;p&gt;æ•´ä½“è¿‡ç¨‹æ˜¯ä¸€ä¸ªå»ºç«‹é•¿è¿æ¥(KeepAliveå¼€å¯), å¹¶åœ¨é•¿è¿æ¥ä¸­é€šè¿‡è¯»å†™ç®¡é“å’Œé”™è¯¯ç»“æœç®¡é“æ¥ååŒå¤„ç†ï¼Œç®¡é“æ˜¯å¯ç¼“å†²çš„ï¼Œé•¿åº¦æ˜¯1ä¸ªbufferï¼Œåˆšå¥½ç”¨äºå­˜æ”¾ä¸€ä¸ªæ•°æ®ï¼Œå‘é€å’Œæ¥æ”¶ç­‰å¾…ç®¡é“ä¸­çš„æ•°æ®è¿›è¡Œå¤„ç†ã€‚&lt;/p&gt;
&lt;p&gt;åœ¨KeepAliveå¼€å¯çš„æƒ…å†µä¸‹ï¼Œé•¿è¿æ¥å¦‚æœä¸å…³é—­Response.Bodyï¼Œå¹¶ä¸”ä¸è¯»å–Bodyä¸­çš„æ•°æ®ï¼Œä¸ä¼šå¤ç”¨åŸæœ‰é•¿è¿æ¥ï¼Œé€šè¿‡ä¸Šé¢åˆ†æï¼Œä¼šå¯¼è‡´åç¨‹æ³„éœ²ï¼›å¦‚ä¸‹ä»£ç ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;k&#34;&gt;for&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;i&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;i&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;10&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;++&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
		&lt;span class=&#34;nx&#34;&gt;fmt&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Println&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;go nums&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;runtime&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;NumGoroutine&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;())&lt;/span&gt;
		&lt;span class=&#34;nx&#34;&gt;resp&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;_&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;http&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Get&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;&amp;lt;http://www.baidu.com&amp;gt;&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
		&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;resp&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;!=&lt;/span&gt; &lt;span class=&#34;kc&#34;&gt;nil&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;resp&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Body&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;!=&lt;/span&gt; &lt;span class=&#34;kc&#34;&gt;nil&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
			&lt;span class=&#34;c1&#34;&gt;//_, _ = ioutil.ReadAll(resp.Body)
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;			&lt;span class=&#34;c1&#34;&gt;//_ = resp.Body.Close()
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;		&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
	&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
	&lt;span class=&#34;nx&#34;&gt;fmt&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Println&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;go nums&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;runtime&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;NumGoroutine&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;())&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;å¦‚æœå¤ç”¨çš„è¯ï¼Œè¿™é‡Œè¯·æ±‚æ˜¯ä¸²è¡Œå¤„ç†ï¼Œä¼šå¤ç”¨åŒä¸€ä¸ªè¿æ¥ï¼Œæ‰€ä»¥åªä¼šæœ‰3ä¸ªåç¨‹åœ¨å·¥ä½œï¼›å¦‚æœä¸èƒ½å¤ç”¨è¿æ¥çš„è¯,æ¯å¤„ç†ä¸€ä¸ªè¯·æ±‚ä¼šæ–°å¼€è¿æ¥ï¼Œå¯¼è‡´åç¨‹æ³„éœ²ã€‚Clientä¸åˆå§‹åŒ–ï¼ŒTransporté»˜è®¤æ˜¯å¼€å¯keep-aliveï¼›&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;c1&#34;&gt;// DefaultTransport is the default implementation of Transport and is
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// used by DefaultClient. It establishes network connections as needed
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// and caches them for reuse by subsequent calls. It uses HTTP proxies
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// as directed by the $HTTP_PROXY and $NO_PROXY (or $http_proxy and
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// $no_proxy) environment variables.
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;var&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;DefaultTransport&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;RoundTripper&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Transport&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
	&lt;span class=&#34;nx&#34;&gt;Proxy&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;ProxyFromEnvironment&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
	&lt;span class=&#34;nx&#34;&gt;DialContext&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;defaultTransportDialContext&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;net&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Dialer&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
		&lt;span class=&#34;nx&#34;&gt;Timeout&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;   &lt;span class=&#34;mi&#34;&gt;30&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;time&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Second&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
		&lt;span class=&#34;nx&#34;&gt;KeepAlive&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;30&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;time&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Second&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
	&lt;span class=&#34;p&#34;&gt;}),&lt;/span&gt;
	&lt;span class=&#34;nx&#34;&gt;ForceAttemptHTTP2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;     &lt;span class=&#34;kc&#34;&gt;true&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
	&lt;span class=&#34;nx&#34;&gt;MaxIdleConns&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;          &lt;span class=&#34;mi&#34;&gt;100&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
	&lt;span class=&#34;nx&#34;&gt;IdleConnTimeout&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;       &lt;span class=&#34;mi&#34;&gt;90&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;time&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Second&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
	&lt;span class=&#34;nx&#34;&gt;TLSHandshakeTimeout&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;   &lt;span class=&#34;mi&#34;&gt;10&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;time&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Second&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
	&lt;span class=&#34;nx&#34;&gt;ExpectContinueTimeout&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;time&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Second&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œä½¿ç”¨tcpè¿æ¥èµ„æºéƒ½æ˜¯éœ€è¦æ ¹æ®è°ƒç”¨ èµ„æºæœåŠ¡æ”¾çš„ç³»ç»Ÿè´Ÿè½½ååèƒ½åŠ›æ¥é…ç½®çš„ã€‚ä¹Ÿæ˜¯éœ€è¦é…ç½®åŒ–ã€‚&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å¦‚æœåœ¨æ²¡æœ‰è¯»å–çš„æƒ…å†µä¸‹ä¹Ÿæ²¡æœ‰å…³é—­Bodyï¼Œä¼šå‘ç”Ÿåç¨‹æ³„éœ²ï¼ŒåŒæ—¶tcpè¿æ¥ä¹Ÿä¸ä¼šå¤ç”¨,æœ¬è´¨ä¸Šæ˜¯è¿æ¥èµ„æºæœªé‡Šæ”¾è‡³è¿æ¥æ± ä¸­ï¼Œå­˜åœ¨è¿æ¥æ³„éœ²ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;è¿˜éœ€è¦è®°ä½çš„é‡è¦äº‹æƒ…æ˜¯ï¼Œå¦‚å¼€å‘æ–‡æ¡£net/httpä¸­æåˆ°çš„ï¼Œå½“å…³é—­ Response Bodyæ—¶ï¼Œæ˜¯å¦å¤ç”¨è¿æ¥ï¼Œè¿™å–å†³äºæ˜¯å¦ä»ä¸­è¯»å–å®Œbodyä¸­çš„å€¼ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å¦‚æœåœ¨æ²¡æœ‰è¯»å–çš„æƒ…å†µä¸‹å…³é—­Bodyï¼Œè™½ç„¶ä¸ä¼šå‘ç”Ÿåç¨‹æ³„éœ²ï¼Œä½†æ˜¯é»˜è®¤çš„ HTTP ä¼ è¾“å¯èƒ½ä¼šå…³é—­è¿æ¥ã€‚&lt;/li&gt;
&lt;li&gt;å¦‚æœåœ¨è¯»å–åå…³é—­Bodyï¼Œé»˜è®¤çš„ HTTP ä¼ è¾“ä¸ä¼šå…³é—­è¿æ¥ï¼›å› æ­¤ï¼Œå®ƒå¯ä»¥é‡å¤ä½¿ç”¨ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;æ‰€ä»¥ä¸ç®¡å¦‚ä½•ï¼Œæœ€å¥½çš„æ–¹å¼æ˜¯éƒ½åº”è¯¥å…³é—­Response Body,  å°½ç®¡Bodyæ²¡æœ‰æ•°æ®ï¼Œæˆ–è€…å·²ç»è¯»å–å®Œäº†ï¼Œéƒ½åº”è¯¥å…³é—­ã€‚&lt;/p&gt;
&lt;p&gt;tips: æ˜¯å¦è¿æ¥å¤ç”¨çš„åˆ¤å®šï¼Œå¯ä»¥é€šè¿‡tcpdump æˆ–è€… wireshark æ¥æŠ“åŒ…ï¼Œé€šè¿‡æ˜¯å¦ä½¿ç”¨åŒä¸€ä¸ªè¿æ¥å››å…ƒç»„æ¥ç¡®å®šæ˜¯å¦å¤ç”¨äº†åŒä¸€è¿æ¥ã€‚å¯ä»¥ä½¿ç”¨ç±»ä¼¼å¦‚ä¸‹å‘½ä»¤ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;tcpdump -i utun2 -tnn dst host www.baidu.com //per host pool
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h4 id=&#34;case2-sqlrows&#34;&gt;case2 sql.Rows&lt;/h4&gt;
&lt;p&gt;&lt;code&gt;sql.Rows&lt;/code&gt;æ˜¯ç”¨ä½œ SQL æŸ¥è¯¢ç»“æœçš„ç»“æ„ã€‚å› ä¸ºè¿™ä¸ªç»“æ„å®ç°äº†&lt;code&gt;io.Closer&lt;/code&gt;ï¼Œæ‰€ä»¥å®ƒå¿…é¡»è¢«å…³é—­ã€‚å¿˜è®°å…³é—­è¡Œæ„å‘³ç€è¿æ¥æ³„æ¼ï¼Œè¿™ä¼šé˜»æ­¢æ•°æ®åº“è¿æ¥è¢«æ”¾å›è¿æ¥æ± ã€‚&lt;/p&gt;
&lt;h4 id=&#34;case3-osfile&#34;&gt;case3 os.File&lt;/h4&gt;
&lt;p&gt;å¦‚æœæœ€ç»ˆæ²¡æœ‰å…³é—­ä¸€ä¸ª&lt;code&gt;os.File&lt;/code&gt;ï¼Œå®ƒæœ¬èº«ä¸ä¼šå¯¼è‡´æ³„æ¼ï¼šæ–‡ä»¶å°†åœ¨&lt;code&gt;os.File&lt;/code&gt;åƒåœ¾æ”¶é›†æ—¶è‡ªåŠ¨å…³é—­ã€‚ä½†æ˜¯ï¼Œæœ€å¥½&lt;code&gt;Close&lt;/code&gt;æ˜¾å¼è°ƒç”¨ï¼Œå› ä¸ºä¸çŸ¥é“ä¸‹ä¸€æ¬¡ GC ä½•æ—¶ä¼šè¢«è§¦å‘ï¼ˆé™¤éæ‰‹åŠ¨è¿è¡Œå®ƒï¼‰ã€‚&lt;/p&gt;
&lt;p&gt;æ€»ç»“æœ¬èŠ‚ï¼Œå·²ç»çœ‹åˆ°å…³é—­ä¸´æ—¶èµ„æºä»è€Œé¿å…æ³„æ¼çš„é‡è¦æ€§ã€‚ä¸´æ—¶èµ„æºå¿…é¡»åœ¨æ­£ç¡®çš„æ—¶é—´å’Œç‰¹å®šæƒ…å†µä¸‹å…³é—­ã€‚äº‹å…ˆå¹¶ä¸æ€»æ˜¯æ¸…æ¥šä»€ä¹ˆå¿…é¡»å…³é—­ã€‚åªèƒ½é€šè¿‡ä»”ç»†é˜…è¯» API æ–‡æ¡£å’Œ/æˆ–é€šè¿‡ç»éªŒæ¥è·å–è¿™äº›ä¿¡æ¯ã€‚ä½†æ˜¯åº”è¯¥è®°ä½ï¼Œå¦‚æœä¸€ä¸ªç»“æ„å®ç°äº†&lt;code&gt;io.Closer&lt;/code&gt;æ¥å£ï¼Œæœ€ç»ˆå¿…é¡»è°ƒç”¨&lt;code&gt;Close&lt;/code&gt;æ–¹æ³•ã€‚æœ€åä½†å¹¶éæœ€ä¸é‡è¦çš„ä¸€ç‚¹æ˜¯ï¼Œäº†è§£å¦‚æœé—­åŒ…å¤±è´¥è¯¥æ€ä¹ˆåŠéå¸¸é‡è¦ï¼šæ˜¯å¦è¶³ä»¥è®°å½•ä¸€æ¡æ¶ˆæ¯ï¼Œæˆ–è€…æ˜¯å¦ä¹Ÿåº”è¯¥ä¼ æ’­å®ƒï¼Ÿé€‚å½“çš„æ“ä½œå–å†³äºå…·ä½“é”™è¯¯erræ˜¯å¦éœ€è¦å¤„ç†ã€‚&lt;/p&gt;
&lt;h3 id=&#34;80åœ¨å›å¤-http-è¯·æ±‚åå¿˜è®°è¿”å›è¯­å¥-å‡‘æ•°&#34;&gt;80.åœ¨å›å¤ HTTP è¯·æ±‚åå¿˜è®°è¿”å›è¯­å¥ ï¼ˆå‡‘æ•°ï¼‰&lt;/h3&gt;
&lt;p&gt;å¦‚æœæœ‰é€‚å½“çš„è¦†ç›–ç‡ï¼Œè¿™æ ·çš„é—®é¢˜å¯ä»¥è€Œä¸”åº”è¯¥åœ¨æµ‹è¯•æœŸé—´è¢«å‘ç°ã€‚è¿™ä¸ªå±äºerrâ‰ nil, éœ€è¦checké‡åˆ°é”™è¯¯ä¸ä¸ºnilï¼Œæ˜¯å¦ç›´æ¥returnè¿”å›ã€‚è¿™æ€»ä½çº§é”™è¯¯ï¼Œå¯ä»¥äº¤ç»™æµ‹è¯•ç”¨ä¾‹æ¥è¦†ç›–åˆ°ã€‚&lt;/p&gt;
&lt;h3 id=&#34;81ä½¿ç”¨é»˜è®¤çš„-http-å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨-å·¥ç¨‹è§„èŒƒ&#34;&gt;81.ä½¿ç”¨é»˜è®¤çš„ HTTP å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ (å·¥ç¨‹è§„èŒƒ)&lt;/h3&gt;
&lt;p&gt;åœ¨è®¨è®ºhttpåŒ…çš„æ—¶å€™æåˆ°, å¦‚æœä¸åˆå§‹åŒ–http.Clientï¼ŒClientç»“æ„ä¸­çš„RoundTripperä¼šé»˜è®¤ä½¿ç”¨DefaultTransport, è€ŒDefaultTransport åªèƒ½ç”¨äºå¼€å‘æµ‹è¯•æ—¶ä½¿ç”¨ï¼›å¯¹äºç”Ÿäº§ç¯å¢ƒï¼Œ éœ€è¦æ›´å…·ä¾èµ–çš„èµ„æºæœåŠ¡è¿›è¡Œé…ç½®ï¼Œä¿è¯å…¶é…ç½®è¿‡å¤§çš„è¿æ¥æ•°è€Œè¶…å‡ºèµ„æºæœåŠ¡çš„è´Ÿè½½èƒ½åŠ›ï¼Œä»¥åŠåœ¨ç½‘ç»œä¸ç¨³å®šæƒ…å†µä¸‹ï¼Œè¿æ¥è¶…æ—¶ï¼Œè¯»å†™è¶…æ—¶çš„è®¾å®šï¼Œä»¥ä¾¿æ˜¯å¦é‡è¯•ï¼Œè¿™æ ·ä¸ä¼šä¸€ç›´hangä½è¿æ¥ä¸é‡Šæ”¾ï¼Œå¹¶å‘åœºæ™¯ä¸‹ï¼Œä¼šå¯¼è‡´æœåŠ¡è´Ÿè½½å¢åŠ ï¼Œ è¿æ¥è¿‡å¤šå¯¼è‡´æœåŠ¡æ‹’ç»ã€‚æ‰€ä»¥å¯¹äºç½‘ç»œtcpè¯·æ±‚ï¼Œéƒ½éœ€è¦æ ¹æ®å…·ä½“çš„ç”Ÿäº§æƒ…å†µè¿›è¡Œåˆç†é…ç½®ï¼Œè€Œä¸”æ˜¯å¯é…ç½®åŒ–ï¼Œ æˆ–è€…å¼•å…¥é…ç½®ä¸­å¿ƒåŠ¨æ€ä¸‹å‘é…ç½®ã€‚å¯¹äºæœåŠ¡ç«¯çš„tcpè¿æ¥é…ç½®ä¹Ÿæ˜¯å¦‚æ­¤ï¼Œä¹Ÿéœ€è¦é…ç½®è¯»å†™è¶…æ—¶æ—¶é—´ï¼Œè¿›è¡Œå¯é…ç½®åŒ–ç®¡ç†ã€‚&lt;/p&gt;
&lt;h2 id=&#34;æ¦‚æ‹¬&#34;&gt;æ¦‚æ‹¬&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;å¯¹æ¥å—&lt;code&gt;time.Duration&lt;/code&gt;. å³ä½¿å…è®¸ä¼ é€’æ•´æ•°ï¼Œä¹Ÿè¦å°½é‡ä½¿ç”¨æ—¶é—´ API æ¥é˜²æ­¢ä»»ä½•å¯èƒ½çš„æ··æ·†ã€‚&lt;/li&gt;
&lt;li&gt;é¿å…è°ƒç”¨&lt;code&gt;time.After&lt;/code&gt;é‡å¤å‡½æ•°ï¼ˆä¾‹å¦‚å¾ªç¯æˆ– HTTP å¤„ç†ç¨‹åºï¼‰å¯ä»¥é¿å…å³°å€¼å†…å­˜æ¶ˆè€—ã€‚ç”±åˆ›å»ºçš„èµ„æº&lt;code&gt;time.After&lt;/code&gt;åªæœ‰åœ¨å®šæ—¶å™¨åˆ°æœŸæ—¶æ‰ä¼šè¢«é‡Šæ”¾ã€‚&lt;/li&gt;
&lt;li&gt;åœ¨ Go ç»“æ„ä¸­ä½¿ç”¨åµŒå…¥å¼å­—æ®µæ—¶è¦å°å¿ƒã€‚è¿™æ ·åšå¯èƒ½ä¼šå¯¼è‡´å·å·æ‘¸æ‘¸çš„é”™è¯¯ï¼Œä¾‹å¦‚&lt;code&gt;time.Time&lt;/code&gt;å®ç°&lt;code&gt;json .Marshaler&lt;/code&gt;æ¥å£çš„åµŒå…¥å¼å­—æ®µï¼Œä»è€Œè¦†ç›–é»˜è®¤çš„å°é€å¤„ç†è¡Œä¸ºã€‚&lt;/li&gt;
&lt;li&gt;æ¯”è¾ƒä¸¤ä¸ª&lt;code&gt;time.Time&lt;/code&gt;ç»“æ„æ—¶ï¼Œå›æƒ³ä¸€ä¸‹å®ƒ&lt;code&gt;time.Time&lt;/code&gt;åŒæ—¶åŒ…å«ä¸€ä¸ªæŒ‚é’Ÿå’Œä¸€ä¸ªå•è°ƒæ—¶é’Ÿï¼Œå¹¶ä¸”ä½¿ç”¨è¿ç®—ç¬¦çš„æ¯”è¾ƒ&lt;code&gt;==&lt;/code&gt;æ˜¯åœ¨ä¸¤ä¸ªæ—¶é’Ÿä¸Šå®Œæˆçš„ã€‚&lt;/li&gt;
&lt;li&gt;ä¸ºé¿å…åœ¨è§£ç»„ JSON æ•°æ®æ—¶æä¾›åœ°å›¾æ—¶å‡ºç°é”™è¯¯å‡è®¾ï¼Œè¯·è®°ä½&lt;code&gt;float64&lt;/code&gt;é»˜è®¤æƒ…å†µä¸‹ä¼šå°†æ•°å­—è½¬æ¢ä¸ºã€‚&lt;/li&gt;
&lt;li&gt;å¦‚æœéœ€è¦æµ‹è¯•é…ç½®å¹¶ç¡®ä¿æ•°æ®åº“å¯è®¿é—®ï¼Œè¯·è°ƒç”¨&lt;code&gt;Ping&lt;/code&gt;oræ–¹æ³•ã€‚&lt;code&gt;PingContext&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;é…ç½®ç”Ÿäº§çº§åº”ç”¨ç¨‹åºçš„æ•°æ®åº“è¿æ¥å‚æ•°ã€‚&lt;/li&gt;
&lt;li&gt;ä½¿ç”¨ SQL é¢„å¤„ç†è¯­å¥å¯ä»¥ä½¿æŸ¥è¯¢æ›´é«˜æ•ˆã€æ›´å®‰å…¨ã€‚&lt;/li&gt;
&lt;li&gt;ä½¿ç”¨æŒ‡é’ˆæˆ–ç±»å‹å¤„ç†è¡¨ä¸­å¯ä¸ºç©ºçš„åˆ—&lt;code&gt;sql.NullXXX&lt;/code&gt;ã€‚&lt;/li&gt;
&lt;li&gt;è°ƒç”¨è¡Œåè¿­ä»£&lt;code&gt;Err&lt;/code&gt;çš„æ–¹æ³•&lt;code&gt;sql.Rows&lt;/code&gt;ä»¥ç¡®ä¿æ‚¨åœ¨å‡†å¤‡ä¸‹ä¸€è¡Œæ—¶æ²¡æœ‰é—æ¼ä»»ä½•é”™è¯¯ã€‚&lt;/li&gt;
&lt;li&gt;æœ€ç»ˆå…³é—­æ‰€æœ‰å®ç°çš„ç»“æ„&lt;code&gt;io.Closer&lt;/code&gt;ä»¥é¿å…å¯èƒ½çš„æ³„æ¼ã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;return&lt;/code&gt;ä¸ºé¿å… HTTP å¤„ç†ç¨‹åºå®ç°ä¸­çš„æ„å¤–è¡Œä¸ºï¼Œå¦‚æœæ‚¨å¸Œæœ›å¤„ç†ç¨‹åºåœ¨ ä¹‹ååœæ­¢ï¼Œè¯·ç¡®ä¿æ‚¨æ²¡æœ‰é”™è¿‡è¯¥è¯­å¥&lt;code&gt;http.Error&lt;/code&gt;ã€‚&lt;/li&gt;
&lt;li&gt;å¯¹äºç”Ÿäº§çº§åº”ç”¨ç¨‹åºï¼Œä¸è¦ä½¿ç”¨é»˜è®¤çš„ HTTP å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨å®ç°ã€‚è¿™äº›å®ç°ç¼ºå°‘åœ¨ç”Ÿäº§ä¸­åº”è¯¥å¼ºåˆ¶æ‰§è¡Œçš„è¶…æ—¶å’Œè¡Œä¸ºã€‚&lt;/li&gt;
&lt;/ul&gt;</description>
      
    </item>
    
    <item>
      <title>Go tips-ç¬”è®°: å¹¶å‘å®è·µ 61-74 mistakes</title>
      <link>https://weedge.github.io/post/notions/go-tips/go-tips-09-concurrency-practice/</link>
      <pubDate>Sat, 18 Feb 2023 14:26:23 +0800</pubDate>
      
      <guid>https://weedge.github.io/post/notions/go-tips/go-tips-09-concurrency-practice/</guid>
      
        <description>&lt;h2 id=&#34;å¼•è¨€&#34;&gt;å¼•è¨€&lt;/h2&gt;
&lt;p&gt;è¿™é‡Œä¸»è¦ä»‹ç»å¹¶å‘å®è·µä¸­é‡åˆ°çš„é—®é¢˜ï¼Œè¿™äº›é—®é¢˜åœ¨golangå¼€æºé¡¹ç›®ä¸­ä¹Ÿç»å¸¸ä¼šå‡ºç°ï¼Œå¦‚æœç¼–å†™å¹¶å‘ä¹Ÿä¼šä¸€ç›´ä¼´éšåœ¨å¼€å‘å½“ä¸­å‡ºç°ï¼Œä¹Ÿæœ‰å·¥ç¨‹å®è·µç›¸å…³çš„è®ºæ–‡è¿›è¡Œç»Ÿè®¡å½’çº³æ€»ç»“(PS: ç”¨è¿™ç§æ–¹å¼å‘ä¸ªè®ºæ–‡è¿˜æ˜¯æ¯”è¾ƒè½»æ¾çš„~)ï¼š&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;&lt;a href=&#34;https://songlh.github.io/paper/go-study.pdf&#34;&gt;Understanding Real-World Concurrency Bugs in Go&lt;/a&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;tips: ä½œè€…å¯¹golangå’Œrustéƒ½æœ‰ç ”ç©¶ï¼Œç»“åˆç›¸å…³çš„ä»£ç éƒ½å¯ä»¥ä¸€èµ·å­¦ä¹ ä¸‹, è¯­è¨€æ–¹é¢çš„å°ç»†èŠ‚&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://arxiv.org/pdf/2204.00764.pdf&#34;&gt;&lt;strong&gt;A Study of Real-World Data Races in Golang&lt;/strong&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Go å®˜æ–¹æä¾›raceå·¥å…·æ¥æ£€æŸ¥å¹¶å‘åœºæ™¯ä¸‹çš„æ•°æ®ç«äº‰é—®é¢˜ï¼š &lt;a href=&#34;https://go.dev/doc/articles/race_detector&#34;&gt;https://go.dev/doc/articles/race_detector&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/google/sanitizers/wiki/ThreadSanitizerGoManual&#34;&gt;https://github.com/google/sanitizers/wiki/ThreadSanitizerGoManual&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;æ³¨ï¼šGoè¦ä½¿ç”¨-raceï¼Œéœ€å¯ç”¨CGOï¼Œä¾èµ–sanitizersï¼›ä¸€èˆ¬ç”¨äºå¼€å‘æµ‹è¯•è¿›è¡Œæ£€æµ‹&lt;/p&gt;
&lt;p&gt;å¦‚æœæƒ³æ›´åŠ æ·±å…¥çš„äº†è§£å¹¶å‘å¹¶è¡Œï¼Œå¯ä»¥ä¸€èµ·å­¦ä¹ è¿™æœ¬ä¹¦ï¼š &lt;a href=&#34;https://mirrors.edge.kernel.org/pub/linux/kernel/people/paulmck/perfbook/perfbook.html&#34;&gt;&lt;strong&gt;Is Parallel Programming Hard, And, If So, What Can You Do About It?&lt;/strong&gt;&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&#34;ç¬”è®°&#34;&gt;ç¬”è®°&lt;/h2&gt;
&lt;h3 id=&#34;61ä¼ æ’­ä¸é€‚å½“çš„context&#34;&gt;61.ä¼ æ’­ä¸é€‚å½“çš„context&lt;/h3&gt;
&lt;p&gt;ä¼ æ’­contextåº”è¯¥è°¨æ…è¿›è¡Œã€‚æ¯”å¦‚æ–‡ä¸­ä¸­é€šè¿‡ä¸€ä¸ªåŸºäºä¸ http.Requestå…³è”çš„contextå¤„ç†å¼‚æ­¥æ“ä½œçš„ç¤ºä¾‹æ¥è¯´æ˜è¿™ä¸€ç‚¹ã€‚å› ä¸ºä¸€æ—¦æœåŠ¡æ¥å£è¿”å›å“åº”ï¼Œè¿™æ¬¡è¯·æ±‚ä¼šè¯çš„contextå°±ä¼šè¢«cancelï¼Œä½¿ç”¨ http.Requestå…³è”çš„contextçš„å¼‚æ­¥æ“ä½œä¹Ÿå¯èƒ½ä¼šæ„å¤–åœæ­¢(è¯·æ±‚å·²ç»ç»“æŸï¼Œä½†æ˜¯å¼‚æ­¥æ“ä½œè¿˜æ²¡æœ‰æ‰§è¡Œå®Œ)ã€‚é‡åˆ°è¿™ç§æƒ…å†µï¼Œå¯ä»¥ä¸ºç‰¹æ®Šæƒ…å†µåˆ›å»ºå®ç°context.Contextæ¥å£çš„è‡ªå®šä¹‰contextç»“æ„ï¼Œè¿™ä¸ªç»“æ„å°†åŸæ¥çš„ctx context.Contextä½œä¸ºæˆå‘˜wrapä¸€å±‚ï¼Œå®ç°ä¸»è¦çš„ä¼ é€’åŠŸèƒ½Valueæ–¹æ³•, è¿™æ ·åœ¨æœåŠ¡çš„è¯·æ±‚å›è¯ç»“æŸä¹‹åï¼Œå¼‚æ­¥æ“ä½œå¯ä»¥ç»§ç»­æ‰§è¡Œå®Œæˆã€‚&lt;/p&gt;
&lt;p&gt;tipsï¼šç”Ÿäº§ç¯å¢ƒä¸‹ï¼Œè¯·æ±‚æ¥å£ä¸‹çš„å¼‚æ­¥æ“ä½œï¼Œå¿…é¡»é¿å…å› goroutineåç¨‹å¤„ç†hangä½ï¼Œå¯¼è‡´æ³„éœ²ï¼Œä¸€èˆ¬å¼•å…¥æ‰§è¡Œè¶…æ—¶æœºåˆ¶ã€‚&lt;/p&gt;
&lt;h3 id=&#34;62åœ¨ä¸çŸ¥é“ä½•æ—¶åœæ­¢çš„æƒ…å†µä¸‹å¯åŠ¨-goroutine-é‡è¦&#34;&gt;62.åœ¨ä¸çŸ¥é“ä½•æ—¶åœæ­¢çš„æƒ…å†µä¸‹å¯åŠ¨ goroutine (é‡è¦)&lt;/h3&gt;
&lt;p&gt;Goroutines å¯åŠ¨èµ·æ¥æ—¢ç®€å•åˆä¾¿å®œâ€”â€”å¦‚æ­¤ç®€å•å’Œä¾¿å®œï¼Œä»¥è‡³äºä¸è€ƒè™‘åœæ­¢ä¸€ä¸ªæ–°çš„ goroutineï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´æ³„æ¼ã€‚ä¸çŸ¥é“ä½•æ—¶åœæ­¢ goroutine æ˜¯ä¸€ä¸ªè®¾è®¡é—®é¢˜ï¼Œä¹Ÿæ˜¯ Go ä¸­å¸¸è§çš„å¹¶å‘é”™è¯¯ã€‚äº†è§£åŸå› ä»¥åŠå¦‚ä½•é¢„é˜²å®ƒã€‚&lt;/p&gt;
&lt;p&gt;é¦–å…ˆï¼Œé‡åŒ–ä¸€ä¸‹ goroutine æ³„æ¼çš„å«ä¹‰ã€‚åœ¨å†…å­˜æ–¹é¢ï¼Œä¸€ä¸ª goroutine ä»¥ 2 KB çš„æœ€å°å †æ ˆå¤§å°å¼€å§‹ï¼Œå®ƒå¯ä»¥æ ¹æ®éœ€è¦å¢é•¿å’Œæ”¶ç¼©ï¼ˆæœ€å¤§å †æ ˆå¤§å°åœ¨ 64 ä½ä¸Šä¸º 1 GBï¼Œåœ¨ 32 ä½ä¸Šä¸º 250 MBï¼‰ã€‚åœ¨å†…å­˜æ–¹é¢ï¼Œgoroutine è¿˜å¯ä»¥ä¿å­˜åˆ†é…ç»™å †çš„å˜é‡å¼•ç”¨ã€‚åŒæ—¶ï¼Œgoroutine å¯ä»¥ä¿å­˜ HTTP æˆ–æ•°æ®åº“è¿æ¥ã€æ‰“å¼€çš„æ–‡ä»¶å’Œç½‘ç»œå¥—æ¥å­—ç­‰èµ„æºï¼Œè¿™äº›èµ„æºæœ€ç»ˆåº”è¯¥æ­£å¸¸å…³é—­ã€‚å¦‚æœä¸€ä¸ª goroutine è¢«æ³„éœ²ï¼Œé‚£ä¹ˆè¿™äº›èµ„æºä¹Ÿä¼šè¢«æ³„éœ²ã€‚&lt;/p&gt;
&lt;p&gt;goroutine æ˜¯ä¸€ç§èµ„æºï¼Œå°±åƒä»»ä½•å…¶ä»–èµ„æºä¸€æ ·ï¼Œæœ€ç»ˆå¿…é¡»å…³é—­ä»¥é‡Šæ”¾å†…å­˜æˆ–å…¶ä»–èµ„æº(é€šå¸¸é€šè¿‡cancel ä¿¡å·é‡ï¼Œctx.Doneæ–¹å¼è®©è¿™äº›goroutineä»»åŠ¡é€€å‡ºé‡Šæ”¾èµ„æº)ã€‚åœ¨ä¸çŸ¥é“ä½•æ—¶åœæ­¢çš„æƒ…å†µä¸‹å¯åŠ¨ goroutine æ˜¯ä¸€ä¸ªè®¾è®¡é—®é¢˜ã€‚æ¯å½“ä¸€ä¸ª goroutine å¯åŠ¨æ—¶ï¼Œåº”è¯¥å¯¹å®ƒä½•æ—¶åœæ­¢æœ‰ä¸€ä¸ªæ˜ç¡®çš„è®¡åˆ’ã€‚å¦‚æœä¸€ä¸ª goroutine åˆ›å»ºèµ„æºå¹¶ä¸”å®ƒçš„ç”Ÿå‘½å‘¨æœŸä¸åº”ç”¨ç¨‹åºçš„ç”Ÿå‘½å‘¨æœŸç»‘å®šï¼Œé‚£ä¹ˆåœ¨é€€å‡ºåº”ç”¨ç¨‹åºä¹‹å‰ï¼Œç­‰å¾…è¿™ä¸ª goroutine å®Œæˆå¯èƒ½æ›´å®‰å…¨ã€‚è¿™æ ·å¯ä»¥ç¡®ä¿èµ„æºå¯ä»¥è¢«é‡Šæ”¾ã€‚&lt;/p&gt;
&lt;h3 id=&#34;63ä¸æ³¨æ„-goroutines-å’Œå¾ªç¯å˜é‡-é‡è¦&#34;&gt;63.ä¸æ³¨æ„ goroutines å’Œå¾ªç¯å˜é‡ (é‡è¦)&lt;/h3&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;k&#34;&gt;for&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;i&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;range&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;s&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;      
    &lt;span class=&#34;k&#34;&gt;go&lt;/span&gt; &lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
        &lt;span class=&#34;nx&#34;&gt;fmt&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Print&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
    &lt;span class=&#34;p&#34;&gt;}()&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;è¿™ä¸ªæ˜¯Goæ–°æ‰‹ç»å¸¸ä¼šé‡åˆ°é—®é¢˜ï¼Œä¹Ÿæ˜¯è€ç”Ÿå¸¸è°ˆçš„é—®é¢˜äº†ï¼Œå¦‚æœå¸Œæœ›æ¯ä¸ªé—­åŒ…éƒ½è®¿é—®goroutineåˆ›å»ºæ—¶çš„å€¼ï¼Œæœ‰ä»€ä¹ˆè§£å†³æ–¹æ¡ˆï¼Ÿæœ‰ä¸¤ç§æ–¹æ³•: æ¯æ¬¡è¿­ä»£ä¸­ï¼Œåˆ›å»ºä¸€ä¸ªå±€éƒ¨æ–°å˜é‡iï¼Œå¹¶å°†iå¤åˆ¶ç»™æ–°iï¼›å¦å¤–ä¸€ç§æ–¹æ³•æ˜¯ä¸å†ä¾èµ–é—­åŒ…ï¼Œè€Œæ˜¯ä½¿ç”¨å®é™…å‡½æ•°è¿›è¡Œä¼ å‚å€¼æ‹·è´ï¼Œæœ¬è´¨ä¸Šä¸€æ ·ã€‚&lt;/p&gt;
&lt;h3 id=&#34;64ä½¿ç”¨-select-å’Œ-channels-æœŸå¾…ç¡®å®šæ€§è¡Œä¸º-é‡è¦&#34;&gt;64.ä½¿ç”¨ select å’Œ channels æœŸå¾…ç¡®å®šæ€§è¡Œä¸º ï¼ˆé‡è¦ï¼‰&lt;/h3&gt;
&lt;p&gt;è¿™é‡Œä¸»è¦äº†è§£selectè¯­ä¹‰çš„å·¥ä½œåŸç†ï¼Œå¯ä»¥ä»å®˜æ–¹æ–‡æ¡£ä¸­è¿›è¡Œäº†è§£ï¼šhttps://go.dev/ref/spec#Select_statements&lt;/p&gt;
&lt;p&gt;å¦‚æœä¸€ä¸ªæˆ–å¤šä¸ªé€šä¿¡å¯ä»¥ç»§ç»­è¿›è¡Œï¼Œåˆ™é€šè¿‡ç»Ÿä¸€çš„ä¼ªéšæœºé€‰æ‹©ä¸€ä¸ªå¯ä»¥ç»§ç»­è¿›è¡Œçš„é€šä¿¡ã€‚å¦åˆ™ï¼Œå¦‚æœå­˜åœ¨é»˜è®¤æƒ…å†µï¼Œåˆ™é€‰æ‹©è¯¥æƒ…å†µã€‚å¦‚æœæ²¡æœ‰é»˜è®¤æƒ…å†µï¼Œåˆ™â€œselectâ€è¯­å¥å°†é˜»å¡ï¼Œç›´åˆ°è‡³å°‘æœ‰ä¸€ä¸ªé€šä¿¡å¯ä»¥ç»§ç»­è¿›è¡Œã€‚&lt;/p&gt;
&lt;p&gt;tips: å½“ä½¿ç”¨æ— ç¼“å†²channelæ—¶ï¼Œå†™å…¥ä¸æƒ³é˜»å¡ï¼Œä½¿ç”¨select + case å†™chan + defaultçš„æ–¹å¼æ¥å¤„ç†æ—¶éå¸¸å¥½çš„åŠæ³•ï¼Œå¯ä»¥é¿å…æ­»é”çš„æƒ…å†µï¼Œæ¯”å¦‚ &lt;code&gt;fatal error: all goroutines are asleep - deadlock!&lt;/code&gt;è¿™ä¸ªé”™è¯¯ç»å¸¸ä¼šé‡åˆ°ï¼Œè¿™ä¸ªæ˜¯å…¨éƒ¨åœ¨æ‰§è¡Œçš„goroutineéƒ½è¿›å…¥äº†ç­‰å¾…çŠ¶æ€ï¼ŒGo è¯­è¨€æ­»é”æ£€æµ‹ä¼šå‘ç°å½“å‰çš„ Goroutine å·²ç»ä¸å¯èƒ½è¢«å”¤é†’ï¼Œå°±ä¼šç›´æ¥æŠ¥é”™é€€å‡ºï¼›å¸¸è§äº ä¸€ç»„åç¨‹å¤„ç†æ•°æ®å…¶ä¸­ä¸€ä¸ªåç¨‹è¿›å…¥ä¸€ç›´ç­‰å¾…çŠ¶æ€ï¼Œè°ƒç”¨sync.WaitGroup Waitæ–¹æ³•(åº•å±‚é€šè¿‡ä¿¡å·é‡å€¼æœºåˆ¶semacquire1)ç­‰å¾…åç¨‹æ‰§è¡Œå®Œæˆï¼Œè¿™æ ·å‡ºç°ç›¸äº’ç­‰å¾…ï¼Œå¯¼è‡´deadlockã€‚&lt;/p&gt;
&lt;h3 id=&#34;65ä¸ä½¿ç”¨é€šçŸ¥channel&#34;&gt;65.ä¸ä½¿ç”¨é€šçŸ¥channel&lt;/h3&gt;
&lt;p&gt;æ— æ•°æ®channelåº”è¯¥ç”¨ &lt;code&gt;chan struct{}&lt;/code&gt; ä½œä¸ºé€šçŸ¥channelï¼Œ struct{}{}ä¸å å†…å­˜ç©ºé—´ã€‚&lt;/p&gt;
&lt;h3 id=&#34;66ä¸ä½¿ç”¨nil--channel&#34;&gt;66.ä¸ä½¿ç”¨nil  channel&lt;/h3&gt;
&lt;p&gt;æ¥å—æˆ–å‘é€åˆ° nil é€šé“æ˜¯ä¸€ç§é˜»å¡è¡Œä¸ºï¼Œè€Œä¸”è¿™ç§è¡Œä¸ºå¹¶éæ— ç”¨ã€‚æ­£å¦‚æ–‡ä¸­åˆå¹¶ä¸¤ä¸ªé€šé“çš„ç¤ºä¾‹ä¸­çœ‹åˆ°çš„é‚£æ ·ï¼Œå³ä½¿close é€šé“ï¼Œ æ¥å—æ–¹è¿˜æ˜¯å¯ä»¥è¯»å–æ•°æ®ï¼Œé€šè¿‡è¿”å›çš„ç¬¬äºŒä¸ªå‚æ•°åˆ¤æ–­æ˜¯å¦å…³é—­ï¼Œå…³é—­äº†å°†é€šé“è®¾ç½®ä¸ºnilï¼Œè¿™æ ·åˆ©ç”¨selectä¸ä¼šé€‰æ‹©é˜»å¡çš„nilé€šé“ï¼Œå¯ä»¥ä½¿ç”¨ nil é€šé“æ¥å®ç°ä¸€ä¸ªä¼˜é›…çš„çŠ¶æ€æœºï¼Œæ‰€ä»¥ nil é€šé“åœ¨æŸäº›æƒ…å†µä¸‹å¾ˆæœ‰ç”¨ï¼Œå¹¶ä¸”åœ¨å¤„ç†å¹¶å‘ä»£ç æ—¶åº”è¯¥æˆä¸º Go å¼€å‘äººå‘˜å·¥å…·é›†çš„ä¸€éƒ¨åˆ†ã€‚&lt;/p&gt;
&lt;h3 id=&#34;67å¯¹channelå¤§å°æ„Ÿåˆ°å›°æƒ‘&#34;&gt;67.å¯¹channelå¤§å°æ„Ÿåˆ°å›°æƒ‘&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;æ— ç¼“å†²é€šé“æ”¯æŒåŒæ­¥ã€‚å¯ä»¥ä¿è¯ä¸¤ä¸ª goroutine å°†å¤„äºå·²çŸ¥çŠ¶æ€ï¼šä¸€ä¸ªæ¥æ”¶æ¶ˆæ¯ï¼Œå¦ä¸€ä¸ªå‘é€æ¶ˆæ¯ã€‚&lt;/li&gt;
&lt;li&gt;ç¼“å†²é€šé“ä¸æä¾›ä»»ä½•å¼ºåŒæ­¥ã€‚å®é™…ä¸Šï¼Œç”Ÿäº§è€… goroutine å¯ä»¥å‘é€ä¸€æ¡æ¶ˆæ¯ï¼Œç„¶ååœ¨é€šé“æœªæ»¡æ—¶ç»§ç»­æ‰§è¡Œã€‚å”¯ä¸€çš„ä¿è¯æ˜¯ goroutine åœ¨æ¶ˆæ¯å‘é€ä¹‹å‰ä¸ä¼šæ”¶åˆ°æ¶ˆæ¯ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;å¿…é¡»ç‰¢è®°è¿™ä¸€åŸºæœ¬åŒºåˆ«ã€‚ä¸¤ç§é€šé“ç±»å‹éƒ½æ”¯æŒé€šä¿¡ï¼Œä½†åªæœ‰ä¸€ç§æä¾›åŒæ­¥ã€‚å¦‚æœéœ€è¦åŒæ­¥ï¼Œå¿…é¡»ä½¿ç”¨æ— ç¼“å†²é€šé“ï¼Œæ— ç¼“å†²é€šé“ä¹Ÿå¯èƒ½æ›´å®¹æ˜“æ¨ç†ï¼›ç¼“å†²é€šé“å¯èƒ½å¯¼è‡´æ¨¡ç³Šçš„æ­»é”ï¼Œè¿™åœ¨æ— ç¼“å†²é€šé“ä¸­ä¼šç«‹å³æ˜¾ç°å‡ºæ¥ã€‚åœ¨é€šçŸ¥channelçš„æƒ…å†µä¸‹ï¼Œé€šçŸ¥æ˜¯é€šè¿‡å…³é—­channel ( &lt;code&gt;close(ch)&lt;/code&gt;) å¤„ç†çš„ï¼Œä½¿ç”¨ç¼“å†²é€šé“ä¸ä¼šå¸¦æ¥ä»»ä½•å¥½å¤„ï¼Œclose channelåï¼Œè¿˜å¯ä»¥ç»§ç»­ä»channelä¸­è¯»å–æ•°æ®ã€‚&lt;/p&gt;
&lt;p&gt;ä½¿ç”¨ç¼“å†²é€šé“çš„æƒ…å†µï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;åœ¨ä½¿ç”¨ç±»ä¼¼å·¥ä½œæ± çš„æ¨¡å¼ä¸‹ï¼Œåˆ›å»ºçš„goroutineè½®è®­ä»å…±äº«é€šé“è·å–æ•°æ®æ‰§è¡Œï¼›å¯ä»¥å°†ç¼“å†²é€šé“å¤§å°ä¸åˆ›å»ºçš„ goroutines æ•°é‡è”ç³»èµ·æ¥ã€‚&lt;/li&gt;
&lt;li&gt;å½“ä½¿ç”¨é€šé“æ¥è§£å†³é€Ÿç‡é™åˆ¶é—®é¢˜æ—¶ã€‚å¦‚æœéœ€è¦é€šè¿‡é™åˆ¶è¯·æ±‚æ•°é‡æ¥å¼ºåˆ¶èµ„æºåˆ©ç”¨ï¼Œåº”è¯¥æ ¹æ®é™åˆ¶è®¾ç½®ç¼“å†²é€šé“å¤§å°ã€‚ä¾‹å¦‚ï¼Œerrorgroup ä¸­çš„ sem chan struct{}(token) å°±æ˜¯ç”¨æ¥è®¾ç½®æœ€å¤§æ‰§è¡Œçš„goroutineæ•°ç›®ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;å†³å®šä¸€ä¸ªå‡†ç¡®ç¼“å†²é€šé“å¤§å°ä¸æ˜¯ä¸€ä¸ªå®¹æ˜“çš„é—®é¢˜ã€‚é¦–å…ˆï¼Œå®ƒæ˜¯ CPU å’Œå†…å­˜ä¹‹é—´çš„å¹³è¡¡ã€‚å€¼è¶Šå°ï¼Œå¯ä»¥é¢å¯¹çš„ CPU äº‰ç”¨è¶Šå¤šï¼›ä½†æ˜¯è¿™ä¸ªå€¼è¶Šå¤§ï¼Œéœ€è¦åˆ†é…çš„å†…å­˜å°±è¶Šå¤šï¼›éœ€è¦åŸºäºåœºæ™¯ä¸‹ï¼ŒåŸºå‡†å‹æµ‹æ¥è¡¡é‡ã€‚&lt;/p&gt;
&lt;h3 id=&#34;68å¿˜è®°å­—ç¬¦ä¸²æ ¼å¼åŒ–å¯èƒ½äº§ç”Ÿçš„å‰¯ä½œç”¨&#34;&gt;68.å¿˜è®°å­—ç¬¦ä¸²æ ¼å¼åŒ–å¯èƒ½äº§ç”Ÿçš„å‰¯ä½œç”¨&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;æ•°æ®ç«äº‰(data race), æ–‡ä¸­ä¸¾äº†ä¸€ä¸ªetcd ä¾‹å­ä¸­ ä¸€ä¸ªgoroutineé€šè¿‡&lt;code&gt;fmt.Sprintf(&amp;quot;%v&amp;quot;, ctx)&lt;/code&gt; æ ¼å¼åŒ–æˆkey, å¯¹keyè¿›è¡Œwatchæ“ä½œï¼Œ é€šè¿‡ctxä¸­çš„Stringæ–¹æ³•è¯»å–ctxä¸­çš„å…ƒæ•°æ®è¿›è¡Œæ ¼å¼åŒ–ï¼›å¦ä¸€ä¸ªgoroutine é€šè¿‡context.WithValue å†™å…¥ï¼Œè¿™æ ·äº§ç”Ÿäº†data raceã€‚ä¿®å¤ ( &lt;a href=&#34;https://github.com/etcd-io/etcd/pull/7816&#34;&gt;https://github.com/etcd-io/etcd/pull/7816&lt;/a&gt; ) prä¸­, ç›´æ¥å®ç°wrapä¸€å±‚è‡ªå®šä¹‰ctxï¼Œä¸ä¾èµ–é€šè¿‡context.WithValueå†™å…¥æ”¹å˜å€¼çš„ctxï¼›&lt;/li&gt;
&lt;li&gt;æ­»é”(deadlock)ï¼Œå¦‚æœä¸€ä¸ªç»“æ„ä½“çš„æ ¼å¼åŒ–Stringå‡½æ•°ä¸­ä½¿ç”¨äº†äº’æ–¥é”ï¼Œåˆ™å¯¹ç»“æ„ä½“å¯¹è±¡æ ¼å¼åŒ–æ—¶ï¼Œè¦è€ƒè™‘å¯¹åº”äº’æ–¥é”çš„èŒƒå›´ï¼Œå¦‚æœä¸Šé”èŒƒå›´åŒ…æ‹¬äº†æ ¼å¼åŒ–ä»£ç ï¼Œåˆ™ä¼šé‡å¤ä¸Šé”ï¼Œå¯¼è‡´ç›¸äº’ç­‰å¾…ï¼Œè¿›è€Œå‡ºç°deadlockï¼›&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;69ä½¿ç”¨appendæ“ä½œäº§ç”Ÿæ•°æ®ç«äº‰-é‡è¦&#34;&gt;69.ä½¿ç”¨appendæ“ä½œäº§ç”Ÿæ•°æ®ç«äº‰ (é‡è¦)&lt;/h3&gt;
&lt;p&gt;å‘ç”Ÿæ•°æ®ç«äº‰(data race)çš„æƒ…å†µæ˜¯å¤šä¸ªå¹¶å‘goroutinesè‡³å°‘æœ‰ä¸€ä¸ªå†™æ“ä½œå‘ç”Ÿåœ¨ä¸€ä¸ªå…±äº«ç©ºé—´ä¸­ï¼›å¯¹äºsliceåˆ‡ç‰‡ç»“æ„ï¼Œappendåœ¨æ‰©å®¹çš„æ—¶å€™æ˜¯å¦é‡æ–°åˆ†é…äº†å†…å­˜ç©ºé—´ï¼Œå¦‚æœå‘ç”Ÿæ‰©å®¹åˆ™åœ¨åœ¨åˆ‡ç‰‡å‰¯æœ¬ä¸Šä½¿ç”¨ï¼Œè€Œä¸æ˜¯åŸå§‹åˆ‡ç‰‡ï¼Œè¿™æ ·å°±ä¸ä¼šå‘ç”Ÿæ•°æ®ç«äº‰ï¼›æ›´åˆç†æƒ…å†µæ˜¯ç›´æ¥åœ¨goroutineä¸­è¿›è¡Œcopyä¸€ä»½åˆ‡ç‰‡å‰¯æœ¬è¿›è¡Œappendæ“ä½œã€‚&lt;/p&gt;
&lt;p&gt;å¤šä¸ªgoroutines å¹¶å‘è®¿é—® sliceå’Œmapæ—¶ï¼Œå‘ç”Ÿæ•°æ®ç«äº‰çš„æƒ…å†µï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;ä½¿ç”¨è‡³å°‘ä¸€ä¸ªæ›´æ–°å€¼çš„ goroutine è®¿é—®åŒä¸€ä¸ªåˆ‡ç‰‡ç´¢å¼•æ˜¯ä¸€ç§æ•°æ®ç«äº‰ï¼›goroutines è®¿é—®ç›¸åŒçš„å†…å­˜ä½ç½®ã€‚&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;æ— è®ºæ“ä½œå¦‚ä½•è®¿é—®ä¸åŒçš„åˆ‡ç‰‡ç´¢å¼•éƒ½ä¸æ˜¯æ•°æ®ç«äº‰ï¼›ä¸åŒçš„ç´¢å¼•æ„å‘³ç€ä¸åŒçš„å†…å­˜ä½ç½®ã€‚&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;ä½¿ç”¨è‡³å°‘ä¸€ä¸ªgoroutineæ›´æ–°è®¿é—®åŒä¸€ä¸ªmapï¼ˆä¸ç®¡å®ƒæ˜¯ç›¸åŒçš„è¿˜æ˜¯ä¸åŒçš„keyï¼‰æ˜¯ä¸€ç§æ•°æ®ç«äº‰ã€‚ä¸ºä»€ä¹ˆè¿™ä¸åˆ‡ç‰‡æ•°æ®ç»“æ„ä¸åŒï¼Ÿmapåº•å±‚ç»“æ„æ˜¯ä¸ªæ¡¶æ•°ç»„ï¼Œæ¯ä¸ªæ¡¶éƒ½æ˜¯ä¸€ä¸ªæŒ‡å‘é”®å€¼å¯¹æ•°ç»„çš„æŒ‡é’ˆï¼›å“ˆå¸Œç®—æ³•ç”¨äºç¡®å®šæ¡¶çš„æ•°ç»„ç´¢å¼•ã€‚å› ä¸ºè¯¥ç®—æ³•åœ¨mapåˆå§‹åŒ–æœŸé—´åŒ…å«ä¸€äº›éšæœºæ€§ï¼Œæ‰€ä»¥ä¸€æ¬¡æ‰§è¡Œå¯èƒ½å¯¼è‡´ç›¸åŒçš„æ•°ç»„ç´¢å¼•(ç›¸åŒbucket)ï¼Œè€Œå¦ä¸€æ¬¡æ‰§è¡Œå¯èƒ½ä¸ä¼šã€‚ç«äº‰æ£€æµ‹å™¨é€šè¿‡å‘å‡ºè­¦å‘Šæ¥å¤„ç†è¿™ç§æƒ…å†µï¼Œè€Œä¸ç®¡å®é™…çš„æ•°æ®ç«äº‰æ˜¯å¦å‘ç”Ÿã€‚&lt;/p&gt;
&lt;p&gt;tips: ä¸sliceä¸åŒï¼Œgoåœ¨mapå®ç°ä¸­å†…ç½®äº†å¯¹å¹¶å‘è¯»å†™çš„æ£€æµ‹ï¼Œå³ä¾¿ä¸åŠ å…¥-raceï¼Œä¸€æ—¦å‘ç°å­˜åœ¨æ•°æ®ç«äº‰(è‡³å°‘æœ‰ä¸€ä¸ªå†™æ“ä½œ)ç›´æ¥fatal errorã€‚&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;70å¯¹sliceå’Œmapä½¿ç”¨mutexä¸å‡†ç¡®-é‡è¦&#34;&gt;70.å¯¹sliceå’Œmapä½¿ç”¨mutexä¸å‡†ç¡® ï¼ˆé‡è¦ï¼‰&lt;/h3&gt;
&lt;p&gt;åœ¨æ•°æ®æ—¢å¯å˜åˆå…±äº«çš„å¹¶å‘ä¸Šä¸‹æ–‡ä¸­å·¥ä½œæ—¶ï¼Œé€šå¸¸ä½¿ç”¨mutexå¯¹æ“ä½œæ•°æ®çš„ä¸´ç•ŒåŒºåŸŸè¿›è¡ŒåŒæ­¥äº’æ–¥è®¿é—®ï¼›&lt;/p&gt;
&lt;p&gt;å…·ä½“mapçš„å†…éƒ¨ç»“æ„åœ¨https://github.com/golang/go/blob/go1.20/src/runtime/map.go hmapæŸ¥çœ‹æºç (é€šè¿‡æµ‹è¯•ç”¨ä¾‹ä»£ç äº†è§£)ï¼›mapæ˜¯ä¸€ä¸ª&lt;code&gt;runtime.hmap&lt;/code&gt;ä¸»è¦åŒ…å«å…ƒæ•°æ®ï¼ˆcounter,flags,Bç­‰ï¼‰ä»¥åŠ2ä¸ªæŒ‡å‘æ•°æ®æ¡¶(bucket)çš„æŒ‡é’ˆçš„ç»“æ„ã€‚æ‰€ä»¥å¯¹ä¸mapå˜é‡ä¹‹é—´èµ‹å€¼æ“ä½œ&lt;code&gt;mp:=m&lt;/code&gt;ä¸å¤åˆ¶åº•å±‚å®é™…æ•°æ®(buckets)ã€‚è¿™ä¸ªå’Œsliceåˆ‡ç‰‡çš„åŸç†æ˜¯ä¸€æ ·ï¼Œåªä¸è¿‡éœ€è¦æ³¨æ„appendæ‰©å®¹æƒ…å†µï¼Œè€Œmapæ‰©å®¹çš„æ˜¯åº•å±‚bucketsæ•°æ®ã€‚&lt;/p&gt;
&lt;p&gt;äº†è§£äº†sliceå’Œmapçš„ç»“æ„ï¼Œå¯¹äºmutexä¿æŠ¤æ“ä½œå…±äº«çš„sliceæˆ–è€…mapçš„ä¸´ç•ŒåŒºé—´å¾ˆæœ‰å¸®åŠ©ï¼Œå¯¹äºmapéå†æ“ä½œè¿›è¡Œäº’æ–¥è®¿é—®ï¼Œå¦‚æœéå†å¤„ç†çš„æ—¶é—´é•¿ï¼Œè€ƒè™‘åˆ°æ€§èƒ½é—®é¢˜ï¼Œå¯ä»¥æ·±æ‹·è´ä¸€ä»½å‡ºæ¥è¿›è¡Œè€—æ—¶çš„è®¡ç®—æ“ä½œï¼›&lt;/p&gt;
&lt;p&gt;åœ¨è€ƒè™‘ä½¿ç”¨mutexå¯¹sliceæˆ–mapè¿›è¡Œäº’æ–¥è®¿é—®æ—¶ï¼Œéœ€è¦è€ƒè™‘å¥½äº’æ–¥çš„ä¸´ç•ŒåŒºåŸŸã€‚&lt;/p&gt;
&lt;h3 id=&#34;71æ»¥ç”¨-syncwaitgroup--é‡è¦&#34;&gt;71.æ»¥ç”¨ sync.WaitGroup  ï¼ˆé‡è¦ï¼‰&lt;/h3&gt;
&lt;p&gt;sync.WaitGroupæ˜¯Goå¹¶å‘ç¨‹åºå¸¸ç”¨çš„ç”¨äºç­‰å¾…ä¸€ç»„goroutineé€€å‡ºçš„æœºåˆ¶ã€‚é€šè¿‡Addå’ŒDoneæ–¹æ³•å®ç°å†…éƒ¨è®¡æ•°çš„è°ƒæ•´ã€‚è€ŒWaitæ–¹æ³•ç”¨äºç­‰å¾…ï¼Œç›´åˆ°å†…éƒ¨è®¡æ•°å™¨ä¸º0æ‰ä¼šè¿”å›ã€‚æ–‡ä¸­æåˆ°çš„ä¾‹å­æ˜¯æ¯”è¾ƒç»å…¸çš„å‘ï¼Œåœ¨è®ºæ–‡&lt;a href=&#34;https://arxiv.org/pdf/2204.00764.pdf&#34;&gt;&lt;strong&gt;A Study of Real-World Data Races in Golang&lt;/strong&gt;&lt;/a&gt;ä¸­ä¹Ÿæœ‰æåˆ°&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;nx&#34;&gt;wg&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;sync&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;WaitGroup&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{}&lt;/span&gt;
	&lt;span class=&#34;kd&#34;&gt;var&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;v&lt;/span&gt; &lt;span class=&#34;kt&#34;&gt;uint64&lt;/span&gt;

	&lt;span class=&#34;k&#34;&gt;for&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;i&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;i&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;++&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
		&lt;span class=&#34;k&#34;&gt;go&lt;/span&gt; &lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
			&lt;span class=&#34;nx&#34;&gt;wg&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Add&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
			&lt;span class=&#34;nx&#34;&gt;atomic&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;AddUint64&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;v&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
			&lt;span class=&#34;nx&#34;&gt;wg&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Done&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
		&lt;span class=&#34;p&#34;&gt;}()&lt;/span&gt;
	&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;

	&lt;span class=&#34;nx&#34;&gt;wg&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Wait&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
	&lt;span class=&#34;nx&#34;&gt;fmt&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Println&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;v&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;åœ¨&lt;code&gt;sync.WaitGroup&lt;/code&gt;ç»“æ„ä¸­æ‹¥æœ‰ä¸€ä¸ªé»˜è®¤åˆå§‹åŒ–ä¸º 0çš„è®¡æ•°å™¨ã€‚å¯ä»¥ä½¿ç”¨&lt;code&gt;Add(int)&lt;/code&gt;æ–¹æ³•é€’å¢æ­¤è®¡æ•°å™¨ï¼Œä½¿ç”¨&lt;code&gt;Done()&lt;/code&gt;æˆ–ä½¿ç”¨Addè´Ÿå€¼æ¥é€’å‡æ­¤è®¡æ•°å™¨ã€‚å¦‚æœæƒ³è¦ç­‰åˆ°è®¡æ•°å™¨ä¸º0ï¼Œåˆ™ä½¿ç”¨&lt;code&gt;Wait()&lt;/code&gt;é˜»å¡ç­‰å¾…å¹¶é‡Šæ”¾goroutineèµ„æºï¼Œè¿™éƒ¨åˆ†å†…å®¹åœ¨ &lt;a href=&#34;https://weedge.github.io/post/notions/go-tips/go-tips-09-concurrency-practice/#64%E4%BD%BF%E7%94%A8-select-%E5%92%8C-channels-%E6%9C%9F%E5%BE%85%E7%A1%AE%E5%AE%9A%E6%80%A7%E8%A1%8C%E4%B8%BA-%E9%87%8D%E8%A6%81&#34;&gt;#64&lt;/a&gt; tipsä¸­ä¹Ÿæœ‰æåˆ°ï¼Œå…·ä½“è§æºç å®¢è§‚åˆ†æï¼šhttps://github.com/golang/go/blob/go1.20/src/sync/waitgroup.go (ç»“åˆæµ‹è¯•ç”¨ä¾‹çœ‹ç–—æ•ˆæ›´å¥½)&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/golang/go/blob/go1.20/src/runtime/sema.go&#34;&gt;https://github.com/golang/go/blob/go1.20/src/runtime/sema.go&lt;/a&gt; (Semaphoreå®ç°ï¼Œ&lt;a href=&#34;https://swtch.com/semaphore.pdf&#34;&gt;ç±»ä¼¼Linuxçš„futexæœºåˆ¶&lt;/a&gt;)&lt;/p&gt;
&lt;p&gt;äº†è§£äº†WaitGroup,  ä¸éš¾ç†è§£ä¾‹å­ä¸­çš„ä»£ç é—®é¢˜ï¼Œå°†wg.Add(1)æ”¾åœ¨äº†goroutineæ‰§è¡Œçš„å‡½æ•°ä¸­ï¼Œè€Œæ²¡æœ‰åƒæ­£ç¡®æ–¹æ³•é‚£æ ·ï¼Œå°†Add(1)æ”¾åœ¨goroutineåˆ›å»ºå¯åŠ¨ä¹‹å‰ï¼Œè¿™æ ·ä¼šå¯¼è‡´å¯¹WaitGroupå†…éƒ¨è®¡æ•°å™¨å½¢æˆäº†æ•°æ®ç«äº‰ï¼Œå¾ˆå¯èƒ½å› goroutineè°ƒåº¦é—®é¢˜ï¼ŒAdd(1)è¿˜æœªæ¥çš„åŠè°ƒç”¨ï¼Œä»è€Œå¯¼è‡´Waitæå‰è¿”å›ï¼Œè¿™ç»„goroutineä¸­è¿˜æœ‰åœ¨æ‰§è¡Œä¸­çš„ã€‚&lt;/p&gt;
&lt;p&gt;åœ¨ è®ºæ–‡&lt;a href=&#34;https://arxiv.org/pdf/2204.00764.pdf&#34;&gt;A Study of Real-World Data Races in Golang&lt;/a&gt; ä¸­ è¿˜æåˆ°ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯goroutineä¸­æœ‰å¤šä¸ªdefer æ“ä½œï¼Œdefer Done æ“ä½œé¦–å…ˆæ‰§è¡Œäº†ï¼Œå¯¼è‡´å…¶ä»–deferæ“ä½œå¯èƒ½è¿˜æœªæ‰§è¡Œï¼ŒWaitå°±å·²ç»è¿”å›äº†ï¼Œå¯¼è‡´åé¢ä¾èµ–deferæ“ä½œä¸­çš„ç»“æœ,è¿›è¡Œåˆ¤æ–­å¤„ç†çš„é€»è¾‘ä¼šå‡ºé”™ã€‚&lt;/p&gt;
&lt;p&gt;tips: ä¸Šä¸€èŠ‚tipsä¸­æœ‰æåˆ°cpuæœ‰ä½¿ç”¨&lt;em&gt;å†…å­˜å±éšœ(memory barrier)&lt;/em&gt;ï¼ˆä¹Ÿç§°ä¸º&lt;em&gt;å†…å­˜æ …æ (memory fence)&lt;/em&gt;ï¼‰æ¥ç¡®ä¿é¡ºåºã€‚Go ä¸ºå®ç°å†…å­˜å±éšœå®šä¹‰äº†è¯­è¨€å±‚é¢çš„å†…å­˜æ¨¡å‹è§„èŒƒï¼Œè¿™é‡Œåœ¨ä½¿ç”¨çš„&lt;code&gt;sync.WaitGroup&lt;/code&gt;ï¼Œ&lt;code&gt;wg.Add&lt;/code&gt; å’Œ &lt;code&gt;wg.Wait&lt;/code&gt;ä¹‹é—´å­˜åœ¨ happens-before å…³ç³»ã€‚&lt;/p&gt;
&lt;p&gt;è¿™ä¸ªæ˜¯Goå¼€å‘äººå‘˜å¸¸è§é”™è¯¯ã€‚ä½¿ç”¨&lt;code&gt;sync.WaitGroup&lt;/code&gt;ï¼Œ&lt;code&gt;Add&lt;/code&gt;æ“ä½œå¿…é¡»åœ¨çˆ¶ goroutine ä¸­å¯åŠ¨ goroutine ä¹‹å‰å®Œæˆï¼Œè€Œ&lt;code&gt;Done&lt;/code&gt;æ“ä½œå¿…é¡»åœ¨ goroutine å†…å®Œæˆã€‚&lt;/p&gt;
&lt;h3 id=&#34;72å¿˜è®°-synccond&#34;&gt;72.å¿˜è®° sync.Cond&lt;/h3&gt;
&lt;p&gt;åœ¨åŒæ­¥åŸè¯­&lt;code&gt;sync&lt;/code&gt;åŒ…ä¸­ï¼Œ&lt;code&gt;sync.Cond&lt;/code&gt;å¯èƒ½æ˜¯æœ€å°‘ä½¿ç”¨å’Œç†è§£çš„ã€‚ä½†æ˜¯ï¼Œå®ƒæä¾›äº†æ— æ³•é€šè¿‡channelå®ç°çš„åŠŸèƒ½ã€‚å®ç°ç±»ä¼¼pub/sub çš„å¤šé€šé“å¹¿æ’­æœºåˆ¶ï¼Œå¯ä»¥è®¤ä¸ºpub/subæœºåˆ¶æ˜¯åŒ…æ‹¬äº†å•é€šé“å¹¿æ’­çš„ï¼Œsync.Condçš„å†…éƒ¨å®ç°ï¼Œå…¶ç»“æ„ä¸­L Locker ç”¨æ¥äº’æ–¥è®¿é—®æ¡ä»¶é€»è¾‘ï¼Œå¦‚æœæ¡ä»¶ä¸æˆç«‹ï¼Œåˆ™æ£€æµ‹æ˜¯å¦copyï¼Œcopyåˆ™ç›´æ¥panic, å¦åˆ™æ·»åŠ åˆ°é€šçŸ¥åˆ—è¡¨ä¸­ï¼Œè¿›è¡Œç­‰å¾…ï¼›å¦‚æœæ¡ä»¶æˆç«‹ï¼Œåˆ™æ‰§è¡Œå¯¹åº”é€»è¾‘ã€‚å”¤é†’æ–¹å¼åˆ†ä¸ºä¸¤ç§ï¼šSignal() å”¤é†’ç­‰å¾…é˜Ÿä¸­çš„ä¸€ä¸ªgoroutineæ¥æ‰§è¡Œåˆ¤æ–­ï¼› Broadcast å”¤é†’ç­‰å¾…é˜Ÿåˆ—ä¸­çš„å…¨éƒ¨goroutineæ¥æ‰§è¡Œå¯¹åº”åˆ¤æ–­é€»è¾‘ï¼›å…·ä½“è§æºç å®¢è§‚åˆ†æï¼šhttps://github.com/golang/go/blob/go1.20/src/sync/cond.go (ç»“åˆæµ‹è¯•ç”¨ä¾‹çœ‹ç–—æ•ˆæ›´å¥½)&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/golang/go/blob/go1.20/src/runtime/sema.go&#34;&gt;https://github.com/golang/go/blob/go1.20/src/runtime/sema.go&lt;/a&gt; (Semaphoreå®ç°ï¼Œ&lt;a href=&#34;https://swtch.com/semaphore.pdf&#34;&gt;ç±»ä¼¼Linuxçš„futexæœºåˆ¶&lt;/a&gt;)&lt;/p&gt;
&lt;p&gt;å¯¹äºSignal()æ–¹å¼ï¼Œå’Œä½¿ç”¨ channel chan struct{} éé˜»å¡å‘é€æ¶ˆæ¯ä¸€æ ·&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;nx&#34;&gt;ch&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;make&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;chan&lt;/span&gt; &lt;span class=&#34;kd&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{})&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;select&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;case&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;ch&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&#34;kd&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{}{}:&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;default&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;73ä¸ä½¿ç”¨errorgroup&#34;&gt;73.ä¸ä½¿ç”¨errorgroup&lt;/h3&gt;
&lt;p&gt;errorgroupè¿™ä¸ªåŒ…æ˜¯googleå¯¹goçš„ä¸€ä¸ªæ‰©å±•åŒ…ï¼š&lt;a href=&#34;https://pkg.go.dev/golang.org/x/sync/errgroup&#34;&gt;golang.org/x/sync/errgroup&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;tips: &lt;code&gt;golang.org/x&lt;/code&gt;æ˜¯ä¸€ä¸ªæä¾›æ ‡å‡†åº“æ‰©å±•çš„åº“ã€‚ä¸ºsyncåŒ…æ‰©å±•äº†ä¸€ä¸ªåŒ…ï¼šerrgroup&lt;/p&gt;
&lt;p&gt;å®ç°é€»è¾‘ç®€å•ï¼Œä¸»è¦æ˜¯é”™è¯¯å¤„ç†ï¼Œå¦‚æœå…¶ä¸­æœ‰ä¸€ä¸ªgoroutineæ‰§è¡Œé”™è¯¯ï¼Œåˆ™åªè®°å½•ç¬¬ä¸€æ¬¡goroutineæ‰§è¡Œçš„é”™è¯¯ï¼Œé€šè¿‡contextå‘ŠçŸ¥äº†cancelçŠ¶æ€ï¼Œè¿™ä¸ªéœ€è¦é€šè¿‡select+ctx.Done() æ„ŸçŸ¥åˆ°ï¼›å¹¶ä¸”é€šçŸ¥å¯¹åº”ä½¿ç”¨Wait()ç­‰å¾…å…¨éƒ¨goroutineæ‰§è¡Œå®Œæˆï¼Œå¹¶ä¸”è¿”å›è®°å½•çš„é”™è¯¯ï¼› åé¢åŠ å…¥sem chan struct{}(token)ï¼Œç”¨æ¥é™åˆ¶æœ€å¤§æ‰§è¡Œgoroutineæ•°ï¼Œé€šè¿‡SetLimitæ¥è®¾ç½®ï¼Œå¹¶ä¸”æä¾›äº†TryGo éé˜»å¡æ‰§è¡Œã€‚&lt;/p&gt;
&lt;p&gt;å¦‚æœæƒ³åŠ å…¥goroutineçš„æ‰§è¡Œè¶…æ—¶æ—¶é—´ï¼Œä¹Ÿæ˜¯å¯ä»¥åšåˆ°ï¼Œåªéœ€åœ¨ä½¿ç”¨errgroupå‰ï¼Œä½¿ç”¨cancelCtxå°±è¡Œï¼Œå¦‚ä¸‹ä»£ç ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;TestErrGroupWithTimeout&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;t&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;testing&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;T&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
	&lt;span class=&#34;nx&#34;&gt;ctx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;cancel&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;context&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;WithTimeout&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;context&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;TODO&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(),&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;5&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;time&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Second&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
	&lt;span class=&#34;k&#34;&gt;defer&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;cancel&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
	&lt;span class=&#34;nx&#34;&gt;group&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;ctx&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;errgroup&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;WithContext&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;ctx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
	&lt;span class=&#34;k&#34;&gt;for&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;i&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;i&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;10&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;++&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
		&lt;span class=&#34;nx&#34;&gt;index&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;i&lt;/span&gt;
		&lt;span class=&#34;nx&#34;&gt;group&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Go&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt; &lt;span class=&#34;kt&#34;&gt;error&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
			&lt;span class=&#34;k&#34;&gt;select&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
			&lt;span class=&#34;k&#34;&gt;case&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;lt;-&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;time&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;After&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;time&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Duration&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;index&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;time&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Second&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;):&lt;/span&gt;
				&lt;span class=&#34;nx&#34;&gt;fmt&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Printf&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;finished:%d\\n&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;index&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
				&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;kc&#34;&gt;nil&lt;/span&gt;
			&lt;span class=&#34;k&#34;&gt;case&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;lt;-&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;ctx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Done&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;():&lt;/span&gt;
				&lt;span class=&#34;nx&#34;&gt;fmt&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Printf&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;canceled:%d\\n&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;index&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
				&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;ctx&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Err&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
			&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
		&lt;span class=&#34;p&#34;&gt;})&lt;/span&gt;
	&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
	&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;err&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;group&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Wait&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;err&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;!=&lt;/span&gt; &lt;span class=&#34;kc&#34;&gt;nil&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
		&lt;span class=&#34;nx&#34;&gt;fmt&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Println&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;err&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
	&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;å½“ç„¶å¦‚æœæƒ³è·å–goroutineæ‰§è¡Œçš„å…¨éƒ¨é”™è¯¯åˆ™éœ€è¦é¢å¤–çš„é”™è¯¯æ•°ç»„æ¥æ”¯æŒï¼ŒGoä¸­çš„å‡½æ•°è¿”å›é”™è¯¯å¿…é¡»ä¸ºnilã€‚&lt;/p&gt;
&lt;h3 id=&#34;74å¤åˆ¶åŒæ­¥ç±»å‹-é‡è¦&#34;&gt;74.å¤åˆ¶åŒæ­¥ç±»å‹ ï¼ˆé‡è¦ï¼‰&lt;/h3&gt;
&lt;p&gt;syncåŒ…æä¾›åŸºæœ¬åŒæ­¥åŸè¯­ï¼Œä¾‹å¦‚ mutex, rwmutex, condition variableï¼Œwaitgroupï¼Œpoolï¼Œmapç­‰ã€‚å¯¹äºæ‰€æœ‰è¿™äº›ç»“æ„ä½“ï¼Œæœ‰ä¸€ä¸ªç¡¬æ€§è§„åˆ™è¦éµå¾ªï¼šå®ƒä»¬æ°¸è¿œä¸åº”è¯¥è¢«å¤åˆ¶ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªå¸¸è§çš„é”™è¯¯ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;kd&#34;&gt;type&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;Counter&lt;/span&gt; &lt;span class=&#34;kd&#34;&gt;struct&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
	&lt;span class=&#34;nx&#34;&gt;mu&lt;/span&gt;       &lt;span class=&#34;nx&#34;&gt;sync&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Mutex&lt;/span&gt;
	&lt;span class=&#34;c1&#34;&gt;// mu      *sync.Mutex
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;	&lt;span class=&#34;nx&#34;&gt;counters&lt;/span&gt; &lt;span class=&#34;kd&#34;&gt;map&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;string&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;

&lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;NewCounter&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;Counter&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
	&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;Counter&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;counters&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;kd&#34;&gt;map&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;string&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{}}&lt;/span&gt;
	&lt;span class=&#34;c1&#34;&gt;// return Counter{counters: map[string]int{}, mu: &amp;amp;sync.Mutex{}}
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;

&lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;c&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;Counter&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;Increment1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;name&lt;/span&gt; &lt;span class=&#34;kt&#34;&gt;string&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
	&lt;span class=&#34;nx&#34;&gt;c&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;mu&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Lock&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
	&lt;span class=&#34;k&#34;&gt;defer&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;c&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;mu&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Unlock&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
	&lt;span class=&#34;nx&#34;&gt;c&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;counters&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;++&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;c&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Counter&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;Increment2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;name&lt;/span&gt; &lt;span class=&#34;kt&#34;&gt;string&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
	&lt;span class=&#34;c1&#34;&gt;// Same code
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;main&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
	&lt;span class=&#34;nx&#34;&gt;counter&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;NewCounter&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;

	&lt;span class=&#34;k&#34;&gt;go&lt;/span&gt; &lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
		&lt;span class=&#34;nx&#34;&gt;counter&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Increment1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;foo&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
	&lt;span class=&#34;p&#34;&gt;}()&lt;/span&gt;
	&lt;span class=&#34;k&#34;&gt;go&lt;/span&gt; &lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
		&lt;span class=&#34;nx&#34;&gt;counter&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Increment1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;bar&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
	&lt;span class=&#34;p&#34;&gt;}()&lt;/span&gt;

	&lt;span class=&#34;nx&#34;&gt;time&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Sleep&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;10&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;time&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Millisecond&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;ç»“æ„ä½“æ¥å—è€…é‡‡ç”¨å€¼ä¼ é€’ï¼Œå¦‚æœä¸¤ä¸ªåç¨‹åŒæ—¶ä½¿ç”¨counter, ä¼šå¤åˆ¶ä¸€ä»½ç»“æ„ï¼Œä¹Ÿä¼šå¤åˆ¶äº’æ–¥é”ï¼Œå¯¼è‡´ä¸Šé”å¤±è´¥ï¼Œå¹¶å‘åœºæ™¯è¿è¡Œæ—¶å‡ºç°data race,  data raceå¯ä»¥ -race è¿›è¡Œæ£€æµ‹ï¼›&lt;/p&gt;
&lt;p&gt;é€šè¿‡linterç±»å‹å·¥å…·æ£€æŸ¥ï¼Œæ¯”å¦‚é™æ€ç¼–è¯‘æ£€æŸ¥vetï¼Œå¯ä»¥ç›´æ¥æ£€æŸ¥å‡ºæ¥è¿›è¡Œæç¤ºï¼Œ&lt;code&gt;passes lock by value&lt;/code&gt; or &lt;code&gt;assignment copies lock value to&lt;/code&gt; ï¼›ä¸€èˆ¬IDEå¼€å‘å·¥å…·å®‰è£…äº†é™æ€æ£€æŸ¥å·¥å…·å°±å¯ä»¥æ£€æŸ¥å‡ºæ¥æç¤º(å¦‚æœä¸æ‰«æé‡Œé¢çš„noCopyæˆå‘˜ï¼Œåˆ™æ‰«ä¸å‡ºæ¥é”™è¯¯è¿›è¡Œæç¤º)ï¼Œæœ€å¥½çš„åŠæ³•ç›´æ¥ä½¿ç”¨ go vet åœ¨CIé˜¶æ®µæ£€æŸ¥ï¼Œè¿›è€Œä¿è¯ä»£ç è´¨é‡ï¼›&lt;/p&gt;
&lt;p&gt;è¿™ä¸ªnoCopyçš„æ£€æµ‹æ˜¯æ€ä¹ˆåšåˆ°çš„å‘¢ï¼Ÿåªè¦æ˜¯å®ç°äº†Locker æ¥å£çš„Lock()å’ŒUnlock()æ–¹æ³•çš„ç»“æ„ä½“ï¼Œæˆ–è€…ç»“æ„ä½“æˆå‘˜å®ç°äº†Lockeræ¥å£ï¼Œåˆ™å¯ä»¥é€šè¿‡go vetåŠŸèƒ½ï¼Œæ¥æ£€æŸ¥ä»£ç ä¸­è¯¥å¯¹è±¡æ˜¯å¦æœ‰è¢«copyï¼›æ¯”å¦‚è‡ªå®šä¹‰çš„ç»“æ„ä½“åŒ…æ¶µå€¼ä¼ é€’æˆå‘˜noCopyï¼ŒnoCopyç»“æ„ä½“å®ç°äº†Lockeræ¥å£ï¼Œåˆ™é€šè¿‡go vetæ£€æŸ¥æ˜¯å¦copy&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;c1&#34;&gt;// noCopy may be added to structs which must not be copied
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// after the first use.
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;//
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// See **&amp;lt;https://golang.org/issues/8005#issuecomment-190753527**&amp;gt;
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// for details.
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;//
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// Note that it must not be embedded, due to the Lock and Unlock methods.
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;type&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;noCopy&lt;/span&gt; &lt;span class=&#34;kd&#34;&gt;struct&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{}&lt;/span&gt;

&lt;span class=&#34;c1&#34;&gt;// Lock is a no-op used by -copylocks checker from `go vet`.
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;noCopy&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;Lock&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;   &lt;span class=&#34;p&#34;&gt;{}&lt;/span&gt;
&lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;noCopy&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;Unlock&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{}&lt;/span&gt;
&lt;span class=&#34;kd&#34;&gt;type&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;MyStruct&lt;/span&gt; &lt;span class=&#34;kd&#34;&gt;struct&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
   &lt;span class=&#34;nx&#34;&gt;noValCopy&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;noCopy&lt;/span&gt;
   &lt;span class=&#34;c1&#34;&gt;// Copy *noCopy
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;æ¯å½“å¤šä¸ª goroutine è®¿é—®ä¸€ä¸ªåŒæ­¥å…±äº«å…ƒç´ ï¼Œå¿…é¡»ç¡®ä¿å®ƒä»¬éƒ½ä¾èµ–äºåŒä¸€ä¸ªå®ä¾‹ã€‚æ­¤è§„åˆ™é€‚ç”¨äºå®šä¹‰çš„æ‰€æœ‰åŒæ­¥ç±»å‹ã€‚å¯ä»¥ä½¿ç”¨æŒ‡é’ˆè§£å†³è¿™ä¸ªé—®é¢˜ï¼Œç»“æ„ä¼ é€’è€…å¯¹è±¡æ˜¯æŒ‡é’ˆï¼Œæˆ–è€…ç»“æ„æˆå‘˜ä¸­çš„åŒæ­¥å…±äº«å…ƒç´ æ˜¯æŒ‡é’ˆç±»å‹ã€‚æœ¬è´¨ä¸Šæ˜¯å€¼ä¼ é€’å’ŒæŒ‡é’ˆä¼ é€’çš„é—®é¢˜ã€‚&lt;/p&gt;
&lt;h2 id=&#34;æ¦‚æ‹¬&#34;&gt;æ¦‚æ‹¬&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;äº†è§£contextä½•æ—¶å¯ä»¥å–æ¶ˆåœ¨ä¼ æ’­å®ƒæ—¶éœ€è¦æ³¨æ„ï¼Œé¿å…å–æ¶ˆå¯¼è‡´æœªæ‰§è¡Œå®Œï¼šä¾‹å¦‚ï¼ŒHTTP å¤„ç†ç¨‹åºåœ¨å‘é€å“åº”åå–æ¶ˆcontextã€‚&lt;/li&gt;
&lt;li&gt;é¿å…æ³„æ¼æ„å‘³ç€è¦æ³¨æ„ï¼Œæ— è®ºä½•æ—¶å¯åŠ¨ goroutineï¼Œéƒ½åº”è¯¥æœ‰ä¸€ä¸ªæœ€ç»ˆåœæ­¢å®ƒçš„è®¡åˆ’ã€‚&lt;/li&gt;
&lt;li&gt;ä¸ºäº†é¿å… goroutines å’Œå¾ªç¯å˜é‡çš„é”™è¯¯ï¼Œåˆ›å»ºå±€éƒ¨å˜é‡æˆ–è°ƒç”¨å‡½æ•°è€Œä¸æ˜¯é—­åŒ…ã€‚&lt;/li&gt;
&lt;li&gt;å¦‚æœå¤šä¸ªé€‰é¡¹æ˜¯å¯èƒ½çš„ï¼Œé‚£ä¹ˆç†è§£&lt;code&gt;select&lt;/code&gt;å¤šé€šé“éšæœºé€‰æ‹©æ¡ˆä¾‹å¯ä»¥é˜²æ­¢åšå‡ºå¯èƒ½å¯¼è‡´å¾®å¦™çš„å¹¶å‘é”™è¯¯ã€‚&lt;/li&gt;
&lt;li&gt;ä½¿ç”¨&lt;code&gt;chan struct{}&lt;/code&gt;ç±»å‹å‘é€é€šçŸ¥ã€‚&lt;/li&gt;
&lt;li&gt;ä½¿ç”¨ nil channelåº”è¯¥æˆä¸ºå¹¶å‘å·¥å…·é›†çš„ä¸€éƒ¨åˆ†ï¼Œä»selectè¯­å¥ä¸­ç§»é™¤æ“ä½œchannel çš„ caseã€‚&lt;/li&gt;
&lt;li&gt;è€ƒè™‘åˆ°é—®é¢˜ï¼Œä»”ç»†å†³å®šè¦ä½¿ç”¨çš„æ­£ç¡®channelç±»å‹ã€‚åªæœ‰æ— ç¼“å†²é€šé“æ‰èƒ½æä¾›å¼ºå¤§çš„åŒæ­¥ä¿è¯ã€‚&lt;/li&gt;
&lt;li&gt;åº”è¯¥æœ‰å……åˆ†çš„ç†ç”±ä¸ºç¼“å†²é€šé“æŒ‡å®šé€šé“å¤§å°ã€‚&lt;/li&gt;
&lt;li&gt;æ„è¯†åˆ°å­—ç¬¦ä¸²æ ¼å¼å¯èƒ½ä¼šå¯¼è‡´è°ƒç”¨ç°æœ‰å‡½æ•°æ„å‘³ç€è¦æ³¨æ„å¯èƒ½çš„æ­»é”å’Œå…¶ä»–æ•°æ®ç«äº‰ã€‚&lt;/li&gt;
&lt;li&gt;å¹¶å‘ appendå¹¶ä¸æ€»æ˜¯æ²¡æœ‰æ•°æ®ç«äº‰ï¼›å› æ­¤ï¼Œä¸åº”åœ¨å…±äº«åˆ‡ç‰‡ä¸ŠåŒæ—¶ä½¿ç”¨å®ƒã€‚&lt;/li&gt;
&lt;li&gt;äº†è§£sliceå’Œmapç»“æ„ä½“ï¼Œå…·ä½“åº•å±‚æ•°æ®ç»“æ„ï¼›å¯¹é˜²æ­¢å¸¸è§çš„æ•°æ®ç«äº‰å¤„ç†æœ‰æ‰€å¸®åŠ©ã€‚&lt;/li&gt;
&lt;li&gt;è¦å‡†ç¡®ä½¿ç”¨&lt;code&gt;sync.WaitGroup&lt;/code&gt;ï¼Œ&lt;code&gt;Add&lt;/code&gt;åœ¨å¯åŠ¨ goroutine ä¹‹å‰è°ƒç”¨è¯¥æ–¹æ³•ã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;sync.Cond&lt;/code&gt;å¯ä»¥ä½¿ç”¨ å¹¿æ’­æ–¹å¼å‘å¤šä¸ª goroutines å‘é€é‡å¤çš„é€šçŸ¥(å”¤é†’)ï¼Œä¹Ÿå¯ä»¥å•æ’­æ–¹å¼æƒ³ä¸€ä¸ªgoroutineå‘é€é€šçŸ¥(å”¤é†’)ã€‚&lt;/li&gt;
&lt;li&gt;å¯ä»¥åŒæ­¥ä¸€ç»„ goroutines å¹¶ä½¿ç”¨&lt;code&gt;errgroup&lt;/code&gt;åŒ…å¤„ç†é”™è¯¯å’Œcontextã€‚&lt;/li&gt;
&lt;li&gt;åŒæ­¥åŸè¯­ç±»å‹æˆ–è€…è‡ªå®šç±»å‹ç»“æ„ä¸åº”copyã€‚&lt;/li&gt;
&lt;/ul&gt;</description>
      
    </item>
    
    <item>
      <title>Go tips-ç¬”è®°: å¹¶å‘æ¦‚å¿µ 55-60 mistakes</title>
      <link>https://weedge.github.io/post/notions/go-tips/go-tips-08-concurrency-foundations/</link>
      <pubDate>Fri, 17 Feb 2023 14:26:23 +0800</pubDate>
      
      <guid>https://weedge.github.io/post/notions/go-tips/go-tips-08-concurrency-foundations/</guid>
      
        <description>&lt;h2 id=&#34;ç¬”è®°&#34;&gt;ç¬”è®°&lt;/h2&gt;
&lt;h3 id=&#34;55æ··æ·†å¹¶å‘å’Œå¹¶è¡Œ&#34;&gt;55.æ··æ·†å¹¶å‘å’Œå¹¶è¡Œ&lt;/h3&gt;
&lt;p&gt;è¿™ä¸ªåœ¨å¤„ç†å¤§æ•°æ®çš„åœºæ™¯ä¸­ç»å¸¸å¯ä»¥çœ‹åˆ°ï¼Œå¯ä»¥è¿™ä¹ˆæŠ½è±¡ï¼Œæ¯”å¦‚å°†ä¸€ä¸ªjob åˆ†æˆ å¾ˆå¤šçš„ task äº‹ä»¶ï¼Œ æ¯”å¦‚ è¯»å–æ–‡ä»¶ task, åˆ‡å‰²æ–‡ä»¶task, map key task, shuffle key taskï¼Œreduce key taskï¼Œsink task ç­‰ç­‰ï¼Œå¦‚æœè¿™ä¸ªjob ä¸²è¡Œæ‰§è¡Œï¼ŒåŒæ­¥å¤„ç†task, æ•ˆç‡ä¼šå¾ˆä½ï¼Œcpuèµ„æºä¹Ÿä¸ä¼šå……åˆ†åˆ©ç”¨ï¼Œæ¯”å¦‚æ–‡ä»¶io,ç½‘ç»œioï¼Œç³»ç»Ÿç¼ºé¡µä¸­æ–­éƒ½ä¼šåç”Ÿç³»ç»Ÿè°ƒç”¨(åŒæ­¥æˆ–è€…å¼‚æ­¥)ï¼Œè¿™æ ·cpuå¯èƒ½ç©ºé—²å‡ºæ¥äº†ï¼Œä¸²è¡Œæ‰§è¡Œçš„è¯ï¼Œ éœ€è¦ç­‰å¾…è¿™æ¬¡ç³»ç»Ÿè°ƒç”¨å¤„ç†å®Œä¹‹åæ‰èƒ½ç»§ç»­ä½¿ç”¨cpu, æ‰€ä»¥å¤„ç†èµ·æ¥å¾ˆæ…¢ï¼Œååé‡å¾ˆä½ï¼› å¦‚æœæ”¹æˆå¹¶å‘(å–å†³äºæ“ä½œç³»ç»Ÿè°ƒåº¦ï¼ŒåŸºäºæ—¶é—´ç‰‡è½®è®­æŠ¢å å¼è°ƒåº¦)ï¼Œå°†jobè¿›ç¨‹åˆ†æˆçš„å¤šä¸ªtaskäº‹ä»¶ä¸€åŒå·¥ä½œï¼Œå¦‚æœæŸä¸ªtaskå‘ç”Ÿäº†ç³»ç»Ÿä¸­æ–­ï¼Œåˆ™å¯ä»¥è®©å‡ºcpuç»™å¦å¤–ä¸€ä¸ªtaskæ¥æ‰§è¡Œï¼Œæ¯”å¦‚è¯»å–æ–‡ä»¶io.Readerï¼Œsink io.Writerå†™å…¥æ–‡ä»¶æ—¶äº§ç”Ÿäº†ç³»ç»Ÿä¸­æ–­ï¼Œåˆ™å¯ä»¥ä¿å­˜ä¸Šä¸‹æ–‡è®©å‡ºcpuç»™å…¶ä»–taskæ¥æ‰§è¡Œï¼Œè¿™æ ·å¯ä»¥å……åˆ†åˆ©ç”¨cpuèµ„æºï¼Œæé«˜åå(è¿™é‡Œtaskä¸èƒ½å¤ªå¤š,æ¶‰åŠåˆ°ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œåè€Œä¼šé™ä½ååï¼Œéœ€è¦éœ€è¦ç”¨æˆ·åˆç†ç¼–æ’è¿è¡Œæ—¶ç»“æ„)ï¼›å½“cpuåˆ©ç”¨ä¸Šäº†ï¼Œé‚£å°±ä½¿ç”¨å¤šæ ¸cpuæ¥åŒæ—¶å¤„ç†ï¼Œè¿›ä¸€æ­¥æé«˜åå(å¤šæ ¸æ¶‰åŠåˆ°åº•å±‚ &lt;a href=&#34;https://fgiesen.wordpress.com/2014/07/07/cache-coherency/&#34;&gt;&lt;strong&gt;cpu cacheä¸€è‡´æ€§&lt;/strong&gt;&lt;/a&gt; é—®é¢˜)ï¼›å•æœºååä¸Šæ¥äº†ï¼Œå¦‚æœæ•°æ®é‡éå¸¸å¤§ï¼Œå•æœºä¼˜åŒ–å·²ç»æ— æ³•å­˜æ”¾è¿™ä¹ˆå¤šæ•°æ®äº†ï¼Œé‚£å°±copyå¤šå°æœºå™¨åˆ†å¸ƒå¼è¿›è¡Œå¤„ç†(å•æœºå˜å¤šæœºï¼ŒååŒå’Œç½‘ç»œé—®é¢˜)ï¼›ç¬¬ä¸€æ¬¡æå‡ä½¿ç”¨çš„å°±æ˜¯å°†jobåˆ‡æˆå¤šä¸ªtaskä¸€èµ·æ¥å¤„ç†ï¼Œå°±æ˜¯ä½¿ç”¨å¹¶å‘æœºåˆ¶å……åˆ†cpuèµ„æºï¼›ç¬¬äºŒæ¬¡æå‡åˆ™æ˜¯ä½¿ç”¨å¤šæ ¸ï¼Œå¢åŠ cpuèµ„æºï¼Œå°†å¤šä¸ªtaskåˆ†é…åˆ°cpuä¸ŠåŒæ—¶ä¸€èµ·åš(æ‰§è¡Œ)ï¼Œå³æ‰€è°“çš„å¹¶è¡Œï¼Œè¿™æ ·å¯ä»¥å•æœºå‚ç›´æ‰©å®¹æå‡ååäº†ï¼›å³ä½¿å­˜åœ¨æ‘©å°”å®šå¾‹ï¼Œä½†æ˜¯å•æœºè¿˜æ˜¯æœ‰é™åˆ¶ï¼›æ•°æ®æ— æé™ï¼Œé‚£å¤„ç†ä¹Ÿéœ€è¦æ— æé™ï¼Œcopyå¤šå°æœºå™¨ï¼Œç»„æˆé›†ç¾¤ï¼Œå°†å•æœºä»»åŠ¡åˆ†å‘åˆ°å¤šé›†ç¾¤ä¸Šè¿›è¡Œè°ƒåº¦æ‰§è¡Œï¼Œå……åˆ†åˆ©ç”¨å¹¶å‘å¹¶è¡Œï¼Œåˆ©ç”¨è®¡ç®—å’Œå­˜å‚¨èµ„æºï¼Œæ°´å¹³æ‰©å®¹ï¼Œè¿™æ ·å°±æ²¡æœ‰èµ„æºä¸Šçš„é™åˆ¶äº†(éœ€è¦è€ƒè™‘èµ„æºçš„å……åˆ†åˆ©ç”¨ï¼Œå› ä¸ºæˆæœ¬ä¸Šå»äº†å˜›ï¼›å½“ç„¶&lt;a href=&#34;https://www.intel.com/content/www/us/en/products/docs/processors/what-is-a-gpu.html&#34;&gt;GPU&lt;/a&gt;çš„åˆ©ç”¨åº”è¯¥åŒæ ·é€‚ç”¨ï¼Œå¹¶è¡Œèƒ½åŠ›æ›´å¼ºï¼Œä½†æ˜¯å•æ ¸è®¡ç®—èƒ½åŠ›ç›¸å¯¹cpuå¼±)ã€‚åœ¨å¹¶å‘å¹¶è¡Œå¤„ç†æ—¶ï¼Œtaskä¹‹é—´å¿…ç„¶ä¼šå­˜åœ¨ååŒå…³ç³»ï¼Œå½¼æ­¤åˆ†å·¥åˆä½œï¼Œåˆ™éœ€è¦æ²Ÿé€šï¼Œå…±åŒå¤„ç†å…±äº«èµ„æºï¼Œå­˜åœ¨ç«äº‰ï¼ŒCSPç†è®ºä¸­æå€¡é€šè¿‡æ²Ÿé€šæ¥å…±äº«èµ„æºï¼Œåœ¨Goä¸­é€šè¿‡channelæ¥ååŒï¼Œä¹Ÿæœ‰ç›¸å…³syncåº“æ¥å¤„ç†åŒæ­¥ï¼›åˆ†å¸ƒå¼å¤šæœºæ²Ÿé€šåˆ™é€šè¿‡rpcå’Œæ¶ˆæ¯é˜Ÿåˆ—ï¼›å…¶ä¸­æ¶‰åŠåˆ°åˆ†å¸ƒå¼è°ƒåº¦å’Œè®¡ç®—ã€‚ è¿™ç§å¹¶å‘å’Œå¹¶è¡Œæ¨¡å¼åœ¨å¼€åº—åšç”Ÿæ„ï¼Œé“¶è¡Œæ’é˜Ÿï¼Œå·¥å‚æµæ°´çº¿ä¸­éƒ½å¯ä»¥çœ‹åˆ°ç›¸åŒçš„å¤„ç†æ¨¡å¼ã€‚&lt;/p&gt;
&lt;p&gt;å›åˆ°æ­£é¢˜ï¼Œå¼•ç”¨Goè®¾è®¡è€…çš„ä¸€å¥è¯æ¦‚æ‹¬ï¼š&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;em&gt;Concurrency is about dealing with lots of things at once. Parallelism is about doing lots of things at once.&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;â€”Rob Pike&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;å¹¶å‘æ˜¯ä¸€æ¬¡å¤„ç†å¾ˆå¤šäº‹æƒ…ï¼Œå¹¶è¡Œæ˜¯ä¸€æ¬¡æ‰§è¡Œåšå¾ˆå¤šäº‹æƒ…ï¼›&lt;/p&gt;
&lt;p&gt;å¹¶å‘å’Œå¹¶è¡Œæ˜¯ä¸åŒçš„ã€‚å¹¶å‘æ˜¯å…³äºç»“æ„çš„ï¼Œå¯ä»¥é€šè¿‡å¼•å…¥åˆ†ç¦»å¹¶å‘çº¿ç¨‹å¯ä»¥å¤„ç†çš„ä¸åŒæ­¥éª¤ï¼Œå°†é¡ºåºå®ç°æ›´æ”¹ä¸ºå¹¶å‘å®ç°ã€‚åŒæ—¶ï¼Œå¹¶è¡Œæ€§æ˜¯å…³äºæ‰§è¡Œçš„ï¼Œå¯ä»¥é€šè¿‡æ·»åŠ æ›´å¤šå¹¶è¡Œçº¿ç¨‹åœ¨æ­¥éª¤çº§åˆ«ä½¿ç”¨å®ƒã€‚ç†è§£è¿™ä¸¤ä¸ªæ¦‚å¿µæ˜¯æˆä¸ºä¸€åç†Ÿç»ƒçš„ Gopher çš„åŸºç¡€ã€‚&lt;/p&gt;
&lt;p&gt;é™„ï¼š&lt;strong&gt;&lt;a href=&#34;https://go.dev/blog/waza-talk&#34;&gt;Concurrency is not parallelism&lt;/a&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;h3 id=&#34;56è®¤ä¸ºå¹¶å‘æ€»æ˜¯æ›´å¿«&#34;&gt;56.è®¤ä¸ºå¹¶å‘æ€»æ˜¯æ›´å¿«&lt;/h3&gt;
&lt;p&gt;åœ¨è€ƒè™‘å¹¶å‘æ€§æ—¶ï¼Œæœ‰ä¸¤ç§ç±»å‹çš„å·¥ä½œè´Ÿè½½éœ€è¦ç†è§£ã€‚&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;CPU-Bound&lt;/strong&gt;ï¼šæ˜¯ä¸€ç§æ°¸è¿œä¸ä¼šé€ æˆ Goroutines è‡ªç„¶åœ°è¿›å…¥å’Œé€€å‡ºç­‰å¾…çŠ¶æ€çš„æƒ…å†µçš„å·¥ä½œè´Ÿè½½ã€‚æ˜¯ä¸æ–­è¿›è¡Œè®¡ç®—çš„jobã€‚å°† Pi è®¡ç®—åˆ°ç¬¬ N ä½çš„çº¿ç¨‹å°†å— CPU-Boundã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;IO-Bound&lt;/strong&gt;ï¼šæ˜¯ä¸€ç§å¯¼è‡´ Goroutines è‡ªç„¶è¿›å…¥ç­‰å¾…çŠ¶æ€çš„å·¥ä½œè´Ÿè½½ã€‚åŒ…æ‹¬è¯·æ±‚é€šè¿‡ç½‘ç»œè®¿é—®èµ„æºï¼Œæˆ–å¯¹æ“ä½œç³»ç»Ÿè¿›è¡Œç³»ç»Ÿè°ƒç”¨(åŒæ­¥/å¼‚æ­¥)ï¼Œæˆ–ç­‰å¾…äº‹ä»¶å‘ç”Ÿã€‚éœ€è¦è¯»å–æ–‡ä»¶çš„ Goroutine æ˜¯ IO-Boundã€‚å°†å¯¼è‡´ Goroutine ç­‰å¾…çš„åŒæ­¥äº‹ä»¶ï¼ˆäº’æ–¥é”ã€åŸå­ï¼‰åŒ…å«åœ¨è¯¥ç±»åˆ«ä¸­ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;å¯¹äºå—CPU-Boundçš„å·¥ä½œè´Ÿè½½ï¼Œéœ€è¦å¹¶è¡Œæ€§æ¥åˆ©ç”¨å¹¶å‘æ€§ã€‚å¤„ç†å¤šä¸ª Goroutines çš„å•ä¸ªæ“ä½œç³»ç»Ÿ/ç¡¬ä»¶çº¿ç¨‹æ•ˆç‡ä¸é«˜ï¼Œå› ä¸º Goroutines ä¸ä¼šä½œä¸ºå…¶å·¥ä½œè´Ÿè½½çš„ä¸€éƒ¨åˆ†è¿›å…¥å’Œé€€å‡ºç­‰å¾…çŠ¶æ€ã€‚æ‹¥æœ‰æ¯”æ“ä½œç³»ç»Ÿ/ç¡¬ä»¶çº¿ç¨‹æ›´å¤šçš„ Goroutine ä¼šå‡æ…¢å·¥ä½œè´Ÿè½½çš„æ‰§è¡Œé€Ÿåº¦ï¼Œå› ä¸ºå°† Goroutine ç§»å…¥å’Œç§»å‡ºæ“ä½œç³»ç»Ÿçº¿ç¨‹ä¼šäº§ç”Ÿå»¶è¿Ÿæˆæœ¬ï¼ˆèŠ±è´¹çš„æ—¶é—´ï¼‰ã€‚ä¸Šä¸‹æ–‡åˆ‡æ¢æ­£åœ¨ä¸ºå·¥ä½œåˆ›å»ºä¸€ä¸ªâ€œStop The Worldâ€äº‹ä»¶ï¼Œå› ä¸ºåœ¨åˆ‡æ¢æœŸé—´ä»»ä½•å·¥ä½œè´Ÿè½½éƒ½æ²¡æœ‰è¢«æ‰§è¡Œï¼Œå¦åˆ™å®ƒå¯èƒ½ä¼šè¢«æ‰§è¡Œã€‚&lt;/p&gt;
&lt;p&gt;å¯¹äºå—IO-Boundçš„å·¥ä½œè´Ÿè½½ï¼Œä¸éœ€è¦å¹¶è¡Œæ€§æ¥ä½¿ç”¨å¹¶å‘ã€‚å•ä¸ªæ“ä½œç³»ç»Ÿ/ç¡¬ä»¶çº¿ç¨‹å¯ä»¥é«˜æ•ˆåœ°å¤„ç†å¤šä¸ª Goroutinesï¼Œå› ä¸º Goroutines ä½œä¸ºå…¶å·¥ä½œè´Ÿè½½çš„ä¸€éƒ¨åˆ†è‡ªç„¶åœ°è¿›å…¥å’Œé€€å‡ºç­‰å¾…çŠ¶æ€ã€‚æ‹¥æœ‰æ¯”æ“ä½œç³»ç»Ÿ/ç¡¬ä»¶çº¿ç¨‹æ›´å¤šçš„ Goroutine å¯ä»¥åŠ å¿«å·¥ä½œè´Ÿè½½çš„æ‰§è¡Œé€Ÿåº¦ï¼Œå› ä¸ºå°† Goroutine ç§»å…¥å’Œç§»å‡ºæ“ä½œç³»ç»Ÿçº¿ç¨‹çš„å»¶è¿Ÿæˆæœ¬ä¸ä¼šäº§ç”Ÿâ€œStop The Worldâ€äº‹ä»¶ã€‚å·¥ä½œè´Ÿè½½è‡ªç„¶åœæ­¢ï¼Œè¿™å…è®¸ä¸åŒçš„ Goroutine æœ‰æ•ˆåœ°åˆ©ç”¨ç›¸åŒçš„æ“ä½œç³»ç»Ÿ/ç¡¬ä»¶çº¿ç¨‹ï¼Œè€Œä¸æ˜¯è®©æ“ä½œç³»ç»Ÿ/ç¡¬ä»¶çº¿ç¨‹é—²ç½®ã€‚&lt;/p&gt;
&lt;p&gt;æ€ä¹ˆçŸ¥é“æ¯ä¸ªç¡¬ä»¶çº¿ç¨‹æœ‰å¤šå°‘ Goroutines æä¾›æœ€ä½³ååé‡ï¼ŸGoroutines å¤ªå°‘ï¼Œæœ‰æ›´å¤šçš„ç©ºé—²æ—¶é—´ï¼›å¤ªå¤šçš„ Goroutines æœ‰æ›´å¤šçš„ä¸Šä¸‹æ–‡åˆ‡æ¢å»¶è¿Ÿæ—¶é—´ã€‚å¦‚æœä¸ç¡®å®šæ˜¯å¦å¹¶å‘ä¼šæ›´å¿«ï¼Œæ­£ç¡®çš„æ–¹æ³•å¯èƒ½æ˜¯ä»ä¸€ä¸ªç®€å•çš„é¡ºåºç‰ˆæœ¬å¼€å§‹ï¼Œç„¶åä½¿ç”¨åˆ†æå’ŒåŸºå‡†æµ‹è¯•ï¼Œè¿›è¡Œè°ƒä¼˜ã€‚&lt;/p&gt;
&lt;p&gt;é™„ï¼š &lt;a href=&#34;https://www.ardanlabs.com/blog/2018/12/scheduling-in-go-part3.html&#34;&gt;&lt;strong&gt;Scheduling In Go : Part III - Concurrency&lt;/strong&gt;&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&#34;57å¯¹ä½•æ—¶ä½¿ç”¨channelæˆ–mutexæ„Ÿåˆ°å›°æƒ‘&#34;&gt;57.å¯¹ä½•æ—¶ä½¿ç”¨channelæˆ–mutexæ„Ÿåˆ°å›°æƒ‘&lt;/h3&gt;
&lt;p&gt;channelæœ€é€‚åˆGoroutineä¹‹é—´ä¼ é€’æ•°æ®æ‰€æœ‰æƒã€åˆ†é…å·¥ä½œå•å…ƒå’Œä¼ è¾¾å¼‚æ­¥ç»“æœç­‰æƒ…å†µï¼Œé€šè¿‡æ²Ÿé€šæ¥å…±äº«èµ„æºï¼›&lt;/p&gt;
&lt;p&gt;æƒ³è¦å…±äº«çŠ¶æ€æˆ–è®¿é—®å…±äº«èµ„æºæ—¶ï¼ŒsyncåŒ…ä¸­çš„mutexäº’æ–¥é”åŒæ­¥åŸè¯­ä¼šç¡®ä¿å¯¹è¯¥èµ„æºçš„ç‹¬å è®¿é—®ã€‚è™½ç„¶channelä¹Ÿå¯ä»¥ä¿è¯å…±äº«èµ„æºçš„äº’æ–¥è®¿é—®ï¼Œä½†æ˜¯ä¸mutexç›¸æ¯”ï¼Œchannel ä¼šå¯¼è‡´æ€§èƒ½ä¸‹é™ï¼›å½“åªéœ€è¦é”å®šå°‘é‡å…±äº«èµ„æºæ—¶ï¼Œä½¿ç”¨ mutex éå¸¸æœ‰ç”¨ã€‚&lt;/p&gt;
&lt;h3 id=&#34;58ä¸ç†è§£ç«äº‰raceé—®é¢˜&#34;&gt;58.ä¸ç†è§£ç«äº‰raceé—®é¢˜&lt;/h3&gt;
&lt;p&gt;å½“åˆ™ç¼–å†™çš„å¹¶å‘åº”ç”¨ç¨‹åºä¸­å·¥ä½œæ—¶ï¼Œäº†è§£æ•°æ®ç«äº‰ data race ä¸åŒäºç«äº‰æ¡ä»¶ data condition æ˜¯å¾ˆé‡è¦çš„ã€‚å½“å¤šä¸ª goroutine åŒæ—¶è®¿é—®åŒä¸€å†…å­˜ä½ç½®å¹¶ä¸”å…¶ä¸­è‡³å°‘ä¸€ä¸ªæ­£åœ¨å†™å…¥æ—¶ï¼Œå°±ä¼šå‘ç”Ÿæ•°æ®ç«äº‰ã€‚æ•°æ®ç«äº‰æ„å‘³ç€æ„å¤–è¡Œä¸ºã€‚ä½†æ˜¯ï¼Œæ— æ•°æ®ç«äº‰çš„åº”ç”¨ç¨‹åºå¹¶ä¸ä¸€å®šæ„å‘³ç€ç¡®å®šæ€§ç»“æœã€‚ä¸€ä¸ªåº”ç”¨ç¨‹åºå¯ä»¥æ²¡æœ‰æ•°æ®ç«äº‰ï¼Œä½†ä»ç„¶æœ‰ä¾èµ–äºä¸å—æ§åˆ¶çš„äº‹ä»¶çš„è¡Œä¸ºï¼ˆä¾‹å¦‚ goroutine æ‰§è¡Œï¼Œæ¶ˆæ¯å‘å¸ƒåˆ°é€šé“çš„é€Ÿåº¦ï¼Œæˆ–è€…å¯¹æ•°æ®åº“çš„è°ƒç”¨æŒç»­å¤šé•¿æ—¶é—´ï¼‰ï¼Œè¿™æ˜¯ä¸€ä¸ªç«äº‰æ¡ä»¶ã€‚ç†è§£è¿™ä¸¤ä¸ªæ¦‚å¿µå¯¹äºç²¾é€šå¹¶å‘åº”ç”¨ç¨‹åºçš„è®¾è®¡è‡³å…³é‡è¦ã€‚&lt;/p&gt;
&lt;h4 id=&#34;go-å†…å­˜æ¨¡å‹&#34;&gt;Go å†…å­˜æ¨¡å‹&lt;/h4&gt;
&lt;p&gt;Go å†…å­˜æ¨¡å‹æ˜¯ä¸€ç§è§„èŒƒï¼Œå®ƒå®šä¹‰äº†åœ¨ä¸åŒçš„ goroutine ä¸­å†™å…¥ç›¸åŒå˜é‡åå¯ä»¥ä¿è¯ä»ä¸€ä¸ª goroutine ä¸­çš„å˜é‡è¯»å–çš„æ¡ä»¶. æ¢å¥è¯è¯´ï¼ŒGoå¼€å‘äººå‘˜åº”ç‰¢è®°å†…å­˜æ¨¡å‹è§„èŒƒï¼Œé¿å…åšå‡ºå¯èƒ½å¯¼è‡´æ•°æ®ç«äº‰ã€ç«äº‰æ¡ä»¶çš„é”™è¯¯å‡è®¾ã€‚å…·ä½“ç»†èŠ‚ï¼š&lt;a href=&#34;https://research.swtch.com/gomm&#34;&gt;https://research.swtch.com/gomm&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;tips: ç”±äºå¤šæ ¸å¤„ç†å™¨cpuä¹‹é—´ç‹¬ç«‹çš„L1/L2 cacheï¼Œä¼šå‡ºç°cache lineä¸ä¸€è‡´çš„é—®é¢˜ï¼Œä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæœ‰ç›¸å…³åè®®æ¨¡å‹ï¼Œæ¯”å¦‚MESIåè®®æ¥ä¿è¯cacheæ•°æ®ä¸€è‡´ï¼ŒåŒæ—¶ç”±äºCPUå¯¹ã€Œç¼“å­˜ä¸€è‡´æ€§åè®®ã€è¿›è¡Œçš„å¼‚æ­¥ä¼˜åŒ–ï¼Œå¯¹å†™å’Œè¯»åˆ†åˆ«å¼•å…¥äº†ã€Œstore bufferã€å’Œã€Œinvalid queueã€ï¼Œå¾ˆå¯èƒ½å¯¼è‡´åé¢çš„æŒ‡ä»¤æŸ¥ä¸åˆ°å‰é¢æŒ‡ä»¤çš„æ‰§è¡Œç»“æœï¼ˆå„ä¸ªæŒ‡ä»¤çš„æ‰§è¡Œé¡ºåºéä»£ç æ‰§è¡Œé¡ºåºï¼‰ï¼Œè¿™ç§ç°è±¡å¾ˆå¤šæ—¶å€™è¢«ç§°ä½œã€ŒCPUä¹±åºæ‰§è¡Œã€ï¼Œä¸ºäº†è§£å†³ä¹±åºé—®é¢˜ï¼ˆä¹Ÿå¯ä»¥ç†è§£ä¸ºå¯è§æ€§é—®é¢˜ï¼Œä¿®æ”¹å®Œæ²¡æœ‰åŠæ—¶åŒæ­¥åˆ°å…¶ä»–çš„CPUï¼‰ï¼Œåˆå¼•å‡ºäº†ã€Œå†…å­˜å±éšœã€çš„æ¦‚å¿µï¼›å†…å­˜å±éšœå¯ä»¥åˆ†ä¸ºä¸‰ç§ç±»å‹ï¼šå†™å±éšœï¼Œè¯»å±éšœä»¥åŠå…¨èƒ½å±éšœï¼ˆåŒ…å«äº†è¯»å†™å±éšœï¼‰ï¼Œå±éšœå¯ä»¥ç®€å•ç†è§£ä¸ºï¼šåœ¨æ“ä½œæ•°æ®çš„æ—¶å€™ï¼Œå¾€æ•°æ®æ’å…¥ä¸€æ¡â€ç‰¹æ®Šçš„æŒ‡ä»¤â€ã€‚åªè¦é‡åˆ°è¿™æ¡æŒ‡ä»¤ï¼Œé‚£å‰é¢çš„æ“ä½œéƒ½å¾—ã€Œå®Œæˆã€ã€‚CPUå½“å‘ç°å†™å±éšœæŒ‡ä»¤æ—¶ï¼Œä¼šæŠŠè¯¥æŒ‡ä»¤ã€Œä¹‹å‰ã€å­˜åœ¨äºã€Œstore Bufferã€æ‰€æœ‰å†™æŒ‡ä»¤åˆ·å…¥é«˜é€Ÿç¼“å­˜ã€‚å°±å¯ä»¥è®©CPUä¿®æ”¹çš„æ•°æ®é©¬ä¸Šæš´éœ²ç»™å…¶ä»–CPUï¼Œè¾¾åˆ°ã€Œå†™æ“ä½œã€å¯è§æ€§çš„æ•ˆæœã€‚è¯»å±éšœä¹Ÿæ˜¯ç±»ä¼¼çš„ï¼šCPUå½“å‘ç°è¯»å±éšœçš„æŒ‡ä»¤æ—¶ï¼Œä¼šæŠŠè¯¥æŒ‡ä»¤ã€Œä¹‹å‰ã€å­˜åœ¨äºã€Œinvalid queueã€æ‰€æœ‰çš„æŒ‡ä»¤éƒ½å¤„ç†æ‰ã€‚é€šè¿‡è¿™ç§æ–¹å¼å°±å¯ä»¥ç¡®ä¿å½“å‰CPUçš„ç¼“å­˜çŠ¶æ€æ˜¯å‡†ç¡®çš„ï¼Œè¾¾åˆ°ã€Œè¯»æ“ä½œã€ä¸€å®šæ˜¯è¯»å–æœ€æ–°çš„æ•ˆæœã€‚ç”±äºä¸åŒCPUæ¶æ„çš„ç¼“å­˜ä½“ç³»ä¸ä¸€æ ·ã€ç¼“å­˜ä¸€è‡´æ€§åè®®ä¸ä¸€æ ·ã€é‡æ’åºçš„ç­–ç•¥ä¸ä¸€æ ·ã€æ‰€æä¾›çš„å†…å­˜å±éšœæŒ‡ä»¤ä¹Ÿæœ‰å·®å¼‚ï¼Œæ‰€ä»¥ä¸€äº›è¯­è¨€c++/java/go/rust éƒ½æœ‰å®ç°è‡ªå·±çš„å†…å­˜æ¨¡å‹ï¼Œåº”è¯¥ç›¸äº’éƒ½æœ‰äº›å€Ÿé‰´å§ã€‚&lt;/p&gt;
&lt;h3 id=&#34;59ä¸äº†è§£å·¥ä½œè´Ÿè½½ç±»å‹çš„å¹¶å‘å½±å“&#34;&gt;59.ä¸äº†è§£å·¥ä½œè´Ÿè½½ç±»å‹çš„å¹¶å‘å½±å“&lt;/h3&gt;
&lt;p&gt;ä¸Šæ–‡æåˆ°åˆ°å·¥ä½œè´Ÿè½½åˆ†ä¸¤ç§ï¼šCPU-Bound å’Œ IO-Bound å·²ç»è¯´æ˜äº†ä¸€äº›é—®é¢˜ï¼Œæ–‡ä¸­ä½¿ç”¨çš„å·¥ä½œæ± ï¼Œä¹Ÿæ˜¯ä¾èµ–äºä½¿ç”¨åœºæ™¯çš„å·¥ä½œè´Ÿè½½ç±»å‹æ˜¯CPU-Boundè¿˜æ˜¯ IO-Bound ; å¦‚æœ worker æ‰§è¡Œçš„å·¥ä½œè´Ÿè½½æ˜¯ I/O-boundï¼Œåˆ™è¯¥å€¼ä¸»è¦å–å†³äºå¤–éƒ¨ç³»ç»Ÿã€‚ç›¸åï¼Œå¦‚æœå·¥ä½œé‡æ˜¯å— CPU é™åˆ¶ï¼Œgoroutine çš„æœ€ä½³æ•°é‡æ¥è¿‘äºå¯ç”¨çº¿ç¨‹çš„æ•°é‡ã€‚åœ¨è®¾è®¡å¹¶å‘åº”ç”¨ç¨‹åºæ—¶ï¼Œäº†è§£å·¥ä½œè´Ÿè½½ç±»å‹ï¼ˆI/O æˆ– CPUï¼‰è‡³å…³é‡è¦ã€‚&lt;/p&gt;
&lt;p&gt;å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œåº”è¯¥é€šè¿‡åŸºå‡†æ¥éªŒè¯å‡è®¾ã€‚å¹¶å‘ä¸æ˜¯ç›´æˆªäº†å½“çš„ï¼Œå¾ˆå®¹æ˜“åšå‡ºè‰ç‡çš„å‡è®¾ï¼Œç»“æœè¯æ˜æ˜¯æ— æ•ˆçš„ã€‚&lt;/p&gt;
&lt;h3 id=&#34;60è¯¯è§£-go-context&#34;&gt;60.è¯¯è§£ Go Context&lt;/h3&gt;
&lt;p&gt;æ–‡ä¸­ä¸»è¦æ˜¯ä»‹ç»äº†å„ç§contextçš„ä½¿ç”¨åœºæ™¯ï¼Œ&lt;code&gt;WithCancel&lt;/code&gt; ï¼Œ&lt;code&gt;WithTimeout&lt;/code&gt;ï¼Œ&lt;code&gt;WithDeadline&lt;/code&gt;ï¼Œ&lt;code&gt;WithValue&lt;/code&gt;ï¼Œä»¥åŠ1.20æ–°åŠ å…¥çš„ &lt;code&gt;WithCancelCause&lt;/code&gt;è¿”å›CancelCauseFunc å¯ä»¥è®°å½•Cancelå¯¼è‡´çš„é”™è¯¯åŸå› ï¼Œé€šè¿‡&lt;code&gt;Cause&lt;/code&gt;è·å–åˆ°ï¼›å…·ä½“å¯ä»¥åœ¨å¼€å‘æ–‡æ¡£ä¸­å­¦ä¹ å³å¯ï¼š &lt;a href=&#34;https://pkg.go.dev/context&#34;&gt;https://pkg.go.dev/context&lt;/a&gt; ;&lt;/p&gt;
&lt;p&gt;ä½¿ç”¨Contextçš„ç¨‹åºåº”è¯¥éµå¾ªè¿™äº›è§„åˆ™ï¼Œä»¥ä¿æŒæ¥å£åœ¨åŒ…ä¹‹é—´çš„ä¸€è‡´æ€§ï¼Œå¹¶å¯ç”¨é™æ€åˆ†æå·¥å…·æ¥æ£€æŸ¥contextä¼ æ’­ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ä¼ é€’ Context æ—¶ï¼Œè€Œåº”è¯¥æ˜¾å¼åœ°ä¼ å…¥å‡½æ•°ï¼Œå¹¶ä¸”æ”¾åœ¨å‚æ•°åˆ—è¡¨ç¬¬ä¸€ä¸ªä½ç½®ï¼Œé€šå¸¸å‘½åä¸º ctxï¼›&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;DoSomething&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;ctx&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;context&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Context&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;arg&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;Arg&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;kt&#34;&gt;error&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
	&lt;span class=&#34;c1&#34;&gt;// ... use ctx ...
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;ä¸è¦ä¼ é€’ nil çš„ Contextï¼Œåœ¨ä¸ç¡®å®šçš„æ—¶å€™åº”è¯¥ä¼ é€’ &lt;code&gt;context.TODO()&lt;/code&gt;ï¼›è€Œä¸æ˜¯ä¼ é€’ç©ºä¸Šä¸‹æ–‡&lt;code&gt;context.Background&lt;/code&gt;ã€‚&lt;code&gt;context.TODO()&lt;/code&gt;è¿”å›ä¸€ä¸ªç©ºä¸Šä¸‹æ–‡ï¼Œä½†åœ¨è¯­ä¹‰ä¸Šï¼Œå®ƒè¡¨ç¤ºè¦ä½¿ç”¨çš„ä¸Šä¸‹æ–‡ä¸æ¸…æ¥šæˆ–å°šä¸å¯ç”¨ï¼ˆä¾‹å¦‚ï¼Œå°šæœªç”±çˆ¶çº§ä¼ æ’­ï¼‰ã€‚&lt;/li&gt;
&lt;li&gt;ä½¿ç”¨ context çš„ Value ç›¸å…³æ–¹æ³•æ—¶åªåº”è¯¥ç”¨äºä¼ é€’å’Œè¯·æ±‚ç›¸å…³çš„å…ƒæ•°æ®(metadata)ï¼Œä¸è¦ç”¨å®ƒä¼ é€’ä¸€äº›å¯é€‰å‚æ•°ï¼›æ¯”å¦‚traceId, spanId, å»ºè®¾å¾®æœåŠ¡ç»å¸¸ä¼šç”¨åˆ°ã€‚&lt;/li&gt;
&lt;li&gt;WithValueä¸­çš„key, å¿…é¡»å¯æ¯”è¾ƒçš„ï¼Œå¹¶ä¸”ä¸åº”æ˜¯å­—ç¬¦ä¸²ç±»å‹æˆ–ä»»ä½•å…¶ä»–å†…ç½®ç±»å‹ï¼Œä»¥é¿å…ä½¿ç”¨contextçš„åŒ…ä¹‹é—´å‘ç”Ÿå†²çªï¼›æœ€ä½³åšæ³•æ˜¯åˆ›å»ºä¸€ä¸ªæœªå¯¼å‡ºçš„è‡ªå®šä¹‰ç±»å‹ï¼›æ¯”å¦‚åœ¨åŒ…ä¸­å®šä¹‰ &lt;code&gt;type favContextKey string&lt;/code&gt; ï¼Œå³ä½¿å¦ä¸€ä¸ªåŒ…ä¹Ÿç”¨&lt;code&gt;favContextKey&lt;/code&gt; è¿™ä¸ªåå­—ï¼Œä¸æ˜¯åŒä¸€ä¸ªkeyäº†ã€‚è¿™ä¸ªåœ¨httpä¸­é—´ä»¶é‡Œç»å¸¸å‡ºç°ï¼Œè®°å½•åœ¨è®¿é—®æ—¥å¿—ä¸­è®°å½•ç›¸å…³ä¿¡æ¯ã€‚&lt;/li&gt;
&lt;li&gt;åŒä¸€ä¸ª context å¯ä»¥ä¼ é€’åˆ°ä¸åŒçš„ goroutine ä¸­ï¼Œä¸”åœ¨å¤šä¸ª goroutine å¯ä»¥å®‰å…¨è®¿é—®ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;æ¦‚æ‹¬&#34;&gt;æ¦‚æ‹¬&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;äº†è§£å¹¶å‘å’Œå¹¶è¡Œä¹‹é—´çš„æ ¹æœ¬åŒºåˆ«æ˜¯ Go å¼€å‘äººå‘˜çŸ¥è¯†çš„åŸºçŸ³ã€‚å¹¶å‘æ˜¯å…³äºç»“æ„çš„ï¼Œè€Œå¹¶è¡Œæ˜¯å…³äºæ‰§è¡Œçš„ã€‚&lt;/li&gt;
&lt;li&gt;è¦æˆä¸ºç†Ÿç»ƒçš„å¼€å‘äººå‘˜ï¼Œå¿…é¡»æ‰¿è®¤å¹¶å‘å¹¶ä¸æ€»æ˜¯æ›´å¿«ã€‚æ¶‰åŠæœ€å°å·¥ä½œè´Ÿè½½å¹¶è¡ŒåŒ–çš„è§£å†³æ–¹æ¡ˆä¸ä¸€å®šæ¯”é¡ºåºå®æ–½æ›´å¿«ã€‚å¯¹é¡ºåºè§£å†³æ–¹æ¡ˆä¸å¹¶å‘è§£å†³æ–¹æ¡ˆè¿›è¡ŒåŸºå‡†æµ‹è¯•åº”è¯¥æ˜¯éªŒè¯å‡è®¾çš„æ–¹æ³•ã€‚&lt;/li&gt;
&lt;li&gt;åœ¨channelå’Œmutexä¹‹é—´åšå‡ºå†³å®šæ—¶ï¼Œäº†è§£ goroutine äº¤äº’ä¹Ÿå¾ˆæœ‰å¸®åŠ©ã€‚é€šå¸¸ï¼Œå¯¹äºå…±äº«èµ„æºå˜é‡ï¼Œ goroutineç«äº‰è®¿é—®æ—¶ï¼Œ éœ€è¦åŒæ­¥ï¼Œä½¿ç”¨åŒæ­¥æœºåˆ¶syncåŒ…ä¸­mutexï¼›å¯¹äº goroutineä¹‹é—´éœ€è¦åè°ƒå’Œç¼–æ’ï¼Œåˆ™ä½¿ç”¨channelã€‚&lt;/li&gt;
&lt;li&gt;ç²¾é€šå¹¶å‘ä¹Ÿæ„å‘³ç€ç†è§£æ•°æ®ç«äº‰å’Œç«äº‰æ¡ä»¶æ˜¯ä¸åŒçš„æ¦‚å¿µã€‚å½“å¤šä¸ª goroutine åŒæ—¶è®¿é—®åŒä¸€å†…å­˜ä½ç½®å¹¶ä¸”å…¶ä¸­è‡³å°‘ä¸€ä¸ªæ­£åœ¨å†™å…¥æ—¶ï¼Œå°±ä¼šå‘ç”Ÿæ•°æ®ç«äº‰ã€‚åŒæ—¶ï¼Œæ— æ•°æ®ç«äº‰å¹¶ä¸ä¸€å®šæ„å‘³ç€ç¡®å®šæ€§æ‰§è¡Œã€‚å½“è¡Œä¸ºå–å†³äºæ— æ³•æ§åˆ¶çš„äº‹ä»¶çš„é¡ºåºæˆ–æ—¶é—´æ—¶ï¼Œè¿™å°±æ˜¯ç«äº‰æ¡ä»¶ã€‚&lt;/li&gt;
&lt;li&gt;äº†è§£ Go å†…å­˜æ¨¡å‹ä»¥åŠåœ¨æ’åºå’ŒåŒæ­¥æ–¹é¢çš„åº•å±‚ä¿è¯å¯¹äºé˜²æ­¢å¯èƒ½çš„æ•°æ®ç«äº‰å’Œç«äº‰æ¡ä»¶è‡³å…³é‡è¦ã€‚&lt;/li&gt;
&lt;li&gt;åˆ›å»ºä¸€å®šæ•°é‡çš„ goroutine æ—¶ï¼Œè¯·è€ƒè™‘å·¥ä½œè´Ÿè½½ç±»å‹ã€‚åˆ›å»º CPU-bound goroutines æ„å‘³ç€å°†è¿™ä¸ªæ•°å­—é™åˆ¶åœ¨å˜é‡é™„è¿‘&lt;code&gt;GOMAXPROCS&lt;/code&gt;ï¼ˆé»˜è®¤æƒ…å†µä¸‹åŸºäºä¸»æœºä¸Šçš„ CPU æ ¸å¿ƒæ•°ï¼‰ã€‚åˆ›å»º I/O-bound goroutines å–å†³äºå…¶ä»–å› ç´ ï¼Œä¾‹å¦‚å¤–éƒ¨ç³»ç»Ÿã€‚&lt;/li&gt;
&lt;li&gt;Go Contextä¹Ÿæ˜¯ Go å¹¶å‘çš„åŸºçŸ³ä¹‹ä¸€ã€‚Contextå…è®¸æºå¸¦æˆªæ­¢æ—¥æœŸã€å–æ¶ˆä¿¡å·ã€é”®å€¼å…ƒæ•°æ®åˆ—è¡¨(metadata)ã€‚&lt;/li&gt;
&lt;/ul&gt;
</description>
      
    </item>
    
    <item>
      <title>Go tips-ç¬”è®°: é”™è¯¯ç®¡ç† 48-54 mistakes</title>
      <link>https://weedge.github.io/post/notions/go-tips/go-tips-07-error-management/</link>
      <pubDate>Thu, 16 Feb 2023 14:26:23 +0800</pubDate>
      
      <guid>https://weedge.github.io/post/notions/go-tips/go-tips-07-error-management/</guid>
      
        <description>&lt;h2 id=&#34;ç¬”è®°&#34;&gt;ç¬”è®°&lt;/h2&gt;
&lt;h3 id=&#34;48panic&#34;&gt;48.panic&lt;/h3&gt;
&lt;p&gt;Go æ–°æ‰‹å¯¹é”™è¯¯å¤„ç†æ„Ÿåˆ°å›°æƒ‘æ˜¯å¾ˆå¸¸è§çš„ã€‚åœ¨ Go ä¸­ï¼Œé”™è¯¯é€šå¸¸ç”±è¿”å›çš„å‡½æ•°æˆ–æ–¹æ³•ç®¡ç†ç±»å‹&lt;code&gt;error&lt;/code&gt;ä½œä¸ºæœ€åä¸€ä¸ªå‚æ•°ï¼ˆè¿™ä¸ªæ˜¯ä»£ç é£æ ¼ï¼Œerrorå¯ä»¥ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ï¼‰ï¼›å…ˆäº†è§£ä¸‹panicè°ƒç”¨æ—¶çš„æƒ…å†µï¼š&lt;/p&gt;
&lt;p&gt;ä¸€æ—¦&lt;code&gt;panic&lt;/code&gt;è¢«è°ƒç”¨ï¼Œå®ƒå°±ä¼šåœæ­¢å½“å‰å‡½æ•°çš„æ‰§è¡Œå¹¶å‘ä¸Šè°ƒç”¨æ ˆï¼Œç›´åˆ°å½“å‰ goroutine å‡ºæ ˆè¿”å›æˆ–è¢«&lt;code&gt;recover&lt;/code&gt;æ•è·ï¼›å€¼å¾—æ³¨æ„ç‚¹æ˜¯å½“å‰åç¨‹å‡½æ•°ä¸­panicäº†ï¼Œå¦‚æœæœ‰deferå‡½æ•°è¿˜æ˜¯ä¼šæ‰§è¡Œï¼Œæ‰€ä»¥ä¸€èˆ¬ä½¿ç”¨defer func(){recover()} çš„å½¢å¼æ¥é˜²æ­¢åç¨‹panic,  è€Œä¸”åªèƒ½recoverä½å½“å‰åç¨‹panic, è¿™æ˜¯å› ä¸ºå½“å‰åç¨‹æœªä½¿ç”¨recoveræ—¶å·²ç»å‡ºæ ˆè¿”å›ï¼Œå‡½æ•°æ ˆå¸§å·²ç»æ— æ•ˆäº†ï¼Œè°ƒç”¨è€…æ˜¯æ²¡æ³•recoverçš„ã€‚&lt;/p&gt;
&lt;p&gt;panicä¸€èˆ¬ä½¿ç”¨åœ¨ç¨‹åºå¯åŠ¨æ—¶ï¼Œä¸€ä¸ªä¾èµ–é¡¹æœªèƒ½åˆå§‹åŒ–å®ƒæ—¶ï¼Œå¯ä»¥ä½¿ç”¨ï¼Œä½†æ˜¯ä¸€èˆ¬çš„åšæ³•æ˜¯æ‰“å°fatalæ—¥å¿—é€€å‡ºï¼›åœ¨æœåŠ¡å¯åŠ¨ä¹‹åï¼Œä¸èƒ½panicï¼Œä¸€èˆ¬è®°å½•é”™è¯¯æ—¥å¿—ï¼Œå¹¶ä¸”åœ¨æœåŠ¡è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œéœ€è¦å¯¹å½“å‰åç¨‹ panic recoverä½ï¼Œä»¥é˜²å¸¸è§çš„ç©ºæŒ‡é’ˆè®¿é—®æ•°æ®ï¼ŒæœåŠ¡downæ‰çš„æƒ…å†µã€‚&lt;/p&gt;
&lt;h3 id=&#34;49å¿½ç•¥ä½•æ—¶error-wrap&#34;&gt;49.å¿½ç•¥ä½•æ—¶error wrap&lt;/h3&gt;
&lt;p&gt;åœ¨å¤„ç†é”™è¯¯æ—¶ï¼Œéœ€è¦å‘é”™è¯¯æ·»åŠ é¢å¤–çš„ä¸Šä¸‹æ–‡å’Œ/æˆ–å°†é”™è¯¯æ ‡è®°ä¸ºç‰¹å®šç±»å‹ã€‚åˆ†ä¸ºä¸‰ç§erroræƒ…å†µè¿›è¡Œä½¿ç”¨ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å¦‚æœéœ€è¦æ ‡è®°é”™è¯¯ï¼Œåº”è¯¥åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰é”™è¯¯ç±»å‹ï¼Œæ¯”å¦‚errorCodeã€‚&lt;/li&gt;
&lt;li&gt;å¦‚æœåªæƒ³æ·»åŠ é¢å¤–çš„ä¸Šä¸‹æ–‡ï¼Œåº”è¯¥ä½¿ç”¨&lt;code&gt;fmt.Errorf %w&lt;/code&gt;æ ¼å¼æŒ‡ä»¤ç”ŸæˆwrapErrorç±»å‹é”™è¯¯ï¼Œå› ä¸ºå®ƒä¸éœ€è¦åˆ›å»ºæ–°çš„é”™è¯¯ç±»å‹ï¼›wrapErrorä¼šäº§ç”Ÿæ½œåœ¨çš„è€¦åˆï¼Œå®ƒä½¿æºé”™è¯¯é€šè¿‡Unwrapå¯ä¾›è°ƒç”¨è€…ä½¿ç”¨ã€‚&lt;/li&gt;
&lt;li&gt;å¦‚æœä¸æƒ³ä½¿ç”¨æºé”™è¯¯è¿½æº¯ï¼Œä¸åº”è¯¥ä½¿ç”¨wrapErrorï¼Œè€Œæ˜¯é”™è¯¯è½¬æ¢ï¼Œä¾‹å¦‚ä½¿ç”¨&lt;code&gt;fmt.Errorf %v&lt;/code&gt;æ ¼å¼æŒ‡ä»¤ç”Ÿæˆæ–°çš„errorStringç±»å‹é”™è¯¯&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;50ä¸å‡†ç¡®åœ°æ£€æŸ¥errorç±»å‹-é‡è¦&#34;&gt;50.ä¸å‡†ç¡®åœ°æ£€æŸ¥errorç±»å‹ (é‡è¦)&lt;/h3&gt;
&lt;p&gt;è¿™ä¸ªå…¶å®å°±æ˜¯å¼„æ‡‚Go1.13å¼•å…¥çš„wrapErrorç±»å‹é”™è¯¯ï¼Œè¿™ä¸ªé”™è¯¯ç±»å‹å› ä¸ºæ˜¯å±‚å±‚åŒ…è£¹æºé”™è¯¯ï¼Œå¦‚æœå°†ä»¥å‰è€çš„ä»£ç è¿”å›çš„é”™è¯¯é‡æ„æˆwrapErrorçš„è¯ï¼Œåœ¨è°ƒç”¨çš„åœ°æ–¹åˆ¤æ–­errçš„æ—¶å€™ éœ€è¦ç”¨ error.Is é”™è¯¯å€¼å’Œ error.As é”™è¯¯ç±»å‹ å‡½æ•°è¿›è¡Œåˆ¤æ–­ï¼ŒIsæ˜¯ä»error é“¾ä¸­é€’å½’åœ°Unwrap erréå†æ˜¯å¦æœ‰å¯¹åº”ç›®æ ‡errorå€¼,  Asæ˜¯ä»error é“¾ä¸­é€’å½’åœ°Unwrap errå¹¶æŸ¥çœ‹å…¶ä¸­ä¸€ä¸ªé”™è¯¯æ˜¯å¦æ˜¯ç‰¹å®šerrorç±»å‹ï¼›è¿™ä¸¤ä¸ªå‡½æ•°éƒ½æ˜¯ç”¨äº†åå°„ï¼Œå¦‚æœé”™è¯¯é“¾è·¯é•¿çš„è¯ï¼Œä¼šæœ‰ä¸€äº›æ€§èƒ½æŠ˜æŸã€‚&lt;/p&gt;
&lt;h3 id=&#34;51æ£€æŸ¥errorå€¼ä¸å‡†ç¡®-é‡è¦&#34;&gt;51.æ£€æŸ¥errorå€¼ä¸å‡†ç¡® ï¼ˆé‡è¦ï¼‰&lt;/h3&gt;
&lt;p&gt;è¿™é‡Œä»‹ç»çš„æ˜¯wrapErrorç±»å‹é”™è¯¯åœ¨==æ¯”è¾ƒé”™è¯¯å€¼æ—¶ï¼Œåº”è¯¥é‡‡ç”¨error.Isæ¥åˆ¤æ–­ã€‚&lt;/p&gt;
&lt;h3 id=&#34;52å¤„ç†errorä¸¤æ¬¡&#34;&gt;52.å¤„ç†errorä¸¤æ¬¡&lt;/h3&gt;
&lt;p&gt;è¿™ä¸ªåœ¨å·¥ç¨‹é¡¹ç›®ä¸­ï¼Œä½¿ç”¨Goå¼€å‘ï¼Œæ‰“æ—¥å¿—ç»å¸¸å‡ºç°é”™è¯¯æ‰“å°å¤šæ¡çš„æƒ…å†µï¼Œå¯¹äºå¹¶å‘æœåŠ¡ï¼Œå¦‚æœä¸ç”¨logId,traceIdæ¥è¾…åŠ©å®šä½ï¼Œä¸€èˆ¬å¾ˆéš¾å®šä½åˆ°ä¸€æ¬¡é€»è¾‘äº¤äº’çš„å¤šæ¡æ—¥å¿—ä¿¡æ¯ã€‚è¿™é‡Œçš„å¤„ç†æ–¹å¼å°†å¤šæ¡é”™è¯¯é€šè¿‡wrapçš„æ–¹å¼ ä¸€æ¡æ‰“å°å‡ºæ•´æ¡é€»è¾‘é“¾è·¯çš„é”™è¯¯ä¿¡æ¯å‡ºæ¥ã€‚å·¥ç¨‹å®è·µå°ç»†èŠ‚å§ï¼Œå¦‚æœè€ƒè™‘æ€§èƒ½å½±å“ï¼Œéœ€è¦æŠ˜ä¸­è€ƒè™‘äº†ã€‚&lt;/p&gt;
&lt;h3 id=&#34;53ä¸å¤„ç†é”™è¯¯-å·¥ç¨‹è§„èŒƒ&#34;&gt;53.ä¸å¤„ç†é”™è¯¯ (å·¥ç¨‹è§„èŒƒï¼‰&lt;/h3&gt;
&lt;p&gt;å¿½ç•¥é”™è¯¯éƒ½åº”è¯¥ä½¿ç”¨_æ ‡è¯†ç¬¦æ˜¾å¼æ ‡ç¤ºï¼Œåœ¨ä¸å¤„ç†é”™è¯¯çš„å‡½æ•°è°ƒç”¨åœ°æ–¹ï¼ŒåŠ ä¸Šå¯¹åº”æ³¨é‡Šä¸Šä¸‹æ–‡é€»è¾‘è¯´æ˜ä¸ºä»€ä¹ˆå¯ä»¥å¿½ç•¥ã€‚ã€‚ã€‚&lt;/p&gt;
&lt;h3 id=&#34;54ä¸å¤„ç†å»¶è¿Ÿé”™è¯¯&#34;&gt;54.ä¸å¤„ç†å»¶è¿Ÿé”™è¯¯&lt;/h3&gt;
&lt;p&gt;å¦‚æœå‡½æ•°è¿”å›çš„é”™è¯¯éœ€è¦è€ƒè™‘deferå‡½æ•°ä¸­çš„å‡½æ•°è°ƒç”¨æ˜¯å¦è¿”å›é”™è¯¯ï¼Œåˆ™åœ¨deferé—­åŒ…å‡½æ•°ä¸­å…ˆåˆ¤æ–­å‡½æ•°ä¸­çš„erræ˜¯å¦ä¸ä¸ºnil, æ˜¯åˆ™ç›´æ¥é—­åŒ…å‡½æ•°è¿”å›ï¼Œå¦åˆ™å°†defer é—­åŒ…å‡½æ•°ä¸­å¤„ç†çš„é€»è¾‘å‡½æ•°é”™è¯¯èµ‹å€¼ç»™errã€‚å¦‚æœæƒ³å¿½ç•¥å®ƒï¼Œä½¿ç”¨_æ ‡è¯†ç¬¦æ ‡ç¤ºã€‚&lt;/p&gt;
&lt;h2 id=&#34;æ¦‚æ‹¬&#34;&gt;æ¦‚æ‹¬&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;panic&lt;/code&gt;æ˜¯ Go ä¸­å¤„ç†é”™è¯¯çš„ä¸€ä¸ªé€‰é¡¹ã€‚å®ƒåº”è¯¥åªåœ¨ä¸å¯æ¢å¤çš„æƒ…å†µä¸‹è°¨æ…ä½¿ç”¨ï¼šä¾‹å¦‚ï¼Œå‘å‡ºç¨‹åºå‘˜é”™è¯¯ä¿¡å·æˆ–åŠ è½½å¼ºåˆ¶ä¾èµ–é¡¹å¤±è´¥æ—¶ã€‚&lt;/li&gt;
&lt;li&gt;åŒ…è£…é”™è¯¯å…è®¸æ ‡è®°é”™è¯¯å’Œ/æˆ–æä¾›é¢å¤–çš„ä¸Šä¸‹æ–‡ã€‚ä½†æ˜¯ï¼Œé”™è¯¯åŒ…è£…ä¼šäº§ç”Ÿæ½œåœ¨çš„è€¦åˆï¼Œå› ä¸ºå®ƒä½¿æºé”™è¯¯å¯ä¾›è°ƒç”¨è€…ä½¿ç”¨ã€‚å¦‚æœæƒ³é˜²æ­¢è¿™ç§æƒ…å†µå‘ç”Ÿï¼Œè¯·ä¸è¦ä½¿ç”¨é”™è¯¯åŒ…è£…ã€‚&lt;/li&gt;
&lt;li&gt;å¦‚æœä½¿ç”¨ Go 1.13 &lt;code&gt;fmt.Errorf %w&lt;/code&gt;æŒ‡ä»¤è¿”å›wrapErrorç±»å‹é”™è¯¯ï¼Œåˆ™å¿…é¡»åˆ†åˆ«ä½¿ç”¨&lt;code&gt;errors.As&lt;/code&gt; æˆ–è€…&lt;code&gt;errors.Is&lt;/code&gt;å°†é”™è¯¯ä¸ç±»å‹æˆ–å€¼è¿›è¡Œæ¯”è¾ƒã€‚&lt;/li&gt;
&lt;li&gt;è¦ä¼ è¾¾é¢„æœŸçš„é”™è¯¯ï¼Œè¯·ä½¿ç”¨é”™è¯¯å“¨å…µï¼ˆé”™è¯¯å€¼ï¼‰ã€‚æ„å¤–é”™è¯¯åº”è¯¥æ˜¯ç‰¹å®šçš„é”™è¯¯ç±»å‹ã€‚&lt;/li&gt;
&lt;li&gt;åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œä¸€ä¸ªé”™è¯¯åº”è¯¥åªå¤„ç†ä¸€æ¬¡ã€‚è®°å½•é”™è¯¯å°±æ˜¯å¤„ç†é”™è¯¯ã€‚å› æ­¤ï¼Œå¿…é¡»åœ¨è®°å½•æˆ–è¿”å›é”™è¯¯ä¹‹é—´åšå‡ºé€‰æ‹©ã€‚åœ¨è®¸å¤šæƒ…å†µä¸‹ï¼Œé”™è¯¯åŒ…è£…æ˜¯è§£å†³æ–¹æ¡ˆï¼Œå› ä¸ºå®ƒå…è®¸ä¸ºé”™è¯¯æä¾›é¢å¤–çš„ä¸Šä¸‹æ–‡å¹¶è¿”å›æºé”™è¯¯ã€‚&lt;/li&gt;
&lt;li&gt;å¿½ç•¥é”™è¯¯ï¼Œæ— è®ºæ˜¯åœ¨å‡½æ•°è°ƒç”¨æœŸé—´è¿˜æ˜¯åœ¨å‡½æ•°ä¸­&lt;code&gt;defer&lt;/code&gt;ï¼Œéƒ½åº”è¯¥ä½¿ç”¨_æ ‡è¯†ç¬¦æ˜¾å¼æ ‡ç¤ºã€‚å¦åˆ™ï¼Œæœªæ¥çš„è¯»è€…å¯èƒ½ä¼šæ··æ·†è¿™æ˜¯æ•…æ„çš„è¿˜æ˜¯å¤±è¯¯ã€‚&lt;/li&gt;
&lt;li&gt;åœ¨è®¸å¤šæƒ…å†µä¸‹ï¼Œä¸åº”è¯¥å¿½ç•¥å‡½æ•°è¿”å›çš„é”™è¯¯&lt;code&gt;defer&lt;/code&gt;ã€‚æ ¹æ®ä¸Šä¸‹æ–‡ï¼Œç›´æ¥å¤„ç†å®ƒæˆ–å°†å…¶ä¼ æ’­ç»™è°ƒç”¨è€…ã€‚å¦‚æœæƒ³å¿½ç•¥å®ƒï¼Œä½¿ç”¨_æ ‡è¯†ç¬¦æ ‡ç¤ºã€‚&lt;/li&gt;
&lt;/ul&gt;
</description>
      
    </item>
    
    <item>
      <title>Go tips-ç¬”è®°: å‡½æ•°å’Œæ–¹æ³• 42-47 mistakes</title>
      <link>https://weedge.github.io/post/notions/go-tips/go-tips-06-functions-methods/</link>
      <pubDate>Wed, 15 Feb 2023 14:26:23 +0800</pubDate>
      
      <guid>https://weedge.github.io/post/notions/go-tips/go-tips-06-functions-methods/</guid>
      
        <description>&lt;h2 id=&#34;ç¬”è®°&#34;&gt;ç¬”è®°&lt;/h2&gt;
&lt;h3 id=&#34;42ç»“æ„ä½“æ–¹æ³•ä¸çŸ¥é“ä½¿ç”¨å“ªç§ç±»å‹çš„æ¥æ”¶è€…&#34;&gt;42.ç»“æ„ä½“æ–¹æ³•ä¸çŸ¥é“ä½¿ç”¨å“ªç§ç±»å‹çš„æ¥æ”¶è€…&lt;/h3&gt;
&lt;p&gt;æ–‡ä¸­è¯´äº†å¾ˆå¤šï¼Œæ„Ÿè§‰ä¸ºäº†å‡‘æ•°ï¼Œä¸»è¦å°±æ˜¯å›´ç»•ç€å€¼ä¼ é€’è¿˜æ˜¯æŒ‡é’ˆä¼ é€’ï¼Œå€¼ä¼ é€’ç»™æ¥æ”¶è€…ï¼Œå¦‚æœç»“æ„ä½“ä¸­æ²¡æœ‰æŒ‡é’ˆç±»å‹æˆå‘˜ï¼Œåˆ™ä¸ä¼šæ”¹å˜æ¥æ”¶è€…çš„æ•°æ®ï¼›å¦‚æœ‰æŒ‡é’ˆä¼ é€’ï¼Œåˆ™ä¼šæ”¹å˜ã€‚é€‰æ‹©å“ªç§ä¼ é€’æ–¹å¼ï¼Œä¸»è¦å–å†³äºç»“æ„ä½“ä¸­çš„æˆå‘˜æ˜¯å¦éƒ½æ˜¯åªè¯»æ“ä½œï¼Œå¦‚æœæ˜¯åªè¯»ï¼Œä½¿ç”¨å€¼ä¼ é€’ï¼Œå¦åˆ™ä½¿ç”¨æŒ‡é’ˆä¼ é€’ã€‚è‡³äºæ˜¯å¦å¤§ç»“æ„ä½“æ•°æ®ï¼Œè¿™ä¸ªç”±ç»“æ„ä½“ä¸­çš„æˆå‘˜æ¥å†³å®šï¼Œæ˜¯å¦æœ‰æŒ‡é’ˆæˆå‘˜ï¼›&lt;/p&gt;
&lt;h3 id=&#34;43ä»ä¸ä½¿ç”¨å‘½åç»“æœå‚æ•°--å»ºè®®&#34;&gt;43.ä»ä¸ä½¿ç”¨å‘½åç»“æœå‚æ•°  (å»ºè®®)&lt;/h3&gt;
&lt;p&gt;ä¸»è¦æ˜¯ä¸ºäº†å‡½æ•°/ç»“æ„ä½“æ–¹æ³•è¿”å›çš„å€¼ï¼Œæ›´å…·ä»£ç å¯è¯»æ€§ï¼Œæ•°æ®ç±»å‹æœ¬èº«ä¸èƒ½è¡¨ç¤ºå…·ä½“å«ä¹‰ï¼Œé™¤étype åˆ«åï¼› åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œåœ¨æ¥å£å®šä¹‰çš„ä¸Šä¸‹æ–‡ä¸­ä½¿ç”¨å‘½åç»“æœå‚æ•°å¯ä»¥æé«˜å¯è¯»æ€§è€Œä¸ä¼šå¯¼è‡´ä»»ä½•å‰¯ä½œç”¨ã€‚ä½†æ˜¯åœ¨æ–¹æ³•å®ç°çš„ä¸Šä¸‹æ–‡ä¸­æ²¡æœ‰ä¸¥æ ¼çš„è§„åˆ™ã€‚ å½“æœ‰æ˜æ˜¾çš„å¥½å¤„æ—¶ï¼Œåº”è¯¥è°¨æ…ä½¿ç”¨å‘½åç»“æœå‚æ•°ã€‚&lt;/p&gt;
&lt;h3 id=&#34;44å…·æœ‰å‘½åç»“æœå‚æ•°çš„æ„å¤–å‰¯ä½œç”¨-å»ºè®®&#34;&gt;44.å…·æœ‰å‘½åç»“æœå‚æ•°çš„æ„å¤–å‰¯ä½œç”¨ ï¼ˆå»ºè®®ï¼‰&lt;/h3&gt;
&lt;p&gt;å¦‚æœä½¿ç”¨å‘½åçš„ç»“æ„å‚æ•°ï¼Œå£°æ˜äº†ç»“æœçš„å˜é‡åï¼Œåœ¨å‡½æ•°æ–¹æ³•ä½“å†…è¿›è¡Œåˆå§‹å®šä¹‰ï¼Œä½¿ç”¨æ—¶æ³¨æ„ä¸ç”¨è¢«åŒåè¦†ç›–ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤„ç†é”™è¯¯é€»è¾‘æ—¶ï¼Œé”™è¯¯çš„è¿”å›æƒ…å†µï¼Œæ‰€ä»¥ ä½¿ç”¨å‘½åç»“æœå‚æ•°æ—¶ä¿æŒè°¨æ…ï¼Œä»¥é¿å…æ½œåœ¨çš„å‰¯ä½œç”¨ ã€‚&lt;/p&gt;
&lt;h3 id=&#34;45è¿”å›ä¸€ä¸ª-nil-æ¥å£-é‡è¦&#34;&gt;45.è¿”å›ä¸€ä¸ª nil æ¥å£ (é‡è¦)&lt;/h3&gt;
&lt;p&gt;åœ¨å¤„ç†è‡ªå®šä¹‰å®ç°erroræ¥å£çš„é”™è¯¯ä½“ç»“æ„ï¼Œåˆ¤æ–­é”™è¯¯æ—¶éœ€è¦æ³¨æ„çš„åœ°æ–¹ï¼Œå¦‚æœæ¥å£error ä¸ºæœªèµ‹å€¼çš„è‡ªå®šä¹‰é”™è¯¯ä½“ç»“æ„ï¼Œè™½ç„¶é”™è¯¯ä½“ç»“æ„ä¸ºnilï¼Œä½†æ˜¯interface errorä¸ä¸ºnil, å…¶interface error å†…éƒ¨æŒ‡å‘çš„é”™è¯¯ä½“ç»“æ„ä¸ºnilï¼Œ æ‰€ä»¥éœ€è¦åˆ¤æ–­erroä¸ºnilæ—¶ï¼Œ ç›´æ¥è¿”å›nilå€¼, è€Œä¸æ˜¯ä¸ºnilçš„é”™è¯¯ä½“ç»“æ„ä½“æŒ‡é’ˆï¼›è¿™ä¸ªæ˜¯Goä¸­ç»å¸¸ä¼šé‡åˆ°çš„å‘ã€‚è¿™ç§æƒ…å†µä¹Ÿå¯èƒ½å‘ç”Ÿåœ¨ä»»ä½•ä½¿ç”¨æŒ‡é’ˆæ¥æ”¶è€…å®ç°çš„æ¥å£ï¼Œéœ€è¦ä¿æŒè°¨æ…ã€‚&lt;/p&gt;
&lt;h3 id=&#34;46ä½¿ç”¨æ–‡ä»¶åä½œä¸ºå‡½æ•°è¾“å…¥&#34;&gt;46.ä½¿ç”¨æ–‡ä»¶åä½œä¸ºå‡½æ•°è¾“å…¥&lt;/h3&gt;
&lt;p&gt;è¿™ä¸ªæ˜¯å±äºè®¾è®¡é—®é¢˜äº†ï¼Œå‡½æ•°æ“ä½œçš„æ˜¯å…±æ€§æ•°æ®æ—¶ï¼Œåº”è¯¥é‡‡ç”¨æ¥å£ä½œä¸ºå‡½æ•°çš„è¾“å…¥ï¼Œä»¥ä¾¿è§£è€¦å…·ä½“å®ç°ï¼Œæ–¹ä¾¿æµ‹è¯•å’Œæ‰©å±•ï¼Œæ¯”å¦‚æ–‡ä¸­æ‰€æåˆ°æ‰«ææ•°æ®å†…å®¹çš„è¡Œæ•°ï¼Œå±äºè¯»æ“ä½œï¼Œå¯ä»¥ä½¿ç”¨&lt;code&gt;io.Reader&lt;/code&gt; æ¥å£ä½œä¸ºå‚æ•°ï¼Œå¦‚æœæ˜¯å†™æ“ä½œï¼Œä½¿ç”¨io.Writer ç­‰ç­‰ï¼ŒioåŒ…ä¸­å°è£…äº†ä¸åŒæ¥å£ç»„åˆ; bufioåŒ…ä¸­æœ‰å¯¹åº”æ–¹æ³•æ¥å—æ¥å£å‚æ•°è¿›è¡Œè¯»å†™æ“ä½œï¼›è¿™æ ·æ•°æ®æºåªè¦å®ç°å¯¹åº”è¯»å†™æ¥å£æ–¹æ³•å³å¯ã€‚&lt;/p&gt;
&lt;h3 id=&#34;47å¿½ç•¥deferå‚æ•°å’Œæ¥æ”¶è€…çš„è®¡ç®—æ–¹å¼-é‡è¦&#34;&gt;47.å¿½ç•¥deferå‚æ•°å’Œæ¥æ”¶è€…çš„è®¡ç®—æ–¹å¼ (é‡è¦)&lt;/h3&gt;
&lt;p&gt;åœ¨ä¼ é€’defer å‡½æ•°å‚æ•°æ—¶ï¼Œå‡½æ•°çš„å‚æ•°æ˜¯å€¼æ‹·è´ä¼ é€’ï¼Œä¼ å…¥çš„å€¼ä¸ºå½“å‰å€¼ï¼Œæ¯”å¦‚defer f(a) åœ¨fçš„å®šä¹‰ä¸­,ä¼ å…¥å‚æ•°å¯¹aå€¼è¿›è¡Œäº†å€¼æ‹·è´ï¼Œæ‰€ä»¥å¤–éƒ¨aå€¼æ€ä¹ˆå˜ï¼Œå·²ç»å’Œdeferå‡½æ•°ä¸­çš„å‚æ•°å€¼å·²ç»æ²¡æœ‰å…³ç³»äº†ï¼Œå¦‚æœæƒ³ç»§ç»­ä½¿ç”¨çš„è¯ï¼Œ æä¾›äº†ä¸¤ç§æ–¹æ¡ˆï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;defer å‡½æ•°å‚æ•°é‡‡ç”¨æŒ‡é’ˆä¼ é€’ï¼Œæ¯”å¦‚f(&amp;amp;a)ï¼Œè¿™æ ·æŒ‡å‘åŒä¸€åœ°å€ç©ºé—´ï¼Œéœ€è¦å‡½æ•°ä¼ å…¥æŒ‡é’ˆç±»å‹ï¼Œè¿™ä¸ªå¯¹äºå·²æœ‰å°è£…å¥½çš„å‡½æ•°æ˜¯ä¸å¯è¡Œçš„ã€‚&lt;/li&gt;
&lt;li&gt;ä½¿ç”¨é—­åŒ…å‡½æ•°ï¼Œdefer func(){f(a)}() è¿™æ ·å¯ä»¥å¼•ç”¨åˆ°åœ¨returnä¹‹å‰açš„æœ€ç»ˆå€¼ï¼Œå¦‚æœæ”¹æˆ defer func(a int){f(a)}(a), åˆ™å’ŒåŸæ¥å€¼ä¼ é€’çš„æƒ…å†µä¸€æ ·ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;æ³¨æ„çš„åœ°æ–¹ï¼Œå¦‚æœdeferçš„æ˜¯ç»“æ„ä½“å®ä¾‹çš„æ–¹æ³•ï¼Œæ¯”å¦‚ defer s.f() ï¼Œå¦‚æœsæ˜¯æŒ‡é’ˆä¼ é€’ï¼Œåˆ™åç»­ç»“æ„ä½“å®ä¾‹sä¸­çš„æˆå‘˜æœ‰å˜åŒ–ï¼Œä¹Ÿä¼šå½±å“åˆ°defer s.f(); å¦‚æœé‡‡ç”¨å€¼ä¼ é€’ç»™æ¥å—è€…s, åˆ™æ˜¯å½“å‰sçš„å€¼æ‹·è´ï¼Œåç»­æ€ä¹ˆå˜éƒ½ä¸å½±å“ï¼›&lt;/p&gt;
&lt;h2 id=&#34;æ¦‚æ‹¬&#34;&gt;æ¦‚æ‹¬&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;åº”è¯¥æ ¹æ®ç±»å‹ã€æ˜¯å¦å¿…é¡»æ”¹å˜ã€æ˜¯å¦åŒ…å«æ— æ³•å¤åˆ¶çš„å­—æ®µä»¥åŠå¯¹è±¡æœ‰å¤šå¤§ç­‰å› ç´ æ¥å†³å®šæ˜¯ä½¿ç”¨å€¼è¿˜æ˜¯æŒ‡é’ˆæ¥æ”¶å™¨ã€‚å¦‚æœ‰ç–‘é—®ï¼Œè¯·ä½¿ç”¨æŒ‡é’ˆæ¥æ”¶å™¨ã€‚&lt;/li&gt;
&lt;li&gt;ä½¿ç”¨å‘½åç»“æœå‚æ•°æ˜¯æé«˜å‡½æ•°/æ–¹æ³•å¯è¯»æ€§çš„æœ‰æ•ˆæ–¹æ³•ï¼Œå°¤å…¶æ˜¯åœ¨å¤šä¸ªç»“æœå‚æ•°å…·æœ‰ç›¸åŒç±»å‹çš„æƒ…å†µä¸‹ã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œè¿™ç§æ–¹æ³•ä¹Ÿå¾ˆæ–¹ä¾¿ï¼Œå› ä¸ºå‘½åçš„ç»“æœå‚æ•°è¢«åˆå§‹åŒ–ä¸ºå®ƒä»¬çš„é›¶å€¼ã€‚ä½†è¦æ³¨æ„æ½œåœ¨çš„å‰¯ä½œç”¨ã€‚&lt;/li&gt;
&lt;li&gt;è¿”å›æ¥å£æ—¶ï¼Œæ³¨æ„ä¸è¦è¿”å›ä¸€ä¸ª nil æŒ‡é’ˆï¼Œè€Œæ˜¯ä¸€ä¸ªæ˜¾å¼çš„ nil å€¼ã€‚å¦åˆ™ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ„æƒ³ä¸åˆ°çš„åæœï¼Œå› ä¸ºè°ƒç”¨è€…å°†æ”¶åˆ°ä¸€ä¸ªéé›¶å€¼ã€‚&lt;/li&gt;
&lt;li&gt;å°†å‡½æ•°è®¾è®¡ä¸ºæ¥æ”¶&lt;code&gt;io.Reader&lt;/code&gt;ç±»å‹è€Œä¸æ˜¯æ–‡ä»¶åå¯ä»¥æé«˜å‡½æ•°çš„å¯é‡ç”¨æ€§å¹¶ä½¿æµ‹è¯•æ›´å®¹æ˜“ã€‚&lt;/li&gt;
&lt;li&gt;ä¼ é€’æŒ‡å‘å‡½æ•°çš„æŒ‡é’ˆ&lt;code&gt;defer&lt;/code&gt;å’Œå°†è°ƒç”¨å°è£…åœ¨é—­åŒ…ä¸­æ˜¯å…‹æœæ¥æ”¶è€…å‚æ•°ç«‹å³æ±‚å€¼çš„ä¸¤ç§è§£å†³æ–¹æ¡ˆã€‚&lt;/li&gt;
&lt;/ul&gt;
</description>
      
    </item>
    
    <item>
      <title>Go tips-ç¬”è®°: string 36-41 mistakes</title>
      <link>https://weedge.github.io/post/notions/go-tips/go-tips-05-strings/</link>
      <pubDate>Tue, 14 Feb 2023 14:26:23 +0800</pubDate>
      
      <guid>https://weedge.github.io/post/notions/go-tips/go-tips-05-strings/</guid>
      
        <description>&lt;h2 id=&#34;ç¬”è®°&#34;&gt;ç¬”è®°&lt;/h2&gt;
&lt;p&gt;åœ¨ Go ä¸­ï¼Œstringæ˜¯ä¸€ç§ä¸å¯å˜çš„æ•°æ®ç»“æ„ï¼ŒåŒ…å«ä»¥ä¸‹å†…å®¹ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æŒ‡å‘ä¸å¯å˜å­—èŠ‚åºåˆ—çš„æŒ‡é’ˆï¼ŒæŒ‡å‘ä¸€ä¸ªbyteç±»å‹çš„æ•°ç»„&lt;/li&gt;
&lt;li&gt;æ­¤åºåˆ—ä¸­çš„æ€»å­—èŠ‚æ•°&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;stringåœ¨Goä¸­çš„å†…éƒ¨ç»“æ„æ˜¯&lt;code&gt;reflect.StringHeader&lt;/code&gt;ä½äº&lt;code&gt;reflect/value.go&lt;/code&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;c1&#34;&gt;// StringHeader is the runtime representation of a string.
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// It cannot be used safely or portably and its representation may
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// change in a later release.
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// Moreover, the Data field is not sufficient to guarantee the data
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// it references will not be garbage collected, so programs must keep
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// a separate, correctly typed pointer to the underlying data.
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;type&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;StringHeader&lt;/span&gt; &lt;span class=&#34;kd&#34;&gt;struct&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
	&lt;span class=&#34;nx&#34;&gt;Data&lt;/span&gt; &lt;span class=&#34;kt&#34;&gt;uintptr&lt;/span&gt;
	&lt;span class=&#34;nx&#34;&gt;Len&lt;/span&gt;  &lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;span class=&#34;c1&#34;&gt;//uintptr  an unsigned integer large enough to store the uninterpreted bits of a pointer value
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;å·²é€šè¿‡unsafe.Poniteræ˜¾ç¤ºçš„å°† stringè½¬æ¢æˆ&lt;code&gt;reflect.StringHeader&lt;/code&gt; ç»“æ„ï¼Œè¿›è€Œå¯ä»¥è·å–ç»“æ„ä¸­çš„DataæŒ‡æ­£ï¼Œç„¶åé€šè¿‡unsafe.Poniteræ˜¾ç¤ºè½¬æˆæ•°ç»„ï¼Œæ¯”å¦‚[5]byteï¼Œ æ•°ç»„å¤§å°ä¸ä¸€å®šç­‰äºåŸå§‹stringé•¿åº¦ï¼Œå³ä½¿è¶Šç•Œè®¿é—®ï¼Œå› ä¸ºæ˜¯åªè¯»ï¼Œå¦‚æœå†™çš„è¯ä¼šå‡ºç°panicï¼Œæ‰€ä»¥å¯ä»¥è¶Šç•Œè¿™æ ·è·å–ï¼› ä»£ç å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;ViewStringStruct&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
	&lt;span class=&#34;nx&#34;&gt;s&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;s&#34;&gt;&amp;#34;hello&amp;#34;&lt;/span&gt;
	&lt;span class=&#34;nx&#34;&gt;sh&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;reflect&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;StringHeader&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;unsafe&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Pointer&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;s&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;))&lt;/span&gt;
	&lt;span class=&#34;nx&#34;&gt;fmt&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Printf&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;0x%x\\n&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;sh&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Data&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
	&lt;span class=&#34;nx&#34;&gt;fmt&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Println&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;sh&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Len&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;c1&#34;&gt;// 5
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;	&lt;span class=&#34;nx&#34;&gt;ptr&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;unsafe&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Pointer&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;sh&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Data&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
	&lt;span class=&#34;c1&#34;&gt;//arrPtr := (*[]byte)(ptr) // panic
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;	&lt;span class=&#34;c1&#34;&gt;//arrPtr := (*[3]byte)(ptr)
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;	&lt;span class=&#34;c1&#34;&gt;//arrPtr := (*[100]byte)(ptr) // access violation, string just only read, so is ok
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;	&lt;span class=&#34;nx&#34;&gt;arrPtr&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;5&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;byte&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;ptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
	&lt;span class=&#34;nx&#34;&gt;fmt&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Println&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;arrPtr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;c1&#34;&gt;// [104 101 108 108 111]
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;	&lt;span class=&#34;nx&#34;&gt;fmt&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Printf&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;%s\\n&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;arrPtr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
	&lt;span class=&#34;c1&#34;&gt;//arrPtr[3] = 100 // panic, string cann&amp;#39;t change
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;[]byte å’Œ stringçš„ç›¸äº’è½¬æ¢ï¼Œåœ¨è¯»å–å­—ç¬¦ä¸²çš„åœºæ™¯ä¸‹ç»å¸¸ä½¿ç”¨åˆ°ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;String&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;b&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;[]&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;byte&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;kt&#34;&gt;string&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
	&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;string&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;unsafe&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Pointer&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;b&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;))&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;Str2Bytes&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;s&lt;/span&gt; &lt;span class=&#34;kt&#34;&gt;string&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;[]&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;byte&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
	&lt;span class=&#34;nx&#34;&gt;x&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;uintptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;unsafe&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Pointer&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;s&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;))&lt;/span&gt;
	&lt;span class=&#34;nx&#34;&gt;h&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;uintptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;x&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;],&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;x&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;],&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;x&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]}&lt;/span&gt;
	&lt;span class=&#34;k&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[]&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;byte&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;unsafe&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Pointer&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;h&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;))&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;36ä¸ç†è§£runeçš„æ¦‚å¿µ-é‡è¦&#34;&gt;36.ä¸ç†è§£runeçš„æ¦‚å¿µ ï¼ˆé‡è¦ï¼‰&lt;/h3&gt;
&lt;p&gt;å­—ç¬¦é›†å’Œç¼–ç ä¹‹é—´çš„åŒºåˆ«ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å­—ç¬¦é›†(charset)æ˜¯ä¸€ç»„å­—ç¬¦ã€‚ä¾‹å¦‚ï¼ŒUnicode å­—ç¬¦é›†åŒ…å« 2^21 ä¸ªå­—ç¬¦ã€‚&lt;/li&gt;
&lt;li&gt;ç¼–ç (encoding)æ˜¯å­—ç¬¦åˆ—è¡¨çš„äºŒè¿›åˆ¶è½¬æ¢ã€‚ä¾‹å¦‚ï¼ŒUTF-8 æ˜¯ä¸€ç§ç¼–ç æ ‡å‡†ï¼Œèƒ½å¤Ÿå°†æ‰€æœ‰ Unicode å­—ç¬¦ç¼–ç ä¸ºå¯å˜å­—èŠ‚æ•°ï¼ˆä» 1 åˆ° 4 å­—èŠ‚ï¼‰ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;UTF-8 å°†å­—ç¬¦ç¼–ç ä¸º 1 åˆ° 4 ä¸ªå­—èŠ‚ï¼Œå› æ­¤æœ€å¤šä¸º 32 ä½, rune æ˜¯ int32çš„åˆ«åï¼›éœ€è¦æ¸…æ¥šä»¥ä¸‹æ¦‚å¿µï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å­—ç¬¦é›†æ˜¯ä¸€ç»„å­—ç¬¦ï¼Œè€Œç¼–ç æè¿°äº†å¦‚ä½•å°†å­—ç¬¦é›†è½¬æ¢ä¸ºäºŒè¿›åˆ¶ã€‚&lt;/li&gt;
&lt;li&gt;åœ¨ Go ä¸­ï¼Œstringå¼•ç”¨ä»»æ„å­—èŠ‚çš„ä¸å¯å˜åˆ‡ç‰‡ã€‚&lt;/li&gt;
&lt;li&gt;Go æºä»£ç ä½¿ç”¨ UTF-8 ç¼–ç ã€‚å› æ­¤ï¼Œæ‰€æœ‰å­—ç¬¦ä¸²æ–‡å­—éƒ½æ˜¯ UTF-8 å­—ç¬¦ä¸²ã€‚ä½†æ˜¯å› ä¸ºå­—ç¬¦ä¸²å¯ä»¥åŒ…å«ä»»æ„å­—èŠ‚ï¼Œå¦‚æœå®ƒæ˜¯ä»å…¶ä»–åœ°æ–¹ï¼ˆä¸æ˜¯æºä»£ç ï¼‰è·å¾—çš„ï¼Œåˆ™ä¸èƒ½ä¿è¯å®ƒæ˜¯åŸºäº UTF-8 ç¼–ç çš„ã€‚&lt;/li&gt;
&lt;li&gt;runeå¯¹åº”äº Unicode ç ä½(code point)çš„æ¦‚å¿µï¼Œè¯·å‚è€ƒï¼š&lt;a href=&#34;https://en.wikipedia.org/wiki/Code_point&#34;&gt;code point&lt;/a&gt;ï¼Œç”±å•ä¸ªå€¼è¡¨ç¤ºã€‚&lt;/li&gt;
&lt;li&gt;ä½¿ç”¨ UTF-8ï¼Œå¯ä»¥å°† Unicode ç ä½(code point)ç¼–ç ä¸º 1 åˆ° 4 ä¸ªå­—èŠ‚ã€‚&lt;/li&gt;
&lt;li&gt;åœ¨ Go ä¸­ä½¿ç”¨&lt;code&gt;len&lt;/code&gt;å­—ç¬¦ä¸²è¿”å›å­—èŠ‚æ•°ï¼Œè€Œä¸æ˜¯runeæ•°ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;å¦‚æœæƒ³å‡†ç¡®è·å–åˆ°æœ‰ç¬¦æ–‡(rune)å­—ç¬¦ä¸²çš„é•¿åº¦ï¼Œå¯ä»¥ä½¿ç”¨&lt;code&gt;utf8.RuneCountInString&lt;/code&gt; å‡½æ•°&lt;/p&gt;
&lt;h3 id=&#34;37ä¸å‡†ç¡®çš„å­—ç¬¦ä¸²è¿­ä»£&#34;&gt;37.ä¸å‡†ç¡®çš„å­—ç¬¦ä¸²è¿­ä»£&lt;/h3&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;k&#34;&gt;for&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;i&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;range&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;s&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
    &lt;span class=&#34;nx&#34;&gt;fmt&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Printf&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;position %d: %c\\n&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;s&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;])&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;ä»¥ä¸Šä»£ç ï¼Œæ²¡æœ‰éå†æ¯ä¸ªruneï¼Œè€Œæ˜¯è¿­ä»£runeçš„æ¯ä¸ªèµ·å§‹ç´¢å¼•ï¼›&lt;/p&gt;
&lt;p&gt;å¦‚æœæƒ³éå†å­—ç¬¦ä¸²çš„ç¬¦æ–‡(rune)ï¼Œå¯ä»¥ä½¿ç”¨&lt;code&gt;range&lt;/code&gt;ç›´æ¥åœ¨å­—ç¬¦ä¸²ä¸Šå¾ªç¯ï¼Œå¿…é¡»è®°ä½ï¼Œ**ç´¢å¼•å¯¹åº”çš„ä¸æ˜¯ç¬¦æ–‡ç´¢å¼•ï¼Œè€Œæ˜¯ç¬¦æ–‡å­—èŠ‚åºåˆ—çš„èµ·å§‹ç´¢å¼•ï¼›**å› ä¸ºä¸€ä¸ªç¬¦æ–‡å¯ä»¥ç”±å¤šä¸ªå­—èŠ‚ç»„æˆï¼Œå¦‚æœè¦è®¿é—®ç¬¦æ–‡æœ¬èº«ï¼Œåº”è¯¥ä½¿ç”¨ çš„å€¼å˜é‡&lt;code&gt;range&lt;/code&gt;ï¼Œè€Œä¸æ˜¯å­—ç¬¦ä¸²ä¸­çš„ç´¢å¼•;&lt;/p&gt;
&lt;p&gt;å¦‚æœæƒ³è·å–ç¬¬iä¸ªå­—ç¬¦ä¸²çš„ç¬¦æ–‡(rune)ï¼Œåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹åº”è¯¥å°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºä¸€æ®µ runesã€‚&lt;/p&gt;
&lt;h3 id=&#34;38æ»¥ç”¨-trim-å‡½æ•°&#34;&gt;38.æ»¥ç”¨ trim å‡½æ•°&lt;/h3&gt;
&lt;p&gt;Goä¸­çš„stringsåŒ…ï¼Œå¼€å‘è€…å¯èƒ½ç»å¸¸æ··æ·†ä½¿ç”¨TrimRight å’Œ TrimSuffixï¼Œ æˆ–è€… TrimLeft å’Œ TrimPrefix&lt;/p&gt;
&lt;p&gt;TrimRightå‘åéå†æ¯ä¸ªç¬¦æ–‡ï¼›å¦‚æœç¬¦æ–‡æ˜¯æä¾›çš„é›†åˆçš„ä¸€éƒ¨åˆ†ï¼Œåˆ™è¯¥å‡½æ•°å°†å…¶åˆ é™¤ã€‚å¦‚æœä¸æ˜¯ï¼Œè¯¥å‡½æ•°å°†åœæ­¢è¿­ä»£å¹¶è¿”å›å‰©ä½™çš„å­—ç¬¦ä¸²ã€‚TrimLeft å‘å‰éå†åŒç†ã€‚  Trim å‡½æ•° ä¸¤è¾¹éå†ä¹Ÿæ˜¯ä¸€æ ·ã€‚&lt;/p&gt;
&lt;p&gt;å¦‚æœæƒ³åŒ¹é…æ•´ä½“çš„å­—ç¬¦ä¸²è¿›è¡Œåˆ é™¤çš„è¯ï¼Œ åº”è¯¥ä½¿ç”¨ TrimSuffix å’Œ TrimPrefixï¼Œå¦‚æœä¸¤è¾¹ç§»é™¤åˆ†åˆ«è°ƒç”¨è¿™ä¸¤ä¸ªæ–¹æ³•ã€‚&lt;/p&gt;
&lt;h3 id=&#34;39ä¼˜åŒ–ä¸è¶³çš„å­—ç¬¦ä¸²è¿æ¥&#34;&gt;39.ä¼˜åŒ–ä¸è¶³çš„å­—ç¬¦ä¸²è¿æ¥&lt;/h3&gt;
&lt;p&gt;å¦‚æœä½¿ç”¨ s += str çš„æ–¹å¼è¿æ¥å­—ç¬¦ä¸²ï¼Œä¼šæœ‰æ€§èƒ½é—®é¢˜ï¼Œå› ä¸ºå­—ç¬¦çš„æ•°æ®æ˜¯ä¸å¯å˜çš„ï¼Œæ¯æ¬¡å­—ç¬¦ä¸² + è¿æ¥æ“ä½œéƒ½ä¼šé‡æ–°åˆ†é…ä¸€æ¬¡å†…å­˜ç©ºé—´(allocator)ï¼›&lt;/p&gt;
&lt;p&gt;åº”è¯¥ä½¿ç”¨ strings.Builder ç»“æ„æ¥æ‹¼æ¥å­—ç¬¦ä¸²ï¼Œ Builderç»“æ„ä¸­æœ‰ä¸€ä¸ªbyteåˆ‡ç‰‡ buf []byteç”¨äºæ•°æ®æ‹¼æ¥ï¼ŒWriteString å†…éƒ¨ä½¿ç”¨appendæ¥æ“ä½œï¼Œå‰é¢æåˆ°appendæ“ä½œä¼šå‡ºå‘è‡ªåŠ¨æ‰©å®¹ï¼Œè¿™æ ·ä¸ç”¨æ¯æ¬¡æ‹¼æ¥çš„æ—¶å€™åˆ†é…ä¸€æ¬¡æ–°çš„å†…å­˜ç©ºé—´ï¼Œæé«˜äº†æ€§èƒ½ï¼› å¦‚æœå¯ä»¥è·å–åˆ°æ‹¼æ¥å­—ç¬¦ä¸²çš„é•¿åº¦ï¼Œé‚£å°±å¯ä»¥ç›´æ¥é€šè¿‡ Growå‡½æ•°æ¥ä¸€æ¬¡åˆå§‹åŒ–æ‹¼æ¥buf byteåˆ‡ç‰‡å†…å­˜ç©ºé—´ï¼Œè¿™æ ·æ€§èƒ½å¯ä»¥å¾—åˆ°è¿›ä¸€æ­¥çš„æå‡(ä¸ 21. åˆ‡ç‰‡åˆå§‹åŒ–æ•ˆç‡ä½ä¸‹ åˆ†æä¸€æ ·)ã€‚ç±»ä¼¼WriteStringæ–¹æ³•å¯¹åº”string ç±»å‹ï¼Œè¿˜æœ‰ä¸€ä¸‹ä¸‰æ€»æ–¹æ³•ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å­—èŠ‚åˆ‡ç‰‡ä½¿ç”¨&lt;code&gt;Write&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;å•å­—èŠ‚ä½¿ç”¨&lt;code&gt;WriteByte&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;å•ä¸ªç¬¦æ–‡ä½¿ç”¨&lt;code&gt;WriteRune&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;å½“ç„¶å¦‚æœæ‹¼æ¥çš„çŸ­å­—ç¬¦ä¸²å°±é‚£ä¹ˆå‡ ä¸ªï¼Œåˆ™æ²¡æœ‰å¿…è¦ä½¿ç”¨strings.Builder ç»“æ„æ¥æ‹¼æ¥å­—ç¬¦ä¸²ï¼Œæ€§èƒ½æå‡å¯ä»¥å¿½ç•¥ï¼Œä½†æ˜¯ä»£ç é‡å¯è¯»æ€§æ–¹é¢å°±é™ä½äº†ï¼Œå¯è¯»æ€§ä¸å¦‚ä½¿ç”¨è¿ç®—ç¬¦&lt;code&gt;+=&lt;/code&gt;æˆ–&lt;code&gt;fmt.Sprintf&lt;/code&gt;ã€‚&lt;/p&gt;
&lt;h3 id=&#34;40æ— ç”¨çš„å­—ç¬¦ä¸²è½¬æ¢&#34;&gt;40.æ— ç”¨çš„å­—ç¬¦ä¸²è½¬æ¢&lt;/h3&gt;
&lt;p&gt;æ¯”å¦‚ string è½¬[]byte,  []byte è½¬stringï¼Œ å¦‚æœæ˜¯ç›´æ¥ []byte(string) æˆ–è€… string([]byte)ï¼Œè½¬æ¢éƒ½ä¼šæœ‰é¢å¤–çš„å†…å­˜åˆ†é…ï¼Œè€Œä¸”è½¬æ¢åçš„stringæ˜¯ä¸å¯å˜çš„ï¼› æ‰€ä»¥åœ¨è¿›è¡Œå­—ç¬¦ä¸²æ“ä½œçš„æ—¶å€™ï¼Œå°½é‡éƒ½ä½¿ç”¨[]byteç±»å‹ï¼Œé¿å…è½¬æ¢stringå¸¦æ¥çš„é¢å¤–æ“ä½œï¼Œ&lt;code&gt;strings&lt;/code&gt;åŒ…ä¹Ÿæœ‰æ›¿ä»£å“åŒ…&lt;code&gt;bytes&lt;/code&gt;ï¼Œå¤§å¤šæ•° I/O Buffer éƒ½æ˜¯æ“ä½œ &lt;code&gt;[]byte&lt;/code&gt;ï¼Œå­—ç¬¦ä¸²çš„æ‹¼æ¥Builderç»“æ„ä¹Ÿæ˜¯å¯¹[]byteçš„æ“ä½œã€‚&lt;/p&gt;
&lt;h3 id=&#34;41å­å­—ç¬¦ä¸²å’Œå†…å­˜æ³„æ¼&#34;&gt;41.å­å­—ç¬¦ä¸²å’Œå†…å­˜æ³„æ¼&lt;/h3&gt;
&lt;p&gt;åœ¨ Go ä¸­ä½¿ç”¨å­å­—ç¬¦ä¸²æ“ä½œæ—¶ï¼Œå­—ç¬¦ä¸²çš„ç»“æ„å¯çŸ¥ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;æä¾›çš„é—´éš”æ˜¯åŸºäºå­—èŠ‚æ•°ï¼Œè€Œä¸æ˜¯ç¬¦æ–‡æ•°ã€‚&lt;/li&gt;
&lt;li&gt;å­å­—ç¬¦ä¸²æ“ä½œå¯èƒ½ä¼šå¯¼è‡´å†…å­˜æ³„æ¼ï¼Œå› ä¸ºç”Ÿæˆçš„å­å­—ç¬¦ä¸²å°†ä¸åˆå§‹å­—ç¬¦ä¸²å…±äº«ç›¸åŒçš„åº•å±‚æ•°ç»„ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;é˜²æ­¢è¿™ç§æƒ…å†µå‘ç”Ÿçš„è§£å†³æ–¹æ¡ˆæ˜¯æ‰‹åŠ¨æ‰§è¡Œå­—ç¬¦ä¸²å¤åˆ¶ï¼Œæˆ–è€…ä» Go 1.18 å¼€å§‹å¼•å…¥&lt;code&gt;strings.Clone&lt;/code&gt;ã€‚&lt;/p&gt;
&lt;h2 id=&#34;æ¦‚æ‹¬&#34;&gt;æ¦‚æ‹¬&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;äº†è§£ç¬¦æ–‡å¯¹åº”äº Unicode ç ä½(code point)çš„æ¦‚å¿µï¼Œå®ƒå¯ä»¥ç”±å¤šä¸ªå­—èŠ‚ç»„æˆï¼Œåº”è¯¥æ˜¯ Go å¼€å‘äººå‘˜å‡†ç¡®å¤„ç†å­—ç¬¦ä¸²çš„æ ¸å¿ƒçŸ¥è¯†çš„ä¸€éƒ¨åˆ†ã€‚&lt;/li&gt;
&lt;li&gt;ä½¿ç”¨&lt;code&gt;range&lt;/code&gt;è¿ç®—ç¬¦è¿­ä»£å­—ç¬¦ä¸²ä¼šè¿­ä»£ç¬¦æ–‡ï¼Œå…¶ç´¢å¼•å¯¹åº”äºç¬¦æ–‡å­—èŠ‚åºåˆ—çš„èµ·å§‹ç´¢å¼•ã€‚è¦è®¿é—®ç‰¹å®šçš„ç¬¦æ–‡ç´¢å¼•ï¼ˆä¾‹å¦‚ç¬¬ä¸‰ä¸ªç¬¦æ–‡ï¼‰ï¼Œè¯·å°†å­—ç¬¦ä¸²è½¬æ¢ä¸º&lt;code&gt;[]rune&lt;/code&gt;.&lt;/li&gt;
&lt;li&gt;&lt;code&gt;strings.TrimRight&lt;/code&gt;/&lt;code&gt;strings.TrimLeft&lt;/code&gt;åˆ é™¤ç»™å®šé›†åˆä¸­åŒ…å«çš„æ‰€æœ‰å‘å/å‘å‰ç¬¦æ–‡è¿”å›ï¼Œè€Œ&lt;code&gt;strings.TrimSuffix&lt;/code&gt;/&lt;code&gt;strings.TrimPrefix&lt;/code&gt;åˆ é™¤æä¾›åç¼€/å‰ç¼€çš„å­—ç¬¦ä¸²&lt;code&gt;è¿”å›&lt;/code&gt;ã€‚&lt;/li&gt;
&lt;li&gt;åº”è¯¥è¿æ¥å­—ç¬¦ä¸²åˆ—è¡¨&lt;code&gt;strings.Builder&lt;/code&gt;ä»¥é˜²æ­¢åœ¨æ¯æ¬¡è¿­ä»£æœŸé—´åˆ†é…æ–°å­—ç¬¦ä¸²ã€‚&lt;/li&gt;
&lt;li&gt;è®°ä½&lt;code&gt;bytes&lt;/code&gt;åŒ…æä¾›ä¸åŒ…ç›¸åŒçš„æ“ä½œ&lt;code&gt;strings&lt;/code&gt;å¯ä»¥å¸®åŠ©é¿å…é¢å¤–çš„å­—èŠ‚/å­—ç¬¦ä¸²è½¬æ¢ã€‚&lt;/li&gt;
&lt;li&gt;ä½¿ç”¨å‰¯æœ¬è€Œä¸æ˜¯å­å­—ç¬¦ä¸²å¯ä»¥é˜²æ­¢å†…å­˜æ³„æ¼ï¼Œå› ä¸ºå­å­—ç¬¦ä¸²æ“ä½œè¿”å›çš„å­—ç¬¦ä¸²å°†ç”±ç›¸åŒçš„å­—èŠ‚æ•°ç»„æ”¯æŒã€‚&lt;/li&gt;
&lt;/ul&gt;</description>
      
    </item>
    
    <item>
      <title>Go tips-ç¬”è®°: æ§åˆ¶è¯­å¥ 30-35 mistakes</title>
      <link>https://weedge.github.io/post/notions/go-tips/go-tips-04-control-structures/</link>
      <pubDate>Tue, 14 Feb 2023 10:26:23 +0800</pubDate>
      
      <guid>https://weedge.github.io/post/notions/go-tips/go-tips-04-control-structures/</guid>
      
        <description>&lt;h2 id=&#34;ç¬”è®°&#34;&gt;ç¬”è®°&lt;/h2&gt;
&lt;h3 id=&#34;30å¿½ç•¥äº†å…ƒç´ åœ¨-for-rangeå¾ªç¯ä¸­è¢«å¤åˆ¶-é‡è¦&#34;&gt;30.å¿½ç•¥äº†å…ƒç´ åœ¨ for rangeå¾ªç¯ä¸­è¢«å¤åˆ¶ (é‡è¦)&lt;/h3&gt;
&lt;p&gt;éœ€è¦æ³¨æ„ï¼Œ&lt;code&gt;range&lt;/code&gt;å¾ªç¯ä¸­çš„å€¼å…ƒç´ æ˜¯ä¸€ä¸ªå¤åˆ¶çš„å‰¯æœ¬ã€‚å› æ­¤ï¼Œå¦‚æœå€¼æ˜¯éœ€è¦æ”¹å˜ç»“æ„ï¼Œåªä¼šæ›´æ–°å‰¯æœ¬ï¼Œè€Œä¸æ˜¯å…ƒç´ æœ¬èº«ï¼Œé™¤éä¿®æ”¹çš„å€¼æˆ–å­—æ®µæ˜¯æŒ‡é’ˆã€‚åœ¨ç»å…¸forå¾ªç¯æˆ–è€…for rangeå¾ªç¯ä¸­ï¼Œé€šè¿‡ç´¢å¼•è®¿é—®å…ƒç´ æ¥è¿›è¡Œä¿®æ”¹ã€‚&lt;/p&gt;
&lt;h3 id=&#34;31å¿½ç•¥äº†å‚æ•°åœ¨for-rangeå¾ªç¯ä¸­çš„è®¡ç®—æ–¹å¼-é‡è¦&#34;&gt;31.å¿½ç•¥äº†å‚æ•°åœ¨for rangeå¾ªç¯ä¸­çš„è®¡ç®—æ–¹å¼ (é‡è¦)&lt;/h3&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;kd&#34;&gt;type&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;slice&lt;/span&gt; &lt;span class=&#34;kd&#34;&gt;struct&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
	&lt;span class=&#34;nx&#34;&gt;array&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;unsafe&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Pointer&lt;/span&gt;
	&lt;span class=&#34;nx&#34;&gt;len&lt;/span&gt;   &lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;
	&lt;span class=&#34;nx&#34;&gt;cap&lt;/span&gt;   &lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;

&lt;span class=&#34;nx&#34;&gt;s&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;[]&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;for&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;range&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;s&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
		&lt;span class=&#34;c1&#34;&gt;// debug check slice array ptr (bp[0]), 
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;		&lt;span class=&#34;c1&#34;&gt;// if append happen slicegrow, array ptr change -&amp;gt; new array
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;		&lt;span class=&#34;nx&#34;&gt;bp&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;uintptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;unsafe&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Pointer&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;s1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;))&lt;/span&gt;
		&lt;span class=&#34;nx&#34;&gt;fmt&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Printf&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;0x%x\\n&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;bp&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;])&lt;/span&gt;

    &lt;span class=&#34;nx&#34;&gt;s&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;append&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;s&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;10&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;strong&gt;notice&lt;/strong&gt;ï¼š è¿™æ®µä»£ç åœ¨åŸæ–‡ä¸­åˆ†æè¿‡ç¨‹æ˜¯æœ‰è¯¯çš„ï¼Œä½†ä¸å½±å“æ•´ä½“ç»“æœï¼›range s ä¹‹åä¼šå‘ç”Ÿå€¼æ‹·è´å‡ºç°copy s, åœ¨appendä¹‹å‰ï¼Œcopy s å’Œ sçš„array ptræŒ‡å‘åŒä¸€åœ°å€ç©ºé—´ï¼›å½“å‘ç”Ÿappendä¹‹åï¼Œs å‘ç”Ÿæ¥æ‰©å®¹ï¼Œsçš„ptræŒ‡å‘äº†æ–°çš„åœ°å€ç©ºé—´ï¼Œcopy sè¿˜æ˜¯æŒ‡å‘åŸæ¥çš„åœ°å€ç©ºé—´ï¼Œä¸¤è€…çš„ptræŒ‡å‘çš„åœ°å€ç©ºé—´å·²ç»ä¸åŒäº†ï¼›&lt;/p&gt;
&lt;p&gt;å¯¹äºch chan åŒç† ï¼Œ range ch ä¹‹åä¼šå‘ç”Ÿå€¼æ‹·è´å‡ºç°copy chï¼›å¯¹copy chè¿›è¡Œéå†;&lt;/p&gt;
&lt;p&gt;å¯¹åº”æ•°ç»„arr [â€¦]int{1,2,3} ä¹Ÿæ˜¯åŒç†ï¼Œrange arr ä¹‹åä¼šå‘ç”Ÿå€¼æ‹·è´å‡ºç°copy arr; å¯¹copy arrè¿›è¡Œéå†ï¼Œ å¦‚æœæƒ³æƒ³æ”¹å˜å¯¹åº”arrçš„å€¼ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹æ ‡è®¿é—®ï¼Œæˆ–è€… range &amp;amp;arr ä¹‹å åç”Ÿcopy æ•°ç»„å¼•ç”¨&amp;amp;arr æŒ‡å‘åŒä¸€åœ°å€ç©ºé—´;&lt;/p&gt;
&lt;h3 id=&#34;32å¿½ç•¥äº†åœ¨for-rangeä¸­ä½¿ç”¨æŒ‡é’ˆå…ƒç´ çš„å½±å“--é‡è¦&#34;&gt;32.å¿½ç•¥äº†åœ¨for rangeä¸­ä½¿ç”¨æŒ‡é’ˆå…ƒç´ çš„å½±å“  (é‡è¦)&lt;/h3&gt;
&lt;p&gt;ç”±äº for _, val := range   &amp;amp;valçš„åœ°å€æ˜¯ä¸€ä¸ªå¸¸é‡ï¼Œæ¯æ¬¡è¿­ä»£æŒ‡å‘ä¸åŒçš„å€¼ï¼Œä½†æ˜¯åœ°å€æ˜¯åŒä¸€ä¸ªï¼Œæ‰€ä»¥åœ¨ä½¿ç”¨&amp;amp;valï¼Œ éœ€è¦ç‰¹åˆ«æ³¨æ„ï¼Œå¦‚æœå­˜æ”¾&amp;amp;valå€¼ï¼Œå¾ªç¯è¿­ä»£å®Œä¹‹åï¼Œ&amp;amp;valæŒ‡å‘æœ€åä¸€ä¸ªå…ƒç´ ï¼›å¦‚ä½•è§£å†³å‘¢ï¼Œ ä¸¤ä¸ªä¸»è¦çš„è§£å†³æ–¹æ¡ˆï¼š 1. å€¼æ‹·è´ï¼Œç„¶åèµ‹äºˆåœ°å€ï¼›2. ç›´æ¥åªç”¨ä¸‹æ ‡å¯¹åº”å€¼çš„åœ°å€ï¼›&lt;/p&gt;
&lt;h3 id=&#34;33åœ¨mapè¿­ä»£æœŸé—´åšå‡ºé”™è¯¯çš„å‡è®¾-é‡è¦&#34;&gt;33.åœ¨mapè¿­ä»£æœŸé—´åšå‡ºé”™è¯¯çš„å‡è®¾ (é‡è¦)&lt;/h3&gt;
&lt;p&gt;ä¸€ç§æ˜¯é”™è¯¯çš„æœ‰åºæ€§å‡è®¾ï¼Œ mapæ˜¯æ— åºçš„ï¼Œæ¯æ¬¡å¾ªç¯æ˜¯éšæœºè·å–keyï¼Œå°±æ˜¯è¯´ï¼Œæ’å…¥é¡ºåºå’Œè¯»å–çš„é¡ºåºä¸ä¸€è‡´ï¼Œæ¯æ¬¡å¾ªç¯è¯»å–çš„é¡ºåºéƒ½ä¸åŒï¼›åº”è¯¥æ¸…æ¥šè¿™äº›mapæ— åºè¡Œä¸ºï¼Œè¿™æ ·ä»£ç å°±ä¸ä¼šåŸºäºé”™è¯¯çš„å‡è®¾ï¼›&lt;/p&gt;
&lt;p&gt;é‚£ä¹ˆä¸ºä»€ä¹ˆ Go æœ‰è¿™æ ·ä¸€ç§ä»¤äººæƒŠè®¶çš„æ–¹å¼æ¥éå†mapå‘¢ï¼Ÿè¿™æ˜¯è¯­è¨€è®¾è®¡è€…æœ‰æ„è¯†çš„é€‰æ‹©ã€‚ä»–ä»¬æƒ³æ·»åŠ æŸç§å½¢å¼çš„éšæœºæ€§ï¼Œä»¥ç¡®ä¿å¼€å‘äººå‘˜åœ¨ä½¿ç”¨mapæ—¶æ°¸è¿œä¸ä¼šä¾èµ–ä»»ä½•é¡ºåºå‡è®¾ï¼ˆè¯·å‚é˜…http://mng.bz/M2JWï¼‰ï¼›&lt;/p&gt;
&lt;p&gt;ä¸€ç§æ˜¯è¿­ä»£mapæ—¶æ’å…¥k/vï¼Œåœ¨ Go ä¸­ï¼Œå…è®¸åœ¨è¿­ä»£æœŸé—´æ›´æ–°mapï¼ˆæ’å…¥æˆ–åˆ é™¤å…ƒç´ ï¼‰ï¼›å®ƒä¸ä¼šå¯¼è‡´ç¼–è¯‘é”™è¯¯æˆ–è¿è¡Œæ—¶é”™è¯¯ã€‚ä½†æ˜¯ï¼Œåœ¨è¿­ä»£æœŸé—´åœ¨mapä¸­æ·»åŠ æ¡ç›®æ—¶ï¼Œåº”è¯¥è€ƒè™‘è¿™ç§æƒ…å†µï¼Œä»¥é¿å…å‡ºç°ä¸ç¡®å®šçš„ç»“æœã€‚å‡ºç°çš„æƒ…å†µï¼š&lt;/p&gt;
&lt;p&gt;åœ¨Goä¸­ï¼Œ&lt;em&gt;å¦‚æœåœ¨è¿­ä»£è¿‡ç¨‹ä¸­åˆ›å»ºäº†mapæ¡ç›®ï¼Œåˆ™å¯ä»¥åœ¨è¿­ä»£è¿‡ç¨‹ä¸­äº§ç”Ÿæˆ–è·³è¿‡ã€‚å¯¹äºåˆ›å»ºçš„æ¯ä¸ªæ¡ç›®ä»¥åŠä»ä¸€ä¸ªè¿­ä»£åˆ°ä¸‹ä¸€ä¸ªè¿­ä»£ï¼Œé€‰æ‹©å¯èƒ½ä¼šæœ‰æ‰€ä¸åŒã€‚&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;å¿…é¡»ç‰¢è®°è¿™ç§è¡Œä¸ºï¼Œä»¥ç¡®ä¿ä»£ç ä¸ä¼šäº§ç”Ÿä¸å¯é¢„æµ‹çš„è¾“å‡ºã€‚å¦‚æœæƒ³åœ¨è¿­ä»£mapçš„åŒæ—¶æ›´æ–°mapå¹¶ç¡®ä¿æ·»åŠ çš„æ¡ç›®ä¸æ˜¯è¿­ä»£çš„ä¸€éƒ¨åˆ†ï¼Œä¸€ç§è§£å†³æ–¹æ¡ˆæ˜¯copy mapï¼Œè¿­ä»£map, åœ¨ç”¨æ–°çš„copy mapä¸­æ·»åŠ æ¡ç›®ï¼›&lt;/p&gt;
&lt;p&gt;æ€»è€Œè¨€ä¹‹ï¼Œå½“ä½¿ç”¨mapæ—¶ï¼Œä¸åº”è¯¥ä¾èµ–ä»¥ä¸‹å†…å®¹ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æŒ‰é”®æ’åºçš„æ•°æ®&lt;/li&gt;
&lt;li&gt;ä¿ç•™æ’å…¥é¡ºåº&lt;/li&gt;
&lt;li&gt;ç¡®å®šæ€§è¿­ä»£é¡ºåº&lt;/li&gt;
&lt;li&gt;åœ¨æ·»åŠ å…ƒç´ çš„åŒä¸€è¿­ä»£ä¸­ç”Ÿæˆçš„å…ƒç´ &lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;è®°ä½è¿™äº›è¡Œä¸ºåº”è¯¥æœ‰åŠ©äºé¿å…åŸºäºé”™è¯¯å‡è®¾çš„å¸¸è§é”™è¯¯ã€‚&lt;/p&gt;
&lt;h3 id=&#34;34å¿½ç•¥-break-è¯­å¥æ˜¯å¦‚ä½•å·¥ä½œçš„&#34;&gt;34.å¿½ç•¥ break è¯­å¥æ˜¯å¦‚ä½•å·¥ä½œçš„&lt;/h3&gt;
&lt;p&gt;åœ¨Goä¸­ï¼Œ ä¸€ä¸ªåŸºæœ¬è§„åˆ™æ˜¯&lt;code&gt;break&lt;/code&gt;è¯­å¥ç»ˆæ­¢çš„æ‰§è¡Œæœ€é‡Œé¢çš„&lt;code&gt;for&lt;/code&gt;, &lt;code&gt;switch&lt;/code&gt;, æˆ–&lt;code&gt;select&lt;/code&gt;è¯­å¥ã€‚&lt;/p&gt;
&lt;p&gt;å¦‚ä½•ç¼–å†™ä»£ç æ¥æ‰“ç ´å¾ªç¯å‘¢ï¼Ÿ æœ€æƒ¯ç”¨çš„æ–¹æ³•æ˜¯ä½¿ç”¨æ ‡ç­¾ï¼Œ ä»å¯¹åº”çš„æ ‡ç­¾ä»£ç å—ä¸­break; æˆ–è€…å¯¹æ ‡ç­¾å—ä»£ç å°è£…æˆå‡½æ•°ï¼Œç›´æ¥return;&lt;/p&gt;
&lt;h3 id=&#34;35åœ¨å¾ªç¯ä¸­ä½¿ç”¨-defer&#34;&gt;35.åœ¨å¾ªç¯ä¸­ä½¿ç”¨ defer&lt;/h3&gt;
&lt;p&gt;ä½¿ç”¨&lt;code&gt;defer&lt;/code&gt;æ—¶ï¼Œå¿…é¡»è®°ä½å®ƒä¼šåœ¨å‘¨å›´å‡½æ•°è¿”å›æ—¶å®‰æ’å‡½æ•°è°ƒç”¨ã€‚å› æ­¤ï¼Œ&lt;code&gt;defer&lt;/code&gt;åœ¨å¾ªç¯å†…è°ƒç”¨å°†å †å æ‰€æœ‰è°ƒç”¨ï¼šå®ƒä»¬ä¸ä¼šåœ¨æ¯æ¬¡è¿­ä»£æœŸé—´æ‰§è¡Œï¼Œä¾‹å¦‚ï¼Œå¦‚æœå¾ªç¯æœªç»ˆæ­¢ï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´å†…å­˜æ³„æ¼ã€‚è§£å†³è¿™ä¸ªé—®é¢˜æœ€æ–¹ä¾¿çš„æ–¹æ³•æ˜¯åœ¨æ¯æ¬¡è¿­ä»£ä¸­å¼•å…¥å¦ä¸€ä¸ªå‡½æ•°æ¥è°ƒç”¨ã€‚ä½†æ˜¯ï¼Œå¦‚æœæ€§èƒ½è‡³å…³é‡è¦ï¼Œé‚£ä¹ˆä¸€ä¸ªç¼ºç‚¹å°±æ˜¯å‡½æ•°è°ƒç”¨å¢åŠ çš„å¼€é”€ã€‚å¦‚æœæœ‰è¿™æ ·çš„æƒ…å†µå¹¶ä¸”æƒ³è¦é˜²æ­¢è¿™ç§å¼€é”€ï¼Œåº”è¯¥åœ¨å¾ªç¯ä¹‹å‰æ‘†è„±&lt;code&gt;defer&lt;/code&gt;å¹¶æ‰‹åŠ¨å¤„ç†å»¶è¿Ÿè°ƒç”¨ã€‚&lt;/p&gt;
&lt;h2 id=&#34;æ¦‚æ‹¬&#34;&gt;æ¦‚æ‹¬&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;å¾ªç¯ä¸­çš„å€¼å…ƒç´ &lt;code&gt;range&lt;/code&gt;æ˜¯ä¸€ä¸ªå‰¯æœ¬ã€‚å› æ­¤è¦æ”¹å˜ä¸€ä¸ªç»“æ„ï¼Œä¾‹å¦‚ï¼Œé€šè¿‡å…¶ç´¢å¼•æˆ–é€šè¿‡ç»å…¸&lt;code&gt;for&lt;/code&gt;å¾ªç¯è®¿é—®å®ƒï¼ˆé™¤éä¿®æ”¹çš„å…ƒç´ æˆ–å­—æ®µæ˜¯æŒ‡é’ˆï¼‰ã€‚&lt;/li&gt;
&lt;li&gt;äº†è§£ä¼ é€’ç»™è¿ç®—ç¬¦çš„è¡¨è¾¾å¼&lt;code&gt;range&lt;/code&gt;åœ¨å¾ªç¯å¼€å§‹ä¹‹å‰ä»…è®¡ç®—ä¸€æ¬¡å¯ä»¥å¸®åŠ©é¿å…å¸¸è§é”™è¯¯ï¼Œä¾‹å¦‚é€šé“æˆ–åˆ‡ç‰‡è¿­ä»£ä¸­çš„ä½æ•ˆèµ‹å€¼ã€‚&lt;/li&gt;
&lt;li&gt;ä½¿ç”¨å±€éƒ¨å˜é‡æˆ–ä½¿ç”¨ç´¢å¼•è®¿é—®å…ƒç´ ï¼Œå¯ä»¥é˜²æ­¢åœ¨å¾ªç¯å†…å¤åˆ¶æŒ‡é’ˆæ—¶å‡ºé”™ã€‚&lt;/li&gt;
&lt;li&gt;ä¸ºç¡®ä¿åœ¨ä½¿ç”¨mapæ—¶å¯é¢„æµ‹è¾“å‡ºï¼Œè¯·è®°ä½mapæ•°æ®ç»“æ„
&lt;ul&gt;
&lt;li&gt;ä¸æŒ‰é”®æ’åºæ•°æ®&lt;/li&gt;
&lt;li&gt;ä¸ä¿ç•™æ’å…¥é¡ºåº&lt;/li&gt;
&lt;li&gt;æ²¡æœ‰ç¡®å®šçš„è¿­ä»£é¡ºåº&lt;/li&gt;
&lt;li&gt;ä¸ä¿è¯åœ¨è¿­ä»£æœŸé—´æ·»åŠ çš„å…ƒç´ å°†åœ¨æœ¬æ¬¡è¿­ä»£ä¸­ç”Ÿæˆ&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;code&gt;break&lt;/code&gt;è¯­å¥ç»ˆæ­¢çš„æ‰§è¡Œæœ€é‡Œé¢çš„&lt;code&gt;for&lt;/code&gt;, &lt;code&gt;switch&lt;/code&gt;, æˆ–&lt;code&gt;select&lt;/code&gt;è¯­å¥ï¼Œä½¿ç”¨æ ‡ç­¾ï¼Œå¯ä»¥ä»å¯¹åº”çš„æ ‡ç­¾ä»£ç å—ä¸­breakã€‚&lt;/li&gt;
&lt;li&gt;æå–å‡½æ•°å†…éƒ¨çš„å¾ªç¯é€»è¾‘ä¼šå¯¼è‡´&lt;code&gt;defer&lt;/code&gt;åœ¨æ¯æ¬¡è¿­ä»£ç»“æŸæ—¶æ‰§è¡Œä¸€æ¡è¯­å¥ã€‚&lt;/li&gt;
&lt;/ul&gt;
</description>
      
    </item>
    
    <item>
      <title>Go tips-ç¬”è®°: æ•°æ®ç±»å‹ 17-29 mistakes</title>
      <link>https://weedge.github.io/post/notions/go-tips/go-tips-03-data-types/</link>
      <pubDate>Mon, 13 Feb 2023 20:26:23 +0800</pubDate>
      
      <guid>https://weedge.github.io/post/notions/go-tips/go-tips-03-data-types/</guid>
      
        <description>&lt;h2 id=&#34;ç¬”è®°&#34;&gt;ç¬”è®°&lt;/h2&gt;
&lt;h3 id=&#34;17ä¸å…«è¿›åˆ¶æ–‡å­—æ··æ·†&#34;&gt;17.ä¸å…«è¿›åˆ¶æ–‡å­—æ··æ·†&lt;/h3&gt;
&lt;p&gt;Go å¯ä»¥å¤„ç†äºŒè¿›åˆ¶ã€åå…­è¿›åˆ¶ã€è™šæ•°å’Œå…«è¿›åˆ¶æ•°ã€‚å…«è¿›åˆ¶æ•°å­—ä»¥ 0 å¼€å¤´ã€‚ä½†æ˜¯ï¼Œä¸ºäº†æé«˜å¯è¯»æ€§å¹¶é¿å…æœªæ¥ä»£ç é˜…è¯»å™¨å¯èƒ½çŠ¯çš„é”™è¯¯ï¼Œè¯·ä½¿ç”¨å‰ç¼€æ˜ç¡®è¡¨ç¤ºå…«è¿›åˆ¶æ•°å­—&lt;code&gt;0o&lt;/code&gt;&lt;/p&gt;
&lt;h3 id=&#34;18å¿½ç•¥æ•´æ•°æº¢å‡º&#34;&gt;18.å¿½ç•¥æ•´æ•°æº¢å‡º&lt;/h3&gt;
&lt;p&gt;åœ¨å¤„ç†å¤§æ•°å­—æˆ–è¿›è¡Œè½¬æ¢æˆå°æ•°å­—ï¼Œè¿›è¡Œè¿ç®—æ—¶ï¼Œå¯èƒ½ä¼šå‡ºç°æº¢å‡ºã€‚æº¢å‡ºä¼šäº§ç”Ÿä¸€äº›bug, æ‰€ä»¥éœ€è¦å†ä¸€äº›å¯èƒ½æº¢å‡ºçš„åœºæ™¯ä¸­å¢åŠ æ£€æµ‹åˆ¤æ–­æ˜¯å¦æº¢å‡ºï¼Œæº¢å‡ºåˆ™ç›´æ¥panic,æˆ–è€…è¿›è¡Œé”™è¯¯è¿”å›&lt;/p&gt;
&lt;h3 id=&#34;19ä¸ç†è§£æµ®ç‚¹æ•°&#34;&gt;19.ä¸ç†è§£æµ®ç‚¹æ•°&lt;/h3&gt;
&lt;p&gt;ä»¥&lt;code&gt;float64&lt;/code&gt;ç±»å‹ä¸ºä¾‹ã€‚&lt;code&gt;math.SmallestNonzeroFloat64&lt;/code&gt;ï¼ˆ&lt;code&gt;float64&lt;/code&gt;æœ€å°å€¼ï¼‰å’Œ&lt;code&gt;math.MaxFloat64&lt;/code&gt;ï¼ˆæœ€å¤§å€¼ï¼‰ä¹‹é—´å­˜åœ¨æ— é™å¤šä¸ªå®æ•°å€¼&lt;code&gt;float64&lt;/code&gt;ã€‚ä½†æ˜¯è¯¥&lt;code&gt;float64&lt;/code&gt;ç±»å‹æœ‰æœ‰é™ä½æ•°ï¼š64ã€‚å› ä¸ºä¸å¯èƒ½å°†æ— é™å€¼æ”¾å…¥æœ‰é™ç©ºé—´ï¼Œæ‰€ä»¥å¿…é¡»ä½¿ç”¨è¿‘ä¼¼å€¼ï¼Œå› æ­¤å¯èƒ½ä¼šå¤±å»ç²¾åº¦ã€‚åŒæ ·çš„é€»è¾‘é€‚ç”¨äºç±»å‹&lt;code&gt;float32&lt;/code&gt;ã€‚æ‰€ä»¥åœ¨ä½¿ç”¨&lt;code&gt;==&lt;/code&gt;è¿ç®—ç¬¦æ¯”è¾ƒä¸¤ä¸ªæµ®ç‚¹æ•°å¯èƒ½ä¼šå¯¼è‡´ä¸å‡†ç¡®ï¼Œæµ®ç‚¹è®¡ç®—çš„ç»“æœå–å†³äºå®é™…çš„å¤„ç†å™¨ã€‚æœ€å¤šå¤„ç†å™¨æœ‰ä¸€ä¸ªæµ®ç‚¹å•å…ƒ (FPU) æ¥å¤„ç†æ­¤ç±»è®¡ç®—ã€‚ä¸èƒ½ä¿è¯åœ¨ä¸€å°æœºå™¨ä¸Šæ‰§è¡Œçš„ç»“æœåœ¨å¦ä¸€å°å…·æœ‰ä¸åŒ FPU çš„æœºå™¨ä¸Šæ˜¯ç›¸åŒçš„ã€‚&lt;code&gt;testify&lt;/code&gt;æµ‹è¯•( &lt;a href=&#34;https://github.com/stretchr/testify&#34;&gt;https://github.com/stretchr/testify&lt;/a&gt; ) æœ‰ä¸€ä¸ª&lt;code&gt;InDelta&lt;/code&gt;åŠŸèƒ½æ–­è¨€ä¸¤ä¸ªå€¼åœ¨å½¼æ­¤ç»™å®šçš„è¯¯å·®èŒƒå›´å†…ã€‚&lt;/p&gt;
&lt;p&gt;Go&lt;code&gt;float32&lt;/code&gt;å’Œ&lt;code&gt;float64&lt;/code&gt;æ˜¯è¿‘ä¼¼å€¼ã€‚å¿…é¡»ç‰¢è®°ä¸€äº›è§„åˆ™ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æ¯”è¾ƒä¸¤ä¸ªæµ®ç‚¹æ•°æ—¶ï¼Œæ£€æŸ¥å®ƒä»¬çš„å·®å¼‚æ˜¯å¦åœ¨å¯æ¥å—çš„èŒƒå›´å†…ã€‚&lt;/li&gt;
&lt;li&gt;æ‰§è¡ŒåŠ æ³•æˆ–å‡æ³•æ—¶ï¼Œå°†å…·æœ‰ç›¸ä¼¼æ•°é‡çº§çš„è¿ç®—åˆ†ç»„ä»¥è·å¾—æ›´å¥½çš„å‡†ç¡®æ€§ã€‚&lt;/li&gt;
&lt;li&gt;ä¸ºäº†ä¿è¯å‡†ç¡®æ€§ï¼Œå¦‚æœä¸€ç³»åˆ—è¿ç®—éœ€è¦åŠ ã€å‡ã€ä¹˜æˆ–é™¤ï¼Œè¯·å…ˆæ‰§è¡Œä¹˜é™¤è¿ç®—ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;20ä¸äº†è§£åˆ‡ç‰‡é•¿åº¦å’Œå®¹é‡&#34;&gt;20.ä¸äº†è§£åˆ‡ç‰‡é•¿åº¦å’Œå®¹é‡&lt;/h3&gt;
&lt;p&gt;å¹³å¸¸ä»£ç ä¸­ç»å¸¸ç”¨åˆ°æ˜¯çš„slice, å’Œæ•°ç»„ä¸æ˜¯ä¸€ä¸ªæ¦‚å¿µï¼Œè¿™ä¸ªæ˜¯åœ¨Goä¸­æœ€å®¹æ˜“çŠ¯å¾—é”™è¯¯ï¼Œéœ€è¦äº†è§£sliceç»“æ„ï¼Œå¯¹äºåªè¯»æ“ä½œï¼Œå¯ä»¥åœ¨sliceç»“æ„æŒ‡å‘çš„æ•°ç»„è¿›è¡Œå¤ç”¨ï¼Œè€Œæ— éœ€é‡æ–°åˆ†é…ç©ºé—´ï¼ˆæ³¨æ„å¤ç”¨åæ˜¯å¦éœ€è¦å›æ”¶ï¼‰ï¼›ä½†æ˜¯åœ¨appendæ“ä½œæ—¶ï¼Œéœ€è¦è€ƒè™‘ä»€ä¹ˆæ—¶å€™æ‰©å®¹ï¼Œé‡æ–°åˆ†é…äº†æ•°ç»„ç©ºé—´ï¼›ä¹¦ä¸­æœ‰ä¸ªé”™è¯¯åœ°æ–¹ï¼Œä¹Ÿæ˜¯å¾ˆå¤šæ–‡ç« ä»‹ç»slice growæ—¶ä¸å‡†ç¡®çš„åœ°æ–¹ï¼Œåœ¨1.18ç‰ˆæœ¬ä¹‹åï¼Œslicegrowæ–¹æ³•æœ‰æ‰€æ”¹è¿›ï¼Œå…·ä½“æŸ¥çœ‹ &lt;a href=&#34;https://github.com/golang/go/blob/release-branch.go1.18/src/runtime/slice.go&#34;&gt;https://github.com/golang/go/blob/release-branch.go1.18/src/runtime/slice.go&lt;/a&gt;  growsliceå‡½æ•°ï¼›&lt;/p&gt;
&lt;h3 id=&#34;21åˆ‡ç‰‡åˆå§‹åŒ–æ•ˆç‡ä½ä¸‹&#34;&gt;21.åˆ‡ç‰‡åˆå§‹åŒ–æ•ˆç‡ä½ä¸‹&lt;/h3&gt;
&lt;p&gt;åˆ‡ç‰‡åœ¨åˆå§‹åŒ–æ—¶ï¼Œå°½é‡åˆ†é…å¥½å®¹é‡ï¼Œå¦‚æœç»å¸¸appendæ“ä½œï¼Œå¯¹äºæœªåˆå§‹åŒ–å®¹é‡çš„slice, åœ¨append è¿›è¡Œslicegrowæ‰©å®¹æ“ä½œæ—¶ï¼Œä¼šåˆ†é…ä¸€ä¸ªä¸´æ—¶çš„å†…å­˜ç©ºé—´ï¼Œå¯¼è‡´ GC éœ€è¦ä»˜å‡ºé¢å¤–çš„åŠªåŠ›æ¥æ¸…ç†æ‰€æœ‰è¿™äº›ä¸´æ—¶åˆ†é…çš„å†…å­˜ç©ºé—´ã€‚ä¹Ÿå°½é‡åˆå§‹åŒ–sliceé•¿åº¦å¤§å°ï¼Œè¿™æ ·ç›´æ¥å¯ä»¥ç”¨æ•°ç»„ä¸‹æ ‡è¿›è¡Œæ“ä½œï¼Œæ•ˆç‡æ›´é«˜ï¼Œå¯¹äºæ€§èƒ½æœ‰è¦æ±‚çš„åœºæ™¯é€‰æ‹©åè€…ï¼›&lt;/p&gt;
&lt;h3 id=&#34;22å¯¹-nil-å’Œç©ºåˆ‡ç‰‡æ„Ÿåˆ°å›°æƒ‘&#34;&gt;22.å¯¹ nil å’Œç©ºåˆ‡ç‰‡æ„Ÿåˆ°å›°æƒ‘&lt;/h3&gt;
&lt;p&gt;æ¯”å¦‚ è¿™ä¸ªåœ¨å¼€å‘apiè¿”å›jsonæ•°æ®æ—¶ç»å¸¸ä¼šé‡åˆ°ï¼Œä¸€èˆ¬æƒ…å†µä¼šè¿”å›ä¸€ä¸ªç©ºåˆ‡ç‰‡ï¼Œé˜²æ­¢è°ƒç”¨ç«¯æœªåˆ¤æ–­nilè€Œå¯¼è‡´panicï¼›å…·ä½“æ ¹æ®ä¸Šä¸‹æ–‡åˆå§‹åŒ–ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;var s []string&lt;/code&gt;å¦‚æœä¸ç¡®å®šæœ€ç»ˆé•¿åº¦å¹¶ä¸”åˆ‡ç‰‡å¯ä»¥ä¸ºç©º&lt;/li&gt;
&lt;li&gt;&lt;code&gt;[]string(nil)&lt;/code&gt;ä½œä¸ºåˆ›å»º nil å’Œç©ºåˆ‡ç‰‡çš„è¯­æ³•ç³–&lt;/li&gt;
&lt;li&gt;&lt;code&gt;make([]string,&lt;/code&gt; &lt;code&gt;length)&lt;/code&gt;å¦‚æœæœªæ¥çš„é•¿åº¦å·²çŸ¥&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;23æ²¡æœ‰æ­£ç¡®æ£€æŸ¥åˆ‡ç‰‡æ˜¯å¦ä¸ºç©º&#34;&gt;23.æ²¡æœ‰æ­£ç¡®æ£€æŸ¥åˆ‡ç‰‡æ˜¯å¦ä¸ºç©º&lt;/h3&gt;
&lt;p&gt;ä¸ç®¡æ˜¯ç©ºåˆ‡ç‰‡è¿˜æ˜¯nil, é€šè¿‡æ£€æŸ¥é•¿åº¦len(slice)æ˜¯æœ€å¥½çš„é€‰æ‹©, éƒ½æ˜¯0&lt;/p&gt;
&lt;h3 id=&#34;24æ²¡æœ‰æ­£ç¡®ä½¿ç”¨åˆ‡ç‰‡copy&#34;&gt;24.æ²¡æœ‰æ­£ç¡®ä½¿ç”¨åˆ‡ç‰‡copy&lt;/h3&gt;
&lt;p&gt;å…¶å®å°±æ˜¯äº†è§£copyå‡½æ•°ï¼Œå¤åˆ¶åˆ°ç›®æ ‡åˆ‡ç‰‡çš„å…ƒç´ æ•°é‡ä¸ºæºåˆ‡ç‰‡å’Œç›®æ ‡åˆ‡ç‰‡é•¿åº¦æœ€å°å€¼min(len(dst),len(src))ï¼Œè€Œä¸”ä¸èƒ½æ··æ·†å‚æ•°æ¥ï¼Œcopy(dst,src []Type)ï¼Œè¿˜æœ‰ä¸€ç§æ›¿æ¢æ–¹æ¡ˆï¼š&lt;code&gt;dst := append([]int(nil), src...)&lt;/code&gt;&lt;/p&gt;
&lt;h3 id=&#34;25ä½¿ç”¨åˆ‡ç‰‡é™„åŠ çš„æ„å¤–å‰¯ä½œç”¨&#34;&gt;25.ä½¿ç”¨åˆ‡ç‰‡é™„åŠ çš„æ„å¤–å‰¯ä½œç”¨&lt;/h3&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;nx&#34;&gt;s1&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;[]&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;span class=&#34;nx&#34;&gt;s2&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;s1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;
&lt;span class=&#34;nx&#34;&gt;s3&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;append&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;s2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;10&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;span class=&#34;c1&#34;&gt;// s1=[1 2 10],len(s1)=3,cap(s1)=3
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// s2=[2],len(s2)=1,cap(s2)=2
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// s3=[2 10],len(s3)=2,cap(s3)=2
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;è¿™é‡Œå’Œç¬¬20ä¸ªä¸€æ ·çš„é“ç†ï¼Œç†è§£åˆ‡ç‰‡çš„æ¥å£ï¼Œä»¥åŠä»€ä¹ˆæ—¶å€™æ‰©å®¹ï¼Œä¸æ‰©å®¹æ—¶ï¼Œå…±äº«åº•å±‚æ•°ç»„ï¼Œæ‰“å°æ•°æ®æœ‰é•¿åº¦å¤§å°å†³å®šï¼Œå¦‚æœåœ¨å®¹é‡èŒƒå›´å†…æƒ³è¦è·å–æº¢å‡ºçš„æ•°æ®ï¼Œä¹Ÿæ˜¯å¯ä»¥åšåˆ°çš„ï¼Œéœ€è¦å¼•å…¥ä¸å®‰å…¨çš„æŒ‡é’ˆæ“ä½œï¼Œæ¯”å¦‚æƒ³è¶Šç•Œè·å–s2[1]çš„å€¼ï¼Œå¦‚ä¸‹ ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;nx&#34;&gt;bp&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;uintptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;unsafe&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Pointer&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;s2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;))&lt;/span&gt;
&lt;span class=&#34;nx&#34;&gt;h&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;uintptr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;bp&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;],&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;bp&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;+&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;bp&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]}&lt;/span&gt;
&lt;span class=&#34;nx&#34;&gt;ss2&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[]&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int64&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;unsafe&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Pointer&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;h&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;))&lt;/span&gt;
&lt;span class=&#34;nx&#34;&gt;ss2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;100&lt;/span&gt;
&lt;span class=&#34;c1&#34;&gt;// s1=[1 2 100],len(s1)=3,cap(s1)=3
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// s2=[2,100],len(s2)=2,cap(s2)=2
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// s3=[2 100],len(s3)=1,cap(s3)=2
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;å¦‚æœä¸æƒ³æ”¹å˜s1å’Œs2æŒ‡å‘çš„æ•°ç»„æ•°æ®ï¼Œå¯ä»¥è¿›è¡Œcopyæ“ä½œï¼Œç„¶ååœ¨appendæ•°æ®ç»™s3&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;nx&#34;&gt;s1&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;[]&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;span class=&#34;nx&#34;&gt;s2&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;s1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;]&lt;/span&gt;
&lt;span class=&#34;nx&#34;&gt;s3&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;:=&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;make&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;([]&lt;/span&gt;&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;span class=&#34;nb&#34;&gt;copy&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;s3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;s2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;span class=&#34;c1&#34;&gt;// s3 := append([]int(nil),s2...)
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;s3&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;append&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;s3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;10&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;span class=&#34;c1&#34;&gt;// s1=[1 2 3],len(s1)=3,cap(s1)=3
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// s2=[2],len(s2)=1,cap(s2)=2
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// s3=[2 10],len(s3)=2,cap(s3)=2
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;em&gt;å®Œæ•´åˆ‡ç‰‡è¡¨è¾¾å¼&lt;/em&gt;: &lt;code&gt;s[low:high:max]&lt;/code&gt;ã€‚maxæ²¡æœ‰èµ‹å€¼é»˜è®¤ä¸ºåŸå§‹æ•°æ®å®¹é‡å¤§å°ï¼Œå¦‚æœmaxå€¼è¶…è¿‡åŸå§‹æ•°æ®å®¹é‡åˆ™ä¼šåœ¨è¿è¡Œæ—¶panicï¼›ç”Ÿæˆçš„åˆ‡ç‰‡çš„å®¹é‡ç­‰äº&lt;code&gt;max - low&lt;/code&gt;ï¼Œé•¿åº¦ç­‰äº&lt;code&gt;high-low&lt;/code&gt;ï¼Œæ•°æ®èŒƒå›´åœ¨[low,high) å·¦é—­å³å¼€åŒºé—´è¿›è¡Œåˆ‡ç‰‡ã€‚&lt;/p&gt;
&lt;p&gt;æ‰€ä»¥ä½¿ç”¨åˆ‡ç‰‡æ—¶ï¼Œå¯èƒ½ä¼šé¢ä¸´å¯¼è‡´æ„æƒ³ä¸åˆ°çš„å‰¯ä½œç”¨çš„æƒ…å†µã€‚å¦‚æœç”Ÿæˆçš„åˆ‡ç‰‡çš„é•¿åº¦å°äºå…¶å®¹é‡ï¼Œ&lt;code&gt;append&lt;/code&gt;åˆ™å¯ä»¥æ”¹å˜åŸå§‹åˆ‡ç‰‡ã€‚å¦‚æœæƒ³é™åˆ¶å¯èƒ½çš„å‰¯ä½œç”¨çš„èŒƒå›´ï¼Œå¯ä»¥ä½¿ç”¨åˆ‡ç‰‡copyæˆ–å®Œæ•´çš„åˆ‡ç‰‡è¡¨è¾¾å¼ï¼Œè¿™ä¼šé˜»æ­¢è¿›è¡Œå¤åˆ¶ã€‚&lt;/p&gt;
&lt;h3 id=&#34;26åˆ‡ç‰‡å’Œå†…å­˜æ³„æ¼-é‡è¦&#34;&gt;26.åˆ‡ç‰‡å’Œå†…å­˜æ³„æ¼ (é‡è¦ï¼‰&lt;/h3&gt;
&lt;p&gt;åˆ‡ç‰‡ä¸­å¯¼è‡´å†…å­˜æ³„éœ²çš„åŸå› æ˜¯ï¼Œåˆ‡ç‰‡ä¸€ç›´åœ¨å¤ç”¨ï¼Œæœªè¢«gcé‡Šæ”¾ï¼Œæ¯æ¬¡é‡æ–°ä½¿ç”¨åˆä¼šé‡æ–°åˆ†é…ä¸€æ¬¡å†…å­˜ç©ºé—´ï¼Œä¸€ç›´é‡å¤åˆ†é…ï¼Œå¯¼è‡´å†…å­˜æ³„éœ²ï¼Œæ¯”å¦‚ï¼Œåœ¨ç½‘ç»œè¯·æ±‚ä¸­ï¼Œæ¶ˆæ¯æ•°æ®å¤§äº32KBï¼Œéœ€è¦å¯¹ç½‘ç»œçš„æ¶ˆæ¯åè®®è¿›è¡Œè§£åŒ…ä¹‹åå¤„ç†ä¿å­˜æ•°æ®ï¼Œ é¦–å…ˆä»ç½‘ç»œä¸­è·å–æ¶ˆæ¯ï¼Œç„¶åä»æ¶ˆæ¯ä¸­è·å–åè®®å¤´ï¼Œé€šè¿‡åˆ‡ç‰‡æ–¹å¼å¤ç”¨å¯¹åº”æ¶ˆæ¯ï¼Œä¸‹æ¬¡ä»ç½‘ç»œè¯·æ±‚ä¸­è·å–æ¶ˆæ¯æ•°æ®ï¼Œåˆé‡æ–°ä»å †ä¸Šåˆ†é…äº†æ–°çš„å†…å­˜ç©ºé—´ï¼Œä»¥å‰å¤ç”¨çš„ç©ºé—´è¿˜æœªé‡Šæ”¾ï¼Œæœ€ç»ˆå¯¼è‡´å†…å­˜æ³„éœ²ï¼›è§£å†³è¿™ä¸ªé—®é¢˜çš„æ–¹æ¡ˆï¼Œä»æ¶ˆæ¯ä¸­è·å–åè®®å¤´ï¼Œåªcopyåè®®å¤´éƒ¨åˆ†æ•°æ®è¿›è¡Œå¤„ç†ï¼Œå¤„ç†å®Œï¼Œç”±gcæ¥é‡Šæ”¾å†…å­˜ç©ºé—´ï¼›&lt;/p&gt;
&lt;p&gt;æ ¹æ®ç»éªŒï¼Œè¯·è®°ä½å¯¹å¤§åˆ‡ç‰‡æˆ–æ•°ç»„è¿›è¡Œåˆ‡ç‰‡å¯èƒ½ä¼šå¯¼è‡´æ½œåœ¨çš„é«˜å†…å­˜æ¶ˆè€—ã€‚å‰©ä½™çš„ç©ºé—´ä¸ä¼šè¢« GC å›æ”¶ï¼Œå°½ç®¡åªä½¿ç”¨äº†å‡ ä¸ªå…ƒç´ ï¼Œä½†å¯ä»¥ä¿ç•™ä¸€ä¸ªå¤§çš„åå¤‡æ•°ç»„ã€‚copyåˆ‡ç‰‡æ˜¯é˜²æ­¢è¿™ç§æƒ…å†µçš„è§£å†³æ–¹æ¡ˆã€‚é€šè¿‡runtime.ReadMemStats å‡½æ•°å¯ä»¥è·å–è¿è¡Œæ—¶å†…å­˜alloctorçš„ç»Ÿè®¡ä¿¡æ¯MemStats,&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span class=&#34;kd&#34;&gt;func&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;printAlloc&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
	&lt;span class=&#34;kd&#34;&gt;var&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;m&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;runtime&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;MemStats&lt;/span&gt;
	&lt;span class=&#34;nx&#34;&gt;runtime&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;ReadMemStats&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;m&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
	&lt;span class=&#34;nx&#34;&gt;fmt&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;Printf&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;%d KB\\n&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;m&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nx&#34;&gt;Alloc&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1024&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;ä»‹ç»äº†ä¸¤ä¸ªæ½œåœ¨çš„å†…å­˜æ³„æ¼é—®é¢˜:&lt;/p&gt;
&lt;p&gt;ç¬¬ä¸€ä¸ªæ˜¯å…³äºå¯¹ç°æœ‰åˆ‡ç‰‡æˆ–æ•°ç»„è¿›è¡Œåˆ‡ç‰‡ä»¥ä¿ç•™å®¹é‡ï¼›å¦‚æœå¤„ç†å¤§å‹åˆ‡ç‰‡å¹¶å°†å®ƒä»¬é‡æ–°åˆ‡ç‰‡ä»¥ä»…ä¿ç•™ä¸€å°éƒ¨åˆ†ï¼Œåˆ™å¤§é‡å†…å­˜å°†ä¿æŒåˆ†é…çŠ¶æ€ä½†æœªä½¿ç”¨ã€‚&lt;/p&gt;
&lt;p&gt;ç¬¬äºŒä¸ªé—®é¢˜æ˜¯ï¼Œå½“å¯¹æŒ‡é’ˆæˆ–å…·æœ‰æŒ‡é’ˆå­—æ®µçš„ç»“æ„ä½¿ç”¨åˆ‡ç‰‡æ“ä½œæ—¶ï¼Œéœ€è¦çŸ¥é“ GC ä¸ä¼šå›æ”¶è¿™äº›å…ƒç´ ã€‚&lt;/p&gt;
&lt;p&gt;åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¸¤ä¸ªé€‰é¡¹æ˜¯æ‰§è¡Œå¤åˆ¶æˆ–å°†å‰©ä½™å…ƒç´ å­—æ®µæ˜¾å¼æ ‡è®°ä¸º&lt;code&gt;nil&lt;/code&gt;ã€‚&lt;/p&gt;
&lt;h3 id=&#34;27ä½æ•ˆçš„mapåˆå§‹åŒ–&#34;&gt;27.ä½æ•ˆçš„mapåˆå§‹åŒ–&lt;/h3&gt;
&lt;p&gt;åœ¨ä½¿ç”¨sliceåˆ‡ç‰‡æ—¶ï¼Œå¦‚æœé¢„å…ˆçŸ¥é“è¦æ·»åŠ åˆ°åˆ‡ç‰‡ä¸­çš„å…ƒç´ æ•°é‡ï¼Œå°±å¯ä»¥ä½¿ç”¨ç»™å®šçš„å¤§å°æˆ–å®¹é‡å¯¹å…¶è¿›è¡Œåˆå§‹åŒ–ã€‚è¿™é¿å…äº†å¿…é¡»ä¸æ–­é‡å¤æ˜‚è´µçš„åˆ‡ç‰‡å¢é•¿æ“ä½œã€‚è¿™ä¸ªæƒ³æ³•ä¸mapç±»ä¼¼ã€‚è¿™æ ·å¯ä»¥å°½é‡å‡å°‘mapçš„æ‰©å®¹ï¼Œé‡æ–°åˆ†é…æ–°çš„ç©ºé—´ï¼Œä»¥åŠæ‰©å®¹åçš„rehashå¹³è¡¡æ‰€æœ‰å…ƒç´ ã€‚&lt;/p&gt;
&lt;h3 id=&#34;28mapå’Œå†…å­˜æ³„æ¼&#34;&gt;28.mapå’Œå†…å­˜æ³„æ¼&lt;/h3&gt;
&lt;p&gt;å‘mapä¸­æ·»åŠ &lt;em&gt;nä¸ª&lt;/em&gt;å…ƒç´ ï¼Œç„¶ååˆ é™¤æ‰€æœ‰å…ƒç´ ï¼Œæ„å‘³ç€åœ¨å†…å­˜ä¸­ä¿ç•™ç›¸åŒæ•°é‡çš„æ¡¶ã€‚å› ä¸º Go map çš„å¤§å°åªä¼šå¢åŠ ï¼Œæ‰€ä»¥å®ƒçš„å†…å­˜æ¶ˆè€—ä¹Ÿä¼šå¢åŠ ã€‚æ²¡æœ‰è‡ªåŠ¨ç­–ç•¥æ¥ç¼©å°å®ƒã€‚å¦‚æœè¿™å¯¼è‡´é«˜å†…å­˜æ¶ˆè€—ï¼Œå¯ä»¥å°è¯•ä¸åŒçš„æ–¹æ³•ï¼Œä¾‹å¦‚å¼ºåˆ¶ Go é‡æ–°åˆ›å»ºmap(è¿™ç§æ–¹å¼ä¸å¤ªå¯å–ï¼Œåœ¨å¤åˆ¶ä¹‹åå’Œä¸‹ä¸€æ¬¡åƒåœ¾å›æ”¶ä¹‹å‰ï¼Œå¯èƒ½ä¼šåœ¨çŸ­æ—¶é—´å†…æ¶ˆè€—å½“å‰å†…å­˜çš„ä¸¤å€) æˆ– valå­˜æ”¾æŒ‡å‘æ•°æ®çš„æŒ‡é’ˆï¼›&lt;/p&gt;
&lt;p&gt;tipsï¼š éœ€è¦äº†è§£mapçš„ç»“æ„ï¼Œä»¥åŠmapä¸­çš„key ï¼ˆå¯æ¯”è¾ƒç±»å‹ï¼‰&lt;/p&gt;
&lt;h3 id=&#34;29é”™è¯¯åœ°æ¯”è¾ƒå€¼&#34;&gt;29.é”™è¯¯åœ°æ¯”è¾ƒå€¼&lt;/h3&gt;
&lt;p&gt;å…·ä½“å¯æ¯”è¾ƒçš„ç±»å‹è§å®˜æ–¹æœ€æ–°æ–‡æ¡£ï¼š (é‡è¦)&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://go.dev/ref/spec#Comparison_operators&#34;&gt;The Go Programming Language Specification - The Go Programming Language&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;è€ƒè™‘åˆ°æ–‡æ¡£ä¸­è¿™äº›è¡Œä¸ºï¼Œå¦‚æœå¿…é¡»æ¯”è¾ƒä¸¤ä¸ªåˆ‡ç‰‡ã€ä¸¤ä¸ªmapæˆ–ä¸¤ä¸ªåŒ…å«ä¸å¯æ¯”è¾ƒç±»å‹çš„ç»“æ„ï¼Œæœ‰å“ªäº›é€‰æ‹©ï¼Ÿå¦‚æœåšæŒä½¿ç”¨æ ‡å‡†åº“ï¼Œä¸€ä¸ªé€‰æ‹©æ˜¯ä½¿ç”¨è¿è¡Œæ—¶åå°„&lt;code&gt;reflect&lt;/code&gt;åŒ…ä¸­çš„&lt;code&gt;reflect.DeepEqual&lt;/code&gt;æ–¹æ³•ï¼Œ ä½†æ˜¯ç”±æ€§èƒ½æŸå¤±ï¼Œä¸€èˆ¬ä¸ç”¨äºç”Ÿäº§ç¯å¢ƒï¼Œä¸»è¦ç”¨äºå•å…ƒæµ‹è¯•è¿”å›çš„å€¼æ˜¯å¦æ˜¯é¢„æœŸå€¼ï¼Œè¿˜æœ‰ç±»ä¼¼çš„ä¸‰æ–¹åº“ç”¨äºæµ‹è¯•æ—¶çš„æœŸæœ›å€¼æ¯”è¾ƒï¼Œæ¯”å¦‚&lt;code&gt;go-cmp&lt;/code&gt; ( &lt;a href=&#34;https://github.com/google/go-cmp&#34;&gt;https://github.com/google/go-cmp&lt;/a&gt; ) æˆ–&lt;code&gt;testify&lt;/code&gt;( &lt;a href=&#34;https://github.com/stretchr/testify&#34;&gt;https://github.com/stretchr/testify&lt;/a&gt; )ï¼›å¦‚æœæ€§èƒ½åœ¨è¿è¡Œæ—¶è‡³å…³é‡è¦ï¼Œé‚£ä¹ˆå®æ–½è‡ªå®šä¹‰æ–¹æ³•å¯èƒ½æ˜¯æœ€ä½³è§£å†³æ–¹æ¡ˆï¼›&lt;/p&gt;
&lt;h2 id=&#34;æ¦‚æ‹¬&#34;&gt;æ¦‚æ‹¬&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;é˜…è¯»ç°æœ‰ä»£ç æ—¶ï¼Œè¯·è®°ä½ä»¥ 0 å¼€å¤´çš„æ•´æ•°æ–‡å­—æ˜¯å…«è¿›åˆ¶æ•°ã€‚æ­¤å¤–ï¼Œä¸ºäº†æé«˜å¯è¯»æ€§ï¼Œé€šè¿‡åœ¨å…«è¿›åˆ¶æ•´æ•°å‰åŠ ä¸Š&lt;code&gt;0o&lt;/code&gt;.&lt;/li&gt;
&lt;li&gt;å› ä¸ºæ•´æ•°ä¸Šæº¢å’Œä¸‹æº¢åœ¨ Go ä¸­æ˜¯é™é»˜å¤„ç†çš„ï¼Œæ‰€ä»¥å¯ä»¥å®ç°è‡ªå·±çš„å‡½æ•°æ¥æ•è·å®ƒä»¬ã€‚&lt;/li&gt;
&lt;li&gt;åœ¨ç»™å®šçš„è¯¯å·®èŒƒå›´å†…è¿›è¡Œæµ®ç‚¹æ¯”è¾ƒå¯ä»¥ç¡®ä¿ä»£ç æ˜¯å¯ç§»æ¤çš„ã€‚&lt;/li&gt;
&lt;li&gt;æ‰§è¡ŒåŠ æ³•æˆ–å‡æ³•æ—¶ï¼Œå°†å…·æœ‰ç›¸ä¼¼æ•°é‡çº§çš„è¿ç®—åˆ†ç»„ä»¥æé«˜å‡†ç¡®æ€§ã€‚æ­¤å¤–ï¼Œåœ¨åŠ å‡æ³•ä¹‹å‰æ‰§è¡Œä¹˜æ³•å’Œé™¤æ³•ã€‚&lt;/li&gt;
&lt;li&gt;äº†è§£åˆ‡ç‰‡é•¿åº¦å’Œå®¹é‡ä¹‹é—´çš„å·®å¼‚åº”è¯¥æ˜¯ Go å¼€å‘äººå‘˜æ ¸å¿ƒçŸ¥è¯†çš„ä¸€éƒ¨åˆ†ã€‚åˆ‡ç‰‡é•¿åº¦æ˜¯åˆ‡ç‰‡ä¸­å¯ç”¨å…ƒç´ çš„æ•°é‡ï¼Œè€Œåˆ‡ç‰‡å®¹é‡æ˜¯åå¤‡æ•°ç»„ä¸­å…ƒç´ çš„æ•°é‡ã€‚&lt;/li&gt;
&lt;li&gt;åˆ›å»ºåˆ‡ç‰‡æ—¶ï¼Œå¦‚æœå…¶é•¿åº¦å·²çŸ¥ï¼Œåˆ™ä½¿ç”¨ç»™å®šçš„é•¿åº¦æˆ–å®¹é‡å¯¹å…¶è¿›è¡Œåˆå§‹åŒ–ã€‚è¿™å‡å°‘äº†åˆ†é…çš„æ•°é‡å¹¶æé«˜äº†æ€§èƒ½ã€‚mapçš„é€»è¾‘ç›¸åŒï¼Œéœ€è¦åˆå§‹åŒ–å®ƒä»¬çš„å¤§å°ã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;append&lt;/code&gt;å¦‚æœä¸¤ä¸ªä¸åŒçš„å‡½æ•°ä½¿ç”¨ç”±åŒä¸€æ•°ç»„æ”¯æŒçš„åˆ‡ç‰‡ï¼Œåˆ™ä½¿ç”¨å¤åˆ¶æˆ–å®Œæ•´åˆ‡ç‰‡è¡¨è¾¾å¼æ˜¯ä¸€ç§é˜²æ­¢äº§ç”Ÿå†²çªçš„æ–¹æ³•ã€‚ä½†æ˜¯ï¼Œå¦‚æœæƒ³ç¼©å°ä¸€ä¸ªå¤§åˆ‡ç‰‡ï¼Œåªæœ‰åˆ‡ç‰‡copyå¯ä»¥é˜²æ­¢å†…å­˜æ³„æ¼ã€‚&lt;/li&gt;
&lt;li&gt;è¦ä½¿ç”¨å†…ç½®å‡½æ•°å°†ä¸€ä¸ªåˆ‡ç‰‡å¤åˆ¶åˆ°å¦ä¸€ä¸ªåˆ‡ç‰‡&lt;code&gt;copy&lt;/code&gt;ï¼Œè¯·è®°ä½å¤åˆ¶çš„å…ƒç´ æ•°å¯¹åº”äºä¸¤ä¸ªåˆ‡ç‰‡é•¿åº¦ä¹‹é—´çš„æœ€å°å€¼ã€‚&lt;/li&gt;
&lt;li&gt;ä½¿ç”¨æŒ‡é’ˆåˆ‡ç‰‡æˆ–å…·æœ‰æŒ‡é’ˆå­—æ®µçš„ç»“æ„ï¼Œå¯ä»¥é€šè¿‡æ ‡è®°&lt;code&gt;nil&lt;/code&gt;ä¸ºåˆ‡ç‰‡æ“ä½œæ’é™¤çš„å…ƒç´ æ¥é¿å…å†…å­˜æ³„æ¼ã€‚&lt;/li&gt;
&lt;li&gt;ä¸ºäº†é˜²æ­¢å¸¸è§çš„æ··æ·†ï¼Œä¾‹å¦‚åœ¨ä½¿ç”¨&lt;code&gt;encoding/json&lt;/code&gt;or&lt;code&gt;reflect&lt;/code&gt;åŒ…æ—¶ï¼Œéœ€è¦äº†è§£ nil å’Œç©ºåˆ‡ç‰‡ä¹‹é—´çš„åŒºåˆ«ã€‚ä¸¤è€…éƒ½æ˜¯é›¶é•¿åº¦ã€é›¶å®¹é‡çš„åˆ‡ç‰‡ï¼Œä½†åªæœ‰ nil åˆ‡ç‰‡ä¸éœ€è¦åˆ†é…ã€‚&lt;/li&gt;
&lt;li&gt;è¦æ£€æŸ¥åˆ‡ç‰‡æ˜¯å¦ä¸åŒ…å«ä»»ä½•å…ƒç´ ï¼Œè¯·æ£€æŸ¥å…¶é•¿åº¦ã€‚æ— è®ºåˆ‡ç‰‡æ˜¯å¦ä¸º&lt;code&gt;nil&lt;/code&gt;ç©ºï¼Œæ­¤æ£€æŸ¥éƒ½æœ‰æ•ˆã€‚mapä¹Ÿæ˜¯å¦‚æ­¤ã€‚&lt;/li&gt;
&lt;li&gt;è¦è®¾è®¡æ˜ç¡®çš„ APIï¼Œä¸åº”è¯¥åŒºåˆ† nil å’Œç©ºåˆ‡ç‰‡ã€‚&lt;/li&gt;
&lt;li&gt;mapå¯ä»¥åœ¨å†…å­˜ä¸­å¢é•¿ï¼Œä½†æ°¸è¿œä¸ä¼šç¼©å°ã€‚å› æ­¤ï¼Œå¦‚æœå®ƒå¯¼è‡´ä¸€äº›å†…å­˜é—®é¢˜ï¼Œå¯ä»¥å°è¯•ä¸åŒçš„é€‰é¡¹ï¼Œä¾‹å¦‚å¼ºåˆ¶ Go é‡æ–°åˆ›å»ºmapæˆ–ä½¿ç”¨æŒ‡é’ˆã€‚&lt;/li&gt;
&lt;li&gt;è¦åœ¨ Go ä¸­æ¯”è¾ƒç±»å‹ï¼Œå¦‚æœä¸¤ç§ç±»å‹æ˜¯å¯æ¯”è¾ƒçš„ï¼Œåˆ™å¯ä»¥ä½¿ç”¨&lt;code&gt;==&lt;/code&gt;å’Œ&lt;code&gt;!=&lt;/code&gt;è¿ç®—ç¬¦ï¼šå¸ƒå°”å€¼ã€æ•°å­—ã€stringã€æŒ‡é’ˆã€channelå’Œç”±å¯æ¯”è¾ƒç±»å‹ç»„æˆçš„ç»“æ„ä½“ã€‚å¦åˆ™ï¼Œå¯ä»¥ä½¿ç”¨&lt;code&gt;reflect.DeepEqual&lt;/code&gt;åå°„å¹¶ä¸ºæ­¤ä»˜å‡ºä»£ä»·ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨è‡ªå®šä¹‰å®ç°å’Œåº“ã€‚&lt;/li&gt;
&lt;/ul&gt;
</description>
      
    </item>
    
    <item>
      <title>Go tips-ç¬”è®°: ä»£ç å’Œé¡¹ç›®ç»„ç»‡ 1-16 mistakes</title>
      <link>https://weedge.github.io/post/notions/go-tips/go-tips-02-code-project-organization/</link>
      <pubDate>Mon, 13 Feb 2023 14:26:23 +0800</pubDate>
      
      <guid>https://weedge.github.io/post/notions/go-tips/go-tips-02-code-project-organization/</guid>
      
        <description>&lt;h2 id=&#34;å¼•è¨€&#34;&gt;å¼•è¨€&lt;/h2&gt;
&lt;p&gt;ä»é”™è¯¯ä¸­å­¦ä¹ æ•ˆç‡æ›´é«˜ï¼Œè€Œä¸”ä»é”™è¯¯å¤±è´¥çš„åœºæ™¯ä¸‹å­¦ä¹ ï¼Œå¾€å¾€æ¯”ç›´æ¥äº¤ä»£æ­£ç¡®æ€§çš„ç†è®ºçŸ¥è¯†ï¼Œæ²¡æœ‰ä¸Šä¸‹æ–‡çš„ç»“æœå» è®°å¿†å·©å›ºçŸ¥è¯†ï¼Œåœ¨é”™è¯¯å¤±è´¥åœºæ™¯ä¸‹å¾€å¾€å°è±¡æ›´æ·±åˆ»ï¼›å¯ä»¥å¸®åŠ©æ›´å¥½åœ°é¿å…é”™è¯¯å¹¶åšå‡ºæ›´æ˜æ™ºã€æ›´æœ‰æ„è¯†çš„å†³å®šï¼Œå› ä¸ºç°åœ¨äº†è§£äº†é”™è¯¯èƒŒåçš„åŸºæœ¬åŸç†ï¼Œæœ‰ç§è¯¥æ­»çš„ï¼Œæç„¶å¤§æ‚Ÿçš„æ„Ÿè§‰ï¼Œæ‹¨å¼€é›¨é›¾è§æœˆæ˜ï¼›&lt;/p&gt;
&lt;p&gt;æ¶µç›–äº†å¯èƒ½å¯¼è‡´å„ç§è½¯ä»¶é”™è¯¯çš„æ¡ˆä¾‹ï¼ŒåŒ…æ‹¬æ•°æ®ç«äº‰ã€æ³„æ¼ã€é€»è¾‘é”™è¯¯å’Œå…¶ä»–ç¼ºé™·ã€‚è™½ç„¶å‡†ç¡®çš„æµ‹è¯•åº”è¯¥æ˜¯å°½æ—©å‘ç°æ­¤ç±»é”™è¯¯çš„ä¸€ç§æ–¹å¼ï¼Œä½†æœ‰æ—¶å¯èƒ½ä¼šå› ä¸ºæ—¶é—´é™åˆ¶æˆ–å¤æ‚æ€§ç­‰ä¸åŒå› ç´ è€Œé”™è¿‡æ¡ˆä¾‹ã€‚å› æ­¤ï¼Œä½¿ç”¨Golangå¼€å‘ï¼Œç¡®ä¿é¿å…å¸¸è§é”™è¯¯è‡³å…³é‡è¦ã€‚&lt;/p&gt;
&lt;p&gt;æœ‰äº›å‘å¯èƒ½æ›¾ç»è¸©è¿‡ï¼Œé€šè¿‡è¿™äº›mistakesäº§ç”Ÿå…±é¸£ï¼ŒåŠ æ·±å°è±¡ï¼ŒåŒæ—¶å¯ä»¥ç»§ç»­è¿½åŠ ä¸€äº›æ–°çš„å‘æ¥å¡«å……,æ¯”å¦‚ç³»ç»Ÿæ€§èƒ½è°ƒä¼˜ï¼ŒåŒ…æ‹¬IO,  ç½‘ç»œï¼Œæ•°æ®ç¼–è§£ç å‹ç¼©ï¼Œåˆ†å¸ƒå¼ç³»ç»Ÿï¼Œä¸šåŠ¡ç³»ç»Ÿç»„ç»‡æ¶æ„ï¼Œé€æ­¥å­¦ä¹ å®è·µè¯•é”™è¿‡ç¨‹ã€‚å­¦ä¹ ç¬”è®°å¼€ä¸ªå¤´ã€‚&lt;/p&gt;
&lt;p&gt;ä»£ç åœ°å€ï¼š&lt;a href=&#34;https://github.com/teivah/100-go-mistakes&#34;&gt;https://github.com/teivah/100-go-mistakes&lt;/a&gt; ; å¯ä»¥ç›´æ¥æŸ¥çœ‹é‡Œé¢çš„ç¤ºä¾‹ï¼Œè¿›è¡ŒCRï¼Œå¦‚æœçŸ¥é“å‘çš„ç¼˜ç”±ï¼Œè¯´æ˜å·²ç»é¿å‘äº† :ï¼‰&lt;/p&gt;
&lt;h2 id=&#34;ç¬”è®°&#34;&gt;ç¬”è®°&lt;/h2&gt;
&lt;h3 id=&#34;1å˜é‡éšè—&#34;&gt;1.å˜é‡éšè—&lt;/h3&gt;
&lt;p&gt;éœ€è¦ç†è§£golangä¸­å˜é‡çš„ä½œç”¨åŸŸï¼Œåœ¨å—ä¸­å£°æ˜çš„å˜é‡åå¯ä»¥åœ¨å†…éƒ¨å—ä¸­é‡æ–°å£°æ˜(:=)ï¼›å¸¸è§äºerrå˜é‡åçš„é‡ç”¨çš„æƒ…å†µï¼Œéœ€è¦è€ƒè™‘æ˜¯å¦éœ€è¦é‡æ–°å‘½åï¼›ä½¿ç”¨ vet lintå·¥å…·è¿›è¡Œæ£€æµ‹&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;go install golang.org/x/tools/go/analysis/passes/shadow/cmd/shadow
go vet --vettool&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;$(&lt;/span&gt;which shadow&lt;span class=&#34;k&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;{&lt;/span&gt;go file&lt;span class=&#34;o&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;2ä¸å¿…è¦çš„åµŒå¥—ä»£ç å·¥ç¨‹è§„èŒƒ&#34;&gt;2.ä¸å¿…è¦çš„åµŒå¥—ä»£ç ï¼ˆå·¥ç¨‹è§„èŒƒï¼‰&lt;/h3&gt;
&lt;p&gt;è¿™ä¸ªå°±æ˜¯ä»£ç é£æ ¼é—®é¢˜äº†ï¼Œgoogle code styleé‡Œï¼Œæˆ–è€…ä»£ç è´¨é‡ä¸­ç»å¸¸ä¼šæåˆ°çš„ï¼Œå’Œç¼–ç¨‹è¯­è¨€æ— å…³è”ï¼Œå°½é‡ä¿æŒåœ¨ä¸€å±‚åµŒå¥—(happy path)ï¼Œç»å¸¸å‡ºç°çš„åˆ¤æ–­å‰ç½®ï¼›&lt;/p&gt;
&lt;h3 id=&#34;3æ»¥ç”¨åˆå§‹åŒ–å‡½æ•°&#34;&gt;3.æ»¥ç”¨åˆå§‹åŒ–å‡½æ•°&lt;/h3&gt;
&lt;p&gt;init å‡½æ•°æ˜¯golangè§„å®špackageåˆå§‹åŒ–å‡½æ•°ï¼Œä¸èƒ½ç›´æ¥æ˜¾ç¤ºè°ƒç”¨ï¼Œ è€Œä¸”è°ƒç”¨é¡ºåºæŒ‰ç…§åŒ…åå­—æ¯é¡ºåºä¾æ¬¡è°ƒç”¨æ‰§è¡Œï¼Œå³ä½¿æœªä½¿ç”¨(_), ä¹Ÿä¼šè°ƒç”¨åŒ…çš„initæ–¹æ³•ï¼›è¿˜å¯ä»¥åœ¨åŒ…ä¸­å£°æ˜å¤šä¸ªinitå‡½æ•°ä¾æ¬¡æ‰§è¡Œï¼› æ‰€ä»¥å¯¹äºåˆå§‹åŒ–ä¾èµ–èµ„æºæœåŠ¡ï¼Œéœ€è¦å•æµ‹çš„åœºæ™¯ï¼Œä¸èƒ½ä½¿ç”¨åŒ…ä¸­çš„initå‡½æ•°ï¼Œè€Œæ˜¯ä½¿ç”¨è‡ªå®šä¹‰çš„åˆå§‹åŒ–å‡½æ•°ï¼Œå¹¶ä¸”å¯ä»¥è¿”å›å…·ä½“åˆå§‹åŒ–å®ä¾‹ï¼Œå¯ç”¨äºä¾èµ–æ³¨å…¥ï¼Œå·¥ç¨‹åŒ–ç»å¸¸ä¼šä½¿ç”¨ï¼› ä½†æ˜¯ä»…ä»…æ˜¯ç®€å•çš„åˆå§‹åŒ–ï¼Œé™æ€çš„ç½—åˆ—ï¼Œå½¼æ­¤æ²¡æœ‰å…³è”ï¼Œ å¯ä»¥ç”¨initåˆå§‹åŒ–ï¼Œ æ¯”å¦‚ net/http/pprofåŒ…ç›´æ¥åœ¨initä¸­åˆå§‹åŒ–äº†è·¯ç”±æ³¨å†Œçš„æœåŠ¡æ¥å£å‡½æ•°å¥æŸ„ï¼›&lt;/p&gt;
&lt;h3 id=&#34;4è¿‡åº¦ä½¿ç”¨-getter-å’Œ-setterå·¥ç¨‹è§„èŒƒ&#34;&gt;4.è¿‡åº¦ä½¿ç”¨ getter å’Œ setterï¼ˆå·¥ç¨‹è§„èŒƒï¼‰&lt;/h3&gt;
&lt;p&gt;è¿™ä¸ªåœ¨é¢å‘å¯¹è±¡è¯­è¨€c++/javaä¸­ç»å¸¸ä¼šå‡ºç°çš„æƒ…å†µï¼Œå°†ç§æœ‰æˆå‘˜å°è£…æˆæ–¹æ³•è°ƒç”¨ï¼Œéšè—å†…éƒ¨ä¸€äº›é€»è¾‘ç»†èŠ‚ï¼› golangä¸ä¼šå¼ºåˆ¶çº¦æŸè¿™æ ·åšï¼Œæ¯”å¦‚time.Timerç»“æ„ æˆå‘˜C æ˜¯å…¬å¼€çš„ï¼Œç›¸å¯¹æ¯”è¾ƒè‡ªç”±ï¼›å¦å¤–å¦‚æœä½¿ç”¨getterå°è£…ç§æœ‰æˆå‘˜çš„å‡½æ•°åï¼Œä¸éœ€è¦Getå‰ç¼€ï¼Œè¿™ä¸ªä»…ä»…æ˜¯ ç»Ÿä¸€çš„ä»£ç é£æ ¼é—®é¢˜ï¼Œéµå¾ªä¸šç•Œæ ‡å‡†Google Styleå°±è¡Œï¼›&lt;/p&gt;
&lt;h3 id=&#34;5interface-æ±¡æŸ“&#34;&gt;5.interface æ±¡æŸ“&lt;/h3&gt;
&lt;p&gt;è®¾è®¡æŠ½è±¡æ¥å£å‡½æ•°çš„ç²’åº¦ï¼Œè®°ä½Go ä¸­çš„ä¸€ä¸ªè‘—åè°šè¯­ ( &lt;a href=&#34;https://www.youtube.com/watch?v=PAAkCSZUG1c&amp;amp;t=318s&#34;&gt;https://www.youtube.com/watch?v=PAAkCSZUG1c&amp;amp;t=318s&lt;/a&gt; )&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;The bigger the interface, the weaker the abstraction.&lt;/p&gt;
&lt;p&gt;â€”Rob Pike&lt;/p&gt;
&lt;p&gt;As Einstein said, â€œEverything should be made as simple as possible, but no simpler.â€&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;æ¥å£å¯ä»¥è¿›è¡Œç»„åˆä½¿ç”¨ï¼Œå°½é‡ä¿æŒå•ä¸€åŸåˆ™å§~ golangçš„è®¾è®¡æ·±å—UNIXå“²å­¦çš„å½±å“( &lt;a href=&#34;https://web.archive.org/web/20100724002941/http://herpolhode.com/rob/&#34;&gt;&lt;strong&gt;&lt;!-- raw HTML omitted --&gt;Rob Pike&lt;!-- raw HTML omitted --&gt;&lt;/strong&gt;&lt;/a&gt; æ˜¯è´å°”å®éªŒå®¤unixå°ç»„æˆå‘˜ï¼‰ï¼›&lt;/p&gt;
&lt;p&gt;æ¥å£æŠ½è±¡å¯ä»¥å’Œå®ç°è§£è€¦ï¼Œè¿›è¡Œä¾èµ–åè½¬ï¼Œä»£ç ä¸ä¾èµ–å…·ä½“å®ç°ï¼Œæ–°å¢æˆ–è€…æ›´æ”¹æ–¹æ³•ä¸å½±å“æ•´ä½“æŠ½è±¡æµç¨‹ç»“æ„ï¼Œä¹Ÿæ–¹ä¾¿æ•´ä½“mockæµ‹è¯•ï¼ŒLiskov æ›¿æ¢åŸåˆ™ï¼ˆ Robert C. Martin çš„ SOLID è®¾è®¡åŸåˆ™ä¸­çš„L)ï¼Œåœ¨ä½¿ç”¨golangå®ç°DDDä¸šåŠ¡é¢†åŸŸæ¨¡å‹ä¸­ç»å¸¸ä¼šä½¿ç”¨åˆ°ï¼›&lt;/p&gt;
&lt;p&gt;æ¥å£é™åˆ¶ï¼Œæ¯”å¦‚ä¸€ä¸ªé…ç½®ç»“æ„ä½“åªéœ€è¦è¯»é…ç½®å†…å®¹ï¼Œ åˆ™è¿™ä¸ªç»“æ„ä½“åªéœ€è¦ä¸€ä¸ªåªè¯»æ¥å£æˆå‘˜ï¼Œé™åˆ¶ç»“æ„ä½“çš„æ¥å£è¡Œä¸ºï¼Œä»¥ä¾¿è¿™ä¸ªç»“æ„ä½“å¯ä»¥ä»¥ç»„åˆæ–¹å¼åŠ å…¥æ–°çš„æ¥å£è¡Œä¸º&lt;/p&gt;
&lt;p&gt;å¯¹äºä¸éœ€è¦æŠ½è±¡çš„åœºæ™¯ï¼Œåˆ™ä¸åº”è¯¥ä½¿ç”¨interfaceæ¥æŠ½é—²ä¸€å±‚ï¼Œç›´æ¥è°ƒç”¨å¯¹åº”å®ç°å‡½æ•°å³å¯ï¼Œæ— éœ€è¿‡åº¦ä¾èµ–æ¥å£è®¾è®¡ï¼Œåœ¨ä»£ç ä¸­åˆ›å»ºæŠ½è±¡æ—¶åº”è¯¥è°¨æ…â€”â€”æŠ½è±¡åº”è¯¥è¢«å‘ç°ï¼Œè€Œä¸æ˜¯åˆ›å»ºã€‚&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Donâ€™t design with interfaces, discover them.&lt;/p&gt;
&lt;p&gt;â€”Rob Pike&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&#34;6ç”Ÿäº§è€…ä¾§-interface&#34;&gt;6.ç”Ÿäº§è€…ä¾§ interface&lt;/h3&gt;
&lt;p&gt;å°±æ˜¯æä¾›ç»™å¤–éƒ¨ä½¿ç”¨çš„åŒ…ä¸­æ²¡æœ‰æŠ½è±¡æ—¶ï¼Œä¸åº”è¯¥è¿‡åº¦è®¾è®¡æ¥å£ï¼Œåœ¨æ¥å£ä¸­å®šä¹‰è¿‡å¤šæ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•åœ¨æ¶ˆè´¹æ¥å£ç«¯ä½¿ç”¨æ—¶ä¸ä¼šç”¨åˆ°è¿™äº›è¿‡å¤šçš„æ–¹æ³•ï¼Œå­˜åœ¨è¿‡åº¦çš„æ¥å£è®¾è®¡ï¼›golangå…è®¸åœ¨åŒ…å¤–æ¶ˆè´¹ä¾§æ¥å®šä¹‰æ¥å£ï¼Œå¦‚æœåœ¨ç”Ÿäº§ä¾§å®šä¹‰æ¥å£ï¼ŒæŠ½è±¡åº”è¯¥æ˜¯è¢«å‘ç°æ˜¯é€šç”¨çš„ï¼Œè€Œä¸”æ¥å£ä¸­æ–¹æ³•ç²’åº¦å°½å¯èƒ½çš„å°ï¼Œæ–¹ä¾¿æ¶ˆè´¹ä¾§ä½¿ç”¨æ–¹ç»„åˆï¼›&lt;/p&gt;
&lt;h3 id=&#34;7è¿”å›-interface&#34;&gt;7.è¿”å› interface&lt;/h3&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;em&gt;Be conservative in what you do, be liberal in what you accept from others.&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;â€”Transmission Control Protocol&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;å…¶å®è¿˜æ˜¯æ¥å£æŠ½è±¡æ—¶çš„åŸåˆ™ï¼š æŠ½è±¡åº”è¯¥è¢«å‘ç°ï¼Œè€Œä¸æ˜¯åˆ›å»ºã€‚æ€»ä¹‹ï¼Œåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œä¸åº”è¯¥è¿”å›æ¥å£ï¼Œè€Œæ˜¯è¿”å›å…·ä½“çš„å®ç°ã€‚å¦åˆ™ï¼Œç”±äºåŒ…ä¾èµ–æ€§ï¼Œå®ƒä¼šä½¿è®¾è®¡æ›´åŠ å¤æ‚ï¼Œå¹¶ä¸”ä¼šé™åˆ¶çµæ´»æ€§ï¼Œå› ä¸ºæ‰€æœ‰ä½¿ç”¨ç«¯éƒ½å¿…é¡»ä¾èµ–ç›¸åŒçš„æŠ½è±¡ã€‚åŒæ ·ï¼Œç»“è®ºä¸å‰é¢çš„éƒ¨åˆ†ç±»ä¼¼ï¼šå¦‚æœçŸ¥é“ï¼ˆä¸æ˜¯é¢„è§ï¼‰æŠ½è±¡å¯¹ä½¿ç”¨ç«¯æœ‰å¸®åŠ©ï¼Œå¯ä»¥è€ƒè™‘è¿”å›ä¸€ä¸ªæ¥å£ã€‚å¦åˆ™ï¼Œä¸åº”è¯¥å¼ºåˆ¶æŠ½è±¡ï¼›ä»–ä»¬åº”è¯¥è¢«ä½¿ç”¨ç«¯å‘ç°ã€‚å¦‚æœä½¿ç”¨ç«¯å‡ºäºæŸç§åŸå› éœ€è¦æŠ½è±¡å®ç°ï¼Œå®ƒä»ç„¶å¯ä»¥åœ¨ä½¿ç”¨ç«¯æ‰§è¡Œæ­¤æ“ä½œã€‚&lt;/p&gt;
&lt;h3 id=&#34;8anyinterface-says-nothing&#34;&gt;8.any(interface{}) says nothing&lt;/h3&gt;
&lt;p&gt;åœ¨ Go ä¸­ï¼ŒæŒ‡å®šé›¶ä¸ªæ–¹æ³•çš„æ¥å£ç±»å‹ç§°ä¸ºç©ºæ¥å£ï¼Œinterface{}. åœ¨ Go 1.18 ä¸­ï¼Œé¢„å…ˆå£°æ˜çš„ç±»å‹anyæˆä¸ºç©ºæ¥å£çš„åˆ«åï¼›å› æ­¤ï¼Œæ‰€æœ‰interface{}å‡ºç°çš„åœ°æ–¹éƒ½å¯ä»¥æ›¿æ¢ä¸ºanyã€‚åœ¨è®¸å¤šæƒ…å†µä¸‹ï¼Œanyå¯ä»¥è¢«è®¤ä¸ºæ˜¯è¿‡åº¦æ¦‚æ‹¬ï¼›æ­£å¦‚ Rob Pike æ‰€æåˆ°çš„ï¼Œå®ƒæ²¡æœ‰ä¼ è¾¾ä»»ä½•ä¿¡æ¯ï¼ˆ&lt;a href=&#34;https://www.youtube.com/watch?v=PAAkCSZUG1c&amp;amp;t=7m36s&#34;&gt;https://www.youtube.com/watch?v=PAAkCSZUG1c&amp;amp;t=7m36s&lt;/a&gt; ï¼‰;&lt;/p&gt;
&lt;p&gt;any(interface{})å¦‚æœç¡®å®éœ€è¦æ¥å—æˆ–è¿”å›ä»»ä½•å¯èƒ½çš„ç±»å‹ï¼ˆä¾‹å¦‚ï¼Œå½“æ¶‰åŠåˆ°marshaling or formattingæ—¶ï¼‰ï¼Œå®ƒä¼šå¾ˆæœ‰å¸®åŠ©ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œåº”è¯¥ä¸æƒœä¸€åˆ‡ä»£ä»·é¿å…è¿‡åº¦æ¦‚æ‹¬ç¼–å†™çš„ä»£ç ã€‚å¦‚æœèƒ½æé«˜å…¶ä»–æ–¹é¢ï¼ˆä¾‹å¦‚ä»£ç è¡¨è¾¾èƒ½åŠ›ï¼‰ï¼Œä¹Ÿè®¸ä¸€ç‚¹ç‚¹é‡å¤ä»£ç å¶å°”ä¼šæ›´å¥½ã€‚&lt;/p&gt;
&lt;h3 id=&#34;9å¯¹ä½•æ—¶ä½¿ç”¨æ³›å‹æ„Ÿåˆ°å›°æƒ‘&#34;&gt;9.å¯¹ä½•æ—¶ä½¿ç”¨æ³›å‹æ„Ÿåˆ°å›°æƒ‘&lt;/h3&gt;
&lt;p&gt;å°½ç®¡æ³›å‹åœ¨ç‰¹å®šæƒ…å†µä¸‹ä¼šæœ‰æ‰€å¸®åŠ©ï¼Œä½†æ˜¯åº”è¯¥è°¨æ…é€‰æ‹©ä½•æ—¶ä½¿ç”¨å®ƒä»¬ä»¥åŠä½•æ—¶ä¸ä½¿ç”¨å®ƒä»¬ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œå¦‚æœè¦å›ç­”ä½•æ—¶ä¸ä½¿ç”¨æ³›å‹ï¼Œå¯ä»¥æ‰¾åˆ°ä¸ä½•æ—¶ä¸ä½¿ç”¨æ¥å£çš„ç›¸ä¼¼ä¹‹å¤„ã€‚äº‹å®ä¸Šï¼Œæ³›å‹å¼•å…¥äº†ä¸€ç§æŠ½è±¡å½¢å¼ï¼Œå¿…é¡»è®°ä½ï¼Œä¸å¿…è¦çš„æŠ½è±¡ä¼šå¸¦æ¥å¤æ‚æ€§ã€‚&lt;/p&gt;
&lt;p&gt;åŒæ ·ï¼Œä¸è¦ç”¨ä¸å¿…è¦çš„æŠ½è±¡æ±¡æŸ“ä»£ç ï¼Œä¸“æ³¨äºè§£å†³å…·ä½“é—®é¢˜ã€‚è¿™æ„å‘³ç€ä¸åº”è¯¥è¿‡æ—©åœ°ä½¿ç”¨ç±»å‹å‚æ•°ã€‚ç­‰åˆ°å³å°†ç¼–å†™æ ·æ¿ä»£ç æ—¶å†è€ƒè™‘ä½¿ç”¨æ³›å‹ã€‚è€Œä¸”æ³›å‹ç°åœ¨è¿˜å­˜åœ¨ä¸€äº›æ€§èƒ½ä¸Šçš„é—®é¢˜ï¼Œå¯ä»¥å‚è€ƒï¼š &lt;a href=&#34;https://planetscale.com/blog/generics-can-make-your-go-code-slower&#34;&gt;&lt;strong&gt;&lt;!-- raw HTML omitted --&gt;Generics can make your Go code slower&lt;!-- raw HTML omitted --&gt;&lt;/strong&gt;&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&#34;10æ²¡æœ‰æ„è¯†åˆ°ç±»å‹åµŒå…¥å¯èƒ½å­˜åœ¨çš„é—®é¢˜&#34;&gt;10.æ²¡æœ‰æ„è¯†åˆ°ç±»å‹åµŒå…¥å¯èƒ½å­˜åœ¨çš„é—®é¢˜&lt;/h3&gt;
&lt;p&gt;æƒ³è¦å°è£…åœ¨ç»“æ„ä¸­å¹¶ä½¿å¤–éƒ¨å®¢æˆ·ç«¯ä¸å¯è§çš„ä¸œè¥¿ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ä¸åº”è¯¥å°†å…¶è®¾ä¸ºåµŒå…¥å­—æ®µï¼›&lt;/p&gt;
&lt;p&gt;å¦‚æœå†³å®šä½¿ç”¨ç±»å‹åµŒå…¥ï¼Œéœ€è¦ç‰¢è®°ä¸¤ä¸ªä¸»è¦çº¦æŸï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å®ƒä¸åº”è¯¥å•ç‹¬ç”¨ä½œä¸€äº›è¯­æ³•ç³–æ¥ç®€åŒ–å¯¹å­—æ®µçš„è®¿é—®ï¼ˆä¾‹å¦‚Foo.Baz()ä»£æ›¿Foo.Bar.Baz()ï¼‰ã€‚å¦‚æœè¿™æ˜¯å”¯ä¸€çš„ç†ç”±ï¼Œå°±ä¸è¦åµŒå…¥å†…éƒ¨ç±»å‹ï¼Œè€Œæ˜¯ä½¿ç”¨å­—æ®µã€‚&lt;/li&gt;
&lt;li&gt;å®ƒä¸åº”è¯¥æå‡æƒ³è¦ä»å¤–éƒ¨éšè—çš„æ•°æ®ï¼ˆå­—æ®µï¼‰æˆ–è¡Œä¸ºï¼ˆæ–¹æ³•ï¼‰ï¼šä¾‹å¦‚ï¼Œå¦‚æœå®ƒå…è®¸å®¢æˆ·ç«¯è®¿é—®åº”è¯¥å¯¹ç»“æ„ä¿æŒç§æœ‰çš„é”å®šè¡Œä¸ºã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;æ¯”å¦‚å¯¹ä¸€ä¸ªå¼€æºçš„æ—¥å¿—åº“è¿›è¡ŒäºŒæ¬¡å°è£…ï¼Œå¯ä»¥ç›´æ¥åµŒå…¥è‡³ç»“æ„ä½“ä¸­ï¼Œä½¿ç”¨å¯¹åº”æ—¥å¿—åº“ç»“æ„ä½“ä¸­çš„å…¬æœ‰æ–¹æ³•ã€‚&lt;/p&gt;
&lt;h3 id=&#34;11ä¸ä½¿ç”¨åŠŸèƒ½é€‰é¡¹æ¨¡å¼å·¥ç¨‹è§„èŒƒ&#34;&gt;11.ä¸ä½¿ç”¨åŠŸèƒ½é€‰é¡¹æ¨¡å¼ï¼ˆå·¥ç¨‹è§„èŒƒï¼‰&lt;/h3&gt;
&lt;p&gt;GOä¸­ä¸åƒpythonæœ‰é»˜è®¤å‚æ•°ï¼Œé€šè¿‡å‚æ•°å¯å˜é…ç½®æ¥newä¸€ä¸ªå¯¹è±¡ï¼›å¦‚æœGOå®ç°ï¼Œå¯å˜é…ç½®å¯ä»¥é€šè¿‡â€¦ Optionæ–¹å¼é…ç½®ï¼Œé…ç½®é¡¹é€šè¿‡With* è®¾ç½®è¿”å›é—­åŒ…å‡½æ•°æ“ä½œï¼Œ åœ¨åˆå§‹åŒ–å¯¹è±¡æ—¶ä¼ å…¥With** æ–¹æ³•å¯¹é…ç½®é¡¹è¿›è¡Œè®¾ç½®ï¼Œå‚æ•°ä¸ªæ•°å¯é€‰ï¼Œæœªè®¾ç½®åˆ™ä½¿ç”¨é»˜è®¤é…ç½®é¡¹ï¼›è¿™ä¸ªæ–¹å¼ç»å¸¸ç”¨äºç¨‹åºå¯åŠ¨æ—¶é€šè¿‡åŠ è½½é…ç½®è¿›è¡Œåˆå§‹åŒ–æ“ä½œã€‚&lt;/p&gt;
&lt;h3 id=&#34;12é¡¹ç›®ç»„ç»‡ä¸å½“å·¥ç¨‹è§„èŒƒ&#34;&gt;12.é¡¹ç›®ç»„ç»‡ä¸å½“ï¼ˆå·¥ç¨‹è§„èŒƒï¼‰&lt;/h3&gt;
&lt;p&gt;GOå®˜æ–¹æ²¡æœ‰æä¾›æ ‡å‡†çš„é¡¹ç›®ç»„ç»‡ç»“æ„ï¼Œä¸€èˆ¬æƒ…å†µä½¿ç”¨GitHub golang-standards ç»„ç»‡ä¸‹çš„é¡¹ç›®å¸ƒå±€ï¼ˆ&lt;a href=&#34;https://github.com/golang-standards/project-layout&#34;&gt;https://github.com/golang-standards/project-layout&lt;/a&gt;ï¼‰ï¼Œä½†æ˜¯è¿™ä¸ªä¸æ˜¯ç»å¯¹çš„ï¼Œå› é¡¹ç›®è€Œå¼‚ç¨æœ‰ä¸åŒï¼›ä¸»è¦æ˜¯é¡¹ç›®ä¸­çš„å±‚çº§ä¸èƒ½åµŒå¥—å¤ªæ·±ï¼Œè€Œä¸”é‡è¦çš„ä¸€ç‚¹æ˜¯ä¸èƒ½å‡ºç°å¾ªç¯åµŒå¥—å¼•ç”¨åŒ…ï¼› ä¸è¦è¿‡æ—©å°åŒ…ï¼ŒæŠ½è±¡ä¸€å±‚æ—¶ï¼Œå°½é‡ä¸Šå±‚ä¾èµ–ä¸‹å±‚å­ç›®å½•ï¼Œå­ç›®å½•é«˜åº¦å†…èšï¼Œ ä¸šåŠ¡é€»è¾‘å±‚ä¾èµ–å…¬å…±å±‚ï¼›å¦‚æœä¸ç¡®å®šæ˜¯å¦å¯¼å‡ºä¸€ä¸ªå…ƒç´ ï¼Œåº”è¯¥é»˜è®¤ä¸å¯¼å‡ºå®ƒï¼›åé¢å‘ç°éœ€è¦å¯¼å‡ºï¼Œå¯ä»¥è°ƒæ•´ä»£ç ã€‚å¯¹äºå¤§å‹é¡¹ç›®ï¼Œæœ‰å¤šä¸ªå­æ¨¡å—ï¼Œå¯ä»¥ä½¿ç”¨workspaceè¿›è¡Œç®¡ç†ï¼›&lt;/p&gt;
&lt;p&gt;Tips: å¦‚æœä½¿ç”¨DDD &lt;a href=&#34;https://blog.cleancoder.com/uncle-bob/2012/08/13/the-clean-architecture.html&#34;&gt;clean-architecture&lt;/a&gt; æ¶æ„æ€æƒ³å¼€å‘ä¸šåŠ¡ï¼Œå¯ä»¥ä½¿ç”¨ &lt;a href=&#34;https://github.com/bxcodec/go-clean-arch&#34;&gt;go-clean-arch&lt;/a&gt; è¿™ä¸ªé¡¹ç›®ç»“æ„ã€‚&lt;/p&gt;
&lt;h3 id=&#34;13åˆ›å»ºå®ç”¨ç¨‹åºåŒ…å·¥ç¨‹è§„èŒƒ&#34;&gt;13.åˆ›å»ºå®ç”¨ç¨‹åºåŒ…ï¼ˆå·¥ç¨‹è§„èŒƒï¼‰&lt;/h3&gt;
&lt;p&gt;åŒ…å‘½åï¼Œåº”è¯¥æ˜¯åŒ…å¯¹åº”åŠŸèƒ½ï¼Œè€Œä¸æ˜¯é€šç”¨æ„ä¹‰ä¸Šçš„åç§°æ¯”å¦‚utilsã€commonæˆ–baseï¼Œè¿™äº›å¯ä»¥ä½œä¸ºå…·ä½“åŒ…çš„å½’æ¡£ã€‚ç±»ä¼¼netåŒ…ä¸­çš„ç»„ç»‡å½¢å¼&lt;/p&gt;
&lt;h3 id=&#34;14å¿½ç•¥åŒ…åç§°å†²çªå·¥ç¨‹è§„èŒƒ&#34;&gt;14.å¿½ç•¥åŒ…åç§°å†²çªï¼ˆå·¥ç¨‹è§„èŒƒï¼‰&lt;/h3&gt;
&lt;p&gt;å˜é‡åä¸åŒ…åå†²çªï¼Œåº”è¯¥é¿å…ï¼Œè¿™ä¸ªstaticcheck å·¥å…·å°±å¯ä»¥ç›´æ¥æ£€æµ‹å‡ºæ¥æç¤º; å¯ä»¥ä½¿ç”¨åŒ…åˆ«åï¼›&lt;/p&gt;
&lt;h3 id=&#34;15ç¼ºå°‘ä»£ç æ–‡æ¡£å·¥ç¨‹è§„èŒƒ&#34;&gt;15.ç¼ºå°‘ä»£ç æ–‡æ¡£ï¼ˆå·¥ç¨‹è§„èŒƒï¼‰&lt;/h3&gt;
&lt;p&gt;è¿™ä¸ªå±äºä»£ç å·¥ç¨‹è§„èŒƒé—®é¢˜äº†ï¼Œå¯¹äºå¼€æ”¾å‡ºå»çš„åŒ…ï¼Œéœ€è¦æä¾›ä»£ç æ–‡æ¡£ï¼Œè¡¨æ˜å…¶ç›®çš„å’Œå†…å®¹ï¼Œæ–¹ä¾¿ä½¿ç”¨è€…æŸ¥çœ‹æ–‡æ¡£ï¼Œå…¶å®è¿™ä¸ªå› äººè€Œå¼‚äº†ï¼Œæœ€å¥½ç»“åˆæºç å’Œç”¨ä¾‹æ¥ç†è§£ï¼Œæœ‰æ—¶å€™ä»£ç æ›´æ–°ï¼Œæ–‡æ¡£å´æœªæ›´æ–°ï¼Œåœ¨ä»£ç ä¸­ç»å¸¸å¯ä»¥çœ‹åˆ°(å„ç§prä¿®æ”¹)ã€‚ æœ€å¥½ç±»ä¼¼rusté‚£æ ·ï¼Œåœ¨æ–‡æ¡£ä¸­åŠ å…¥ä¸€äº›æµ‹è¯•ç”¨ä¾‹ï¼›å¯¹äºåç»­ä¸ç»´æŠ¤çš„æ–¹æ³•ï¼Œå¯ä»¥é€šè¿‡// Deprecated:è¿™ç§æ–¹å¼ä½¿ç”¨æ³¨é‡Šå¼ƒç”¨å¯¼å‡ºçš„å…ƒç´ ï¼Œ è¿™ä¸ªä¸åŒçš„å¼€å‘è¯­è¨€éƒ½æœ‰ç±»ä¼¼åŠŸèƒ½ï¼›&lt;/p&gt;
&lt;h3 id=&#34;16ä¸ä½¿ç”¨-linters&#34;&gt;16.ä¸ä½¿ç”¨ linters&lt;/h3&gt;
&lt;p&gt;åº”è¯¥ä½¿ç”¨Goæä¾›çš„æ£€æµ‹å·¥å…·æ¥å†™å‡ºç»Ÿä¸€è´¨é‡é«˜çš„ä»£ç ï¼ŒLinters ç±»å·¥å…·å’Œæ ¼å¼åŒ–ç¨‹åºæ˜¯æé«˜ä»£ç åº“è´¨é‡å’Œä¸€è‡´æ€§çš„æœ‰æ•ˆæ–¹æ³•ã€‚èŠ±æ—¶é—´äº†è§£è¿™äº›å·¥å…·ï¼Œå¹¶ç¡®ä¿è‡ªåŠ¨æ‰§è¡Œå®ƒä»¬ï¼ˆä¾‹å¦‚ CI æˆ– Git é¢„æäº¤æŒ‚é’©ï¼Œæ¯”å¦‚å¼€æºé¡¹ç›®ä¸­åœ¨ç»å¸¸ä½¿ç”¨staticcheck å’Œ golangci-lint è¿›è¡Œåˆ†æ,&lt;code&gt;golangci-lint run --out-format=github-actions --path-prefix=. -E gofumpt&lt;/code&gt;ï¼‰ï¼›å­¦ä¼šä½¿ç”¨å·¥å…·åˆ†æä»£ç è´¨é‡é—®é¢˜ï¼›&lt;/p&gt;
&lt;h2 id=&#34;æ¦‚æ‹¬&#34;&gt;æ¦‚æ‹¬&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;é¿å…éšè—å˜é‡æœ‰åŠ©äºé˜²æ­¢é”™è¯¯ï¼Œä¾‹å¦‚å¼•ç”¨é”™è¯¯çš„å˜é‡æˆ–æ··æ·†è¯»è€…ã€‚&lt;/li&gt;
&lt;li&gt;é¿å…åµŒå¥—çº§åˆ«å¹¶ä¿æŒå¿«ä¹è·¯å¾„åœ¨å·¦ä¾§å¯¹é½ï¼Œå¯ä»¥æ›´è½»æ¾åœ°æ„å»ºå¿ƒæ™ºä»£ç æ¨¡å‹ã€‚&lt;/li&gt;
&lt;li&gt;åˆå§‹åŒ–å˜é‡æ—¶ï¼Œè¯·è®°ä½ init å‡½æ•°å…·æœ‰æœ‰é™çš„é”™è¯¯å¤„ç†ï¼Œå¹¶ä½¿çŠ¶æ€å¤„ç†å’Œæµ‹è¯•æ›´åŠ å¤æ‚ã€‚åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œåˆå§‹åŒ–åº”ä½œä¸ºç‰¹å®šå‡½æ•°å¤„ç†ã€‚&lt;/li&gt;
&lt;li&gt;å¼ºåˆ¶ä½¿ç”¨ getter å’Œ setter åœ¨ Go ä¸­ä¸æ˜¯æƒ¯ç”¨çš„ã€‚åŠ¡å®å¹¶åœ¨æ•ˆç‡å’Œç›²ç›®éµå¾ªæŸäº›æˆè¯­ä¹‹é—´æ‰¾åˆ°æ­£ç¡®çš„å¹³è¡¡åº”è¯¥æ˜¯è¦èµ°çš„è·¯ã€‚&lt;/li&gt;
&lt;li&gt;æŠ½è±¡åº”è¯¥è¢«å‘ç°ï¼Œè€Œä¸æ˜¯è¢«åˆ›é€ ã€‚ä¸ºé¿å…ä¸å¿…è¦çš„å¤æ‚æ€§ï¼Œè¯·åœ¨éœ€è¦æ—¶åˆ›å»ºæ¥å£ï¼Œè€Œä¸æ˜¯åœ¨é¢„è§éœ€è¦æ—¶åˆ›å»ºæ¥å£ï¼Œæˆ–è€…è‡³å°‘å¯ä»¥è¯æ˜æŠ½è±¡æ˜¯æœ‰æ•ˆçš„ã€‚&lt;/li&gt;
&lt;li&gt;å°†æ¥å£ä¿ç•™åœ¨å®¢æˆ·ç«¯å¯ä»¥é¿å…ä¸å¿…è¦çš„æŠ½è±¡ã€‚&lt;/li&gt;
&lt;li&gt;ä¸ºäº†é˜²æ­¢åœ¨çµæ´»æ€§æ–¹é¢å—åˆ°é™åˆ¶ï¼Œå‡½æ•°åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ä¸åº”è¿”å›æ¥å£ï¼Œè€Œåº”è¿”å›å…·ä½“å®ç°ã€‚ç›¸åï¼Œå‡½æ•°åº”è¯¥å°½å¯èƒ½æ¥å—æ¥å£ã€‚&lt;/li&gt;
&lt;li&gt;ä»…anyåœ¨éœ€è¦æ¥å—æˆ–è¿”å›ä»»ä½•å¯èƒ½çš„ç±»å‹æ—¶ä½¿ç”¨ï¼Œä¾‹å¦‚ json. Marshal. å¦åˆ™ï¼Œanyä¸ä¼šæä¾›æœ‰æ„ä¹‰çš„ä¿¡æ¯ï¼Œå¹¶å¯èƒ½é€šè¿‡å…è®¸è°ƒç”¨è€…è°ƒç”¨å…·æœ‰ä»»ä½•æ•°æ®ç±»å‹çš„æ–¹æ³•è€Œå¯¼è‡´ç¼–è¯‘æ—¶é—®é¢˜ã€‚&lt;/li&gt;
&lt;li&gt;ä¾èµ–æ³›å‹å’Œç±»å‹å‚æ•°å¯ä»¥é˜²æ­¢ç¼–å†™æ ·æ¿ä»£ç æ¥åˆ†è§£å…ƒç´ æˆ–è¡Œä¸ºã€‚ä½†æ˜¯ï¼Œä¸è¦è¿‡æ—©åœ°ä½¿ç”¨ç±»å‹å‚æ•°ï¼Œåªæœ‰å½“ä½ çœ‹åˆ°å¯¹å®ƒä»¬çš„å…·ä½“éœ€æ±‚æ—¶æ‰ä½¿ç”¨ã€‚å¦åˆ™ï¼Œå®ƒä»¬ä¼šå¼•å…¥ä¸å¿…è¦çš„æŠ½è±¡å’Œå¤æ‚æ€§ã€‚&lt;/li&gt;
&lt;li&gt;ä½¿ç”¨ç±»å‹åµŒå…¥ä¹Ÿæœ‰åŠ©äºé¿å…æ ·æ¿ä»£ç ï¼›ä½†æ˜¯ï¼Œè¯·ç¡®ä¿è¿™æ ·åšä¸ä¼šå¯¼è‡´æŸäº›å­—æ®µæœ¬åº”éšè—çš„å¯è§æ€§é—®é¢˜ã€‚&lt;/li&gt;
&lt;li&gt;è¦ä»¥ API å‹å¥½çš„æ–¹å¼æ–¹ä¾¿åœ°å¤„ç†é€‰é¡¹ï¼Œè¯·ä½¿ç”¨åŠŸèƒ½é€‰é¡¹æ¨¡å¼ã€‚&lt;/li&gt;
&lt;li&gt;éµå¾ªè¯¸å¦‚ project-layout ä¹‹ç±»çš„å¸ƒå±€å¯èƒ½æ˜¯å¼€å§‹æ„å»º Go é¡¹ç›®çš„å¥½æ–¹æ³•ï¼Œå°¤å…¶æ˜¯å½“æ­£åœ¨å¯»æ‰¾ç°æœ‰çº¦å®šæ¥æ ‡å‡†åŒ–æ–°é¡¹ç›®æ—¶ã€‚&lt;/li&gt;
&lt;li&gt;å‘½åæ˜¯åº”ç”¨ç¨‹åºè®¾è®¡çš„å…³é”®éƒ¨åˆ†ã€‚åˆ›å»ºè¯¸å¦‚commonã€utilå’Œ ä¹‹ç±»çš„åŒ…sharedä¸ä¼šä¸ºè¯»è€…å¸¦æ¥å¤ªå¤šä»·å€¼ã€‚å°†æ­¤ç±»åŒ…é‡æ„ä¸ºæœ‰æ„ä¹‰ä¸”ç‰¹å®šçš„åŒ…åç§°ã€‚&lt;/li&gt;
&lt;li&gt;ä¸ºé¿å…å˜é‡å’ŒåŒ…ä¹‹é—´çš„å‘½åå†²çªï¼Œä»è€Œå¯¼è‡´æ··æ·†ç”šè‡³é”™è¯¯ï¼Œè¯·ä¸ºæ¯ä¸ªå˜é‡ä½¿ç”¨å”¯ä¸€çš„åç§°ã€‚å¦‚æœè¿™ä¸å¯è¡Œï¼Œè¯·ä½¿ç”¨å¯¼å…¥åˆ«åæ¥æ›´æ”¹é™å®šç¬¦ä»¥åŒºåˆ†åŒ…åç§°å’Œå˜é‡åç§°ï¼Œæˆ–è€…è€ƒè™‘ä¸€ä¸ªæ›´å¥½çš„åç§°ã€‚&lt;/li&gt;
&lt;li&gt;ä¸ºäº†å¸®åŠ©å®¢æˆ·å’Œç»´æŠ¤è€…ç†è§£çš„ä»£ç çš„ç”¨é€”ï¼Œè®°å½•å¯¼å‡ºçš„å…ƒç´ ã€‚&lt;/li&gt;
&lt;li&gt;è¦æé«˜ä»£ç è´¨é‡å’Œä¸€è‡´æ€§ï¼Œè¯·ä½¿ç”¨ linters å’Œæ ¼å¼åŒ–ç¨‹åºã€‚&lt;/li&gt;
&lt;/ul&gt;</description>
      
    </item>
    
    <item>
      <title>è®¾è®¡-ç›´æ’­é—´èµ é€ç¤¼ç‰©åŠŸèƒ½</title>
      <link>https://weedge.github.io/post/zb-gift/</link>
      <pubDate>Mon, 21 Nov 2022 10:26:23 +0800</pubDate>
      
      <guid>https://weedge.github.io/post/zb-gift/</guid>
      
        <description>&lt;h2 id=&#34;èƒŒæ™¯&#34;&gt;èƒŒæ™¯&lt;/h2&gt;
&lt;p&gt;ç›´æ’­çº¿ä¸Šäº’åŠ¨ï¼Œå·²æˆä¸ºå½“ä¸‹ç”Ÿæ´»çš„ä¸€éƒ¨åˆ†ï¼Œç‰¹åˆ«æ˜¯å—ç–«æƒ…å½±å“ï¼Œæˆä¸ºäº’è”ç½‘çš„ä¸»è¦æµé‡å…¥å£ï¼›ç ”ç©¶äº†ä¸‹å„ä¸ªå¹³å°ç›´æ’­é—´é€ç¤¼ç‰©çš„åŠŸèƒ½ï¼Œå‘ç°å¤§åŒå°å¼‚ï¼Œåœ¨ç¤¼ç‰©åˆ†ç»„ï¼Œä¸€äº›å®šåˆ¶åŒ–çš„ç¤¼ç‰©æœ‰åŒºåˆ†ï¼Œæ•´ä½“äº¤äº’æµç¨‹å¤§è‡´ç›¸åŒï¼Œä¸»è¦æ˜¯ç›´æ’­é—´ä¸»æ’­ä¸Šæ’­ï¼Œç”¨æˆ·é€šè¿‡ç¤¼ç‰©æ‰“èµç»™ä¸»æ’­ä»¬(ä¸€ä¸ªç›´æ’­é—´å¯èƒ½æœ‰å¤šåä¸»æ’­åœ¨äº’åŠ¨)ï¼Œç¤¼ç‰©æ˜¯é€šè¿‡è™šæ‹Ÿå¸(**å¸) æ¢ç®—ï¼Œæ—©æœŸäº’è”ç½‘ç”¨æˆ·çº¿ä¸Šäº’åŠ¨ç¤¼ç‰©ï¼Œç©å®¶æœ€å¤šçš„åº”è¯¥æ˜¯QQå¸äº†ï¼Œåªä¸è¿‡ä»¥å‰çš„æ‰“èµèµ é€åœºæ™¯æ˜¯åœ¨web2.0åˆšå¼€å§‹çš„æ—¶å€™ï¼Œäº¤äº’çš„å¤§å¤šæ˜¯æ–‡å­—å’Œå›¾ç‰‡ï¼Œç›¸å…³äº§å“åœºæ™¯ï¼Œè™šæ‹Ÿç©ºé—´(ä¸ªäººç©ºé—´ï¼Œåšå®¢ï¼Œç§èœç­‰å¨±ä¹äº’åŠ¨åœºæ™¯)ï¼›éšç€åº•å±‚ç½‘ç»œåŸºå»ºçš„å‘å±•ï¼Œ4Gä¹‹åå‡ºç°äº†å¤§é‡çš„è§†é¢‘ç½‘ç«™ï¼Œç”¨æˆ·å¯ä»¥å½•ä¸€äº›è§†é¢‘å†…å®¹æ¥äº’åŠ¨ï¼›åˆ°åæ¥éŸ³è§†é¢‘æµåª’ä½“çš„å‘å±•ï¼Œç›¸å…³çš„åœ¨çº¿ç›´æ’­é—´å¼€å§‹æ¶Œç°ï¼Œç”¨æˆ·ä¹‹é—´äº«å—ä¸€æ³¢ç›´æ’­çº¢åˆ©å¸¦æ¥çš„äº’åŠ¨ï¼Œå½“ç„¶å½±å“ç›¸å¯¹äºå‰é¢çš„å½¢å¼æ›´åŠ å®æ—¶å’Œç›´æ¥ï¼›ç°åœ¨çš„5Gå’Œæœªæ¥6Gï¼Œä»¥åŠç‰©è”ç½‘éƒ½ä¼šç»™ç›´æ’­å½¢å¼å¸¦æ¥æ–°çš„äº’åŠ¨åœºæ™¯,æ¯”å¦‚ï¼šè™šæ‹Ÿä¼šåœºï¼Œäººæœºäº’åŠ¨ï¼›å…¶ä¸­æ—©æœŸåŸ¹å…»èµ·æ¥çš„æ‰“èµé€ç¤¼è¡Œä¸ºåŠŸèƒ½ç»å¸¸ç”¨äºæœ‰ä¸»æ’­çš„å¨±ä¹äº’åŠ¨ç›´æ’­ä¸­ï¼Œä¹Ÿæ˜¯å¢å€¼ç›ˆåˆ©çš„ä¸€éƒ¨åˆ†ï¼›&lt;/p&gt;
&lt;p&gt;tips: é™¤äº†é€ç¤¼åŠŸèƒ½ï¼Œæ ¹æ®ä¸åŒç›´æ’­åœºæ™¯ï¼Œè¿˜æœ‰è¯­éŸ³è§†é¢‘è¿éº¦ï¼Œç”µå•†å¸¦è´§å•†å“ï¼Œæ²¡æœ‰ä¸»æ’­ï¼ŒèŠ‚ç›®ç›´æ’­/è½¬æ’­ï¼Œä¼šè®®ç›´æ’­ï¼Œè‡ªä¹ å®¤ï¼ŒåŸºæœ¬çš„ç‚¹èµï¼Œè®¡æ•°ï¼ŒèŠå¤©åŸºç¡€æœåŠ¡åŠŸèƒ½ï¼›è¿˜æœ‰äº›æŠ½å¥–åŠŸèƒ½ï¼Œç­”é¢˜åŠŸèƒ½(æ•™è‚²ç±»ç›´æ’­å±…å¤š)ï¼ŒæŠ•ç¥¨ï¼Œçº¢åŒ…è¿™äº›åŠŸèƒ½æœåŠ¡å¯åœ¨å¼€æ’­æ—¶è®¾ç½®ï¼Œæ˜¯å¦å¯ç”¨ï¼›æœ‰ç”¨æˆ·åŸºç¡€çš„æµé‡å¹³å°å¯èƒ½è¿˜ä¼šä»¥ç«ä»·æ’åçš„æ–¹å¼æ¨èä¸€æ³¢ï¼›è¿™äº›åŠŸèƒ½å¯ä»¥ä½œä¸ºä¸€ä¸ªå¯ç®¡ç†çš„æ’ä»¶ï¼Œé€šè¿‡ç»„åˆçš„æ–¹å¼åº”ç”¨äºç›´æ’­ä¸­ï¼Œæ–¹ä¾¿ç®¡ç†ï¼Œåç»­å¯ä»¥æ·»åŠ æ–°åŠŸèƒ½æ»¡è¶³æŸç±»å‹ç›´æ’­åœºæ™¯ã€‚&lt;/p&gt;
&lt;h2 id=&#34;éœ€æ±‚è®¾è®¡&#34;&gt;éœ€æ±‚è®¾è®¡&lt;/h2&gt;
&lt;p&gt;è®¾è®¡ä¸€ä¸ªç®€å•ç¤¼ç‰©æ‰“èµåŠŸèƒ½: Aç”¨æˆ·(è§‚ä¼—)èµ é€ç¤¼ç‰©ç»™Bç”¨æˆ·(ä¸»æ’­)ï¼Œå¯ä»¥ç»™å¤šä¸ªä¸»æ’­èµ é€ç¤¼ç‰©ï¼›&lt;/p&gt;
&lt;h3 id=&#34;åˆ†æ&#34;&gt;åˆ†æ&lt;/h3&gt;
&lt;p&gt;ç¤¼ç‰©ï¼šç›´æ’­å¹³å°é€šè¿‡è™šæ‹Ÿå¸æ¥ç»Ÿä¸€ç­‰ä»·äº¤æ¢çš„è™šæ‹Ÿç‰©å“ï¼Œè€Œè™šæ‹Ÿå¸æ˜¯éœ€è¦é€šè¿‡ç”¨æˆ·å……å€¼è´­ä¹°ï¼›å‘é€ç¤¼ç‰©å¯ä»¥è·å¾—ä¸€äº›ç§¯åˆ†ï¼›&lt;/p&gt;
&lt;p&gt;Aç”¨æˆ·å‘é€ç¤¼ç‰©ç»™Bç”¨æˆ·ï¼ŒAçš„è™šæ‹Ÿå¸æ‰£é™¤ï¼ŒBçš„è™šæ‹Ÿå¸ç›¸åº”å¢åŠ ï¼›éœ€è¦ä¿è¯èµ é€å’Œæ”¶åˆ°çš„æ•°é‡ä¸€è‡´ï¼›&lt;/p&gt;
&lt;p&gt;éœ€è¦è€ƒè™‘å¹¶å‘åœºæ™¯ï¼Œå¯¹äºçƒ­é—¨ä¸»æ’­é«˜å³°æœŸçš„æµé‡å€¼100wè§‚ä¼—ç”¨æˆ·åœ¨çº¿äº’åŠ¨ï¼Œæ¯ç§’é€ç¤¼çš„è¯·æ±‚æ•°é‡ä¹Ÿå¯èƒ½é«˜äºè¿™ä¸ªå€¼ï¼Œç”¨æˆ·å¯èƒ½è¿å‡»é€å‡ºå¤šæ¬¡(è¿å‡»è¡Œä¸ºå®¢æˆ·ç«¯å¯ä»¥ç¼“å†²ä¸€æ¬¡å‘é€ç»™åç«¯)ï¼Œ è€Œä¸”ä¸ºäº†ä¿è¯æ•°æ®ä¸€è‡´å’Œååï¼Œå°½é‡å‡å°‘é”çš„ä½¿ç”¨ï¼Œæˆ–è€…è¯´é‡‡ç”¨&lt;a href=&#34;https://en.wikipedia.org/wiki/Optimistic_concurrency_control&#34;&gt;OCC&lt;/a&gt;ï¼Œä¹è§‚é”çš„æ–¹å¼æ¥å¤„ç†äº‹åŠ¡ï¼Œäº¤ç”±ä¸šåŠ¡æœåŠ¡ç¨‹åºæ¥å¤„ç†ï¼Œå°½é‡å‡å°‘æˆ–å‡çŸ­æ•°æ®åº“ä¸­å¿ƒå­˜å‚¨æœåŠ¡ä¸Šçš„é”æ“ä½œï¼ŒåŸç†å°±æ˜¯ï¼šå¤¯ä¸»åï¼Œå°±å‘†èŒäº†ï¼Œèµ„æºæœªé‡Šæ”¾ï¼Œè¯·æ±‚èµ„æºä¸€å¢å¤šï¼Œå¯¼è‡´æ•´ä¸ªæœåŠ¡ååä¸‹é™ï¼Œä¸€ç›´æŒç»­ä¸‹å»éšæ—¶éƒ½ä¼šdownæ‰ï¼Œè€Œä¸”é”æ˜¯å»ºç«‹åœ¨ç´¢å¼•æ•°æ®ä¹‹ä¸Šçš„ï¼Œ å¦‚æœæ²¡æœ‰ç›¸å…³é™çº§å¤„ç†ï¼Œå¼„ä¸å¥½æ•´ä½“æœåŠ¡å°±&lt;a href=&#34;https://www.youtube.com/watch?v=4m48GqaOz90&#34;&gt;galigeigei&lt;/a&gt;ï¼›&lt;/p&gt;
&lt;p&gt;100W è§‚ä¼—Aå‘åŒä¸€ä¸ªä¸»æ’­B èµ é€ç¤¼ç‰©ï¼Œå¯¹äºä¸»æ’­Bçš„è™šæ‹Ÿå¸ç´¯è®¡å†™æ“ä½œæ¯”è¾ƒå¤§ï¼ŒåŒä¸€æ—¶é—´å¯èƒ½100W+çš„w æ“ä½œ ä¸»æ’­B è™šæ‹Ÿå¸è¿™æ¡è®°å½•ï¼Œå¦‚æœç›´æ¥åŒæ­¥æ“ä½œåœ¨æ•°æ®åº“å±‚é¢ä¼šå‡ºç°è¡Œé”ï¼Œä¼šç­‰å¾…å¤¯ä¸»æ•´ä¸ªèµ é€æµç¨‹ï¼Œæ‰€ä»¥éœ€è¦æŠŠè¿™äº›é›†ä¸­å†™ï¼Œé€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥å»æ›´æ–°è™šæ‹Ÿå¸æ•°ç›®ï¼Œè¿›è€Œæé«˜è§‚ä¼—é€ç¤¼æ¥å£çš„ååé‡ï¼Œ&lt;/p&gt;
&lt;p&gt;è§‚ä¼—è™½ç„¶æ“ä½œè‡ªå·±çš„è™šæ‹Ÿå¸æ•°ç›®è¡Œè®°å½•ï¼Œä½†æ˜¯ç›´æ¥æ“ä½œæ•°æ®åº“ï¼Œå³ä½¿å¯¹ç”¨æˆ·èµ„äº§è¡¨è¿›è¡Œåˆ†åº“åˆ†è¡¨æ“ä½œï¼Œä¹Ÿä¼šæœ‰å¤§é‡çš„ç£ç›˜i/oï¼Œæ‰€ä»¥ç›´æ’­é—´çš„äº’åŠ¨æ•°æ®ç›´æ¥åœ¨ç¼“å­˜ä¸­æ“ä½œï¼ŒæŠŠè§‚ä¼—çš„æ“ä½œè®°å½•æ¶ˆæ¯é˜Ÿåˆ—çš„æ–¹å¼å¼‚æ­¥è½åº“ï¼›&lt;/p&gt;
&lt;p&gt;ç¼“å­˜çš„æ–¹å¼æ“ä½œï¼Œéœ€è¦æŠŠè§‚ä¼—çš„ç”¨æˆ·èµ„äº§ä¿¡æ¯å‰ç½®é¢„çƒ­è‡³ç¼“å­˜ä¸­ï¼Œç›´æ’­ä¸­ç›´æ¥æ“ä½œç¼“å­˜ï¼Œ æ“ä½œç¼“å­˜éœ€è¦ä¿è¯å¹¶å‘æ“ä½œäº‹åŠ¡çš„åŸå­æ€§ï¼Œä¿è¯è§‚ä¼—çš„è™šæ‹Ÿå¸ä¸èƒ½å¤šæ‰£æˆ–è€…å°‘æ‰£ï¼›&lt;/p&gt;
&lt;p&gt;å¹¶å‘åœºæ™¯ä¸‹ï¼Œä¸ºäº†å‡å°‘å¤§é‡ç”¨æˆ·å†²å‡»åº•å±‚æ•°æ®åº“ï¼Œå‡å°‘ç£ç›˜io, é€ç¤¼ç‰©è¿™äº›äº’åŠ¨ç›´æ¥è¯»å†™ç”¨æˆ·ç¼“å­˜æ•°æ®ï¼Œè¿™äº›ç¼“å­˜æ•°æ®çš„æ“ä½œç±»å‹åˆ†ä¸ºæ˜¯/å¦æ›´æ–°é¢‘ç¹ï¼›&lt;/p&gt;
&lt;p&gt;æ›´æ–°ä¸é¢‘ç¹æ•°æ®ï¼šç”¨æˆ·ï¼Œç›´æ’­é—´ï¼Œç‰©æ–™è¯¦æƒ…ç­‰ä¿¡æ¯ï¼Œè¿™äº›ç¼“å­˜æ•°æ®åœ¨è¿›å…¥ç›´æ’­é—´çš„æ—¶å€™ç›´æ¥ä»æ•°æ®åº“ä»¥cacheAside patternè·å–å¡«å……ï¼Œå¡«å……çš„æ—¶å€™é‡‡ç”¨singleflightæ–¹å¼ï¼›ç‰©æ–™ä¿¡æ¯è¿˜å¯ä»¥æœåŠ¡æœ¬åœ°ç¼“å­˜ä¸€ä»½ï¼›å˜æ›´æ•°æ®æ—¶ï¼Œè¿œç«¯ç¼“å­˜æ•°æ®å¯ä»¥é€šè¿‡CDCè®¢é˜…æ•°æ®åº“æ“ä½œæ—¥å¿—(æ¯”å¦‚ï¼šbinlog)æ¥ä¸»åŠ¨å¼‚æ­¥æ›´æ–°ç¼“å­˜æ•°æ®ï¼Œæˆ–è€…ä½¿ç”¨å»¶æ—¶åŒåˆ æ¥è¢«åŠ¨æ›´æ–°ï¼Œæœ¬åœ°ç¼“å­˜å¯æ ¹æ®é€šè¿‡æ§åˆ¶å¹³é¢é…ç½®ä¸‹å‘æ¥è§¦å‘ä»è¿œç«¯ç¼“å­˜æ›´æ–°æ•°æ®ï¼›&lt;/p&gt;
&lt;p&gt;æ›´æ–°é¢‘ç¹æ•°æ®ï¼š è¿™ä¸ªä¸»è¦å‘ç”Ÿåœ¨ç”¨æˆ·ç›´æ’­äº’åŠ¨ï¼Œèµ é€ç¤¼ç‰©åœºæ™¯ï¼Œå¤šæ¬¡å¹¶å‘æ“ä½œï¼Œå˜æ›´çš„å®ä½“æ•°æ® è§‚ä¼—/ä¸»æ’­è™šæ‹Ÿèµ„äº§æ‰£é™¤/å¢åŠ ï¼Œè¿™äº›æ•°æ®ä»¥writeThrough/Behind partternæ–¹å¼ç›´æ¥æ›´æ–°ç¼“å­˜ï¼Œé˜Ÿåˆ—å¼‚æ­¥è½åº“ï¼›å› ä¸ºç›´æ’­åœºæ™¯ç”¨æˆ·çš„æ•°æ®éƒ½åœ¨ç¼“å­˜ä¸­ï¼Œæ•°æ®å®æ—¶æ›´æ–°æŸ¥çœ‹ï¼Œä¸å½±å“ç”¨æˆ·ä½“éªŒï¼›ç›´æ’­ç›‘æ§åå°ä»æ•°æ®åº“é‡Œè®¢é˜…è¿‘å®æ—¶æŸ¥çœ‹ç”¨æˆ·çš„è™šæ‹Ÿèµ„äº§ï¼Œä¼šæœ‰ä¸€ä¸ªæ‰¹é‡çª—å£çš„å¤„ç†å»¶è¿Ÿï¼›&lt;/p&gt;
&lt;p&gt;ç¼“å­˜æ•°æ®åˆå§‹åŒ–ï¼Œå¯ä»¥åœ¨ç”¨æˆ·åˆšæ‰“å¼€appçš„æ—¶å€™åˆå§‹åŒ–ï¼Œä¹Ÿå¯ä»¥åœ¨è¿›å…¥/åˆ›å»ºå¥½ç›´æ’­é—´çš„æ—¶å€™åˆå§‹åŒ–å¥½ç”¨æˆ·ç›´æ’­é—´ç¼“å­˜æ•°æ®ï¼›&lt;/p&gt;
&lt;p&gt;ä»¥ä¸Šå¯ä»¥å°†æ“ä½œåˆ†2ä¸ªå…³é”®æ­¥éª¤ï¼š è§‚ä¼—èµ é€ç¤¼ç‰©å’Œå¼‚æ­¥æ›´æ–°è§‚ä¼—å’Œä¸»æ’­çš„èµ„äº§ä¿¡æ¯ï¼›é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—æ¥è§£è€¦ï¼Œæé«˜é€ç¤¼æ¥å£ååå’Œè¯·æ±‚å“åº”å»¶è¿Ÿï¼Œä»¥åŠä»¥pullæ–¹å¼æ¶ˆè´¹ï¼Œç¼“è§£æ•°æ®åº“å®ä¾‹çš„è¯»å†™å‹åŠ›ï¼›&lt;/p&gt;
&lt;p&gt;è§‚ä¼—èµ é€ç¤¼ç‰©ï¼š ç¤¼ç‰©æ˜¯é€šè¿‡è™šæ‹Ÿè´§å¸è¿›è¡Œç­‰ä»·äº¤æ¢çš„ï¼Œé€šè¿‡ç¤¼ç‰©idè·å–åˆ°å¯¹åº”æ¶ˆè´¹çš„è™šæ‹Ÿèµ„äº§ï¼Œå¯¹ä¸­å¿ƒè¿œç«¯ç¼“å­˜åˆ†ç‰‡ä¸­çš„è§‚ä¼—è™šæ‹Ÿèµ„äº§è¿›è¡Œäº‹åŠ¡æ‰£é™¤å¤„ç†ï¼Œäº‹åŠ¡æäº¤ä¹‹åï¼Œå‘é€äº‹åŠ¡æ¶ˆæ¯ï¼›è¿™é‡Œé‡‡ç”¨casæ–¹å¼å¤„ç†ï¼Œä¸€ç§æ˜¯watch key(string è¯»å†™ioæ˜¯O(1), ä¸ç”¨hashæ˜¯å› ä¸ºè¯»å–å…¨éƒ¨èµ„äº§ä¿¡æ¯ioæ˜¯O(n))+äº‹åŠ¡æ–¹å¼ï¼Œä¸€ç§æ˜¯luaçš„å½¢å¼ç›´æ¥å†™ä¸šåŠ¡æäº¤è„šæœ¬ç»™redisæ ¸å¿ƒä¸»çº¿ç¨‹å»å¤„ç†ï¼›è¿™é‡Œå¯èƒ½ä¼šæƒ³åˆ°ç›´æ¥ç”¨ hash incråŸå­æ“ä½œï¼Œä½†æ˜¯è¿™é‡Œä¸è¡Œï¼Œå› ä¸ºéœ€è¦è¯»å‡ºkeyå¯¹åº”çš„è™šæ‹Ÿèµ„äº§ï¼Œç”¨äºåˆ¤æ–­è™šæ‹Ÿèµ„æºæ˜¯å¦å……è¶³ï¼Œè¯»å‡ºæ¥åœ¨æ‰£é™¤å†™å…¥ï¼Œéœ€è¦ä¸€èµ·æ‰§è¡Œï¼Œä¿è¯äº‹åŠ¡åŸå­æ€§ï¼›é™¤äº†æ ¸å¿ƒæµç¨‹ï¼Œè¿˜æœ‰å‘é€ç¤¼ç‰©æˆåŠŸåï¼Œéœ€è¦æ¨é€æ¶ˆæ¯åˆ°ç›´æ’­é—´ï¼Œæ ¹æ®äº§å“ç¤¼å“ç­–ç•¥åˆ¤æ–­æ˜¯å¦å±•ç¤ºç‰¹æ•ˆ; ä»¥åŠå¢åŠ ç”¨æˆ·æ´»åŠ¨ç§¯åˆ†ï¼Œå¢åŠ äº’åŠ¨ç§¯ææ€§ï¼›&lt;/p&gt;
&lt;p&gt;å¼‚æ­¥æ›´æ–°è§‚ä¼—å’Œä¸»æ’­æ•°æ®åº“è½åœ°èµ„äº§ä¿¡æ¯ï¼šä¸ºäº†å‡å°‘å¯¹æ•°æ®åº“çš„è¡Œé”çš„å¹¶å‘å‹åŠ›ï¼Œå¯é‡‡ç”¨CASçš„æ–¹å¼æ¥æ›´æ–°æ•°æ®åº“çš„æ•°æ®ï¼Œå‰ææ˜¯å•ä¸ªç”¨æˆ·èµ„äº§æ“ä½œï¼Œå¦‚æœæƒ³å•ä¸ªäº‹åŠ¡å•ä¸ªäº‹åŠ¡å¤„ç†ï¼Œå¯ä»¥é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—äº‹åŠ¡æ¶ˆæ¯æ–¹å¼ä¸²èµ·æ¥(pipeline)ï¼›å¦‚æœæ˜¯å¤šä¸ªç”¨æˆ·èµ„äº§æ“ä½œåœ¨åŒä¸€æœåŠ¡äº‹ç‰©é‡Œæ“ä½œçš„è¯ï¼Œåˆ™ä¸èƒ½ä½¿ç”¨CASçš„æ–¹å¼å¤„ç†äº†ï¼Œåªèƒ½ä»¥æ•´ä½“äº‹åŠ¡æ–¹å¼å¤„ç†(é»˜è®¤RRçº§åˆ«)ï¼›&lt;/p&gt;
&lt;p&gt;æ¶ˆæ¯é˜Ÿåˆ—ï¼šæ¶‰åŠåˆ°é‡‘é’±ï¼Œä¸ºäº†æé«˜ååï¼Œéœ€è¦ä¿è¯æ•°æ®å‡†ç¡®ï¼Œæ•°æ®æœ€ç»ˆä¸€è‡´(&lt;a href=&#34;https://www.allthingsdistributed.com/2008/12/eventually_consistent.html&#34;&gt;&lt;strong&gt;BASE&lt;/strong&gt;&lt;/a&gt;)ï¼Œé‡‡ç”¨æ”¯æŒäº‹åŠ¡æ¶ˆæ¯çš„åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ¯”å¦‚ï¼š&lt;a href=&#34;https://rocketmq.apache.org/zh/docs/featureBehavior/04transactionmessage/&#34;&gt;rocketMQ&lt;strong&gt;äº‹åŠ¡æ¶ˆæ¯&lt;/strong&gt;&lt;/a&gt;ï¼Œè¿™é‡Œå¯èƒ½æœ‰ä¸ªç–‘é—®å¦‚æœåˆšå¼€å§‹å‘é€äº‹åŠ¡æ¶ˆæ¯å°±å¤±è´¥äº†ï¼Œå¯èƒ½æ˜¯ç½‘ç»œæŠ–åŠ¨,æˆ–è€…æœåŠ¡è´Ÿè½½é«˜ç­‰åŸå› ï¼Œä¸€èˆ¬æ˜¯å¯ç”¨failoveræƒé‡&lt;a href=&#34;https://en.wikipedia.org/wiki/Exponential_backoff&#34;&gt;æŒ‡æ•°é€€é¿&lt;/a&gt;ç­–ç•¥é‡è¯•åˆ°ä¸åŒæœºæˆ¿çš„rocketMQé›†ç¾¤ï¼Œå¯ä»¥æŸ¥çœ‹&lt;a href=&#34;https://rocketmq.apache.org/zh/docs/featureBehavior/05sendretrypolicy#%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81%E9%87%8D%E8%AF%95%E6%9C%BA%E5%88%B6&#34;&gt;æ¶ˆæ¯å‘é€é‡è¯•æœºåˆ¶&lt;/a&gt; å’Œ &lt;a href=&#34;https://rocketmq.apache.org/zh/docs/bestPractice/15bestpractice&#34;&gt;æœ€ä½³å®è·µ&lt;/a&gt;, &lt;a href=&#34;https://aws.amazon.com/cn/builders-library/timeouts-retries-and-backoff-with-jitter/&#34;&gt;timeouts-retries-and-backoff-with-jitter&lt;/a&gt;ï¼›å¦‚æœé‡è¯•è¿˜æ˜¯å¤±è´¥æ‰“å°é”™è¯¯æ—¥å¿—è®°å½•å‘é€è¯¦æƒ…ï¼Œé€šè¿‡å®æ—¶æ•°æ®æµå°†å¼‚å¸¸è¡Œä¸ºå†™å…¥dbä¸­ï¼Œä»¥ä¾¿åç»­è¡¥å‘ï¼›&lt;/p&gt;
&lt;p&gt;Tips: å¦‚æœä½¿ç”¨é˜¿é‡Œäº‘rocketMQ, éœ€è¦æ³¨æ„æ”¯æŒç‰ˆæœ¬æä¾›çš„SDKï¼Œ5.0 ç‰ˆæœ¬ &lt;a href=&#34;https://github.com/apache/rocketmq-clients&#34;&gt;client SDK&lt;/a&gt; ; 4.0ç›¸å…³ç‰ˆæœ¬æœ‰äº›å¼€å‘è¯­è¨€ä¸æ”¯æŒtcpæ–¹å¼ï¼Œä»…æä¾›httpçš„æ–¹å¼(ä¼šå°‘äº†ä¸€äº›åŠŸèƒ½ï¼Œæ¯”å¦‚æ‰¹é‡å‘é€æ™®é€šæ¶ˆæ¯)ï¼›é€‰ç”¨æ–°ç‰ˆçš„5.0ç‰ˆæœ¬çš„SDKå¼€å‘(golangç‰ˆclient SDKå¯ä»¥ç”¨æ¥ç”Ÿäº§æ¶ˆæ¯ï¼Œå¯¹åº”æ¶ˆæ¯ç±»å‹éƒ½å·²æ”¯æŒ); å¦‚æœæœ‰è‡ªå»ºè¿ç»´èƒ½åŠ›ï¼Œç›´æ¥ä½¿ç”¨å¼€æºæ–¹æ¡ˆæ¥æ­å»ºä¸€å¥—ï¼Œæ¯”å¦‚ç”¨&lt;a href=&#34;https://www.amazonaws.cn/solutions/apache-rocketmq-on-aws/&#34;&gt;rocketMQ on aws&lt;/a&gt;ï¼Œç„¶åå¯ä»¥åŸºäºOTELçš„metricæ ‡å‡†é‡‡é›†åˆ°Promethuesä¸­ï¼Œé€šè¿‡GrafanaåŠ ä¸Šç›‘æ§æŠ¥è­¦(ç›‘æ§ç³»ç»Ÿä¹Ÿå¯ä»¥è‡ªå»ºï¼Œæˆ–è€…ç”¨äº‘æœåŠ¡æ¯”å¦‚aliyun ARMSï¼ŒåŒæ ·åˆ†å¸ƒå¼db/cacheä¹Ÿæœ‰ç›¸åº”ç›‘æ§è§£å†³æ–¹æ¡ˆ,æ•°æ®æŒ‡æ ‡é‡‡é›†ä¸ŠæŠ¥ä»¥pullæ–¹å¼å±…å¤š,ç›¸å¯¹äºä¸šåŠ¡æœåŠ¡å¸¸è§ä»¥pushæ–¹å¼)ï¼›å¹¶ä¸”ä½¿ç”¨5.0å¯ä»¥å®ç°ä¸€å±‚mq-proxy(æœ¬åœ°ä»£ç†å’Œä¸­å¿ƒä»£ç†)ï¼Œè®¡ç®—å­˜å‚¨åˆ†ç¦»;&lt;/p&gt;
&lt;p&gt;é¢˜å¤–è¯: ç°åœ¨åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—&lt;a href=&#34;https://kafka.apache.org/33/documentation/streams/architecture&#34;&gt;kafka-streams&lt;/a&gt;, &lt;a href=&#34;https://github.com/apache/rocketmq-streams&#34;&gt;rocketmq-streams&lt;/a&gt; æ”¯æŒæ•°æ®æµ(stream)å¤„ç†å¤§æ•°æ®å®æ—¶åœºæ™¯ï¼Œæ”¯æŒä¸€äº›ç®€å•ç®—å­æ“ä½œå’ŒSQL(&lt;a href=&#34;https://github.com/confluentinc/ksql&#34;&gt;ksql&lt;/a&gt;, &lt;a href=&#34;https://github.com/alibaba/rsqldb&#34;&gt;rsql&lt;/a&gt;)ï¼›è¿™ä¸ªå’Œflinkå¯¹åº”åŠŸèƒ½æ˜¯é‡åˆäº†ï¼Œflinkä¹Ÿåœ¨å¾€table storeä¸Šå‘åŠ›æ»¡è¶³æ•°æ®å †ç§¯çš„èƒ½åŠ›; ä¸€æ³¢æµï½&lt;/p&gt;
&lt;h3 id=&#34;è°ƒç ”&#34;&gt;è°ƒç ”&lt;/h3&gt;
&lt;p&gt;ä»¥pcç«¯æŠ“httpåŒ…ä¸ºä¾‹ï¼Œæ‰‹æœºç«¯æ¥å£ä¸€æ ·ï¼Œä¼ è¾“æ ¼å¼å¯èƒ½ä¸åŒï¼Œpb/json&lt;/p&gt;
&lt;h4 id=&#34;æŠ–éŸ³æ¥å£&#34;&gt;æŠ–éŸ³æ¥å£&lt;/h4&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;curl &lt;span class=&#34;s1&#34;&gt;&amp;#39;https://live.douyin.com/webcast/gift/send/?aid=6383&amp;amp;live_id=1&amp;amp;device_platform=web&amp;amp;language=zh-CN&amp;amp;enter_from=web_live&amp;amp;cookie_enabled=true&amp;amp;screen_width=2048&amp;amp;screen_height=1152&amp;amp;browser_language=zh-CN&amp;amp;browser_platform=MacIntel&amp;amp;browser_name=Chrome&amp;amp;browser_version=107.0.0.0&amp;amp;browser_online=true&amp;amp;engine_name=Blink&amp;amp;engine_version=107.0.0.0&amp;amp;os_name=Mac+OS&amp;amp;os_version=10.15.7&amp;amp;cpu_core_num=8&amp;amp;device_memory=8&amp;amp;platform=PC&amp;amp;downlink=10&amp;amp;effective_type=4g&amp;amp;round_trip_time=50&amp;amp;channel=channel_pc_web&amp;amp;app_name=douyin_web&amp;amp;webid=7167235205950047744&amp;amp;user_agent=Mozilla%2F5.0+(Macintosh%3B+Intel+Mac+OS+X+10_15_7)+AppleWebKit%2F537.36+(KHTML,+like+Gecko)+Chrome%2F107.0.0.0+Safari%2F537.36&amp;amp;fp=verify_lam4f5i1_plZJSYeB_iUgU_4z2o_9JHF_d7Z0Z60sLg33&amp;amp;did=0&amp;amp;referer=https:%2F%2Flive.douyin.com%2F444452144000%3Fcover_type%3D0%26enter_from_merge%3Dweb_live%26enter_method%3Dweb_card%26game_name%3D%26is_recommend%3D1%26live_type%3Dgame%26more_detail%3D%26request_id%3D2022111814283801020916816201004237%26room_id%3D7167220081737468683%26stream_type%3Dvertical%26title_type%3D1%26web_live_page%3Dhot_live%26web_live_tab%3Dall&amp;amp;target=&amp;amp;device_id=7167235205950047744&amp;amp;msToken=aOEoMNHAEI98H45Z0n-zUTffiNgv7HNkGU0lwFptk-JBg00tEs0I74G4sYXgG670cAdhSmXNcKlRU3-QaxW7Pflt-p8YAmyU5eC3EGJQfp7Mk7JpmP_P&amp;amp;X-Bogus=DFSzswVL0qCmAcoQS8MuBN7TlqS8&amp;amp;_signature=_02B4Z6wo00001Heu8JQAAIDD43irmgubdKx3rvQAAH6ktTtRdH7gtQJWp3SjldUkeBB51lpkXUQ700UnFEXODUicQ0r1ccxSxq4OwWIjvxuNe8Acl-gJzChe99W43SojHkPp9aa82Qzi9VoTd2&amp;#39;&lt;/span&gt; &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;  -H &lt;span class=&#34;s1&#34;&gt;&amp;#39;authority: live.douyin.com&amp;#39;&lt;/span&gt; &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;  -H &lt;span class=&#34;s1&#34;&gt;&amp;#39;accept: application/json, text/plain, */*&amp;#39;&lt;/span&gt; &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;  -H &lt;span class=&#34;s1&#34;&gt;&amp;#39;accept-language: zh-CN,zh;q=0.9,en;q=0.8,zh-TW;q=0.7&amp;#39;&lt;/span&gt; &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;  -H &lt;span class=&#34;s1&#34;&gt;&amp;#39;content-type: application/x-www-form-urlencoded&amp;#39;&lt;/span&gt; &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;  -H &lt;span class=&#34;s1&#34;&gt;&amp;#39;cookie: xgplayer_user_id=502915240928; csrf_session_id=f5161482adac52884f25a91fa758d7b0; ttcid=5cd5ff73751f4ab39911c85e57f9ca7479; passport_csrf_token=46e48d1e7b4df245f8caab8a34b64935; passport_csrf_token_default=46e48d1e7b4df245f8caab8a34b64935; home_can_add_dy_2_desktop=%220%22; n_mh=Qo43cptpX41bfwDmWyVyRUGMZnsucxhgcWJqKjjWkvI; sso_uid_tt=a84f8e3ae1f0c8301f5a882b05abe3f0; sso_uid_tt_ss=a84f8e3ae1f0c8301f5a882b05abe3f0; toutiao_sso_user=a28a6e92e7dc7d690b4f6b9a59077692; toutiao_sso_user_ss=a28a6e92e7dc7d690b4f6b9a59077692; passport_assist_user=Cjyr0IY04IJK-7Hxgl87vzPKZIfpFS29oAG2arITfMftUANM_d6SDxwAksiJEuVqZgZdE_BYyvcjLLGAQaYaSAo8zVwGiPnNM3S7eRNlXwMkuS7yNVm17pbNfKqXsXj3Rgk9Nm08DWh_PY0JRbH8FQeLxabRAoqM4bPJTzQ8EM_DoQ0Yia_WVCIBAxToQPk%3D; sid_ucp_sso_v1=1.0.0-KGIxM2FlNmE2MDdiNWE5MDA1YmIwZjg5OWVkNTUxMTBhMzdhYWE2OTIKHQjhrMGYrgIQt8vcmwYY7zEgDDDHuNHRBTgGQPQHGgJobCIgYTI4YTZlOTJlN2RjN2Q2OTBiNGY2YjlhNTkwNzc2OTI; ssid_ucp_sso_v1=1.0.0-KGIxM2FlNmE2MDdiNWE5MDA1YmIwZjg5OWVkNTUxMTBhMzdhYWE2OTIKHQjhrMGYrgIQt8vcmwYY7zEgDDDHuNHRBTgGQPQHGgJobCIgYTI4YTZlOTJlN2RjN2Q2OTBiNGY2YjlhNTkwNzc2OTI; passport_auth_status=ba24f5319c0f02c6232d484fd51c2187%2C; passport_auth_status_ss=ba24f5319c0f02c6232d484fd51c2187%2C; sid_guard=ea2e466c926c317f4f552f0d3982a458%7C1668752823%7C5184000%7CTue%2C+17-Jan-2023+06%3A27%3A03+GMT; uid_tt=23c596f546d448da13c0098152ef5d17; uid_tt_ss=23c596f546d448da13c0098152ef5d17; sid_tt=ea2e466c926c317f4f552f0d3982a458; sessionid=ea2e466c926c317f4f552f0d3982a458; sessionid_ss=ea2e466c926c317f4f552f0d3982a458; sid_ucp_v1=1.0.0-KDRiMzcyMDVkZmZhMWIxNjhjNDM4YjBiZDA4Y2E5ZTBmN2IxNTE1NjIKFwjhrMGYrgIQt8vcmwYY7zEgDDgGQPQHGgJsZiIgZWEyZTQ2NmM5MjZjMzE3ZjRmNTUyZjBkMzk4MmE0NTg; ssid_ucp_v1=1.0.0-KDRiMzcyMDVkZmZhMWIxNjhjNDM4YjBiZDA4Y2E5ZTBmN2IxNTE1NjIKFwjhrMGYrgIQt8vcmwYY7zEgDDgGQPQHGgJsZiIgZWEyZTQ2NmM5MjZjMzE3ZjRmNTUyZjBkMzk4MmE0NTg; FOLLOW_NUMBER_YELLOW_POINT_INFO=%22MS4wLjABAAAAt_v5oVMmcxuNnLLRzi6Ey1GKVQr_2XVFt2jPbkhZPI8%2F1668787200000%2F0%2F1668752826051%2F0%22; strategyABtestKey=%221668752909.101%22; __ac_nonce=06377261b0070042789c9; __ac_signature=_02B4Z6wo00f01JfP74gAAIDDAxm0hJMbmiiX7-sAAEaJTk9YXvYiEKlcYbhZnUTqyIVISJ6Z9uR3UEye00i7MfEP1dAywrmbnaQAIP3m1.7zOA8BmpqIWhyYJal-u6k6LMxVpsCtyakYsz3325; live_can_add_dy_2_desktop=%221%22; tt_scid=PpJHVbeNWnhY54EQ6vWraqXl5A8SZDtl3dn9JTaQQNLPo37ztPaJz.xoJHxyhNYScf8e; s_v_web_id=verify_lam4f5i1_plZJSYeB_iUgU_4z2o_9JHF_d7Z0Z60sLg33; ttwid=1%7C-XDacSDIgDIHmJqBxLj6Op91O91Ww4nvf96AveJpNeE%7C1668752951%7C0275ac24a410dd06b5f87dc4d84188f6eedaf20ed69cc9d0e979559df7df461e; download_guide=%223%2F20221118%22; odin_tt=3a02e4ad7a6c9042e1c42ece6d0d4a1aeeb37ed334f3450eb4adf57a6d0e09938523f8954816d90d557b27f5d3cbea85; msToken=1GTirdFSckP7H_txAPOKIMLWleKhlwccm-ts_3OviXegeQ2cr0B56jMAqfB3SqEGnxPEBjXRWsmg-sxVW3okb1s-acOAnBkIVDA_47g5aZFOqMKEzI-N; msToken=aOEoMNHAEI98H45Z0n-zUTffiNgv7HNkGU0lwFptk-JBg00tEs0I74G4sYXgG670cAdhSmXNcKlRU3-QaxW7Pflt-p8YAmyU5eC3EGJQfp7Mk7JpmP_P&amp;#39;&lt;/span&gt; &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;  -H &lt;span class=&#34;s1&#34;&gt;&amp;#39;origin: https://live.douyin.com&amp;#39;&lt;/span&gt; &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;  -H &lt;span class=&#34;s1&#34;&gt;&amp;#39;referer: https://live.douyin.com/444452144000&amp;#39;&lt;/span&gt; &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;  -H &lt;span class=&#34;s1&#34;&gt;&amp;#39;sec-ch-ua: &amp;#34;Google Chrome&amp;#34;;v=&amp;#34;107&amp;#34;, &amp;#34;Chromium&amp;#34;;v=&amp;#34;107&amp;#34;, &amp;#34;Not=A?Brand&amp;#34;;v=&amp;#34;24&amp;#34;&amp;#39;&lt;/span&gt; &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;  -H &lt;span class=&#34;s1&#34;&gt;&amp;#39;sec-ch-ua-mobile: ?0&amp;#39;&lt;/span&gt; &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;  -H &lt;span class=&#34;s1&#34;&gt;&amp;#39;sec-ch-ua-platform: &amp;#34;macOS&amp;#34;&amp;#39;&lt;/span&gt; &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;  -H &lt;span class=&#34;s1&#34;&gt;&amp;#39;sec-fetch-dest: empty&amp;#39;&lt;/span&gt; &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;  -H &lt;span class=&#34;s1&#34;&gt;&amp;#39;sec-fetch-mode: cors&amp;#39;&lt;/span&gt; &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;  -H &lt;span class=&#34;s1&#34;&gt;&amp;#39;sec-fetch-site: same-origin&amp;#39;&lt;/span&gt; &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;  -H &lt;span class=&#34;s1&#34;&gt;&amp;#39;user-agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/107.0.0.0 Safari/537.36&amp;#39;&lt;/span&gt; &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;  -H &lt;span class=&#34;s1&#34;&gt;&amp;#39;x-secsdk-csrf-token: 000100000001c39118162052c6b50f6dadb067cc07c073c9b93f035ea22242c67c43f5951903172899f1bc355042&amp;#39;&lt;/span&gt; &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;  --data-raw &lt;span class=&#34;s1&#34;&gt;&amp;#39;room_id=7167220081737468683&amp;amp;to_room_id=7167220081737468683&amp;amp;sec_to_user_id=MS4wLjABAAAAOgGR5D9qmmPglgaT08-30j8vnjeeAdmgXhJY_8Q7oLk&amp;amp;to_episode_id=0&amp;amp;send_type=4&amp;amp;send_scene=1&amp;amp;gift_source=0&amp;amp;buff_level=0&amp;amp;count=1&amp;amp;price=2&amp;amp;gift_id=2002&amp;amp;is_first_combo=true&amp;#39;&lt;/span&gt; &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;  --compressed -iv
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;å“åº”&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-json&#34; data-lang=&#34;json&#34;&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
 &lt;span class=&#34;nt&#34;&gt;&amp;#34;data&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
   &lt;span class=&#34;nt&#34;&gt;&amp;#34;message&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;Insufficient Fund&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
   &lt;span class=&#34;nt&#34;&gt;&amp;#34;prompts&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;ä½™é¢ä¸è¶³&amp;#34;&lt;/span&gt;
 &lt;span class=&#34;p&#34;&gt;},&lt;/span&gt;
 &lt;span class=&#34;nt&#34;&gt;&amp;#34;extra&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
   &lt;span class=&#34;nt&#34;&gt;&amp;#34;now&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;1668755929438&lt;/span&gt;
 &lt;span class=&#34;p&#34;&gt;},&lt;/span&gt;
 &lt;span class=&#34;nt&#34;&gt;&amp;#34;status_code&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;40001&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h4 id=&#34;å¿«æ‰‹æ¥å£&#34;&gt;å¿«æ‰‹æ¥å£&lt;/h4&gt;
&lt;p&gt;è¯·æ±‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;curl &lt;span class=&#34;s1&#34;&gt;&amp;#39;https://live.kuaishou.com/live_graphql&amp;#39;&lt;/span&gt; &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;  -H &lt;span class=&#34;s1&#34;&gt;&amp;#39;Accept-Language: zh-CN,zh;q=0.9,en;q=0.8,zh-TW;q=0.7&amp;#39;&lt;/span&gt; &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;  -H &lt;span class=&#34;s1&#34;&gt;&amp;#39;Connection: keep-alive&amp;#39;&lt;/span&gt; &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;  -H &lt;span class=&#34;s1&#34;&gt;&amp;#39;Cookie: clientid=3; did=web_0d47b6546f1fd39fe4d1236703ae2b16; kuaishou.live.bfb1s=9b8f70844293bed778aade6e0a8f9942; client_key=65890b29; kpn=GAME_ZONE; userId=553458447; kuaishou.live.web_st=ChRrdWFpc2hvdS5saXZlLndlYi5zdBKgAV6EW8_dkcqveTyN6yy6uaMZd7O2c9rYOi19Fb3FhhOTPjtHtkb7lPQxQ4QaygTV0J-_Z0E7-4E5lFUZ2MRRzwjNAgbEEeSbf5duEVRtpGJnR_EEjJeZ3yyPMWPsJelIVcpSHGX02esKljXrWSXcbMWU709r4hxtaNHdMQtnvmLt1nijHxRE7lio0ZRYM5n-EK65VJq2EUpFqHFY_jFqxm0aEhrHsWfESUHgv806qk-5eqStgCIgOVwse70J74NPwA2TbGfOv-Ze0M-TVQJ0kHcHOHiTkKooBTAB; kuaishou.live.web_ph=75bafd83e69f9caf80b760c47f7b9c976d31; userId=553458447; ksliveShowClipTip=true&amp;#39;&lt;/span&gt; &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;  -H &lt;span class=&#34;s1&#34;&gt;&amp;#39;Origin: https://live.kuaishou.com&amp;#39;&lt;/span&gt; &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;  -H &lt;span class=&#34;s1&#34;&gt;&amp;#39;Referer: https://live.kuaishou.com/u/YiGe6666&amp;#39;&lt;/span&gt; &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;  -H &lt;span class=&#34;s1&#34;&gt;&amp;#39;Sec-Fetch-Dest: empty&amp;#39;&lt;/span&gt; &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;  -H &lt;span class=&#34;s1&#34;&gt;&amp;#39;Sec-Fetch-Mode: cors&amp;#39;&lt;/span&gt; &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;  -H &lt;span class=&#34;s1&#34;&gt;&amp;#39;Sec-Fetch-Site: same-origin&amp;#39;&lt;/span&gt; &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;  -H &lt;span class=&#34;s1&#34;&gt;&amp;#39;User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/107.0.0.0 Safari/537.36&amp;#39;&lt;/span&gt; &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;  -H &lt;span class=&#34;s1&#34;&gt;&amp;#39;accept: */*&amp;#39;&lt;/span&gt; &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;  -H &lt;span class=&#34;s1&#34;&gt;&amp;#39;content-type: application/json&amp;#39;&lt;/span&gt; &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;  -H &lt;span class=&#34;s1&#34;&gt;&amp;#39;sec-ch-ua: &amp;#34;Google Chrome&amp;#34;;v=&amp;#34;107&amp;#34;, &amp;#34;Chromium&amp;#34;;v=&amp;#34;107&amp;#34;, &amp;#34;Not=A?Brand&amp;#34;;v=&amp;#34;24&amp;#34;&amp;#39;&lt;/span&gt; &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;  -H &lt;span class=&#34;s1&#34;&gt;&amp;#39;sec-ch-ua-mobile: ?0&amp;#39;&lt;/span&gt; &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;  -H &lt;span class=&#34;s1&#34;&gt;&amp;#39;sec-ch-ua-platform: &amp;#34;macOS&amp;#34;&amp;#39;&lt;/span&gt; &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;  --data-raw &lt;span class=&#34;s1&#34;&gt;&amp;#39;{&amp;#34;operationName&amp;#34;:&amp;#34;SendTokenGift&amp;#34;,&amp;#34;variables&amp;#34;:{&amp;#34;e&amp;#34;:&amp;#34;UJfUx05OooLVLeaLzurAD7t0ycf7qHV57YPA64hWOh5Nslk4cNv5GCO5UIhUfygGimZNaBMDaQF7CWigSoxuOG4KmX6PBg7Nw/BxK3lCQ/MeVM8H3VRD7RIv7A9H4Zt+z/43c25jpTuaQrjLpxrWXzNYORIKJRjga9ZUGPCbNwatxYFMuVGEJcn8SZxFdd2rr1HMsQV2HXhl1PcILcXZ5fcnu7+VARIIj26snB4TOiQ=&amp;#34;,&amp;#34;iv&amp;#34;:&amp;#34;yLelD2PBybOSK8LM&amp;#34;,&amp;#34;giftId&amp;#34;:114,&amp;#34;liveStreamId&amp;#34;:&amp;#34;sOuGkqrHrOs&amp;#34;,&amp;#34;count&amp;#34;:1,&amp;#34;comboKey&amp;#34;:&amp;#34;IZLFwC_9lDBi2YL6_1668754497884&amp;#34;,&amp;#34;giftToken&amp;#34;:&amp;#34;CkMQj7b0hwIaNIECAoICgwLHAgmLAowCjQIOENsBnAGfAt8B4AEhoQLhAakCKXFysgLyAfYBtwL3AfgB+QEgNCi36OokEIzc0szIMBqQARbIi9FshY8J3yb72Pi3Kf3b4VlRZ8dHHr2d64OWA545YQ6SBsTaqA6ERQ9DQbGDCXK3L5MoVtVL/wy4cLlD+XTMYIYjEYUU/0IwTbvhrTXWdll64SIP1APvRQXCjDugMBShDAqlMCBPqREhchX0t8tXHhYO2h+h6k3+kwe3yAdSioapP7i5NxtuLxCFTYPiVA==&amp;#34;},&amp;#34;query&amp;#34;:&amp;#34;mutation SendTokenGift($e: String, $iv: String, $giftId: Int, $liveStreamId: ID, $count: Int, $comboKey: String, $giftToken: String) {\n  sendTokenGift(e: $e, iv: $iv, giftId: $giftId, liveStreamId: $liveStreamId, count: $count, comboKey: $comboKey, giftToken: $giftToken) {\n    result\n    ksCoin\n    styleType\n    __typename\n  }\n}\n&amp;#34;}&amp;#39;&lt;/span&gt; &lt;span class=&#34;se&#34;&gt;\
&lt;/span&gt;&lt;span class=&#34;se&#34;&gt;&lt;/span&gt;  --compressed -iv
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;å“åº”&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-json&#34; data-lang=&#34;json&#34;&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
  &lt;span class=&#34;nt&#34;&gt;&amp;#34;data&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
    &lt;span class=&#34;nt&#34;&gt;&amp;#34;sendTokenGift&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
      &lt;span class=&#34;nt&#34;&gt;&amp;#34;result&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;//æˆåŠŸ&lt;/span&gt;
      &lt;span class=&#34;nt&#34;&gt;&amp;#34;ksCoin&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
      &lt;span class=&#34;nt&#34;&gt;&amp;#34;styleType&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;kc&#34;&gt;null&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
      &lt;span class=&#34;nt&#34;&gt;&amp;#34;__typename&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;SendGiftResult&amp;#34;&lt;/span&gt;
    &lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
  &lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;å¿«æ‰‹ç»™ç«¯ä¸Šçš„æ¥å£ä½¿ç”¨çš„&lt;a href=&#34;https://spec.graphql.org/draft/&#34;&gt;graphql&lt;/a&gt;ç»Ÿä¸€ä¸­å¿ƒåŒ–äº†å…¥å£ï¼Œæ–¹ä¾¿åç»­è§„èŒƒåŒ–ç®¡ç†æ¥å£ï¼›æ•´ä½“äº¤äº’ä¹Ÿæœ‰äº›å·®åˆ«ï¼Œä¸€ä¸ªæ˜¯åç½®åˆ¤æ–­ï¼Œä¸€ä¸ªæ˜¯å‰ç½®åˆ¤æ–­ç¤¼ç‰©æ˜¯å¦å¯ä»¥èµ é€ï¼Œä½†æ˜¯å¯¹äºèµ é€ç¤¼ç‰©æ¥å£è¿˜æ˜¯éœ€è¦åˆ¤æ–­æ˜¯å¦æ»¡è¶³èµ é€çš„é‡‘é¢ï¼›å‰ç½®å¯¹äºç”¨æˆ·ä½“éªŒä¼šå¥½äº›ï¼Œå°‘äº†äº›äº¤äº’å§; æ¥å£æ•°æ®éƒ½æœ‰tokenåŠ å¯†éªŒè¯ï¼Œé˜²æ­¢ä¸‰æ–¹é»‘äº§ä¸­é€”æ‹¦æˆªï¼Œåè€…å¯¹æ•´ä½“èµ é€æ•°æ®ä¹Ÿæ˜¯å‹ç¼©åŠ å¯†äº†(ç”¨æˆ·è¡Œä¸ºæ‰“ç‚¹æ•°æ®ä¹Ÿæ˜¯å‹ç¼©ä¸ŠæŠ¥çš„)ï¼›&lt;/p&gt;
&lt;p&gt;Tips: è²Œä¼¼ç¤¼ç‰©çš„ä»·æ ¼åœ¨å„ä¸ªç›´æ’­å¹³å°éƒ½ä¸€æ ·çš„ï¼Œä¸åƒå•†å“ä»·æ ¼æœ‰ç›¸å¯¹æ³¢åŠ¨ï¼Œåªæ˜¯ä¼šæœ‰äº›ç›´æ’­åœºæ™¯å®šåˆ¶åŒ–çš„ç¤¼ç‰©ï¼Œæœ‰ç§éç†æ€§æƒ…æ„Ÿå†²åŠ¨æ¶ˆè´¹çš„æ„Ÿè§‰ï¼Œæç›´æ’­ç±»ç”¨æˆ·äº§å“ï¼Œç¤¾ä¼šå¿ƒç†å­¦è²Œä¼¼æŒºé‡è¦çš„ï¼Œè€é“å¸¦ä¸€æ³¢èŠ‚å¥ 666ï½&lt;/p&gt;
&lt;h3 id=&#34;è®¾è®¡&#34;&gt;è®¾è®¡&lt;/h3&gt;
&lt;h4 id=&#34;æ•´ä½“è®¾è®¡æœåŠ¡æ¨¡å—æµç¨‹&#34;&gt;æ•´ä½“è®¾è®¡æœåŠ¡æ¨¡å—æµç¨‹&lt;/h4&gt;
&lt;p&gt;&lt;img src=&#34;https://raw.githubusercontent.com/weedge/mypic/master/%E7%9B%B4%E6%92%AD%E4%BA%92%E5%8A%A8-%E8%B5%A0%E9%80%81%E7%A4%BC%E7%89%A9%E8%AE%BE%E8%AE%A1.drawio.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;h4 id=&#34;db&#34;&gt;DB&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;gift ç¤¼ç‰©è¡¨&lt;/strong&gt;ï¼šæœ‰é™é›†ï¼Œè¿™ä¸ªç‰©æ–™æ•°ç›®æ˜¯å›ºå®šçš„ï¼Œæ²¡æœ‰SKUè¿™ä¸€æ¦‚å¿µï¼Œå¯ä»¥ç›´æ¥å®šä¹‰å¥½é…ç½®ä¹‹åï¼Œç›´æ¥å­˜æ”¾åœ¨æ•°æ®åº“ä¸­ï¼›ä¾¿äºåç»­ç¼“å­˜è‡³è¿œç«¯æˆ–è€…æœåŠ¡æœ¬åœ°ï¼›&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;å­—æ®µ&lt;/th&gt;
&lt;th&gt;ç±»å‹&lt;/th&gt;
&lt;th&gt;æè¿°&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;giftId&lt;/td&gt;
&lt;td&gt;int64&lt;/td&gt;
&lt;td&gt;UK  å”¯ä¸€é”®&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;name&lt;/td&gt;
&lt;td&gt;string&lt;/td&gt;
&lt;td&gt;ç¤¼ç‰©åç§°&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;currencyCn&lt;/td&gt;
&lt;td&gt;int&lt;/td&gt;
&lt;td&gt;ä»·æ ¼ï¼šè™šæ‹Ÿè´§å¸æ•°ç›®&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;unit&lt;/td&gt;
&lt;td&gt;int&lt;/td&gt;
&lt;td&gt;è™šæ‹Ÿè´§å¸åº¦é‡å•ä½ï¼Œå¯¹åº”èµ„äº§ç±»å‹ï¼šé‡‘å¸/é’»çŸ³/Xå¸&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;giftCategory&lt;/td&gt;
&lt;td&gt;string&lt;/td&gt;
&lt;td&gt;ç¤¼ç‰©ç±»åˆ«&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;iconUrl&lt;/td&gt;
&lt;td&gt;string&lt;/td&gt;
&lt;td&gt;ç¤¼ç‰©iconåœ°å€&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;sendRule&lt;/td&gt;
&lt;td&gt;string&lt;/td&gt;
&lt;td&gt;èµ é€è§„åˆ™&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;effectsUrl&lt;/td&gt;
&lt;td&gt;string&lt;/td&gt;
&lt;td&gt;ç¤¼ç‰©ç‰¹æ•ˆåœ°å€&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;createdAt&lt;/td&gt;
&lt;td&gt;timestamp&lt;/td&gt;
&lt;td&gt;åˆ›å»ºæ—¶é—´&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;updatedAt&lt;/td&gt;
&lt;td&gt;timestamp&lt;/td&gt;
&lt;td&gt;æ›´æ–°æ—¶é—´&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;&lt;strong&gt;user_asset ç”¨æˆ·æ‹¥æœ‰çš„è™šæ‹Ÿèµ„äº§è¡¨&lt;/strong&gt;ï¼š  ç”¨æˆ·å½“å‰æ‹¥æœ‰çš„è™šæ‹Ÿå¸ä½™é¢ï¼Œ å»ºåº“å»ºè¡¨æŒ‰ç…§userIdè¿›è¡Œhash åˆ†åº“åˆ†è¡¨åˆ†åŒº/åˆ†ç‰‡(Region) (å†™æ›´æ–°çƒ­ç‚¹) æ•°æ®é‡æŒ‰ä¸­å›½æ€»äººå£è®¡ç®—ï¼Œä¸€å¼ ç‰©ç†è¡¨å­˜æ”¾1000wæ•°æ®&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;å­—æ®µ&lt;/th&gt;
&lt;th&gt;ç±»å‹&lt;/th&gt;
&lt;th&gt;æè¿°&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;userId&lt;/td&gt;
&lt;td&gt;int64&lt;/td&gt;
&lt;td&gt;ç”¨æˆ·id&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;assetCn&lt;/td&gt;
&lt;td&gt;int&lt;/td&gt;
&lt;td&gt;èµ„äº§æ•°é‡&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;assetType&lt;/td&gt;
&lt;td&gt;int&lt;/td&gt;
&lt;td&gt;èµ„äº§ç±»å‹ 1. é‡‘å¸ 2.é’»çŸ³ 3. Xå¸ &lt;del&gt;4. Xä¼˜æƒ å·&lt;/del&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;version&lt;/td&gt;
&lt;td&gt;int64&lt;/td&gt;
&lt;td&gt;æ›´æ–°ç‰ˆæœ¬&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;createdAt&lt;/td&gt;
&lt;td&gt;timestamp&lt;/td&gt;
&lt;td&gt;åˆ›å»ºæ—¶é—´&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;updatedAt&lt;/td&gt;
&lt;td&gt;timestamp&lt;/td&gt;
&lt;td&gt;æ›´æ–°æ—¶é—´&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;cm&#34;&gt;/* local mysql innodb(index B+TREE) */&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;create&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;database&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;pay&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;{$&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;dbpartitions&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;CREATE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;TABLE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;pay&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;{$&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;dbpartitions&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;user_assert&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;userId&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;bigint&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;unsigned&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;NOT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;NULL&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;DEFAULT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;0&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;assetCn&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;bigint&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;unsigned&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;NOT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;NULL&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;DEFAULT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;0&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;assetType&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;tinyint&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;unsigned&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;NOT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;NULL&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;DEFAULT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;0&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;version&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;bigint&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;unsigned&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;NOT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;NULL&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;DEFAULT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;0&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;createdAt&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;timestamp&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;NOT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;NULL&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;DEFAULT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;CURRENT_TIMESTAMP&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;updatedAt&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;timestamp&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;NOT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;NULL&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;DEFAULT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;CURRENT_TIMESTAMP&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;ON&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;UPDATE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;CURRENT_TIMESTAMP&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;UNIQUE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;KEY&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;uk_user_assertType&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;userId&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;assetType&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ENGINE&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;InnoDB&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;DEFAULT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;CHARSET&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;utf8mb4&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;partition&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;by&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;hash&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;userId&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;partitions&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;16&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;create&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;table&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;pay&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;{$&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;dbpartitions&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;user_assert$&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;tbpartitions&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;like&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;user_assert&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;cm&#34;&gt;/* create table add this for tidb tikv(index LSM-TREE) */&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;cm&#34;&gt;/* eg: partitions*2^min(SHARD_ROW_ID_BITS,PRE_SPLIT_REGIONS) = 128 regions, echo regions 96MB(compressed) */&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;cm&#34;&gt;/* if don&amp;#39;t use regions, those regions will be recycled */&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;cm&#34;&gt;/*T! SHARD_ROW_ID_BITS=4 PRE_SPLIT_REGIONS=3 */&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;CREATE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;TABLE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;user_asset&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;userId&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;bigint&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;unsigned&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;NOT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;NULL&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;DEFAULT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;0&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;assetCn&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;bigint&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;unsigned&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;NOT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;NULL&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;DEFAULT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;0&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;assetType&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;tinyint&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;unsigned&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;NOT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;NULL&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;DEFAULT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;0&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;version&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;bigint&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;unsigned&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;NOT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;NULL&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;DEFAULT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;0&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;createdAt&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;timestamp&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;NOT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;NULL&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;DEFAULT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;CURRENT_TIMESTAMP&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;updatedAt&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;timestamp&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;NOT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;NULL&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;DEFAULT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;CURRENT_TIMESTAMP&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;ON&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;UPDATE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;CURRENT_TIMESTAMP&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;UNIQUE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;KEY&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;uk_user_assetType&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;userId&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;assetType&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;DEFAULT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;CHARSET&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;utf8mb4&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;SHARD_ROW_ID_BITS&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;4&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;PRE_SPLIT_REGIONS&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;3&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;partition&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;by&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;hash&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;userId&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;partitions&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;16&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;show&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;table&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;user_asset&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;regions&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;cm&#34;&gt;/* create db table for polardb-x innodb(index B+TREE) */&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;cm&#34;&gt;/* PARTITION_MODE drds/sharding (db,table), auto/partitioning use partitioning */&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;cm&#34;&gt;/* create database `pay` PARTITION_MODE=sharding; */&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;create&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;database&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;pay&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;PARTITION_MODE&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;partitioning&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;CREATE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;TABLE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;pay&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;user_asset&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;userId&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;bigint&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;unsigned&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;NOT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;NULL&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;DEFAULT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;0&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;assetCn&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;bigint&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;unsigned&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;NOT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;NULL&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;DEFAULT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;0&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;assetType&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;tinyint&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;unsigned&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;NOT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;NULL&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;DEFAULT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;0&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;version&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;bigint&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;unsigned&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;NOT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;NULL&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;DEFAULT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;0&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;createdAt&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;timestamp&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;NOT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;NULL&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;DEFAULT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;CURRENT_TIMESTAMP&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;updatedAt&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;timestamp&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;NOT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;NULL&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;DEFAULT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;CURRENT_TIMESTAMP&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;ON&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;UPDATE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;CURRENT_TIMESTAMP&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;UNIQUE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;KEY&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;uk_user_assetType&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;userId&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;assetType&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ENGINE&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;InnoDB&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;DEFAULT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;CHARSET&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;utf8mb4&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;partition&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;by&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;hash&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;userId&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;partitions&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;128&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;cm&#34;&gt;/*dbpartition by hash(`userId`) tbpartition by hash(`userId`) tbpartitions 16*/&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;show&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;table&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;info&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;from&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;pay&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;user_asset&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;show&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;topology&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;from&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;pay&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;user_asset&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;show&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;rule&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;from&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;pay&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;user_asset&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;SHOW&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;NODE&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;show&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;db&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;status&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;show&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;table&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;status&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;å¯¹äº&lt;strong&gt;å•ä¸ªç”¨æˆ·èµ„äº§ä¿®æ”¹&lt;/strong&gt;ï¼›å¦‚æœå­˜åœ¨ &lt;strong&gt;select èµ„äº§ï¼Œç„¶åæ ¹æ®ä¸åŒäº§å“ç­–ç•¥è¿›è¡Œä¸šåŠ¡é€»è¾‘è®¡ç®—å‡ºæ›´æ–°åèµ„äº§ï¼Œæœ€åupdate æ›´æ–°&lt;/strong&gt; åœºæ™¯ï¼Œåœ¨å¹¶å‘åœºæ™¯ä¸‹ï¼Œä¸‰ç§æ–¹å¼ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;æœåŠ¡ç›´æ¥é€šè¿‡åˆ†å¸ƒå¼é”æ¥å¤„ç†ï¼Œè¿™ç§æ–¹å¼ä¸èƒ½é˜²ä½å…¶ä»–å…¶ä»–æœåŠ¡æˆ–è€…è„šæœ¬ç›´æ¥æ“ä½œæ•°æ®åº“çš„æƒ…å†µï¼Œé™¤éåœ¨æ“ä½œä¹‹å‰ä¹Ÿå»è·å–ä¸€æ¬¡é”ï¼Œè€Œä¸”å¼•å…¥å¤–éƒ¨ä¾èµ–ï¼›å¯ä»¥è€ƒè™‘è‡ªä¸¾æ–¹å¼ï¼ŒæœåŠ¡èµ„æºå®ä¾‹è‡ªå·±æ¥ä¸Šé”ï¼›&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;æ‚²è§‚é” select for updateäº‹åŠ¡å®ç°&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;k&#34;&gt;SET&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;AUTOCOMMIT&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; 
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;BEGIN&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;ï¼›&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;   &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;SELECT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;assetCn&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;FROM&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;user_asset&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;WHERE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;userId&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;{$&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;userId&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;and&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;assetType&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;{$&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;assetType&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;FOR&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;UPDATE&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;   &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;update&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;user_asset&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;set&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;assetCn&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;assetCn&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;{$&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;incrCn&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;where&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;userId&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;{$&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;userId&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;and&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;assetType&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;{$&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;assetType&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; 
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;COMMIT&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ol start=&#34;3&#34;&gt;
&lt;li&gt;ä¹è§‚é” CASçš„æ–¹å¼ï¼Œæ²¡æœ‰æ›´æ–°ç»§ç»­å¾ªç¯ï¼Œç›´åˆ°æ›´æ–°ok&lt;/li&gt;
&lt;/ol&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;n&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;SELECT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;assetCn&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;FROM&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;user_asset&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;WHERE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;userId&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;{$&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;userId&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;and&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;assetType&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;{$&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;assetType&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;#&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;$&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;oldAssetCn&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;assetCn&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;#&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;$&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;newAssetCn&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;assetCn&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;$&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;incrCn&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;#&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;err&#34;&gt;$&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;newAssetCn&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;update&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;update&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;user_asset&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;set&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;assetCn&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;{$&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;newAssetCn&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;where&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;userId&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;{$&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;userId&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;and&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;assetType&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;{$&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;assetType&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;and&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;assetCn&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;err&#34;&gt;{$&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;oldAssetCn&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; 
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;å­˜åœ¨ABAé—®é¢˜ï¼š&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;è€ƒè™‘å¦‚ä¸‹æ“ä½œï¼š&lt;/p&gt;
&lt;p&gt;å¹¶å‘1ï¼ˆä¸Šï¼‰ï¼šè·å–å‡ºæ•°æ®çš„åˆå§‹å€¼æ˜¯Aï¼Œåç»­è®¡åˆ’å®æ–½CASä¹è§‚é”ï¼ŒæœŸæœ›æ•°æ®ä»æ˜¯Açš„æ—¶å€™ï¼Œä¿®æ”¹æ‰èƒ½æˆåŠŸ&lt;/p&gt;
&lt;p&gt;å¹¶å‘2ï¼šå°†æ•°æ®ä¿®æ”¹æˆB&lt;/p&gt;
&lt;p&gt;å¹¶å‘3ï¼šå°†æ•°æ®ä¿®æ”¹å›A&lt;/p&gt;
&lt;p&gt;å¹¶å‘1ï¼ˆä¸‹ï¼‰ï¼šCASä¹è§‚é”ï¼Œæ£€æµ‹å‘ç°åˆå§‹å€¼è¿˜æ˜¯Aï¼Œè¿›è¡Œæ•°æ®ä¿®æ”¹&lt;/p&gt;
&lt;p&gt;å¹¶å‘1åœ¨ä¿®æ”¹æ•°æ®æ—¶ï¼Œè™½ç„¶è¿˜æ˜¯Aï¼Œä½†å·²ç»ä¸æ˜¯åˆå§‹æ¡ä»¶çš„Aäº†ï¼Œä¸­é—´å‘ç”Ÿäº†Aå˜Bï¼ŒBåˆå˜Açš„å˜åŒ–ï¼Œæ­¤Aå·²ç»éå½¼Aï¼Œæ•°æ®å´æˆåŠŸä¿®æ”¹ï¼Œå¯èƒ½å¯¼è‡´é”™è¯¯&lt;/p&gt;
&lt;p&gt;ABAé—®é¢˜å¯¼è‡´çš„åŸå› ï¼Œæ˜¯CASè¿‡ç¨‹ä¸­åªç®€å•è¿›è¡Œäº†â€œå€¼â€çš„æ ¡éªŒï¼Œå†æœ‰äº›æƒ…å†µä¸‹ï¼Œâ€œå€¼â€ç›¸åŒä¸ä¼šå¼•å…¥é”™è¯¯çš„ä¸šåŠ¡é€»è¾‘ï¼ˆä¾‹å¦‚åº“å­˜ï¼‰ï¼Œæœ‰äº›æƒ…å†µä¸‹ï¼Œâ€œå€¼â€è™½ç„¶ç›¸åŒï¼Œå´å·²ç»ä¸æ˜¯åŸæ¥çš„æ•°æ®äº†ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;åŠ ä¸Šç‰ˆæœ¬å­—æ®µversion, å¯¹ç‰ˆæœ¬è¿›è¡ŒCASæ›´æ–°&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;n&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;SELECT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;assetCn&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;version&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;FROM&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;user_asset&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;WHERE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;userId&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;{$&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;userId&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;and&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;assetType&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;{$&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;assetType&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;#&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;$&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;oldAssetCn&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;assetCn&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;#&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;$&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;oldVersion&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;version&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;#&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;$&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;newAssetCn&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;assetCn&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;$&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;incrCn&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;#&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;err&#34;&gt;$&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;newAssetCn&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;update&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;#&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;$&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;newVersion&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;err&#34;&gt;$&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;oldVersion&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;update&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;user_asset&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;set&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;assetCn&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;{$&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;newAssetCn&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;and&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;version&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;{$&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;newVersion&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;where&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;userId&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;{$&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;userId&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;and&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;assetType&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;{$&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;assetType&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;and&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;version&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;err&#34;&gt;{$&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;oldVersion&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; 
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;æƒ³ä¸€æƒ³ï¼šmysqlä¸ºäº†é«˜å¯ç”¨å’Œè¯»å†™åˆ†ç¦»ï¼Œç”Ÿäº§ç¯å¢ƒéƒ¨ç½²çš„å®ä¾‹é›†ç¾¤æ˜¯ä¸»ä»æ¶æ„ï¼Œå­˜åœ¨ä¸»ä»å»¶è¿Ÿï¼Œå…¶å®è¿™ä¸ªæ˜¯ä¸å½±å“çš„ï¼Œæœ€ç»ˆéƒ½æ˜¯CASçš„updateæ›´æ–°ï¼Œæ›´æ–°æˆåŠŸä¼šè¿”å›affect rowsä¸º1ï¼Œæ²¡æœ‰æ›´æ–°åˆ™ä¸º0ï¼›&lt;/p&gt;
&lt;p&gt;Notice:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;select for update åŠ æ’æ–¥é”å’Œæ‰€å»ºçš„ç´¢å¼•æœ‰å…³(é—´éš”(gap)é”ï¼Œä¸´é”®(next-key)é”ï¼Œé”è¡Œ/è¡¨)&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;å¦‚æœä½¿ç”¨mongodbæ¥å­˜æ”¾ï¼Œç›´æ¥ä½¿ç”¨findAndModifyæ¥æ“ä½œå³å¯ï¼Œå½“ç„¶é˜²æ­¢é‡å¤æ•°æ®ï¼Œéœ€è¦åŠ å”¯ä¸€ç´¢å¼•(é”æ–‡æ¡£)&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;strong&gt;user_asset_record ç”¨æˆ·è™šæ‹Ÿå¸äº¤æ˜“æµæ°´è¡¨&lt;/strong&gt;ï¼šè®°å½•è™šæ‹Ÿå¸å¢åŠ å’Œå‡å°‘æ•°æ®è¯¦æƒ…ï¼Œè¿™ä¸ªæä¾›åå°æŸ¥çœ‹ï¼Œç”¨äºé‡å¤è¯·æ±‚å¹‚ç­‰å¤„ç†ï¼Œ å»ºåº“å»ºè¡¨æŒ‰ç…§userIdè¿›è¡Œhash åˆ†åº“åˆ†è¡¨åˆ†åŒº / åˆ†ç‰‡(Region)ï¼› (å†™æ’å…¥çƒ­ç‚¹) , notice: è¿™é‡Œå†—ä½™è®¾è®¡äº†ï¼Œå¯ä»¥æŒ‰ç…§ç¬¬ä¸‰èŒƒå¼ï¼Œä¸€ä¸ªäº‹ä»¶æœ‰å¤šäººå‚ä¸ï¼Œä¸€ä¸ªäººå¯ä»¥å‚ä¸å¤šä¸ªäº‹ä»¶ï¼Œåˆ†å‡ºä¸€ä¸ªç”¨æˆ·äº‹ä»¶å…³è”è¡¨(user_event)ï¼Œä¸€ä¸ªäº‹ä»¶è¡¨(event_record)ï¼›ä¸»è¦æ˜¯æ–¹ä¾¿æŒ‰ç”¨æˆ·ç»´åº¦è·å–æµæ°´è®°å½•ï¼›è¿™é‡Œå¦‚æœæ ‡å‡†å­—æ®µæ¢æˆå­˜æ”¾æ“ä½œç”¨æˆ·opUserå’Œæ¥å—ç”¨æˆ·toUserï¼Œå¦‚æœæŒ‰ç…§opUserç»´åº¦æ‹†åˆ†ï¼ŒæŸ¥è¯¢toUserçš„æµæ°´æ•°æ®å°±ä¸æ–¹ä¾¿ï¼Œè™½ç„¶polardb-xå¯ä»¥ä½¿ç”¨&lt;a href=&#34;https://help.aliyun.com/document_detail/311522.html&#34;&gt;å…¨å±€äºŒçº§ç´¢å¼•&lt;/a&gt;æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä½†æ˜¯æ¢ä¸ªå»ºè¡¨ç»´åº¦æ€è·¯æ—¢å¯ä»¥æ»¡è¶³å½“å‰è¿™ä¸ªä¸šåŠ¡åœºæ™¯ï¼ŒåŒæ—¶ä¹Ÿé€šç”¨ç»Ÿä¸€ä½¿ç”¨userIdè¿›è¡Œæ‹†åˆ†ï¼Œå¦‚æœæ˜¯ToBåœºæ™¯ï¼Œå¯ä»¥ä½¿ç”¨ç§Ÿæˆ·id(tenantId)åˆ†åº“(ç‰©ç†åº“)ï¼Œç”¨æˆ·userIdåˆ†è¡¨ï¼Œè¿™é‡ŒToCåœºæ™¯ç”¨æˆ·ç»´åº¦ï¼Œç›´æ¥userIdåˆ†åŒºå³å¯ã€‚&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;å­—æ®µ&lt;/th&gt;
&lt;th&gt;ç±»å‹&lt;/th&gt;
&lt;th&gt;æè¿°&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;userId&lt;/td&gt;
&lt;td&gt;int64&lt;/td&gt;
&lt;td&gt;ç”¨æˆ·id&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;opUserType&lt;/td&gt;
&lt;td&gt;int64&lt;/td&gt;
&lt;td&gt;1.æ“ä½œè€…ï¼Œ2.æ¥æ”¶è€…&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;bizId&lt;/td&gt;
&lt;td&gt;int64&lt;/td&gt;
&lt;td&gt;ç›´æ’­åœºæ™¯ï¼šroomIdï¼Œå……å€¼åœºæ™¯ï¼šè®¢å•Id&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;bizType&lt;/td&gt;
&lt;td&gt;int&lt;/td&gt;
&lt;td&gt;ä¸šåŠ¡ç±»å‹ï¼š1.ç›´æ’­äº’åŠ¨ï¼Œ2.å……å€¼&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;eventId&lt;/td&gt;
&lt;td&gt;string&lt;/td&gt;
&lt;td&gt;äº‹ä»¶Id: ç›´æ’­äº’åŠ¨åœºæ™¯ä¸‹ï¼Œäº’åŠ¨äº‹ä»¶id ç”¨äºè´¯å½»æ•´ä¸ªé€ç¤¼ç‰©æµæ°´é“¾è·¯,è¿›è¡Œå¹‚ç­‰å¤„ç†; ç”¨æˆ·å……å€¼åœºæ™¯ä¸‹ï¼Œè®¢å•äº‹ä»¶id,  UUID&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;eventType&lt;/td&gt;
&lt;td&gt;string&lt;/td&gt;
&lt;td&gt;äº‹ä»¶ç±»å‹ï¼ŒinteractGift,  orderApple, orderWX, orderAlipay, orderDouyin&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;objId&lt;/td&gt;
&lt;td&gt;string&lt;/td&gt;
&lt;td&gt;æ“ä½œå¯¹è±¡id, giftId, transactionId/outOrderNo&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;record&lt;/td&gt;
&lt;td&gt;string&lt;/td&gt;
&lt;td&gt;è®°å½•è¡Œä¸º&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;recordOp&lt;/td&gt;
&lt;td&gt;string&lt;/td&gt;
&lt;td&gt;æ“ä½œè®°å½• è™šæ‹Ÿå¸å¢åŠ å’Œå‡å°‘&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;createdAt&lt;/td&gt;
&lt;td&gt;timestamp&lt;/td&gt;
&lt;td&gt;åˆ›å»ºæ—¶é—´&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;updatedAt&lt;/td&gt;
&lt;td&gt;timestamp&lt;/td&gt;
&lt;td&gt;æ›´æ–°æ—¶é—´&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;cm&#34;&gt;/* local mysql innodb(index B+TREE) */&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;create&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;table&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;pay&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;{$&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;dbpartitions&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;user_assert_record&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;userId&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;bigint&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;unsigned&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;not&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;null&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;default&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;0&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;opUserType&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;tinyint&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;unsigned&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;not&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;null&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;default&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;0&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;bizId&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;bigint&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;unsigned&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;not&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;null&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;default&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;0&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;bizType&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;tinyint&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;unsigned&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;not&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;null&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;default&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;0&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;objId&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;varchar&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;128&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;not&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;null&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;default&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;eventId&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;varchar&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;128&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;not&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;null&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;default&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;eventType&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;varchar&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;128&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;not&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;null&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;default&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;record&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;varchar&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;256&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;not&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;null&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;default&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;recordOp&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;varchar&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;64&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;not&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;null&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;default&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;createdAt&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;timestamp&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;not&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;null&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;DEFAULT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;CURRENT_TIMESTAMP&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;updatedAt&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;timestamp&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;not&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;null&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;default&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;CURRENT_TIMESTAMP&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;ON&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;UPDATE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;CURRENT_TIMESTAMP&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;UNIQUE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;KEY&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;uk_user_opUserType_event&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;userId&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;opUserType&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;eventId&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;engine&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;InnoDB&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;default&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;charset&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;utf8mb4&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;partition&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;by&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;hash&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;userId&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;PARTITIONS&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;16&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;create&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;table&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;pay&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;{$&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;dbpartitions&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;user_assert_record$&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;tbpartitions&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;like&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;user_assert_record&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;cm&#34;&gt;/* create table add this for tidb tikv(index LSM-TREE) */&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;cm&#34;&gt;/* eg: partitions*2^min(SHARD_ROW_ID_BITS,PRE_SPLIT_REGIONS) = 256 regions, echo regions 96MB(compressed) */&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;cm&#34;&gt;/* if don&amp;#39;t use regions, those regions will be recycled */&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;cm&#34;&gt;/*T! SHARD_ROW_ID_BITS=4 PRE_SPLIT_REGIONS=5 */&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;create&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;table&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;pay&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;user_asset_record&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;userId&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;bigint&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;unsigned&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;not&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;null&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;default&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;0&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;opUserType&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;tinyint&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;unsigned&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;not&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;null&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;default&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;0&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;bizId&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;bigint&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;unsigned&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;not&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;null&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;default&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;0&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;bizType&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;tinyint&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;unsigned&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;not&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;null&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;default&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;0&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;objId&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;varchar&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;128&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;not&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;null&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;default&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;eventId&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;varchar&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;128&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;not&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;null&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;default&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;eventType&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;varchar&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;128&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;not&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;null&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;default&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;record&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;varchar&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;256&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;not&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;null&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;default&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;recordOp&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;varchar&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;64&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;not&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;null&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;default&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;createdAt&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;timestamp&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;not&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;null&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;DEFAULT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;CURRENT_TIMESTAMP&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;updatedAt&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;timestamp&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;not&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;null&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;default&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;CURRENT_TIMESTAMP&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;ON&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;UPDATE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;CURRENT_TIMESTAMP&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;UNIQUE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;KEY&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;uk_user_opUserType_event&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;userId&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;opUserType&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;eventId&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;engine&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;InnoDB&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;default&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;charset&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;utf8mb4&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;SHARD_ROW_ID_BITS&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;4&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;PRE_SPLIT_REGIONS&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;5&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;PARTITION&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;BY&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;HASH&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;userId&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;PARTITIONS&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;16&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;show&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;table&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;user_asset_record&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;regions&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;cm&#34;&gt;/* create db table for polardb-x innodb(index B+TREE) or tokudb(index Fractal tree) or x-engine(index LSM-TREE) ,for this scene use innodb */&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;cm&#34;&gt;/* PARTITION_MODE drds/sharding (db,table), auto/partitioning use partitioning */&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;cm&#34;&gt;/* create database `pay` PARTITION_MODE=sharding; */&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;create&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;database&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;pay&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;PARTITION_MODE&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;partitioning&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;create&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;table&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;pay&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;user_asset_record&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;userId&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;bigint&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;unsigned&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;not&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;null&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;default&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;0&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;opUserType&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;tinyint&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;unsigned&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;not&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;null&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;default&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;0&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;bizId&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;bigint&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;unsigned&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;not&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;null&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;default&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;0&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;bizType&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;tinyint&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;unsigned&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;not&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;null&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;default&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;0&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;objId&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;varchar&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;128&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;not&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;null&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;default&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;eventId&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;varchar&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;128&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;not&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;null&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;default&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;eventType&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;varchar&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;128&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;not&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;null&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;default&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;record&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;varchar&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;256&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;not&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;null&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;default&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;recordOp&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;varchar&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;64&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;not&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;null&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;default&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;createdAt&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;timestamp&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;not&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;null&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;DEFAULT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;CURRENT_TIMESTAMP&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;updatedAt&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;timestamp&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;not&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;null&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;default&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;CURRENT_TIMESTAMP&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;ON&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;UPDATE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;CURRENT_TIMESTAMP&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;UNIQUE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;KEY&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;uk_user_opUserType_event&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;userId&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;opUserType&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;eventId&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;engine&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;InnoDB&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;cm&#34;&gt;/*tokudb/xengine*/&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;default&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;PARTITION&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;BY&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;HASH&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;userId&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;PARTITIONS&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;256&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;cm&#34;&gt;/*dbpartition by hash(`userId`) tbpartition by hash(`userId`) tbpartitions 16*/&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;show&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;table&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;info&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;from&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;pay&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;user_asset_record&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;show&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;topology&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;from&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;pay&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;user_asset_record&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;show&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;rule&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;from&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;pay&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;user_asset_record&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;`&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;SHOW&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;NODE&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;show&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;db&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;status&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;show&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;table&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;status&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;èµ„æºè¯„ä¼°ï¼šç”¨æŠ–éŸ³çœ‹ä¸‹å¡å¡”å°”ä¸–ç•Œæ¯ï¼Œæ”¯æŒä¸‹æ¢…è€æ¿çš„é˜¿æ ¹å»·ğŸ‡¦ğŸ‡·é˜Ÿç›´æ’­ï¼Œå»ä¼°ç®—ä¸‹å§ï½ï½&lt;/p&gt;
&lt;p&gt;Tips: é‡‡ç”¨åˆ†å¸ƒå¼æ•°æ®åº“ï¼Œå¯¹å…¶èµ„æºè¯„ä¼°ï¼Œå»ºè¡¨ï¼Œç´¢å¼•ï¼Œäº‹åŠ¡ï¼ŒæŸ¥è¯¢ä¼˜åŒ–ç­‰æ“ä½œï¼›è¯·å‚è€ƒè§„èŒƒå’Œæœ€ä½³å®è·µï¼š&lt;a href=&#34;https://docs.pingcap.com/zh/tidb/stable/tidb-best-practices&#34;&gt;tibd æœ€ä½³å®è·µ&lt;/a&gt; &lt;a href=&#34;https://docs.pingcap.com/zh/tidb/stable/high-concurrency-best-practices&#34;&gt;TiDB é«˜å¹¶å‘å†™å…¥åœºæ™¯æœ€ä½³å®è·µ&lt;/a&gt; &lt;a href=&#34;https://cn.pingcap.com/best-practice-detail/best-practices-for-developing-applications-with-tidb&#34;&gt;tidbå¼€å‘è§„èŒƒ&lt;/a&gt; &lt;a href=&#34;https://help.aliyun.com/document_detail/308293.html&#34;&gt;palordb-xæœ€ä½³å®è·µ&lt;/a&gt; ;&lt;/p&gt;
&lt;p&gt;é¢˜å¤–è¯ï¼šTidb åº•å±‚å­˜å‚¨tikvåˆ†ç‰‡é‡‡ç”¨çš„èŒƒå›´åˆ†ç‰‡ï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®šåˆ†ç‰‡æ•°ï¼Œé»˜è®¤1ä¸ªï¼Œå½“tikvä¸Šä¸€ä¸ªregionå†™æ»¡äº†ï¼Œä¼šåŠ¨æ€åˆ†è£‚å‡ºä¸€ä¸ªæ–°çš„region, å¯ä»¥æå‰åˆ†é…å¥½åˆ†ç‰‡æ•°ï¼Œä»¥é˜²æ½®æ±æµé‡çƒ­ç‚¹å†™å…¥ï¼Œæ¯”å¦‚è¿™é‡Œçš„çƒ­é—¨ä¸»æ’­èµ„äº§ä¿¡æ¯ï¼Œä»¥åŠèµ„äº§æµæ°´è®°å½•ï¼Œé€šè¿‡é…ç½® SHARD_ROW_ID_BITS å‚æ•°é€šè¿‡tidbè‡ªèº«æœåŠ¡éšè—ROW_ID hashæ‰“æ•£å†™å…¥çƒ­ç‚¹ï¼Œç±»ä¼¼mrä»»åŠ¡æ•°æ®å€¾æ–œæ—¶çš„å†æ¬¡hashæ‰“æ•£ï¼Œä¸redis/ç¨‹åºä¸­çš„map rehashä¸åŒï¼Œredis rehashè§£å†³ç¢°æ’æŸ¥æ‰¾æ•ˆç‡ä½å’Œç©ºé—´ä½¿ç”¨ç‡ä½é—®é¢˜ï¼Œé€šè¿‡loadFactoré˜ˆå€¼ï¼Œè§¦å‘æ‰©å®¹å’Œç¼©å®¹ï¼Œgolangä¸­map rehashä»…è§¦å‘æ‰©å®¹ï¼Œè¿™é‡Œæ‰€è°ˆçš„æ˜¯æµé‡å€¾æ–œå¯¼è‡´è´Ÿè½½ä¸å‡è¡¡é‡æ–°rehashï¼› è€Œpolardb-xçš„è´Ÿè½½æ‰©å®¹ åˆ™ç±»ä¼¼äºredisçš„rehashæœºåˆ¶æ‰©å®¹ï¼Œæ•°æ®å€¾æ–œçš„é—®é¢˜æ˜¯ä¸èƒ½é€šè¿‡æ‰©å®¹æ¥è§£å†³ï¼Œå¯å‚è€ƒ&lt;a href=&#34;https://help.aliyun.com/document_detail/309469.html&#34;&gt;polardb-xå¦‚ä½•åˆ†ææ•°æ®åˆ†å¸ƒä¸å‡è¡¡&lt;/a&gt;ã€‚&lt;/p&gt;
&lt;p&gt;åœ¨æ”¯ä»˜ä¸­å°ï¼ŒæŸä¸ªäº’åŠ¨æ¶‰åŠåˆ°å¤šä¸ªç”¨æˆ·èµ„äº§çš„å˜æ›´ï¼Œéœ€è¦æŠŠå¤šä¸ªå†™æ“ä½œå…³è”åˆ°ä¸€ä¸ªæœ¬åœ°äº‹åŠ¡è¿›è¡Œå¤„ç†ï¼Œä¿è¯æ•°æ®æ‰£å‡å’Œå¢å‡ä¸€è‡´ï¼Œéœ€è¦å¼€å¯æœ¬åœ°äº‹åŠ¡æ¥å¤„ç†å¤šè¡¨æ•°æ®ï¼›ä»¥ä¸‹gistä¸ºå¹¶å‘mysqlæœ¬åœ°äº‹åŠ¡å¤„ç†æµ‹è¯•demo&lt;/p&gt;
&lt;script type=&#34;application/javascript&#34; src=&#34;https://gist.github.com/weedge/1700dd7053a87a4ab35ba4fce0ebea6a.js&#34;&gt;&lt;/script&gt;

&lt;script type=&#34;application/javascript&#34; src=&#34;https://gist.github.com/weedge/fd731ce8549cd99ccfc9491f6025ae8e.js&#34;&gt;&lt;/script&gt;

&lt;h4 id=&#34;cache&#34;&gt;Cache&lt;/h4&gt;
&lt;h5 id=&#34;keyè®¾è®¡&#34;&gt;keyè®¾è®¡ï¼š&lt;/h5&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;åç§°&lt;/th&gt;
&lt;th&gt;key&lt;/th&gt;
&lt;th&gt;type&lt;/th&gt;
&lt;th&gt;value&lt;/th&gt;
&lt;th&gt;ex&lt;/th&gt;
&lt;th&gt;æ˜¯å¦é¢‘ç¹æ›´æ–°&lt;/th&gt;
&lt;th&gt;è¯´æ˜&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;ç”¨æˆ·è™šæ‹Ÿèµ„äº§ä¿¡æ¯&lt;/td&gt;
&lt;td&gt;I.asset.{userId}.{assetType.string()}&lt;/td&gt;
&lt;td&gt;string/hash&lt;/td&gt;
&lt;td&gt;user_asset(json)&lt;/td&gt;
&lt;td&gt;1 d&lt;/td&gt;
&lt;td&gt;Y&lt;/td&gt;
&lt;td&gt;type: String vs Hash tradeoff &lt;!-- raw HTML omitted --&gt;1. String å¯¹äºredisè¯»è¯¦æƒ…æ•°æ®æ•ˆç‡é«˜ï¼Œä½†æ˜¯å†™æ“ä½œèµ„äº§æ•°ç›®éœ€è¦json decode/encode get/setï¼Œå¦‚æœæ“ä½œæ˜¯åœ¨ä¸šåŠ¡åº”ç”¨é€»è¾‘æœåŠ¡å™¨ä¸Šæ“ä½œå¯ä»¥ä½¿ç”¨(æœ‰å¯¹åº”ä¼˜åŒ–jsonåº“)ï¼Œç»“åˆwatch+äº‹åŠ¡casæ–¹å¼; &lt;!-- raw HTML omitted --&gt;2. Hash ç›¸å¯¹stringè¯»è¯¦æƒ…æ•°æ®æ•ˆç‡ä½äº›ï¼Œä½†æ˜¯å†™æ“ä½œèµ„äº§æ•°ç›®ä»…éœ€hincrby(hget/hset)æ“ä½œå³å¯ï¼Œå¦‚æœæ“ä½œæ˜¯åœ¨æ•°æ®ä¸­å¿ƒredisä¸Šæ‰§è¡Œluaè„šæœ¬åŸå­æ“ä½œå¯ä»¥ä½¿ç”¨ï¼Œredis lua ä½¿ç”¨cjsonåº“ç›¸å¯¹è§£ææ•ˆç‡ä½äº›ï¼Œç‰¹åˆ«æ˜¯å¤§jsonï¼Œå‚è€ƒ&lt;a href=&#34;https://blog.codingnow.com/2014/07/sproto.html&#34;&gt;sproto&lt;/a&gt;ï¼Œå¹¶å‘é‡å¤§å®¹æ˜“å¢åŠ redisæ•°æ®ä¸­å¿ƒè´Ÿè½½ï¼Œé™ä½ååï¼› ç»“åˆå…·ä½“åœºæ™¯ä½¿ç”¨(å°½é‡è®¡ç®—å­˜å‚¨åˆ†ç¦»)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;ç¤¼ç‰©ä¿¡æ¯&lt;/td&gt;
&lt;td&gt;I.gift.{giftId}&lt;/td&gt;
&lt;td&gt;string&lt;/td&gt;
&lt;td&gt;gift(json)&lt;/td&gt;
&lt;td&gt;7 d&lt;/td&gt;
&lt;td&gt;N&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;ç”¨æˆ·ä¿¡æ¯&lt;/td&gt;
&lt;td&gt;I.user.{userId}&lt;/td&gt;
&lt;td&gt;string&lt;/td&gt;
&lt;td&gt;user(json)&lt;/td&gt;
&lt;td&gt;1 d&lt;/td&gt;
&lt;td&gt;N&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;ç›´æ’­é—´ä¿¡æ¯&lt;/td&gt;
&lt;td&gt;I.room.{roomId}&lt;/td&gt;
&lt;td&gt;string&lt;/td&gt;
&lt;td&gt;room(json)&lt;/td&gt;
&lt;td&gt;1 d&lt;/td&gt;
&lt;td&gt;N&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;è·å–ç”¨æˆ·è™šæ‹Ÿèµ„äº§åˆ†å¸ƒå¼é”&lt;/td&gt;
&lt;td&gt;L.asset.{userId}.{tag}   &lt;!-- raw HTML omitted --&gt;(tag:assetType.String())&lt;/td&gt;
&lt;td&gt;string&lt;/td&gt;
&lt;td&gt;token&lt;/td&gt;
&lt;td&gt;60 s&lt;/td&gt;
&lt;td&gt;N&lt;/td&gt;
&lt;td&gt;APå‹é”ï¼ŒåŠ é”å•ä¸ªçº¿ç¨‹ä»dbä¸­è·å–æ•°æ®å†™å…¥ç¼“å­˜ï¼Œåˆå§‹åŒ–é€ç¤¼ç”¨æˆ·èµ„äº§ä¿¡æ¯ï¼Œé”çš„æ˜¯çƒ­æ›´æ–°èµ„æºï¼›å­˜åœ¨æ•°æ®å¤åˆ¶çš„å»¶è¿Ÿå¯èƒ½å¸¦æ¥çš„æ•°æ®å†™åè¯»ï¼ˆread-after-writeï¼‰ä¸ä¸€è‡´é—®é¢˜ï¼Œæ‰€ä»¥&lt;strong&gt;ä»followerè¯»å–æ•°æ®å¿…é¡»æ˜¯å¼ºä¸€è‡´æ€§è¯»(tidbæ”¯æŒ)/å…¨å±€ä¸€è‡´æ€§è¯»(polardb-xæ”¯æŒ)ï¼Œå¦åˆ™ä»leader/masterä¸Šè¯»å–&lt;/strong&gt;ï¼›&lt;!-- raw HTML omitted --&gt;è¿™é‡Œä½¿ç”¨redlockï¼Œå¦‚æœè¿è¡Œé”å¤±æ•ˆå¤šæ¬¡è¯»å†™å…¥ç¼“å­˜å¹‚ç­‰æ“ä½œ,ç«äº‰æ¡ä»¶æ˜¯å¯ä»¥æ¥å—ï¼Œç›´æ¥ç”¨å•é›†ç¾¤å®ä¾‹redlockå°±è¡Œï¼›å¦åˆ™éœ€è¦å¤šé›†ç¾¤redlockåŠ é”ï¼Œå…·ä½“è¯¦æƒ…ï¼š&lt;a href=&#34;https://redis.io/docs/manual/patterns/distributed-locks/&#34;&gt;distributed-locks&lt;/a&gt; PS: ç±»ä¼¼ä½¿ç”¨æ•°æ®åº“é”ä¹Ÿå¯ä»¥ä½¿ç”¨redlockç®—æ³•æ¥å®ç°åˆ†å¸ƒå¼å¯é åŠ é”;  é”çš„ç²’åº¦ï¼Œå¯ä»¥å…ˆåˆ†æ•£åˆ°æœ¬åœ°é”(éœ€è¦åŠ ç­‰å¾…è¶…æ—¶æ—¶é—´ï¼Œé˜²æ­¢å¤¯ä¸»æœåŠ¡ï¼Œè¶…æ—¶ä¸Šæ¸¸å¯ä»¥é‡è¯•)ï¼Œç„¶ååˆ†å¸ƒå¼é”åªæœ‰å•ä¸ªçº¿ç¨‹è·å–æ•°æ®å»è®¾ç½®ç¼“å­˜ï¼Œé™ä½åˆ†å¸ƒå¼é”çš„ç«äº‰ï¼Œæœ€å¤šéƒ¨ç½²è¿›ç¨‹å®ä¾‹æ•°ç›®ç«äº‰,é«˜å¹¶å‘åœºæ™¯ä¸‹å¾ˆå¤§å¹…åº¦å‡å°‘ç½‘ç»œIOã€‚ å¦‚ä¸‹åœºæ™¯ï¼š&lt;strong&gt;å¾ˆå¤šè§‚ä¼—ç»™çƒ­é—¨å¥³ä¸»æ’­é€ç¤¼ç‰©ï¼Œè¿™ä¸ªå¥³ä¸»æ’­åŒæ—¶ç»™çƒ­é—¨ç”·ä¸»æ’­é€ç¤¼ç‰©&lt;/strong&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;èµ„äº§å˜æ›´æ¶ˆæ¯&lt;/td&gt;
&lt;td&gt;M.asset.{userId}.{eventId}&lt;/td&gt;
&lt;td&gt;string&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;1 d&lt;/td&gt;
&lt;td&gt;N&lt;/td&gt;
&lt;td&gt;1. ä¿è¯å¹‚ç­‰ï¼šç±»ä¼¼Once done åŸå­æ“ä½œ(eventäº‹åŠ¡ç»´åº¦)ï¼› &lt;!-- raw HTML omitted --&gt;2.äº‹åŠ¡æ¶ˆæ¯å›è°ƒRCå¯è§(åŸå­æ“ä½œ)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;èµ„æºè¯„ä¼°ï¼šç”¨æŠ–éŸ³çœ‹ä¸‹å¡å¡”å°”ä¸–ç•Œæ¯ï¼Œæ”¯æŒä¸‹æ¢…è€æ¿çš„é˜¿æ ¹å»·ğŸ‡¦ğŸ‡·é˜Ÿç›´æ’­ï¼Œå»ä¼°ç®—ä¸‹å§ï½ï½&lt;/p&gt;
&lt;p&gt;å¹¶å‘åœºæ™¯ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;ç¼“å­˜ä»dbä¸­è·å–&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;é¢‘ç¹å¢/å‡ç”¨æˆ·è™šæ‹Ÿèµ„äº§ç¼“å­˜å­˜é‡æ•°æ®&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;çƒ­key:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;ç”¨æˆ·ç»´åº¦çš„ç”¨æˆ·è™šæ‹Ÿèµ„äº§ä¿¡æ¯ï¼Œé€šè¿‡userIdè¿›è¡Œåˆ†æ•£å³å¯ï¼Œ å¦‚æœå¤šç”¨æˆ·/ç§Ÿæˆ· å¯¹ å…±äº«ç¼“å­˜èµ„æºé¢‘ç¹æ“ä½œ(æ¯”å¦‚ ä¼˜æƒ å·/å•†å·)ï¼Œçªç ´äº†å•rediså®ä¾‹çš„è¯»å†™ç“¶é¢ˆï¼Œéœ€è¦å¯¹keyè¿›è¡Œå†æ¬¡åˆ‡åˆ†ï¼›å¦‚æœæ˜¯è¯»å¤šåœºæ™¯ï¼Œæ›´æ–°ä¸é¢‘ç¹ç¼“å­˜å¯ä»¥ç¼“å­˜åœ¨æœ¬åœ°æœåŠ¡è¿›ç¨‹ä¸­ï¼›&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;å¤§key:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;å­˜æ”¾çš„valueå€¼æ¯”è¾ƒå¤§ï¼Œä¸€èˆ¬æ˜¯list, setï¼Œzset, hashè¿™äº›é›†åˆç»“æ„ï¼Œå­˜å‚¨çš„item/fieldæ•°ç›®ä¸€èˆ¬åœ¨5000ä¸ªå·¦å³ï¼Œéœ€è¦æŒ‰æ¯”ä¾‹åˆ‡åˆ†ï¼Œè¯»æ”¾å¤§çš„é—®é¢˜å¯ä»¥å¹¶å‘æ§åˆ¶è¯»å–ï¼›&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;watch+äº‹åŠ¡ï¼ŒluaåŸå­æ“ä½œ demoä»£ç å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;script type=&#34;application/javascript&#34; src=&#34;https://gist.github.com/weedge/2b473c5baf0ac59d8d0c8b1ddc5692f5.js&#34;&gt;&lt;/script&gt;

&lt;script type=&#34;application/javascript&#34; src=&#34;https://gist.github.com/weedge/c2d830dceef4163acc6dd749a05493db.js&#34;&gt;&lt;/script&gt;

&lt;h4 id=&#34;æ¶ˆæ¯é˜Ÿåˆ—&#34;&gt;æ¶ˆæ¯é˜Ÿåˆ—&lt;/h4&gt;
&lt;h5 id=&#34;topic&#34;&gt;Topic&lt;/h5&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;åç§°&lt;/th&gt;
&lt;th&gt;è¯»/å†™é˜Ÿåˆ—æ•°&lt;/th&gt;
&lt;th&gt;æ¶ˆæ¯ç±»å‹&lt;/th&gt;
&lt;th&gt;æ¶ˆæ¯key&lt;/th&gt;
&lt;th&gt;æ¶ˆæ¯tag&lt;/th&gt;
&lt;th&gt;è¯´æ˜&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;TOPIC_ASSET_CHANGE_EVENT&lt;/td&gt;
&lt;td&gt;default: 8/8&lt;/td&gt;
&lt;td&gt;äº‹åŠ¡æ¶ˆæ¯&lt;/td&gt;
&lt;td&gt;eventId&lt;/td&gt;
&lt;td&gt;{eventType} ( || é—´éš”å¤šä¸ªtag)&lt;/td&gt;
&lt;td&gt;ç”¨æˆ·äº‹ä»¶èµ„äº§å˜æ›´&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;Tips:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;topic tag: é•¿åº¦ä¸èƒ½è¶…è¿‡ 127 (Byte.MAX_VALUE )ï¼›&lt;/li&gt;
&lt;li&gt;è¯»å†™é˜Ÿåˆ—æ•°ç”±æ¶ˆè´¹é›†ç¾¤å’Œç”Ÿäº§é›†ç¾¤ååé‡å†³å®šï¼Œå¼€å‘å¯ä»¥ä½¿ç”¨é»˜è®¤8/8ï¼›&lt;/li&gt;
&lt;li&gt;äº‹åŠ¡æ¶ˆæ¯ä¸æ”¯æŒæ‰¹é‡ç”Ÿäº§å’Œå»¶æ—¶ç”Ÿäº§ï¼Œå³ä½¿åœ¨ç”Ÿäº§ä¾§è®¾ç½®å»¶æ—¶å‘é€äº‹åŠ¡æ¶ˆæ¯ï¼Œrocketmq 4.7.0ä¹‹åçš„ä¸ä¼šç”Ÿæ•ˆï¼Œ&lt;a href=&#34;https://github.com/GenerousMan/rocketmq/commit/5a584d056a07350911954dd269bb1ee5c80dfd11&#34;&gt;commit&lt;/a&gt; ;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/apache/rocketmq/wiki/RIP-50-RocketMQ-Transaction-Message-Improvement&#34;&gt;RocketMQäº‹åŠ¡æ¶ˆæ¯æ”¹è¿›&lt;/a&gt; è¿™ä¸ªæ”¹è¿›ææ¡ˆæš‚æ—¶è¿˜æœªå‘å¸ƒï¼›&lt;/li&gt;
&lt;/ol&gt;
&lt;h5 id=&#34;message&#34;&gt;Message&lt;/h5&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;å­—æ®µ&lt;/th&gt;
&lt;th&gt;ç±»å‹&lt;/th&gt;
&lt;th&gt;è¯´æ˜&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;eventId&lt;/td&gt;
&lt;td&gt;string&lt;/td&gt;
&lt;td&gt;å˜æ›´äº‹ä»¶id&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;opUserId&lt;/td&gt;
&lt;td&gt;int64&lt;/td&gt;
&lt;td&gt;æ“ä½œè€…id&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;eventType&lt;/td&gt;
&lt;td&gt;string&lt;/td&gt;
&lt;td&gt;å˜æ›´äº‹ä»¶ç±»å‹ï¼ŒinteractGift&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;messageBody&lt;/td&gt;
&lt;td&gt;string&lt;/td&gt;
&lt;td&gt;æ¶ˆæ¯æ•°æ®ï¼Œæ›´å…·æ¶ˆæ¯äº‹ä»¶ç±»å‹å®šä¹‰ï¼Œæ ¼å¼å¯ä»¥ä¸ºjson ä»¥ä¾¿è·Ÿè¸ªæŸ¥çœ‹&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;producer GroupName/GroupID: P_GID_GIFT_ASSET_CHANGE&lt;/p&gt;
&lt;p&gt;consumer GroupName/GroupID: C_GID_GIFT_ASSET_CHANGE   5.0ç‰ˆæœ¬å°½é‡é‡‡ç”¨&lt;a href=&#34;https://mp.weixin.qq.com/s/UFWULymSblrs1hIGP5e7YQ&#34;&gt;POP consumeræ¨¡å¼&lt;/a&gt; , æ¯”å¦‚æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤åˆ‡æ¢æˆ&lt;code&gt;POP&lt;/code&gt;æ¨¡å¼ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;./mqadmin setConsumeMode -c DefaultCluster -t &lt;span class=&#34;nb&#34;&gt;test&lt;/span&gt; -g testGroup -m POP -n namesrv:9876
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;æ¶ˆæ¯å¤§å°ä¸èƒ½è¶…è¿‡4M, å¯å‚è€ƒ &lt;a href=&#34;https://help.aliyun.com/document_detail/440347.html&#34;&gt;5.0ç‰ˆé™åˆ¶&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;æ¶ˆæ¯é‡è¯•é»˜è®¤16æ¬¡, è®¾ç½®é‡è¯•å»¶è¿Ÿçº§åˆ«(level)ï¼Œè®¾ç½®çš„å»¶è¿Ÿçº§åˆ«ä¸‹æ ‡(level-1)å¦‚ä¸‹å»¶è¿Ÿæ•°ç»„&lt;code&gt;delayLevelArray&lt;/code&gt;ï¼š&lt;/p&gt;
&lt;p&gt;&lt;code&gt;[1s, 5s, 10s, 30s, 1m, 2m, 3m, 4m, 5m, 6m, 7m, 8m, 9m, 10m, 20m, 30m, 1h, 2h]&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;å¦‚æœä¸åœ¨æŒ‡å®šå»¶è¿Ÿçº§åˆ«å†…ï¼Œä½¿ç”¨é»˜è®¤ &lt;code&gt;delayLevelArray[2:]&lt;/code&gt;å»¶è¿Ÿæ•°ç»„ä¾æ¬¡é‡è¯•16æ¬¡ï¼›&lt;/p&gt;
&lt;h5 id=&#34;æ¶ˆè´¹ä¾§éœ€è¦å…³æ³¨çš„å‚æ•°&#34;&gt;æ¶ˆè´¹ä¾§éœ€è¦å…³æ³¨çš„å‚æ•°&lt;/h5&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;åç§°&lt;/th&gt;
&lt;th&gt;é»˜è®¤&lt;/th&gt;
&lt;th&gt;è¯´æ˜&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;pullBatchSize&lt;/td&gt;
&lt;td&gt;32&lt;/td&gt;
&lt;td&gt;æ¯æ¬¡å‘èµ·pullè¯·æ±‚åˆ°brokerï¼Œå®¢æˆ·ç«¯éœ€è¦æŒ‡å®šä¸€ä¸ªæœ€å¤§batch sizeï¼Œè¡¨ç¤ºè¿™ä¸€æ¬¡æ‹‰å–æ¶ˆæ¯æœ€å¤šæ‰¹é‡æ‹‰å–å¤šå°‘æ¡ï¼›èŒƒå›´åœ¨ [1,1024]; ä¸ºäº†æé«˜ååï¼Œä¸€èˆ¬éƒ½å¤§äº1&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;consumeMessageBatchMaxSize&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;æ‰¹é‡æ¶ˆè´¹çš„æœ€å¤§æ¶ˆæ¯æ¡æ•°ï¼›èŒƒå›´åœ¨ [1,1024]ï¼›å¦‚æœæ¶ˆè´¹é€»è¾‘æ”¯æŒæ‰¹é‡å¤„ç†ï¼Œå¯ä»¥è®¾ç½®å€¼å¤§äº1ï¼› å¤„ç†ä¸šåŠ¡é€»è¾‘çš„æ‰¹é‡msgsçš„æœ€å¤§å¤§å°æ˜¯consumeMessageBatchMaxSizeå’ŒpullBatchSizeçš„è¾ƒå°å€¼ã€‚&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;maxReconsumeTimes&lt;/td&gt;
&lt;td&gt;-1&lt;/td&gt;
&lt;td&gt;-1 é»˜è®¤16æ¬¡é‡è¯•ï¼›0æˆ–è€…å°äº-1 ä¸é‡è¯•ï¼›å¤§äº0ï¼Œåˆ™ä¸ºè®¾ç½®çš„é‡è¯•æ¬¡æ•°&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;æ¶ˆè´¹ä¾§ä»broker pull messageæµç¨‹ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-fallback&#34; data-lang=&#34;fallback&#34;&gt;NewPushConsumer -&amp;gt; GetOrNewRocketMQClient -&amp;gt; GetOrNewRocketMQClient-&amp;gt; æ³¨å†ŒRegisterRequestFunc  ReqResetConsumerOffsetäº‹ä»¶çš„å›è°ƒfunc -&amp;gt; è§¦å‘ resetOffset -&amp;gt; ResetOffset-&amp;gt; resume -&amp;gt; doBalance -&amp;gt; updateProcessQueueTableå†™å…¥æ‹‰å»è¯·æ±‚åˆ°prCHä¸­

Start -&amp;gt; RegisterConsumer -&amp;gt; start
å¼‚æ­¥ select è½®è®­ä»prChä¸­è·å–æ‹‰å»è¯·æ±‚pr -&amp;gt; å¼‚æ­¥ pullMessage(pr)-&amp;gt;
	å¼‚æ­¥ select è½®è®­å¤„ç†prä¸­çš„å¤„ç†é˜Ÿåˆ—å’Œæ¶ˆæ¯é˜Ÿåˆ— submitToConsume(pr.pq, pr.mq) (ä¸€ä¸ªæ˜¯é¡ºåºorderlyå¤„ç†ï¼Œä¸€ä¸ªæ˜¯æ™®é€šcurrentlyå¤„ç†)
	
	-&amp;gt;pq.putMessage(msgs)ä»brokerä¸­è¯·æ±‚çš„æ¶ˆæ¯æ”¾å…¥å¤„ç†é˜Ÿåˆ—ä¸­çš„msgChä¸­
	
	-&amp;gt;æ™®é€šå¤„ç†consumeMessageCurrently() -&amp;gt; pq.getMessages ä»å¤„ç†é˜Ÿåˆ—ä¸­çš„msgChä¸­è·å–æ¶ˆæ¯-&amp;gt; 
		æ‹‰å–åˆ°çš„ä¸€æ‰¹æ¶ˆæ¯ä¼šæ‹†åˆ†æˆNï¼ˆå–å†³äºconsumeMessageBatchMaxSizeï¼‰ä¸ªå°æ‰¹æ¶ˆæ¯subMsgs -&amp;gt; 
		å¼‚æ­¥ consumeInner(ctx,subMsgs) -&amp;gt; è°ƒç”¨ä¸šåŠ¡å®šä¹‰çš„å›è°ƒä¸šåŠ¡å‡½æ•°callback.f(ctx, subMsgs...)-&amp;gt;
	å¤„ç†å®Œæˆè¿”å›å“åº”
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;å¯¹äºæ™®é€šæ¶ˆæ¯çš„å¤„ç†ï¼Œå¯ä»¥çœ‹å‡ºæ‰¹é‡æ‹‰å»æ‹†åˆ†æˆN(PullBatchSize/min(ConsumeMessageBatchMaxSize,PullBatchSize))ä¸ªæ‰¹é‡msgs, æ¯æ¬¡è·å–æ‰¹é‡msgså¤„ç†éƒ½æ˜¯å¹¶å‘çš„ï¼Œä¸ä¼šç›¸äº’ç­‰å¾…ï¼›æ‹‰å®Œä¸€æ‰¹è§¦å‘åç§»äº‹ä»¶ç»§ç»­æ‹‰å»ä¸‹ä¸€æ‰¹åˆ°æœ¬åœ°pré˜Ÿåˆ—ä¸­ï¼Œç›´åˆ°brokeré˜Ÿåˆ—ä¸­æ²¡æœ‰å¯æ¶ˆè´¹çš„æ•°æ®ï¼›é‡è¯•æœ‰å¯¹åº”topicé‡è¯•é˜Ÿåˆ—ä¸ä¼šé˜»å¡å½“å‰topicé˜Ÿåˆ—çš„æ­£å¸¸æ¶ˆè´¹ï¼›&lt;/p&gt;
&lt;p&gt;å…¶ä»–å‚è€ƒï¼š&lt;a href=&#34;https://zhuanlan.zhihu.com/p/27397055&#34;&gt;å®¢æˆ·ç«¯é…ç½®è¯¦è§£&lt;/a&gt;&lt;/p&gt;
&lt;h5 id=&#34;rocketmq-é‡è¯•-æ­»ä¿¡-ç³»ç»Ÿ-topic&#34;&gt;RocketMQ é‡è¯•, æ­»ä¿¡, ç³»ç»Ÿ Topic&lt;/h5&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;åç§°&lt;/th&gt;
&lt;th&gt;è¯´æ˜&lt;/th&gt;
&lt;th&gt;&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;%RETRY%C_GID_GIFT_ASSET_CHANGE&lt;/td&gt;
&lt;td&gt;å¯¹åº”æ¶ˆè´¹ç»„é‡è¯•topicï¼Œé‡è¯•æ¬¡æ•°é»˜è®¤16æ¬¡&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;%DLQ%C_GID_GIFT_ASSET_CHANGE&lt;/td&gt;
&lt;td&gt;å¯¹åº”æ¶ˆè´¹ç»„æ­»ä¿¡é˜Ÿåˆ—topic, è¶…è¿‡é‡è¯•æ¬¡æ•°æ”¾å…¥è¯¥é˜Ÿåˆ—ä¸­&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;SCHEDULE_TOPIC_XXXX&lt;/td&gt;
&lt;td&gt;å»¶è¿Ÿæ¶ˆæ¯é˜Ÿåˆ—topic&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;em&gt;TBW102&lt;/em&gt;&lt;/td&gt;
&lt;td&gt;é»˜è®¤ç”¨äºåˆ›å»ºä¸å­˜åœ¨topicæ—¶ä½¿ç”¨è¿™ä¸ªé»˜è®¤topicæ¥åˆ›å»º&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;RMQ_SYS_TRACE_TOPIC&lt;/td&gt;
&lt;td&gt;å¼€å¯æ¶ˆæ¯è·Ÿè¸ªçš„topic ç”¨äºæ¶ˆæ¯è½¨è¿¹&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;RMQ_SYS_TRANS_HALF_TOPIC&lt;/td&gt;
&lt;td&gt;è®°å½•æ‰€æœ‰çš„åŠäº‹åŠ¡æ¶ˆæ¯ï¼Œæ¶ˆè´¹ç«¯ä¸å¯è§&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;RMQ_SYS_TRANS_OP_HALF_TOPIC&lt;/td&gt;
&lt;td&gt;è®°å½•å·²ç»COMMITæˆ–ROLLBACKçš„åŠäº‹åŠ¡æ¶ˆæ¯ï¼Œtagsæ˜¯&amp;quot;d&amp;quot; é€»è¾‘åˆ é™¤&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;TRANS_CHECK_MAX_TIME_TOPIC&lt;/td&gt;
&lt;td&gt;æœªçŸ¥çŠ¶æ€çš„äº‹åŠ¡æ¶ˆæ¯è¶…è¿‡æœ€å¤§å›æŸ¥æ¬¡æ•°ï¼Œé»˜è®¤15æ¬¡ï¼Œä¼šå­˜åœ¨è¿™ä¸ªé˜Ÿåˆ—&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;å…·ä½“ç”Ÿäº§ï¼Œæ¶ˆè´¹ç”¨æˆ·èµ„äº§äº‹åŠ¡æ¶ˆæ¯demoå¦‚ä¸‹: (demoä¸­ä½¿ç”¨ &lt;a href=&#34;https://github.com/apache/rocketmq-client-go&#34;&gt;rocketmq-client-go&lt;/a&gt; &lt;strong&gt;å®¢æˆ·ç«¯ç”Ÿäº§æ¶ˆè´¹é…ç½®äº† traceï¼Œrocketmq brokerä¹Ÿéœ€è¦é…ç½®traceTopicEnable=trueï¼Œç”¨äºæŸ¥çœ‹æ¶ˆæ¯è½¨è¿¹&lt;/strong&gt;ï¼›é™¤æ­¤ä¹‹å¤–ï¼Œå¯ä»¥åœ¨æ¶ˆæ¯å±æ€§ä¸­åŠ ä¸Šå…¨é“¾è·¯è¿½è¸ªçš„traceIdï¼Œç”¨äºæ•´ä½“ç³»ç»ŸæœåŠ¡è¿›è¡Œä¸²è”ï¼Œå¦‚æœæƒ³æŠŠrocketmqå®¢æˆ·ç«¯ç”Ÿäº§å’Œæ¶ˆè´¹åŠ å…¥OTELè¿›è¡Œå…¨é“¾è·¯è¿½è¸ª, å¯ä»¥å‚è€ƒ &lt;strong&gt;&lt;a href=&#34;https://github.com/open-telemetry/opentelemetry-go-contrib/tree/main/instrumentation/github.com/Shopify/sarama/otelsarama&#34;&gt;kafka-otel-sarama&lt;/a&gt;&lt;/strong&gt; å®ç°ä¸éš¾)&lt;/p&gt;
&lt;script type=&#34;application/javascript&#34; src=&#34;https://gist.github.com/weedge/fcbc8e4a2889c6230d62f6f35de6862d.js&#34;&gt;&lt;/script&gt;

&lt;script type=&#34;application/javascript&#34; src=&#34;https://gist.github.com/weedge/37839a2fcb3c11f77228ce43a713dee7.js&#34;&gt;&lt;/script&gt;

&lt;h4 id=&#34;api&#34;&gt;API&lt;/h4&gt;
&lt;p&gt;å‰å°ç»Ÿä¸€å…¥å£æ¥å£å‚æ•°å®‰å…¨éªŒè¯&lt;/p&gt;
&lt;p&gt;æ¥å£å…¬å…±å“åº” BaseResp&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;å­—æ®µ&lt;/th&gt;
&lt;th&gt;ç±»å‹&lt;/th&gt;
&lt;th&gt;è¯´æ˜&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;errCode&lt;/td&gt;
&lt;td&gt;int&lt;/td&gt;
&lt;td&gt;é”™è¯¯ç ï¼Œ0ä»£è¡¨æˆåŠŸï¼Œé0é”™è¯¯&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;errMsg&lt;/td&gt;
&lt;td&gt;string&lt;/td&gt;
&lt;td&gt;é”™è¯¯ä¿¡æ¯&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;extra&lt;/td&gt;
&lt;td&gt;Map&amp;lt;string,string&amp;gt;&lt;/td&gt;
&lt;td&gt;é¢å¤–ä¿¡æ¯&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;errCodeåˆ†é…ï¼š&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;æœåŠ¡&lt;/th&gt;
&lt;th&gt;åˆ†é…èŒƒå›´&lt;/th&gt;
&lt;th&gt;è¯´æ˜&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;äº’åŠ¨&lt;/td&gt;
&lt;td&gt;[10000,20000)&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;æ”¯ä»˜&lt;/td&gt;
&lt;td&gt;[20000,30000)&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;æ¶ˆæ¯&lt;/td&gt;
&lt;td&gt;[30000,40000)&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;äº’åŠ¨ä¸­å°ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;èµ é€ç¤¼ç‰©æ¥å£&lt;/li&gt;
&lt;li&gt;è·å–ç›´æ’­é—´ç¤¼ç‰©åˆ—è¡¨æ¥å£&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;æ”¯ä»˜ä¸­å°ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;å˜æ›´ç”¨æˆ·è™šæ‹Ÿèµ„äº§æ¥å£&lt;/strong&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;BizAssetChangesReq è¯·æ±‚ï¼š(æ‰¹é‡å¹¶å‘æ§åˆ¶ç»Ÿä¸€æ”¶æ•›è‡³æ”¯ä»˜ä¸­å°ï¼Œè°ƒç”¨æ–¹æ— é¡»å¹¶å‘è·å–)&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th style=&#34;text-align:left&#34;&gt;å­—æ®µ&lt;/th&gt;
&lt;th&gt;ç±»å‹&lt;/th&gt;
&lt;th&gt;è¯´æ˜&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td style=&#34;text-align:left&#34;&gt;bizAssetChanges&lt;/td&gt;
&lt;td&gt;list&amp;lt;\BizEventAssetChange/&amp;gt;&lt;/td&gt;
&lt;td&gt;ä¸šåŠ¡èµ„äº§å˜æ›´åˆ—è¡¨&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;BizEventAssetChange&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;å­—æ®µ&lt;/th&gt;
&lt;th&gt;ç±»å‹&lt;/th&gt;
&lt;th&gt;è¯´æ˜&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;eventId&lt;/td&gt;
&lt;td&gt;string&lt;/td&gt;
&lt;td&gt;æ“ä½œäº‹ä»¶id&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;opUserId&lt;/td&gt;
&lt;td&gt;int64&lt;/td&gt;
&lt;td&gt;æ“ä½œè€…id&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;eventType&lt;/td&gt;
&lt;td&gt;string&lt;/td&gt;
&lt;td&gt;äº‹ä»¶ç±»å‹: interactGift,  orderApple, orderWX, orderAlipay, orderDouyin&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;bizId&lt;/td&gt;
&lt;td&gt;int64&lt;/td&gt;
&lt;td&gt;ä¸šåŠ¡åœºæ™¯id: ç›´æ’­(roomId), å……å€¼(orderId)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;bizType&lt;/td&gt;
&lt;td&gt;int&lt;/td&gt;
&lt;td&gt;ä¸šåŠ¡ç±»å‹ 1.ç›´æ’­ï¼Œ2.å……å€¼&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;objId&lt;/td&gt;
&lt;td&gt;string&lt;/td&gt;
&lt;td&gt;æ“ä½œå¯¹è±¡id, giftId, transactionId/outOrderNo&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;opUserAssetChange&lt;/td&gt;
&lt;td&gt;UserAssetChangeInfo&lt;/td&gt;
&lt;td&gt;æ“ä½œç”¨æˆ·èµ„äº§å˜æ›´&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;toUserAssetChange&lt;/td&gt;
&lt;td&gt;UserAssetChangeInfo&lt;/td&gt;
&lt;td&gt;å¯¹æ–¹ç”¨æˆ·èµ„äº§å˜æ›´&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;UserAssetChangeInfo&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;å­—æ®µ&lt;/th&gt;
&lt;th&gt;ç±»å‹&lt;/th&gt;
&lt;th&gt;è¯´æ˜&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;userId&lt;/td&gt;
&lt;td&gt;int64&lt;/td&gt;
&lt;td&gt;ç”¨æˆ·id&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;assetType&lt;/td&gt;
&lt;td&gt;int&lt;/td&gt;
&lt;td&gt;èµ„äº§ç±»å‹&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;incr&lt;/td&gt;
&lt;td&gt;int&lt;/td&gt;
&lt;td&gt;+å¢åŠ /-å‡å°‘å¤šå°‘èµ„äº§&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;BizAssetChangesResp å“åº”&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;å­—æ®µ&lt;/th&gt;
&lt;th&gt;ç±»å‹&lt;/th&gt;
&lt;th&gt;è¯´æ˜&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;bizAssetChangeResList&lt;/td&gt;
&lt;td&gt;list&amp;lt;\BizEventAssetChangerRes/&amp;gt;&lt;/td&gt;
&lt;td&gt;èµ„äº§å˜æ›´ç»“æœåˆ—è¡¨&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;baseResp&lt;/td&gt;
&lt;td&gt;BaseResp&lt;/td&gt;
&lt;td&gt;å…¬å…±å“åº”ä¿¡æ¯&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;BizEventAssetChangerRes&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;å­—æ®µ&lt;/th&gt;
&lt;th&gt;ç±»å‹&lt;/th&gt;
&lt;th&gt;è¯´æ˜&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;eventId&lt;/td&gt;
&lt;td&gt;string&lt;/td&gt;
&lt;td&gt;æ“ä½œäº‹ä»¶id&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;opUserAsset&lt;/td&gt;
&lt;td&gt;UserAsset&lt;/td&gt;
&lt;td&gt;æ“ä½œè€…çš„ç”¨æˆ·èµ„äº§&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;changeRes&lt;/td&gt;
&lt;td&gt;bool&lt;/td&gt;
&lt;td&gt;1 æˆåŠŸï¼Œ 0 å¤±è´¥&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;failMsg&lt;/td&gt;
&lt;td&gt;string&lt;/td&gt;
&lt;td&gt;å¤±è´¥ä¿¡æ¯&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;UserAsset&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;å­—æ®µ&lt;/th&gt;
&lt;th&gt;ç±»å‹&lt;/th&gt;
&lt;th&gt;è¯´æ˜&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;userId&lt;/td&gt;
&lt;td&gt;int64&lt;/td&gt;
&lt;td&gt;ç”¨æˆ·id&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;assetType&lt;/td&gt;
&lt;td&gt;int&lt;/td&gt;
&lt;td&gt;èµ„äº§ç±»å‹&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;assetCn&lt;/td&gt;
&lt;td&gt;int&lt;/td&gt;
&lt;td&gt;èµ„äº§æ•°&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;ol start=&#34;2&#34;&gt;
&lt;li&gt;
&lt;p&gt;è·å–ç”¨æˆ·è™šæ‹Ÿèµ„äº§æ¥å£&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;è·å–ç”¨æˆ·èµ„äº§å˜æ›´æµæ°´æ¥å£&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;æ›´æ–°æ•°æ®åº“ä¸­çš„ç”¨æˆ·èµ„äº§ æ¶ˆè´¹é€»è¾‘&lt;/strong&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;æ¶ˆæ¯æœåŠ¡ï¼š &lt;a href=&#34;https://weedge.github.io/post/jxzbim/&#34;&gt;https://weedge.github.io/post/jxzbim/&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&#34;å¼€å‘&#34;&gt;å¼€å‘&lt;/h3&gt;
&lt;p&gt;å€ŸåŠ©å¼€æºå·¥å…·ï¼Œä»0åˆ°1å¼€å§‹æ­å»ºè“å›¾ï¼Œ&amp;gt;1ç”±ä¸šåŠ¡é©±åŠ¨å®å›¾&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;æ­å»ºæœ¬åœ°åŸºç¡€ç¯å¢ƒï¼Œtidb/polardb-x, redis, rocketmq 1d&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;&lt;span class=&#34;c1&#34;&gt;#just for mac os local brew install&lt;/span&gt;
brew install redis
brew install mysql
&lt;span class=&#34;c1&#34;&gt;#list services to view is ok &lt;/span&gt;
brew services list
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-yaml&#34; data-lang=&#34;yaml&#34;&gt;&lt;span class=&#34;c&#34;&gt;#redis-cluster-single-docker-compose.yaml&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;c&#34;&gt;#https://github.com/bitnami/bitnami-docker-redis-cluster/issues/3&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;version&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;3&amp;#34;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;single-redis-cluster&amp;#34;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;services&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;redis-cluster&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;image&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;grokzen/redis-cluster:latest&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;ports&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;- &lt;span class=&#34;s2&#34;&gt;&amp;#34;26379-26384:26379-26384&amp;#34;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;environment&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;- &lt;span class=&#34;s2&#34;&gt;&amp;#34;INITIAL_PORT=26379&amp;#34;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;- &lt;span class=&#34;s2&#34;&gt;&amp;#34;MASTERS=3&amp;#34;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;- &lt;span class=&#34;s2&#34;&gt;&amp;#34;SLAVES_PER_MASTER=1&amp;#34;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;- &lt;span class=&#34;s2&#34;&gt;&amp;#34;SENTINEL=false&amp;#34;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;- &lt;span class=&#34;s2&#34;&gt;&amp;#34;REDIS_CLUSTER_IP=0.0.0.0&amp;#34;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;- &lt;span class=&#34;s2&#34;&gt;&amp;#34;IP=0.0.0.0&amp;#34;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;- &lt;span class=&#34;s2&#34;&gt;&amp;#34;BIND_ADDRESS=0.0.0.0&amp;#34;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;&lt;span class=&#34;c1&#34;&gt;# redis-cluster docker local deploy&lt;/span&gt;
docker-compose -f redis-cluster-single-docker-compose.yaml up -d
&lt;span class=&#34;c1&#34;&gt;# check cluster state is ok &lt;/span&gt;
redis-cli -c -p &lt;span class=&#34;m&#34;&gt;26379&lt;/span&gt; cluster info

&lt;span class=&#34;c1&#34;&gt;# rocketmq docker local deploy    &lt;/span&gt;
&lt;span class=&#34;c1&#34;&gt;# https://github.com/apache/rocketmq-docker&lt;/span&gt;
git clone https://github.com/apache/rocketmq-docker.git
&lt;span class=&#34;nb&#34;&gt;cd&lt;/span&gt; image-build
sh build-image.sh 5.0.0 alpine
&lt;span class=&#34;nb&#34;&gt;cd&lt;/span&gt; ..
sh stage.sh 5.0.0
&lt;span class=&#34;nb&#34;&gt;cd&lt;/span&gt; stages/5.0.0
&lt;span class=&#34;c1&#34;&gt;# change data/broker/conf/broker.conf add brokerIP1={localIp}, add traceTopicEnable=true&lt;/span&gt;
&lt;span class=&#34;c1&#34;&gt;# docker run -d -v `pwd`/data/broker/logs:/home/rocketmq/logs -v `pwd`/data/broker/store:/home/rocketmq/store -v `pwd`/data/broker/conf/broker.conf:/opt/rocketmq-5.0.0/conf/broker.conf --name rmqbroker --link rmqnamesrv:namesrv -e &amp;#34;NAMESRV_ADDR=namesrv:9876&amp;#34; -p 10909:10909 -p 10911:10911 -p 10912:10912 apache/rocketmq:5.0.0${TAG_SUFFIX} sh mqbroker -c /opt/rocketmq-5.0.0/conf/broker.conf&lt;/span&gt;
&lt;span class=&#34;c1&#34;&gt;# run simple single node docker&lt;/span&gt;
./play-docker.sh alpine

&lt;span class=&#34;c1&#34;&gt;# rocketmq dashboard local deploy&lt;/span&gt;
docker pull apacherocketmq/rocketmq-dashboard:latest
docker run -d --name rocketmq-dashboard -e &lt;span class=&#34;s2&#34;&gt;&amp;#34;JAVA_OPTS=-Drocketmq.namesrv.addr={localIp}:9876&amp;#34;&lt;/span&gt; -p 8181:8080 -t apacherocketmq/rocketmq-dashboard:latest
&lt;span class=&#34;c1&#34;&gt;# view http://127.0.0.1:8181/&lt;/span&gt;

&lt;span class=&#34;c1&#34;&gt;#tidb local deploy&lt;/span&gt;
&lt;span class=&#34;c1&#34;&gt;# notice:&lt;/span&gt;
&lt;span class=&#34;c1&#34;&gt;# docker is not support&lt;/span&gt;
&lt;span class=&#34;c1&#34;&gt;# u should use deploy local tidb by tiup tool&lt;/span&gt;
&lt;span class=&#34;c1&#34;&gt;# see this https://docs.pingcap.com/tidb/dev/quick-start-with-tidb&lt;/span&gt;
tiup playground

&lt;span class=&#34;c1&#34;&gt;#polardb-x docker local deploy by pxd tool&lt;/span&gt;
&lt;span class=&#34;c1&#34;&gt;#see this &lt;/span&gt;

pxd tryout
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;æµ‹è¯•demo, redis clusteré›†ç¾¤ä¸‹çš„ç¼“å­˜äº‹åŠ¡å’Œ tidbåˆ†å¸ƒå¼ç¼“å­˜äº‹åŠ¡ï¼Œrocketmq åˆ†å¸ƒå¼æ¶ˆæ¯äº‹åŠ¡ï¼›&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;æ ¸å¿ƒæœåŠ¡æ¨¡å—å¼€å‘æ”¯ä»˜ä¸­å°æ¥å£&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;ç¼–å†™makefile, dockerfile, æ‰“åŒ…æˆdockeré•œåƒï¼Œ æ•´ä½“è§£å†³æ–¹æ¡ˆä¾èµ–ç»„ä»¶ä¹Ÿå¯ä»¥é€šè¿‡docker-composeéƒ¨ç½²è‡³dockerå®¹å™¨ä¸­&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;ç¼–å†™ç›¸å…³k8sèµ„æº (configmap,secret,deployment+service,ingress)é€šè¿‡minikube/kind éƒ¨ç½²è‡³æœ¬åœ°k8sé›†ç¾¤&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;å°†æœåŠ¡ç½‘æ ¼åŒ–istio(xdsæµæ§, å¯ç”¨äºå…¨é“¾è·¯ç›‘æ§, A/Bæµ‹è¯•ï¼Œç‰¹åˆ«æ˜¯äº§å“æ–°ç‰¹æ€§/æ¨¡å‹ç­–ç•¥åœºæ™¯)  (like this: &lt;a href=&#34;https://mp.weixin.qq.com/s/SAn-H5p53IfvSy_Y3Mcz_Q&#34;&gt;https://mp.weixin.qq.com/s/SAn-H5p53IfvSy_Y3Mcz_Q&lt;/a&gt;)&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;k8s/istio operator&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;å¼€æºå¼€å‘æ¡†æ¶å’Œç»„ä»¶é€‰æ‹©(åœ¨æ ‡å‡†åŒ–ï¼Œè§„èŒƒæ¨¡å—åŒ–çš„å‰æä¸‹ï¼Œå°½é‡è‡ªåŠ¨åŒ–ï¼Œæé«˜ç ”å‘æ•ˆèƒ½ï¼Œfocus on æ ¸å¿ƒä¸šåŠ¡é€»è¾‘)&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;å¼€å‘è¯­è¨€ï¼šgolang + lua5.1(&lt;a href=&#34;https://redis.io/docs/manual/programmability/lua-debugging/&#34;&gt;redis lua debugging&lt;/a&gt;) + shell&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;å¼€å‘æ¡†æ¶ï¼š&lt;a href=&#34;https://www.cloudwego.io/zh/docs/kitex/overview/&#34;&gt;kitex&lt;/a&gt;(ç»Ÿä¸€è§„èŒƒåŒ–äº†RPCæ¡†æ¶ï¼Œæ”¯æŒgRPCå’Œthriftçš„è„šæ‰‹æ¶ï¼Œå¸¸æ”¯æŒå†…éƒ¨å¾®æœåŠ¡ï¼Œæ³›åŒ–è°ƒç”¨+ proxyless xdsæµæ§, å‚è€ƒ&lt;a href=&#34;https://mp.weixin.qq.com/s/G8vmlJyaimux_K-548kFbA&#34;&gt;brpc&lt;/a&gt;) + &lt;a href=&#34;https://www.cloudwego.io/zh/docs/hertz/overview/&#34;&gt;hertz&lt;/a&gt;(httpåè®®æ¡†æ¶ï¼Œå¸¸æ”¯æŒå¤–éƒ¨ä¸šåŠ¡å‰/åå°, æ•°æ®æ¸²æŸ“,è¯·æ±‚æ ¡éªŒ)&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;DBï¼šmysql, é«˜å¯ç”¨é›†ç¾¤æ–¹æ¡ˆï¼šä¸æ¨èè‡ªå»ºsharding+proxyçš„æ–¹å¼ï¼›æ¨èä½¿ç”¨æ”¯æŒmysqlåè®®çš„åˆ†å¸ƒå¼æ•°æ®åº“ï¼Œä¸”æ— éœ€åœ¨ä¸šåŠ¡ä»£ç ä¸­è€ƒè™‘åˆ†åº“åˆ†è¡¨æ“ä½œï¼Œä»¥åŠåˆ†åº“åˆ†è¡¨çš„åˆ†å¸ƒå¼äº‹åŠ¡ï¼›æ¯”å¦‚ï¼šå¼€æºæ–¹æ¡ˆ &lt;a href=&#34;https://docs.pingcap.com/zh/&#34;&gt;tidb&lt;/a&gt;(shared nothing,scale out)ï¼Œäº‘å‚å•†ï¼š&lt;a href=&#34;https://polardbx.com/document&#34;&gt;polardb-x&lt;/a&gt; (shared nothing, scale out)/&lt;a href=&#34;https://docs.aws.amazon.com/zh_cn/AmazonRDS/latest/AuroraUserGuide/Aurora.AuroraMySQL.html&#34;&gt;aurora mysql&lt;/a&gt; (shared disk, scale up, auroraç›¸å…³è§£è¯»å¯ä»¥çœ‹ä¸‹&lt;a href=&#34;youtube.com/watch?v=jJSh54J1s5o&#34;&gt;mit 6.824 Cloud Replicated DB, Aurora&lt;/a&gt;),   &lt;a href=&#34;https://gorm.io/&#34;&gt;gorm&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Tips: å¯¹åº”åˆ†å¸ƒå¼äº‹åŠ¡æ“ä½œtidbæœ‰æ‰€ä¸åŒï¼Œtidbå’ŒåŸç”Ÿçš„mysql innodbå¼•æ“äº‹åŠ¡æ“ä½œsqlè¯­å¥æœ‰äº›åŒºåˆ«: &lt;a href=&#34;https://docs.pingcap.com/zh/tidb/dev/transaction-overview&#34;&gt;tidb transaction&lt;/a&gt;, &lt;a href=&#34;https://docs.pingcap.com/zh/tidb/dev/dev-guide-sample-application-golang&#34;&gt;tidb-gorm-sample&lt;/a&gt;ï¼›&lt;a href=&#34;https://doc.polardbx.com/features/topics/distributed-transaction.html&#34;&gt;polardb-x åˆ†å¸ƒå¼äº‹åŠ¡&lt;/a&gt; å’Œ aurora åˆ™åŸç”Ÿæ”¯æŒäº‹åŠ¡æ“ä½œsqlè¯­å¥;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Cache:  redis, é«˜å¯ç”¨é›†ç¾¤æ–¹æ¡ˆ å¼€æºæ–¹æ¡ˆ&lt;a href=&#34;https://redis.io/docs/management/scaling/&#34;&gt;redis-cluster&lt;/a&gt;, &lt;a href=&#34;https://github.com/RedisLabs/redis-cluster-proxy&#34;&gt;redis-cluster-proxy&lt;/a&gt;ï¼›äº‘å‚å•†proxyä»£ç†æ–¹å¼ï¼š&lt;a href=&#34;https://help.aliyun.com/document_detail/52228.html&#34;&gt;é˜¿é‡Œäº‘redis&lt;/a&gt;,  æˆ–è€…æ”¯æŒredis clusteråè®® åº•å±‚åˆ©ç”¨rocksdb/leveldb ä½œä¸ºkvå­˜å‚¨å¼•æ“çš„å¼€æºæ–¹æ¡ˆï¼Œæ¯”å¦‚&lt;a href=&#34;https://github.com/apache/incubator-kvrocks&#34;&gt;kvrocks&lt;/a&gt;(watchå‘½ä»¤æš‚æœªæ”¯æŒï¼Œå¯ä»¥ä½¿ç”¨luaè„šæœ¬å‘½ä»¤),  &lt;a href=&#34;https://redis.uptrace.dev/guide/&#34;&gt;go-redis&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;MQ: rocketMQ, &lt;a href=&#34;https://github.com/apache/rocketmq-client-go&#34;&gt;rocketmq-client-go&lt;/a&gt;,  å¦‚æœä½¿ç”¨é˜¿é‡Œäº‘rocketMQä½¿ç”¨å¯¹åº”&lt;a href=&#34;https://github.com/apache/rocketmq-clients/tree/master/golang&#34;&gt;client SDK&lt;/a&gt; (producerå·²æ”¯æŒå…¨éƒ¨æ¶ˆæ¯ç±»å‹)&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;æœåŠ¡ç¼–æ’æµé‡æ²»ç†ï¼š&lt;a href=&#34;https://kubernetes.io/zh-cn/docs/home/&#34;&gt;k8s&lt;/a&gt; + &lt;a href=&#34;https://istio.io/latest/docs/&#34;&gt;istio&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;tips: åœ¨æœ¬åœ°å¼€å‘ï¼Œå¯ä»¥é€šè¿‡docker compose æœ¬åœ°éƒ¨ç½²ï¼› è¿˜å¯ä»¥é€šè¿‡docker+minikube/kind+helm æ¥éƒ¨ç½²æœ¬åœ°èŠ‚ç‚¹çš„å¤špodé›†ç¾¤ç‰ˆæœ¬æ•°æ®åº“(mysql/tidb/polardb-x)ï¼Œredis-clusterï¼Œä»¥åŠé›†ç¾¤ç‰ˆrocketMQï¼›ä»¥åŠå¼€å‘å®Œä¸šåŠ¡æœåŠ¡åº”ç”¨åï¼Œä¹Ÿå¯ä»¥éƒ¨ç½²åœ¨æœ¬åœ°podçš„å®¹å™¨ä¸­, ä»¥ä¾¿åç»­CI/CDè‡ªåŠ¨åŒ–é›†æˆéƒ¨ç½²è‡³å¤šäº‘å®¹å™¨æœåŠ¡/è‡ªæ‰˜ç®¡çš„å®¹å™¨æœåŠ¡ä¸­ï¼Œå…·ä½“å¯å‚è€ƒ&lt;a href=&#34;https://jimmysong.io/kubernetes-handbook/practice/ci-cd.html&#34;&gt;k8s ci/cd&lt;/a&gt; , GitOpså®è·µ: &lt;a href=&#34;https://cloudyuga.guru/blog/jenkins-argo&#34;&gt;github-jenkins-argo&lt;/a&gt; , &lt;a href=&#34;https://www.jokerbai.com/archives/ji-yu-jenkins-he-argocd-shi-xian-devops&#34;&gt;ä½¿ç”¨gitlab,Jenkinså’ŒArgocdå®ç°CI/CD&lt;/a&gt;, &lt;a href=&#34;https://www.jokerbai.com/archives/shi-yong-argorollouts-shi-xian-jin-si-que-fa-bu&#34;&gt;ä½¿ç”¨argo rolloutså®ç°é‡‘ä¸é›€å‘å¸ƒ&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;æ— çŠ¶æ€æœåŠ¡å¿«é€Ÿå¼€å‘è¿­ä»£å¤§è‡´è‡ªåŠ¨åŒ–æ„å»ºéƒ¨ç½²å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;p&gt;CI:  begin -&amp;gt; build(local makefile/test build, dockerfile build) -&amp;gt; push docker registry(è‡ªå»º&lt;a href=&#34;https://goharbor.io/docs/2.6.0/&#34;&gt;harbor&lt;/a&gt;æˆ–è€…äº‘æœåŠ¡) -&amp;gt; end  (gitlab/jenkins CI)&lt;/p&gt;
&lt;p&gt;CD: åˆ†å¼€å‘ï¼Œæµ‹è¯•ï¼Œé¢„å‘å’Œç”Ÿäº§ç¯å¢ƒï¼Œå¼€å‘ï¼Œæµ‹è¯•ç›´æ¥å•podéƒ¨ç½²å®ä¾‹ï¼›é¢„å‘åŒpod;  ç”Ÿäº§ç¯å¢ƒåˆ™åˆ†é˜¶æ®µéƒ¨ç½²å’Œå›æ»šï¼šè“ç»¿éƒ¨ç½²/é‡‘ä¸é›€(ç°åº¦)éƒ¨ç½² (&lt;a href=&#34;https://argo-cd.readthedocs.io/en/stable/&#34;&gt;argo CD&lt;/a&gt;, &lt;a href=&#34;https://argoproj.github.io/argo-rollouts/&#34;&gt;argo Rollouts&lt;/a&gt;)&lt;/p&gt;
&lt;p&gt;æœ‰çŠ¶æ€æ•°æ®å­˜å‚¨æœåŠ¡é€šè¿‡operatoréƒ¨ç½²ï¼š&lt;/p&gt;
&lt;p&gt;polardb-x operator: &lt;a href=&#34;https://doc.polardbx.com/operator/&#34;&gt;https://doc.polardbx.com/operator/&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Tidb-operator: &lt;a href=&#34;https://github.com/pingcap/tidb-operator&#34;&gt;https://github.com/pingcap/tidb-operator&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Redis-cluster:   &lt;a href=&#34;https://github.com/bitnami/charts/tree/main/bitnami/redis-cluster&#34;&gt;https://github.com/bitnami/charts/tree/main/bitnami/redis-cluster&lt;/a&gt; , &lt;a href=&#34;https://kubedb.com/docs/v2022.10.18/guides/redis/clustering/redis-cluster/&#34;&gt;https://kubedb.com/docs/v2022.10.18/guides/redis/clustering/redis-cluster/&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;RocketMQ-operator on k8s: &lt;a href=&#34;https://github.com/apache/rocketmq-operator&#34;&gt;https://github.com/apache/rocketmq-operator&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;é¢˜å¤–è¯ï¼šæˆ–è€…è¿›ä¸€æ­¥çš„ç›´æ¥ä½¿ç”¨æ— æœåŠ¡serverless å‡½æ•°è®¡ç®—ï¼Œå¼€æºæ–¹æ¡ˆ&lt;a href=&#34;https://www.cncf.io/online-programs/event-driven-architecture-with-knative-events/&#34;&gt;&lt;strong&gt;Knative&lt;/strong&gt;&lt;/a&gt; &lt;a href=&#34;https://docs.openfaas.com/deployment/kubernetes/&#34;&gt;openfaas on k8s&lt;/a&gt;, æˆ–è€…ä½¿ç”¨äº‘æœåŠ¡æ¯”å¦‚&lt;a href=&#34;https://aws.amazon.com/cn/campaigns/lambda/&#34;&gt;aws lambda&lt;/a&gt;(transform, not transport data), ä¸“æ³¨äºä¸šåŠ¡é€»è¾‘ï¼Œå‡å°‘&amp;rsquo;èƒ¶æ°´&amp;rsquo;ä»£ç ï¼Œç¼ºå°‘äº†å¼€å‘æ¡†æ¶çš„ä¾èµ–ï¼Œå¸¸ç”¨äºæ•°æ®äº‹ä»¶å¤„ç†,æ¯”å¦‚ç›´æ’­éŸ³è§†é¢‘ç¦»çº¿/å®æ—¶å¤„ç†ï¼ˆDevOps-&amp;gt;AppOps)ï¼Œ &lt;strong&gt;&lt;a href=&#34;https://www.youtube.com/watch?v=PiQ_eZFO2GU&amp;amp;list=PL2yQDdvlhXf_lYR5Ntvr9V5iVYv5rcbNc&amp;amp;index=6&#34;&gt;AWS re:Invent 2022 - Best practices for advanced serverless developers&lt;/a&gt;&lt;/strong&gt;, &lt;strong&gt;&lt;a href=&#34;https://catalog.workshops.aws/complete-aws-sam/en-US&#34;&gt;The Complete AWS SAM workshop&lt;/a&gt;&lt;/strong&gt;ã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;ä»£ç åœ°å€&lt;/strong&gt;ï¼š &lt;a href=&#34;https://github.com/weedge/craftsman/tree/main/cloudwego&#34;&gt;https://github.com/weedge/craftsman/tree/main/cloudwego&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;ä»£ç ç»“æ„ï¼š(æ”¾åœ¨ä¸€ä¸ªgitä»“åº“(svn)ä¸­ä¸»è¦æ˜¯ä¸ºäº†æ–¹ä¾¿æäº¤å¼€å‘æŸ¥çœ‹æ•´ä½“å¼€å‘æ¡†æ¶å“ˆï¼Œå¦‚æœæƒ³å¤šäººç©å¯ä»¥å»ºä¸ªç»„ç»‡æ‹†åˆ†å“ˆ,é€šè¿‡submoduleç»„åˆåœ¨ä¸€èµ·CP git flowï¼Œg*yhub)&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-fallback&#34; data-lang=&#34;fallback&#34;&gt;â”œâ”€â”€ aws	-------------- use aws cloud develop, focus on biz logic by use lambda / step functions
â”‚Â Â  â””â”€â”€ cdk ------ deploy infrastructure ECS, VPC, EKS, S3, cache,db/search,mq etc for severless 
â”œâ”€â”€ cloudwego	----------------- use cloudwego framwork develop
â”‚Â Â  â”œâ”€â”€ common	----------------- biz common for idl,dto,dict enum; rpc service/client, pkg
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ idl
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ kitex_gen
â”‚Â Â  â”‚Â Â  â”‚Â Â  â”œâ”€â”€ base
â”‚Â Â  â”‚Â Â  â”‚Â Â  â”œâ”€â”€ common
â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ payment
â”‚Â Â  â”‚Â Â  â”‚Â Â      â”œâ”€â”€ base
â”‚Â Â  â”‚Â Â  â”‚Â Â      â”œâ”€â”€ da
â”‚Â Â  â”‚Â Â  â”‚Â Â      â”‚Â Â  â””â”€â”€ paymentservice
â”‚Â Â  â”‚Â Â  â”‚Â Â      â””â”€â”€ station
â”‚Â Â  â”‚Â Â  â”‚Â Â          â””â”€â”€ paymentservice
â”‚Â Â  â”‚Â Â  â””â”€â”€ pkg
â”‚Â Â  â”‚Â Â      â””â”€â”€ constants
â”‚Â Â  â”œâ”€â”€ kitex-contrib ------------------------ kitex rpc framwork contrib (add new)
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ gorm
â”‚Â Â  â”‚Â Â  â””â”€â”€ obs-opentelemetry
â”‚Â Â  â”‚Â Â      â””â”€â”€ logging
â”‚Â Â  â”‚Â Â          â””â”€â”€ zap
â”‚Â Â  â””â”€â”€ payment		---------------------------- app payment have http ui/gateway, rpc station,da service/server
â”‚Â Â      â”œâ”€â”€ bin		---- go build cmd output to bin
â”‚Â Â      â”œâ”€â”€ build	---- makefile, dockerfile,docker-compose.yml to build, run
â”‚Â Â      â”œâ”€â”€ cmd		---- main.go to load da/station/gw cmd to run
â”‚Â Â      â”‚Â Â  â”œâ”€â”€ da
â”‚Â Â      â”‚Â Â  â”œâ”€â”€ gw
â”‚Â Â      â”‚Â Â  â””â”€â”€ station
â”‚Â Â      â”œâ”€â”€ conf	---------- env biz config for local/dev/test/pre/stress/gray/prod 
â”‚Â Â      â”‚Â Â  â”œâ”€â”€ dev
â”‚Â Â      â”‚Â Â  â”œâ”€â”€ gray
â”‚Â Â      â”‚Â Â  â”œâ”€â”€ local
â”‚Â Â      â”‚Â Â  â”œâ”€â”€ pre
â”‚Â Â      â”‚Â Â  â”œâ”€â”€ prod
â”‚Â Â      â”‚Â Â  â”œâ”€â”€ stress
â”‚Â Â      â”‚Â Â  â””â”€â”€ test
â”‚Â Â      â”œâ”€â”€ data	-------------- sql data, encode/decode meta data
â”‚Â Â      â”œâ”€â”€ docs	-------------- app help doc
â”‚Â Â      â”œâ”€â”€ internal ----------- internal don&amp;#39;t be used by out package, code biz logic
â”‚Â Â      â”‚Â Â  â”œâ”€â”€ da	------------------------ dal 
â”‚Â Â      â”‚Â Â  â”‚Â Â  â”œâ”€â”€ consumer ---- event drive consumer
â”‚Â Â      â”‚Â Â  â”‚Â Â  â”œâ”€â”€ dao      ---- db table data persistence op
â”‚Â Â      â”‚Â Â  â”‚Â Â  â”œâ”€â”€ domain   ---- domain entries, interface, errors
â”‚Â Â      â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ mocks ---- mock for test
â”‚Â Â      â”‚Â Â  â”‚Â Â  â”œâ”€â”€ model    ---- table entry model 
â”‚Â Â      â”‚Â Â  â”‚Â Â  â”œâ”€â”€ repository ---- impl domain db repository interface
â”‚Â Â      â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ mysql
â”‚Â Â      â”‚Â Â  â”‚Â Â  â””â”€â”€ usecase ----- biz logic use repositories 
â”‚Â Â      â”‚Â Â  â”œâ”€â”€ gw	------------------------ ui/gateway
â”‚Â Â      â”‚Â Â  â”‚Â Â  â””â”€â”€ middleware -------- middleware handle
â”‚Â Â      â”‚Â Â  â””â”€â”€ station -------------------- biz logic station by using cache 
â”‚Â Â      â”‚Â Â      â””â”€â”€ consumer ---- event drive consumer for cache
â”‚Â Â      â”‚Â Â      â”œâ”€â”€ domain   ---- domain entries, interface, errors
â”‚Â Â      â”‚Â Â      â”œâ”€â”€ repository ---- impl domain cache, mq produce repository interface
â”‚Â Â      â”‚Â Â      â”‚Â Â  â”œâ”€â”€ redis
â”‚Â Â      â”‚Â Â      â”‚Â Â  â”‚Â Â  â””â”€â”€ lua
â”‚Â Â      â”‚Â Â      â”‚Â Â  â””â”€â”€ rmq
â”‚Â Â      â”‚Â Â      â””â”€â”€ usecase  ----- biz logic use repositories 
â”‚Â Â      â”œâ”€â”€ manifests -------------- k8s/istio configmap,secret,deployment+service,ingress resource workload and traffic/flow control
â”‚Â Â      â”‚Â Â  â”œâ”€â”€ traffic
â”‚Â Â      â”‚Â Â  â”‚Â Â  â””â”€â”€ istio
â”‚Â Â      â”‚Â Â  â””â”€â”€ workloads
â”‚Â Â      â””â”€â”€ pkg --------------------- app common pkg
â”‚Â Â          â”œâ”€â”€ configparser
â”‚Â Â          â”œâ”€â”€ constants
â”‚Â Â          â”œâ”€â”€ injectors
â”‚Â Â          â”œâ”€â”€ subscriber
â”‚Â Â          â”œâ”€â”€ utils
â”‚Â Â          â”‚Â Â  â”œâ”€â”€ logutils
â”‚Â Â          â”‚Â Â  â””â”€â”€ netutils
â”‚Â Â          â””â”€â”€ version 
â”œâ”€â”€ kratos	----------------- use kratos framwork develop
â””â”€â”€ opentelemetry-go-contrib ----- otel go contrib just for new one, if change, it&amp;#39;s not origin, u can fork, go mod edit -replace
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;æœåŠ¡å¯ä»¥é€šè¿‡å¤šä¸ªserviceç»„åˆæˆä¸€ä¸ªå•ä½“serverï¼Œä¹Ÿå¯ä»¥ä»ä¸€ä¸ªå•ä½“serveræ‹†åˆ†æˆå¤šä¸ªå¾®æœåŠ¡serverï¼Œä»¥ä¾¿ä¼ä¸šå†…éƒ¨ç»„ç»‡æ¶æ„æ¥è°ƒæ•´æœåŠ¡(åŸºäºä¸Šä¸‹æ–‡è½¯ä»¶æ¶æ„åŸåˆ™ &lt;strong&gt;&lt;a href=&#34;https://martinfowler.com/bliki/ConwaysLaw.html&#34;&gt;Conway&amp;rsquo;s law&lt;/a&gt;&lt;/strong&gt;)&lt;/p&gt;
&lt;p&gt;æœåŠ¡å†…éƒ¨å„ä¸ªæ¨¡å—ç»„ä»¶é‡‡ç”¨DDD &lt;a href=&#34;https://blog.cleancoder.com/uncle-bob/2012/08/13/the-clean-architecture.html&#34;&gt;clean-architecture&lt;/a&gt; æ¶æ„ï¼Œæ¥å£éš”ç¦»å®ç°ï¼Œä¾èµ–åè½¬(&lt;strong&gt;&lt;a href=&#34;http://en.wikipedia.org/wiki/Dependency_inversion_principle&#34;&gt;Dependency Inversion Principle&lt;/a&gt;&lt;/strong&gt;)ï¼Œæœ¨æœ‰å¾ªç¯ä¾èµ–ï¼Œæ—¢æ–¹ä¾¿mockï¼Œä¹Ÿæ–¹ä¾¿ç»„è£…ï¼Œgolangéƒ½æ˜¯ä»¥ç»„åˆæ–¹å¼æ¥æ„å»ºï¼Œé¢å‘å¯¹è±¡ç¼–ç¨‹è¯­è¨€ java/c++ é€šè¿‡æ¥å£/ç»§æ‰¿æ¥å®ç°å¤šæ€ï¼Œgolangåˆ™æ²¡æœ‰ç»§æ‰¿é€šè¿‡æ¥å£çš„æ–¹å¼æ¥å®ç°å¤šæ€ï¼Œå‰è€…æ˜¯è¿è¡Œæ—¶æŸ¥æ‰¾ç¼–è¯‘æ—¶ç”Ÿæˆçš„å‡½æ•°è¡¨(itable/vtable)è¿›è¡ŒåŠ¨æ€ç»‘å®šï¼Œåè€…åˆ™æ˜¯ç¼–è¯‘æ—¶æŒ‡é’ˆç›´æ¥è¿›è¡Œç»‘å®š(å®ç°æ¥å£åˆ†æŒ‡é’ˆç±»å‹å’Œç»“æ„ä½“ç±»å‹ï¼Œåè€…æœ‰å‚æ•°æ‹·è´æ“ä½œï¼Œå¼€å‘ä¸­ä½¿ç”¨å‰è€…æŒ‡é’ˆç±»å‹ï¼›ç¼–è¯‘æ—¶éç©ºinterface ifaceä¸­çš„itab.interæŒ‡å‘å¯¹åº”æ¥å£å, itab._type æŒ‡å‘å¯¹åº”å®ä¾‹å¯¹è±¡ä»¥åŠå‡½æ•°æ•°ç»„æŒ‡é’ˆfunæŒ‡å‘å¯¹åº”ç»“æ„å®ä½“ä¸­çš„å®ç°æ–¹æ³•ï¼›è¿è¡Œæ—¶å°†åˆå§‹åŒ–å®ä¾‹å¯¹è±¡åˆ†é…åœ¨å †ä¸­ï¼Œç„¶åå°†å®ä¾‹åŒ–å¯¹è±¡æŒ‡é’ˆèµ‹ç»™itab._type, è°ƒç”¨å¯¹åº”å®ä½“çš„å‡½æ•°æ–¹æ³•æ—¶åœ¨åˆ†é…çš„æ ˆç©ºé—´ä¸­è¿›è¡Œè¿è¡Œï¼›é€šè¿‡ &lt;a href=&#34;https://golang.google.cn/src/cmd/compile/doc.go?h=go+tool+compile&#34;&gt;go tool complie&lt;/a&gt; åœ¨å¯¹åº”ç¡¬ä»¶å¹³å°æŸ¥çœ‹ç¼–è¯‘çš„Plan9æ±‡ç¼–ä»£ç ä¸ºå‡†)ï¼Œä»¥ç»„åˆçš„æ–¹å¼æ„å»ºé¡¹ç›®(åŸåˆ™: &lt;strong&gt;ä»»ä½•æ„é€ å‡½æ•°éƒ½ä¸åº”è°ƒç”¨å¦ä¸€ä¸ªæ„é€ å‡½æ•°&lt;/strong&gt;, åœ¨ç¨‹åºåˆå§‹åŒ–æ—¶è¿›è¡Œæ„é€ æ³¨å…¥å®ä½“)ï¼Œä»¥é˜²ç±»ç»§æ‰¿è¿‡åº¦æŠ½è±¡è®¾è®¡ï¼›interfaceç›¸å…³å¯å‚è€ƒï¼š&lt;a href=&#34;https://www.toptal.com/go/golang-oop-tutorial&#34;&gt;golang-oop-tutorial&lt;/a&gt; &lt;a href=&#34;https://halfrost.com/go_interface/&#34;&gt;go-interface&lt;/a&gt; &lt;a href=&#34;https://github.com/cch123/golang-notes/blob/master/assembly.md&#34;&gt;golang-assembly&lt;/a&gt; &lt;strong&gt;&lt;a href=&#34;https://github.com/teh-cmc/go-internals/blob/master/chapter2_interfaces/README.md&#34;&gt;go-internals-interfaces&lt;/a&gt;&lt;/strong&gt; &lt;strong&gt;&lt;a href=&#34;https://planetscale.com/blog/generics-can-make-your-go-code-slower&#34;&gt;generics-can-make-your-go-code-slower&lt;/a&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;å°½é‡ä½¿ç”¨å·¥å…·æ¥ç”Ÿæˆè§„èŒƒåŒ–ï¼Œç»“æ„åŒ–çš„ä»£ç ; å¸¸ç”¨å·¥å…·å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;a href=&#34;https://gorm.io/gen/index.html&#34;&gt;gorm-gen&lt;/a&gt; diyç”Ÿæˆæ•°æ®åº“æŒä¹…è®¿é—®å±‚æ¨¡å‹,å¯ä»¥ç”¨sqlæ¥æ¨æ¼”ä¸šåŠ¡é€»è¾‘ï¼Œç„¶åç›´æ¥ç”Ÿæˆå¯¹åº”daoæ“ä½œmodel/entryè¯»å†™æ–¹æ³•ï¼Œæä¾›ç»™ä¸Šå±‚repository è¿›è¡Œæ¥å£å®ä¾‹åŒ–æ³¨å…¥ï¼Œå¦‚æœä¸šåŠ¡é€»è¾‘éç®€å•çš„CURD, æä¾›ä¸€å±‚usecaseæ¥åˆ†ç¦»ä¸šåŠ¡å…·ä½“å®ç°ï¼Œä»¥åŠç»„åˆrepositoryæ¥å®ç°å…·ä½“ä¸šåŠ¡åœºæ™¯é€»è¾‘ï¼Œå®ç° domainé¢†åŸŸé©±åŠ¨ æ»¡è¶³ ä¸šåŠ¡å¯¹å†…å¯¹å¤–çš„apiæ¥å£ ä»¥åŠ äº‹ä»¶é©±åŠ¨ï¼›&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/google/wire/blob/main/docs/guide.md&#34;&gt;wire &lt;/a&gt;ä¾èµ–æ³¨å…¥ï¼Œå°†db/cache/mq/rpc/http client -&amp;gt; dao, repository  -&amp;gt; usecase -&amp;gt; api/subscribe handler  -&amp;gt; service  =&amp;gt; server ä¾æ¬¡æ³¨å…¥å®ä½“ç»„è£…æˆserverï¼Œæä¾›æœåŠ¡ï¼›&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/golang/mock&#34;&gt;GoMock mockgen&lt;/a&gt;(golangå®˜æ–¹å‡ºå“)ï¼Œå¯ä»¥ç»“åˆ &lt;a href=&#34;github.com/vektra/mockery&#34;&gt;mockery&lt;/a&gt; (ç›¸å¯¹å¼€å‘å‹å¥½)å·¥å…·æ¥mock æ¥å£ ï¼Œ è¿™æ ·åœ¨å‰æœŸä¸ç”¨å®ç°å…·ä½“åœºæ™¯å®ä½“ç±»ï¼Œç›´æ¥å¯ä»¥æµ‹è¯•é©±åŠ¨(BDD/TDD)è¿›è¡Œä¸šåŠ¡é€»è¾‘æ¨æ¼”ï¼›å¯ä»¥è®¤ä¸ºå‰æœŸæ­å¼€å‘æ¡†æ¶æ¶å­ï¼Œä¸ä»…éœ€è¦æ»¡è¶³ç°åœ¨éœ€æ±‚ï¼Œè€Œä¸”éœ€è¦å¯¹åç»­æ˜“å˜éœ€æ±‚å¯è¿›è¡Œæ‰©å±•å¼€å‘ï¼Œæ— éœ€æ”¹åŠ¨ä»¥å¾€é€»è¾‘(ä¸šåŠ¡é€»è¾‘å®ä½“åˆç†æŠ½è±¡ä»¥åŠå¯¹åº”æ–¹æ³•æ¥å£)ï¼›ä¹Ÿå¯ä»¥ä½¿ç”¨hackçš„æ–¹å¼ é€šè¿‡ &lt;a href=&#34;https://bou.ke/blog/monkey-patching-in-go/&#34;&gt;gomonkey&lt;/a&gt; è¿›è¡Œæ‰“æ¡©æ³¨å…¥è¿›è¡Œmockï¼Œè™½ç„¶ç®€å•ç›´æ¥ï¼Œä½†æ˜¯ä¾èµ–åº•å±‚ç¼–è¯‘ç¡¬ä»¶å¹³å°æ¶æ„,æœ‰é™åˆ¶ä¸æ¨èï¼›&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://onsi.github.io/ginkgo/&#34;&gt;ginkgo&lt;/a&gt; ç¼–å†™å…¬æœ‰å‡½æ•°æµ‹è¯•ç”¨ä¾‹ï¼Œè¦†ç›–ä¸šåŠ¡é€»è¾‘åˆ†æ”¯&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;æ€»ä¹‹ä¿æŒ &lt;strong&gt;KISS&lt;/strong&gt; å§¿åŠ¿ï¼Œè®©å·¥å…·æ¥è§£æ”¾ç”Ÿäº§åŠ›ï¼ˆå¥½çš„å·¥å…·å¯ä»¥è§„èŒƒåŒ–å†™ä»£ç æµç¨‹, å‰ææ˜¯å·¥ç¨‹æœ€ä½³å®è·µæ²‰æ·€ï¼‰ã€‚&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Keep it simple stupid â€œK.I.S.Sâ€&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;é™„ï¼š&lt;a href=&#34;https://google.github.io/styleguide/go/&#34;&gt;google golang style&lt;/a&gt;  , &lt;a href=&#34;https://rakyll.org/deprecated/&#34;&gt;Deprecation notices in Go&lt;/a&gt; ,  &lt;a href=&#34;https://research.swtch.com/gomm&#34;&gt;GOMM&lt;/a&gt; , &lt;a href=&#34;https://medium.com/@ankur_anand/a-visual-guide-to-golang-memory-allocator-from-ground-up-e132258453ed&#34;&gt;Go Memory Allocator&lt;/a&gt; , &lt;a href=&#34;https://tip.golang.org/doc/gc-guide&#34;&gt;gc-guide&lt;/a&gt; , &lt;a href=&#34;https://www.ardanlabs.com/blog/2018/12/garbage-collection-in-go-part1-semantics.html&#34;&gt;garbage-collection-in-go&lt;/a&gt; , &lt;a href=&#34;https://www.ardanlabs.com/blog/2018/08/scheduling-in-go-part2.html&#34;&gt;scheduling-in-go&lt;/a&gt; , &lt;a href=&#34;https://go101.org/article/channel-closing.html&#34;&gt;channel-closing&lt;/a&gt; , &lt;a href=&#34;https://www.google.com.hk/search?q=kavya%20golang#fpstate=ive&amp;amp;vld=cid:089b5108,vid:KBZlN0izeiY&#34;&gt;Understanding Channels&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&#34;æµ‹è¯•&#34;&gt;æµ‹è¯•&lt;/h3&gt;
&lt;p&gt;åŸºæœ¬åŠŸèƒ½é€»è¾‘æµ‹è¯•ï¼Œå¹¶å‘åœºæ™¯ä¸‹çš„æ‰£å‡å’Œæ–°å¢æ•°æ®ä¸€è‡´ï¼›ç„¶ååŠ ä¸Š ä¸šåŠ¡/åŸºç¡€æœåŠ¡/ä¸­é—´ä»¶æœåŠ¡ç›‘æ§ï¼Œæ—¥å¿—ï¼Œåœ¨å¼€å§‹å‹æµ‹ï¼Œç»™å‡ºæ€§èƒ½æŠ¥å‘Šï¼Œè°ƒä¼˜ï¼›æœ€ç»ˆç»™å‡ºæ¥å£/æ•´ä½“æœåŠ¡ååå’Œå»¶æ—¶ä¸Šé™ï¼Œé‡‡ç”¨æœåŠ¡æµæ§å¯¹æœåŠ¡æ¥å£åŠ ä¸Šæ¥å£/æœåŠ¡é™æµï¼Œä»¥åŠè¶…æ—¶é‡è¯•ï¼ŒæœåŠ¡ç›¸å…³é™çº§ç­–ç•¥ï¼›ç„¶åæ¨¡æ‹Ÿçº¿ä¸Šåœºæ™¯ç»§ç»­å‹æµ‹ï¼Œè§¦å‘å¯¹åº”æŠ¥è­¦å’Œé™æµï¼Œé™çº§ç­–ç•¥ï¼›&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;æ¨¡å—æµ‹è¯•, ä¸»è¦æ˜¯ pkgä¸­çš„åŸºç¡€å‡½æ•°benchmarkæµ‹è¯•ï¼Œä»¥åŠinternalä¸­çš„ä¸šåŠ¡é€»è¾‘æµ‹è¯•&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;åŠ ä¸ŠæœåŠ¡ç›‘æ§ï¼Œæ—¥å¿—ï¼ŒæŠ¥è­¦ï¼Œé‡ç‚¹å…³æ³¨æ ¸å¿ƒé“¾è·¯æŒ‡æ ‡ï¼šèµ„æºU.S.E, åº”ç”¨R.E.D; å‚è€ƒ: &lt;a href=&#34;http://www.infoq.com/articles/monitoring-SRE-golden-signals&#34;&gt;&lt;strong&gt;Monitoring SREâ€™s Golden Signals&lt;/strong&gt;&lt;/a&gt;, &lt;a href=&#34;https://sre.google/sre-book/monitoring-distributed-systems/#xref_monitoring_golden-signals&#34;&gt;monitoring_golden-signals L.E.T.S&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;å•ä¸ªæ¥å£å‹æµ‹, ä¸»è¦æ˜¯æ¥å£ä¸­æ“ä½œæ•°æ®ä¸­å¿ƒdbçš„è¯»å†™ååï¼Œä»¥åŠå¼•å…¥ç¼“å­˜åï¼Œè¿›è¡Œå¼‚æ­¥å¤„ç†çš„è¯»å†™åå&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;æ ¸å¿ƒå‰ç«¯æ¥å£æ•´ä½“å‹æµ‹, éœ€è¦æµé‡å’Œæ•°æ®å­˜å‚¨ç¯å¢ƒéš”ç¦»ï¼Œæ•´ä½“é€šè¿‡æœåŠ¡æ²»ç†æ¡†æ¶è¿›è¡Œæµæ§ï¼Œæ‰“ä¸Šstressæ ‡ç­¾æŸ“è‰²ï¼Œè¯·æ±‚æµé‡å’Œæ•°æ®æµé€šè¿‡stressæ ‡ç­¾å°†æ•°æ®å­˜æ”¾äºå½±å­é€»è¾‘å­˜å‚¨(cache KV, è¡¨/é›†åˆ/ç´¢å¼•ï¼Œé˜Ÿåˆ—)ä¸­; å‚è€ƒï¼š&lt;a href=&#34;https://mp.weixin.qq.com/s/vofrpFGvnptj3MNAv1hQ-w&#34;&gt;Rhino&lt;/a&gt; &lt;a href=&#34;https://tech.meituan.com/2018/09/27/quake-introduction.html&#34;&gt;Quake&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;æ··æ²Œæµ‹è¯•ï¼Œå°½é‡è¦†ç›–è§¦å‘è¾¹ç•Œåœºæ™¯ï¼Œé¢å‘æ•…éšœç¼–ç¨‹ï¼Œæµ‹è¯•; å‚è€ƒï¼š&lt;a href=&#34;https://mp.weixin.qq.com/s/kZ_sDdrbc-_trVLNCWXyYw&#34;&gt;æ··æ²Œå·¥ç¨‹å®è·µ&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;ä¸šåŠ¡åŠŸèƒ½è°ƒä¼˜ï¼šä¼˜å…ˆä¸šåŠ¡åŠŸèƒ½å¤§æ–¹å‘è°ƒä¼˜ï¼Œåˆ†å¸ƒå¼æ•°æ®åº“ä¸‹çš„æŸ¥è¯¢è¯­å¥ï¼Œç®—å­ä¸‹æ¨ï¼Œç´¢å¼•æ•ˆç‡ (ç©ºé—´æ¢æ—¶é—´ï¼Œk/v æ“ä½œ B+tree,LSM-tree)&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Profiling è°ƒä¼˜ï¼šé€šè¿‡ç›¸å…³trace/perfå·¥å…·å…³æ³¨è€—æ—¶ï¼Œä½¿ç”¨ç³»ç»Ÿå†…æ ¸ä¼˜åŒ–çš„è°ƒç”¨å‡½æ•°ï¼Œä»¥åŠç³»ç»Ÿå‚æ•°è°ƒæ•´ï¼Œå†…å­˜(å‡å°‘gcï¼Œé¢‘ç¹æ“ä½œå°å¯¹è±¡æ± åŒ–å¤ç”¨ï¼Œå†…å­˜åˆ†é…ç®¡ç†ï¼Œå±€éƒ¨æ€§åŸåˆ™)ï¼Œcpu(äº²å’Œæ€§)ï¼ŒI/O(ç½‘ç»œï¼Œç£ç›˜I/O å°½é‡å¼‚æ­¥å¤„ç†,) ï¼Œbuff(ç¼“å†²ï¼Œbatch)ç­‰&lt;/p&gt;
&lt;p&gt;tips: ä¸šåŠ¡æ•´ä½“è®¾è®¡æ–¹æ¡ˆokçš„æƒ…å†µä¸‹ï¼ŒåŒæœºæˆ¿æ•´ä½“æ€§èƒ½ä¼˜åŒ–æ”¶ç›Šï¼š ç¡¬ä»¶(cpu/GPUæµ®ç‚¹è¿ç®—/TPUï¼Œå†…å­˜/nvmï¼Œç£ç›˜/ssdï¼Œç½‘å¡å¸¦å®½æ‹†è§£åŒ…æ ¡éªŒ) &amp;gt; å†…æ ¸ç³»ç»Ÿè°ƒç”¨ &amp;gt; ä¸šåŠ¡ä»£ç (æ•°æ®ç»“æ„,è¯­è¨€å±‚é¢ç¼–è¯‘ä¼˜åŒ–opcode)&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&#34;æ€»ç»“&#34;&gt;æ€»ç»“&lt;/h2&gt;
&lt;p&gt;é¢å¯¹å¤§é‡å¹¶å‘è¯·æ±‚çš„ç”¨æˆ·äº¤äº’åœºæ™¯ï¼Œæ¶‰åŠåˆ°ç”¨æˆ·é‡‘é¢ç­‰äº‹åŠ¡åœºæ™¯ï¼Œæ•´ä½“æ€è·¯æ˜¯é¢„çƒ­å¿«é€Ÿè·¯å¾„å“åº”ç”¨æˆ·çš„äº¤äº’è¯·æ±‚è¡Œä¸ºï¼Œç„¶åå¼‚æ­¥é˜Ÿåˆ—è§£è€¦ï¼Œæ‰§è¡Œæ…¢è·¯å¾„ï¼Œæ…¢è·¯å¾„ä¸Šé€šè¿‡æœ¬åœ°äº‹åŠ¡(åŒæœåŠ¡å¤šè¡¨æ›´æ–°)ï¼Œæˆ–è€…åˆ†å¸ƒå¼äº‹åŠ¡(å¤šæœåŠ¡å¯¹åº”è¡¨æ›´æ–°)ï¼Œæ¥ä¿è¯æ•°æ®æ•´ä½“ä¸€è‡´ï¼Œå°½é‡é€šè¿‡æ‰¹é‡å¤„ç†(å•åˆ†ç‰‡äº‹åŠ¡ç»„æäº¤)æé«˜ååï¼›å¿«è·¯å¾„å°½é‡ä½¿ç”¨åŸå­æ“ä½œ(æœåŠ¡ä¸»é€»è¾‘å•çº¿ç¨‹æ‰§è¡Œ)æˆ–è€…ä¹è§‚é”ç”¨æˆ·ç¨‹åºè‡ªæ—‹æ‰§è¡Œäº‹åŠ¡ï¼ŒæŒ‰ç”¨æˆ·ç»´åº¦åˆ‡åˆ†å‡å°‘block, ä»¥åŠé€šè¿‡æå‰è§„åˆ’åˆ†å¸ƒå¼å­˜å‚¨å‡åŒ€æ‰“æ•£è¯»å†™çƒ­ç‚¹(åˆ†åº“åˆ†è¡¨åˆ†åŒºåˆ†ç‰‡/æ§½Region/Slot)ï¼Œè§„é¿èŠ‚ç‚¹è´Ÿè½½å€¾æ–œä¸å‡è¡¡é—®é¢˜(å¤§æµé‡,å¤§æ•°æ®),å¤šç»´åº¦æŸ¥è¯¢çš„è¯å¯ä»¥é‡‡ç”¨æ•°æ®å¼‚æ„æ–¹å¼(ç©ºé—´æ¢æ—¶é—´)ï¼Œå¦‚æœæ¶‰åŠåˆ°è·¨æ•°æ®ä¸­å¿ƒåˆ™éœ€è¦è€ƒè™‘æ•°æ®åŒæ„è¿ç§»é—®é¢˜(æ¯”å¦‚å›½é™…åŒ–æ•°æ®éšç§&lt;em&gt;PIPL&lt;/em&gt; &lt;em&gt;GDPR&lt;/em&gt;)ï¼›å¯¹äºæ•°æ®å¹¶å‘åŒæ­¥è·å–è‡³ç¼“å­˜ï¼Œåˆ™éœ€è¦åŠ åˆ†å¸ƒå¼äº’æ–¥é”è‡ªæ—‹blockä¸€æ®µæ—¶é—´ï¼Œé˜²æ­¢å¹¶å‘æ“ä½œåŠ é”å°½é‡å‰ç½®å¤„ç†(warm up to run fast~),å‡å°‘blockï¼›æœ¬è´¨ä¸Šéƒ½æ˜¯å°†å¹¶è¡Œå˜æˆä¸²è¡Œï¼Œåªä¸è¿‡å†…å­˜æ“ä½œæ¯”ç£ç›˜,ç½‘ç»œIOæ“ä½œè¦å¿«å¾ˆå¤š(ç†è®ºä¸Šï¼Œluaè„šæœ¬åœ¨masterä¸»çº¿ç¨‹å†…å­˜ä¸­åŸå­æ‰§è¡Œç›¸å¯¹watch+äº‹åŠ¡æ–¹å¼å¤„ç†æ•ˆç‡è¦é«˜äº›)ï¼›è¿˜æœ‰æœåŠ¡å¼‚å¸¸æ—¶çš„é™çº§æªæ–½ï¼Œä»¥åŠæœåŠ¡è¿‡è½½æ—¶çš„é™æµï¼Œä»¥åŠæ¶ˆæ¯æ•°æ®æµçš„åå‹æªæ–½ã€‚&lt;/p&gt;
&lt;p&gt;é¢˜å¤–è¯ï¼šæ²¡æœ‰é“¶å¼¹ï¼Œå……åˆ†åˆ©ç”¨å¼€æº(å·¥ç¨‹è§„èŒƒ) â˜ï¸çº¢åˆ©(ç¡¬ä»¶è®¡ç®—å­˜å‚¨èµ„æº)ï¼› &lt;em&gt;çº¸ä¸Šå¾—æ¥ç»ˆè§‰æµ…ï¼Œç»çŸ¥æ­¤äº‹è¦èº¬è¡Œ&lt;/em&gt;ï¼Œ step by step, maybe day day up~  hope expand your horizons&lt;/p&gt;
&lt;h2 id=&#34;å‚è€ƒ&#34;&gt;å‚è€ƒ&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&#34;https://mp.weixin.qq.com/s/Cmw3QExqCfBAz9V0AlsS9A&#34;&gt;https://mp.weixin.qq.com/s/Cmw3QExqCfBAz9V0AlsS9A&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&#34;https://aws.amazon.com/cn/builders-library/timeouts-retries-and-backoff-with-jitter/&#34;&gt;https://aws.amazon.com/cn/builders-library/timeouts-retries-and-backoff-with-jitter/&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&#34;https://mp.weixin.qq.com/s/jznfR9Jc-U-uCXioHXjeew&#34;&gt;https://mp.weixin.qq.com/s/jznfR9Jc-U-uCXioHXjeew&lt;/a&gt; , &lt;a href=&#34;https://mp.weixin.qq.com/s/AV4E0Y9d4k5VYTL7n2TNug&#34;&gt;https://mp.weixin.qq.com/s/AV4E0Y9d4k5VYTL7n2TNug&lt;/a&gt; , &lt;a href=&#34;https://mp.weixin.qq.com/s/cT9b2GDsUinVNoA6gyqs_g&#34;&gt;https://mp.weixin.qq.com/s/cT9b2GDsUinVNoA6gyqs_g&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&#34;http://www.52im.net/thread-3515-1-1.html#26&#34;&gt;http://www.52im.net/thread-3515-1-1.html#26&lt;/a&gt; , &lt;a href=&#34;http://www.52im.net/thread-3994-1-1.html&#34;&gt;http://www.52im.net/thread-3994-1-1.html&lt;/a&gt; , &lt;a href=&#34;http://www.52im.net/thread-3376-1-1.html&#34;&gt;http://www.52im.net/thread-3376-1-1.html&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&#34;https://coolshell.cn/articles/8239.html,&#34;&gt;https://coolshell.cn/articles/8239.html,&lt;/a&gt; &lt;a href=&#34;https://time.geekbang.org/column/article/4050&#34;&gt;https://time.geekbang.org/column/article/4050&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;&lt;a href=&#34;https://redis.io/docs/manual/transactions/&#34;&gt;https://redis.io/docs/manual/transactions/&lt;/a&gt; , &lt;a href=&#34;https://redis.io/docs/manual/programmability/&#34;&gt;https://redis.io/docs/manual/programmability/&lt;/a&gt; , &lt;a href=&#34;https://redis.io/docs/reference/cluster-spec/&#34;&gt;https://redis.io/docs/reference/cluster-spec/&lt;/a&gt; , &lt;a href=&#34;https://redis.com/blog/redis-clustering-best-practices-with-keys/&#34;&gt;https://redis.com/blog/redis-clustering-best-practices-with-keys/&lt;/a&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&#34;https://martinfowler.com/articles/serverless.html&#34;&gt;https://martinfowler.com/articles/serverless.html&lt;/a&gt;  &lt;a href=&#34;https://jimmysong.io/kubernetes-handbook/usecases/serverless.html&#34;&gt;https://jimmysong.io/kubernetes-handbook/usecases/serverless.html&lt;/a&gt; , &lt;a href=&#34;https://www.youtube.com/playlist?list=PL2yQDdvlhXf_lYR5Ntvr9V5iVYv5rcbNc&#34;&gt;https://www.youtube.com/playlist?list=PL2yQDdvlhXf_lYR5Ntvr9V5iVYv5rcbNc&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/apache/incubator-kvrocks/wiki/Kvrocks-%E9%9B%86%E7%BE%A4%E6%96%B9%E6%A1%88%E7%AE%80%E4%BB%8B&#34;&gt;https://github.com/apache/incubator-kvrocks/wiki/Kvrocks-%E9%9B%86%E7%BE%A4%E6%96%B9%E6%A1%88%E7%AE%80%E4%BB%8B&lt;/a&gt;  &lt;a href=&#34;https://www.qin.news/kvrocks-qian-xi/&#34;&gt;https://www.qin.news/kvrocks-qian-xi/&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;&lt;a href=&#34;https://tidb.net/blog/09cc69f4&#34;&gt;https://tidb.net/blog/09cc69f4&lt;/a&gt; , &lt;a href=&#34;https://cn.pingcap.com/best-practice-detail/best-practices-for-developing-applications-with-tidb&#34;&gt;https://cn.pingcap.com/best-practice-detail/best-practices-for-developing-applications-with-tidb&lt;/a&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;&lt;a href=&#34;https://mp.weixin.qq.com/s/UFWULymSblrs1hIGP5e7YQ&#34;&gt;https://mp.weixin.qq.com/s/UFWULymSblrs1hIGP5e7YQ&lt;/a&gt; , &lt;a href=&#34;https://github.com/apache/rocketmq/wiki/RIP-50-RocketMQ-Transaction-Message-Improvement&#34;&gt;https://github.com/apache/rocketmq/wiki/RIP-50-RocketMQ-Transaction-Message-Improvement&lt;/a&gt;&lt;/strong&gt; , &lt;strong&gt;&lt;a href=&#34;https://xie.infoq.cn/article/ad16bac16b4c172e268225cfa&#34;&gt;https://xie.infoq.cn/article/ad16bac16b4c172e268225cfa&lt;/a&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&#34;https://www.youtube.com/playlist?list=PLy7NrYWoggjziYQIDorlXjTvvwweTYoNC&#34;&gt;https://www.youtube.com/playlist?list=PLy7NrYWoggjziYQIDorlXjTvvwweTYoNC&lt;/a&gt; , &lt;a href=&#34;https://www.youtube.com/watch?v=vgPFzblBh7w&amp;amp;list=PL8t1FdN2Tj3ZVAzTY-FvsS0qy-mEfRdoj&amp;amp;index=5&#34;&gt;https://www.youtube.com/watch?v=vgPFzblBh7w&amp;amp;list=PL8t1FdN2Tj3ZVAzTY-FvsS0qy-mEfRdoj&amp;amp;index=5&lt;/a&gt; , &lt;a href=&#34;https://www.youtube.com/watch?v=-U9E1PhrM3o&#34;&gt;https://www.youtube.com/watch?v=-U9E1PhrM3o&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;&lt;a href=&#34;https://tonybai.com/2022/08/15/developing-kubernetes-operators-in-go-part1/&#34;&gt;https://tonybai.com/2022/08/15/developing-kubernetes-operators-in-go-part1/&lt;/a&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;&lt;a href=&#34;https://github.com/istio/istio/tree/master/samples/bookinfo&#34;&gt;https://github.com/istio/istio/tree/master/samples/bookinfo&lt;/a&gt; , &lt;a href=&#34;https://github.com/cloudwego/biz-demo&#34;&gt;https://github.com/cloudwego/biz-demo&lt;/a&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&#34;https://mp.weixin.qq.com/s/n4eVf2KZRIp2yKACk88qJA&#34;&gt;https://mp.weixin.qq.com/s/n4eVf2KZRIp2yKACk88qJA&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;</description>
      
    </item>
    
    <item>
      <title>è®©MLè·‘èµ·æ¥</title>
      <link>https://weedge.github.io/post/let-ml-go/</link>
      <pubDate>Tue, 08 Nov 2022 10:26:23 +0800</pubDate>
      
      <guid>https://weedge.github.io/post/let-ml-go/</guid>
      
        <description>&lt;h3 id=&#34;ä»‹ç»&#34;&gt;ä»‹ç»&lt;/h3&gt;
&lt;p&gt;ä¸Šæ–‡æåˆ°é€šè¿‡ç”¨æˆ·çš„è¡Œä¸ºæ•°æ®å­˜æ”¾åœ¨S3ä¸­ï¼Œè¿™äº›æ•°æ®åŒ…æ‹¬ç»“æ„åŒ–å’Œéç»“æ„åŒ–æ•°æ®ï¼Œæ€ä¹ˆè®©è¿™äº›æ•°æ®å˜å¾—æœ‰ä»·å€¼å‘¢ï¼Ÿä¸€ç§æ˜¯äººä¸ºè¿›è¡Œæ•°æ®æŒ–æ˜ï¼Œå¯¹ç›¸å…³æŒ‡æ ‡è½¬åŒ–ç‡è¿›è¡Œè¯„ä¼°ï¼›è¿˜æœ‰ä¸€ç§æ˜¯é€šè¿‡è¿™äº›æ•°æ®æ¥è®­ç»ƒæ¨¡å‹ï¼Œç„¶åå°†é¢„æµ‹æ¨¡å‹ç”¨äºç”Ÿäº§ç¯å¢ƒä¸­è¿›è¡ŒA/Bæµ‹è¯•ï¼Œé€‰å‡ºé€‚åˆçš„æ¨¡å‹ï¼Œè¿™ä¸ªæ¨¡å‹éœ€è¦ä¸æ–­æ›´æ–°è¿­ä»£ï¼Œå¹¶ä¸”è‡ªåŠ¨åŒ–åŠè‡ªåŠ¨åŒ–è¿è¡Œèµ·æ¥ï¼›&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://docs.aws.amazon.com/zh_cn/sagemaker/latest/dg/images/ml-concepts-10.png&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;h3 id=&#34;æ•°æ®å‡†å¤‡&#34;&gt;æ•°æ®å‡†å¤‡&lt;/h3&gt;
&lt;h4 id=&#34;ç‰¹å¾å·¥ç¨‹&#34;&gt;ç‰¹å¾å·¥ç¨‹&lt;/h4&gt;
&lt;h3 id=&#34;æ¨¡å‹è®­ç»ƒ&#34;&gt;æ¨¡å‹è®­ç»ƒ&lt;/h3&gt;
&lt;p&gt;ç›¸å…³åº“ï¼š&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://xgboost.ai/&#34;&gt;XGBoost&lt;/a&gt;,  &lt;a href=&#34;https://en.wikipedia.org/wiki/Gradient_boosting&#34;&gt;Gradient Boosting&lt;/a&gt;æ¡†æ¶ä¸‹å®ç°æœºå™¨å­¦ä¹ ç®—æ³•ã€‚XGBoost æä¾›äº†ä¸€ç§å¹¶è¡Œæ ‘æå‡ï¼ˆä¹Ÿç§°ä¸º &lt;a href=&#34;https://developers.google.com/machine-learning/decision-forests/intro-to-gbdt&#34;&gt;GBDT&lt;/a&gt;ã€GBMï¼‰ï¼Œå¯ä»¥å¿«é€Ÿå‡†ç¡®åœ°è§£å†³è®¸å¤šæ•°æ®ç§‘å­¦é—®é¢˜ã€‚æ”¯æŒåœ¨å¤šå°æœºå™¨ä¸Šè¿›è¡Œåˆ†å¸ƒå¼è®­ç»ƒï¼ŒåŒ…æ‹¬ AWSã€GCEã€Azure å’Œ Yarn é›†ç¾¤ï¼›å¯ä¸ Flinkã€Spark ç­‰äº‘æ•°æ®æµç³»ç»Ÿé›†æˆã€‚&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;å¦‚æœè¯´æŠŠæœºå™¨å­¦ä¹ é—®é¢˜åˆ†æˆï¼Œå¸¸è§„æœºå™¨å­¦ä¹ ï¼ˆconventional machine learningï¼‰å’Œæ·±åº¦å­¦ä¹ ï¼ˆdeep learningï¼‰çš„è¯ï¼Œé‚£ä¹ˆXGBoostå°±æ˜¯åœ¨å¸¸è§„MLç«èµ›è·å¥–æœ€å¤šçš„ç®—æ³•ã€‚&lt;a href=&#34;https://github.com/dmlc/xgboost&#34;&gt;XGBoost&lt;/a&gt; çš„å…¨ç§°æ˜¯ Extreme Gradient Boostingï¼Œæ˜¯gradient boostingçš„ä¸€ç§å¼€æºå®ç°ã€‚gradient boosting æŠŠè‹¥å¹²å¼±æ¨¡å‹é€šè¿‡å†³ç­–æ ‘çš„æ–¹å¼èšåˆï¼ˆensembleï¼‰åœ¨ä¸€èµ·ï¼Œ å½¢æˆä¸€ä¸ªæœ€ç»ˆçš„æ¨¡å‹ï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯ä¸€ä¸ªæŒç»­çš„ã€ä¸æ–­è¿­ä»£ä¼˜åŒ–è¿‡ç¨‹ï¼Œæ¯æ¬¡è¿­ä»£ä¼˜åŒ–çš„æ–¹å‘é€šè¿‡è®¡ç®—loss functionçš„æ¢¯åº¦æ¥å®ç°ï¼Œç„¶åé‡‡å–æ¢¯åº¦ä¸‹é™çš„æ–¹å¼ä¸æ–­çš„é™ä½loss functionï¼Œä»è€Œå¾—åˆ°ä¸€ä¸ªæœ€ç»ˆçš„æ¨¡å‹ã€‚&lt;/p&gt;
&lt;p&gt;XGBoostæœ€å¸¸ç”¨æ¥è§£å†³å¸¸è§„MLä¸­çš„åˆ†ç±»ï¼ˆregressionï¼‰å’Œå›å½’ï¼ˆclassificationï¼‰é—®é¢˜ã€‚å›å½’é—®é¢˜ï¼Œä¸¾ä¾‹æ¥è¯´ï¼šæ ¹æ®ä¸€ä¸ªäººçš„å¹´é¾„ã€èŒä¸šã€å±…ä½ç¯å¢ƒç­‰ä¸ªäººä¿¡æ¯æ¨ç®—å‡ºè¿™ä¸ªäººçš„æ”¶å…¥ï¼Œè¿™ç§æ¨ç†çš„ç»“æœæ˜¯ä¸€ä¸ªè¿ç»­çš„å€¼ï¼ˆæ”¶å…¥ï¼‰çš„æƒ…å†µå°±æ˜¯ä¸€ä¸ªå›å½’é—®é¢˜ï¼›åˆ†ç±»é—®é¢˜ï¼Œæ¯”å¦‚åœ¨æ¬ºè¯ˆæ£€æµ‹ä¸­ï¼Œæ ¹æ®æœ‰å…³äº¤æ˜“çš„ä¿¡æ¯ï¼Œæ¥åˆ¤æ–­äº¤æ˜“æ˜¯ä¸æ˜¯æ¬ºè¯ˆï¼Œè¿™é‡Œçš„åˆ¤æ–­æ˜¯æˆ–è€…å¦å°±æ˜¯ä¸€ä¸ªäºŒåˆ†ç±»é—®é¢˜ã€‚é€šå¸¸è¿™ä¸¤ç±»é—®é¢˜éƒ½æ˜¯ç»™å‡ºä¸€ä¸ªè¡¨æ ¼ç±»å‹æ•°æ®ï¼Œè¡¨æ ¼ä¸­çš„æ¯åˆ—æ•°æ®éƒ½æ˜¯è·Ÿæ¨ç†çš„ç›®æ ‡ï¼ˆå±äºæŸä¸ªåˆ†ç±»æˆ–è€…æ¨ç†å€¼ï¼‰æœ‰ç€æ½œåœ¨å…³ç³»çš„æ•°æ®ï¼ŒXGBoostç‰¹åˆ«æ“…é•¿å¤„ç†è¿™ç±»çš„è¡¨æ ¼æ•°æ®ï¼ˆtabular dataï¼‰ï¼Œå¹¶æ®æ­¤ä½œå‡ºæ¨æ–­ã€‚å¯¹äºè¡¨æ ¼æ•°æ®ï¼Œæ— éç”±è¡Œã€åˆ—æ¥ç»„æˆï¼Œåœ¨MLä¸­å¯¹äºè¡¨æ ¼æ•°æ®ä¸­çš„è¡Œå’Œåˆ—ï¼Œæˆ‘ä»¬æœ‰å¾ˆå¤šçº¦å®šä¿—ç§°çš„ç§°è°“ï¼Œåœ¨å„ç§å…³äºMLçš„æ–‡ç« ä¸­è¿™äº›ç§°è°“ä¼šç»å¸¸å‡ºç°ï¼Œä¸ºäº†ä¾¿äºå¤§å®¶ç†è§£ï¼Œåœ¨è¿™é‡Œå¯¹è¿™äº›å«æ³•åšä¸€ä¸ªæ¢³ç†ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;è¡Œï¼ˆrowï¼‰ï¼Œå«åšä¸€ä¸ªè§‚å¯Ÿï¼ˆobservationï¼‰ï¼Œæˆ–è€…ä¸€ä¸ªæ ·æœ¬ï¼ˆsampleï¼‰&lt;/li&gt;
&lt;li&gt;åˆ—ï¼ˆcolumnï¼‰ ï¼Œä¹Ÿå«å­—æ®µï¼ˆfieldï¼‰ï¼Œå±æ€§ï¼ˆattributeï¼‰ï¼Œæˆ–è€…ç‰¹å¾ï¼ˆfeatureï¼‰&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;a href=&#34;https://keras.io/zh/&#34;&gt;keras&lt;/a&gt;: æ·±åº¦å­¦ä¹ æ¨¡å‹åº“ï¼Œé«˜çº§ç¥ç»ç½‘ç»œ,åŒæ—¶æ”¯æŒå·ç§¯ç¥ç»ç½‘ç»œå’Œå¾ªç¯ç¥ç»ç½‘ç»œï¼Œä»¥åŠä¸¤è€…çš„ç»„åˆã€‚&lt;/p&gt;
&lt;h3 id=&#34;æ¨¡å‹è¯„ä¼°&#34;&gt;æ¨¡å‹è¯„ä¼°&lt;/h3&gt;
&lt;h3 id=&#34;æ¨¡å‹éƒ¨ç½²&#34;&gt;æ¨¡å‹éƒ¨ç½²&lt;/h3&gt;
&lt;p&gt;å¦‚æœä½¿ç”¨&lt;a href=&#34;https://www.tensorflow.org/&#34;&gt;TF&lt;/a&gt;(tensorflow)æ¡†æ¶, ä½¿ç”¨TF &lt;a href=&#34;https://github.com/tensorflow/serving&#34;&gt;serving&lt;/a&gt;æ¥æ”¯æŒåŠ è½½è®­ç»ƒå¥½çš„æ¨¡å‹å‘å¸ƒåˆ°ç”Ÿäº§ç¯å¢ƒï¼Œå¹¶ä¸”å¯ä»¥è¿›è¡ŒA/Bæµ‹è¯•ï¼›&lt;/p&gt;
&lt;p&gt;æ“ä½œdemoå‚è€ƒï¼šhttps://www.tensorflow.org/tfx/tutorials/serving/rest_simple&lt;/p&gt;
&lt;h3 id=&#34;ç”¨äºç”Ÿäº§ç¯å¢ƒéœ€è¦è€ƒè™‘çš„é—®é¢˜&#34;&gt;ç”¨äºç”Ÿäº§ç¯å¢ƒéœ€è¦è€ƒè™‘çš„é—®é¢˜&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;è®­ç»ƒæ¨¡å‹çš„æ•°æ®æ¥æºï¼Œä»¥åŠé‡‡é›†å­˜æ”¾(æ ¼å¼å’Œå‹ç¼©)ï¼›è¿™äº›æ•°æ®æ ¹æ®ä½¿ç”¨åœºæ™¯è€Œå®šï¼Œæ¯”å¦‚demoä¸­çš„ç”µå•†åœºæ™¯ï¼Œè¯†åˆ«ç‰©å“ï¼Œéœ€è¦å¤§é‡çš„éç»“æ„åŒ–å›¾ç‰‡æ•°æ®ï¼Œè¿™äº›ç”¨æˆ·ä¸Šä¼ çš„åŸå§‹å›¾ç‰‡å’ŒåŠ å·¥åçš„å›¾ç‰‡å­˜æ”¾äºå¯¹è±¡å­˜å‚¨ä¸­æ¯”å¦‚S3ï¼ŒOSSï¼ŒCOSï¼›&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;ç‰¹å¾æ•°æ®æ¸…æ´—è¿‡æ»¤å­˜æ”¾ï¼›&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;æ•°æ®å¦‚ä½•å¿«é€Ÿè®­ç»ƒï¼›æ•°æ®é‡ä¸€èˆ¬å¾ˆå¤§ï¼ŒPBçº§åˆ«ï¼Œå•æœºè‚¯å®šæ˜¯åŠ è½½ä¸äº†è¿™ä¹ˆå¤šæ•°æ®è®­ç»ƒï¼Œå³ä½¿åˆ†å‰²æˆå¤šä¸ªå°æ–‡ä»¶ï¼Œå•æœºå¤„ç†éœ€è¦å¤§é‡ä¸­é—´ç»“æœå­˜æ”¾ï¼Œå¤„ç†æ•ˆç‡éå¸¸ä½ï¼›æ‰€ä»¥æ¨¡å‹è®­ç»ƒéœ€è¦è€ƒè™‘é›†ç¾¤æ¨¡å¼ï¼Œè¿›è¡Œ&lt;a href=&#34;https://openmlsys.github.io/chapter_distributed_training/index.html&#34;&gt;åˆ†å¸ƒå¼è®­ç»ƒæ¨¡å‹&lt;/a&gt;ï¼Œéœ€è¦ä¸€ä¸ªè®­ç»ƒå¹³å°æ¥æ”¯æŒï¼Œå……åˆ†è°ƒåº¦è®¡ç®—èµ„æº(CPU,GPU,TPU,FPGA)ï¼Œå¹¶è¡Œè®¡ç®—ï¼Œå¹¶ä¸”æ ¹æ®æ•°æ®é‡è¿›è¡Œå¯ä¼¸ç¼©æ‰©å±•ï¼Œä¿è¯è®­ç»ƒä¸­é€”ä¸­æ–­çš„å¯ç”¨æ€§(failover,checkpoint)ï¼›&lt;/p&gt;
&lt;p&gt;å¼€æºæ¡†æ¶ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;uber &lt;a href=&#34;https://github.com/horovod/horovod&#34;&gt;https://github.com/horovod/horovod&lt;/a&gt;  &lt;a href=&#34;https://arxiv.org/pdf/1802.05799.pdf&#34;&gt;Horovod: fast and easy distributed deep learning in TensorFlow&lt;/a&gt; å¤§éƒ¨åˆ†äº‘å¹³å°åŸºäºhorovodåšäº†å®šåˆ¶åŒ–çš„æ”¹é€ &lt;/li&gt;
&lt;li&gt;Bytedance: &lt;a href=&#34;https://github.com/bytedance/byteps&#34;&gt;https://github.com/bytedance/byteps&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;å°†è®­ç»ƒå¥½çš„æ¨¡å‹å¯¼å‡ºåºåˆ—åŒ–pbæ ¼å¼ï¼Œå­˜æ”¾åˆ°æ–‡ä»¶ç³»ç»Ÿä¸­(&lt;a href=&#34;https://www.tensorflow.org/guide/saved_model#save_and_restore_models&#34;&gt;SavedModel&lt;/a&gt;)ï¼›ç„¶åTF servingå¯åŠ¨æœåŠ¡åŠ è½½æ¨¡å‹ï¼Œå¯¹å¤–ä»¥ HTTP &lt;a href=&#34;https://github.com/tensorflow/serving/blob/master/tensorflow_serving/g3doc/api_rest.md&#34;&gt;REST API&lt;/a&gt;æˆ– &lt;a href=&#34;https://github.com/tensorflow/serving/tree/master/tensorflow_serving/apis&#34;&gt;gRPC API&lt;/a&gt;çš„æ–¹å¼æä¾›æ¨¡å‹æœåŠ¡ï¼›æ­£å¼ç”¨äºçº¿ä¸Šï¼Œéœ€è¦è€ƒè™‘æœåŠ¡æ€§èƒ½é—®é¢˜(é«˜å¹¶å‘åœºæ™¯ï¼Œå»¶è¿Ÿå’Œååé‡ï¼Œæ¨¡å‹&lt;a href=&#34;https://github.com/tensorflow/serving/blob/master/tensorflow_serving/g3doc/saved_model_warmup.md&#34;&gt;é¢„çƒ­&lt;/a&gt;(warmup)ï¼Œ&lt;a href=&#34;https://github.com/tensorflow/serving/blob/master/tensorflow_serving/batching/README.md&#34;&gt;æ‰¹å¤„ç†&lt;/a&gt;(batching)ç­‰&lt;a href=&#34;https://github.com/tensorflow/serving/blob/master/tensorflow_serving/g3doc/performance.md&#34;&gt;æ€§èƒ½&lt;/a&gt;ä¼˜åŒ–ç‚¹)ï¼Œç”Ÿäº§ç¯å¢ƒæ¨¡å‹æ›´æ–°(æ„å»ºï¼Œæ— æŸæœåŠ¡åˆ‡æ¢ï¼Œæµé‡A/Bæµ‹è¯•)ï¼Œå®¹å™¨åŒ–éƒ¨ç½²(&lt;a href=&#34;https://github.com/tensorflow/serving/blob/master/tensorflow_serving/g3doc/serving_kubernetes.md&#34;&gt;serving on K8S&lt;/a&gt;)(æ‰©ç¼©å®¹ï¼Œæµæ§ï¼Œå®¹é”™ç­‰é«˜å¯ç”¨è®¾è®¡)ï¼ŒæœåŠ¡ç›‘æ§ç­‰å·¥ç¨‹ä¸Šçš„é—®é¢˜ï¼›æœ¬åœ°demoå¯å‚è€ƒ: &lt;a href=&#34;https://github.com/tensorflow/serving/blob/master/tensorflow_serving/g3doc/serving_basic.md&#34;&gt;Serving a TensorFlow Model&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;ç›‘æ§æ¨¡å‹æ•°æ®ï¼Œå¦‚ä½•å¯¹å…¶è¿›è¡Œè¯„ä¼°ï¼›&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;æ¨¡å‹è¿­ä»£æ›´æ–°é€Ÿåº¦å¿«ï¼Œéœ€è¦å¼•å…¥CI/CD pipelines æ¥è‡ªåŠ¨åŒ–æ”¯æŒæ¨¡å‹é—­ç¯è¿­ä»£ï¼›&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;è®¡ç®—èµ„æºæœºå™¨æˆæœ¬é¢„ä¼°ï¼›&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&#34;å¼€æºæ–¹æ¡ˆ&#34;&gt;å¼€æºæ–¹æ¡ˆ&lt;/h3&gt;
&lt;p&gt;&lt;a href=&#34;https://www.kubeflow.org/docs/started/introduction/&#34;&gt;Kubeflow&lt;/a&gt; åœ¨ Kubernetes ä¸Šéƒ¨ç½²æœºå™¨å­¦ä¹  (ML) å·¥ä½œæµå˜å¾—ç®€å•ã€å¯ç§»æ¤å’Œå¯æ‰©å±•ã€‚æä¾›ä¸€ç§ç›´æ¥çš„æ–¹å¼æ¥å°†ç”¨äº ML çš„åŒç±»æœ€ä½³å¼€æºç³»ç»Ÿéƒ¨ç½²åˆ°ä¸åŒçš„åŸºç¡€è®¾æ–½ï¼›åœ¨ä»»ä½•è¿è¡Œ Kubernetes çš„åœ°æ–¹ï¼Œéƒ½åº”è¯¥èƒ½å¤Ÿè¿è¡Œ Kubeflowã€‚&lt;/p&gt;
&lt;h3 id=&#34;tfx-with-kubeflow-on-gke&#34;&gt;TFX with kubeflow on GKE&lt;/h3&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/tensorflow/tfx&#34;&gt;https://github.com/tensorflow/tfx&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;æ–‡æ¡£ï¼š&lt;a href=&#34;https://www.tensorflow.org/tfx/tutorials&#34;&gt;TFX tutorials&lt;/a&gt;&lt;/p&gt;

&lt;div style=&#34;position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;&#34;&gt;
  &lt;iframe src=&#34;https://www.youtube.com/embed/17l3VR2MIeg&#34; style=&#34;position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;&#34; allowfullscreen title=&#34;YouTube Video&#34;&gt;&lt;/iframe&gt;
&lt;/div&gt;

&lt;h3 id=&#34;ml-on--amazon-sagemakerhttpsawsamazoncomsagemaker&#34;&gt;ML on  &lt;a href=&#34;https://aws.amazon.com/sagemaker/&#34;&gt;Amazon SageMaker&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;åˆ†å¸ƒå¼è®­ç»ƒï¼š &lt;a href=&#34;https://aws.amazon.com/cn/sagemaker/distributed-training/&#34;&gt;https://aws.amazon.com/cn/sagemaker/distributed-training/&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;æ–‡æ¡£ï¼š&lt;a href=&#34;https://sagemaker-examples.readthedocs.io/en/latest/index.html&#34;&gt;Amazon SageMaker Example Notebooks&lt;/a&gt;ï¼Œ &lt;a href=&#34;https://sagemaker-workshop.com/&#34;&gt;Amazon SageMaker Workshop&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;SageMakeræ¡†æ¶ç›´æ¥é›†æˆäº†å¤šç§æœºå™¨å­¦ä¹ æ¡†æ¶ï¼Œä¸€æ¡é¾™æœåŠ¡ï¼Œä¹Ÿå¯ä»¥é›†æˆKubeflowæ–¹æ¡ˆï¼›æœºå™¨å­¦ä¹ æ•´ä½“ç”Ÿå‘½å‘¨æœŸåŒ…æ‹¬è®­ç»ƒæ•°æ®å‡†å¤‡ï¼Œæ¨¡å‹è®­ç»ƒï¼Œæ¨¡å‹è¯„ä¼°ï¼Œè¯„ä¼°okä¹‹åéƒ¨ç½²ä¸Šçº¿æä¾›åœ¨çº¿é¢„æµ‹æ¨ç†æœåŠ¡ï¼Œé€šè¿‡ç›‘æ§æœé›†æ•°æ®ï¼Œé‡å¤è¿­ä»£æ¨¡å‹ï¼›æ•´ä½“ç”Ÿå‘½å‘¨æœŸå¦‚å›¾æ‰€ç¤ºï¼š&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://s3.cn-north-1.amazonaws.com.cn/awschinablog/use-xgboost-in-amazon-sagemaker-for-commercial-empowerment1.jpg&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;p&gt;å°†æ•°æ®å¤„ç†å‡†å¤‡åˆ°æ¨¡å‹ä¸Šçº¿æ•´ä¸ªè¿‡ç¨‹å¯ä»¥è‡ªåŠ¨åŒ–ï¼Œé€šè¿‡sageMakerå¹³å°ç›´æ¥ç»„åˆæˆå·¥ä½œæµpipelineè¿›è¡Œè‡ªåŠ¨åŒ–å¤„ç†ï¼Œdemoè¯·å‚è€ƒï¼š&lt;a href=&#34;https://aws.amazon.com/cn/getting-started/hands-on/machine-learning-tutorial-mlops-automate-ml-workflows/&#34;&gt;è‡ªåŠ¨åŒ–æœºå™¨å­¦ä¹ å·¥ä½œæµ sagemaker tutorial&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://d1.awsstatic.com/sagemaker-tutorial-5-1-step-3-1-pipeline-diagram.90a11a1a83636b6d56c8ce8d43829571b506ae11.png&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;p&gt;Tips: è¿™é‡Œåªæ˜¯æ•´ä½“æ¦‚æ‹¬ä¸‹æœºå™¨å­¦ä¹ å·¥ç¨‹åŒ–çš„è¿‡ç¨‹ï¼›æœºå™¨å­¦ä¹ ä»¥åŠæ·±åº¦å­¦ä¹ ç›¸å…³çš„ç®—æ³•çŸ¥è¯†å¾…æ·±å…¥è¾¹åŠ¨æ‰‹è¾¹å­¦ä¹ ï¼›å¾…ç»­ï½ :)&lt;/p&gt;
&lt;h3 id=&#34;å‚è€ƒ&#34;&gt;å‚è€ƒ&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;&lt;a href=&#34;https://developers.google.com/machine-learning&#34;&gt;google-developers-ml&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://www.tensorflow.org/tfx/&#34;&gt;TFX&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://xgboost.readthedocs.io/en/latest/index.html&#34;&gt;XGBoostæ–‡æ¡£&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://www.tensorflow.org/tfx/guide/serving&#34;&gt;TF Serving&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://time.geekbang.org/column/article/303430&#34;&gt;æ·±åº¦å­¦ä¹ æ¨èç³»ç»Ÿå®æˆ˜&lt;/a&gt; &lt;a href=&#34;https://github.com/wzhe06/SparrowRecSys&#34;&gt;SparrowRecSys&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://zh.d2l.ai/index.html&#34;&gt;åŠ¨æ‰‹å­¦æ·±åº¦å­¦ä¹ &lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://www.mikulskibartosz.name/how-to-ab-test-tensorflow-models-using-sagemaker-endpoints/&#34;&gt;How to A/B test Tensorflow models using Sagemaker Endpoints&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://aws.amazon.com/cn/blogs/china/use-xgboost-in-amazon-sagemaker-for-commercial-empowerment/&#34;&gt;åœ¨ Amazon SageMaker ä¸­ä½¿ç”¨ XGBoost æ¥å®ç°å•†ä¸šèµ‹èƒ½&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://aws.amazon.com/cn/getting-started/hands-on/machine-learning-tutorial-mlops-automate-ml-workflows/&#34;&gt;è‡ªåŠ¨åŒ–æœºå™¨å­¦ä¹ å·¥ä½œæµ sagemaker tutorial&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://zhuanlan.zhihu.com/p/79030485&#34;&gt;AllReduceç®—æ³•çš„å‰ä¸–ä»Šç”Ÿ&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;</description>
      
    </item>
    
    <item>
      <title>ç”¨æˆ·è¡Œä¸ºåˆ†ææ–¹æ¡ˆè®¾è®¡</title>
      <link>https://weedge.github.io/post/user-behavior-analytics-solution/</link>
      <pubDate>Wed, 02 Nov 2022 10:26:23 +0800</pubDate>
      
      <guid>https://weedge.github.io/post/user-behavior-analytics-solution/</guid>
      
        <description>&lt;h2 id=&#34;èƒŒæ™¯&#34;&gt;èƒŒæ™¯&lt;/h2&gt;
&lt;p&gt;ç”¨æˆ·åœ¨æ‰‹æœºå’Œpcç«¯ä½¿ç”¨å®¢æˆ·ä¸šåŠ¡äº§å“ï¼Œæ¯”å¦‚æµè§ˆç½‘é¡µï¼Œè´­ä¹°å•†å“ï¼ŒæŸ¥çœ‹æ–‡æ¡£ï¼Œè§‚çœ‹è§†é¢‘ï¼Œç›´æ’­ï¼ŒIOTåœºæ™¯ï¼›ä¼šäº§ç”Ÿå¤§é‡çš„ç”¨æˆ·è¡Œä¸ºæ•°æ®ï¼Œä¸»è¦åŒ…æ‹¬ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;éç»“æ„åŒ–æ•°æ®ï¼šæ—¥å¿—(å‰ç«¯äº‹ä»¶åŸ‹ç‚¹æ—¥å¿—ï¼ŒæœåŠ¡ç«¯å¤„ç†äº‹ä»¶æ—¥å¿—)ï¼Œè¿˜æœ‰äº›éç»“æ„åŒ–çš„å›¾ç‰‡ï¼ŒéŸ³è§†é¢‘æ•°æ®ç­‰ç­‰ï¼Œä¸»è¦å­˜æ”¾åœ¨æ–‡ä»¶å­˜å‚¨ç³»ç»Ÿä¸­ï¼›&lt;/li&gt;
&lt;li&gt;ç»“æ„åŒ–å’ŒåŠç»“æ„åŒ–æ•°æ®ï¼š ç”¨æˆ·æ“ä½œäº§å“å†™å…¥çš„ç»“æ„åŒ–æ•°æ®å­˜æ”¾äºæ•°æ®åº“è¡¨ä¸­ï¼Œå°†æ–‡æ¡£å‹åŠç»“æ„åŒ–çš„æ•°æ®æ”¾å…¥æ–‡æ¡£æ•°æ®åº“ä¸­ï¼›&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;éœ€è¦åˆ†æç”¨æˆ·çš„è¡Œä¸ºæ•°æ®ï¼Œè¿›è¡Œå†³ç­–ï¼›åˆ†ä¸ºå®æ—¶æµå¼å¤„ç†å’Œç¦»çº¿æ‰¹å¤„ç†ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;å®æ—¶æµå¤„ç†ï¼Œä¸»è¦ç”¨äºå®æ—¶å±•ç°å®¢æˆ·ç«¯çœ‹æ¿ï¼Œåå°BIå®æ—¶åˆ†æï¼Œå®æ—¶é£æ§/æ¨èï¼Œå¼‚å¸¸æŠ¥è­¦ç­‰åœºæ™¯ï¼›&lt;/li&gt;
&lt;li&gt;ç¦»çº¿æ‰¹å¤„ç†ï¼Œåˆ†æç”¨æˆ·å†å²æ•°æ®ï¼Œè¿›è¡Œæ¨èç®—æ³•ç­‰æœºå™¨å­¦ä¹ ç®—æ³•æ¨¡å‹è®­ç»ƒä½¿ç”¨ï¼Œæ•°æ®ä»“åº“ä¸­æ ¹æ®ä¸åŒç»´åº¦å¯¹æ•°æ®è¿‡æ»¤èšåˆï¼Œè¿›è¡Œä¸Šå·ä¸‹é’»åˆ†æï¼Œæ¯”å¦‚è®¡ç®—DAU,WAU,MAUï¼Œè½¬åŒ–ç‡(è´­ä¹°ç‡ï¼Œæ³¨å†Œç‡)åˆ†æç­‰ï¼Œé€šå¸¸å¯¹æ•°æ®å»ºè®¾æŠ•å…¥å¤šçš„è¯ï¼Œ ä¼šæŠŠç”¨æˆ·äº§ç”Ÿçš„ç»“æ„åŒ–éç»“æ„åŒ–çš„æ•°æ®éƒ½å­˜ä¸‹ï¼Œæ”¾åœ¨ä¸€ä¸ªå¤§çš„æ± å­é‡Œå¾…ä½¿ç”¨æ—¶è¿›è¡Œåˆ†æï¼Œå³æ‰€è°“çš„æ•°æ®æ¹–ï¼Œå›´æ¹–è€Œå»ºæŒ–æ˜æ•°æ®ä»·å€¼ï¼›è€Œæ•°ä»“ç›¸å¯¹ç²¾ç»†åŒ–çš„åˆ†æï¼Œå‰ç½®å»ºæ¨¡å»ºè¡¨åˆ†æï¼›&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;å¯¹æ­¤è¿›è¡Œæ–¹æ¡ˆåˆ†æï¼Œæœ¬æ–‡å°†ä»‹ç»ä¸€ç§å®æ—¶ç¦»çº¿å¤„ç†åˆ†æç”¨æˆ·è¡Œä¸ºæ•°æ®æ–¹æ¡ˆï¼Œå³èƒ½å¸®åŠ©ä¼ä¸šä½æˆæœ¬åœ°ä½¿ç”¨æµ·é‡æ•°æ®ï¼Œåˆèƒ½æ›´å¿«é€Ÿåœ°å“åº”ä¸šåŠ¡éœ€æ±‚ï¼ŒåŒæ—¶å€ŸåŠ©äºšé©¬é€Šäº‘ç§‘æŠ€çš„æ‰˜ç®¡æœåŠ¡ï¼Œèƒ½å¤Ÿå¿«é€Ÿå®æ–½å’Œè½»æ¾è¿ç»´ã€‚&lt;/p&gt;
&lt;h3 id=&#34;æ“ä½œæ¦‚æ‹¬&#34;&gt;æ“ä½œæ¦‚æ‹¬&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;æƒé™è®¾ç½®ï¼šæ ¹æ®å…¬å¸ä¸šåŠ¡ç»„ç»‡ï¼Œåˆ†é…å¯¹åº”æœåŠ¡èµ„æºæƒé™ï¼Œæ¯”å¦‚ç³»ç»Ÿç®¡ç†å‘˜OP, å¼€å‘äººå‘˜DEV, è¿˜æœ‰ä¸šåŠ¡ç®¡ç†å‘˜OPï¼›ç»„ç»‡æ¶æ„æƒé™å»ºè®¾ï¼›&lt;/li&gt;
&lt;li&gt;æœåŠ¡åŸºç¡€æ¶æ„ï¼šé¦–å…ˆéœ€è¦æ­å¥½åŸºç¡€æœåŠ¡æ¡†æ¶ï¼Œç»“åˆäº‘å‚å•†æœåŠ¡ï¼Œè¿›è¡Œå¯æ°´å¹³å‚ç›´è‡ªåŠ¨æ‰©å±•ï¼Œé«˜å®¹é”™æ€§ï¼Œä½æˆæœ¬ï¼Œå¯è§‚æµ‹ç›‘æ§ï¼Œæ˜“äºç»´æŠ¤ï¼ŒæŒç»­é›†æˆå‘å¸ƒçš„ç¨³å®šæ€§æ¶æ„å»ºè®¾ï¼›&lt;/li&gt;
&lt;li&gt;ä¸šåŠ¡è¿­ä»£æ•°æ®å»ºè®¾å¼€å‘ï¼šæ¶å­æ­å¥½ä¹‹åï¼Œéœ€è¦å¯¹ç‰¹å®šçš„ä¸šåŠ¡åœºæ™¯è¿›è¡Œæ•°æ®å»ºæ¨¡ï¼ŒAIæ¨¡å‹è®­ç»ƒï¼ŒæŒ–æ˜å‡ºæ•°æ®çš„ä»·å€¼ï¼Œè¿›è¡Œå†³ç­–ï¼›æœåŠ¡ä»£ç è´¨é‡ï¼Œæ¡†æ¶å»ºè®¾ï¼›&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&#34;è§£å†³æ–¹æ¡ˆ&#34;&gt;è§£å†³æ–¹æ¡ˆ&lt;/h2&gt;
&lt;p&gt;ä½¿ç”¨aws ç°æœ‰äº§å“æœåŠ¡ç»„ä»¶è¿›è¡Œæ­å»ºï¼Œä¸»è¦åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼Œæ•°æ®é‡‡é›†ï¼Œæ•°æ®å¤„ç†å­˜å‚¨ï¼Œæ•°æ®åˆ†æï¼Œæ•´ä½“æ¶æ„å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://github.com/weedge/user-behavior-analytics-cdk/blob/master/docs/aws-user-behavior-analytics.drawio.png?raw=true&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;h3 id=&#34;æ•°æ®æºé‡‡é›†&#34;&gt;æ•°æ®æºé‡‡é›†&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;è®¿é—®æ—¥å¿—å’Œè¯·æ±‚äº‹ä»¶ï¼šç”¨æˆ·åœ¨æ‰‹æœºç«¯é€šè®¿CloudFront å†…å®¹åˆ†å‘æœåŠ¡, ä¼šç”Ÿæˆç”¨æˆ·è¡Œä¸º&lt;a href=&#34;https://docs.aws.amazon.com/zh_cn/AmazonCloudFront/latest/DeveloperGuide/AccessLogs.html&#34;&gt;è®¿é—®æ—¥å¿—&lt;/a&gt;ï¼Œè¿™äº›&lt;a href=&#34;https://docs.aws.amazon.com/zh_cn/AmazonCloudFront/latest/DeveloperGuide/real-time-logs.html&#34;&gt;å®æ—¶æ—¥å¿—&lt;/a&gt;ä¸­ä¼šæœ‰äº§å“ä¸­å®šä¹‰çš„è¡Œä¸ºåˆ†æåŸ‹ç‚¹è®°å½•äº‹ä»¶ï¼Œå­˜æ”¾åœ¨S3ä¸­ï¼Œé€šè¿‡Lambdaæ— æœåŠ¡å‡½æ•°å†™å…¥kinesis data streamsä¸­ï¼›å¦‚æœéœ€è¦å®æ—¶å¤„ç†ï¼Œéœ€è¦å¼€å¯&lt;a href=&#34;https://docs.aws.amazon.com/zh_cn/AmazonCloudFront/latest/DeveloperGuide/real-time-logs.html&#34;&gt;CloudFrontå®æ—¶æ—¥å¿—åŠŸèƒ½&lt;/a&gt;ï¼Œå°†æ•°æ®å†™å…¥Kinesis Data Streamsä¸­ï¼Œä¼šæœ‰å‡ ç§’çš„å¤„ç†å»¶æ—¶ï¼›è¿˜æœ‰ä¸€ç§æ–¹å¼æ˜¯æœåŠ¡ç«¯åœ¨çº¿å®æ—¶é€šè¿‡ä½¿ç”¨aws SDKæ–¹å¼ç›´æ¥å†™å…¥è®°å½•äº‹ä»¶æ•°æ®ï¼Œå¯é€šè¿‡æ— æœåŠ¡éƒ¨ç½²çš„lambdaå‡½æ•°å†™å…¥æˆ–è€…API gatewayé…ç½®å†™å…¥(å‚è€ƒ:&lt;a href=&#34;https://docs.aws.amazon.com/zh_cn/apigateway/latest/developerguide/integrating-api-with-aws-services-kinesis.html&#34;&gt;åœ¨ API Gateway ä¸­åˆ›å»º REST API ä½œä¸º Amazon Kinesis ä»£ç†&lt;/a&gt;)ï¼Œå¸¸ç”¨äºå®æ—¶å¼‚å¸¸æŠ¥è­¦å’Œç»Ÿè®¡ï¼›&lt;/li&gt;
&lt;li&gt;æ•°æ®åº“æ•°æ®ï¼š å­˜æ”¾åœ¨æ•°æ®åº“ä¸­çš„æ•°æ®ï¼Œéœ€è¦å°†æ•°æ®åŒæ­¥å­˜æ”¾åœ¨æ•°ä»“å’Œæ•°æ®æ¹–ä¸­ï¼Œè¿›è¡Œç¦»çº¿åˆ†æ; æ•°æ®åº“çš„æ•°æ®å¯ä»¥é€šè¿‡&lt;a href=&#34;https://docs.aws.amazon.com/zh_cn/dms/latest/userguide/CHAP_Introduction.html&#34;&gt;aws DMS&lt;/a&gt;æœåŠ¡æ¥æ”¯æŒå­˜é‡å¢é‡æ•°æ®åŒæ­¥è‡³Kinesis Data Streamsä¸­ï¼Œå…·ä½“æ–¹æ¡ˆå¯ä»¥å‚è€ƒ**&lt;a href=&#34;https://aws.amazon.com/cn/blogs/big-data/stream-change-data-to-amazon-kinesis-data-streams-with-aws-dms/&#34;&gt;ä½¿ç”¨ AWS DMS å°†æ›´æ”¹æ•°æ®æµå¼ä¼ è¾“åˆ° Amazon Kinesis Data Streams&lt;/a&gt;**ï¼›ä¹Ÿå¯ä»¥ä½¿ç”¨&lt;a href=&#34;https://ververica.github.io/flink-cdc-connectors/master/&#34;&gt;flink CDC connector&lt;/a&gt;  &lt;a href=&#34;https://docs.aws.amazon.com/zh_cn/emr/latest/ReleaseGuide/emr-flink.html&#34;&gt;on aws EMR&lt;/a&gt;æ”¯æŒåŒæ­¥(éœ€è¦ç†è§£åå‹æœºåˆ¶ï¼Œä»¥ä¾¿è§¦å‘æ—¶çœ‹æ˜¯å¦å¢å¤§ä¸‹æ¸¸æ¶ˆè´¹èƒ½åŠ›æé«˜åå), å¯å‚è€ƒ&lt;a href=&#34;https://aws.amazon.com/cn/blogs/china/best-practice-of-using-amazon-emr-cdc-to-enter-the-lake-in-real-time-in-a-multi-database-multi-table-scenario/&#34;&gt;å¤šåº“å¤šè¡¨åœºæ™¯ä¸‹ä½¿ç”¨Amazon EMR CDCå®æ—¶å…¥æ¹–æœ€ä½³å®è·µ&lt;/a&gt;ï¼Œæ³¨æ„æ•°æ®åº“è¡¨ä¸­çš„æ•°æ®å­—æ®µéœ€è¦è§„èŒƒï¼Œéœ€è¦ä¸€ä¸ªæ›´æ–°æ—¶é—´å­—æ®µæ–¹ä¾¿æ•°æ®é¡ºåºåŒæ­¥ï¼Œæ¯”å¦‚mysql &lt;code&gt;update_time timestamp DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP&lt;/code&gt;ï¼›&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;æ‚¨å¯ä»¥å‚é˜… AWS ç™½çš®ä¹¦&lt;a href=&#34;https://d1.awsstatic.com/whitepapers/aws-cloud-data-ingestion-patterns-practices.pdf&#34;&gt;AWS Cloud Data Ingestion Patterns and Practices&lt;/a&gt;ï¼Œäº†è§£æœ‰å…³æ•°æ®é‡‡é›†æ¨¡å¼çš„æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼›&lt;/p&gt;
&lt;p&gt;å°†æ•°æ®é‡‡é›†å†™å…¥æ¶ˆæ¯é˜Ÿåˆ—ä¸­ä¸»è¦æ˜¯æ–¹ä¾¿å¤šä¸ªæ¶ˆè´¹æ–¹æ¥å¤„ç†æµï¼Œä»¥åŠæœåŠ¡ä¹‹é—´çš„æ•´ä½“è§£è€¦ï¼Œå¯ä½œä¸ºæ•°æ®æµç¼“å­˜å±‚ï¼Œæ•°æ®æµé‡çªå¢æ—¶ï¼Œå¢åŠ åˆ†ç‰‡æ•°ï¼Œæé«˜ååï¼Œå½“ç„¶æ•´ä½“ååé‡ä¹Ÿå–å†³äºä¸‹æ¸¸æ•°æ®çš„æ¶ˆè´¹èƒ½åŠ›ï¼Œå¼•å…¥æ¶ˆæ¯é˜Ÿåˆ—ï¼Œä»¥pullæ–¹å¼è¿›è¡Œæ¶ˆè´¹(ä¸»åŠ¨æ¶ˆè´¹)ï¼Œä¸è‡³äºå°†ä¸‹æ¸¸æœåŠ¡æ‰“æŒ‚ï¼Œè€Œä¸”æ–¹ä¾¿ä¸‹æ¸¸å¼‚å¸¸æ¶ˆè´¹é‡å¯æ—¶ï¼Œç»§ç»­åœ¨æœªæ¶ˆè´¹ç‚¹å¼€å§‹æ¶ˆè´¹ï¼›è¿™é‡Œæä¾›ä¸¤ç§æ–¹æ¡ˆï¼Œä¸€ç§å°†æ•°æ®å†™å…¥Kinesis Data Streamsä¸­ï¼Œä¸€ç§å°†æ•°æ®å†™å…¥&lt;a href=&#34;https://docs.aws.amazon.com/zh_cn/msk&#34;&gt;MSK&lt;/a&gt;(aws æ‰˜ç®¡çš„kafkaé›†ç¾¤æœåŠ¡ï¼Œå¦‚æœç›´æ¥è‡ªå·±æ­å»ºç»´æŠ¤ï¼Œæˆæœ¬æ¯”è¾ƒé«˜ï¼Œå¯¹æ¥å…¶ä»–awsæœåŠ¡ç›¸å¯¹å¤æ‚äº›) ä¸­ï¼›&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;æ•°æ®å†™å…¥Kinesis Data Streamsä¸­ä¸»è¦æ˜¯æ–¹ä¾¿å¤šä¸ªæ¶ˆè´¹æ–¹æ¥å¤„ç†æµï¼Œä»¥åŠæœåŠ¡ä¹‹é—´çš„æ•´ä½“è§£è€¦ï¼Œæ•°æ®æµç¼“å­˜å±‚ï¼Œæ›´é‡è¦çš„æ˜¯æ–¹ä¾¿ä½¿ç”¨aws Kinesisæ–¹æ¡ˆï¼Œå‡å°‘è¿ç»´æˆæœ¬ï¼Œå¯¹æ¥ä¹Ÿä¸°å¯Œï¼Œä¸»è¦æ˜¯æ–¹ä¾¿å¯¹æ¥å†…éƒ¨Kinesisç›¸å…³æœåŠ¡ç»„ä»¶;&lt;/li&gt;
&lt;li&gt;æ•°æ®å†™å…¥MSKä¸­ï¼Œä½¿ç”¨çš„å¼€æºè§£å†³æ–¹æ¡ˆå¯¹æ¥ï¼›ä¸‹æ¸¸å¯¹æ¥kinesis Data Analytics æœåŠ¡éœ€è¦é€šè¿‡flink è®¡ç®—å¼•æ“åŠ è½½å¯¹åº”kafka connectoråŒ…ï¼Œä»kafkaä¸­è·å–æ•°æ®æºè¿›è¡Œåˆ†æï¼›å¦‚æœä¸‹æ¸¸å¯¹æ¥å…¶ä»–æœåŠ¡ï¼Œæ¯”å¦‚ï¼šKinesis Data Firehoseï¼Œå°†æ•°æ®ä¼ è¾“è½¬åŒ–å†™å…¥æ•°æ®æ¹–S3ä¸­å­˜å‚¨ï¼Œå†™å…¥Redshiftæ•°ä»“ä¸­åˆ†æï¼›ä½¿ç”¨SNS è¿›è¡ŒæŠ¥è­¦ç­‰ï¼› éœ€è¦å¼•å…¥æ— æœåŠ¡æ¡†æ¶lambdaå‡½æ•°ï¼Œé€šè¿‡ä½¿ç”¨&lt;a href=&#34;https://docs.confluent.io/platform/current/clients/index.html&#34;&gt;kafka client SDKåº“&lt;/a&gt;æ¥è¿›è¡Œç”Ÿäº§/æ¶ˆè´¹å¤„ç†ï¼›&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;å…·ä½“ä½¿ç”¨ç»“åˆå…¬å¸å®é™…åœºæ™¯è€Œå®šï¼Œå¦‚æœæƒ³æƒ³é€šè¿‡kafkaå¯¹æ¥æ›´å¤šçš„å¼€æºå¤§æ•°æ®æœåŠ¡æ¡†æ¶ï¼Œ å¯ä»¥é€‰æ‹©MSKæ–¹æ¡ˆï¼Œé¢å¤–éœ€è¦å¼€å‘ç»´æŠ¤lambdaå‡½æ•°æœåŠ¡ï¼›ä½¿ç”¨Kinesis Data streams å¾ˆæ–¹ä¾¿æ¥å…¥awsç›¸å…³æœåŠ¡ï¼Œå‡å°‘é¢å¤–çš„å¼€å‘ç»´æŠ¤æˆæœ¬ï¼Œä¸è¿‡å¦‚æœå¯¹æ¥å…¶ä»–å¼€æºå¤§æ•°æ®æœåŠ¡æ¡†æ¶ï¼ŒåŒæ ·éœ€è¦å¼•å…¥lambdaå‡½æ•°æœåŠ¡ï¼›æœ¬æ–‡é‡‡ç”¨å°†æ•°æ®å†™å…¥Kinesis Data streams æœåŠ¡ï¼Œæä¾›ç»™ä¸‹æ¸¸å¯¹æ¥ã€‚&lt;/p&gt;
&lt;h3 id=&#34;æ•°æ®å¤„ç†å­˜å‚¨&#34;&gt;æ•°æ®å¤„ç†å­˜å‚¨&lt;/h3&gt;
&lt;p&gt;æ•°æ®å¤„ç†åˆ†æï¼Œåˆ†ä¸ºå®æ—¶å¤„ç†çš„&lt;a href=&#34;https://aws.amazon.com/cn/streaming-data/&#34;&gt;æµæ•°æ®&lt;/a&gt;å’Œç¦»çº¿å¤„ç†æ‰¹æ•°æ®å¤„ç†å­˜æ”¾ï¼›&lt;/p&gt;
&lt;p&gt;å®æ—¶å¤„ç†ä½¿ç”¨AWS Kinesisi Data Analytics(KDA)è¿›è¡Œåˆ†æï¼Œæ”¯æŒä¸‰ç§åˆ†ææ–¹å¼ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;ä½¿ç”¨è€çš„æ–¹å¼&lt;a href=&#34;https://docs.aws.amazon.com/zh_cn/kinesisanalytics/latest/dev/what-is.html&#34;&gt;SQL åº”ç”¨ç¨‹åº&lt;/a&gt;è¿›è¡Œåˆ†æå¤„ç†ï¼Œä¸èƒ½ä½¿ç”¨ç¼–ç¨‹è¯­è¨€python/Scalaæ¥è°ƒç”¨apiæ¥è¿›è¡Œç²¾ç»†åŒ–æ“ä½œ(éœ€è¦å®šä¹‰UDFåŒ…æä¾›ä½¿ç”¨),ä»¥åŠå³å¸­æŸ¥è¯¢ï¼›&lt;/li&gt;
&lt;li&gt;ä½¿ç”¨åŸºäº &lt;a href=&#34;https://flink.apache.org/&#34;&gt;Apache Flink&lt;/a&gt; çš„å¼€æºåº“åœ¨ Kinesis Data Analytics ä¸­æ„å»º Java ,Scala å’ŒPython åº”ç”¨ç¨‹åº,Apache Flink æ˜¯å¤„ç†æ•°æ®æµçš„å¸¸ç”¨æ¡†æ¶å’Œå¼•æ“ï¼ŒKinesis Data Analyticsç°ä½¿ç”¨flinkæ”¯æŒæœ€é«˜ç‰ˆæœ¬æ˜¯&lt;a href=&#34;https://nightlies.apache.org/flink/flink-docs-release-1.13/docs/learn-flink/overview/&#34;&gt;1.13&lt;/a&gt;ï¼›åœ¨å¼€å‘åº”ç”¨æ—¶ï¼Œéœ€è¦æ‰“å°æ—¥å¿—ï¼Œä»¥ä¾¿ä½¿ç”¨CloudWatch æ—¥å¿—ç›‘æ§åº”ç”¨ç¨‹åºçš„æ€§èƒ½å’Œé”™è¯¯çŠ¶å†µï¼›å¦‚æœåº”ç”¨ç¨‹åºå‡ºç°bugæˆ–è€…æœåŠ¡å¼‚å¸¸ä¸­æ–­å¯ä»¥ä½¿ç”¨æ£€æŸ¥ç‚¹(&lt;a href=&#34;https://nightlies.apache.org/flink/flink-docs-release-1.13/docs/ops/state/checkpoints/&#34;&gt;CheckPoints&lt;/a&gt;)å’Œä¿å­˜ç‚¹(&lt;a href=&#34;https://nightlies.apache.org/flink/flink-docs-release-1.13/docs/ops/state/savepoints/&#34;&gt;SavePoints&lt;/a&gt; ç”Ÿæˆ&lt;a href=&#34;https://docs.aws.amazon.com/zh_cn/kinesisanalytics/latest/java/how-fault-snapshot.html&#34;&gt;å¿«ç…§&lt;/a&gt;)åœ¨ Kinesis Data Analytics åº”ç”¨ç¨‹åºä¸­å®ç°å®¹é”™åŠŸèƒ½; åŒæ—¶Kinesis Data Analytics &lt;a href=&#34;https://docs.aws.amazon.com/zh_cn/kinesisanalytics/latest/java/how-scaling.html&#34;&gt;&lt;strong&gt;å¯å¼¹æ€§æ‰©ç¼©&lt;/strong&gt;&lt;/a&gt;åº”ç”¨ç¨‹åºçš„å¹¶è¡Œåº¦ï¼Œä»¥é€‚åº”å¤§å¤šæ•°åœºæ™¯ä¸‹çš„æºæ•°æ®ååé‡å’Œæ“ä½œå¤æ‚æ€§ï¼ŒKinesis Data Analytics ç›‘æ§åº”ç”¨ç¨‹åºçš„èµ„æº (CPU) ä½¿ç”¨æƒ…å†µï¼Œå¹¶ç›¸åº”åœ°å¼¹æ€§åœ°å‘ä¸Šæˆ–å‘ä¸‹æ‰©å±•åº”ç”¨ç¨‹åºçš„å¹¶è¡Œåº¦; ä½¿ç”¨ç®—å­(&lt;a href=&#34;https://nightlies.apache.org/flink/flink-docs-release-1.13/docs/dev/datastream/operators/overview/#operators&#34;&gt;operators&lt;/a&gt;)è¿›è¡Œæ•°æ®æµæ‹“æ‰‘è®¡ç®—ï¼›åŒæ—¶é€šè¿‡&lt;a href=&#34;https://nightlies.apache.org/flink/flink-docs-release-1.13/docs/connectors/datastream/overview/&#34;&gt;connector&lt;/a&gt;å¯ç›´æ¥å¼•å…¥jaråŒ…æ¥å…¥æ•°æ®æºæˆ–è€…sinkåˆ°ä¸‹æ¸¸æœåŠ¡ï¼Œå¯ä»¥åœ¨mvnåº“ä¸­æ‰¾åˆ°ï¼Œæ¯”å¦‚&lt;a href=&#34;https://mvnrepository.com/artifact/org.apache.flink/flink-sql-connector-kinesis&#34;&gt;kinesis stream connector&lt;/a&gt;;&lt;/li&gt;
&lt;li&gt;åœ¨åŸºäº &lt;a href=&#34;https://flink.apache.org/&#34;&gt;Apache Flink&lt;/a&gt; çš„å¼€æºåº“æ„å»ºåº”ç”¨ç¨‹åºçš„åŸºç¡€ä¸Šï¼Œç»“åˆ&lt;a href=&#34;https://docs.aws.amazon.com/zh_cn/glue/latest/dg/how-it-works.html&#34;&gt;Glue&lt;/a&gt;å®šä¹‰æ•°æ®åº“è¡¨å­˜æ”¾æ•°æ®catalogå…ƒæ•°æ®ï¼Œé€šè¿‡&lt;a href=&#34;https://zeppelin.apache.org/&#34;&gt;zeppelin&lt;/a&gt;å¢åŠ äº†å¯è§†åŒ–å³å¸­æŸ¥è¯¢, ç›´æ¥å¯ä»¥åœ¨notebookä¸Šç¼–å†™flink æµ/æ‰¹**&lt;a href=&#34;https://nightlies.apache.org/flink/flink-docs-master/docs/dev/table/sql/overview/&#34;&gt;SQL&lt;/a&gt;**(notice: **flinkSQLå’ŒKDA SQLæœ‰æ‰€ä¸åŒï¼Œç‰¹åˆ«æ˜¯åœ¨windowä¸Šæœ‰äº›åŒºåˆ«**), ä»¥åŠç¼–å†™è°ƒç”¨flink APIçš„Scala,Pythonç¨‹åº, å…·ä½“è§&lt;a href=&#34;https://zeppelin.apache.org/docs/0.9.0/interpreter/flink.html&#34;&gt;zeppelin flinkè§£é‡Šå™¨&lt;/a&gt;; è¿™ç§æ–¹å¼æ˜¯ç›¸å¯¹äºç¬¬äºŒç§æ–¹å¼ï¼Œåœ¨æ–¹ä¾¿è¿ç»´ç®¡ç†çš„åŸºç¡€ä¸Šæ›´åŠ å®¹æ˜“ä¸Šæ‰‹ï¼Œç›´æ¥åœ¨notebookä¸Šå°±å¯ä»¥è¿›è¡Œå³å¸­æŸ¥è¯¢, æŸ¥è¯¢ä¼šè¯è¿˜å¯ä»¥ä¿ç•™æˆ–å­˜æ”¾æœ¬åœ°ï¼Œè¿˜å¯ä»¥ä½œä¸ºæµ‹è¯•å¼€å‘è°ƒè¯•çš„å¹³å°ï¼Œæ„å»ºå¥½å¤„ç†ç¨‹åºï¼Œå¯ç›´æ¥è½¬åŒ–æˆ&lt;a href=&#34;https://docs.aws.amazon.com/zh_cn/kinesisanalytics/latest/java/how-notebook-durable.html&#34;&gt;æŒä¹…åŒ–çš„åº”ç”¨ç¨‹åºéƒ¨ç½²&lt;/a&gt;ï¼›å½“ç„¶è¿™éƒ¨åˆ†è´¹ç”¨ç›¸æ¯”å‰é¢çš„åˆ†ææ–¹å¼ç›¸å¯¹å¤šäº›ï¼Œå¯åŠ¨çš„studio notebook è´¹ç”¨ï¼ŒKinesis å¤„ç†å•å…ƒ(KPU)å°†æŒ‰å°æ—¶æ”¶è´¹ï¼›å¯å‚è€ƒ&lt;a href=&#34;https://docs.aws.amazon.com/kinesisanalytics/latest/java/how-zeppelin-examples.html&#34;&gt;å®ä¾‹æ•™ç¨‹&lt;/a&gt;ï¼Œ&lt;a href=&#34;https://aws.amazon.com/cn/blogs/big-data/query-your-data-streams-interactively-using-kinesis-data-analytics-studio-and-python/&#34;&gt;ä½¿ç”¨ Kinesis Data Analytics Studio å’Œ Python ä»¥äº¤äº’æ–¹å¼æŸ¥è¯¢æ•°æ®æµ&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;æ•´ä½“æ¥è¯´ï¼š &lt;a href=&#34;https://aws.amazon.com/kinesis/data-analytics/&#34;&gt;Amazon Kinesis Data Analytics&lt;/a&gt; å¯ä»¥è½»æ¾åœ°å®æ—¶åˆ†ææµæ•°æ®ï¼Œå¹¶ä½¿ç”¨æ ‡å‡† SQLã€Python å’Œ Scala æ„å»ºç”± Apache Flink æä¾›æ”¯æŒçš„æµå¤„ç†åº”ç”¨ç¨‹åºã€‚ç‰¹åˆ«æ˜¯notebookåŠŸèƒ½åªéœ€åœ¨AWS ç®¡ç†æ§åˆ¶å°ä¸­å•å‡»å‡ ä¸‹ï¼Œå†™ä¸‹åˆ†æSQLï¼Œå°±å¯ä»¥å¯åŠ¨æ— æœåŠ¡å™¨ç¬”è®°æœ¬æ¥æŸ¥è¯¢æ•°æ®æµå¹¶åœ¨å‡ ç§’é’Ÿå†…è·å¾—ç»“æœã€‚Kinesis Data Analytics é™ä½äº†æ„å»ºå’Œç®¡ç† Apache Flink åº”ç”¨ç¨‹åºçš„å¤æ‚æ€§ã€‚&lt;/p&gt;
&lt;p&gt;ç¦»çº¿å¤„ç†çš„æ•°æ®ä¸»è¦æ˜¯é€šè¿‡&lt;a href=&#34;&#34;&gt;AWS Kinesis Data Firehose&lt;/a&gt; ä¼ è¾“æµå†™å…¥ä¸‹æ¸¸æœåŠ¡å­˜å‚¨ï¼Œå°†æ•°æ®å†™å…¥æ¹–ä»“ç³»ç»Ÿä¸­, ç”¨äºåç»­çš„æ•°æ®åˆ†æï¼Œä»¥åŠå‰æœŸè§„åˆ’å¥½çš„æ•°æ®åˆ†æï¼›é€‰ç”¨firehoseçš„åŸå› æ˜¯æœ‰åŸå§‹å¤‡ä»½æœºåˆ¶å­˜æ”¾äºS3ä¸­ï¼Œå³ä½¿æ•°æ®ä¼ è¾“é”™è¯¯æ—¶ï¼Œæ•°æ®ä¼ è¾“ä¸­ä¸ä¼šä¸¢å¤±æ•°æ®ï¼ŒåŒæ—¶å†…ç½®lambdå‡½æ•°åœ¨ä¼ è¾“ä¹‹å‰å°†æ•°æ®è½¬åŒ–å¤„ç†ï¼ŒåŒæ—¶ä¹Ÿæ”¯æŒç”¨Glueå®šä¹‰è¡¨æ¥è½¬æ¢å¤§æ•°æ®ç›¸å…³çš„è®°å½•æ ¼å¼;&lt;/p&gt;
&lt;p&gt;åŸå§‹åˆ†ææ•°æ®ç›´æ¥å­˜æ”¾äº&lt;a href=&#34;https://docs.aws.amazon.com/zh_cn/AmazonS3/latest/userguide/Welcome.html&#34;&gt;S3&lt;/a&gt;ä¸­ï¼Œ11ä¸ª9çš„ä¿éšœå¯ä»¥éå¸¸å¯é ä¿è¯æ•°æ®ä¸ä¸¢å¤±ï¼Œé€šè¿‡&lt;a href=&#34;https://aws.amazon.com/cn/s3/storage-classes/glacier/&#34;&gt;Glacier&lt;/a&gt;æŒä¹…å†·çƒ­å­˜æ”¾ï¼Œé™ä½æˆæœ¬ï¼Œæ–¹ä¾¿åé¢è¿½æŸ¥æ•°æ®ï¼Œä»¥åŠé€šè¿‡AthenaæŸ¥è¯¢å¼•æ“ç»“åˆGlueæ¥å®šä¹‰è¡¨ä»S3ä¸­æŒ–æ˜å‡ºæ›´æœ‰ä»·å€¼çš„æ•°æ®ï¼›æ•°æ®å­˜æ”¾ä¸‹æ¥ä¹‹åï¼Œç»“åˆå¤§æ•°æ®ç›¸å…³å¹³å°ï¼Œ&lt;a href=&#34;https://docs.aws.amazon.com/zh_cn/emr/latest/ManagementGuide/emr-what-is-emr.html&#34;&gt;EMR&lt;/a&gt;è¿›è¡Œæµ·é‡æ•°æ®å¤„ç†(PBçº§åˆ«)ï¼›åŒæ—¶ç»“åˆ&lt;a href=&#34;https://docs.aws.amazon.com/zh_cn/glue/latest/dg/what-is-glue.html&#34;&gt;Glue&lt;/a&gt; è¿›è¡ŒETL æ•°æ®å¤„ç†ï¼Œé›†æˆç¼–æ’æˆDAGå·¥ä½œæµï¼Œå¯è§†åŒ–ç®¡ç†è¿™äº›ETLä»»åŠ¡ä½œä¸šï¼Œä¹Ÿå¯ä»¥è¿ç§»è°ƒåº¦å¹³å°æ¯”å¦‚Azkabançš„å·¥ä½œæµè¿ç§»è‡³Glue ETLå·¥ä½œæµ,å‚è€ƒ&lt;a href=&#34;https://aws.amazon.com/cn/blogs/china/preliminary-study-on-selection-of-aws-glue-scheduling-tool/&#34;&gt;Amazon Glue ETLä½œä¸šè°ƒåº¦å·¥å…·é€‰å‹åˆæ¢&lt;/a&gt;ï¼›&lt;/p&gt;
&lt;p&gt;æå‰ä¸šåŠ¡åœºæ™¯æ•°æ®åˆ†æå»ºæ¨¡ï¼Œä½¿ç”¨&lt;a href=&#34;https://docs.aws.amazon.com/zh_cn/redshift/latest/gsg/concepts-diagrams.html&#34;&gt;Redshift&lt;/a&gt;æ¥å­˜æ”¾ä¸åŒç»´åº¦(DIM)çš„è¡¨ï¼Œåˆ†å±‚(ODS-&amp;gt;&lt;strong&gt;DWD-&amp;gt;DWM-&amp;gt;DWS&lt;/strong&gt;)å»ºè®¾æ•°æ®ä»“åº“ï¼› é€‰ç”¨redshiftæ€§ä»·æ¯”æ¯”è¾ƒé«˜ï¼Œå¼€ç®±å³ç”¨ï¼Œå­˜æ”¾ç»“æ„åŒ–ï¼ŒåŠç»“æ„åŒ–æ•°æ®ï¼Œæ•°æ®åˆ—å¼å­˜å‚¨ï¼Œåˆ†ç‰‡å­˜æ”¾ï¼Œè®¡ç®—å’Œå­˜å‚¨åˆ†ç¦»ï¼Œå¾ˆæ–¹ä¾¿æ— æœåŠ¡åŒ–ï¼Œåœ¨æ•°ç§’å†…è½»æ¾è¿è¡Œå’Œæ‰©å±•åˆ†æï¼Œè€Œæ— éœ€è°ƒé…å’Œç®¡ç†æ•°æ®ä»“åº“; å’Œæ•°æ®æ¹–æ‰“é€šï¼Œå¯ä»¥ä½¿ç”¨ &lt;a href=&#34;https://docs.aws.amazon.com/zh_cn/redshift/latest/gsg/data-lake.html&#34;&gt;Redshift Spectrum&lt;/a&gt; åœ¨ Amazon S3 æ–‡ä»¶ä¸­æŸ¥è¯¢æ•°æ®ï¼Œè€Œä¸å¿…å°†æ•°æ®åŠ è½½åˆ° Amazon Redshift è¡¨ä¸­ï¼Œæé«˜å…³è”æŸ¥è¯¢ï¼›è¿˜å¯ä»¥å¯¹æ¥æœºå™¨å­¦ä¹ &lt;a href=&#34;https://docs.aws.amazon.com/zh_cn/redshift/latest/dg/machine_learning.html&#34;&gt;ML&lt;/a&gt;ï¼Œé€šè¿‡CREATE MODEL DDLè¯­å¥ä¸‹æ¨åˆ°Amazon &lt;a href=&#34;https://docs.aws.amazon.com/zh_cn/sagemaker/latest/dg/whatis.html&#34;&gt;SageMaker&lt;/a&gt;ï¼Œä»S3ä¸­åŠ è½½æ•°æ®è¿›è¡Œè®­ç»ƒï¼›&lt;/p&gt;
&lt;h3 id=&#34;æ•°æ®åˆ†æ&#34;&gt;æ•°æ®åˆ†æ&lt;/h3&gt;
&lt;p&gt;ä¸»è¦æ˜¯é€šè¿‡åˆ†æå¼•æ“ä»æ•°æ®å­˜å‚¨è·å–æ•°æ®ï¼Œæ ¹æ®ç»´åº¦å±•ç°çœ‹æ¿ï¼Œè¿›è¡Œå®æ—¶æ•°æ®æŸ¥çœ‹ï¼Œç¦»çº¿åˆ†æï¼Œä»¥åŠå¯è§†åŒ–å³å¸­åˆ†æï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;å®æ—¶ç»“æœæ•°æ®æŸ¥çœ‹ï¼šé€šè¿‡&lt;a href=&#34;https://docs.aws.amazon.com/zh_cn/amazondynamodb/latest/developerguide/Introduction.html&#34;&gt;DynamoDB&lt;/a&gt;è·å–å®æ—¶ç»“æœæ•°æ®ï¼Œä¸»è¦æ˜¯Key/Valueæ•°æ®ï¼ŒåŒæ—¶æŸ¥è¯¢é€Ÿåº¦å¾ˆå¿«ï¼Œåˆ©ç”¨&lt;a href=&#34;https://docs.aws.amazon.com/zh_cn/amazondynamodb/latest/developerguide/DAX.html&#34;&gt;DAX&lt;/a&gt;å®ç°å†…å­˜ä¸­åŠ é€Ÿï¼›é€šè¿‡&lt;a href=&#34;https://docs.aws.amazon.com/zh_cn/lambda/latest/dg/welcome.html&#34;&gt;lambda&lt;/a&gt;å¯¹æ¥&lt;a href=&#34;https://docs.aws.amazon.com/zh_cn/apigateway/latest/developerguide/welcome.html&#34;&gt;API Gateway&lt;/a&gt;æä¾›æ•°æ®æ¥å£ï¼Œæ–¹ä¾¿ä¸šåŠ¡åœºæ™¯å®æ—¶å±•ç°ï¼Œæ¯”å¦‚ç›‘æ§æŸ¥çœ‹å¼‚å¸¸æ•°æ®ï¼Œè®¿é—®è®¡æ•°ç­‰ç»“æœå±•ç°ï¼›è¿™äº›ç»“æœæ•°æ®å¯ä»¥ç›´æ¥é€šè¿‡&lt;a href=&#34;https://docs.aws.amazon.com/zh_cn/sns/latest/dg/welcome.html&#34;&gt;SNS&lt;/a&gt;å‘é€é‚®ä»¶æˆ–è€…çŸ­ä¿¡è¿›è¡Œé€šçŸ¥ï¼›&lt;/li&gt;
&lt;li&gt;é€šè¿‡&lt;a href=&#34;https://docs.aws.amazon.com/zh_cn/opensearch-service/latest/developerguide/what-is.html&#34;&gt;OpenSearch&lt;/a&gt;æä¾›å®æ—¶æœç´¢æœåŠ¡ï¼Œæ¯”å¦‚æ—¥å¿—æœç´¢å®æ—¶å®šä½è¿½æŸ¥é—®é¢˜ï¼Œé€šè¿‡KDAå®æ—¶åˆ†æå†™å…¥ï¼›åœ¨çº¿æ£€ç´¢å•†å“ï¼Œè¿™äº›æ•°æ®ä¸»è¦æ¥æºäºæ•°æ®åº“ï¼Œå¼‚æ„æˆOpenSearchç´¢å¼•æ•°æ®è¿›è¡Œæ£€ç´¢ï¼Œå¯é€šè¿‡&lt;a href=&#34;https://ververica.github.io/flink-cdc-connectors/master/&#34;&gt;flink CDC&lt;/a&gt; on &lt;a href=&#34;https://docs.aws.amazon.com/zh_cn/emr/latest/ReleaseGuide/emr-flink.html&#34;&gt;EMR&lt;/a&gt;æ¥åŒæ­¥æ•°æ®åˆ°OpenSearchä¸­ï¼›&lt;/li&gt;
&lt;li&gt;S3ä¸­çš„æ•°æ®é€šè¿‡&lt;a href=&#34;https://docs.aws.amazon.com/zh_cn/athena/latest/ug/what-is.html&#34;&gt;Athena&lt;/a&gt;åœ¨Glue/Hiveä¸Šå»ºè¡¨å…ƒæ•°æ®ï¼Œä½¿ç”¨&lt;a href=&#34;https://docs.aws.amazon.com/zh_cn/athena/latest/ug/ddl-sql-reference.html&#34;&gt;SQL&lt;/a&gt;æŸ¥è¯¢ï¼Œå‡ åˆ†é’Ÿå†…å¯ä»¥æŸ¥è¯¢åˆ°ç»“æœ;&lt;/li&gt;
&lt;li&gt;å­˜æ”¾åœ¨&lt;a href=&#34;https://docs.aws.amazon.com/zh_cn/redshift/latest/gsg/concepts-diagrams.html&#34;&gt;Redshift&lt;/a&gt;æ•°æ®ä»“åº“ä¸­çš„æ•°æ®ï¼Œé€šè¿‡Amazon &lt;a href=&#34;https://docs.aws.amazon.com/zh_cn/quicksight/latest/user/welcome.html&#34;&gt;QuickSight&lt;/a&gt;æ¥å…¥è¿›è¡ŒBIåˆ†æï¼Œå“åº”æ—¶é—´åœ¨ç§’çº§åˆ«ï¼Œåªéœ€è¦åœ¨ç•Œé¢ä¸Šé€‰æ‹©å›¾è¡¨ç»„åˆæˆä¸€ä¸ªä»ªè¡¨ç›˜å±•ç°å³å¯ï¼Œæ–¹ä¾¿å¿«é€Ÿå†³ç­–ï¼›&lt;a href=&#34;https://docs.aws.amazon.com/zh_cn/quicksight/latest/user/regions.html&#34;&gt;æ”¯æŒAWSåŒºåŸŸæ¥å…¥IPèŒƒå›´&lt;/a&gt;;&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&#34;ç»„ç»‡ç”¨æˆ·è§’è‰²æƒé™ç®¡ç†&#34;&gt;ç»„ç»‡ç”¨æˆ·è§’è‰²æƒé™ç®¡ç†&lt;/h3&gt;
&lt;p&gt;ä»¥ä¸Šè¿™äº›è°ˆåˆ°çš„æœåŠ¡éœ€è¦è¿›è¡Œå®‰å…¨è®¿é—®ï¼Œé€šè¿‡&lt;a href=&#34;https://docs.aws.amazon.com/zh_cn/iam/&#34;&gt;IAM&lt;/a&gt;å®šä¹‰ç­–ç•¥è§’è‰²åˆ†é…æƒé™è¿›è¡Œ&lt;a href=&#34;https://docs.aws.amazon.com/zh_cn/service-authorization/latest/reference/reference.html&#34;&gt;æœåŠ¡æˆæƒ&lt;/a&gt;ï¼Œæ¥è¿›è¡Œå®‰å…¨è®¿é—®ï¼Œæœ‰ä¸¤ç§æƒ…å†µï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;æœåŠ¡èµ„æºä¹‹é—´çš„è®¿é—®ï¼Œéœ€è¦åˆ†é…è¯»å†™æƒé™ï¼Œéœ€è¦æŠŠè¿™äº›ç­–ç•¥èµ‹äºˆè«ä¸ªè§’è‰²ï¼Œç„¶åèµ„æºé€šè¿‡è¿™ä¸ªèµ‹äºˆèµ„æºæƒé™çš„è§’è‰²æ¥è®¿é—®å¯¹åº”èµ„æºï¼›&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;è¿˜æœ‰å°±æ˜¯æ“ä½œè€…è®¿é—®æœåŠ¡èµ„æºï¼Œéœ€è¦åˆ†é…ä¸åŒèµ„æºçš„è¯»å†™æƒé™ï¼Œå¯ä»¥æ ¹æ®å…¬å¸ç»„ç»‡æ¶æ„æ¥ç®¡ç†æ¯ä¸ªå‘˜å·¥çš„æƒé™ä½¿ç”¨èŒƒå›´ï¼Œéå¸¸æ–¹ä¾¿ï¼›&lt;/p&gt;
&lt;p&gt;è§’è‰²æƒé™è®¾ç½®è§„åˆ™å¦‚ä¸‹ï¼š&lt;a href=&#34;https://docs.aws.amazon.com/zh_cn/IAM/latest/UserGuide/id.html&#34;&gt;IAMèº«ä»½&lt;/a&gt;è®¾ç½®ç”¨æˆ·ç»„ dev, op, biz userï¼Œåç»­ ç»†åˆ†åœ¨æŒ‰ç»„ç»‡éƒ¨é—¨è¿›è¡Œå»ºç»„ï¼›&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;op: ç†è®ºä¸Šæ„å»ºå®Œä¸€ç»„èµ„æºå¯ä»¥åˆ†é…å¯¹åº”æƒé™ç­–ç•¥è§’è‰²Roleï¼Œç»™äºˆæœåŠ¡èµ„æºçš„è¿ç»´ç®¡ç†æ“ä½œï¼›&lt;/li&gt;
&lt;li&gt;dev: åªæœ‰ä½¿ç”¨å¼€å‘èµ„æºæƒé™ï¼Œæ¯”å¦‚lambdaç¼–è¾‘å‘å¸ƒæƒé™ï¼Œæ•°æ®åº“è¯»å†™æƒé™ï¼Œè€Œéç®¡ç†åˆ é™¤æƒé™ç­–ç•¥Roleï¼›&lt;/li&gt;
&lt;li&gt;bizUser: ä¸šåŠ¡æ“ä½œè€…ï¼Œå¤§éƒ¨åˆ†åªæœ‰è¯»æƒé™ç­–ç•¥Roleï¼Œæ²¡æœ‰å†™æ“ä½œæƒé™ï¼›&lt;/li&gt;
&lt;li&gt;admin: ç®¡ç†å‘˜ï¼ŒAdministratoræƒé™ï¼Œå¯ä»¥è®¿é—®ä»»ä½•èµ„æº&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;è¿˜æœ‰æ˜¯åˆ›å»ºçš„åº”ç”¨æ˜¯ç»™å¤–éƒ¨æœåŠ¡ç”¨æˆ·ä½¿ç”¨ï¼Œæ¯”å¦‚Web,ç§»åŠ¨ç«¯ç”¨æˆ·ï¼Œé€šè¿‡Amazon &lt;a href=&#34;https://docs.aws.amazon.com/zh_cn/cognito/&#34;&gt;Cognito&lt;/a&gt;æ¥æ³¨å†Œç™»å½•ç®¡ç†ç”¨æˆ·ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ç¬¬ä¸‰æ–¹ç™»å½•è¿›è¡Œèº«ä»½éªŒè¯ï¼›ä¸¤ä¸ªä¸»è¦ç»„ä»¶æ˜¯ç”¨æˆ·æ± å’Œèº«ä»½æ± ï¼šç”¨æˆ·æ± æ˜¯ä¸ºåº”ç”¨ç¨‹åºæä¾›æ³¨å†Œå’Œç™»å½•é€‰é¡¹çš„ç”¨æˆ·ç›®å½•ï¼Œèº«ä»½æ± æˆäºˆç”¨æˆ·è®¿é—®å…¶ä»– AWS æœåŠ¡çš„æƒé™ã€‚è¯·å‚è€ƒ&lt;a href=&#34;https://docs.aws.amazon.com/zh_cn/cognito/latest/developerguide/cognito-scenarios.html&#34;&gt;Amazon Cognitoå¸¸è§åœºæ™¯&lt;/a&gt;ã€‚&lt;/p&gt;
&lt;h2 id=&#34;åœºæ™¯&#34;&gt;åœºæ™¯&lt;/h2&gt;
&lt;h3 id=&#34;case-å®æ—¶å¼‚å¸¸äº‹ä»¶æŠ¥è­¦å±•ç°&#34;&gt;CASE å®æ—¶å¼‚å¸¸äº‹ä»¶æŠ¥è­¦å±•ç°&lt;/h3&gt;
&lt;p&gt;æ‰“ç‚¹äº‹ä»¶æ•°æ®ï¼šï¼ˆå®ä½“æ•°æ®ï¼Œé€šè¿‡åŒæ­¥å®ä½“è¡¨æ•°æ®æµè¿›è¡Œå…³è”jionæ“ä½œï¼‰&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;field&lt;/th&gt;
&lt;th&gt;type&lt;/th&gt;
&lt;th&gt;desc&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;eventId&lt;/td&gt;
&lt;td&gt;string&lt;/td&gt;
&lt;td&gt;ç”¨æˆ·è¡Œä¸ºäº‹ä»¶id&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;action&lt;/td&gt;
&lt;td&gt;string&lt;/td&gt;
&lt;td&gt;ç»Ÿä¸€å®šä¹‰çš„äº‹ä»¶åŠ¨ä½œï¼Œæ¯”å¦‚ æµè§ˆæ–‡æ¡£ï¼šviewDoc&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;userId&lt;/td&gt;
&lt;td&gt;string&lt;/td&gt;
&lt;td&gt;è§¦å‘äº‹ä»¶çš„ç”¨æˆ·id&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;createdAt&lt;/td&gt;
&lt;td&gt;string&lt;/td&gt;
&lt;td&gt;è§¦å‘äº‹ä»¶æ—¶é—´&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;objectId&lt;/td&gt;
&lt;td&gt;string&lt;/td&gt;
&lt;td&gt;æ“ä½œå¯¹è±¡id, æ¯”å¦‚æ–‡æ¡£id&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;bizId&lt;/td&gt;
&lt;td&gt;string&lt;/td&gt;
&lt;td&gt;æ‰€å±ä¸šåŠ¡id&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;errorMsg&lt;/td&gt;
&lt;td&gt;string&lt;/td&gt;
&lt;td&gt;é”™è¯¯ä¿¡æ¯&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;å®æ—¶è¿‡æ»¤å‡ºå¼‚å¸¸äº‹ä»¶KDA SQL&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;c1&#34;&gt;-- ** Continuous Filter ** 
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;-- Performs a continuous filter based on a WHERE condition.
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;--          .----------.   .----------.   .----------.              
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;--          |  SOURCE  |   |  INSERT  |   |  DESTIN. |              
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;-- Source--&amp;gt;|  STREAM  |--&amp;gt;| &amp;amp; SELECT |--&amp;gt;|  STREAM  |--&amp;gt;Destination
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;--          |          |   |  (PUMP)  |   |          |              
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;--          &amp;#39;----------&amp;#39;   &amp;#39;----------&amp;#39;   &amp;#39;----------&amp;#39;               
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;-- STREAM (in-application): a continuously updated entity that you can SELECT from and INSERT into like a TABLE
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;-- PUMP: an entity used to continuously &amp;#39;SELECT ... FROM&amp;#39; a source STREAM, and INSERT SQL results into an output STREAM
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;-- Create output stream, which can be used to send to a destination
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;-- reference: 
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;-- https://docs.aws.amazon.com/zh_cn/kinesisanalytics/latest/sqlref/analytics-sql-reference.html
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;-- https://docs.aws.amazon.com/zh_cn/kinesisanalytics/latest/dev/streaming-sql-concepts.html
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;-- https://docs.aws.amazon.com/zh_cn/kinesisanalytics/latest/sqlref/kinesis-analytics-sqlref.pdf
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;-- abnormality event stream
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;CREATE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;OR&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;REPLACE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;STREAM&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;DESTINATION_SQL_STREAM&amp;#34;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; 
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;eventId&amp;#34;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;       &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;varchar&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;64&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;action&amp;#34;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;varchar&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;256&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;userId&amp;#34;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;varchar&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;64&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;objectId&amp;#34;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;varchar&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;64&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;bizId&amp;#34;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;         &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;varchar&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;64&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;errorMsg&amp;#34;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;varchar&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1024&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;createdAt&amp;#34;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;varchar&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;32&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;-- Filter errorMsg like panic/error pump
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;CREATE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;OR&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;REPLACE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;PUMP&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;ERROR_PANIC_STREAM_PUMP&amp;#34;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;AS&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;INSERT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;INTO&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;DESTINATION_SQL_STREAM&amp;#34;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;SELECT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;STREAM&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;eventId&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;action&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;userId&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;objectId&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;bizId&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;errorMsg&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;createdAt&amp;#34;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;FROM&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;SOURCE_SQL_STREAM_001&amp;#34;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;WHERE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;errorMsg&amp;#34;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;LIKE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;%[PANIC]%&amp;#39;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;or&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;errorMsg&amp;#34;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;LIKE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;%[panic]%&amp;#39;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; 
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;or&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;errorMsg&amp;#34;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;LIKE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;%[ERROR]%&amp;#39;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; 
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;or&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;errorMsg&amp;#34;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;LIKE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;%[error]%&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;æ¯1åˆ†é’Ÿwarnæ•°ç›®è¶…è¿‡10æ¬¡çš„SQL(æ»šåŠ¨çª—å£)&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-sql&#34; data-lang=&#34;sql&#34;&gt;&lt;span class=&#34;k&#34;&gt;CREATE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;OR&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;REPLACE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;STREAM&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;DESTINATION_SQL_STREAM&amp;#34;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; 
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;eventId&amp;#34;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;       &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;varchar&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;64&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;action&amp;#34;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;varchar&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;256&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;userId&amp;#34;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;varchar&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;64&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;objectId&amp;#34;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;varchar&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;64&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;bizId&amp;#34;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;         &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;varchar&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;64&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;errorMsg&amp;#34;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;varchar&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1024&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;createAt&amp;#34;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;varchar&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;32&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;INGREST_ROW_TIME&amp;#34;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;varchar&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;32&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;APPROXIMATE_ARRIVAL_TIME&amp;#34;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;varchar&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;32&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;-- Filter errorMsg like warning pump
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;-- Aggregation with time window(u can use stagger windows,tumbling windows, sliding windows)
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;-- use tumbling windows for this case
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;CREATE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;OR&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;REPLACE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;PUMP&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;STREAM_PUMP&amp;#34;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;AS&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;INSERT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;INTO&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;DESTINATION_SQL_STREAM&amp;#34;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;SELECT&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;STREAM&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;eventId&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;userId&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;objectId&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;bizId&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;createAt&amp;#34;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;errorMsg&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;action&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;STEP&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;SOURCE_SQL_STREAM_001&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ROWTIME&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;BY&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;INTERVAL&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;60&amp;#39;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;SECOND&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;AS&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;INGREST_ROW_TIME&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;STEP&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;SOURCE_SQL_STREAM_001&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;APPROXIMATE_ARRIVAL_TIME&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;BY&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;INTERVAL&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;60&amp;#39;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;SECOND&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;AS&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;APPROXIMATE_ARRIVAL_TIME&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;-- STEP(&amp;#34;SOURCE_SQL_STREAM_001&amp;#34;.EVENT_TIME BY INTERVAL &amp;#39;60&amp;#39; SECOND) AS &amp;#34;EVENT_TIME&amp;#34;,
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;COUNT&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;AS&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;action_warn_count&amp;#34;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;FROM&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;SOURCE_SQL_STREAM_001&amp;#34;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;WHERE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;errorMsg&amp;#34;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;LIKE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;% WARNNING %&amp;#34;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;or&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;errorMsg&amp;#34;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;LIKE&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;% warnning %&amp;#34;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;GROUP&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;BY&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;action&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;STEP&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;SOURCE_SQL_STREAM_001&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;ROWTIME&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;BY&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;INTERVAL&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;60&amp;#39;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;SECOND&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;STEP&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;SOURCE_SQL_STREAM_001&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;APPROXIMATE_ARRIVAL_TIME&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;BY&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;INTERVAL&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;60&amp;#39;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;SECOND&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;-- STEP(&amp;#34;SOURCE_SQL_STREAM_001&amp;#34;.EVENT_TIME BY INTERVAL &amp;#39;60&amp;#39; SECOND) 
&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;Having&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;action_warn_count&amp;#34;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;10&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&#34;æœåŠ¡æ„å»º&#34;&gt;æœåŠ¡æ„å»º&lt;/h2&gt;
&lt;p&gt;åŸºäºä»¥ä¸ŠæœåŠ¡æ­å»ºï¼Œéœ€è¦ç”¨æˆ·å»awsäº‘å¹³å°ä¸Šç‚¹å‡»ï¼Œé…ç½®ä½¿ç”¨ï¼Œ ç‰¹åˆ«æ˜¯æ„å»ºè¡¨ï¼Œä»¥åŠæ•°æ®ä¼ è¾“ï¼Œå±æ€§å’Œå®‰å…¨è®¿é—®æƒé™è§’è‰²çš„ç®¡ç†ï¼Œéšç€ä¸šåŠ¡å¤æ‚åº¦å˜é«˜ï¼ŒåŸºç¡€æœåŠ¡ä¹Ÿéšä¹‹å¢å¤šï¼Œå¯é…ç½®åŒ–çš„ä¸œè¥¿è¶Šæ¥è¶Šå¤šï¼Œä¼šå¸¦æ¥ç¾éš¾æ€§çš„åæœï¼Œæœ€ç»ˆå˜å¾—ä¸å¯æ§ï¼ŒäººåŠ›ç®¡ç†è¿ç»´æˆæœ¬å¢åŠ ï¼›awså¹³å°æä¾›äº†AWS CloudFormation å…è®¸æ‚¨é€šè¿‡å°†åŸºç¡€è®¾æ–½è§†ä¸ºä»£ç æ¥å»ºæ¨¡ã€é¢„ç½®å’Œç®¡ç† AWS å’Œç¬¬ä¸‰æ–¹èµ„æºã€‚å³IaCï¼Œä¹Ÿæ˜¯Devopsç»å¸¸æ‰€åšçš„äº‹æƒ…ï¼Œå¯ä»¥ä½¿ç”¨ç›¸å…³IaCå·¥å…·æ¥è‡ªåŠ¨åŒ–æ„å»ºä¸€ä¸ªç³»ç»Ÿï¼Œå¸¸ç”¨çš„åœºæ™¯æ˜¯CI/CDæ”¯æŒå¿«é€Ÿå˜åŒ–çš„ä¸šåŠ¡éœ€æ±‚å¼€å‘ï¼›AWSä¸€ç›´æä¾›åŸºç¡€æœåŠ¡çš„é…ç½®APIï¼Œæœ‰ç›¸å…³çš„SDKå¯ä¾›ä½¿ç”¨ï¼Œä¹Ÿæœ‰&lt;code&gt;aws&lt;/code&gt; å·¥å…·æ¥æ“ä½œè¿™äº›åŸºç¡€æœåŠ¡èµ„æºï¼› åé¢æä¾›äº†ä¸€ç§å¼€æºè½¯ä»¶å¼€å‘æ¡†æ¶AWS Cloud Development Kit (AWS &lt;a href=&#34;https://docs.aws.amazon.com/zh_cn/cdk/v2/guide/home.html&#34;&gt;CDK&lt;/a&gt;)ï¼Œå¯ä½¿ç”¨ç†Ÿæ‚‰çš„ç¼–ç¨‹è¯­è¨€æ¥å®šä¹‰äº‘åº”ç”¨ç¨‹åºèµ„æºï¼›å°†äº‘ä¸Šç¡¬ä»¶èµ„æºå¯ç¼–ç¨‹åŒ–ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿çš„å®ç°è‡ªåŠ¨åŒ–è¿ç»´ç®¡ç†ï¼Œå……åˆ†åˆ©ç”¨äº‘ä¸Šçš„èµ„æºæ¥ç»„è£…constructæˆä¸€ä¸ªæ¨¡å—æ ˆstack, å„ä¸ªæ¨¡å—æ ˆæœ€ç»ˆåˆæˆä¸€ä¸ªè½åœ°è§£å†³æ–¹æ¡ˆï¼Œæ–¹ä¾¿å¼€ç®±å³ç”¨(å®‰è£…è½¯ä»¶ä¸€æ ·)ï¼Œé™ä½äº‘æ„å»ºçš„å¤æ‚æ€§ï¼›cdk constructåˆ†3ä¸ªå±‚æ¬¡çš„å°è£…ï¼ŒL1æ˜¯æœ€ä½çº§åˆ«åˆå§‹å°è£…ï¼Œç›´æ¥å¯¹åº”CloudFormationé…ç½®æ¨¡ç‰ˆæ–‡ä»¶æ˜ å°„ï¼Œç§°ä¹‹ä¸ºCFN èµ„æºï¼Œå¿…é¡»é…ç½®æ¯ä¸€é¡¹å±æ€§ï¼Œéœ€è¦æ·±å…¥äº†è§£èµ„æºæ¨¡å‹çš„è¯¦ç»†ä¿¡æ¯ï¼›L2æ˜¯æ˜¯å¯¹äº†L1çš„ç»„åˆå°è£…ï¼Œä½¿ç”¨èµ„æºå±æ€§é»˜è®¤å€¼ï¼Œæ¯”å¦‚new VPCï¼›L3åˆ™æ˜¯ä¸€ç§æ¨¡å¼(pattern)ï¼Œé€šè¿‡å¤šç§èµ„æºç»„åˆæˆä¸€ä¸ªå¸¸è§èµ„æºæ¶æ„ï¼Œæ¯”å¦‚ new Fargateæ— æœåŠ¡åŒ–å®¹å™¨é›†ç¾¤ï¼›å…·ä½“å‚è€ƒè§ï¼š&lt;a href=&#34;https://docs.aws.amazon.com/zh_cn/cdk/v2/guide/constructs.html&#34;&gt;constructs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;é€šè¿‡&lt;a href=&#34;https://cdkworkshop.com&#34;&gt;cdk workshop&lt;/a&gt; å¤§æ¦‚èŠ±åŠå¤©æ—¶é—´å­¦ä¹ è¿™é‡Œçš„demoå°±å¯ä»¥è¯•ç€æ­å»ºç›¸å…³çš„æœåŠ¡ï¼Œ ä¹Ÿæœ‰æ›´å¤šçš„&lt;a href=&#34;https://awesome-aws-workshops.com/&#34;&gt;awesome workshop&lt;/a&gt;å¯ä¾›å‚è€ƒå’Œå­¦ä¹ çš„ï¼Œå¹¶ä¸” &lt;a href=&#34;https://aws.amazon.com/blogs&#34;&gt;aws blog&lt;/a&gt;  &lt;a href=&#34;https://aws.amazon.com/cn/builders-library&#34;&gt;builders&#39; lib&lt;/a&gt;ä¹Ÿä¼šæœ‰å¾ˆå¤šç›¸å…³çš„è§£å†³æ–¹æ¡ˆæä¾›å­¦ä¹ ï¼›å½“ç„¶éœ€è¦å¾ˆå¥½çš„æ¶æ„awsæœåŠ¡ï¼Œéœ€è¦å¤šè½åœ°å®è·µï¼Œæ·±å…¥æœåŠ¡ç»†èŠ‚(æŸ¥çœ‹å¸®åŠ©æ–‡æ¡£&lt;a href=&#34;https://docs.aws.amazon.com/&#34;&gt;docs&lt;/a&gt;)ï¼Œç»“åˆéœ€æ±‚ï¼Œæ‰èƒ½æ„å»ºä¸€ä¸ªç›¸å¯¹å®Œç¾çš„è§£å†³æ–¹æ¡ˆï¼›å½“ç„¶å‰æœŸç”Ÿäº§è½åœ°éœ€è¦ä½¿ç”¨CDKæ¥è¿›è¡Œæ¶æ„æ¨ç†ã€‚&lt;/p&gt;
&lt;p&gt;è¿™é‡Œç»“åˆä¸Šè¿°éœ€æ±‚ï¼Œä½¿ç”¨CDKæ¥æ­å»ºä¸€äº›stack, æ–¹ä¾¿æ•°æ®æµåˆ†æç®¡é“çš„ç»„è£…ï¼Œåç»­ä¹Ÿæ–¹ä¾¿ä¸å…¶ä»–contstuctsè¿›è¡Œç»„è£…ï¼›ä¸»è¦æ˜¯åˆ†ä¸ºä»¥ä¸‹stack:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;CDK-Workshop-Lambda-KDS-stack&lt;/strong&gt;ï¼š&lt;/p&gt;
&lt;p&gt;APIGateway-&amp;gt;lambda(put KDS record &amp;amp; hit counter in dynamodb)-&amp;gt;lambda(hello)  dynamotableviewer&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;DMS-KDS-stack&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;KDS-KDA-sql-Lambda-Dynamodb-stack&lt;/strong&gt;: KDS-&amp;gt;KDA-&amp;gt;lambda-&amp;gt;dynamodb dynamotableviewer&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;KDS-KDF-S3-stack&lt;/strong&gt;: KDS-&amp;gt;KDF-&amp;gt;S3&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;KDS-KDA-flink-OpenSearch-stack&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;KDS-KDA-flink-KDS-stack: eg: for near-realtime-warehouse, make a pipeline (ODS-&amp;gt;&lt;strong&gt;DWD-&amp;gt;DWM-&amp;gt;DWS&lt;/strong&gt;) sink to Redshift; like this &lt;a href=&#34;https://cloud.tencent.com/developer/article/1919594&#34;&gt;tencent news Pipeline pattern&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;KDS-KDF-Redshift-stack:&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Redshift-QuickSight-stack&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;S3-Glue-Athena-stack&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;è¿™é‡Œä¸»è¦éƒ¨ç½²CDK-Workshop-Lambda-KDS-stack, KDS-KDA-sql-Lambda-Dynamodb-stack å’ŒKDS-KDF-S3-stack æ­å»ºSQLæµå¼å¤„ç†ç”¨æˆ·è¡Œä¸ºæ•°æ®,å…·ä½“è§&lt;a href=&#34;https://github.com/weedge/user-behavior-analytics-cdk&#34;&gt;ä»£ç &lt;/a&gt;ï¼›å…¶ä»–stackå¯ä»¥åç»­è¿›è¡Œæ‰©å±•è¿›è¡Œæ„å»ºï¼Œæ¨ç†æ•´ä½“åŸºç¡€è®¾æ–½æ¶æ„ã€‚&lt;/p&gt;
&lt;h3 id=&#34;æ„å»º&#34;&gt;æ„å»º&lt;/h3&gt;
&lt;p&gt;é¦–å…ˆéœ€è¦å®‰è£…CDK, å…·ä½“æŸ¥çœ‹&lt;a href=&#34;https://aws.amazon.com/cn/getting-started/guides/setup-cdk/&#34;&gt;å…¥é—¨æ•™ç¨‹&lt;/a&gt;ï¼Œæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;&lt;span class=&#34;c1&#34;&gt;# download code to start&lt;/span&gt;
git clone https://github.com/weedge/user-behavior-analytics-cdk.git &lt;span class=&#34;o&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;cd&lt;/span&gt; user-behavior-analytics-cdk
&lt;span class=&#34;c1&#34;&gt;# tips: cdk load cdk.json + cdk.context.json to run by js on node&lt;/span&gt;
&lt;span class=&#34;c1&#34;&gt;# list stacks&lt;/span&gt;
cdk ls
&lt;span class=&#34;c1&#34;&gt;# deploy KDS-KDA-sql-Lambda-DynamoDB-stack with KDS-KDF-S3-stack(need created kinesis data stream)&lt;/span&gt;
cdk deploy KDS-KDA-sql-Lambda-DynamoDB-stack
&lt;span class=&#34;c1&#34;&gt;# deploy CDK-Workshop-Lambda-KDS-stack for hit event stream; lambda func put record to KDS, dependcy KDS&lt;/span&gt;
cdk deploy CDK-Workshop-Lambda-KDS-stack
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;éƒ¨ç½²å®Œä¹‹åï¼Œä¼šè¾“å‡ºkinesisæ•°æ®æµçš„åç§°ä»¥åŠç”¨äºæŸ¥çœ‹æ•°æ®ç»“æœåœ°å€ï¼›&lt;/p&gt;
&lt;p&gt;å¼€å§‹å†™å…¥æµ‹è¯•æ•°æ®ï¼Œéœ€è¦ä½¿ç”¨python3, ä½¿ç”¨pip3 å®‰è£…ä¾èµ–åŒ…&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;&lt;span class=&#34;c1&#34;&gt;# init python virtural env&lt;/span&gt;
python3 -m venv .venv &lt;span class=&#34;o&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;source&lt;/span&gt; .venv/bin/activate 
&lt;span class=&#34;c1&#34;&gt;# install boto3  faker&lt;/span&gt;
pip3 install boto3 faker
&lt;span class=&#34;c1&#34;&gt;# run test script, wait KDA run, put record to KDS&lt;/span&gt;
python3 src/scripts/producer-kds-test.py
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;è¿è¡Œæµ‹è¯•è„šæœ¬ï¼Œè¾“å…¥regionåœ°åŸŸåç§°,æ¯”å¦‚us-east-1, ç­‰å¾…å¯åŠ¨åï¼Œè¾“å…¥æ•°æ®æµåç§°ï¼Œå¼€å§‹å‘é€æ•°æ®ï¼›&lt;/p&gt;
&lt;p&gt;æ¯1ç§’å‘ä¸€æ¬¡æ•°æ®å†™å…¥KDSä¸­ï¼Œå‘äº†10æ¬¡å«æœ‰é”™è¯¯äº‹ä»¶ï¼Œå‘äº†10æ¬¡éšæœºäº‹ä»¶ï¼Œæ€»å…±20æ¡ï¼›&lt;/p&gt;
&lt;p&gt;ä¹Ÿå¯ä»¥ä½¿ç”¨awsæä¾›KDSæ•°æ®ç”Ÿæˆå™¨ï¼šhttps://github.com/awslabs/amazon-kinesis-data-generator&lt;/p&gt;
&lt;p&gt;ä»åˆšæ‰éƒ¨ç½²è¾“å‡ºç»“æœåœ°å€æŸ¥çœ‹å«æœ‰é”™è¯¯çš„æ•°æ®å·²ç»æœ‰10æ¡å±•ç°å‡ºæ¥(æ•°æ®è·å–å¼å‰ç«¯æ¯éš”å‡ ç§’è½®è®­è·å–apiæ•°æ®ï¼Œå®æ—¶å±•ç°å¯é€šè¿‡&lt;a href=&#34;https://docs.aws.amazon.com/zh_cn/apigateway/latest/developerguide/apigateway-websocket-api.html&#34;&gt;API Gateway WebSocket&lt;/a&gt; æ¥æ”¯æŒ)ï¼›å†å²æ•°æ®å¯ä»¥åœ¨KDFé…ç½®çš„S3ç›®æ ‡ä¸­ç‚¹å‡»æŸ¥çœ‹ï¼ŒåŸå§‹æ•°æ®å¯ä»¥ä¸‹è½½gzåŒ…è¿›è¡Œè§£å‹æŸ¥çœ‹;&lt;/p&gt;
&lt;p&gt;é€šè¿‡ä½¿ç”¨æä¾›ç»™å‰ç«¯è®¿é—®çš„äº‹ä»¶api(apiåœ°å€åœ¨éƒ¨ç½²CDK-Workshop-Lambda-KDS-stackåè¾“å‡ºçš„è®¿é—®åœ°å€)æ¥å†™å…¥å¼‚å¸¸&lt;code&gt;[error]&lt;/code&gt; æ•°æ®&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;curl -XPOST -iv https://&lt;span class=&#34;o&#34;&gt;{&lt;/span&gt;APIGateway&lt;span class=&#34;o&#34;&gt;}&lt;/span&gt;.execute-api.&lt;span class=&#34;o&#34;&gt;{&lt;/span&gt;region&lt;span class=&#34;o&#34;&gt;}&lt;/span&gt;.amazonaws.com/prod/event -d &lt;span class=&#34;s1&#34;&gt;&amp;#39;{&amp;#34;eventId&amp;#34;:&amp;#34;1-1-1&amp;#34;,&amp;#34;bizId&amp;#34;:&amp;#34;123123&amp;#34;,&amp;#34;objectId&amp;#34;:&amp;#34;123&amp;#34;,&amp;#34;action&amp;#34;:&amp;#34;test&amp;#34;,&amp;#34;errorMsg&amp;#34;:&amp;#34;[error]&amp;#34;,&amp;#34;userId&amp;#34;:&amp;#34;1231321&amp;#34;}&amp;#39;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;é€šè¿‡åˆšæ‰éƒ¨ç½²KDS-KDA-sql-Lambda-DynamoDB-stackçš„ç»“æœåœ°å€å¯ä»¥ æŸ¥çœ‹å¼‚å¸¸æ•°æ®å·²ç»å®æ—¶å†™å…¥ã€‚&lt;/p&gt;
&lt;p&gt;æœ€åå°†éƒ¨ç½²èµ„æºæ¸…é™¤ï¼Œä¾èµ–åˆ é™¤(å’Œå¸è½½è½¯ä»¶ä¸€æ ·)ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;&lt;span class=&#34;c1&#34;&gt;# destroy resources with dependent resources&lt;/span&gt;
cdk destroy KDS-KDF-S3-stack
cdk destroy KDS-KDA-sql-Lambda-DynamoDB-stack
cdk destroy CDK-Workshop-Lambda-KDS-stack
&lt;span class=&#34;c1&#34;&gt;# or cdk destroy --all&lt;/span&gt;
cdk destroy --all
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;ä»£ç ç»“æ„&#34;&gt;ä»£ç ç»“æ„&lt;/h3&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-fallback&#34; data-lang=&#34;fallback&#34;&gt;â”œâ”€â”€ cmd                              -- golang cmd bin dir
â”œâ”€â”€ docs                             -- help doc
â”œâ”€â”€ infra                            -- infrastructures stack
â”‚Â Â  â””â”€â”€ lib                          -- cdk constuct in stack
â”œâ”€â”€ src                              -- source code to run
â”‚Â Â  â”œâ”€â”€ kinesis-analytics-pyflink    -- KDA python scripts use flink python api 
â”‚Â Â  â”œâ”€â”€ kinesis-analytics-sql        -- KDA sql
â”‚Â Â  â”œâ”€â”€ lambda                       -- js,python,golang lambda func 
â”‚Â Â  â”œâ”€â”€ redshift-sql                 -- redshift sql 
â”‚Â Â  â””â”€â”€ scripts                      -- local run test code by use aws sdk
â”œâ”€â”€ test                             -- test cdk logic
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&#34;å‚è€ƒ&#34;&gt;å‚è€ƒ&lt;/h2&gt;
&lt;p&gt;sam cli &lt;a href=&#34;https://docs.aws.amazon.com/zh_cn/serverless-application-model/latest/developerguide/serverless-sam-cli-using-invoke.html&#34;&gt;local debug lambda&lt;/a&gt;, &lt;strong&gt;&lt;a href=&#34;https://catalog.workshops.aws/complete-aws-sam/en-US&#34;&gt;The Complete AWS SAM workshop&lt;/a&gt;&lt;/strong&gt;,  &lt;strong&gt;&lt;a href=&#34;https://www.youtube.com/watch?v=PiQ_eZFO2GU&amp;amp;list=PL2yQDdvlhXf_lYR5Ntvr9V5iVYv5rcbNc&amp;amp;index=6&#34;&gt;AWS re:Invent 2022 - Best practices for advanced serverless developers&lt;/a&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;streaming cdk: &lt;a href=&#34;https://github.com/aws-samples/streaming-solution-aws-cdk&#34;&gt;https://github.com/aws-samples/streaming-solution-aws-cdk&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;kds and msk cdk: &lt;a href=&#34;https://github.com/aws-solutions/streaming-data-solution-for-amazon-kinesis-and-amazon-msk&#34;&gt;https://github.com/aws-solutions/streaming-data-solution-for-amazon-kinesis-and-amazon-msk&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Redshift cdk : &lt;a href=&#34;https://github.com/miztiik/redshift-demo&#34;&gt;https://github.com/miztiik/redshift-demo&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Glue cdk: &lt;a href=&#34;https://github.com/aws-samples/glue-workflow-aws-cdk&#34;&gt;https://github.com/aws-samples/glue-workflow-aws-cdk&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;opensearch cdk: &lt;a href=&#34;https://www.luminis.eu/blog/cloud-en/deploying-a-secure-aws-elasticsearch-cluster-using-cdk/&#34;&gt;https://www.luminis.eu/blog/cloud-en/deploying-a-secure-aws-elasticsearch-cluster-using-cdk/&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;mysql cdk: &lt;a href=&#34;https://aws.amazon.com/cn/blogs/infrastructure-and-automation/use-aws-cdk-to-initialize-amazon-rds-instances/&#34;&gt;https://aws.amazon.com/cn/blogs/infrastructure-and-automation/use-aws-cdk-to-initialize-amazon-rds-instances/&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;mysql dms cdk: &lt;a href=&#34;https://aws.amazon.com/cn/blogs/database/accelerate-data-migration-using-aws-dms-and-aws-cdk/&#34;&gt;https://aws.amazon.com/cn/blogs/database/accelerate-data-migration-using-aws-dms-and-aws-cdk/&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;aurora mysql dms kds opensearch cdk: &lt;a href=&#34;https://github.com/aws-samples/aws-dms-cdc-data-pipeline.git&#34;&gt;https://github.com/aws-samples/aws-dms-cdc-data-pipeline.git&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;kda-flink-py: &lt;a href=&#34;https://aws.amazon.com/cn/blogs/china/python-stream-data-processing-and-analysis-using-pyflink-in-amazon-kinesis-data-analytics/&#34;&gt;https://aws.amazon.com/cn/blogs/china/python-stream-data-processing-and-analysis-using-pyflink-in-amazon-kinesis-data-analytics/&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;kda-zeppelin-flink-py: &lt;a href=&#34;https://aws.amazon.com/cn/blogs/big-data/query-your-data-streams-interactively-using-kinesis-data-analytics-studio-and-python/&#34;&gt;https://aws.amazon.com/cn/blogs/big-data/query-your-data-streams-interactively-using-kinesis-data-analytics-studio-and-python/&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;&lt;a href=&#34;https://docs.aws.amazon.com/pdfs/whitepapers/latest/microservices-on-aws/microservices-on-aws.pdf&#34;&gt;Implementing Microservices on AWS&lt;/a&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;&lt;a href=&#34;https://d1.awsstatic.com/whitepapers/aws-cloud-data-ingestion-patterns-practices.pdf&#34;&gt;AWS Cloud Data Ingestion Patterns and Practices&lt;/a&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://catalog.us-east-1.prod.workshops.aws/workshops/c342c6d1-2baf-4827-ba42-52ef9eb173f6/en-US/flink-on-kda&#34;&gt;Flink-on-KDS Workshop&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://catalog.us-east-1.prod.workshops.aws/workshops/2300137e-f2ac-4eb9-a4ac-3d25026b235f/en-US&#34;&gt;Real time streaming with kinesis Workshop&lt;/a&gt;&lt;/p&gt;</description>
      
    </item>
    
    <item>
      <title>å…¨æ ˆå¼€å‘</title>
      <link>https://weedge.github.io/post/shop/</link>
      <pubDate>Sun, 02 Jan 2022 10:26:23 +0800</pubDate>
      
      <guid>https://weedge.github.io/post/shop/</guid>
      
        <description>&lt;h2 id=&#34;ä»‹ç»&#34;&gt;ä»‹ç»&lt;/h2&gt;
&lt;p&gt;ä»¥å‰å·¥ä½œä¸­æœ‰è¿‡å‰ç«¯çš„å¼€å‘ç»éªŒï¼Œä½¿ç”¨åç«¯æ¨¡ç‰ˆSmarty(ä¸»è¦æ˜¯å¤–éƒ¨éœ€æ±‚ï¼Œç°åœ¨æ–°é¡¹ç›®ä¸­åº”è¯¥å¾ˆå°‘ä½¿ç”¨è¿™ä¸ªäº†)ï¼Œå‰ç«¯æ¨¡ç‰ˆMustacheï¼Œé¡µé¢ä¸­ä½¿ç”¨ js jqueryäº¤äº’é€»è¾‘ï¼Œç›´æ¥æœç”¨ä¸€äº›å¼€æºçš„UIç»„ä»¶Bootstrapï¼Œå¼€æºçš„åå°UIç³»ç»Ÿï¼Œä¸»è¦æ˜¯å»ºè®¾å†…éƒ¨åå°çš„æ—¶å€™ä½¿ç”¨ï¼Œè‡ªåŠ¨ç”ŸæˆCRUDé¡µé¢ï¼›å‰ç«¯çš„æŠ€æœ¯æ ˆæ›´æ–°è¿­ä»£ç›¸å¯¹åç«¯å¿«äº›ï¼Œé€šè¿‡ä»¥å…¨æ ˆæŠ€æœ¯æ ˆä¸ºåˆ‡å…¥ç‚¹ï¼Œé€šè¿‡ä¸€ä¸ªç®€å•çš„ç³»ç»Ÿï¼Œå­¦ä¹ ä¸‹æœ€æ–°æŠ€æœ¯æ ˆå·¥å…·ï¼Œä¸»è¦ç›®çš„å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;p&gt;æ ¹æ®éœ€æ±‚ï¼Œå®ç°ä¸€ä¸ªç®€å•åŠŸèƒ½çš„è´­ç‰©ç³»ç»Ÿï¼Œç›®çš„æ˜¯ä¸ºäº†å­¦ä¹ ts-&amp;gt;js on node.jså…¨æ ˆå¼€å‘ï¼Œäº†è§£æ•´ä½“å¼€å‘æ„å»ºå·¥å…·ï¼Œç†Ÿæ‚‰ä¸‹å·¥å…·å¼€å‘æµç¨‹ï¼Œä¸»è¦è¿˜æ˜¯äº†è§£å‰ç«¯æ¡†æ¶å·¥å…·çš„ä½¿ç”¨ï¼Œä»¥åŠç†Ÿæ‚‰é€šè¿‡jsè¿è¡Œæ—¶ç¯å¢ƒè¿è¡Œåœ¨åç«¯æœåŠ¡ä¸Šçš„åº”ç”¨å¼€å‘å·¥å…·ï¼Œä»¥ä¾¿åœ¨åç»­å¼€å‘åå°ç³»ç»Ÿçš„æ—¶å€™å¯ä»¥ç†Ÿç»ƒä½¿ç”¨è¿™äº›æŠ€æœ¯è¿›è¡Œå¼€å‘ï¼Œè¿™äº›å·¥å…·çš„è®¾è®¡æ€æƒ³å¯ä»¥å€Ÿé‰´åˆ°å…¶ä»–åç«¯ä¸šåŠ¡å¼€å‘è¯­è¨€ä¸­ã€‚&lt;/p&gt;
&lt;h2 id=&#34;åŠŸèƒ½è¦æ±‚&#34;&gt;åŠŸèƒ½è¦æ±‚&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;â½¤æˆ·å¯ä»¥æµè§ˆå•†å“ï¼Œæä¾›æŒ‰å•†å“åå­—æœç´¢åŠŸèƒ½ã€‚&lt;/li&gt;
&lt;li&gt;â½¤æˆ·å¯ä»¥ä¸‹å•è´­ä¹°æŸæ ·å•†å“ï¼ˆâ½€ä»˜è¿‡ç¨‹å¯ä»¥çœç•¥ï¼‰ï¼Œè´­ä¹°æˆåŠŸåç³»ç»Ÿéœ€è¦å¼‚æ­¥é€šçŸ¥ä¸‹æ¸¸ç³»ç»Ÿï¼ˆå¦‚ä»“åº“ ç³»ç»Ÿã€ç‰©æµç³»ç»Ÿç­‰ï¼Œä¸‹æ¸¸ç³»ç»Ÿå¯ç®€å•å®ç°ï¼‰ã€‚&lt;/li&gt;
&lt;li&gt;æä¾›åå°ç®¡ç†â»šâ¾¯å½•â¼Šå•†å“ï¼ŒåŒ…æ‹¬å•†å“åç§°ã€å•†å“æè¿°ã€å•†å“ä»·æ ¼ã€åº“å­˜ç­‰ã€‚&lt;/li&gt;
&lt;li&gt;è¦æ±‚è®°å½•â½¤æˆ·è®¿é—®â½‡å¿—ï¼Œä¾›å®¡è®¡ä½¿â½¤ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&#34;å®ç°è¦æ±‚&#34;&gt;å®ç°è¦æ±‚&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;å‰ç«¯ä½¿â½¤Vue.js + elementUIï¼Œåå°ä½¿â½¤ AdonisJS æ¡†æ¶ï¼ˆAdonisJS ç‰ˆæœ¬è¦æ±‚5.0ä»¥ä¸Šï¼‰ã€‚&lt;/li&gt;
&lt;li&gt;æ•°æ®åº“ä½¿â½¤ mysqlï¼Œç»“åˆ AdonisJS çš„ ORM èƒ½â¼’ã€‚&lt;/li&gt;
&lt;li&gt;è®¾è®¡æ—¶éœ€è¦è€ƒè™‘å¿…è¦çš„ç³»ç»Ÿå®‰å…¨æ€§ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&#34;è®¾è®¡å®ç°&#34;&gt;è®¾è®¡å®ç°&lt;/h2&gt;
&lt;h3 id=&#34;éœ€æ±‚åˆ†æ&#34;&gt;éœ€æ±‚åˆ†æ&lt;/h3&gt;
&lt;p&gt;æ•´ä½“äº¤äº’ä¸»è¦æ˜¯å®ç°è´­ä¹°ç³»ç»Ÿï¼Œä»¥åŠç”¨æˆ·è´­ä¹°å•†å“çš„è®¿é—®æ—¥å¿—ï¼Œä»¥åŠç”¨æˆ·è¡Œä¸ºæ—¥å¿—ï¼Œç»™å®¡è®¡ç³»ç»Ÿï¼Œè¿›è¡Œæ¼æ´åˆ†æç­‰ï¼Œè€ƒè™‘åˆ°å‰æœŸç”¨æˆ·æ¯”è¾ƒå°‘ï¼Œäº¤äº’ä½¿ç”¨ï¼Œ5å¤©è®¾è®¡å¼€å‘æ—¶é—´ï¼Œå…ˆæä¾›v1ç®€å•ç‰ˆæœ¬ï¼Œæ»¡è¶³å•†å®¶å’Œä¹°å®¶ç”¨æˆ·çš„åŸºæœ¬è´­ä¹°åŠŸèƒ½&lt;/p&gt;
&lt;p&gt;ä¹°å®¶åŸºæœ¬éœ€æ±‚ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;é€šè¿‡é¡µé¢æŸ¥çœ‹ä¸Šæ¶å•†å“åˆ—è¡¨ï¼›æŸ¥çœ‹å•†å“è¯¦æƒ…é¡µï¼›é€šè¿‡å•†å“åå…³é”®å­—æœç´¢å•†å“ï¼›&lt;/li&gt;
&lt;li&gt;è´­ä¹°å•†å“ï¼ŒæŸ¥çœ‹è®¢å•(ä¸ºäº†ç®€åŒ–éœ€æ±‚ï¼Œæ— è´­ç‰©è½¦åŠŸèƒ½ï¼Œå‡è®¾ç”¨æˆ·è®¢å•åªèƒ½è´­ä¹°ä¸€ä»¶å•†å“ï¼ŒåŠç”¨æˆ·å’Œè®¢å•æ˜¯ä¸€å¯¹å¤šï¼Œè®¢å•å’Œå•†å“æ˜¯å¤šå¯¹ä¸€)ï¼›&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;å–å®¶åŸºæœ¬éœ€æ±‚ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;åå°å½•å…¥æŸ¥çœ‹ä¿®æ”¹åˆ é™¤å•†å“(ä¸€ä¸ªç”¨æˆ·ç¼–è¾‘å¤šä¸ªå•†å“é¡¹ï¼Œä¸€ä¸ªå•†å“é¡¹ä¹Ÿå¯ä»¥ç»™å¤šä¸ªç”¨æˆ·ç¼–è¾‘ï¼ŒåŠç”¨æˆ·å’Œå•†å“æ˜¯å¤šå¯¹å¤šï¼Œä¸ºäº†ç®€å•è€ƒè™‘ï¼Œä¸è€ƒè™‘ååŒçš„æƒ…å†µ)ï¼›&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;åå°éœ€æ±‚ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;è®°å½•è®¿é—®æ—¥å¿—ï¼Œå®¡è®¡éœ€æ±‚ï¼›&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&#34;åŠŸèƒ½è®¾è®¡&#34;&gt;åŠŸèƒ½è®¾è®¡&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;Shop-frontend  æ•°æ®é¡µé¢å±•ç°ï¼Œæ»¡è¶³å•†å“åˆ—è¡¨å±•ç°ï¼›é€šè¿‡å•†å“åæœç´¢ï¼›è¯¦æƒ…é¡µæŸ¥çœ‹ï¼›&lt;/li&gt;
&lt;li&gt;Shop-backend  å•†å“åå°ï¼Œæä¾›http RESTful api ï¼Œæ»¡è¶³é¡µé¢éœ€æ±‚ï¼Œä»¥åŠç›¸åº”authæƒé™éªŒè¯ï¼Œæ—¥å¿—è®°å½•ï¼Œè´­ä¹°è®¢å•å‘é€ï¼›&lt;/li&gt;
&lt;li&gt;Shop-admin-frontend å•†å“æ•°æ®ç®¡ç†é¡µé¢å±•ç°ï¼Œæ“ä½œå•†å“å¢åˆ æŸ¥æ”¹åŠŸèƒ½é¡µé¢ï¼›&lt;/li&gt;
&lt;li&gt;Shop-admin-backend å•†å“æ•°æ®ç®¡ç†åå°ï¼Œæä¾›http RESTful apiï¼Œ æ»¡è¶³é¡µé¢CRUDåŠŸèƒ½ï¼›&lt;/li&gt;
&lt;li&gt;Shop-backend  è®°å½•ç”¨æˆ·è®¿é—®æ—¥å¿—ï¼Œ é€‚ç”¨pbæ ¼å¼è®°å½•æ—¥å¿—ï¼Œäº§ç”Ÿæ—¥å¿—å®æ—¶å†™å…¥æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œæä¾›ç»™å®¡è®¡ç³»ç»Ÿä½¿ç”¨&lt;/li&gt;
&lt;li&gt;å…¶ä»–æœåŠ¡ï¼›&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;æ•´ä½“æ¶æ„è®¾è®¡å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://raw.githubusercontent.com/weedge/mypic/master/shop-system.drawio.png&#34; alt=&#34;simple-shop-system&#34;&gt;&lt;/p&gt;
&lt;h3 id=&#34;æ•°æ®åº“è®¾è®¡&#34;&gt;æ•°æ®åº“è®¾è®¡&lt;/h3&gt;
&lt;p&gt;å•ç‹¬æ•°æ®åº“å®ä¾‹shop, ç®€å•å®ç°ï¼Œæœªæ ¹æ®æœªæ¥å‡ å¹´çš„æ•°æ®é‡æ¥è¯„ä¼°è¡¨çš„å®¹é‡ï¼Œåˆ†åº“åˆ†è¡¨çš„æƒ…å†µç­‰ã€‚&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;å•†å“è¡¨  tbl_shop_items&lt;/p&gt;
&lt;p&gt;(Tips: è¿™é‡Œä¸ºäº†ç®€åŒ–ï¼Œæ²¡æœ‰å®šä¹‰å¤æ‚ä¸šåŠ¡å®ä½“å…³ç³»äº†ï¼Œæ¯”å¦‚äº§å“å•å…ƒ(CPU), å•†å“å•å…ƒ(SKU)ï¼Œäº§å“å®¹å™¨(Container) ç­‰ï¼Œä¸è¦è„±ç¦»ä¸šåŠ¡è€æµæ°“)&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;å­—æ®µ&lt;/th&gt;
&lt;th&gt;ç±»å‹&lt;/th&gt;
&lt;th&gt;æè¿°&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;id&lt;/td&gt;
&lt;td&gt;int64&lt;/td&gt;
&lt;td&gt;å•†å“id&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;name&lt;/td&gt;
&lt;td&gt;varchar(32)&lt;/td&gt;
&lt;td&gt;å•†å“åç§°&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;desc&lt;/td&gt;
&lt;td&gt;varchar(1024)&lt;/td&gt;
&lt;td&gt;å•†å“æè¿°&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;price&lt;/td&gt;
&lt;td&gt;unsigned int&lt;/td&gt;
&lt;td&gt;ä»·æ ¼ï¼ˆåˆ†ï¼‰&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;stock&lt;/td&gt;
&lt;td&gt;unsigned int&lt;/td&gt;
&lt;td&gt;åº“å­˜æ•°ç›®&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;sell_cn&lt;/td&gt;
&lt;td&gt;unsigned int&lt;/td&gt;
&lt;td&gt;å”®å–æ•°ç›®&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;is_released&lt;/td&gt;
&lt;td&gt;bool&lt;/td&gt;
&lt;td&gt;æ˜¯å¦ä¸Šæ¶&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;is_soldout&lt;/td&gt;
&lt;td&gt;bool&lt;/td&gt;
&lt;td&gt;æ˜¯å¦å”®åŒ¿&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;is_del&lt;/td&gt;
&lt;td&gt;bool&lt;/td&gt;
&lt;td&gt;æ˜¯å¦åˆ é™¤&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;owner_id&lt;/td&gt;
&lt;td&gt;unsigned int64&lt;/td&gt;
&lt;td&gt;æ·»åŠ è€…ç”¨æˆ·id&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;create_at&lt;/td&gt;
&lt;td&gt;timestamp&lt;/td&gt;
&lt;td&gt;åˆ›å»ºæ—¶é—´&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;update_at&lt;/td&gt;
&lt;td&gt;timestamp&lt;/td&gt;
&lt;td&gt;ä¿®æ”¹æ—¶é—´&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;ext&lt;/td&gt;
&lt;td&gt;varchar&lt;/td&gt;
&lt;td&gt;æ‰©å±•å­—æ®µ&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;ol start=&#34;2&#34;&gt;
&lt;li&gt;ç”¨æˆ·å•†å“æ“ä½œè¡¨ tbl_user_items&lt;/li&gt;
&lt;/ol&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;å­—æ®µ&lt;/th&gt;
&lt;th&gt;ç±»å‹&lt;/th&gt;
&lt;th&gt;æè¿°&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;id&lt;/td&gt;
&lt;td&gt;unsigned int64&lt;/td&gt;
&lt;td&gt;æ“ä½œid&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;user_id&lt;/td&gt;
&lt;td&gt;unsigned int64&lt;/td&gt;
&lt;td&gt;å•†å“ç®¡ç†åå°ç”¨æˆ·id&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;item_id&lt;/td&gt;
&lt;td&gt;unsigned int64&lt;/td&gt;
&lt;td&gt;å•†å“id&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;create_at&lt;/td&gt;
&lt;td&gt;timestamp&lt;/td&gt;
&lt;td&gt;åˆ›å»ºæ—¶é—´&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;update_at&lt;/td&gt;
&lt;td&gt;timestamp&lt;/td&gt;
&lt;td&gt;ä¿®æ”¹æ—¶é—´&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;ext&lt;/td&gt;
&lt;td&gt;varchar&lt;/td&gt;
&lt;td&gt;æ‰©å±•å­—æ®µ&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;ol start=&#34;3&#34;&gt;
&lt;li&gt;ç”¨æˆ·è®¢å•è¡¨  tbl_user_orders ï¼ˆä¸ºäº†ç®€åŒ–ï¼Œä¸€ä¸ªç”¨æˆ·åªèƒ½é€‰ä¸€ä¸ªå•†å“ç›´æ¥ä¸‹å•è´­ä¹°ï¼Œæ— è´­ç‰©è½¦ï¼‰&lt;/li&gt;
&lt;/ol&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;å­—æ®µ&lt;/th&gt;
&lt;th&gt;ç±»å‹&lt;/th&gt;
&lt;th&gt;æè¿°&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;user_id&lt;/td&gt;
&lt;td&gt;unsigned int64&lt;/td&gt;
&lt;td&gt;ç”¨æˆ·id&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;item_id&lt;/td&gt;
&lt;td&gt;unsigned int64&lt;/td&gt;
&lt;td&gt;å•†å“id&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;order_id&lt;/td&gt;
&lt;td&gt;unsigned int64&lt;/td&gt;
&lt;td&gt;è®¢å•id&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;pay_amount&lt;/td&gt;
&lt;td&gt;unsigned int64&lt;/td&gt;
&lt;td&gt;æ”¯ä»˜é‡‘é¢&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;create_at&lt;/td&gt;
&lt;td&gt;timestamp&lt;/td&gt;
&lt;td&gt;åˆ›å»ºæ—¶é—´&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;update_at&lt;/td&gt;
&lt;td&gt;timestamp&lt;/td&gt;
&lt;td&gt;ä¿®æ”¹æ—¶é—´&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;ext&lt;/td&gt;
&lt;td&gt;varchar&lt;/td&gt;
&lt;td&gt;æ‰©å±•å­—æ®µ&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;ol start=&#34;4&#34;&gt;
&lt;li&gt;ç”¨æˆ·è¡¨ tbl_users (users)&lt;/li&gt;
&lt;/ol&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;å­—æ®µ&lt;/th&gt;
&lt;th&gt;ç±»å‹&lt;/th&gt;
&lt;th&gt;æè¿°&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;id&lt;/td&gt;
&lt;td&gt;unsigned int64&lt;/td&gt;
&lt;td&gt;ç”¨æˆ·id&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;name&lt;/td&gt;
&lt;td&gt;varchar&lt;/td&gt;
&lt;td&gt;ç”¨æˆ·å&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;email&lt;/td&gt;
&lt;td&gt;varchar&lt;/td&gt;
&lt;td&gt;é‚®ä»¶&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;password&lt;/td&gt;
&lt;td&gt;varchar&lt;/td&gt;
&lt;td&gt;åŠ å¯†å¯†ç &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;remember_me_token&lt;/td&gt;
&lt;td&gt;varchar&lt;/td&gt;
&lt;td&gt;api Opaque Access Token&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;is_admin&lt;/td&gt;
&lt;td&gt;bool&lt;/td&gt;
&lt;td&gt;æ˜¯å¦æ˜¯ç®¡ç†å‘˜&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;created_at&lt;/td&gt;
&lt;td&gt;timestamp&lt;/td&gt;
&lt;td&gt;åˆ›å»ºæ—¶é—´&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;updated_at&lt;/td&gt;
&lt;td&gt;timestamp&lt;/td&gt;
&lt;td&gt;ä¿®æ”¹æ—¶é—´&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;ERå…³ç³»ï¼š&lt;/p&gt;
&lt;p&gt;[tbl_shop_items] &amp;lt;-N&amp;mdash;1-&amp;gt; (create) [tbl_users]&lt;/p&gt;
&lt;p&gt;[tbl_shop_items] &amp;lt;-1&amp;mdash;N-&amp;gt; [tbl_user_items] (record)   &amp;lt;-M&amp;mdash;1-&amp;gt; [tbl_users]&lt;/p&gt;
&lt;p&gt;[tbl_shop_items] &amp;lt;-1&amp;mdash;N-&amp;gt; [tbl_user_orders] (order) &amp;lt;-M&amp;mdash;1-&amp;gt; [users]&lt;/p&gt;
&lt;h3 id=&#34;æ¶ˆæ¯è®¾è®¡&#34;&gt;æ¶ˆæ¯è®¾è®¡&lt;/h3&gt;
&lt;p&gt;è®¢å•ç”Ÿæˆåï¼Œé€šçŸ¥ä¸‹æ¸¸ç³»ç»Ÿï¼Œè®¢é˜…æ¶ˆæ¯ï¼Œæš‚ä¸è€ƒè™‘ã€‚&lt;/p&gt;
&lt;h3 id=&#34;åç«¯æ¥å£è®¾è®¡&#34;&gt;åç«¯æ¥å£è®¾è®¡&lt;/h3&gt;
&lt;p&gt;å› ä¸ºé€»è¾‘ç®€å•ï¼Œå°±æ²¡æœ‰ç”»å‡ºæ¥å£åŠŸèƒ½çš„æ—¶åºå›¾å’Œæµç¨‹å›¾ã€‚&lt;/p&gt;
&lt;h4 id=&#34;shop-backend--æœåŠ¡ç«¯å£2021&#34;&gt;Shop-backend  æœåŠ¡ç«¯å£ï¼š2021&lt;/h4&gt;
&lt;ol&gt;
&lt;li&gt;GET /shop/api/v1/itmes  å•†å“åˆ—è¡¨&lt;/li&gt;
&lt;li&gt;GET /shop/api/v1/items/:id å•†å“è¯¦æƒ…&lt;/li&gt;
&lt;li&gt;GET /shop/api/v1/items/search?q=** æ›´å…·åç§°æœç´¢å•†å“&lt;/li&gt;
&lt;li&gt;POST /shop/api/v1/order  å•†å“ä¸‹å•&lt;/li&gt;
&lt;li&gt;GET  /shop/api/v1/orders/:orderId  è·å–è®¢å•è¯¦æƒ…&lt;/li&gt;
&lt;li&gt;GET /shop/api/v1/users/:uid/orders ç”¨æˆ·å•†å“è®¢å•åˆ—è¡¨&lt;/li&gt;
&lt;/ol&gt;
&lt;h4 id=&#34;shop-admin-backend-æœåŠ¡ç«¯å£2022&#34;&gt;Shop-admin-backend æœåŠ¡ç«¯å£ï¼š2022&lt;/h4&gt;
&lt;ol&gt;
&lt;li&gt;shop items CRUD RESTful api  for resource methods (&lt;a href=&#34;https://docs.adonisjs.com/guides/controllers#resourceful-routes-and-controllers&#34;&gt;route RESTful resource&lt;/a&gt;)&lt;/li&gt;
&lt;li&gt;POST /shopadmin/api/v1/items/:id/check å•†å“å®¡æ ¸&lt;/li&gt;
&lt;li&gt;GET /shopadmin/api/v1/items/:uid  è·å–ç”¨æˆ·åˆ›å»ºçš„å•†å“&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&#34;å‰ç«¯é¡µé¢äº¤äº’è®¾è®¡&#34;&gt;å‰ç«¯é¡µé¢äº¤äº’è®¾è®¡&lt;/h3&gt;
&lt;p&gt;å‰ç«¯é¡µé¢è°ƒè¯•ï¼Œæœ¬åœ°èµ·é¡µé¢æœåŠ¡ç«¯å£è¿›è¡Œæœ¬åœ°è°ƒè¯•&lt;/p&gt;
&lt;h4 id=&#34;shop-frontend-vue-route-component-page&#34;&gt;Shop-frontend (vue route component page)&lt;/h4&gt;
&lt;ol&gt;
&lt;li&gt;/     ä¸»é¡µé¢/æœç´¢ç»“æ„é¡µï¼Œåˆ—è¡¨é¡µé¢ ï¼Œå±•ç¤ºæœç´¢æ¡†&lt;/li&gt;
&lt;li&gt;/items/:id   è¯¦ç»†é¡µé¢ï¼Œ å±•ç¤ºè´­ä¹°æŒ‰é’®&lt;/li&gt;
&lt;li&gt;/user/:id/orders ç”¨æˆ·å•†å“è®¢å•åˆ—è¡¨é¡µé¢&lt;/li&gt;
&lt;li&gt;/error  è®¿é—®ä¸åˆ°çš„é¡µé¢&lt;/li&gt;
&lt;/ol&gt;
&lt;h4 id=&#34;shop-admin-frontend-crud-edge-template-layout-page&#34;&gt;Shop-admin-frontend (CRUD edge template layout page)&lt;/h4&gt;
&lt;p&gt;CRUD RESTful api  for resource methods to render edge page&lt;/p&gt;
&lt;h2 id=&#34;å¼€å‘&#34;&gt;å¼€å‘&lt;/h2&gt;
&lt;p&gt;åˆæœŸæ•´ä½“ä½¿ç”¨å‰ç«¯jså…¨æ ˆå¼€å‘æŠ€æœ¯æ ˆï¼›Typescript é™æ€è¯­è¨€ï¼Œé€šè¿‡ tsc å°†tsç¼–è¯‘æˆjs å‡å°‘é”™è¯¯ï¼›é€šè¿‡npmç®¡ç†ä¾èµ–åŒ…(vim vundle/python pip/php composer/go module/rust cargo)ï¼›ä½¿ç”¨VS Code IDEå¼€å‘ç¥å™¨ç¼–ç (All in ONEï¼Œå¯è¿œç¨‹sshè¿æ¥å®‰è£…äº†linux å†…æ ¸è™šæ‹ŸæœåŠ¡è°ƒè¯•å­¦ä¹ ï¼ŒæŸ¥çœ‹æºç å¾ˆæ–¹ä¾¿)ï¼Œå®‰è£…æ‰€éœ€æ’ä»¶ã€‚&lt;/p&gt;
&lt;p&gt;å…·ä½“å¼€å‘å·¥å…·å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;p&gt;Typescript ç¼–ç¨‹è¯­è¨€(JavaScriptè¶…çº§ tsc 4.5.4 ts-&amp;gt;js) + Node.js è¿è¡Œæ—¶ç¯å¢ƒ(v17.2 V8 JavaScript å¼•æ“ from Google Chrome çš„å†…æ ¸) + Adonis.js MVCåç«¯æ¡†æ¶(v5.0+) + Vue.jså‰ç«¯æ¡†æ¶(v3.0+)  + Element-plus UI å‰ç«¯é¡µé¢UIæ¨¡ç‰ˆ(v1.3)&lt;/p&gt;
&lt;p&gt;tipsï¼šä¸šåŠ¡æ¨¡å—è®¾è®¡å°½é‡æ»¡è¶³SOLIDåŸåˆ™ï¼Œæœ€ç»ˆæ»¡è¶³&lt;strong&gt;é«˜å†…èšï¼Œä½è€¦åˆ&lt;/strong&gt;, å°½é‡è®©å¼€å‘æ¡†æ¶æ¥æ»¡è¶³ã€‚&lt;/p&gt;
&lt;h3 id=&#34;åç«¯æœåŠ¡å¼€å‘&#34;&gt;åç«¯æœåŠ¡å¼€å‘&lt;/h3&gt;
&lt;p&gt;shop-backend, shop-admin-backend æœåŠ¡é€»è¾‘ï¼Œ ä½¿ç”¨tsè¯­è¨€ï¼ŒAdonisJS (MVC+IoCå¼€å‘æ¡†æ¶,é€‚åˆåå°å¼€å‘æ¡†æ¶) 5.0+å¼€å‘ç¯å¢ƒï¼š&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://docs.adonisjs.com/guides/database/introduction&#34;&gt;Model&lt;/a&gt;: app ER(entity relationship) data model -&amp;gt; table schema by migration -&amp;gt; create table -&amp;gt; make  table model&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://docs.adonisjs.com/guides/controllers&#34;&gt;Controller&lt;/a&gt;: make controller for api logic&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://docs.adonisjs.com/guides/routing&#34;&gt;Routing&lt;/a&gt;: http RESTful api router (start preload routes)&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://docs.adonisjs.com/guides/views/introduction&#34;&gt;View&lt;/a&gt;: view  edge template reander frontend page&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://docs.adonisjs.com/guides/validator/introduction&#34;&gt;Validator&lt;/a&gt;: validate data schema&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://docs.adonisjs.com/guides/validator/custom-rules&#34;&gt;Rules&lt;/a&gt;: validate rules(common &amp;amp; DIY  start preload rules)&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://docs.adonisjs.com/guides/middleware&#34;&gt;Middleware&lt;/a&gt;:  Middleware are a series of functions that are executed during an HTTP request before it reaches the route handler. Every function in the chain has the ability to end the request or forward it to the &lt;code&gt;next&lt;/code&gt; function. &lt;strong&gt;&lt;del&gt;server&lt;/del&gt;&lt;/strong&gt; Middleware, &lt;strong&gt;Global&lt;/strong&gt; Middleware, &lt;strong&gt;Naming&lt;/strong&gt; Middleware&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://docs.adonisjs.com/guides/auth/introduction&#34;&gt;Authentication&lt;/a&gt;: using &lt;strong&gt;sessions&lt;/strong&gt;, &lt;strong&gt;basic auth&lt;/strong&gt; or &lt;strong&gt;API tokens(JWT, OAT)&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://docs.adonisjs.com/guides/events&#34;&gt;Events&lt;/a&gt;: define evens listener  to listen async event on(eventName,callback) , then emit event to tigger regist event&amp;rsquo;s callback; eg: new user to emit event callback to send email (DIY events Listenner, start preload events)&lt;/p&gt;
&lt;p&gt;é€šè¿‡adonis-ts-app demo åˆå§‹åŒ–ä¸€ä¸ªapp:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;&lt;span class=&#34;c1&#34;&gt;#new project&lt;/span&gt;
npm init adonis-ts-app@latest shop-backend
npm init adonis-ts-app@latest shop-admin-backend
&lt;span class=&#34;c1&#34;&gt;#install package for mysql &lt;/span&gt;
npm i @adonisjs/lucid@alpha
&lt;span class=&#34;c1&#34;&gt;#invoke package to select mysql for ace make:model and migration table&lt;/span&gt;
node ace configure&lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;invoke&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt; @adonisjs/lucid
&lt;span class=&#34;c1&#34;&gt;#install mysql2&lt;/span&gt;
npm install mysql2
&lt;span class=&#34;c1&#34;&gt;#modify config/database.ts use mysql client: mysql2&lt;/span&gt;

&lt;span class=&#34;c1&#34;&gt;#install auth middleware&lt;/span&gt;
npm i @adonisjs/auth@alpha
&lt;span class=&#34;c1&#34;&gt;#install Argon2 password hashing algorithm following the PHC string format&lt;/span&gt;
npm install phc-argon2
&lt;span class=&#34;c1&#34;&gt;#invoke package to select lucid and api tokens&lt;/span&gt;
&lt;span class=&#34;c1&#34;&gt;# https://docs.adonisjs.com/guides/auth/introduction&lt;/span&gt;
node ace invoke @adonisjs/auth
&lt;span class=&#34;c1&#34;&gt;# rigister auth naming middleware in start/kernel.js  auth: &amp;#39;App/Middleware/Auth&amp;#39;,&lt;/span&gt;
&lt;span class=&#34;c1&#34;&gt;# add auth middleware for router in start/router.js  &lt;/span&gt;
&lt;span class=&#34;c1&#34;&gt;# use database-backed opaque access token&lt;/span&gt;
&lt;span class=&#34;c1&#34;&gt;# demo: https://dev.to/tngeene/adonisjs-understanding-user-registration-and-authentication-2ojl&lt;/span&gt;
&lt;span class=&#34;c1&#34;&gt;# for session auth&lt;/span&gt;
npm i @adonisjs/session 
&lt;span class=&#34;c1&#34;&gt;# for CSRF token protection&lt;/span&gt;
npm i @adonisjs/shield 
&lt;span class=&#34;c1&#34;&gt;#invoke add fhield global middleware in start/kernel.js () =&amp;gt; import(&amp;#39;@ioc:Adonis/Addons/Shield&amp;#39;)&lt;/span&gt;
node ace invoke @adonisjs/shield

&lt;span class=&#34;c1&#34;&gt;#change .env modify mysql conf&lt;/span&gt;
&lt;span class=&#34;c1&#34;&gt;#migration table&lt;/span&gt;
node ace make:migration &lt;span class=&#34;o&#34;&gt;{&lt;/span&gt;table&lt;span class=&#34;o&#34;&gt;}&lt;/span&gt;
&lt;span class=&#34;c1&#34;&gt;#migration create/rollback table&lt;/span&gt;
node ace migration:run / node ace migration:rollback

&lt;span class=&#34;c1&#34;&gt;#then u can use ace to make a new model app/Models/***.ts&lt;/span&gt;
node ace make:model ***
&lt;span class=&#34;c1&#34;&gt;#then u can use ace to make a new app/Controllers/Http/***Controller.ts&lt;/span&gt;
node ace make:controller ***
&lt;span class=&#34;c1&#34;&gt;#if use edge tpl, u can use ace to make a new view to render tpl&lt;/span&gt;
node ace make:view ***
&lt;span class=&#34;c1&#34;&gt;#if valide request param, u can use ace to make a new volidator&lt;/span&gt;
&lt;span class=&#34;c1&#34;&gt;#https://docs.adonisjs.com/guides/validator/introduction&lt;/span&gt;
node ace make:validator ***
&lt;span class=&#34;c1&#34;&gt;#or diy validate rules&lt;/span&gt;
node ace make:prldfile validator

&lt;span class=&#34;c1&#34;&gt;#make events to gen start/events.ts for listen on(eventName,callback)&lt;/span&gt;
node ace make:prldfile events
&lt;span class=&#34;c1&#34;&gt;#or make listener to listen on eventsList &lt;/span&gt;
node ace make:listener ***


&lt;span class=&#34;c1&#34;&gt;#make a middleware like auth middleware;&lt;/span&gt;
&lt;span class=&#34;c1&#34;&gt;#transmit by ctx, ctx-&amp;gt;ctx-&amp;gt;ctx to next()&lt;/span&gt;
&lt;span class=&#34;c1&#34;&gt;#eg: u can make a user action log middleware to analyse or A/B test for recommended system&lt;/span&gt;
&lt;span class=&#34;c1&#34;&gt;#https://docs.adonisjs.com/guides/middleware&lt;/span&gt;
node ace make:middleware ***

&lt;span class=&#34;c1&#34;&gt;# https://github.com/luin/ioredis/blob/master/API.md&lt;/span&gt;
&lt;span class=&#34;c1&#34;&gt;# https://docs.adonisjs.com/guides/redis&lt;/span&gt;
&lt;span class=&#34;c1&#34;&gt;#install redis&lt;/span&gt;
npm i @adonisjs/redis
node ace configure @adonisjs/redis

&lt;span class=&#34;c1&#34;&gt;# https://www.npmjs.com/package/@elastic/elasticsearch&lt;/span&gt;
&lt;span class=&#34;c1&#34;&gt;# https://www.elastic.co/guide/en/elasticsearch/client/javascript-api/current/typescript.html&lt;/span&gt;
npm i @elastic/elasticsearch


&lt;span class=&#34;c1&#34;&gt;# watch run &lt;/span&gt;
node ace serve --watch
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;å‰ç«¯å¼€å‘&#34;&gt;å‰ç«¯å¼€å‘&lt;/h3&gt;
&lt;p&gt;Shop-frontend, shop-admin-frontend å‰ç«¯é¡µé¢é€»è¾‘ï¼Œä½¿ç”¨TypeScript+ Vue.js(å‰ç«¯å¼€å‘æ¡†æ¶) + ElementUIç»„ä»¶ é€šè¿‡viteæ„å»ºæœ¬åœ°å¼€å‘(CIè¿‡ç¨‹é€šè¿‡webpackæ‰“åŒ…ç”Ÿæˆé™æ€èµ„æºï¼Œé€šè¿‡CDéƒ¨ç½²åˆ°è¾¹ç¼˜CDNèŠ‚ç‚¹)ï¼Œå¼€å‘ç¯å¢ƒå…·ä½“æ“ä½œå¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;p&gt;Vue.js 3 + TypeScript + Vite + ElementUI-plus&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://next.router.vuejs.org/zh/&#34;&gt;vue router&lt;/a&gt;: é€šè¿‡ Vue.jsï¼Œç”¨ç»„ä»¶ç»„æˆåº”ç”¨ï¼›é€šè¿‡ Vue Router å°†ç»„ä»¶æ˜ å°„åˆ°è·¯ç”±ä¸Šï¼Œè®© Vue Router çŸ¥é“åœ¨å“ªé‡Œæ¸²æŸ“å®ƒä»¬;&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://axios-http.com/zh/docs/intro&#34;&gt;axios&lt;/a&gt;: HTTP ç½‘ç»œclientè¯·æ±‚åº“;&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://next.vuex.vuejs.org/zh/index.html&#34;&gt;vuex&lt;/a&gt;: state management pattern + library stat/view/actions like MVC;&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://vee-validate.logaretm.com/v4/guide/overview&#34;&gt;vee-validate&lt;/a&gt;: form validation;  &lt;a href=&#34;https://www.npmjs.com/package/yup&#34;&gt;yup&lt;/a&gt;:  data schema validation;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;&lt;span class=&#34;c1&#34;&gt;# install vue cli&lt;/span&gt;
npm install -g @vue/cli
&lt;span class=&#34;c1&#34;&gt;# u can use vue create app use vue.js v3&lt;/span&gt;
&lt;span class=&#34;c1&#34;&gt;# vue create vue-app &amp;amp; cd vue-app&lt;/span&gt;
&lt;span class=&#34;c1&#34;&gt;# vue add element-plus&lt;/span&gt;

&lt;span class=&#34;c1&#34;&gt;# or use vite build vue.js v3 project app&lt;/span&gt;
npm init @vitejs/app shop-frontend 
npm init @vitejs/app shop-admin-frontend

&lt;span class=&#34;c1&#34;&gt;# eg: shop-frontend&lt;/span&gt;
&lt;span class=&#34;nb&#34;&gt;cd&lt;/span&gt; shop-frontend &lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;shop-admin-frontend&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;
&lt;span class=&#34;c1&#34;&gt;# choose vue-ts when install&lt;/span&gt;
npm install

&lt;span class=&#34;c1&#34;&gt;# install vue-router4, https://next.router.vuejs.org/zh/&lt;/span&gt;
npm install vue-router@4

&lt;span class=&#34;c1&#34;&gt;# install axios https://axios-http.com/zh/docs/intro&lt;/span&gt;
npm install axios

&lt;span class=&#34;c1&#34;&gt;# install vuex, nice design(state management pattern + library stat/view/actions like MVC)  &lt;/span&gt;
&lt;span class=&#34;c1&#34;&gt;# https://next.vuex.vuejs.org/zh/index.html&lt;/span&gt;
npm install vuex@next --save

&lt;span class=&#34;c1&#34;&gt;# install vee-validate, https://vee-validate.logaretm.com/v4/guide/overview&lt;/span&gt;
npm i vee-validate@next --save


&lt;span class=&#34;c1&#34;&gt;#install element-plus ui&lt;/span&gt;
npm install element-plus --save
npm i -D sass
&lt;span class=&#34;c1&#34;&gt;#auto import &lt;/span&gt;
npm install -D unplugin-vue-components unplugin-auto-import

&lt;span class=&#34;c1&#34;&gt;# run local vue dev runtime app service (vite --port 5000 --host)&lt;/span&gt;
npm run dev

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;é™„å…·ä½“ä»£ç (Monolithç‰ˆæœ¬, åç«¯çŠ¶æ€å­˜å‚¨æ•°æ®è¯»å†™ä½¿ç”¨åŒä¸€ä¸ªæ•°æ®æº)ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/weedge/backend-adonisjs-api/tree/main/shop-admin-backend&#34;&gt;Shop-admin-backend&lt;/a&gt; : åå°ç®¡ç†ç³»ç»Ÿï¼Œä¸ºäº†æ–¹ä¾¿åç»­æ ¹æ®æ•°æ®åº“è¡¨ä¸€é”®ç”ŸæˆCURDä»£ç ï¼Œé‡‡ç”¨åç«¯æ¨¡ç‰ˆedge templateï¼›ç”¨æˆ·ç®¡ç†å¯ä»¥é‡‡ç”¨å†…éƒ¨å…¬å¸ç”¨æˆ·å¹³å°SSOå•ç‚¹ç™»å½•è·å–ticketçš„æ–¹å¼ï¼Œæˆ–è€…ä½¿ç”¨æ¡†æ¶æœ¬èº«çš„èº«ä»½è®¤è¯åŠŸèƒ½è¿›è¡Œåå°æ¨¡å—çš„æƒé™ç®¡ç†(web authentication)&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/weedge/backend-adonisjs-api/tree/main/adonisjs-shop-backend-api&#34;&gt;Shop-backend-api&lt;/a&gt;ï¼šåç«¯æ¥å£ï¼Œè·å–æ¥å£æ•°æ®ï¼Œéœ€è¦ç™»å½•éªŒè¯ï¼Œå’Œtokené‰´æƒï¼Œè®°å½•ç”¨æˆ·è¡Œä¸ºæ—¥å¿—ï¼Œè¯»å†™æ“ä½œæ•°æ®åº“å’Œç¼“å­˜ç­‰ï¼›&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/weedge/frontend-vue/tree/main/vue-shop-frontend&#34;&gt;Shop-frontend-vue&lt;/a&gt;ï¼šå‰ç«¯é¡µé¢ï¼Œä½¿ç”¨vueæ¡†æ¶å¼€å‘ï¼Œè®¿é—®åç«¯APIä½¿ç”¨axiosï¼ŒçŠ¶æ€ç®¡ç†ä½¿ç”¨vuexï¼Œé¡µé¢è·¯ç”±ä½¿vue-routerï¼Œè¡¨å•éªŒè¯å’Œæ•°æ®éªŒè¯åˆ†åˆ«ä½¿ç”¨vee-valdateå’Œyupï¼Œç»„ä»¶çš„ä½¿ç”¨éœ€è¦ç»“åˆæ–‡æ¡£ä½¿ç”¨ï¼›é¦–é¡µ/æœç´¢ç»“æœé¡µå±•ç¤ºå•†å“åˆ—è¡¨ï¼Œç‚¹å‡»æ›´å¤šè¿›å…¥å•†å“è¯¦ç»†é¡µé¢è¿›è¡Œè´­ä¹°ï¼Œè´­ä¹°éœ€è¦ç™»å½•/æ³¨å†Œï¼Œç™»å½•åè¿›å…¥è®¢å•åˆ—è¡¨é¡µï¼Œå…·ä½“éœ€æ±‚æ¨åŠ¨ï¼›&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&#34;æ•´ä½“è”è°ƒ&#34;&gt;æ•´ä½“è”è°ƒ&lt;/h3&gt;
&lt;p&gt;è¿™é‡Œå‰åç«¯ç»Ÿä¸€æŠ€æœ¯æ ˆé‡‡ç”¨js on node  by (AdonisJS 5 + Vue 3 + Element-plus UI)ï¼Œ å¦‚æœç†Ÿæ‚‰node js  å¾ˆæ–¹ä¾¿è°ƒè¯•ï¼Œå¼€å‘1äººå·¥å…¨æ ˆæå®šå°±è¡Œï¼Œè‡³äºå¤–éƒ¨éœ€æ±‚UIçš„è°ƒæ•´ç¾åŒ–ç”±PMå’Œè®¾è®¡å¸ˆç¡®å®šå¥½ï¼Œå°½é‡é€šè¿‡å·¥å…·è‡ªåŠ¨åŒ–ï¼Œ é™ä½æ²Ÿé€šæˆæœ¬ï¼›&lt;/p&gt;
&lt;p&gt;å½“ç„¶å½“åç»­ç³»ç»Ÿåˆ‡æˆå¾®æœåŠ¡ï¼ŒæŠŠ1äººå·¥å…¨æ ˆçš„æ´»åˆ†æˆå¤šä¸ªäººæ¥ç»´æŠ¤ï¼Œä»å…¬å¸å’Œç»„ç»‡æ¶æ„å±‚é¢æ¥è¯´ï¼Œè™½ç„¶å¢åŠ äº†å¼€å‘æ²Ÿé€šæˆæœ¬ï¼Œä½†æ˜¯å¯¹å…¬å¸æ¥è¯´æ˜¯æœ‰åˆ©çš„ï¼Œäººå‘˜ç¦»èŒå¯¹ç³»ç»Ÿå½±å“ä¼šé™ä½å¾ˆå¤šå§(from: éƒ­è€å¸ˆçš„æ¶æ„è¯¾,ä»¥å¿ƒç†å­¦+è®¤çŸ¥ç­‰æ–¹é¢)ï¼›&lt;/p&gt;
&lt;h2 id=&#34;æ€»ç»“&#34;&gt;æ€»ç»“&lt;/h2&gt;
&lt;p&gt;å‰ç«¯çš„æŠ€æœ¯è¿­ä»£é€Ÿåº¦æ˜¯å¿«äºåç«¯çš„ï¼Œä¸»è¦æ˜¯å‰ç«¯æœ‰å¤§é‡çš„éœ€æ±‚å¼€å‘ï¼Œä¸ç®¡æ˜¯å¤–éƒ¨ä¸šåŠ¡è¿˜æ˜¯å†…éƒ¨éœ€æ±‚å¼€å‘ï¼Œæ‰€ä»¥éœ€è¦æ»¡è¶³ä¸šåŠ¡åœºæ™¯ä¸‹çš„é«˜æ•ˆè¿­ä»£é€Ÿåº¦ï¼Œè¡ç”Ÿå‡ºé«˜æ•ˆçš„å¼€å‘æ¡†æ¶å·¥å…·å’ŒUIç»„ä»¶å¤ç”¨ï¼ŒåŒæ—¶éœ€è¦ä¿æŒå·¥å…·åœ¨é¡¹ç›®ä¸­çš„è¿­ä»£å‡çº§ï¼Œè€Œä¸”åœ¨åŸºäºå‰ç«¯æŠ€æœ¯å‘å±•è§¦åŠåˆ°åç«¯å¼€å‘ï¼Œæ¼”å˜å‡ºå‰åæŠ€æœ¯æ ˆç»Ÿä¸€çš„å…¨æ ˆå¼€å‘ï¼Œä½†æ˜¯éœ€æ±‚å¢å¤šï¼Œéœ€è¦æ›´å¤šçš„èµ„æºæ¥æ‰¿è½½ç”¨æˆ·è¯·æ±‚ï¼Œå¯¹äºåç«¯ä¸€äº›åŸºç¡€ç»„ä»¶æœåŠ¡å’Œæ€§èƒ½ä¼˜åŒ–çš„åœºæ™¯ï¼Œè¿˜æ˜¯éœ€è¦æ ¹æ®&lt;strong&gt;è¯­è¨€ç‰¹æ€§ï¼ŒäººåŠ›ï¼Œç»„ç»‡ç»“æ„&lt;/strong&gt;ç­‰å› ç´ è€ƒè™‘ï¼›å‰ç«¯æŠ€æœ¯åº•å±‚å¼•æ“å’ŒåŸç†æ€§åŸºç¡€çŸ¥è¯†æ˜¯ä¸æ˜“å˜çš„ï¼Œå¯ä»¥åœ¨å…³æ³¨å˜åŒ–çš„è¿‡ç¨‹ä¸­ï¼Œæ·±å…¥æµ…å‡ºå…±æ€§çš„åº•å±‚é€»è¾‘ï¼Œä»¥ä¸å˜åº”ä¸‡å˜ï¼›å·¥æ¬²å–„å…¶äº‹ï¼Œå¿…å…ˆåˆ©å…¶å™¨ï¼›(ä¸ç®¡æ˜¯å‰ç«¯/åç«¯å¼€å‘ï¼ŒDevOps, ä»¥åŠå¤§æ•°æ®å¼€å‘ï¼Œç”šè‡³AIï¼Œ&lt;strong&gt;ç†Ÿç»ƒ&lt;/strong&gt;åˆ©ç”¨å¥½å·¥å…·ï¼Œå·¥å…·æ˜¯åœ¨åº”ç”¨åœºæ™¯ä¸‹æ²‰æ·€ä¸‹æ¥çš„ï¼Œ&lt;strong&gt;ç†è§£&lt;/strong&gt;åŸºç¡€åŸç†å’Œå·¥å…·è®¾è®¡åŸç†ï¼Œç»“åˆä½¿ç”¨åœºæ™¯ï¼Œå¿«é€Ÿå®šä½(æ–‡æ¡£ï¼Œé—®é¢˜)ï¼Œè¾“å‡ºæœ€å¤§åŒ–ï¼ŒæŠ€æœ¯å·¥å…·æ²¡æœ‰é“¶å¼¹ï¼Œåº”ç”¨åœ¨é€‚ç”¨åœºæ™¯è¾¾åˆ°äº‹åŠåŠŸå€æ•ˆæœï¼Œå­¦ä¼šåœ¨å·¨äººçš„è‚©è†€ä¸Šè€ƒè™‘é—®é¢˜ï¼Œæäº‹æƒ…)ã€‚&lt;/p&gt;
&lt;h2 id=&#34;reference&#34;&gt;reference&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;ECMAScript: &lt;a href=&#34;https://tc39.es/ecma262/&#34;&gt;https://tc39.es/ecma262/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;ts: &lt;a href=&#34;https://www.typescriptlang.org/&#34;&gt;https://www.typescriptlang.org/&lt;/a&gt;      &lt;a href=&#34;https://typescript.bootcss.com/&#34;&gt;https://typescript.bootcss.com/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;why-ts: &lt;a href=&#34;https://serokell.io/blog/why-typescript&#34;&gt;https://serokell.io/blog/why-typescript&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Node.js: &lt;a href=&#34;http://nodejs.cn/learn&#34;&gt;http://nodejs.cn/learn&lt;/a&gt;  &lt;strong&gt;&lt;a href=&#34;https://nodejs.org/dist/latest-v17.x/docs/api/&#34;&gt;https://nodejs.org/dist/latest-v17.x/docs/api/&lt;/a&gt;&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;V8 JavaScript/&lt;a href=&#34;https://developer.mozilla.org/zh-CN/docs/WebAssembly/Concepts&#34;&gt;WebAssembly&lt;/a&gt; Engine: &lt;strong&gt;&lt;a href=&#34;https://chromium.googlesource.com/v8/v8.git&#34;&gt;https://chromium.googlesource.com/v8/v8.git&lt;/a&gt;&lt;/strong&gt; &lt;strong&gt;&lt;a href=&#34;https://v8.dev/docs&#34;&gt;https://v8.dev/docs&lt;/a&gt;&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;Adonis.js5: &lt;a href=&#34;https://adonisjs.com/&#34;&gt;https://adonisjs.com/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Adonis.js5 + Edge template demo: &lt;a href=&#34;https://masteringbackend.com/posts/adonisjs-tutorial-the-ultimate-guide&#34;&gt;https://masteringbackend.com/posts/adonisjs-tutorial-the-ultimate-guide&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Adonis.js5 + Vue.js3 demo: &lt;a href=&#34;https://www.section.io/engineering-education/build-a-ticketing-app-with-adonisjs-and-vuejs/&#34;&gt;https://www.section.io/engineering-education/build-a-ticketing-app-with-adonisjs-and-vuejs/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Vue.js3: &lt;a href=&#34;https://v3.cn.vuejs.org/guide/introduction.html&#34;&gt;https://v3.cn.vuejs.org/guide/introduction.html&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Vite: &lt;a href=&#34;https://cn.vitejs.dev/guide/&#34;&gt;https://cn.vitejs.dev/guide/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Vue CLI: &lt;a href=&#34;https://cli.vuejs.org/zh/guide/&#34;&gt;https://cli.vuejs.org/zh/guide/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Element-Plus UI: &lt;a href=&#34;https://element-plus.gitee.io/zh-CN/guide/installation.html&#34;&gt;https://element-plus.gitee.io/zh-CN/guide/installation.html&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;webpack: &lt;a href=&#34;https://webpack.docschina.org/concepts/&#34;&gt;https://webpack.docschina.org/concepts/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;webå¼€å‘: &lt;strong&gt;&lt;a href=&#34;https://developer.mozilla.org/zh-CN/docs/Web&#34;&gt;https://developer.mozilla.org/zh-CN/docs/Web&lt;/a&gt;&lt;/strong&gt;&lt;/li&gt;
&lt;/ol&gt;</description>
      
    </item>
    
    <item>
      <title>CRDT</title>
      <link>https://weedge.github.io/post/crdt/</link>
      <pubDate>Tue, 28 Dec 2021 10:26:23 +0800</pubDate>
      
      <guid>https://weedge.github.io/post/crdt/</guid>
      
        <description>&lt;h2 id=&#34;ä»‹ç»&#34;&gt;ä»‹ç»&lt;/h2&gt;
&lt;p&gt;&lt;strong&gt;æ— å†²çªå¤åˆ¶æ•°æ®ç±»å‹&lt;/strong&gt;(CRDT: &lt;strong&gt;conflict-free replicated data type&lt;/strong&gt;) æ˜¯ä¸€ç§ç®€åŒ–åˆ†å¸ƒå¼æ•°æ®å­˜å‚¨ç³»ç»Ÿå’Œå¤šç”¨æˆ·åº”ç”¨ç¨‹åºçš„æ•°æ®ç»“æ„ã€‚&lt;/p&gt;
&lt;p&gt;åœ¨è®¸å¤šç³»ç»Ÿä¸­ï¼ŒæŸäº›æ•°æ®çš„å‰¯æœ¬éœ€è¦å­˜å‚¨åœ¨å¤šå°è®¡ç®—æœºä¸Šã€‚æ­¤ç±»ç³»ç»Ÿçš„ç¤ºä¾‹åŒ…æ‹¬ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;åœ¨æœ¬åœ°è®¾å¤‡ä¸Šå­˜å‚¨æ•°æ®ï¼Œå¹¶ä¸”éœ€è¦å°†è¯¥æ•°æ®åŒæ­¥åˆ°å±äºåŒä¸€ç”¨æˆ·çš„å…¶ä»–è®¾å¤‡ï¼ˆåŒä¸€ç”¨æˆ·å¤šç«¯è®¾å¤‡åŒæ­¥ï¼Œä¾‹å¦‚æ—¥å†ã€ç¬”è®°ã€è”ç³»äººæˆ–æé†’ï¼‰çš„ç§»åŠ¨åº”ç”¨ç¨‹åºï¼›&lt;/li&gt;
&lt;li&gt;åˆ†å¸ƒå¼æ•°æ®åº“ï¼Œç»´æŠ¤æ•°æ®çš„å¤šä¸ªå‰¯æœ¬ï¼ˆåœ¨åŒä¸€æ•°æ®ä¸­å¿ƒæˆ–ä¸åŒä½ç½®,ä¸€èˆ¬æ˜¯ä¸åŒæ•°æ®ä¸­å¿ƒçš„å¤šæ´»åœºæ™¯ï¼‰ï¼Œä»¥ä¾¿åœ¨æŸäº›å‰¯æœ¬ç¦»çº¿æ—¶ç³»ç»Ÿç»§ç»­æ­£å¸¸å·¥ä½œï¼›&lt;/li&gt;
&lt;li&gt;åä½œè½¯ä»¶ï¼Œä¾‹å¦‚ Google Docsã€Trelloã€Figma æˆ–è®¸å¤šå…¶ä»–è½¯ä»¶ï¼Œå…¶ä¸­å¤šä¸ªç”¨æˆ·å¯ä»¥åŒæ—¶æ›´æ”¹åŒä¸€æ–‡ä»¶æˆ–æ•°æ®ï¼›&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://docs.microsoft.com/en-us/shows/tech-exceptions/concordant-always-know-what-to-expect-from-your-data&#34;&gt;è¾¹ç¼˜è®¡ç®—åœºæ™¯&lt;/a&gt;ï¼Œæ¯”å¦‚å¤šä¸ªæ‰‹æœº/è½¦è½½app åœ¨æ— ä¿¡å·çš„æ£®æ—ä¸­ï¼Œäº§ç”Ÿçš„æœ¬åœ°ç¦»çº¿ååŒæ•°æ®ï¼Œå¤šä¸ªè®¾å¤‡åŒæ­¥åˆ°äº‘ä¸Šå¤„ç†;&lt;/li&gt;
&lt;li&gt;å¤§è§„æ¨¡æ•°æ®å­˜å‚¨å’Œå¤„ç†ç³»ç»Ÿï¼Œå¤åˆ¶æ•°æ®ä»¥å®ç°å…¨çƒå¯æ‰©å±•æ€§ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;æ‰€æœ‰æ­¤ç±»ç³»ç»Ÿéƒ½éœ€è¦å¤„ç†æ•°æ®å¯èƒ½åœ¨ä¸åŒå‰¯æœ¬ä¸ŠåŒæ—¶ä¿®æ”¹çš„äº‹å®ã€‚ä»å¹¿ä¹‰ä¸Šè®²ï¼Œæœ‰ä¸¤ç§å¯èƒ½çš„æ–¹æ³•æ¥å¤„ç†æ­¤ç±»æ•°æ®ä¿®æ”¹ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;å¼ºä¸€è‡´æ€§å¤åˆ¶ï¼š&lt;/p&gt;
&lt;p&gt;åœ¨è¿™ä¸ªæ¨¡å‹ä¸­ï¼Œå‰¯æœ¬ç›¸äº’åè°ƒä»¥å†³å®šä½•æ—¶ä»¥åŠå¦‚ä½•åº”ç”¨ä¿®æ”¹ã€‚è¿™ç§æ–¹æ³•æ”¯æŒå¼ºä¸€è‡´æ€§æ¨¡å‹ï¼Œä¾‹å¦‚å¯åºåˆ—åŒ–äº‹åŠ¡å’Œå¯çº¿æ€§åŒ–ã€‚ç„¶è€Œï¼Œç­‰å¾…è¿™ç§åè°ƒä¼šé™ä½è¿™äº›ç³»ç»Ÿçš„æ€§èƒ½ï¼›æ­¤å¤–ï¼ŒCAP å®šç†å‘Šè¯‰æˆ‘ä»¬ï¼Œå½“å‰¯æœ¬ä¸ç³»ç»Ÿçš„å…¶ä½™éƒ¨åˆ†æ–­å¼€è¿æ¥æ—¶ï¼ˆä¾‹å¦‚ï¼Œç”±äºç½‘ç»œåˆ†åŒºï¼Œæˆ–è€…å› ä¸ºå®ƒæ˜¯å…·æœ‰é—´æ­‡æ€§è¿æ¥çš„ç§»åŠ¨è®¾å¤‡ï¼‰ï¼Œä¸å¯èƒ½å¯¹å‰¯æœ¬è¿›è¡Œä»»ä½•æ•°æ®æ›´æ”¹ã€‚&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;ä¹è§‚å¤åˆ¶ï¼š&lt;/p&gt;
&lt;p&gt;åœ¨æ­¤æ¨¡å‹ä¸­ï¼Œç”¨æˆ·å¯ä»¥ç‹¬ç«‹äºä»»ä½•å…¶ä»–å‰¯æœ¬ä¿®æ”¹ä»»ä½•å‰¯æœ¬ä¸Šçš„æ•°æ®ï¼Œå³ä½¿è¯¥å‰¯æœ¬ç¦»çº¿æˆ–ä¸å…¶ä»–å‰¯æœ¬æ–­å¼€è¿æ¥ã€‚è¿™ç§æ–¹æ³•å¯å®ç°æœ€å¤§çš„æ€§èƒ½å’Œå¯ç”¨æ€§ï¼Œä½†å½“å¤šä¸ªå®¢æˆ·ç«¯æˆ–ç”¨æˆ·åŒæ—¶ä¿®æ”¹åŒä¸€æ¡æ•°æ®æ—¶ï¼Œå®ƒå¯èƒ½ä¼šå¯¼è‡´å†²çªã€‚å½“å‰¯æœ¬ç›¸äº’é€šä¿¡æ—¶ï¼Œéœ€è¦è§£å†³è¿™äº›å†²çªã€‚&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;æ— å†²çªå¤åˆ¶æ•°æ®ç±»å‹ (CRDT) ç”¨äºå…·æœ‰ä¹è§‚å¤åˆ¶çš„ç³»ç»Ÿï¼Œå®ƒä»¬è´Ÿè´£è§£å†³å†²çªã€‚CRDT ç¡®ä¿ï¼Œæ— è®ºåœ¨ä¸åŒçš„å‰¯æœ¬ä¸Šè¿›è¡Œä»€ä¹ˆæ•°æ®ä¿®æ”¹ï¼Œæ•°æ®å§‹ç»ˆå¯ä»¥åˆå¹¶åˆ°ä¸€è‡´çš„çŠ¶æ€ã€‚æ­¤åˆå¹¶ç”± CRDT è‡ªåŠ¨æ‰§è¡Œï¼Œæ— éœ€ä»»ä½•ç‰¹æ®Šçš„å†²çªè§£å†³ä»£ç æˆ–ç”¨æˆ·å¹²é¢„ã€‚&lt;/p&gt;
&lt;h2 id=&#34;åŸç†&#34;&gt;åŸç†&lt;/h2&gt;
&lt;h2 id=&#34;å®ç°&#34;&gt;å®ç°&lt;/h2&gt;
&lt;h3 id=&#34;automergehttpsgithubcomautomergeautomerge&#34;&gt;&lt;a href=&#34;https://github.com/automerge/automerge&#34;&gt;automerge&lt;/a&gt;&lt;/h3&gt;
&lt;h3 id=&#34;yjshttpsgithubcomyjsyjs&#34;&gt;&lt;a href=&#34;https://github.com/yjs/yjs&#34;&gt;Yjs&lt;/a&gt;&lt;/h3&gt;
&lt;h3 id=&#34;redis-crdbhttpsrediscomredis-enterprisetechnologyactive-active-geo-distribution&#34;&gt;&lt;a href=&#34;https://redis.com/redis-enterprise/technology/active-active-geo-distribution/&#34;&gt;redis (CRDB)&lt;/a&gt;&lt;/h3&gt;
&lt;h2 id=&#34;references&#34;&gt;references&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;&lt;a href=&#34;https://en.wikipedia.org/wiki/Conflict-free_replicated_data_type&#34;&gt;wiki: Conflict-free replicated data type&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/alangibson/awesome-crdt#know-before-you-go&#34;&gt;awesome-crdt#know-before-you-go&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;&lt;a href=&#34;https://crdt.tech/resources&#34;&gt;crdt.tech-resources&lt;/a&gt;&lt;/strong&gt; &lt;strong&gt;&lt;a href=&#34;https://crdt.tech/implementations&#34;&gt;crdt.tech-implementations&lt;/a&gt;&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://hal.inria.fr/hal-00932836/file/CRDTs_SSS-2011.pdf&#34;&gt;Conflict-free Replicated Data Types.pdf&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;&lt;a href=&#34;https://hal.inria.fr/file/index/docid/555588/filename/techreport.pdf?spm=a2c6h.12873639.0.0.a25177aaoVMJMH&amp;amp;file=techreport.pdf&#34;&gt;A comprehensive study of Convergent and Commutative Replicated Data Types.pdf&lt;/a&gt;&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;&lt;a href=&#34;https://arxiv.org/pdf/1806.10254.pdf&#34;&gt;Conflict-free Replicated Data Types: An Overview.pdf&lt;/a&gt;&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://www.isa-afp.org/browser_info/current/AFP/CRDT/document.pdf&#34;&gt;A framework for establishing Strong Eventual Consistency for Conflict-free Replicated Data types.pdf&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;&lt;a href=&#34;https://arxiv.org/pdf/1608.03960.pdf&#34;&gt;A Conflict-Free Replicated JSON Datatype.pdf&lt;/a&gt;&lt;/strong&gt; &lt;a href=&#34;https://cs.paperswithcode.com/paper/a-conflict-free-replicated-json-datatype&#34;&gt;code&lt;/a&gt; &lt;a href=&#34;https://www.youtube.com/watch?v=TRvQzwDyVro&#34;&gt;vedio introduce&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;&lt;a href=&#34;https://www.youtube.com/watch?v=GXJ0D2tfZCM&#34;&gt;Automerge: Making Servers Optional for Real-Time Collaboration&lt;/a&gt;&lt;/strong&gt; &lt;a href=&#34;https://speakerdeck.com/ept/automerge-making-servers-optional-for-real-time-collaboration&#34;&gt;slide&lt;/a&gt; &lt;a href=&#34;https://github.com/automerge&#34;&gt;github.com/automerge&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://www.researchgate.net/publication/310212186_Near_Real-Time_Peer-to-Peer_Shared_Editing_on_Extensible_Data_Types&#34;&gt;Near Real-Time Peer-to-Peer Shared Editing on Extensible Data Types.pdf&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://www.sciencedirect.com/science/article/pii/S1877050921014101&#34;&gt;Toward Fast and Reliable Active-Active Geo-Replication for a Distributed Data Caching Service in the Mobile Cloud&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://redis.com/redis-enterprise/technology/active-active-geo-distribution/&#34;&gt;redis: active-active-geo-distribution&lt;/a&gt; &lt;a href=&#34;https://docs.redis.com/latest/rs/references/developing-for-active-active/&#34;&gt;redis: Developing applications with Active-Active databases&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://docs.riak.com/riak/kv/2.0.0/developing/data-types/?spm=a2c6h.12873639.0.0.a25177aaoVMJMH&#34;&gt;riak-kv:Data Types&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;&lt;a href=&#34;https://developer.aliyun.com/article/635632&#34;&gt;é˜¿é‡Œäº‘redisï¼šCRDTâ€”â€”è§£å†³æœ€ç»ˆä¸€è‡´é—®é¢˜çš„åˆ©å™¨&lt;/a&gt;&lt;/strong&gt;  &lt;a href=&#34;https://developer.aliyun.com/article/781709?utm_content=g_1000239229&#34;&gt;å¤šä¸­å¿ƒå®¹ç¾å®è·µï¼šå¦‚ä½•å®ç°çœŸæ­£çš„å¼‚åœ°å¤šæ´»ï¼Ÿ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://zhuanlan.51cto.com/art/202107/674513.htm&#34;&gt;åŸºäºCRDTçš„æ•°æ®æœ€ç»ˆä¸€è‡´æ€§&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://ddia.vonng.com/#/ch5?id=%E5%A4%9A%E4%B8%BB%E5%A4%8D%E5%88%B6&#34;&gt;å¤šä¸»å¤åˆ¶&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;</description>
      
    </item>
    
    <item>
      <title>pool</title>
      <link>https://weedge.github.io/post/pool/</link>
      <pubDate>Thu, 02 Dec 2021 12:26:23 +0800</pubDate>
      
      <guid>https://weedge.github.io/post/pool/</guid>
      
        <description>&lt;h2 id=&#34;ä»‹ç»&#34;&gt;ä»‹ç»&lt;/h2&gt;
&lt;p&gt;å¹³å¸¸æƒ³åˆ°ä¸æµªè´¹èµ„æºçš„æ–¹æ³•ï¼Œæ˜¯å¯¹èµ„æºè¿›è¡Œå¤ç”¨ï¼Œå‡å°‘èµ„æºæ¶ˆè€—å’Œæµªè´¹(å°æ—¶å€™å¤§äººç»å¸¸åœ¨åƒé¥­æ—¶è¯´çš„é‚£å¥è¯)ï¼›åœ¨è®¡ç®—æœºå·¥ç¨‹é¢†åŸŸï¼Œå­˜åœ¨å¤§é‡æ¶ˆè€—èµ„æºçš„åœºæ™¯ï¼Œå¤šè·¯å¤ç”¨å’Œæ± åŒ–æ˜¯æœ€å¸¸ç”¨çš„æ€§èƒ½ä¼˜åŒ–æ‰‹æ®µï¼›å¤šè·¯å¤ç”¨å­˜åœ¨ç³»ç»Ÿè°ƒç”¨ï¼Œç”±ç³»ç»Ÿå†…æ ¸å±‚é¢å»æ”¯æŒä¼˜åŒ–(I/Oå¤šè·¯å¤ç”¨select/poll/epoll/kqueue)ï¼Œè€Œæ± åŒ–å¯ä»¥åº”ç”¨ç”¨æˆ·ä½¿ç”¨å±‚é¢æ¥ä¼˜åŒ–ï¼›æ± åŒ–(&lt;a href=&#34;https://en.wikipedia.org/wiki/Pool_(computer_science)&#34;&gt;pool&lt;/a&gt;)æ˜¯ä¸€ç§èµ„æºå¤ç”¨ä¼˜åŒ–æŠ€æœ¯ï¼Œå‡å°‘èµ„æºå›æ”¶å¤„ç†ï¼Œæé«˜èµ„æºåˆ©ç”¨ç‡ï¼Œèµ„æºæœ€å¥½æ˜¯å›ºå®šå¤§å°ï¼Œå¦‚æœåœ¨å¤ç”¨èµ„æºè¿‡ç¨‹ä¸­ï¼Œèµ„æºåœ¨é€æ¸å¢å¤§ï¼Œä¸€ç›´å¤ç”¨ï¼Œä¹Ÿä¼šå¯¼è‡´èµ„æºæ¶ˆè€—è¿‡å¤šï¼Œåˆ°äº†ä¸€å®šå¤§å°ä¹‹åï¼Œé€šè¿‡ç³»ç»Ÿé‡Šæ”¾æ‰ï¼›åœ¨ç¨‹åºå¯åŠ¨çš„æ—¶å€™æå‰ç”³è¯·åŠ è½½å¥½èµ„æºæ”¾åˆ°æ± å­ä¸­ï¼Œè¿è¡Œæ—¶æ ¹æ®ä¸åŒçš„è°ƒåº¦ç®¡ç†èµ„æºç­–ç•¥ä»æ± å­ä¸­è·å–å‡†å¤‡å¥½çš„èµ„æºï¼Œæˆ–è€…è¿è¡Œæ—¶æ–°å»ºèµ„æºæ”¾å…¥æ± å­ä¸­ï¼Œç”¨æˆ·ç¨‹åºä¸­è¿›è¡Œè‡ªå®šä¹‰å¤„ç†æ“ä½œï¼Œæ“ä½œå®Œä¹‹åå°†èµ„æºé‡æ–°æ”¾å…¥æ± å­ä¸­å¤ç”¨ï¼Œæœ‰äº›èµ„æºå¯ä»¥åŠ¨æ€æ‰©ç¼©ï¼› èµ„æºä¸»è¦æ˜¯ç¨‹åºè¿è¡Œæ—¶å¯¹è±¡ï¼Œå½“ç„¶è¿™äº›æ“ä½œèµ„æºå®é™…éƒ½æ˜¯åˆ†é…åœ¨è™šæ‹Ÿå†…å­˜ç©ºé—´çš„å†…æ ¸ç©ºé—´å’Œç”¨æˆ·ç©ºé—´ä¸­ï¼Œæ¯”å¦‚ï¼Œ&lt;a href=&#34;https://zh.wikipedia.org/wiki/%E8%A1%8C%E7%A8%8B&#34;&gt;è¿›ç¨‹&lt;/a&gt;(process &lt;a href=&#34;https://en.wikipedia.org/wiki/Process_control_block&#34;&gt;PCB&lt;/a&gt; å†…æ ¸æ€)ã€&lt;a href=&#34;https://zh.wikipedia.org/wiki/%E5%9F%B7%E8%A1%8C%E7%B7%92&#34;&gt;çº¿ç¨‹&lt;/a&gt;(thread &lt;a href=&#34;https://en.wikipedia.org/wiki/Thread_control_block&#34;&gt;TCB &lt;/a&gt; å†…æ ¸æ€)ã€&lt;a href=&#34;https://zh.wikipedia.org/zh-hans/%E5%8D%8F%E7%A8%8B&#34;&gt;åç¨‹&lt;/a&gt;(coroutine ç”¨æˆ·æ€åä½œå¼è°ƒåº¦,å°½é‡å‡å°‘å†…æ ¸è°ƒåº¦)ä¸ºè½½ä½“çš„å·¥ä½œä»»åŠ¡(work task åœ¨ç”¨æˆ·æ€åˆ†é…æ ˆç©ºé—´)ï¼›å†…å­˜å¯¹è±¡(heap object)ï¼Œé•¿é“¾æ¥(tcp connect) ç­‰ï¼›ä¸»è¦å¯¹è¿™äº›èµ„æºå¯¹è±¡è¿›è¡Œæ± åŒ–æŠ€æœ¯è¿›è¡Œä»‹ç»ï¼Œäº†è§£æ± åŒ–å¯¹åº”åœºæ™¯ã€‚&lt;/p&gt;
&lt;h2 id=&#34;å·¥ä½œä»»åŠ¡æ± worker-pool&#34;&gt;å·¥ä½œä»»åŠ¡æ± ï¼ˆworker pool)&lt;/h2&gt;
&lt;p&gt;ç¨‹åºä¸­çš„å·¥ä½œä»»åŠ¡æ˜¯ä¸€äº›è¿è¡Œé€»è¾‘ï¼Œé€šè¿‡è¿›ç¨‹ï¼Œçº¿ç¨‹ï¼Œæˆ–è€…åç¨‹ä¸ºè½½ä½“è·å–ç³»ç»Ÿèµ„æºæ¥è¿è¡Œï¼›å¦‚æœè¿è¡Œçš„èµ„æºå¯¹è±¡ç‰¹åˆ«å¤šï¼Œè¿™äº›èµ„æºå¯¹è±¡åœ¨å†…å­˜ä¸­åˆ†é…ç©ºé—´ï¼Œè¿™å°±å¯¼è‡´èµ„æºæ¶ˆè€—è¿‡å¤šï¼Œç”šè‡³å¯èƒ½å¯¼è‡´OOMï¼ŒåŒæ—¶å¤„ç†ä»»åŠ¡å®Œæˆä¹‹åï¼Œè¿™äº›èµ„æºéœ€è¦å›æ”¶ï¼Œä¹Ÿä¼šæ¶ˆè€—å¤§é‡çš„cpuæ—¶é—´ï¼›æ‰€ä»¥åœ¨è¿™äº›é«˜è€—è¿›ç¨‹/çº¿ç¨‹ï¼Œæˆ–è€…åç¨‹èµ„æºçš„å·¥ä½œä»»åŠ¡åœºæ™¯ä¸‹(æ¯”å¦‚å¤§é‡çš„è¯·æ±‚ä»»åŠ¡)ï¼Œéœ€è¦ç”¨æ± åŒ–æŠ€æœ¯è¿›è¡Œå¤ç”¨ç®¡ç†ï¼Œæé«˜åˆ©ç”¨ç‡ï¼Œå‡å°‘è¯·æ±‚è€—æ—¶ï¼›å¯¹æ­¤åˆ†åˆ«ä»‹ç»è¿›ç¨‹æ± ï¼Œçº¿ç¨‹æ± ï¼Œåç¨‹æ± ï¼Œä»¥åŠå¼€æºç»„ä»¶æœåŠ¡ä¸­çš„å®ç°ã€‚&lt;/p&gt;
&lt;h3 id=&#34;è¿›ç¨‹æ± process-pool&#34;&gt;è¿›ç¨‹æ± (process pool)&lt;/h3&gt;
&lt;p&gt;æ—©æœŸçš„æ“ä½œç³»ç»Ÿæ˜¯ä»¥&lt;a href=&#34;https://zh.wikipedia.org/wiki/%E8%A1%8C%E7%A8%8B&#34;&gt;è¿›ç¨‹&lt;/a&gt;ä½œä¸ºèµ„æºåˆ†é…å’Œè°ƒåº¦çš„åŸºæœ¬å•ä½ï¼Œæ¯”å¦‚æ—©æœŸlinux2.4ä»¥åŠä¹‹å‰çš„ç‰ˆæœ¬ï¼Œè¿›ç¨‹æ˜¯ç¨‹åºçš„åŸºæœ¬æ‰§è¡Œå®ä½“ï¼›åœ¨é¢å‘çº¿ç¨‹è®¾è®¡çš„ç³»ç»Ÿï¼ˆå¦‚å½“ä»£å¤šæ•°æ“ä½œç³»ç»Ÿã€&lt;a href=&#34;https://zh.wikipedia.org/wiki/Linux&#34;&gt;Linux&lt;/a&gt; 2.6åŠæ›´æ–°çš„ç‰ˆæœ¬ï¼‰ä¸­ï¼Œè¿›ç¨‹æœ¬èº«ä¸æ˜¯åŸºæœ¬æ‰§è¡Œå•ä½ï¼Œè€Œæ˜¯&lt;a href=&#34;https://zh.wikipedia.org/wiki/%E5%9F%B7%E8%A1%8C%E7%B7%92&#34;&gt;çº¿ç¨‹&lt;/a&gt;çš„å®¹å™¨ï¼Œå°†èµ„æºåˆ†é…å’Œè°ƒåº¦è¿è¡Œè¿›è¡Œäº†åˆ†ç¦»è®¾è®¡ï¼›å¼•å…¥çº¿ç¨‹åï¼Œè¿›ç¨‹ä¸­å¯ä»¥æœ‰å¤šä¸ªçº¿ç¨‹ï¼Œå¹¶ä¸”å…±äº«çº¿ç¨‹èµ„æºï¼›è¿™é‡Œä»‹ç»è¿›ç¨‹æ± ï¼Œä¸€ä¸ªè¿›ç¨‹ä¸­åªæœ‰ä¸€ä¸ªçº¿ç¨‹ä½œä¸ºè°ƒåº¦è¿è¡Œå•ä½ï¼›åœ¨ä½¿ç”¨PHPè¯­è¨€è¿›è¡ŒwebæœåŠ¡ç«¯å¼€å‘çš„æ—¶å€™ï¼Œå¸¸è§„æ“ä½œç”¨LAMP/LNMPç»„åˆï¼Œå…¶ä¸­ä½¿ç”¨Apache/Nginxä½œä¸ºwebæœåŠ¡å™¨å°†è¯·æ±‚è·¯ç”±åˆ°å¯¹åº”åç«¯æœåŠ¡æ¨¡å—å¤„ç†ï¼Œç„¶åå°†å¤„ç†çš„å“åº”ç»“æœè¿”å›ï¼›åç«¯æœåŠ¡æ¨¡å—é€šè¿‡å®ç°é€šç”¨ç½‘å…³æ¥å£åè®®(CGI)åº”ç”¨(app)è¿›ç¨‹æ¥å¤„ç†è¯·æ±‚, å¦‚æœä»…ä»…æ˜¯å•ä¸ªè¯·æ±‚å¤„ç†ä»è·¯ç”±æ¨¡å—è½¬å‘çš„è¯·æ±‚ï¼Œååé‡æ˜¯å¾ˆä½çš„(ä¸€ä¸ªè¯·æ±‚ä¸€ä¸ªè¿›ç¨‹çš„æ–¹å¼(fork-and-execæ¨¡å¼)ï¼Œå®ç°ç®€å•ï¼Œç”šè‡³å¯ä»¥ç”¨shellè„šæœ¬æ¥ä½œä¸ºCGIè¿›ç¨‹å¤„ç†ï¼Œæ—©æœŸ90å¹´ä¹‹å‰äº’è”ç½‘ç”¨æˆ·ä¸å¤š)ï¼›éšç€äº’è”ç½‘çš„å‘å±•ï¼Œfork-and-execæ¨¡å¼ï¼Œè¿›ç¨‹åˆ›å»ºå’Œæ¶ˆé™¤å¼€é”€å˜å¤§ï¼Œæˆäº†è¯Ÿç—…ï¼Œ&lt;a href=&#34;https://en.wikipedia.org/wiki/FastCGI&#34;&gt;FastCGI&lt;/a&gt;æ¥å£åè®®åœ¨90å¹´ä»£ä¸­æœŸæå‡ºæ¥ï¼ŒFastCGIæœåŠ¡å™¨ä½¿ç”¨æŒä¹…è¿›ç¨‹æ¥å¤„ç†ä¸€ç³»åˆ—è¯·æ±‚ï¼ŒåŠæ¯ä¸ªå•ç‹¬çš„ FastCGI è¿›ç¨‹å¯ä»¥åœ¨å…¶ç”Ÿå‘½å‘¨æœŸå†…å¤„ç†è®¸å¤šè¯·æ±‚ï¼Œä»è€Œé¿å…æ¯ä¸ªè¯·æ±‚è¿›ç¨‹åˆ›å»ºå’Œç»ˆæ­¢çš„å¼€é”€(å¦å¤–è¿˜æœ‰SCGI,WSGIåè®®,éƒ½æ˜¯å®šä¹‰é€šç”¨çš„æ¥å£åè®®ï¼Œå°†webæœåŠ¡å™¨å’Œåº”ç”¨æœåŠ¡å™¨è¿›è¡Œè§£è€¦ï¼Œæ¯”å¦‚apache/nginxéƒ½æœ‰å¯¹åº”çš„åè®®æ¨¡å—å’Œåº”ç”¨æœåŠ¡å™¨php-fpm/uWSGI(python)ç›¸å…³æ¥å£åè®®è¿›ç¨‹è¿›è¡Œäº¤äº’ï¼Œç¼–å†™è¯­è¨€å¤§å¤šæ˜¯è§£é‡Šæ€§è¯­è¨€ï¼Œè¿›ç¨‹è¿è¡Œæ—¶åŠ¨æ€åŠ è½½è§£é‡Šæ‰§è¡Œ)ã€‚&lt;/p&gt;
&lt;h4 id=&#34;php-fpm-worker-process-pool&#34;&gt;php-fpm worker process pool&lt;/h4&gt;
&lt;p&gt;phpè§£é‡Šæ€§è¯­è¨€ä½œä¸ºåç«¯æœåŠ¡æ¨¡å—çš„å¼€å‘è¯­è¨€ï¼Œæ”¯æŒFastCGIï¼Œå¹¶ä¸”å¯¹æ”¯æŒFastCGIæ¥å£åè®®çš„è¿›ç¨‹è¿›è¡Œç®¡ç†ï¼Œé€šè¿‡SAPI(Server Application Programme Interface)æ¨¡å—ä¸­çš„FPM(FastCGI Process Manager)å®ç°ï¼›åœ¨åˆå§‹å¯åŠ¨php-fpmæ—¶ï¼Œé€šè¿‡ä¸»è¿›ç¨‹ç›‘å¬ä¸åŒæœåŠ¡ç«¯å£ï¼Œä¸åŒæœåŠ¡ç«¯å£åˆå§‹å¯¹åº”çš„FastCGIå·¥ä½œè¿›ç¨‹æ± ï¼›è¿è¡Œæ—¶ï¼Œä¸»è¿›ç¨‹(çˆ¶è¿›ç¨‹)å’Œå·¥ä½œè¿›ç¨‹(å­è¿›ç¨‹)é€šè¿‡åŒå‘ä¿¡å·ç®¡é“(pipe)è¿›è¡Œé€šä¿¡ï¼Œå®ç°ä¸»è¿›ç¨‹å¯¹å·¥ä½œè¿›ç¨‹çš„æ§åˆ¶ç®¡ç†ï¼Œä»¥åŠå·¥ä½œè¿›ç¨‹é€šè¿‡æ ‡å‡†è¾“å‡ºç®¡é“(stdout pipe)å’Œæ ‡å‡†é”™è¯¯ç®¡é“(stderr pipe)ï¼Œå°†ç»“æœå’Œé”™è¯¯è¿”å›ç»™ä¸»è¿›ç¨‹ï¼›ä¸»è¿›ç¨‹å’Œå·¥ä½œè¿›ç¨‹é€šè¿‡å…±äº«å†…å­˜çš„æ–¹å¼(å†…éƒ¨è®°åˆ†æ¿ç»“æ„scoreboard)ï¼Œå®ç°å·¥ä½œè¿›ç¨‹è¿è¡Œæ—¶çš„ç›‘æ§(å·¥ä½œè¿›ç¨‹çŠ¶æ€), ä¸»è¿›ç¨‹ä¼šå®šæ—¶è½®è®­æ£€æŸ¥å·¥ä½œè¿›ç¨‹æ•°ç›®ï¼Œæ ¹æ®è¿›ç¨‹æ± ç®¡ç†ç­–ç•¥æ¥å¤„ç†æ˜¯å¦æ‰©ç¼©å®¹ï¼Œæ£€æŸ¥å·¥ä½œè¿›ç¨‹å¤„ç†è¯·æ±‚æ˜¯å¦è¶…æ—¶ï¼Œæ•´ä½“æµç¨‹å¦‚ä¸‹å›¾ï¼š&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://raw.githubusercontent.com/weedge/mypic/master/fpm-worker-pool.drawio.png&#34; alt=&#34;fpm-worker-pool&#34;&gt;&lt;/p&gt;
&lt;p&gt;å…·ä½“ä»£ç è§&lt;a href=&#34;https://github.com/php/php-src/tree/master/sapi/fpm&#34;&gt;php-fpm&lt;/a&gt;ï¼›phpè¯­è¨€æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä½¿ç”¨ &lt;code&gt;TSRM&lt;/code&gt; æœºåˆ¶åˆ†é…å’Œä½¿ç”¨å˜é‡æ—¶ä¼šæœ‰é¢å¤–çš„æŸè€—ï¼Œæ‰€ä»¥ä¸€èˆ¬ä¸éœ€è¦å¤šçº¿ç¨‹çš„ PHP ç¯å¢ƒï¼›è€Œä¸”å·¥ä½œè¿›ç¨‹å¤„ç†è¯·æ±‚æ—¶åŠ è½½phpè„šæœ¬è§£ææˆopcode, ç„¶åé€šè¿‡ZendVMè§£é‡Šå™¨è°ƒç”¨opcodeå¯¹åº”çš„æœºå™¨æŒ‡ä»¤ï¼Œæœ€ç»ˆå®Œæˆphpè„šæœ¬çš„è¿è¡Œï¼Œç”±äºæ¯æ¬¡å¤„ç†è¯·æ±‚éƒ½éœ€è¦è§£ææˆopcode,ä¼šæœ‰æ€§èƒ½æŸè€—ï¼Œæ‰€ä»¥å¼•å…¥opcacheæ¥ç¼“å­˜è§£æåçš„opcodeï¼›php-fpmçš„è¿è¡Œæœºåˆ¶æ˜¯é‡‡ç”¨å¤šè¿›ç¨‹æ–¹å¼æ¥å¤„ç†è¯·æ±‚ï¼Œæ¯ä¸ªwokerè¿›ç¨‹å¤„ç†è¯·æ±‚æ—¶æ‰€å å†…å­˜å¤§å°åœ¨10M+ï¼Œå¯ä»¥é€šè¿‡&lt;code&gt;ps aux | grep php | grep -v grep | grep -v master | awk &#39;{sum+=$6; cn+=1} END {print sum/cn}&#39;&lt;/code&gt;è·å–workerè¿›ç¨‹æ¶ˆè€—å†…å­˜å¹³å‡å€¼ï¼Œæ‰€ä»¥fpmå¼•å…¥å·¥ä½œè¿›ç¨‹æ± æ¥é˜²æ­¢è¿‡åº¦æ¶ˆè€—å†…å­˜ï¼Œè€Œä¸”å¯ä»¥æœç”¨å·¥ä½œè¿›ç¨‹æ¥å¤„ç†è¯·æ±‚ï¼Œå†…å­˜èµ„æºç´§çš„åœºæ™¯æ± ä¸­å¼€å¯åŠ¨æ€æ‰©ç¼©workerè¿›ç¨‹ï¼Œåä¹‹é‡‡ç”¨é™æ€æ–¹å¼æ± ä¸­ä¸€æ¬¡åˆå§‹pm.max_children è¿™ä¹ˆå¤šworkerè¿›ç¨‹ï¼Œå‡å°‘æ‰©ç¼©ç®¡ç†å¼€é”€ã€‚&lt;/p&gt;
&lt;p&gt;phpå¤šè¿›ç¨‹(è¿›ç¨‹å•ä¸ªçº¿ç¨‹)ç¼–ç¨‹ç›¸å¯¹å¤šçº¿ç¨‹(è¿›ç¨‹å¤šä¸ªçº¿ç¨‹)ç¼–ç¨‹è¦ç®€å•äº›ï¼Œå¤šçº¿ç¨‹éœ€è¦è€ƒè™‘å…±äº«æ‰€åœ¨è¿›ç¨‹èµ„æºåŒæ­¥çš„é—®é¢˜ï¼Œå¤„äºå®‰å…¨éš”ç¦»è€ƒè™‘ï¼Œè¿›ç¨‹å¤šçº¿ç¨‹ä¸­å¦‚æœæŸä¸ªçº¿ç¨‹å‡ºé”™ï¼Œæ•´ä¸ªè¿›ç¨‹å°±æŒ‚äº†ï¼Œè€Œå¤šè¿›ç¨‹èµ„æºç›¸äº’éš”ç¦»ï¼Œå¦‚æœä¸€ä¸ªè¿›ç¨‹æŒ‚äº†ï¼Œä¸å½±å“å…¶ä»–è¿›ç¨‹å¤„ç†ä»»åŠ¡ï¼›è€Œä¸”è§£é‡Šè¯­è¨€ç›¸å¯¹c/c++ç¼–è¯‘æˆæœºå™¨ç æ‰§è¡Œè¯­è¨€å¼€å‘æ•ˆç‡è¦é«˜å¾ˆå¤šï¼Œè¿è¡Œæ—¶åŠ è½½ï¼Œæ— éœ€é‡å¯æœåŠ¡(å½“ç„¶c/c++ç¼–è¯‘å‹è¯­è¨€ä¹Ÿæ”¯æŒåŠ¨æ€åº“åŠ è½½è‡³å†…å­˜æä¾›ç›¸å…³æ¥å£è°ƒç”¨ï¼Œè¿›è¡Œçƒ­åŠ è½½è€Œæ— éœ€é‡å¯æœåŠ¡ï¼Œä½†æ˜¯ä¸å¯èƒ½æ¯æ¬¡æ–°å¼€å‘ä¸€ä¸ªåŠŸèƒ½éƒ½ä»¥*.soåŠ¨æ€åº“çš„å½¢å¼æä¾›å§ï¼Œæ‰€ä»¥éœ€æ±‚æ›´æ–°è¿­ä»£å¿«çš„åœºæ™¯ï¼Œåƒæ¸¸æˆé¢†åŸŸçš„æœåŠ¡å™¨ï¼Œç½‘å…³æœåŠ¡å™¨ï¼Œç”šè‡³å¤§æ•°æ®ä»»åŠ¡ç®—å­ï¼Œå¤§å¤šéƒ½æ˜¯é€šè¿‡å¼•å…¥è§£é‡Šå‹è„šæœ¬è¯­è¨€(lua/js/perl/python/php)ç¼–å†™ä¸šåŠ¡é€»è¾‘ï¼Œè¿›è¡Œçƒ­åŠ è½½)ï¼›&lt;/p&gt;
&lt;p&gt;ä½†æ˜¯å¤šè¿›ç¨‹æ¯•ç«Ÿæ¯”å¤šçº¿ç¨‹è¦æ¶ˆè€—æ›´å¤šçš„ç³»ç»Ÿèµ„æºï¼›è€Œä¸”å¦‚æœå­˜åœ¨å¤šè¿›ç¨‹å•çº¿ç¨‹çš„&lt;a href=&#34;https://zh.wikipedia.org/wiki/%E4%B8%AD%E5%A4%AE%E5%A4%84%E7%90%86%E5%99%A8&#34;&gt;cpu&lt;/a&gt;åˆ‡æ¢ï¼Œæ˜¯ä»ä¸€ä¸ªè¿›ç¨‹åˆ°å¦ä¸€ä¸ªè¿›ç¨‹ï¼Œè€Œå•è¿›ç¨‹å¤šçº¿ç¨‹çš„&lt;a href=&#34;https://zh.wikipedia.org/wiki/%E4%B8%AD%E5%A4%AE%E5%A4%84%E7%90%86%E5%99%A8&#34;&gt;cpu&lt;/a&gt;åˆ‡æ¢åˆ™åªåœ¨ä¸€ä¸ªè¿›ç¨‹å†…ï¼Œæ¯ä¸ªè¿›ç¨‹/çº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„ä¸Šä¸‹æ–‡å †æ ˆä¿å­˜ï¼Œè¿›ç¨‹é—´çš„cpuåˆ‡æ¢æ¶ˆè€—æ›´å¤§ä¸€äº›ï¼›å¤šçº¿ç¨‹ä¸Šä¸‹æ–‡çš„åˆ‡æ¢æ¶‰åŠç¨‹åºè®¡æ•°å™¨ã€å †æ ˆæŒ‡é’ˆå’Œç¨‹åºçŠ¶æ€å­—ç­‰ä¸€ç³»åˆ—çš„å¯„å­˜å™¨ç½®æ¢ã€ç¨‹åºå †æ ˆé‡ç½®ç”šè‡³æ˜¯ CPU é«˜é€Ÿç¼“å­˜ã€TLB å¿«è¡¨çš„æ±°æ¢ï¼›è¿›ç¨‹é—´çš„ä¸Šçº¿æ–‡åˆ‡æ¢è¿˜æ¶‰åŠæ•´ä¸ªè¿›ç¨‹åœ°å€ç©ºé—´ã€‚&lt;/p&gt;
&lt;h3 id=&#34;çº¿ç¨‹æ± thread-poolhttpsenwikipediaorgwikithread_pool&#34;&gt;&lt;a href=&#34;https://en.wikipedia.org/wiki/Thread_pool&#34;&gt;çº¿ç¨‹æ± (thread pool)&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;çº¿ç¨‹æ˜¯æ“ä½œç³»ç»Ÿè°ƒåº¦è¿è¡Œçš„æœ€å°å•å…ƒï¼Œéšç€è®¡ç®—æœº&lt;a href=&#34;https://zh.wikipedia.org/wiki/%E4%B8%AD%E5%A4%AE%E5%A4%84%E7%90%86%E5%99%A8&#34;&gt;cpu&lt;/a&gt;æ ¸æ•°çš„å¢åŠ ï¼Œå¤šçº¿ç¨‹æŠ€æœ¯å¯ä»¥å……åˆ†åˆ©ç”¨å¤šä¸ªcpuæ ¸è¿›è¡Œå¹¶è¡Œå¤„ç†ï¼Œæé«˜ååï¼›å¯¹äºåœ¨å•cpuå•æ ¸çš„è®¡ç®—æœºä¸Šï¼Œä½¿ç”¨å¤šçº¿ç¨‹æŠ€æœ¯ï¼Œä¹Ÿå¯ä»¥æŠŠè¿›ç¨‹ä¸­è´Ÿè´£I/Oå¤„ç†ã€äººæœºäº¤äº’è€Œå¸¸è¢«é˜»å¡çš„éƒ¨åˆ†ï¼Œä¸å¯†é›†è®¡ç®—çš„éƒ¨åˆ†åˆ†å¼€æ¥æ‰§è¡Œï¼Œç¼–å†™ä¸“é—¨çš„workhorseçº¿ç¨‹æ‰§è¡Œå¯†é›†è®¡ç®—ï¼Œè™½ç„¶å¤šä»»åŠ¡æ¯”ä¸ä¸Šå¤šæ ¸ï¼Œä½†å› ä¸ºå…·å¤‡å¤šçº¿ç¨‹çš„èƒ½åŠ›ï¼Œä»è€Œæé«˜äº†ç¨‹åºçš„æ‰§è¡Œæ•ˆç‡ã€‚è€Œå¤šçº¿ç¨‹çš„é¢‘ç¹å»ºç«‹å’Œé”€æ¯ï¼Œä»¥åŠå¤šçº¿ç¨‹ä¸Šä¸‹æ–‡çš„åˆ‡æ¢ï¼Œä¼šå¯¼è‡´æ•´ä½“æ‰§è¡Œçš„å»¶è¿Ÿï¼Œå¯¹äºé«˜æ€§èƒ½çš„æœåŠ¡ç»„ä»¶ï¼Œé’ˆå¯¹ioå¯†é›†å‹åœºæ™¯ï¼Œå¼•å…¥çº¿ç¨‹æ± æ¥è¿›è¡Œä¼˜åŒ–ï¼›è€Œä¸šåŠ¡åœºæ™¯ï¼Œä¸ºäº†æé«˜ä¸šåŠ¡çš„æ¥å£ååé‡ï¼Œä¹Ÿå¼•å…¥äº†çº¿ç¨‹æ± è¿›è¡Œä¼˜åŒ–ï¼›&lt;/p&gt;
&lt;h4 id=&#34;nginx-thread-pool&#34;&gt;nginx thread pool&lt;/h4&gt;
&lt;p&gt;&lt;a href=&#34;https://www.nginx.com/blog/inside-nginx-how-we-designed-for-performance-scale/&#34;&gt;nginxæ˜¯å¤šå·¥ä½œè¿›ç¨‹(cpuæ ¸æ•°)+äº‹ä»¶æ¨¡å‹&lt;/a&gt;ï¼ˆå¦‚æœæ˜¯IOå¯†é›†å‹ workerè¿›ç¨‹æ•°åœ¨1.5-2å€cpuæ ¸æ•°ï¼‰ï¼Œé€šè¿‡å·¥ä½œè¿›ç¨‹å•çº¿ç¨‹çš„äº‹ä»¶æ¨¡å‹(æ¯”å–»æˆgrandmasterğŸ˜„)èƒ½å¤Ÿå¾ˆå¿«å¤„ç†ç”¨æˆ·çš„è¯·æ±‚(epolläº‹ä»¶æœºåˆ¶)ï¼Œä½†æ˜¯ä¸ºäº†è§£å†³é‡é˜»å¡å‹IOå¯†é›†å‹çš„å·¥ä½œä»»åŠ¡é—®é¢˜ï¼Œnginx 1.7.12å¼•å…¥äº†&lt;a href=&#34;https://www.nginx.com/blog/thread-pools-boost-performance-9x/&#34;&gt;thread pool çº¿ç¨‹æ± æŠ€æœ¯&lt;/a&gt;ï¼Œä¸»è¦æ˜¯é’ˆå¯¹linuxç³»ç»Ÿï¼Œè§£å†³ä¸æ”¯æŒå¼‚æ­¥IOçš„åœºæ™¯(FreeBSDç³»ç»Ÿçš„å¼‚æ­¥IOæ”¯æŒä½¿ç”¨å†…å­˜åšä¸ºæ–‡ä»¶ç¼“å­˜)ï¼›&lt;/p&gt;
&lt;p&gt;æ¯”å¦‚äº§ç”Ÿç£ç›˜ioçš„ç³»ç»Ÿè°ƒç”¨read(),sendfile(),aio_write()(Linuxä¸Šçš„åœ¨ç¼–å†™ä¸€äº›ä¸´æ—¶æ–‡ä»¶,åœ¨nginx1.9.13åŠ å…¥&lt;a href=&#34;https://github.com/nginx/nginx/commit/348f705c000bdbfbee74d6f0111a03697f8ffa4f&#34;&gt;commit 348f705&lt;/a&gt;)è¿™äº›é˜»å¡æ“ä½œåœºæ™¯ï¼Œå·¥ä½œè¿›ç¨‹å¤„ç†è¿™äº›æ“ä½œçš„æ—¶å€™ï¼Œå°†å…¶æ”¾å…¥çº¿ç¨‹æ± ä¸­æ¥å¤„ç†ï¼Œå¸¸è§çš„ç›´æ’­/ç‚¹æ’­å›æ”¾åœºæ™¯ä¸­ï¼Œä¼šæœ‰æ‹‰æµæ“ä½œï¼Œä»æœ€è¿‘CDNæœåŠ¡èŠ‚ç‚¹ä¸Šè·å–è§†é¢‘æµè¿›è¡Œæ’­æ”¾ï¼›åƒè§†é¢‘æµæ–‡ä»¶ï¼Œæˆ–è€…å…¶ä»–å¤§æ–‡ä»¶ï¼Œè¿™äº›è¯·æ±‚èµ„æºæ˜¯æ²¡æ³•æ”¾å…¥ç³»ç»Ÿå†…å­˜&lt;a href=&#34;https://zhuanlan.zhihu.com/p/35448479&#34;&gt;é¡µé¢ç¼“å­˜&lt;/a&gt;ä¸­ï¼Œå¯¼è‡´äº‹ä»¶æ¨¡å‹è¢«æ–‡ä»¶æ“ä½œå¡ä½ï¼Œæ²¡æ³•æ­£å¸¸çš„å“åº”é“¾æ¥ï¼Œå¼•å…¥ thread pool æ¥ç¼“è§£è¿™ä¸ªé—®é¢˜ï¼›æµç¨‹å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;p&gt;å·¥ä½œè¿›ç¨‹ä¸­çš„ä¸»çº¿ç¨‹å†³å®šè¦å‘èµ·æ–‡ä»¶ç³»ç»Ÿæ“ä½œæ—¶ï¼Œå°†ä¼šå»ºç«‹ä¸€ä¸ªç‰¹æ®Šçš„ä»»åŠ¡ï¼Œå¹¶å°†è¯¥ä»»åŠ¡ä¸¢åˆ°ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼›è€Œçº¿ç¨‹æ± ä¸­çš„ç©ºé—²çº¿ç¨‹ä¼šä¸æ–­çš„æ‰§è¡Œè¯¥é˜Ÿåˆ—çš„æ–‡ä»¶ä»»åŠ¡ï¼Œè€Œåå°†æ‰§è¡Œå¥½çš„ç»“æœè¿”å›ï¼Œä¸»çº¿ç¨‹ç›‘å¬åˆ°é€šçŸ¥äº‹ä»¶å°±ç»ªè°ƒç”¨å›è°ƒå‡½æ•°å¤„ç†ç»“æœï¼Œç»§ç»­åç»­æ“ä½œã€‚ç»è¿‡è¿™ä¸ªä¼˜åŒ–ï¼Œä¸»çº¿ç¨‹ä¸ä¼šå†è¢«é˜»å¡åœ¨ç³»ç»Ÿè°ƒç”¨ä¸Š(å¤šåˆ†å‡ºäº†é€šçŸ¥äº‹ä»¶ï¼Œä¸å½±å“è¯»å†™äº‹ä»¶)ï¼Œå¦‚å›¾ï¼š&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://raw.githubusercontent.com/weedge/mypic/master/nginx-thread-pool.drawio.png&#34; alt=&#34;thread-pools-worker-process-event-cycle&#34;&gt;&lt;/p&gt;
&lt;p&gt;thread poolæ•´ä½“å®ç°ä»£ç è§&lt;a href=&#34;https://github.com/nginx/nginx/commit/305fc021db799c87d751f0f1f5e99afee7bb2b3b&#34;&gt;thread pool commit 305fc02&lt;/a&gt; , &lt;a href=&#34;https://github.com/nginx/nginx/commit/e10e7a4831cfaf6a41824da7c35819fc7f58f8ee&#34;&gt;epoll notify mechanism&lt;/a&gt;, &lt;a href=&#34;https://github.com/nginx/nginx/commit/2b3c01e9953b3985e05a46e56a01078b37caeb18&#34;&gt;kqueue notify mechanism&lt;/a&gt;ï¼›æœ€è¿‘æœ‰ä¸ª&lt;a href=&#34;https://github.com/nginx/nginx/commit/83e92a2edd6bf7c6867b653284ac44962c4e33c9&#34;&gt;commit 83e92a2&lt;/a&gt; è§£å†³http2 ç­‰å¾… sendfile å®Œæˆ è¯·æ±‚hangä½çš„æƒ…å†µï¼Œå°±æ˜¯åˆ©ç”¨çº¿ç¨‹æ± çš„å¼‚æ­¥æ–¹å¼(aio)æ¥å¤„ç†çš„ï¼ˆps: nginx ä½œè€…ä¹Ÿï¼‰ã€‚&lt;/p&gt;
&lt;h4 id=&#34;redis-thread-pool&#34;&gt;redis thread pool&lt;/h4&gt;
&lt;p&gt;rediså¤„ç†å‘½ä»¤æ ¸å¿ƒé€»è¾‘æ˜¯å•è¿›ç¨‹å•çº¿ç¨‹æ¨¡å¼ï¼Œrediså…³æ³¨çš„æ˜¯ç½‘ç»œIOï¼Œä»¥åŠå†…å­˜æ“ä½œï¼Œå¦‚æœæ˜¯å•è¿›ç¨‹å¤šçº¿ç¨‹å¤„ç†å¿…ç„¶ä¼šæœ‰åŒä¸€ä¸ªå†…å­˜ç»“æ„ä¼šæœ‰å¤šä¸ªçº¿ç¨‹å¤„ç†ï¼ŒåŠ é”å¤„ç†ï¼Œçº¿ç¨‹ç­‰å¾…ä»¥åŠå¤šçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€çš„é—®é¢˜ï¼Œæ‰§è¡Œæ•ˆç‡ä¸å¦‚å•çº¿ç¨‹é«˜æ•ˆï¼›ç½‘ç»œIOäº‹ä»¶ç›´æ¥é€šè¿‡IOå¤šè·¯å¤ç”¨äº‹ä»¶æ¨¡å‹(AE)æ¥è§£å†³, è€Œä¸”é€»è¾‘ç®€å•å¯ç»´æŠ¤ï¼›&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;ä¸ºäº†æé«˜å¤„ç†æ€§èƒ½ï¼ŒRedis v4.0 å°†ç£ç›˜ioå’Œå†…å­˜é‡Šæ”¾freeå·¥ä½œé‡‡ç”¨å‡ ä¸ªçº¿ç¨‹å¼‚æ­¥å¤„ç†bio(3ä¸ª)ï¼›&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;fsyncå†…å­˜å¼‚æ­¥æŒä¹…è½ç›˜æ“ä½œå’Œcloseå¼‚æ­¥å…³é—­æ–‡ä»¶æ“ä½œï¼›&lt;/p&gt;
&lt;p&gt;ç”±äºå†…å­˜ä¸­å¤§keåŒæ­¥åˆ é™¤ä¼šè€—æ—¶é«˜ä»è€Œé˜»å¡æ ¸å¿ƒé€»è¾‘ï¼Œæ‰€ä»¥å°†è¿™äº›å†…å­˜é‡Šæ”¾é‡‡ç”¨lazyfreeæœºåˆ¶ä¼˜åŒ–å¼‚æ­¥åŒ–å¤„ç†ï¼ŒåŒ…æ‹¬ä¸¤ç±»ï¼šä¸€ç±»æ˜¯ä¸»åŠ¨é‡Šæ”¾&lt;code&gt;unlink&lt;/code&gt; &lt;code&gt;flushall async&lt;/code&gt; ï¼›ä¸€ç±»æ˜¯è¢«åŠ¨é‡Šæ”¾, åˆ†ä¸º4ç§åœºæ™¯ï¼ŒæŒ‰éœ€æ±‚åœºæ™¯è¿›è¡Œæ‰“å¼€ä¼˜åŒ–(é»˜è®¤æ˜¯å…³é—­çš„)ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;lazyfree-lazy-eviction no
lazyfree-lazy-expire no
lazyfree-lazy-server-del no
slave-lazy-flush no
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;â€‹	lazyfree-lazy-evictionï¼šé’ˆå¯¹rediså†…å­˜ä½¿ç”¨è¾¾åˆ°maxmeoryï¼Œå¹¶è®¾ç½®æœ‰æ·˜æ±°ç­–ç•¥æ—¶ï¼›åœ¨è¢«åŠ¨æ·˜æ±°é”®æ—¶ï¼Œæ˜¯å¦é‡‡ç”¨lazy freeæœºåˆ¶ï¼› å…·ä½“æµç¨‹è§&lt;a href=&#34;https://weedge.github.io/post/lru/#%E8%BF%91%E4%BC%BClru%E7%AE%97%E6%B3%95&#34;&gt;redis è¿‘ä¼¼lruç®—æ³•&lt;/a&gt;ï¼›&lt;/p&gt;
&lt;p&gt;â€‹	lazyfree-lazy-expireï¼šé’ˆå¯¹è®¾ç½®æœ‰TTLçš„é”®ï¼Œè¾¾åˆ°è¿‡æœŸåï¼Œè¢«redisæ¸…ç†åˆ é™¤æ—¶æ˜¯å¦é‡‡ç”¨lazy freeæœºåˆ¶ï¼›å¯å¼€å¯&lt;/p&gt;
&lt;p&gt;â€‹	lazyfree-lazy-server-delï¼šé’ˆå¯¹æœ‰äº›æŒ‡ä»¤åœ¨å¤„ç†å·²å­˜åœ¨çš„é”®æ—¶ï¼Œä¼šå¸¦æœ‰ä¸€ä¸ªéšå¼çš„DELé”®çš„æ“ä½œï¼Œæ¯”å¦‚&lt;code&gt;rename&lt;/code&gt;æ“ä½œï¼Œå¦‚æœkeyå­˜åœ¨ä¼šå…ˆåˆ é™¤è¿™ä¸ªkey/value, å¦‚æœæ˜¯å¤§keyåœºæ™¯ä¼šé˜»å¡ï¼›å¯å¼€å¯&lt;/p&gt;
&lt;p&gt;â€‹	slave-lazy-flushï¼šé’ˆå¯¹slaveè¿›è¡Œå…¨é‡æ•°æ®åŒæ­¥ï¼Œslaveåœ¨åŠ è½½masterçš„RDBæ–‡ä»¶å‰ï¼Œä¼šè¿è¡Œflushallæ¥æ¸…ç†è‡ªå·±çš„æ•°æ®åœºæ™¯ï¼Œå¼€å¯å¯å‡å°‘å…¨é‡åŒæ­¥è€—æ—¶ï¼Œä»è€Œå‡å°‘ä¸»åº“å› è¾“å‡ºç¼“å†²åŒºçˆ†æ¶¨å¼•èµ·çš„å†…å­˜ä½¿ç”¨å¢é•¿ï¼›å¯å¼€å¯&lt;/p&gt;
&lt;p&gt;â€‹	è¿˜æœ‰ä¸€ä¸ªé…ç½® &lt;code&gt;lazyfree-lazy-user-del no&lt;/code&gt;ï¼Œ é’ˆå¯¹è€ç”¨æˆ·/ä»£ç ä½¿ç”¨&lt;code&gt;del&lt;/code&gt;ä¸»åŠ¨åˆ é™¤æ˜¯å¦å¼‚æ­¥å¤„ç†ï¼Œå¼€å¯å’Œ&lt;code&gt;unlink&lt;/code&gt;ä¸€æ ·ï¼›&lt;/p&gt;
&lt;ol start=&#34;2&#34;&gt;
&lt;li&gt;ä¸ºäº†æé«˜å¤„ç†IOèƒ½åŠ›ï¼ŒRedis v6.0 æ­£å¼åœ¨ç½‘ç»œæ¨¡å‹ä¸­å®ç° I/O å¤šçº¿ç¨‹ï¼Œæµç¨‹å¦‚ä¸‹ï¼š&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;â€‹	å®¢æˆ·ç«¯å’Œä¸»çº¿ç¨‹å»ºç«‹è¿æ¥ï¼Œä¸»çº¿ç¨‹å°†è¯·æ±‚å°è£…æˆclientç»“æ„æ”¾å…¥LIFOè¯»å…¥é˜Ÿåˆ—(clients_pending_read)ï¼Œä¸»çº¿ç¨‹ç„¶åæŠŠLIFOè¯»å…¥é˜Ÿåˆ—ä¸­çš„clientæ•°æ®RRå‡åŒ€åˆ†é…ç»™ä¸»çº¿ç¨‹å’ŒI/Oå¤šçº¿ç¨‹çš„æœ¬åœ°é˜Ÿåˆ—(io_threads_list[id])ï¼›&lt;/p&gt;
&lt;p&gt;â€‹	ä¸»çº¿ç¨‹å’ŒI/Oå¤šçº¿ç¨‹è§£æå‘½ä»¤ï¼Œå†™å…¥æŸ¥è¯¢ç¼“å­˜åŒº(querybuf)ï¼›&lt;/p&gt;
&lt;p&gt;â€‹	ä¸»çº¿ç¨‹å¿™è½®è®­ç­‰å¾…I/Oå¤šçº¿ç¨‹å…¨éƒ¨è§£æå¤„ç†å®Œä¹‹åï¼Œéå†LIFOè¯»å…¥é˜Ÿåˆ—(clients_pending_read)ä¸­çš„client, å¤„ç†æ‰§è¡Œå‘½ä»¤æ ¸å¿ƒé€»è¾‘(processCommand)ï¼Œæ³¨æ„è¿™é‡Œå¹¶ä¸æ˜¯I/Oå¤šçº¿ç¨‹æ¥å¤„ç†ï¼›ä¸»çº¿ç¨‹å¤„ç†å®Œå‘½ä»¤åï¼Œå°†å“åº”æ•°æ®å†™å…¥clientå†™å‡ºç¼“å­˜åŒº(buf/reply)ï¼Œç„¶åæŠŠclientæ”¾å…¥LIFO å†™å‡ºé˜Ÿåˆ—(clients_pending_write)ï¼ŒåŒæ ·ä¸»çº¿ç¨‹ç„¶åæŠŠLIFOå†™å‡ºé˜Ÿåˆ—(clients_pending_write)ä¸­çš„clientæ•°æ®RRå‡åŒ€åˆ†é…ç»™ä¸»çº¿ç¨‹å’ŒI/Oå¤šçº¿ç¨‹çš„æœ¬åœ°é˜Ÿåˆ—(io_threads_list[id])ï¼›&lt;/p&gt;
&lt;p&gt;â€‹	ä¸»çº¿ç¨‹å’ŒI/Oå¤šçº¿ç¨‹å›å†™å“åº”æ•°æ®ç»™å®¢æˆ·ç«¯ï¼›&lt;/p&gt;
&lt;p&gt;â€‹	ä¸»çº¿ç¨‹å¿™è½®è®­ç­‰å¾…I/Oå¤šçº¿ç¨‹å…¨éƒ¨å›å†™å“åº”æ•°æ®ç»™å®¢æˆ·ç«¯ å¤„ç†å®Œä¹‹åï¼Œæœ€ååœ¨éå†LIFOå†™å‡ºé˜Ÿåˆ—(clients_pending_write)ï¼Œæ£€æŸ¥æ˜¯å¦è¿˜æœ‰ client çš„å†™å‡ºç¼“å†²åŒº(buf/reply)ä¸­æœ‰æ®‹ç•™æ•°æ®ï¼Œå¦‚æœæœ‰ï¼Œä¸º client æ³¨å†Œä¸€ä¸ªå‘½ä»¤å›å¤å™¨ sendReplyToClientï¼Œç­‰å¾…clientå¯å†™ä¹‹ååœ¨äº‹ä»¶å¾ªç¯ä¸­ç»§ç»­å›å†™æ®‹ä½™çš„å“åº”æ•°æ®ã€‚&lt;/p&gt;
&lt;p&gt;å¤„ç†æµç¨‹å’Œä»¥å‰çš„å•çº¿ç¨‹reactoræ¨¡å¼å·®ä¸å¤šï¼Œä¸»è¦åŒºåˆ«æ˜¯å¯¹è¯»å†™IOä¼˜åŒ–(å¼‚æ­¥å¤šçº¿ç¨‹å¤„ç†)ï¼› è¯»å…¥è¯·æ±‚å‘½ä»¤è¯»å–è§£æå’Œå†™å‡ºå“åº”æ•°æ®ç»™å®¢æˆ·ç«¯ï¼Œå¢åŠ äº†I/Oå¤šçº¿ç¨‹æ¥å¤„ç†ï¼Œä»¥å‰çš„ä¸»çº¿ç¨‹å¤„ç†çš„æ ¸å¿ƒé€»è¾‘æ²¡æœ‰å˜ï¼Œå¢åŠ äº†å’ŒI/Oå¤šçº¿ç¨‹äº¤äº’çš„è¯»å†™LIFOé˜Ÿåˆ—(clients_pending_read / clients_pending_write)ï¼Œæœ‰ç‚¹åƒæ‰‡å…¥æ‰‡å‡ºæ¨¡å¼ï¼›å°½é‡ä¿æŒ &lt;strong&gt;less is more&lt;/strong&gt; åŸåˆ™ï¼›&lt;/p&gt;
&lt;p&gt;è€Œä¸”redis v6.0ä¸ºäº†é«˜æ€§èƒ½ï¼Œç½‘ç»œIOå¤šçº¿ç¨‹åœºæ™¯ï¼Œå’Œnginxä¸€æ ·ä¹Ÿå¯¹å¤šæ ¸CPU NUMAæ¶æ„è¿›è¡Œäº†äº²å’Œæ€§å¤„ç†(è§setcpuaffinity.cä¸­é€»è¾‘ï¼Œ&lt;a href=&#34;https://github.com/redis/redis/commit/1a0deab2a548fa306171f03439e858c00836fe69&#34;&gt;commit 1a0deab2&lt;/a&gt;)ï¼Œå……åˆ†åˆ©ç”¨CPUæœ¬åœ°ç¼“å­˜ï¼Œå¹¶è¡Œå¤„ç†ï¼›å¦å¤–redis v6.0è¿˜æœ‰ä¸€äº›æ€§èƒ½ä¼˜åŒ–éªšæ“ä½œï¼Œæ— é”åŒ–å¤„ç†ï¼Œçœ‹ä»£ç æ—¶ä¼šå‘ç°ç”¨åˆ°äº†mutex lockï¼Œé€šè¿‡ pthread_mutex_lock ç»™ io_threads_mutex[i] (0&amp;lt;=i&amp;lt;128) ä¸Šé”ï¼Œå…¶å®ç›®çš„æ˜¯ä¸»çº¿ç¨‹ç”¨æ¥é€šçŸ¥I/Oçº¿ç¨‹ä½¿ç”¨çš„ï¼Œæœ€ç»ˆè¿˜æ˜¯é€šè¿‡io_threads_pending[i] åŸå­åŒ–æ“ä½œ(atomic_load_explicit)è·å–åˆ¤è¯»æ˜¯å¦ç­‰å¾…ï¼›æ¯ä¸ªå¤„ç†I/Oçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„æœ¬åœ°é˜Ÿåˆ—io_threads_list[i] ç”¨äºå¤„ç†å°è£…çš„clientç»“æ„ï¼ŒI/Oçº¿ç¨‹ä¹‹é—´äº’ä¸å¹²æ¶‰ï¼›è€Œä¸”ä¸»çº¿ç¨‹å’ŒI/Oå­çº¿ç¨‹å¤„ç†æœ¬åœ°é˜Ÿåˆ— io_threads_list[i] ä»¥åŠio_threads_op é€šè¿‡æ§åˆ¶ä¸»çº¿ç¨‹å’Œ I/O çº¿ç¨‹äº¤é”™è®¿é—®æ¥è§„é¿å…±äº«æ•°æ®ç«äº‰(data race)é—®é¢˜ã€‚&lt;/p&gt;
&lt;p&gt;THREADED I/O æ ¸å¿ƒæ“ä½œå˜é‡å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-c&#34; data-lang=&#34;c&#34;&gt;&lt;span class=&#34;cm&#34;&gt;/* ==========================================================================
&lt;/span&gt;&lt;span class=&#34;cm&#34;&gt; * Threaded I/O
&lt;/span&gt;&lt;span class=&#34;cm&#34;&gt; * ========================================================================== */&lt;/span&gt;

&lt;span class=&#34;cp&#34;&gt;#define IO_THREADS_MAX_NUM 128
&lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;#define IO_THREADS_OP_READ 0
&lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;#define IO_THREADS_OP_WRITE 1
&lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;&lt;/span&gt;
&lt;span class=&#34;n&#34;&gt;pthread_t&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;io_threads&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;IO_THREADS_MAX_NUM&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;];&lt;/span&gt;
&lt;span class=&#34;n&#34;&gt;pthread_mutex_t&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;io_threads_mutex&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;IO_THREADS_MAX_NUM&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;];&lt;/span&gt;
&lt;span class=&#34;n&#34;&gt;redisAtomic&lt;/span&gt; &lt;span class=&#34;kt&#34;&gt;unsigned&lt;/span&gt; &lt;span class=&#34;kt&#34;&gt;long&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;io_threads_pending&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;IO_THREADS_MAX_NUM&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;];&lt;/span&gt;
&lt;span class=&#34;kt&#34;&gt;int&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;io_threads_op&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;      &lt;span class=&#34;cm&#34;&gt;/* IO_THREADS_OP_WRITE or IO_THREADS_OP_READ. */&lt;/span&gt;

&lt;span class=&#34;cm&#34;&gt;/* This is the list of clients each thread will serve when threaded I/O is
&lt;/span&gt;&lt;span class=&#34;cm&#34;&gt; * used. We spawn io_threads_num-1 threads, since one is the main thread
&lt;/span&gt;&lt;span class=&#34;cm&#34;&gt; * itself. */&lt;/span&gt;
&lt;span class=&#34;n&#34;&gt;list&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;io_threads_list&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;IO_THREADS_MAX_NUM&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;];&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;ä»¥ä¸Šé€šè¿‡å¼•å…¥å¤šçº¿ç¨‹æ¥æ”¹å–„redisä¸­I/Oå¤„ç†æ€§èƒ½ï¼Œè¿™äº›ä¼˜åŒ–éƒ½å¯ä»¥æ ¹æ®éœ€æ±‚åœºæ™¯è¿›è¡Œé…ç½®ï¼Œä¹Ÿæœ‰å…·ä½“è¯´æ˜ è§: &lt;a href=&#34;https://github.com/redis/redis/blob/unstable/redis.conf&#34;&gt;redis.conf&lt;/a&gt; (LAZY FREEING, THREADED I/O)ï¼›åŠŸèƒ½æŒ‰éœ€é…ç½®ï¼Œ&lt;strong&gt;å¯é…ç½®åŠŸèƒ½è¯´æ˜&lt;/strong&gt; é…ç½®æ–‡æ¡£åŸåˆ™ (å¼€æºè½¯ä»¶é…ç½®æ–‡ä»¶ä¸€èˆ¬éƒ½ä¼šæœ‰è¯¦ç»†è¯´æ˜å¯äº†è§£)ï¼›&lt;/p&gt;
&lt;h4 id=&#34;java-thread-pool&#34;&gt;java thread pool&lt;/h4&gt;
&lt;p&gt;javaå¤šçº¿ç¨‹ç¼–ç¨‹ï¼Œä¹Ÿæœ‰ç›¸å…³çš„çº¿ç¨‹æ± (ThreadPoolExecutorï¼Œå­ç±»ScheduledThreadPoolExecutor - åˆ©ç”¨å»¶è¿Ÿå·¥ä½œé˜Ÿåˆ—(æœ€å°å †)å®ç°å®šæ—¶ä»»åŠ¡çº¿ç¨‹æ± )æä¾›ä½¿ç”¨ï¼›ä½¿ç”¨ThreadPoolExecutorå¯ä»¥æ»¡è¶³ä¸¤ç§åœºæ™¯ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;å¹¶è¡Œæ‰§è¡Œå­ä»»åŠ¡ï¼Œæé«˜å“åº”é€Ÿåº¦ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œåº”è¯¥ä½¿ç”¨åŒæ­¥é˜Ÿåˆ—ï¼Œæ²¡æœ‰ä»€ä¹ˆä»»åŠ¡åº”è¯¥è¢«ç¼“å­˜ä¸‹æ¥ï¼Œè€Œæ˜¯åº”è¯¥ç«‹å³æ‰§è¡Œ;&lt;/li&gt;
&lt;li&gt;å¹¶è¡Œæ‰§è¡Œå¤§æ‰¹æ¬¡ä»»åŠ¡ï¼Œæå‡ååé‡ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œåº”è¯¥ä½¿ç”¨æœ‰ç•Œé˜Ÿåˆ—ï¼Œä½¿ç”¨é˜Ÿåˆ—å»ç¼“å†²å¤§æ‰¹é‡çš„ä»»åŠ¡ï¼Œé˜Ÿåˆ—å®¹é‡å¿…é¡»å£°æ˜ï¼Œé˜²æ­¢ä»»åŠ¡æ— é™åˆ¶å †ç§¯ï¼›&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;img src=&#34;https://p0.meituan.net/travelcube/77441586f6b312a54264e3fcf5eebe2663494.png&#34; alt=&#34;ThreadPoolExecutorè¿è¡Œæµç¨‹&#34;&gt;&lt;/p&gt;
&lt;p&gt;ThreadPoolExecutorå…·ä½“çš„ä½¿ç”¨ä»‹ç»å¯ä»¥å‚è€ƒç¾å›¢çš„è¿™ç‰‡æ–‡ç« ï¼š&lt;a href=&#34;https://tech.meituan.com/2020/04/02/java-pooling-pratice-in-meituan.html&#34;&gt;Javaçº¿ç¨‹æ± å®ç°åŸç†åŠå…¶åœ¨ç¾å›¢ä¸šåŠ¡ä¸­çš„å®è·µ&lt;/a&gt;ï¼Œå¼•ç”¨ ThreadPoolExecutor è¿è¡Œæµç¨‹å¦‚ä¸Šå›¾ï¼›æ–‡ä¸­æœ‰æœ‰å®é™…çš„æ¡ˆä¾‹å’Œå‚æ•°é…ç½®è§£å†³æ–¹æ¡ˆï¼Œå¯ä»¥å€Ÿé‰´ï¼›åœ¨ä½¿ç”¨javaçº¿ç¨‹æ± å¯¹æ¥å£ååé‡è¿›è¡Œä¼˜åŒ–æ—¶ï¼Œå¦‚æœå‚æ•°ä½¿ç”¨ä¸å½“ï¼Œçº¿ç¨‹æ± æœ€å¤§çº¿ç¨‹æ•°è¿‡å°ï¼Œå¯èƒ½å¯¼è‡´æ¥å£æœåŠ¡é™çº§ï¼›æ¶ˆè´¹çº¿ç¨‹è¿‡å°ä»»åŠ¡é˜Ÿåˆ—è¿‡é•¿ï¼Œç§¯å‹ä»»åŠ¡ï¼Œå¯èƒ½å¯¼è‡´è¯·æ±‚è¶…æ—¶çš„æƒ…å†µï¼›é’ˆå¯¹è¿™äº›åœºæ™¯ï¼Œæå‡ºè§£å†³æ–¹æ¡ˆï¼šå¢åŠ çº¿ç¨‹æ± ç›‘æ§ï¼Œé€šè¿‡é…ç½®ä¸­å¿ƒï¼Œæ‰‹åŠ¨æ¥è°ƒæ•´javaçº¿ç¨‹æ± å‚æ•°, è¿›è¡ŒåŠ¨æ€é…ç½®åŒ–ç®¡ç†ï¼Œè¿™ä¸ªæ€è·¯å…¶å®ä¹Ÿæ˜¯æœåŠ¡åŸºç¡€ç¨³å®šæ€§çš„å¸¸ç”¨æ€è·¯ï¼Œåšå¥½ç›‘æ§æŠ¥è­¦ï¼Œé…ç½®åŒ–åŠæ—¶äººå·¥å“åº”ã€‚(ç¾å›¢çš„&lt;a href=&#34;https://mp.weixin.qq.com/s/C81f0_arbs23KGcaIwi56w&#34;&gt;å¤ç›˜æœºåˆ¶&lt;/a&gt;å€¼å¾—å­¦ä¹ )&lt;/p&gt;
&lt;h4 id=&#34;thread-pool-å°ç»“&#34;&gt;thread pool å°ç»“&lt;/h4&gt;
&lt;p&gt;å¼•å…¥çº¿ç¨‹æ± å…¶å®æœ¬è´¨ä¸Šè¿˜æ˜¯å¯¹å¤šçº¿ç¨‹çš„æœ‰æ•ˆç®¡ç†ï¼Œå……åˆ†åˆ©ç”¨å¤šæ ¸è¿›è¡Œå¹¶è¡Œå¤„ç†ï¼Œå‡å°‘çº¿ç¨‹é—´çš„ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€(&lt;strong&gt;ä¸Šä¸‹æ–‡åˆ‡æ¢æ—¶é—´åœ¨&lt;a href=&#34;https://eli.thegreenplace.net/2018/measuring-context-switching-and-memory-overheads-for-linux-threads/&#34;&gt;~1000 åˆ° ~1500 çº³ç§’&lt;/a&gt;ï¼Œï¼ˆå¹³å‡ï¼‰æ¯æ ¸å¿ƒ&lt;a href=&#34;https://www.youtube.com/watch?v=jEG4Qyo_4Bc&amp;amp;feature=youtu.be&amp;amp;t=266&#34;&gt;æ¯çº³ç§’ 12 æ¡æŒ‡ä»¤&lt;/a&gt;ï¼Œä¸Šä¸‹æ–‡åˆ‡æ¢å¯èƒ½ä¼šèŠ±è´¹å¤§çº¦ 12k åˆ°å¤§çº¦ 18k æ¡æŒ‡ä»¤çš„å»¶è¿Ÿ&lt;/strong&gt;)ï¼›ä»¥ä¸Šå®ç°çš„çº¿ç¨‹æ± æœ¬è´¨ä¸Šéƒ½æ˜¯é€šè¿‡å¤šçº¿ç¨‹å¼‚æ­¥ä¼˜åŒ–IOä»»åŠ¡ï¼Œé€šè¿‡çº¿ç¨‹æ± æ¥ç®¡ç†çº¿ç¨‹ï¼Œé€šè¿‡å‚æ•°è¿›è¡Œè°ƒä¼˜ï¼Œå……åˆ†åˆ©ç”¨å¤šæ ¸cpuç¡¬ä»¶èµ„æºï¼Œå¹¶è¡Œå¤„ç†ï¼Œååæœ€å¤§åŒ–(ps: rediså’Œnginxçš„æºç å€¼å¾—ä¸€æ’¸)ã€‚ ä½†æ˜¯ç”¨æˆ·åº”ç”¨å±‚ä½¿ç”¨çº¿ç¨‹æ± éœ€è¦å¯¹çº¿ç¨‹æ•°ç›®è¿›è¡Œè°ƒæ•´ï¼Œé‚£å¯å¦ä»ç”¨æˆ·åº”ç”¨å±‚é¢æ¥å°è£…ä¸€å±‚è¿›è¡Œè°ƒåº¦ç®¡ç†å‘¢ï¼Ÿ ç­”æ¡ˆæ˜¯æœ‰çš„ï¼ŒåƒGOè¯­è¨€ï¼Œç°åœ¨çš„å†…éƒ¨è¿è¡Œæ—¶runtime é€šè¿‡G-P-Mè°ƒåº¦æ¨¡å‹æ¥æœ‰æ•ˆç®¡ç†ï¼ŒGo è¯­è¨€çš„è°ƒåº¦æ¨¡å‹é€šè¿‡ä½¿ç”¨ä¸ CPU æ•°é‡ç›¸ç­‰çš„çº¿ç¨‹å‡å°‘çº¿ç¨‹é¢‘ç¹åˆ‡æ¢çš„å†…å­˜å¼€é”€(å¦‚æœæ˜¯åœ¨å®¹å™¨ç¯å¢ƒä¸­ï¼Œå¯ä»¥é€šè¿‡&lt;a href=&#34;https://github.com/uber-go/automaxprocs&#34;&gt;uber-go/automaxprocs&lt;/a&gt; è¿è¡Œæ—¶è‡ªåŠ¨é€‚é…åˆ†é…ç»™å®¹å™¨cpuæ ¸æ•°)ï¼ŒåŒæ—¶åœ¨æ¯ä¸€ä¸ªçº¿ç¨‹ä¸Šæ‰§è¡Œé¢å¤–å¼€é”€æ›´ä½çš„ Goroutine åç¨‹æ¥é™ä½æ“ä½œç³»ç»Ÿå’Œç¡¬ä»¶çš„è´Ÿè½½ï¼Œç”¨æˆ·åº”ç”¨å±‚é¢ä¸éœ€è¦è€ƒè™‘å¤šçº¿ç¨‹ç¼–ç¨‹çš„ç»†èŠ‚ï¼Œé‡ç‚¹å…³æ³¨Goroutine åç¨‹çš„ä½¿ç”¨ä¼˜åŒ–ï¼Œäº†è§£G-P-Mæ¨¡å‹ï¼Œè¿è¡Œæ—¶&lt;a href=&#34;http://www1.cs.columbia.edu/~aho/cs6998/reports/12-12-11_DeshpandeSponslerWeiss_GO.pdf&#34;&gt;è°ƒåº¦æœºåˆ¶&lt;/a&gt;ã€‚(äº«å—ä¸€æ³¢è¯­è¨€,å·¥å…·ç¦åˆ©æ—¶ï¼Œ&lt;strong&gt;æ³¨æ„ç³»ç»Ÿé˜»å¡è°ƒç”¨æ—¶çš„çº¿ç¨‹æ³„éœ²,ä»¥åŠå¼‚æ­¥é˜»å¡æ—¶çš„åç¨‹æ³„æ¼, raceæ£€æŸ¥,æ€§èƒ½æµ‹è¯•,pprof/traceåˆ†æ,é€ƒé€¸åˆ†æ,GC&lt;/strong&gt;ç­‰)&lt;/p&gt;
&lt;h3 id=&#34;åç¨‹æ± coroutine-pool&#34;&gt;åç¨‹æ± (coroutine pool)&lt;/h3&gt;
&lt;p&gt;åç¨‹æ˜¯è¿è¡Œåœ¨ç”¨æˆ·æ€çš„è½»é‡çº¿ç¨‹ï¼Œå¯ä»¥è®¤ä¸ºæ˜¯ç”¨æˆ·åº”ç”¨å±‚é¢çš„çº¿ç¨‹ï¼Œ æ¯”çº¿ç¨‹åˆ†é…çš„è™šæ‹Ÿå†…å­˜æ ˆç©ºé—´è¦å°ï¼›åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ‰€å è™šæ‹Ÿå†…å­˜æ ˆç©ºé—´å¤§å°ï¼Œåœ¨linuxä¸‹é€šè¿‡&lt;code&gt;pmap &lt;/code&gt;+pid æŸ¥çœ‹stackå¤§å°ï¼Œ åœ¨macOSä¸‹é€šè¿‡&lt;code&gt;vmmap -interleaved&lt;/code&gt;+pid æŸ¥çœ‹stackå¤§å°ï¼Œå¤§å°ç”±&lt;code&gt;ulimit -s&lt;/code&gt; æ§åˆ¶ï¼Œçº¿ç¨‹æ ˆç©ºé—´ä¸€èˆ¬åœ¨8M~10Må·¦å³ï¼Œå¦‚æœä½¿ç”¨ä¸å½“ä¼šæ ˆæº¢å‡ºï¼›è€Œåç¨‹åˆ†é…ç©ºé—´æ˜¯ç”±å®ç°åç¨‹è¯­è¨€æ¥å†³å®šï¼ŒåƒGOå®ç°çš„goroutineåç¨‹åˆå§‹åˆ›å»ºæ ˆç©ºé—´å¤§å°æ˜¯2k(go 1.4+ é‡‡ç”¨è¿ç»­å †æ ˆç­–ç•¥ï¼Œä»¥å‰æ˜¯åˆ†æ®µæ ˆç­–ç•¥)ï¼Œæœ€å¤§é™åˆ¶çš„é»˜è®¤å€¼åœ¨64ä½ç³»ç»Ÿä¸Šæ˜¯1GBï¼ˆ&lt;a href=&#34;https://github.com/golang/go/blob/f296b7a6f045325a230f77e9bda1470b1270f817/src/runtime/proc.go#L120&#34;&gt;ä¸åŒçš„æ¶æ„æœ€å¤§æ•°ä¼šä¸åŒ&lt;/a&gt;ï¼‰ï¼›ç¼–è¯‘æœŸé—´æ’å…¥æ£€æŸ¥ï¼Œè°ƒç”¨æ—¶å¦‚æœæ»¡è¶³äº†æ‰©å®¹æ¡ä»¶(æ ¹æ®è¢«è°ƒç”¨å‡½æ•°æ ˆå¸§çš„å¤§å°æ¥åˆ¤æ–­æ˜¯å¦éœ€è¦æ‰©å®¹ï¼Œé€šè¿‡ stackguard0 æ¥åˆ¤æ–­æ˜¯å¦è¦è¿›è¡Œæ ˆå¢é•¿)ï¼Œæ‰©å®¹ä¸¤å€ç©ºé—´ï¼Œå¦‚æœåç¨‹æ‰€ä½¿ç”¨çš„æ ˆç©ºé—´å°äº1/4æ—¶ï¼Œç¼©å®¹æˆä¸€åŠç©ºé—´ï¼›(å…·ä½“ç»†èŠ‚è§ï¼š&lt;a href=&#34;https://draveness.me/golang/docs/part3-runtime/ch07-memory/golang-stack-management/&#34;&gt;æ ˆç©ºé—´ç®¡ç†&lt;/a&gt; &lt;a href=&#34;https://kirk91.github.io/posts/2d571d09/&#34;&gt;æ¨é€åœºæ™¯: èŠä¸€èŠgoroutine stack&lt;/a&gt;)&lt;/p&gt;
&lt;p&gt;å°½ç®¡goroutineåç¨‹æ¯”çº¿ç¨‹åˆ†é…æ ˆç©ºé—´å°ï¼Œä½†æ˜¯ å¤§é‡çš„ goroutine è¿˜æ˜¯å¾ˆè€—èµ„æºçš„ï¼Œè€Œä¸”å¤§é‡çš„ goroutine å¯¹äºè°ƒåº¦å’Œåƒåœ¾å›æ”¶çš„è€—æ—¶è¿˜æ˜¯ä¼šæœ‰å½±å“çš„ï¼Œå› æ­¤ï¼Œgoroutine å¹¶ä¸æ˜¯è¶Šå¤šè¶Šå¥½ï¼Œæ‰€ä»¥ä½¿ç”¨åç¨‹æ± æ¥ä¼˜åŒ–ï¼›&lt;/p&gt;
&lt;p&gt;GOä¸­ç®¡ç†åç¨‹æ± çš„å¼€å‘æ–¹æ¡ˆè¿˜æ˜¯æ¯”è¾ƒå¤šçš„ï¼Œå¤§éƒ½æ˜¯å’Œçº¿ç¨‹æ± ä»»åŠ¡å·¥ä½œæ¨¡å‹å·®ä¸å¤šï¼Œä»»åŠ¡é˜Ÿåˆ—ç”¨çš„æ˜¯GOä¸­çš„runtime/channel,  æ± åŒ–ç®¡ç†ç”¨çš„æ˜¯GOä¸­çš„sync.Pool, æ¯”å¦‚&lt;a href=&#34;https://github.com/valyala/fasthttp/blob/9f11af296864153ee45341d3f2fe0f5178fd6210/workerpool.go#L16&#34;&gt;fasthttp workerpool&lt;/a&gt; é’ˆå¯¹è‡ªèº«åœºæ™¯çš„å¤šä¸ªè¿æ¥é€šé“æ± åŒ–å¤ç”¨ -&amp;gt; &lt;a href=&#34;https://github.com/panjf2000/ants&#34;&gt;panjf2000/ants&lt;/a&gt; é€šç”¨åŒ–äº†å¤šä¸ªä»»åŠ¡é€šé“æ± åŒ–å¤ç”¨ -&amp;gt; &lt;a href=&#34;https://github.com/bytedance/gopkg/tree/develop/util/gopool&#34;&gt;bytedance/gopool&lt;/a&gt; ä»»åŠ¡taskerå’Œå·¥ä½œworkeræ± åŒ–å¤ç”¨ï¼›ç›¸å¯¹çº¿ç¨‹æ± thread poolçš„å®ç°è¦ç®€å•äº›ï¼Œå› ä¸ºåº•å±‚GO runtimeçš„&lt;a href=&#34;https://www.ardanlabs.com/blog/2018/08/scheduling-in-go-part2.html&#34;&gt;è°ƒåº¦å™¨&lt;/a&gt;ä»¥åŠsyncåº“å·²ç»åšäº†å¤§éƒ¨åˆ†çš„ä¼˜åŒ–(æ— é”æˆ–æœ€å°åŒ–é”ç²’åº¦)ã€‚&lt;a href=&#34;https://time.geekbang.org/column/article/301716&#34;&gt;Poolï¼šæ€§èƒ½æå‡å¤§æ€å™¨&lt;/a&gt; ä¸­ä»‹ç»äº†GOä¸­sync.Poolçš„å®ç°ï¼Œä»¥åŠåç¨‹æ± çš„ä¸‰æ–¹å¼€æºæ–¹æ¡ˆå®ç°ï¼›&lt;/p&gt;
&lt;p&gt;è¿™é‡Œä»‹ç»ä¸€ä¸ªå®ç°çš„ &lt;a href=&#34;https://github.com/weedge/lib/tree/main/pool/workerpool&#34;&gt;workerpool&lt;/a&gt;   é€šè¿‡channel å­˜æ”¾ä»»åŠ¡ï¼Œå¤šä¸ª Worker å…±äº«åŒä¸€ä¸ªä»»åŠ¡ Channelï¼Œé€šè¿‡å¤šä¸ªåç¨‹æ¥æ¶ˆè´¹æ± ä¸­çš„ä»»åŠ¡æ‰§è¡Œï¼Œåç¨‹æ ¹æ®æäº¤çš„ä»»åŠ¡æ•°åŠ¨æ€æ‰©ç¼©åç¨‹ï¼›ä»»åŠ¡å¯ä»¥å®šä¹‰è¾“å…¥ï¼Œè¾“å‡ºï¼Œè¶…æ—¶æ—¶é—´ï¼›é€šè¿‡channel è¿”å›æ˜¯å¦è¶…æ—¶; å¯ç”¨äºæ‰¹é‡ä»»åŠ¡å¹¶å‘æ‰§è¡Œåœºæ™¯ï¼Œé€‚ç”¨äºå¤§é‡æ‰¹é‡è€—æ—¶ç›¸å¯¹æ¯”è¾ƒé«˜çš„ä»»åŠ¡ï¼›åœ¨å®é™…å·¥ä½œä¸­ï¼Œæ¯”å¦‚ç»„ç»‡å¼•æ“ä¸­æ ‘ä¸­ç»„ç»‡èŠ‚ç‚¹çš„ç”Ÿæˆï¼Œæœ‰äº›ä»»åŠ¡è¶…æ—¶äº†ï¼Œä½¿ç”¨æ–¹å¯ä»¥é‡æ–°æ”¾å…¥é˜Ÿåˆ—ä¸­ï¼Œæˆ–è€…å‡ºé”™æŠ¥è­¦ç­‰æ“ä½œã€‚ æ‰§è¡Œæµç¨‹å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://raw.githubusercontent.com/weedge/lib/main/pool/workerpool/workerpool.png&#34; alt=&#34;workerpool&#34;&gt;&lt;/p&gt;
&lt;p&gt;è¿˜æœ‰åç¨‹æ± çš„å®ç°æ–¹å¼ï¼Œä¸»è¦æ˜¯ä¸ºäº†åº”å¯¹çªå‘æµé‡(åœºæ™¯ï¼šå¤„ç†å¤§é‡è¿æ¥è¯·æ±‚)ï¼Œå¦‚ä¸‹å‡ ä¸ªï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/gammazero/workerpool.git&#34;&gt;gammazero/workerpool&lt;/a&gt;  å®ç°ç”¨åˆ°3ä¸ªé˜Ÿåˆ—ï¼Œä¸€ä¸ªç”¨äºæäº¤ä»»åŠ¡çš„ä»»åŠ¡é˜Ÿåˆ—(buffer channel length 1ï¼Œå‘é€ä»»åŠ¡éé˜»å¡)ã€ä¸€ä¸ªç­‰å¾…é˜Ÿåˆ—ï¼ˆbuf[] interface{} head,tailï¼Œä¸ºäº†åº”å¯¹çªå‘æµé‡è®¾ç½®çš„buff,æ— é™åˆ¶)ã€ ä¸€ä¸ªå·¥ä½œé˜Ÿåˆ—(block channelï¼Œç”¨é˜»å¡chanæ˜¯ä¸ºäº†è®©æ¶ˆè´¹çš„workerå…ˆå¯åŠ¨)ï¼›æœªä½¿ç”¨sync.Poolï¼›é€šè¿‡dispatchåç¨‹æ¥ç®¡ç†å·¥ä½œåç¨‹ï¼Œ å®šæ—¶(idleTimeout)æ£€æŸ¥å·¥ä½œé˜Ÿåˆ—æ˜¯å¦æœ‰ä»»åŠ¡(idle), ä»¥åŠæœ‰å·¥ä½œåç¨‹(workerCount&amp;gt;1)ï¼Œå‘é€ç©ºä»»åŠ¡(nil) ç»“æŸå·¥ä½œåç¨‹ï¼›è¿™ä¸ªæ£€æŸ¥æ˜¯å¦æœ‰ç©ºé—²å·¥ä½œåç¨‹æœºåˆ¶æ¯”è¾ƒç®€å•ï¼Œæ¯åˆ°å®šæ—¶æ—¶é—´æ“ä½œä¸€æ¬¡ï¼Œå›æ”¶é¢‘ç‡å¯ä»¥è°ƒæ•´ï¼ŒidleTimeouté»˜è®¤2ç§’ï¼›é€šè¿‡å‘é€æš‚åœä»»åŠ¡ (Context/stopSignal) æ¥æš‚åœworkerå·¥ä½œä»¥åŠæ•´ä¸ªworkerpoolï¼Œè¿˜æœ‰æäº¤ç­‰å¾…æ‰§è¡Œå®Œæˆçš„ä»»åŠ¡ï¼Œé€šè¿‡Paceræäº¤é™é€Ÿä»»åŠ¡ï¼Œä½¿ç”¨æ–¹ä¹Ÿå¯ä»¥æäº¤è¶…æ—¶ä»»åŠ¡ï¼›ä½¿ç”¨goroutine+channel+sync+contextæ•´ä½“å®ç°workerpoolå°±300è¡Œå·¦å³ï¼Œè¿™ä¸ªå’ŒThreadPoolExecutoræœ‰äº›ç±»ä¼¼ï¼Œæµç¨‹å¦‚ä¸‹ï¼š&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;img src=&#34;https://raw.githubusercontent.com/weedge/mypic/master/go-workerpool.drawio.png&#34; alt=&#34;go-workerpool&#34;&gt;&lt;/p&gt;
&lt;ol start=&#34;2&#34;&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/valyala/fasthttp/blob/9f11af296864153ee45341d3f2fe0f5178fd6210/workerpool.go#L16&#34;&gt;fasthttp workerpool&lt;/a&gt; é’ˆå¯¹è‡ªèº«åœºæ™¯çš„å¤šä¸ªè¿æ¥é€šé“æ± åŒ–å¤ç”¨ï¼› -&amp;gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/panjf2000/ants&#34;&gt;panjf2000/ants&lt;/a&gt; é€šç”¨åŒ–äº†å¤šä¸ªä»»åŠ¡é€šé“æ± åŒ–å¤ç”¨ï¼ˆä¸€æ¬¡ä»»åŠ¡Gç”¨å®Œç”Ÿå‘½å‘¨æœŸè¿˜å¯ä»¥å¤ç”¨(æŒ‰ç©ºé—²æ—¶é—´é•¿çŸ­å›æ”¶), å¯ç”¨workeræ”¾å…¥è‡ªå®šä¹‰çš„æ± ä¸­(stack/loopQueue) , å¦‚æœå·¥ä½œæ± æ²¡æœ‰å¯ç”¨worker, æ ¹æ®é…ç½®æ˜¯å¦ç­‰å¾…ï¼Œç­‰å¾…åˆ™ç­‰æœ‰å¯ç”¨workeræ—¶é€šè¿‡æ¡ä»¶å˜é‡(Cond)å”¤é†’,ä½¿ç”¨è‡ªæ—‹é”; å®šæ—¶ä»è‡ªå®šä¹‰çš„å·¥ä½œæ± ä¸­è·å–ç©ºé—²æ—¶é—´å¤§äºé…ç½®é˜ˆå€¼çš„workerè¿›è¡Œå›æ”¶ï¼‰&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/bytedance/gopkg/tree/develop/util/gopool&#34;&gt;bytedance/gopool&lt;/a&gt; ä»»åŠ¡taskå’Œå·¥ä½œworkeræ± åŒ–å¤ç”¨(ä¸€æ¬¡ä»»åŠ¡Gç”¨å®Œç”Ÿå‘½å‘¨æœŸå¯ä»¥å¤ç”¨ï¼Œå¤ç”¨æ ˆç©ºé—´ï¼Œå°½é‡å‡å°‘åç¨‹è°ƒåº¦æ¶ˆè€—) -&amp;gt; (å°½é‡æ— é”åŒ–é˜Ÿåˆ—);é’ˆå¯¹&lt;strong&gt;ä¼˜åŒ–æ ˆæ‰©å¼ åœºæ™¯&lt;/strong&gt;ä½¿ç”¨(RPC æœåŠ¡å¸¸è§é—®é¢˜,æ¯”å¦‚ï¼š&lt;a href=&#34;https://kirk91.github.io/posts/2d571d09/&#34;&gt;æ¨é€åœºæ™¯: èŠä¸€èŠgoroutine stack&lt;/a&gt;)&lt;/p&gt;
&lt;p&gt;Tips: 1æœ‰ç­‰å¾…å…¨éƒ¨ä»»åŠ¡ç»“æŸï¼›2ï¼Œ3ï¼Œ4 è¿™äº›åç¨‹æ± æ²¡æœ‰ç­‰å¾…ï¼Œå› ä¸ºä½¿ç”¨åœºæ™¯å¤§å¤šæ˜¯å¤šä¸ªåç¨‹å¤„ç†å®Œä»»åŠ¡ä¹‹åæ— éœ€ç­‰å¾…ç»“æœå¤„ç†ï¼Œå¯ä»¥è‡ªå·±çš„ä»»åŠ¡ä¸­å®šä¹‰ï¼›1,2,3éƒ½ä½¿ç”¨äº†channel, 1æ˜¯åœ¨æ¶ˆè´¹ä¾§å¯åŠ¨goroutineï¼Œ2,3æ˜¯åœ¨ç”Ÿäº§ä¾§å¯åŠ¨goroutineï¼Œé€šè¿‡channelå•å‘é€šä¿¡taskï¼›4 æœªä½¿ç”¨channelæ¥é€šä¿¡ï¼Œç›´æ¥é€šè¿‡FIFOå•å‘taské“¾è¡¨ï¼Œä¸Šé”å¤´å‡ºå°¾å…¥taskï¼Œåœ¨ç”Ÿäº§ä¾§å¯åŠ¨goroutineï¼›&lt;/p&gt;
&lt;p&gt;æ»¡è¶³åç¨‹å¤ç”¨çš„å‰æä¸‹ï¼Œåœ¨ç”Ÿäº§ä¾§taskï¼Œé˜Ÿåˆ—ï¼Œæ¶ˆè´¹ä¾§worker ä¸Šå°½é‡ä¼˜åŒ–ç»“æ„ï¼Œç»“åˆè°ƒåº¦ç‰¹æ€§ã€‚&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;ä»¥ä¸Šçš„workerpool éƒ½æœ‰ç¼“å†²é˜Ÿåˆ—ï¼Œå¦‚æœæœåŠ¡è¿›ç¨‹é‡å¯ï¼Œéœ€è¦å¹³æ»‘åœæ­¢æœåŠ¡ï¼Œå°±æ˜¯åœ¨æ”¶åˆ°TERMä¿¡å·æ—¶ï¼Œéœ€è¦è°ƒç”¨workerpoolæä¾›çš„Waitæ¥å£, å¯¹äºæœªç­‰å¾…çš„åç¨‹æ± ï¼Œä½¿ç”¨sync.WaitGroupæ¥ç­‰å¾…å‰©ä½™çš„ä»»åŠ¡æ‰§è¡Œå®Œæˆï¼Œè¿™ç§ä»»åŠ¡å¦‚æœæ˜¯ç”¨æˆ·è¯·æ±‚ä»»åŠ¡ï¼Œä¸€èˆ¬éƒ½æ˜¯çŸ­ä»»åŠ¡ï¼Œå¤„ç†æ—¶é—´ä¸ä¼šå¾ˆé•¿ï¼ŒåƒPod ä¸­çš„ docker containeré”€æ¯çš„æ—¶å€™éƒ½ä¼šç­‰å¾…ä¸€æ®µæ—¶é—´æ‰ä¼šå›æ”¶æ‰ï¼›å¦‚æœæ˜¯é•¿æ—¶é—´ä»»åŠ¡ï¼Œæ¯”å¦‚cron job å–å†³äºä»»åŠ¡çš„é‡è¦ç¨‹åº¦ï¼Œåˆ™éœ€è¦è½åº“å­˜æ”¾ä»»åŠ¡çŠ¶æ€ï¼Œåœ¨ä»»åŠ¡æäº¤ä¹‹å‰é€šè¿‡ä»»åŠ¡è¡¨æ¥è®°å½•ï¼Œå› ä¸ºè¿›ç¨‹æœ¬åœ°è®°å½•æ˜¯ä¸å¯è¡Œçš„ï¼Œå¦‚æœå®¹å™¨åŒ–éƒ¨ç½²åœ¨Podä¸­ï¼Œæ¯æ¬¡éƒ¨ç½²çš„Nodeä¼šä¸åŒï¼›è¯·æ ¹æ®éœ€æ±‚åœºæ™¯é€‰æ‹©åˆé€‚çš„workerpoolã€‚&lt;/p&gt;
&lt;h3 id=&#34;å°ç»“&#34;&gt;å°ç»“&lt;/h3&gt;
&lt;p&gt;çº¿ç¨‹ä½œä¸ºcpuæ‰§è¡Œè°ƒåº¦çš„æœ€å°å•å…ƒï¼Œè€Œè¿›ç¨‹ä½œä¸ºèµ„æºåˆ†é…æœ€å°å•å…ƒï¼Œè¿›ç¨‹ä¸­æœ‰å¤šä¸ªçº¿ç¨‹ï¼Œå…±äº«å…¶è¿›ç¨‹èµ„æºï¼Œä½œä¸ºçº¿ç¨‹çš„å®¹å™¨ï¼Œç›¸äº’éš”ç¦»ä¸åŒè¿›ç¨‹ä¹‹é—´çš„çº¿ç¨‹ï¼Œæ‰€ä»¥nginx/fpm éƒ½æ˜¯å¤šè¿›ç¨‹(å•çº¿ç¨‹)+reactorå¤šè·¯å¤ç”¨çš„æ–¹å¼å¤„ç†ç½‘ç»œIOè¯·æ±‚ï¼› php-fpm ä¸ºäº†æœ‰æ•ˆæ§åˆ¶è¯·æ±‚è¿›ç¨‹æ‰€å èµ„æºè¿‡å¤šæ¶ˆè€—å†…å­˜çš„æƒ…å†µï¼Œå¼•å…¥å·¥ä½œè¿›ç¨‹æ± æ¥é˜²æ­¢è¿‡åº¦æ¶ˆè€—å†…å­˜ï¼Œè€Œä¸”å¯ä»¥å¤ç”¨å·¥ä½œè¿›ç¨‹æ¥å¤„ç†è¯·æ±‚ï¼›nginx ä¸ºäº†ä¼˜åŒ–ç³»ç»Ÿè°ƒç”¨æ—¶é˜»å¡ioï¼Œä½¿ç”¨çº¿ç¨‹æ± æ¥å¼‚æ­¥åŒ–å¤„ç†å¤„ç†é˜»å¡ioäº‹ä»¶ï¼›redis å¼•å…¥å¤šçº¿ç¨‹æ¥è§£å†³ç£ç›˜IO,é‡Šæ”¾å†…å­˜ç©ºé—´ï¼Œä»¥åŠç½‘ç»œIOè¯»å†™çš„æ€§èƒ½é—®é¢˜ï¼Œnginxå’Œredis å¼•å…¥å¤šçº¿ç¨‹éƒ½éœ€è¦ç¼–è¯‘é…ç½®ï¼Œå…¶ä¸­nginxå’Œredisä¸­çš„ç½‘ç»œIOä¼˜åŒ–ç»†èŠ‚å€¼å¾—å­¦ä¹ çš„ï¼›åç¨‹åˆ›å»ºåˆ†é…æ ˆç©ºé—´æ¯”çº¿ç¨‹æ›´å°ï¼ŒGolangä¸­é€šè¿‡å¯å¢é•¿æ ˆç©ºé—´ï¼Œè¿è¡Œæ—¶runtime é€šè¿‡G-P-Mè°ƒåº¦æ¨¡å‹æ¥å°† goroutine å¤šè·¯å¤ç”¨åˆ°çº¿ç¨‹ï¼Œå¦‚æœåç¨‹è¿‡å¤šï¼Œä¹Ÿä¼šå½±å“è°ƒåº¦ä»¥åŠGCæ ‡è®°æ¸…é™¤æ•ˆç‡ï¼Œæ‰€ä»¥åœ¨æ¶ˆè€—å¤§é‡åç¨‹çš„åœºæ™¯ä¸‹ï¼Œå¼•å…¥åç¨‹æ± æ¥å¤ç”¨ï¼Œå› ä¸ºgolang runtimeè°ƒåº¦æ¨¡å‹ä»¥åŠchannelæœºåˆ¶ï¼Œä½¿ç”¨&lt;a href=&#34;https://go.dev/blog/pipelines&#34;&gt;Go Concurrency Patterns&lt;/a&gt; å®ç°åç¨‹æ± æ–¹æ¡ˆå¾ˆå¤šï¼Œgolangç¤¾åŒºæ´»è·ƒï¼Œæœ€å¥½ç»“åˆéœ€æ±‚åœºæ™¯æ¥åˆ†æã€‚&lt;/p&gt;
&lt;h2 id=&#34;references&#34;&gt;references&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;&lt;a href=&#34;https://hpc.llnl.gov/training/tutorials/introduction-parallel-computing-tutorial&#34;&gt;Introduction to Parallel Computing Tutorial&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://www.akkadia.org/drepper/nptl-design.pdf&#34;&gt;nptl-design.pdf&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://sourceware.org/git/?p=glibc.git;a=blob;f=nptl/pthread_create.c;hb=627f5ede70d70c77bdaf857db07404e8bf7f60af#l619&#34;&gt;glibc pthread_create&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/torvalds/linux/blob/master/kernel/fork.c&#34;&gt;linux v2.6.38+ fork.c&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://makelinux.github.io/kernel/map/&#34;&gt;Linux 2.6.36 kernel map&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://www.nginx.com/blog/thread-pools-boost-performance-9x/&#34;&gt;nginx-thread-pools-boost-performance-9x&lt;/a&gt; &lt;a href=&#34;https://segmentfault.com/a/1190000010008012&#34;&gt;ç¿»è¯‘&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://www.nginx.com/blog/inside-nginx-how-we-designed-for-performance-scale/&#34;&gt;inside-nginx-how-we-designed-for-performance-scale&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://www.aosabook.org/en/nginx.html&#34;&gt;AOSA-nginx&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://antirez.com/news/93&#34;&gt;Lazy Redis is better Redis&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://redis.io/topics/benchmarks&#34;&gt;How fast is Redis?&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://tech.meituan.com/2020/04/02/java-pooling-pratice-in-meituan.html&#34;&gt;Javaçº¿ç¨‹æ± å®ç°åŸç†åŠå…¶åœ¨ç¾å›¢ä¸šåŠ¡ä¸­çš„å®è·µ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://www1.cs.columbia.edu/~aho/cs6998/reports/12-12-11_DeshpandeSponslerWeiss_GO.pdf&#34;&gt;Analysis of the Go runtime scheduler&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://www.bilibili.com/video/BV1Bq4y1q7Pi&#34;&gt;Golangæ“ä½œç³»ç»Ÿè°ƒåº¦åŸç†&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://www.ardanlabs.com/blog/2018/08/scheduling-in-go-part1.html&#34;&gt;Scheduling In Go : Part I - OS Scheduler&lt;/a&gt; &lt;a href=&#34;https://www.ardanlabs.com/blog/2018/08/scheduling-in-go-part2.html&#34;&gt;Part II - Go Scheduler&lt;/a&gt; &lt;a href=&#34;https://www.ardanlabs.com/blog/2018/12/scheduling-in-go-part3.html&#34;&gt;Part III - Concurrency&lt;/a&gt;  &lt;a href=&#34;https://github.com/ardanlabs/gotraining&#34;&gt;gotraining&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://www.youtube.com/watch?v=f6kdp27TYZs&#34;&gt;Google I/O 2012 - Go Concurrency Patterns &lt;/a&gt; &lt;a href=&#34;https://talks.golang.org/2012/concurrency.slide#1&#34;&gt;ã€Œslideã€&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://www.youtube.com/watch?v=QDDwwePbDtw&#34;&gt;Google I/O 2013 - Advanced Go Concurrency Patterns&lt;/a&gt;  &lt;a href=&#34;https://talks.golang.org/2013/advconc.slide#1&#34;&gt;ã€Œslideã€&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://www.youtube.com/watch?v=5zXAHh5tJqQ&#34;&gt;Rethinking Classical Concurrency Patterns&lt;/a&gt;  &lt;strong&gt;&lt;a href=&#34;https://drive.google.com/file/d/1nPdvhB0PutEJzdCq5ms6UI58dp50fcAN/view&#34;&gt;ã€Œslideã€&lt;/a&gt;&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://docs.google.com/document/d/1ETuA2IOmnaQ4j81AtTGT40Y4_Jr6_IDASEKg0t0dBR8/edit&#34;&gt;Go Preemptive Scheduler Design Doc&lt;/a&gt;  &lt;a href=&#34;https://rakyll.org/scheduler/&#34;&gt;Go&amp;rsquo;s work-stealing scheduler&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://tonybai.com/2017/06/27/an-intro-about-go-portability/&#34;&gt;ä¹Ÿè°ˆGoçš„å¯ç§»æ¤æ€§&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://www.youtube.com/watch?v=KINIAgRpkDA&#34;&gt;The Design of the Go Assembler&lt;/a&gt; &lt;a href=&#34;https://9p.io/sys/doc/asm.html&#34;&gt;A Manual for the Plan 9 assembler&lt;/a&gt; &lt;a href=&#34;https://github.com/cch123/golang-notes/blob/master/assembly.md&#34;&gt;plan9 assembly å®Œå…¨è§£æ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://time.geekbang.org/column/article/301716&#34;&gt;Poolï¼šæ€§èƒ½æå‡å¤§æ€å™¨&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;</description>
      
    </item>
    
    <item>
      <title>WAL</title>
      <link>https://weedge.github.io/post/wal/</link>
      <pubDate>Sun, 21 Nov 2021 10:26:23 +0800</pubDate>
      
      <guid>https://weedge.github.io/post/wal/</guid>
      
        <description>&lt;h2 id=&#34;åºè¨€&#34;&gt;åºè¨€&lt;/h2&gt;
&lt;p&gt;â€‹	æ•°æ®è½åœ°ä¹‹å‰ï¼Œå¦‚æœå‡ºç°æŒä¹…åŒ–å­˜å‚¨å¼•æ“å®ä¾‹é‡å¯ï¼Œæˆ–è€…æœåŠ¡å½“æœºé‡å¯ï¼Œå¦‚ä½•è¿›è¡Œæ•…éšœæ¢å¤ï¼ˆCrash Recoveryï¼‰å‘¢ï¼Ÿæ•°æ®å†™æ“ä½œå¢åˆ æ”¹ï¼Œè¿™äº›æ“ä½œçŠ¶æ€æ•°æ®ï¼Œæ˜¯å¦‚ä½•ä¿è¯äº‹åŠ¡ä¸­åŸå­æ€§å’ŒæŒä¹…æ€§çš„å‘¢ï¼Ÿ è¿™äº›é—®é¢˜æ•°æ®å¤§æ‹¿ä»¬æå‡ºäº†&lt;a href=&#34;https://en.wikipedia.org/wiki/Algorithms_for_Recovery_and_Isolation_Exploiting_Semantics&#34;&gt;Algorithms for Recovery and Isolation Exploiting Semantics&lt;/a&gt; ï¼ŒåŸºäºè¯­ä¹‰çš„æ¢å¤ä¸éš”ç¦»ç®—æ³•,ç°ä»£æ•°æ®åº“çš„åŸºç¡€ç†è®ºï¼›å½“å‰ä¸»æµå…³ç³»å‹æ•°æ®åœ¨äº‹åŠ¡å®ç°ä¸Šéƒ½å—åˆ°è¯¥ç†è®ºçš„å½±å“ï¼Œå…¶ä¸­æœ‰ä¸¤ç§æ•…éšœæ¢å¤çš„æ–¹æ³•ï¼š é¢„å†™æ—¥å¿—(write-ahead logging (WAL) ) å’Œshadow-page techniqueï¼›shadow-page æ–¹æ³•ç®€å•ä»‹ç»å°±æ˜¯æ¯æ¬¡äº‹åŠ¡æ“ä½œï¼Œä»¥pageä¸ºå•ä½ï¼Œå†™æ—¶å¤åˆ¶çš„æ–¹å¼ï¼Œåˆ†ä¸ºCurrentå’ŒShadowï¼Œç±»ä¼¼ä¸»å¤‡çš„å½¢å¼ï¼Œå¦‚æœcommitæˆåŠŸï¼ŒCurrentä¸­çš„pageåˆå¹¶åˆ° Shadowä¸­; å¦‚æœabortä¸æˆåŠŸä¸¢å¼ƒCurrentçš„page; å¦‚æœCrashäº†ï¼Œä»Shadowä¸­çš„pageæ¢å¤ï¼Œå¯¹æ‰€æœ‰æœªæäº¤äº‹åŠ¡çš„å›æ»šæ“ä½œï¼› ç”±äºshadow-pageæŠ€æœ¯çš„å®ç°ä»¥pageä¸ºå•ä½ï¼Œpageå†…æ— æ³•å¹¶å‘æ“ä½œï¼Œcommit/å›æ»šæ—¶ä¼šæœ‰å¤§é‡åƒåœ¾å›æ”¶æ“ä½œï¼›æœ¬æ–‡ä¸»è¦ä»‹ç»WALï¼Œä»¥åŠå¯¹åº”æŒä¹…åŒ–å­˜å‚¨å¼•æ“çš„å®ç°æœºåˆ¶ä»‹ç»ã€‚&lt;/p&gt;
&lt;h2 id=&#34;wal&#34;&gt;WAL&lt;/h2&gt;
&lt;p&gt;&lt;strong&gt;é¢„å†™æ—¥å¿—&lt;/strong&gt;( &lt;strong&gt;WAL&lt;/strong&gt; ) æ˜¯ä¸€ç³»åˆ—æŠ€æœ¯ï¼Œç”¨äºåœ¨&lt;a href=&#34;https://en.wikipedia.org/wiki/Database_system&#34;&gt;æ•°æ®åº“ç³»ç»Ÿä¸­&lt;/a&gt;æä¾›&lt;a href=&#34;https://en.wikipedia.org/wiki/Atomicity_(database_systems)&#34;&gt;åŸå­æ€§&lt;/a&gt;å’Œ&lt;a href=&#34;https://en.wikipedia.org/wiki/Durability_(database_systems)&#34;&gt;æŒä¹…æ€§&lt;/a&gt;ï¼ˆä¸¤ä¸ª&lt;a href=&#34;https://en.wikipedia.org/wiki/ACID&#34;&gt;ACID&lt;/a&gt;å±æ€§ï¼‰ã€‚åœ¨å°†æ›´æ”¹å†™å…¥æ•°æ®åº“ä¹‹å‰ï¼Œæ›´æ”¹é¦–å…ˆè®°å½•åœ¨æ—¥å¿—ä¸­ï¼Œæ—¥å¿—å¿…é¡»å†™å…¥&lt;a href=&#34;https://en.wikipedia.org/wiki/Stable_storage&#34;&gt;ç¨³å®šå­˜å‚¨&lt;/a&gt;ï¼ˆä¿è¯ä»»ä½•ç»™å®šå†™å…¥æ“ä½œçš„åŸå­æ€§ï¼Œå¹¶å…è®¸ç¼–å†™å¯¹æŸäº›ç¡¬ä»¶å’Œç”µæºæ•…éšœå…·æœ‰&lt;a href=&#34;https://en.wikipedia.org/wiki/Robustness_(computer_science)&#34;&gt;é²æ£’æ€§çš„&lt;/a&gt;è½¯ä»¶ï¼‰ã€‚&lt;/p&gt;
&lt;p&gt;è¿™æ ·åšçš„ç›®çš„å¯ä»¥é€šè¿‡ä¸€ä¸ªä¾‹å­æ¥è¯´æ˜ã€‚æƒ³è±¡ä¸€ä¸‹ï¼Œå½“è¿è¡Œå®ƒçš„æœºå™¨æ–­ç”µæ—¶ï¼Œå®ƒæ­£åœ¨æ‰§è¡ŒæŸäº›æ“ä½œã€‚é‡æ–°å¯åŠ¨æ—¶ï¼Œè¯¥ç¨‹åºå¯èƒ½éœ€è¦çŸ¥é“å®ƒæ­£åœ¨æ‰§è¡Œçš„æ“ä½œæ˜¯æˆåŠŸã€éƒ¨åˆ†æˆåŠŸè¿˜æ˜¯å¤±è´¥ã€‚å¦‚æœä½¿ç”¨é¢„å†™æ—¥å¿—ï¼Œç¨‹åºå¯ä»¥æ£€æŸ¥æ­¤æ—¥å¿—å¹¶å°†æ„å¤–æ–­ç”µæ—¶åº”è¯¥æ‰§è¡Œçš„æ“ä½œä¸å®é™…æ‰§è¡Œçš„æ“ä½œè¿›è¡Œæ¯”è¾ƒã€‚åœ¨æ­¤æ¯”è¾ƒçš„åŸºç¡€ä¸Šï¼Œç¨‹åºå¯ä»¥å†³å®šæ’¤æ¶ˆå·²å¼€å§‹çš„å†…å®¹ã€å®Œæˆå·²å¼€å§‹çš„å†…å®¹æˆ–ä¿æŒåŸæ ·ã€‚&lt;/p&gt;
&lt;p&gt;åœ¨ä½¿ç”¨ WAL çš„ç³»ç»Ÿä¸­ï¼Œæ‰€æœ‰ä¿®æ”¹åœ¨åº”ç”¨ä¹‹å‰éƒ½ä¼šå†™å…¥&lt;a href=&#34;https://en.wikipedia.org/wiki/Database_log&#34;&gt;æ—¥å¿—&lt;/a&gt;ã€‚é€šå¸¸redoå’Œundoä¿¡æ¯éƒ½å­˜å‚¨åœ¨æ—¥å¿—ä¸­ã€‚&lt;/p&gt;
&lt;p&gt;æ³¨æ„ï¼šå†™ä¸ä¸€å®šæ˜¯é¡ºåºå†™ï¼Œä¸€èˆ¬&lt;a href=&#34;https://en.wikipedia.org/wiki/Computer_data_storage&#34;&gt;è®¡ç®—æœºå­˜å‚¨&lt;/a&gt; éæ˜“å¤±æ€§çš„ç¡¬ä»¶ç»“æ„å¯¹é¡ºåºå†™çš„æ€§èƒ½é«˜äºéšæœºå†™çš„æ€§èƒ½ï¼Œæ¯”å¦‚å¸¸ç”¨çš„ç£ç›˜HDD/SSD; ä½†æ˜¯æœ€è¿‘åŸºäºNVMæŠ€æœ¯(ç»“åˆç£ç›˜å’Œå†…å­˜çš„ç‰¹æ€§)çš„å­˜å‚¨ç¡¬ä»¶PC-RAM(Phase Change Random Access Memory), STT-RAM( Spin Transfer Torque Random Access Memory),  R-RAM(Resistive Random Access Memory)ï¼Œç»“åˆå†…å­˜ä¸­éšæœºè®¿é—®ï¼Œç£ç›˜éæ˜“å¤±æ€§ç‰¹æ€§ï¼Œéšæœºå†™å’Œé¡ºåºå†™æ²¡ä»€ä¹ˆå·®åˆ«ï¼Œ&lt;a href=&#34;http://repository.bilkent.edu.tr/bitstream/handle/11693/37609/Implications%20of%20non-volatile%20memory%20as%20primary%20storage%20for%20database%20management%20systems.pdf&#34;&gt;Implications of Non-Volatile Memory as Primary Storage for Database Management Systems&lt;/a&gt; è¿™ç¯‡è®ºæ–‡ä¸­æåˆ°Pgå¦‚æœä¸éƒ¨ç½²å†…éƒ¨çš„buffer cacheï¼Œæ‰€æœ‰å†™ç›´æ¥å†™åˆ°NVMå¯¹åº”çš„å­˜å‚¨ç¡¬ä»¶ä¸­ï¼Œå¯ä»¥å»æ‰redoæ—¥å¿—ï¼Œä½†æ˜¯undoæ—¥å¿—ä»»ç„¶éœ€è¦,åœ¨ç³»ç»Ÿé”™è¯¯æ—¶å¤åŸ; ä¸€èˆ¬å­¦æœ¯æ–¹æ¡ˆè¦é¢†å…ˆå®é™…å·¥ç¨‹è®¸å¤šï¼ŒçœŸæ­£è½åœ°åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œè¿˜æ˜¯ç”¨èººè¿‡å‘çš„æˆç†Ÿæ–¹æ¡ˆ ï¼ˆé¡ºä¾¿æƒ³åˆ°ç°åœ¨ä¸€äº›k/vå­˜å‚¨å¼•æ“è€ƒè™‘ä¸Šäº‘ï¼Œæ”¯æŒäº‘å‚å•†çš„äº‘ç›˜ï¼Œå¯ä»¥è®¤ä¸ºæ— é™å®¹é‡ï¼‰ã€‚ç¡¬ä»¶ç»“æ„å†³å®šä¸Šå±‚è½¯ä»¶å­˜å‚¨å¼•æ“çš„è®¾è®¡çš„ä¼˜åŒ–ï¼Œä»¥ä¸‹éƒ½æ˜¯ä»¥å¸¸ç”¨çš„ç£ç›˜HDD/SSDçš„ç¡¬ä»¶ç»“æ„æ¥ä»‹ç»å­˜å‚¨å¼•æ“å®ç°WALæŠ€æœ¯ã€‚&lt;/p&gt;
&lt;h2 id=&#34;mysql-innodbå­˜å‚¨å¼•æ“&#34;&gt;mysql Innodbå­˜å‚¨å¼•æ“&lt;/h2&gt;
&lt;p&gt;mysql Innodbå­˜å‚¨å¼•æ“æ˜¯é€šè¿‡ redoã€undo æ—¥å¿—å®ç° WAL,ä¸»è¦ç”¨äºcrash æ¢å¤å’Œå›æ»šï¼Œæ»¡è¶³æœ¬åœ°äº‹åŠ¡ä¸­çš„æŒä¹…æ€§å’ŒåŸå­æ€§ï¼Œæ¥ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼›å½“ç„¶innodbå¼•æ“ä¸ºäº†æé«˜å¹¶å‘è¯»æ€§èƒ½ï¼Œundo logä¸­åŠ å…¥äº†MVCC (å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶)ç›¸å…³ä¿¡æ¯ï¼› å¦å¤–ï¼Œmysql serverå±‚æ‰§è¡Œå™¨ä¼šå†™bin logï¼Œä¸»è¦æ˜¯ç”¨æ¥æ¢å¤æŸä¸ªæ—¶é—´çš„ç‚¹æ•°æ®ä»¥åŠä¸»ä»å¤åˆ¶æ•°æ®ä½¿ç”¨ï¼Œbin logæ–‡ä»¶å’Œå­˜å‚¨å¼•æ“æ— å…³ï¼›åˆ†åˆ«ç®€è¦ä»‹ç»redo, undo, bin log æ–‡ä»¶åœ¨mysqlä¸­çš„ä½œç”¨ã€‚&lt;/p&gt;
&lt;h3 id=&#34;redolog&#34;&gt;redolog&lt;/h3&gt;
&lt;h4 id=&#34;ä¸ºä»€ä¹ˆéœ€è¦redo-log&#34;&gt;ä¸ºä»€ä¹ˆéœ€è¦redo logï¼Ÿ&lt;/h4&gt;
&lt;p&gt;æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œäº‹åŠ¡çš„å››å¤§ç‰¹æ€§é‡Œé¢æœ‰ä¸€ä¸ªæ˜¯ &lt;strong&gt;æŒä¹…æ€§&lt;/strong&gt; ï¼Œå…·ä½“æ¥è¯´å°±æ˜¯&lt;strong&gt;åªè¦äº‹åŠ¡æäº¤æˆåŠŸï¼Œé‚£ä¹ˆå¯¹æ•°æ®åº“åšçš„ä¿®æ”¹å°±è¢«æ°¸ä¹…ä¿å­˜ä¸‹æ¥äº†ï¼Œä¸å¯èƒ½å› ä¸ºä»»ä½•åŸå› å†å›åˆ°åŸæ¥çš„çŠ¶æ€&lt;/strong&gt; ã€‚é‚£ä¹ˆmysqlæ˜¯å¦‚ä½•ä¿è¯ä¸€è‡´æ€§çš„å‘¢ï¼Ÿæœ€ç®€å•çš„åšæ³•æ˜¯åœ¨æ¯æ¬¡äº‹åŠ¡æäº¤çš„æ—¶å€™ï¼Œå°†è¯¥äº‹åŠ¡æ¶‰åŠä¿®æ”¹çš„æ•°æ®é¡µå…¨éƒ¨åˆ·æ–°åˆ°ç£ç›˜ä¸­ã€‚ä½†æ˜¯è¿™ä¹ˆåšä¼šæœ‰ä¸¥é‡çš„æ€§èƒ½é—®é¢˜ï¼Œä¸»è¦ä½“ç°åœ¨ä¸¤ä¸ªæ–¹é¢ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;å› ä¸º Innodbæ˜¯ä»¥é¡µä¸ºå•ä½è¿›è¡Œç£ç›˜äº¤äº’çš„ï¼Œè€Œä¸€ä¸ªäº‹åŠ¡å¾ˆå¯èƒ½åªä¿®æ”¹ä¸€ä¸ªæ•°æ®é¡µé‡Œé¢çš„å‡ ä¸ªå­—èŠ‚ï¼Œè¿™ä¸ªæ—¶å€™å°†å®Œæ•´çš„æ•°æ®é¡µåˆ·åˆ°ç£ç›˜çš„è¯ï¼Œå¤ªæµªè´¹èµ„æºäº†ï¼&lt;/li&gt;
&lt;li&gt;ä¸€ä¸ªäº‹åŠ¡å¯èƒ½æ¶‰åŠä¿®æ”¹å¤šä¸ªæ•°æ®é¡µï¼Œå¹¶ä¸”è¿™äº›æ•°æ®é¡µåœ¨ç‰©ç†ä¸Šå¹¶ä¸è¿ç»­ï¼Œä½¿ç”¨éšæœºIOå†™å…¥æ€§èƒ½å¤ªå·®ï¼&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;å› æ­¤ mysqlè®¾è®¡äº†redolog ï¼Œ &lt;strong&gt;å…·ä½“æ¥è¯´å°±æ˜¯åªè®°å½•äº‹åŠ¡å¯¹æ•°æ®é¡µåšäº†å“ªäº›ä¿®æ”¹&lt;/strong&gt;ï¼Œè¿™æ ·å°±èƒ½å®Œç¾åœ°è§£å†³æ€§èƒ½é—®é¢˜äº†(ç›¸å¯¹è€Œè¨€æ–‡ä»¶æ›´å°å¹¶ä¸”æ˜¯é¡ºåºIO)ã€‚&lt;/p&gt;
&lt;h4 id=&#34;redo-logåŸºæœ¬æ¦‚å¿µ&#34;&gt;redo logåŸºæœ¬æ¦‚å¿µ&lt;/h4&gt;
&lt;p&gt;redo logåŒ…æ‹¬ä¸¤éƒ¨åˆ†ï¼šä¸€ä¸ªæ˜¯å†…å­˜ä¸­çš„æ—¥å¿—ç¼“å†²( redo log buffer )ï¼Œå¦ä¸€ä¸ªæ˜¯ç£ç›˜ä¸Šçš„æ—¥å¿—æ–‡ä»¶(  redo log file )ã€‚ mysql æ¯æ‰§è¡Œä¸€æ¡ DML ä¿®æ”¹å†™è¯­å¥ï¼Œæ“ä½œçš„æ•°æ®åœ¨å†…å­˜ä¸­(å¦‚æœæ²¡æœ‰ä¼šloadåˆ°å†…å­˜ä¸­)ï¼Œé¦–å…ˆä¼šè®°ä¿®æ”¹æ“ä½œçš„åæ“ä½œé€»è¾‘æ•°æ®è®°å½•å†™å…¥undo log bufferä¸­ï¼Œç„¶åä¼šå°†ä¿®æ”¹å“ªä¸ªç‰©ç†é¡µé¢åšäº†ä»€ä¹ˆæ“ä½œè®°å½•å†™å…¥ redo log buffer ï¼Œåç»­æŸä¸ªæ—¶é—´ç‚¹å†ä¸€æ¬¡æ€§å°†å¤šä¸ªæ“ä½œè®°å½•å†™åˆ° redo log file å’Œ undo log fileã€‚è¿™ç§ &lt;strong&gt;å…ˆå†™æ—¥å¿—ï¼Œå†å†™ç£ç›˜&lt;/strong&gt; çš„æŠ€æœ¯å°±æ˜¯ MySQLä¸­çš„ WALã€‚&lt;/p&gt;
&lt;p&gt;åœ¨è®¡ç®—æœºæ“ä½œç³»ç»Ÿä¸­ï¼Œç”¨æˆ·ç©ºé—´( user space )ä¸‹çš„ç¼“å†²åŒºæ•°æ®ä¸€èˆ¬æƒ…å†µä¸‹æ˜¯æ— æ³•ç›´æ¥å†™å…¥ç£ç›˜çš„ï¼Œä¸­é—´å¿…é¡»ç»è¿‡æ“ä½œç³»ç»Ÿå†…æ ¸ç©ºé—´(kernel space )ç¼“å†²åŒº( OS Buffer )ã€‚å› æ­¤ï¼Œ redo/undo log buffer å†™å…¥ redo/undo log file; å®é™…ä¸Šæ˜¯å…ˆå†™å…¥ OS Buffer ï¼Œç„¶åå†é€šè¿‡ç³»ç»Ÿè°ƒç”¨ fsync() å°†å…¶åˆ·åˆ° redo/undo log file ä¸­ï¼Œè¿‡ç¨‹å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://image-static.segmentfault.com/755/731/755731335-aec527828a1323b6_fix732&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;p&gt;mysql æ”¯æŒä¸‰ç§å°† redo/undo log buffer å†™å…¥ redo/undo log file çš„æ—¶æœºï¼Œå¯ä»¥é€šè¿‡ innodb_flush_log_at_trx_commit  å‚æ•°é…ç½®ï¼Œå„å‚æ•°å€¼å«ä¹‰å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;å‚æ•°å€¼&lt;/th&gt;
&lt;th&gt;å«ä¹‰&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;0ï¼ˆå»¶è¿Ÿå†™ï¼‰&lt;/td&gt;
&lt;td&gt;äº‹åŠ¡æäº¤æ—¶ä¸ä¼šå°† redo/undo log buffer ä¸­æ—¥å¿—å†™å…¥åˆ° os buffer ï¼Œè€Œæ˜¯æ¯ç§’å†™å…¥ os buffer å¹¶è°ƒç”¨ fsync() å†™å…¥åˆ° redo/undo log file ä¸­ã€‚ä¹Ÿå°±æ˜¯è¯´è®¾ç½®ä¸º0æ—¶æ˜¯(å¤§çº¦)æ¯ç§’åˆ·æ–°å†™å…¥åˆ°ç£ç›˜ä¸­çš„ï¼Œå½“ç³»ç»Ÿå´©æºƒï¼Œä¼šä¸¢å¤±1ç§’é’Ÿçš„æ•°æ®ã€‚&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1ï¼ˆå®æ—¶å†™ï¼Œå®æ—¶åˆ·ï¼‰&lt;/td&gt;
&lt;td&gt;äº‹åŠ¡æ¯æ¬¡æäº¤éƒ½ä¼šå°† redo/undo log buffer ä¸­çš„æ—¥å¿—å†™å…¥ os buffer å¹¶è°ƒç”¨ fsync() åˆ·åˆ° redo/undo log file ä¸­ã€‚è¿™ç§æ–¹å¼å³ä½¿ç³»ç»Ÿå´©æºƒä¹Ÿä¸ä¼šä¸¢å¤±ä»»ä½•æ•°æ®ï¼Œä½†æ˜¯å› ä¸ºæ¯æ¬¡æäº¤éƒ½å†™å…¥ç£ç›˜ï¼ŒIOçš„æ€§èƒ½è¾ƒå·®ã€‚ä¸€èˆ¬å¼€å¯&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;2ï¼ˆå®æ—¶å†™ï¼Œå»¶è¿Ÿåˆ·ï¼‰&lt;/td&gt;
&lt;td&gt;æ¯æ¬¡æäº¤éƒ½ä»…å†™å…¥åˆ° os buffer ï¼Œç„¶åæ˜¯æ¯ç§’è°ƒç”¨ fsync() å°† os buffer ä¸­çš„æ—¥å¿—å†™å…¥åˆ° redo/undo log file ã€‚&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;&lt;img src=&#34;https://image-static.segmentfault.com/706/634/706634199-04894beff4e7b54f_fix732&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;h4 id=&#34;redo-logè®°å½•å½¢å¼&#34;&gt;redo logè®°å½•å½¢å¼&lt;/h4&gt;
&lt;p&gt;å‰é¢è¯´è¿‡ï¼Œ redo log å®é™…ä¸Šè®°å½•æ•°æ®é¡µçš„å˜æ›´ï¼Œè€Œè¿™ç§å˜æ›´è®°å½•æ˜¯æ²¡å¿…è¦å…¨éƒ¨ä¿å­˜ï¼Œå› æ­¤ redo logå®ç°ä¸Šé‡‡ç”¨äº†å¤§å°å›ºå®šï¼Œå¾ªç¯å†™å…¥çš„æ–¹å¼ï¼Œå½“å†™åˆ°ç»“å°¾æ—¶ï¼Œä¼šå›åˆ°å¼€å¤´å¾ªç¯å†™æ—¥å¿—ã€‚é€šè¿‡&lt;code&gt;show variables like &#39;innodb_log%&#39;; &lt;/code&gt; æŸ¥çœ‹å‚æ•°ï¼›è®°å½•æ–‡ä»¶å½¢å¼å¦‚ä¸‹å›¾ï¼š&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://image-static.segmentfault.com/390/444/3904443652-cc3225d69e1d0476_fix732&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;p&gt;åœ¨innodbå­˜å‚¨å¼•æ“ä¸­ï¼Œæ—¢æœ‰ redo log éœ€è¦åˆ·ç›˜ï¼Œè¿˜æœ‰ æ•°æ®é¡µ ä¹Ÿéœ€è¦åˆ·ç›˜ï¼Œ redo log å­˜åœ¨çš„æ„ä¹‰ä¸»è¦å°±æ˜¯é™ä½å¯¹æ•°æ®é¡µåˆ·ç›˜çš„è¦æ±‚ ã€‚åœ¨ä¸Šå›¾ä¸­ï¼Œ write pos è¡¨ç¤º redo log å½“å‰è®°å½•çš„ LSN (é€»è¾‘åºåˆ—å·)ä½ç½®ï¼Œ check point è¡¨ç¤ºæ•°æ®é¡µæ›´æ”¹è®°å½•åˆ·ç›˜åå¯¹åº” redo log æ‰€å¤„çš„ LSN (é€»è¾‘åºåˆ—å·)ä½ç½®ã€‚ write pos åˆ° check point ä¹‹é—´çš„éƒ¨åˆ†æ˜¯ redo log ç©ºç€çš„éƒ¨åˆ†ï¼Œç”¨äºè®°å½•æ–°çš„è®°å½•ï¼› check point åˆ° write pos ä¹‹é—´æ˜¯ redo log å¾…è½ç›˜çš„æ•°æ®é¡µæ›´æ”¹è®°å½•ã€‚å½“ write pos è¿½ä¸Š check point æ—¶ï¼Œä¼šå…ˆæ¨åŠ¨ check point å‘å‰ç§»åŠ¨ï¼Œç©ºå‡ºä½ç½®å†è®°å½•æ–°çš„æ—¥å¿—ã€‚&lt;/p&gt;
&lt;p&gt;å¯åŠ¨ innodb çš„æ—¶å€™ï¼Œä¸ç®¡ä¸Šæ¬¡æ˜¯æ­£å¸¸å…³é—­è¿˜æ˜¯å¼‚å¸¸å…³é—­ï¼Œæ€»æ˜¯ä¼šè¿›è¡Œæ¢å¤æ“ä½œã€‚å› ä¸º redo log è®°å½•çš„æ˜¯æ•°æ®é¡µçš„ç‰©ç†å˜åŒ–ï¼Œå› æ­¤æ¢å¤çš„æ—¶å€™é€Ÿåº¦æ¯”é€»è¾‘æ—¥å¿—(å¦‚ binlog )è¦å¿«å¾ˆå¤šã€‚ é‡å¯ innodb æ—¶ï¼Œé¦–å…ˆä¼šæ£€æŸ¥ç£ç›˜ä¸­æ•°æ®é¡µçš„ LSN ï¼Œå¦‚æœæ•°æ®é¡µçš„ LSN å°äºæ—¥å¿—ä¸­çš„ LSN ï¼Œåˆ™ä¼šä» checkpoint å¼€å§‹æ¢å¤ã€‚ è¿˜æœ‰ä¸€ç§æƒ…å†µï¼Œåœ¨å®•æœºå‰æ­£å¤„äºcheckpoint çš„åˆ·ç›˜è¿‡ç¨‹ï¼Œä¸”æ•°æ®é¡µçš„åˆ·ç›˜è¿›åº¦è¶…è¿‡äº†æ—¥å¿—é¡µçš„åˆ·ç›˜è¿›åº¦ï¼Œæ­¤æ—¶ä¼šå‡ºç°æ•°æ®é¡µä¸­è®°å½•çš„ LSN å¤§äºæ—¥å¿—ä¸­çš„ LSNï¼Œè¿™æ—¶è¶…å‡ºæ—¥å¿—è¿›åº¦çš„éƒ¨åˆ†å°†ä¸ä¼šé‡åšï¼Œå› ä¸ºè¿™æœ¬èº«å°±è¡¨ç¤ºå·²ç»åšè¿‡çš„äº‹æƒ…ï¼Œæ— éœ€å†é‡åšã€‚&lt;/p&gt;
&lt;p&gt;Mysql8.0 InnoDBå­˜å‚¨å¼•æ“å†™æ“ä½œï¼Œå¯¹redo logçš„å†™æ“ä½œè¿›è¡Œæ— é”å…¨å¼‚æ­¥è®¾è®¡ä¼˜åŒ–ï¼Œå¢åŠ ï¼›å…·ä½“è¯¦ç»†è§å®˜æ–¹æ–‡æ¡£ï¼š&lt;a href=&#34;https://dev.mysql.com/doc/refman/8.0/en/optimizing-innodb-logging.html&#34;&gt;ä¼˜åŒ– InnoDB é‡åšæ—¥å¿—&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&#34;undolog&#34;&gt;undolog&lt;/h3&gt;
&lt;p&gt;æ•°æ®åº“äº‹åŠ¡å››å¤§ç‰¹æ€§ä¸­æœ‰ä¸€ä¸ªæ˜¯ &lt;strong&gt;åŸå­æ€§&lt;/strong&gt; ï¼Œå…·ä½“æ¥è¯´å°±æ˜¯ &lt;strong&gt;åŸå­æ€§æ˜¯æŒ‡å¯¹æ•°æ®åº“çš„ä¸€ç³»åˆ—æ“ä½œï¼Œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ï¼Œä¸å¯èƒ½å‡ºç°éƒ¨åˆ†æˆåŠŸçš„æƒ…å†µ&lt;/strong&gt;ã€‚å®é™…ä¸Šï¼Œ &lt;strong&gt;åŸå­æ€§&lt;/strong&gt; åº•å±‚å°±æ˜¯é€šè¿‡ undo log å®ç°çš„ã€‚ undo log ä¸»è¦è®°å½•äº†æ•°æ®çš„é€»è¾‘å˜åŒ–ï¼Œæ¯”å¦‚ä¸€æ¡  INSERT è¯­å¥ï¼Œå¯¹åº”ä¸€æ¡ DELETE çš„ undo log ï¼Œå¯¹äºæ¯ä¸ª UPDATE è¯­å¥ï¼Œå¯¹åº”ä¸€æ¡ç›¸åçš„ UPDATE çš„undo log ï¼Œè¿™æ ·åœ¨å‘ç”Ÿé”™è¯¯æ—¶ï¼Œå°±èƒ½å›æ»šåˆ°äº‹åŠ¡ä¹‹å‰çš„æ•°æ®çŠ¶æ€ã€‚åŒæ—¶ï¼Œ undo log ä¹Ÿæ˜¯ MVCC (å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶)å®ç°çš„å…³é”®ï¼›é€šè¿‡ &lt;code&gt;show variables like &#39;%undo%&#39;; &lt;/code&gt;æŸ¥çœ‹å‚æ•°ã€‚&lt;/p&gt;
&lt;h3 id=&#34;binlog&#34;&gt;binlog&lt;/h3&gt;
&lt;p&gt;binlog ç”¨äºè®°å½•æ•°æ®åº“æ‰§è¡Œçš„å†™å…¥æ€§æ“ä½œ(ä¸åŒ…æ‹¬æŸ¥è¯¢)ä¿¡æ¯ï¼Œä»¥äºŒè¿›åˆ¶çš„å½¢å¼ä¿å­˜åœ¨ç£ç›˜ä¸­ã€‚ binlog æ˜¯ mysqlçš„é€»è¾‘æ—¥å¿—ï¼Œå¹¶ä¸”ç”± Server å±‚è¿›è¡Œè®°å½•ï¼Œä½¿ç”¨ä»»ä½•å­˜å‚¨å¼•æ“çš„ mysql æ•°æ®åº“éƒ½ä¼šè®°å½• binlog æ—¥å¿—ï¼ˆ&lt;code&gt;log_bin&lt;/code&gt; æ‰“å¼€çš„æƒ…å†µä¸‹ï¼‰ã€‚&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;é€»è¾‘æ—¥å¿—&lt;/strong&gt;ï¼š å¯ä»¥ç®€å•ç†è§£ä¸ºè®°å½•çš„å°±æ˜¯sqlè¯­å¥ ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;ç‰©ç†æ—¥å¿—&lt;/strong&gt;ï¼š mysql æ•°æ®æœ€ç»ˆæ˜¯ä¿å­˜åœ¨æ•°æ®é¡µä¸­çš„ï¼Œç‰©ç†æ—¥å¿—è®°å½•çš„å°±æ˜¯æ•°æ®é¡µå˜æ›´ ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;binlog æ˜¯é€šè¿‡è¿½åŠ çš„æ–¹å¼è¿›è¡Œå†™å…¥çš„ï¼Œå¯ä»¥é€šè¿‡ max_binlog_size å‚æ•°è®¾ç½®æ¯ä¸ª binlogæ–‡ä»¶çš„å¤§å°ï¼Œå½“æ–‡ä»¶å¤§å°è¾¾åˆ°ç»™å®šå€¼ä¹‹åï¼Œä¼šç”Ÿæˆæ–°çš„æ–‡ä»¶æ¥ä¿å­˜æ—¥å¿—ã€‚binlogç›¸å…³å‚æ•°é€šè¿‡&lt;code&gt;show variables like &amp;quot;%binlog%&amp;quot;;&lt;/code&gt; æŸ¥çœ‹ï¼›é€šè¿‡&lt;code&gt;show variables like &amp;quot;%log_bin%&amp;quot;;&lt;/code&gt;æŸ¥çœ‹binlogæ˜¯å¦å¼€å¯,ä»¥åŠbinlogæ—¥å¿—ç›®å½•ï¼Œ8.0ç‰ˆæœ¬é»˜è®¤æ—¶å¼€å¯ã€‚&lt;/p&gt;
&lt;h4 id=&#34;binlogä½¿ç”¨åœºæ™¯&#34;&gt;binlogä½¿ç”¨åœºæ™¯&lt;/h4&gt;
&lt;p&gt;åœ¨å®é™…åº”ç”¨ä¸­ï¼Œ binlog çš„ä¸»è¦ä½¿ç”¨åœºæ™¯æœ‰ä¸¤ä¸ªï¼Œåˆ†åˆ«æ˜¯ &lt;strong&gt;ä¸»ä»å¤åˆ¶&lt;/strong&gt; å’Œ &lt;strong&gt;æ•°æ®æ¢å¤&lt;/strong&gt; ã€‚&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;ä¸»ä»å¤åˆ¶&lt;/strong&gt; ï¼šåœ¨ Master ç«¯å¼€å¯ binlog ï¼Œç„¶åå°† binlog å‘é€åˆ°å„ä¸ª Slave ç«¯ï¼Œ Slave ç«¯é‡æ”¾ binlog ä»è€Œè¾¾åˆ°ä¸»ä»æ•°æ®ä¸€è‡´ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;æ•°æ®æ¢å¤&lt;/strong&gt; ï¼šé€šè¿‡ä½¿ç”¨ mysqlbinlog å·¥å…·æ¥æ¢å¤æ•°æ®ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;h4 id=&#34;binlogåˆ·ç›˜æ—¶æœº&#34;&gt;binlogåˆ·ç›˜æ—¶æœº&lt;/h4&gt;
&lt;p&gt;å¯¹äº InnoDB å­˜å‚¨å¼•æ“è€Œè¨€ï¼Œåªæœ‰åœ¨äº‹åŠ¡æäº¤æ—¶æ‰ä¼šè®°å½• biglog ï¼Œæ­¤æ—¶è®°å½•è¿˜åœ¨å†…å­˜ä¸­ï¼Œé‚£ä¹ˆ biglogæ˜¯ä»€ä¹ˆæ—¶å€™åˆ·åˆ°ç£ç›˜ä¸­çš„å‘¢ï¼Ÿ mysql é€šè¿‡ sync_binlog å‚æ•°æ§åˆ¶ biglog çš„åˆ·ç›˜æ—¶æœºï¼Œå–å€¼èŒƒå›´æ˜¯ 0-Nï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;0ï¼šä¸å»å¼ºåˆ¶è¦æ±‚ï¼Œç”±ç³»ç»Ÿè‡ªè¡Œåˆ¤æ–­ä½•æ—¶å†™å…¥ç£ç›˜ï¼›&lt;/li&gt;
&lt;li&gt;1ï¼šæ¯æ¬¡ commit çš„æ—¶å€™éƒ½è¦å°† binlog å†™å…¥ç£ç›˜ï¼›ä¸€èˆ¬å¼€å¯&lt;/li&gt;
&lt;li&gt;Nï¼šæ¯Nä¸ªäº‹åŠ¡ï¼Œæ‰ä¼šå°† binlog å†™å…¥ç£ç›˜ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;ä»ä¸Šé¢å¯ä»¥çœ‹å‡ºï¼Œ sync_binlog æœ€å®‰å…¨çš„æ˜¯è®¾ç½®æ˜¯ 1 ï¼Œè¿™ä¹Ÿæ˜¯ MySQL 5.7.7ä¹‹åç‰ˆæœ¬çš„é»˜è®¤å€¼ã€‚ä½†æ˜¯è®¾ç½®ä¸€ä¸ªå¤§ä¸€äº›çš„å€¼å¯ä»¥æå‡æ•°æ®åº“æ€§èƒ½ï¼Œå› æ­¤å®é™…æƒ…å†µä¸‹ä¹Ÿå¯ä»¥å°†å€¼é€‚å½“è°ƒå¤§ï¼Œç‰ºç‰²ä¸€å®šçš„ä¸€è‡´æ€§æ¥è·å–æ›´å¥½çš„æ€§èƒ½ã€‚&lt;/p&gt;
&lt;h4 id=&#34;binlogæ—¥å¿—æ ¼å¼&#34;&gt;binlogæ—¥å¿—æ ¼å¼&lt;/h4&gt;
&lt;p&gt;binlog æ—¥å¿—æœ‰ä¸‰ç§æ ¼å¼ï¼Œåˆ†åˆ«ä¸º STATMENT ã€ ROW å’Œ MIXED ã€‚åœ¨ MySQL 5.7.7 ä¹‹å‰ï¼Œé»˜è®¤çš„æ ¼å¼æ˜¯ STATEMENT ï¼Œ MySQL 5.7.7 ä¹‹åï¼Œé»˜è®¤å€¼æ˜¯ ROW ã€‚æ—¥å¿—æ ¼å¼é€šè¿‡ binlog-format æŒ‡å®š; &lt;code&gt;show variables like &amp;quot;%binlog_format%&amp;quot;;&lt;/code&gt;æŸ¥çœ‹&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;STATMENT ï¼š åŸºäº SQL è¯­å¥çš„å¤åˆ¶( statement-based replication, SBR )ï¼Œæ¯ä¸€æ¡ä¼šä¿®æ”¹æ•°æ®çš„sqlè¯­å¥ä¼šè®°å½•åˆ° binlog ä¸­ ã€‚&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ä¼˜ç‚¹ï¼š ä¸éœ€è¦è®°å½•æ¯ä¸€è¡Œçš„å˜åŒ–ï¼Œå‡å°‘äº† binlog  æ—¥å¿—é‡ï¼ŒèŠ‚çº¦äº†  IO  , ä»è€Œæé«˜äº†æ€§èƒ½ï¼›&lt;/li&gt;
&lt;li&gt;ç¼ºç‚¹ï¼š åœ¨æŸäº›æƒ…å†µä¸‹ä¼šå¯¼è‡´ä¸»ä»æ•°æ®ä¸ä¸€è‡´ï¼Œæ¯”å¦‚æ‰§è¡Œæœ¬åœ°æ—¶é—´æ“ä½œï¼› &lt;code&gt;SELECT NOW(),SYSDATE(),SLEEP(3),NOW(),SYSDATE();&lt;/code&gt;ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;ROW ï¼š åŸºäºè¡Œçš„å¤åˆ¶( row-based replication, RBR )ï¼Œä¸è®°å½•æ¯æ¡sqlè¯­å¥çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œä»…éœ€è®°å½•å“ªæ¡æ•°æ®è¢«ä¿®æ”¹äº† ã€‚&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ä¼˜ç‚¹ï¼š ä¸ä¼šå‡ºç°æŸäº›ç‰¹å®šæƒ…å†µä¸‹çš„å­˜å‚¨è¿‡ç¨‹ã€æˆ–functionã€æˆ–triggerçš„è°ƒç”¨å’Œè§¦å‘æ— æ³•è¢«æ­£ç¡®å¤åˆ¶çš„é—®é¢˜ ï¼›&lt;/li&gt;
&lt;li&gt;ç¼ºç‚¹ï¼š ä¼šäº§ç”Ÿå¤§é‡çš„æ—¥å¿—ï¼Œå°¤å…¶æ˜¯ alter table çš„æ—¶å€™ä¼šè®©æ—¥å¿—æš´æ¶¨ï¼›&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;MIXED ï¼š åŸºäº STATMENT å’Œ ROW ä¸¤ç§æ¨¡å¼çš„æ··åˆå¤åˆ¶( mixed-based replication, MBR )ï¼Œä¸€èˆ¬çš„å¤åˆ¶ä½¿ç”¨ STATEMENT æ¨¡å¼ä¿å­˜ binlog ï¼Œå¯¹äº STATEMENT æ¨¡å¼æ— æ³•å¤åˆ¶çš„æ“ä½œä½¿ç”¨ ROW æ¨¡å¼ä¿å­˜ binlogï¼›&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;binlogæ—¥å¿—ä¸»è¦æ˜¯ç”¨æ¥ä¸»ä»åŒæ­¥å¤åˆ¶æ•°æ®ä»¥åŠæ•°æ®æ¢å¤ï¼Œæ˜¯mysql serverå±‚æ‰§è¡Œå™¨è¿›è¡Œæ“ä½œ(ä¸»)å†™å…¥å’Œ(ä»)è¯»å…¥(relaylog)ï¼›&lt;/p&gt;
&lt;p&gt;æ•°æ®å¯ä»¥æŒ‰å¤©æŒ‰å‘¨è¿›è¡Œå¤‡ä»½ï¼Œé¡ºåºå†™å…¥ï¼Œæ²¡æœ‰å¤§å°é™åˆ¶(æ–‡ä»¶å¤§å°æœ‰é™ï¼Œä½†æ˜¯æ•´ä½“æ²¡æœ‰é™åˆ¶ï¼Œå¤šä¸ªæ–‡ä»¶binlog.**å¯ä»¥é€šè¿‡binlog.indexå®šä½)ï¼›&lt;/p&gt;
&lt;h3 id=&#34;redo-logä¸binlogåŒºåˆ«&#34;&gt;redo logä¸binlogåŒºåˆ«&lt;/h3&gt;
&lt;p&gt;ä¸åŒäºredo log, è™½ç„¶ä¸¤è€…éƒ½å¯ä»¥ç”¨æ¥æ¢å¤æ•°æ®ï¼Œä½†æ˜¯åœ¨mysqlä¸­innodbå­˜å‚¨å¼•æ“çš„walæœºåˆ¶ä¸‹ç”Ÿæˆçš„redologæœ‰å¤§å°é™åˆ¶ï¼Œ redo log å®é™…ä¸Šè®°å½•æ•°æ®é¡µçš„å˜æ›´ï¼Œè€Œè¿™ç§å˜æ›´è®°å½•æ˜¯æ²¡å¿…è¦å…¨éƒ¨ä¿å­˜ï¼Œå› æ­¤ redo logå®ç°ä¸Šé‡‡ç”¨äº†å¤§å°å›ºå®šï¼Œå¾ªç¯å†™å…¥çš„æ–¹å¼ï¼Œå½“å†™åˆ°ç»“å°¾æ—¶ï¼Œä¼šå›åˆ°å¼€å¤´å¾ªç¯å†™æ—¥å¿—ï¼›è€Œbinlogä¸»è¦æ˜¯ç”¨æ¥æ•°æ®æ¢å¤ï¼Œå¦‚æœå¤‡ä»½æ—¶é—´é•¿ï¼Œç”¨æˆ·åœ¨æŸæ®µæ—¶é—´æœ‰è¯¯æ“ä½œï¼Œéœ€è¦å›æ»šæ“ä½œï¼Œå°±å¯ä»¥åŒbinlogæ¥æ¢å¤åˆ°æŸä¸ªæ—¶é—´ç‚¹çš„æ—¥å¿—çŠ¶æ€ï¼›å¯¹äºredo logæ˜¯åšä¸åˆ°çš„ï¼›è€Œä¸”binlog ä¸æ˜¯å­˜å‚¨å¼•æ“ç‰¹æœ‰çš„ï¼Œæ‰€ä»¥å¯ä»¥åœ¨ä¸åŒçš„å­˜å‚¨å¼•æ“å…¬ç”¨æ¥æ¢å¤æ•°æ®åœºæ™¯ï¼›åŒºåˆ«å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;&lt;/th&gt;
&lt;th&gt;redo log&lt;/th&gt;
&lt;th&gt;binlog&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;æ–‡ä»¶å¤§å°&lt;/td&gt;
&lt;td&gt;redo log çš„å¤§å°æ˜¯å›ºå®šçš„ã€‚&lt;/td&gt;
&lt;td&gt;binlog å¯é€šè¿‡é…ç½®å‚æ•° max_binlog_size è®¾ç½®æ¯ä¸ª binlog æ–‡ä»¶çš„å¤§å°ã€‚&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;å®ç°æ–¹å¼&lt;/td&gt;
&lt;td&gt;redo log æ˜¯ InnoDB å¼•æ“å±‚å®ç°çš„ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰å¼•æ“éƒ½æœ‰ã€‚&lt;/td&gt;
&lt;td&gt;binlog æ˜¯ Server å±‚å®ç°çš„ï¼ŒMySQL 3.23.14 ä¸­å¼•å…¥çš„ï¼Œæ‰€æœ‰å¼•æ“éƒ½å¯ä»¥ä½¿ç”¨ binlog æ—¥å¿—ï¼ŒæœåŠ¡å™¨è¿è¡ŒæœŸé—´ç”Ÿæˆçš„æœåŠ¡å™¨å…¨å±€çŠ¶æ€æ›´æ”¹çš„è·Ÿè¸ªæ—¥å¿—&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;è®°å½•æ–¹å¼&lt;/td&gt;
&lt;td&gt;redo log é‡‡ç”¨å¾ªç¯å†™çš„æ–¹å¼è®°å½•ï¼Œå½“å†™åˆ°ç»“å°¾æ—¶ï¼Œä¼šå›åˆ°å¼€å¤´å¾ªç¯å†™æ—¥å¿—ã€‚&lt;/td&gt;
&lt;td&gt;binlogé€šè¿‡è¿½åŠ çš„æ–¹å¼è®°å½•ï¼Œå½“æ–‡ä»¶å¤§å°å¤§äºç»™å®šå€¼åï¼Œåç»­çš„æ—¥å¿—ä¼šè®°å½•åˆ°æ–°çš„æ–‡ä»¶ä¸Š&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;é€‚ç”¨åœºæ™¯&lt;/td&gt;
&lt;td&gt;redo log é€‚ç”¨äºå´©æºƒæ¢å¤(crash-safe)ï¼Œé‡å¯æ¢å¤çš„æ—¶å€™ï¼Œé€šè¿‡check pointå’Œwrite pos æ¥æ¢å¤æ•°æ®&lt;/td&gt;
&lt;td&gt;binlog é€‚ç”¨äºä¸»ä»å¤åˆ¶å’Œæ•°æ®æ¢å¤ï¼ŒæŸä¸ªæ—¶é—´ç‚¹çš„æ“ä½œè®°å½•å½’æ¡£ï¼Œå¯ä»¥æŒ‰æ—¶é—´ç‚¹è¿›è¡Œæ¢å¤ï¼›ä»¥åŠä¸»ä»ä¹‹é—´çš„å¤åˆ¶é‡æ”¾, å®ç°é«˜å¯ç”¨çš„åŸºç¡€ï¼Œä»¥åŠè®¢é˜…binlogè¿›è¡Œä¸åŒåˆ†å¸ƒå¼å­˜å‚¨æ•°æ®çš„åŒæ­¥&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;ç”± binlog å’Œ redo log çš„åŒºåˆ«å¯çŸ¥ï¼šå› ä¸ºmysql æ—©æœŸè‡ªå¸¦çš„MyISAMå­˜å‚¨å¼•æ“è®¾è®¡ç”¨ binlog æ—¥å¿—åªç”¨äºå½’æ¡£ï¼Œè¿›è¡Œæ•°æ®æ¢å¤ï¼Œåªä¾é  binlog æ˜¯æ²¡æœ‰ crash-safe èƒ½åŠ›çš„ã€‚innodbå­˜å‚¨å¼•æ“å¼•å…¥mysqlä¹‹åï¼Œå¼•å…¥redo/undo logæ–‡ä»¶æ¥æ”¯æŒäº‹åŠ¡æŒä¹…æ€§å’ŒåŸå­æ€§æ¥ä¿è¯å†™å…¥æ•°æ®çš„ä¸€è‡´æ€§ï¼›ä½†åªæœ‰ redo log ä¹Ÿä¸è¡Œï¼Œå› ä¸º redo log æ˜¯ InnoDB ç‰¹æœ‰çš„ï¼Œå¾ªç¯å†™å…¥ï¼Œæ— æ³•è¿˜åŸä¸åœ¨è¿™ä¸ªredo logä¸­çš„è®°å½•ï¼Œæ¯”å¦‚ä»æœåŠ¡å¯åŠ¨æˆ–è€…è®°å½•æ•°æ®è½åå¾ˆå¤š(é™¤éæ˜¯shared storageæ¶æ„æœºåˆ¶çš„äº‘å‚å•†æ•°æ®åº“ï¼Œåƒ&lt;a href=&#34;https://www.allthingsdistributed.com/files/p1041-verbitski.pdf&#34;&gt;Aurora&lt;/a&gt;,&lt;a href=&#34;https://www.vldb.org/pvldb/vol11/p1849-cao.pdf&#34;&gt;PolarDB&lt;/a&gt;)ï¼›å› æ­¤éœ€è¦ binlog å’Œ redo logäºŒè€…åŒæ—¶è®°å½•ï¼Œæ‰èƒ½ä¿è¯å½“æ•°æ®åº“å‘ç”Ÿè¯¯åˆ æˆ–è€…å®•æœºé‡å¯æ—¶ï¼Œæ•°æ®ä¸ä¼šä¸¢å¤±ã€‚&lt;/p&gt;
&lt;h3 id=&#34;ä¸¤é˜¶æ®µæäº¤&#34;&gt;ä¸¤é˜¶æ®µæäº¤&lt;/h3&gt;
&lt;p&gt;ä¸ºäº†ä¿è¯å†™å…¥ä¸¤ä»½æ—¥å¿—redo log, binlog æœ€ç»ˆæ¢å¤æ•°æ®æ˜¯ä¸€è‡´çš„ï¼Œé‡‡ç”¨&lt;a href=&#34;https://en.wikipedia.org/wiki/Two-phase_commit_protocol&#34;&gt;ä¸¤é˜¶æ®µæäº¤(2pc)&lt;/a&gt;çš„æœºåˆ¶(XA,å†…éƒ¨/å…¨å±€äº‹åŠ¡ innodbæä¾›ä¸€æ ·çš„æ“ä½œ)ï¼Œmysql server æ‰§è¡Œå™¨ åœ¨è°ƒç”¨innodbå­˜å‚¨å¼•æ“æ¥å£è¿›è¡Œå†™æ“ä½œçš„æ—¶å€™ï¼Œèµ·åˆ°ä¸€ä¸ªäº‹åŠ¡åè°ƒè€…çš„ä½œç”¨,é€šè¿‡TC_LOG(Transaction Coordinator Log)åŸºç±»å®šä¹‰äº†äº‹åŠ¡æ—¥å¿—éœ€è¦å®ç°çš„æ¥å£: open, prepare, commit, rollback, closeï¼›å®ç°è¿™äº›æ¥å£çš„ç±»ï¼šTC_LOG_DUMMY(disable the logging), TC_LOG_MMAP(mmap logging), MYSQL_BIN_LOG(binlog)ï¼›ä¸»è¦æ˜¯æ˜¯æŸ¥çœ‹MYSQL_BIN_LOGç±»ä¸­&lt;a href=&#34;https://github.com/mysql/mysql-server/blob/8.0/sql/binlog.cc#L7881&#34;&gt;prepare&lt;/a&gt; å’Œ &lt;a href=&#34;https://github.com/mysql/mysql-server/blob/8.0/sql/binlog.cc#L7934&#34;&gt;commit&lt;/a&gt; çš„å®ç°ï¼›prepare å’Œ commitæœ€ç»ˆä¼šè°ƒç”¨å­˜å‚¨å¼•æ“åˆå§‹åŒ–æ—¶æŒ‡å‘çš„handlertonå¯¹è±¡å¯¹åº”å‡½æ•°ï¼›ï¼ˆè¿™ç§æ¥å£éš”ç¦»çš„å¸¸ç”¨è®¾è®¡ï¼Œå°†è°ƒç”¨æ–¹å’Œå®ç°æ–¹è¿›è¡Œè§£è€¦ï¼Œæ ¹æ®å‚æ•°é…ç½®æ¥ç»‘å®šå®ç°æ–¹ï¼Œè¿è¡Œæ—¶åŠ¨æ€è°ƒç”¨ï¼‰&lt;/p&gt;
&lt;p&gt;mysqlæ˜¯ä»¥pluginçš„æ–¹å¼ç®¡ç†å­˜å‚¨å¼•æ“ï¼Œreplication(ä¸»ä»å‰¯æœ¬åŒæ­¥)æ’ä»¶å’Œå…¶ä»–æ’ä»¶ï¼ˆé€šè¿‡&lt;code&gt;SHOW PLUGINS;&lt;/code&gt;æŸ¥çœ‹)ï¼›å…·ä½“çš„æ’ä»¶ä»£ç åœ¨&lt;a href=&#34;https://github.com/mysql/mysql-server/tree/8.0/plugin&#34;&gt;plugin&lt;/a&gt;æ–‡ä»¶ä¸­ï¼Œç®€å•çš„æ’ä»¶ç¤ºä¾‹&lt;a href=&#34;https://github.com/mysql/mysql-server/tree/8.0/plugin/rewrite_example&#34;&gt;rewrite_example&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;mysqld å¯åŠ¨æ—¶é€šè¿‡é…ç½®åˆå§‹çš„å­˜å‚¨å¼•æ“(é»˜è®¤innodb)ï¼Œè°ƒç”¨&lt;a href=&#34;https://github.com/mysql/mysql-server/blob/8.0/sql/mysqld.cc#L5815&#34;&gt;init_server_components&lt;/a&gt; è°ƒç”¨innodbå­˜å‚¨å¼•æ“çš„æ¥å£è¿›è¡Œåˆå§‹åŒ–ha_handler, åœ¨&lt;a href=&#34;https://github.com/mysql/mysql-server/blob/8.0/storage/innobase/handler/ha_innodb.cc#L4935&#34;&gt;innodb_init&lt;/a&gt;ä¸­è¿›è¡Œåˆå§‹åŒ–, æ¯”å¦‚åˆ·ç›˜æ“ä½œ innobase_hton-&amp;gt;flush_logs = innobase_flush_logs; ç„¶ååœ¨sql/handlerä¸­å®šä¹‰çš„ç›¸å…³æ¥å£è°ƒç”¨, æ¯”å¦‚&lt;a href=&#34;https://github.com/mysql/mysql-server/blob/8.0/sql/handler.cc#L2459&#34;&gt;ha_flush_logs&lt;/a&gt;ã€‚&lt;/p&gt;
&lt;p&gt;å®‰è£…replicationæ’ä»¶æ—¶ä¼šæ³¨å†Œæ’ä»¶ä¸­ç›¸åº”çš„æ–¹æ³•åŠ å…¥observer åˆ—è¡¨ä¸­ï¼Œè¿è¡Œè§¦å‘çš„æ—¶å€™ä»¥AOPçš„æ–¹å¼RUN_HOOK æ‰«æobserveråˆ—è¡¨Observer_info-&amp;gt;observerè°ƒç”¨å¯¹åº”æ’ä»¶å‡½æ•°ï¼›replicationæ’ä»¶éœ€è¦å®ç°ä»¥ä¸‹&lt;a href=&#34;https://github.com/mysql/mysql-server/blob/8.0/sql/replication.h&#34;&gt;replicationæ–‡ä»¶ä¸­&lt;/a&gt;ç›¸å…³ç»“æ„ä½“çš„æ–¹æ³•(æ¥å£) æ‰èƒ½åŠ è½½ï¼š&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-fallback&#34; data-lang=&#34;fallback&#34;&gt;struct Trans_observer /* Observes and extends transaction execution */
struct Server_state_observer /* Observer server state */
struct Binlog_transmit_observer /* Observe and extends the binlog dumping thread. */
struct Binlog_relay_IO_observer /* Observes and extends the service of slave IO thread. */
struct Binlog_storage_observer /* Observe binlog logging storage */
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;è¿™é‡Œä¼šæœ‰å„ç§æ—¥å¿—çš„åˆ·æ–°æœºåˆ¶ï¼Œå¯ä»¥é€šè¿‡&lt;code&gt;show variables like &#39;%innodb%flush%&#39;; show variables like &#39;sync_binlog&#39;;&lt;/code&gt;è·å–å¯¹åº”çš„å‚æ•°ï¼Œå¯ä»¥å»å®˜ç½‘&lt;a href=&#34;https://dev.mysql.com/doc/refman/8.0/en/server-option-variable-reference.html&#34;&gt;Server Option, System Variable, and Status Variable Reference&lt;/a&gt; æŸ¥æ‰¾å¯¹åº”çš„è¯¦æƒ…è¿›è¡Œé…ç½®ä¼˜åŒ–ï¼›&lt;/p&gt;
&lt;p&gt;å½“å¼€å¯binlogæ—¶, MySQLé»˜è®¤ä½¿ç”¨è¯¥éšå¼XAæ¨¡å¼ï¼Œå¼€å¯è‡ªåŠ¨æäº¤äº‹åŠ¡autocommitã€‚äº‹åŠ¡çš„æäº¤æµç¨‹ç›¸å¯¹æ¯”è¾ƒå¤æ‚ï¼Œæ‰§è¡Œç®€å•çš„updateæ“ä½œï¼Œç®€è¿°å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;0. æ‰§è¡Œå™¨æ•°æ®è·å–ä¿®æ”¹ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;æ‰§è¡Œå™¨è°ƒç”¨innodbå­˜å‚¨å¼•æ“æ¥å£è·å–æ»¡è¶³æ¡ä»¶çš„æ•°æ®ï¼Œé€šè¿‡æ ‘ç´¢å¼•æŸ¥æ‰¾/å…¨è¡¨æŸ¥æ‰¾ï¼Œ å¦‚æœæ•°æ®åœ¨buffer poolä¸­æŸ¥æ‰¾åˆ°ï¼Œè¿”å›æ•°æ®ï¼›å¦åˆ™ä»ç£ç›˜è¡¨ç©ºé—´æ–‡ä»¶ä¸­è¯»å–æ•°æ®pageåˆ°buffer pool  clean pageä¸­ï¼Œè¿”å›æ•°æ®ï¼›æ— æ•°æ®ï¼Œæµç¨‹ç»ˆæ­¢è¿”å›ï¼›&lt;/li&gt;
&lt;li&gt;æ‰§è¡Œå™¨ä¿®æ”¹æ‰¾åˆ°çš„æ•°æ®ï¼Œå°†ä¿®æ”¹çš„æ•°æ® è°ƒç”¨innodbå­˜å‚¨å¼•æ“æ¥å£å†™å…¥æ–°æ•°æ®ï¼Œè¿›è¡Œä¸¤é˜¶æ®µæäº¤ï¼›&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;äº‹åŠ¡çš„æäº¤è¿‡ç¨‹å…¥å£ç‚¹ä½äº &lt;a href=&#34;https://github.com/mysql/mysql-server/blob/8.0/sql/handler.cc#L1592&#34;&gt;ha_commit_trans&lt;/a&gt;å‡½æ•°ï¼Œä»¥mysql binlog ä¸ºäº‹åŠ¡2pcåè°ƒè€…ä¸ºä¾‹ï¼Œäº‹åŠ¡æäº¤çš„è¿‡ç¨‹å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;1. mysql bin log äº‹åŠ¡2pcåè°ƒè€… å¤„ç† å‡†å¤‡prepareé˜¶æ®µ&lt;/strong&gt;ï¼š(tc_log-&amp;gt;prepare)&lt;/p&gt;
&lt;p&gt;MYSQL_BIN_LOG::prepare(THD *thd, bool all)  è®¾ç½® thd-&amp;gt;durability_property = HA_IGNORE_DURABILITY; ç”¨äºåœ¨å­˜å‚¨å¼•æ“å‡†å¤‡é˜¶æ®µä¸åˆ·æ–°äº‹åŠ¡æ—¥å¿—redo/undo log åˆ°ç£ç›˜æ—¥å¿—æ–‡ä»¶ä¸­ï¼›&lt;/p&gt;
&lt;p&gt;è°ƒç”¨æµç¨‹ï¼šha_prepare_low â†’ innobase_xa_prepare â†’ trx_prepare_for_mysql â†’   &lt;a href=&#34;https://github.com/mysql/mysql-server/blob/8.0/storage/innobase/trx/trx0trx.cc#L2919&#34;&gt;static void trx_prepare(trx_t *trx)&lt;/a&gt;   â†’ trx_prepare_low â†’ trx_undo_set_state_at_prepare&lt;/p&gt;
&lt;ol start=&#34;3&#34;&gt;
&lt;li&gt;
&lt;p&gt;æ‰§è¡Œå™¨è°ƒç”¨innodbå­˜å‚¨å¼•æ“æ¥å£è¿›è¡Œä¿®æ”¹æ“ä½œï¼Œé¦–å…ˆå†™å…¥æ•°æ®çš„æ—§å€¼è‡³undo log bufferä¸­ï¼Œæ›´æ–°InnoDBçš„undoå›æ»šæ®µï¼Œå°†å…¶è®¾ç½®ä¸ºPrepareçŠ¶æ€ï¼ˆ&lt;code&gt;TRX_UNDO_PREPARED&lt;/code&gt;ï¼‰å†™å…¥mlogä¸­ï¼Œè¿”å› redo log çš„LSN,&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;æ›´æ–°buffer poolä¸­çš„æ•°æ®(å¦‚æœæ’å…¥éœ€è¦ä»free(free list)å˜æˆclean page(lru list)ï¼Œfree list ä¸å¤Ÿæ—¶éœ€è¦ä»flush istæˆ–è€…lru listæ·˜æ±°ä¸€å®šçš„pageå˜æˆfree page åŠ å…¥free list); ä¿®æ”¹çš„clean page(lru list)å˜æˆ dirty page(lru list)(æ›´æ–°çš„æ•°æ®é¡µåœ¨ç¼“å­˜ä¸­ï¼Œè¿˜æœªåˆ·ç›˜)ï¼›dirty pageå†™å…¥flush listï¼› ä¸ºäº†æé«˜å†™æ€§èƒ½å¼‚æ­¥çº¿ç¨‹åˆ·ç›˜(åˆ·ç›˜æ—¶æœºå¯ä»¥åœ¨commitä¹‹åï¼›MySQL 5.7å¼•å…¥äº†page cleanerçº¿ç¨‹)&lt;/p&gt;
&lt;p&gt;Tips: åœ¨flush listä¸Šçš„é¡µé¢ä¸€å®šåœ¨lru Listä¸Šï¼Œä½†æ˜¯åä¹‹åˆ™ä¸æˆç«‹ã€‚ä¸€ä¸ªæ•°æ®é¡µå¯èƒ½ä¼šåœ¨ä¸åŒçš„æ—¶åˆ»è¢«ä¿®æ”¹å¤šæ¬¡ï¼Œåœ¨æ•°æ®é¡µä¸Šè®°å½•äº†æœ€è€(ä¹Ÿå°±æ˜¯ç¬¬ä¸€æ¬¡)çš„ä¸€æ¬¡ä¿®æ”¹çš„LSNï¼Œå³oldest_modificationã€‚ä¸åŒæ•°æ®é¡µæœ‰ä¸åŒçš„oldest_modificationï¼Œflush listä¸­çš„èŠ‚ç‚¹æŒ‰ç…§oldest_modificationæ’åºï¼Œé“¾è¡¨å°¾æ˜¯æœ€å°çš„ï¼Œä¹Ÿå°±æ˜¯æœ€æ—©è¢«ä¿®æ”¹çš„æ•°æ®é¡µï¼Œå½“éœ€è¦ä»flush listä¸­æ·˜æ±°é¡µé¢æ—¶å€™ï¼Œä»é“¾è¡¨å°¾éƒ¨å¼€å§‹æ·˜æ±°ã€‚åŠ å…¥flush listï¼Œéœ€è¦ä½¿ç”¨flush_list_mutexä¿æŠ¤ï¼Œæ‰€ä»¥èƒ½ä¿è¯flush listä¸­èŠ‚ç‚¹çš„é¡ºåºã€‚&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;åŒæ—¶å°†æ•°æ®é¡µçš„ä¿®æ”¹è®°å½•LSNå†™å…¥redo log bufferä¸­ï¼Œå‡†å¤‡æäº¤äº‹åŠ¡ï¼Œæ­¤æ—¶ redo log å¤„äº prepare çŠ¶æ€ï¼Œå¦‚æœthd-&amp;gt;durability_property = HA_IGNORE_DURABILITY, å°†&lt;code&gt;LSN&lt;/code&gt; å†™å…¥redo log ç£ç›˜æ–‡ä»¶ä¸­ï¼›åŸå­åŒ–æ“ä½œ&lt;code&gt;trx_t&lt;/code&gt; äº‹åŠ¡çŠ¶æ€ä¸º PREPARED (ç”¨äºäº‹åŠ¡éš”ç¦»æ“ä½œ)ï¼› å°†&lt;code&gt;gtid_desc&lt;/code&gt;å†™å…¥undolog è¡¨ç©ºé—´ä¸­ï¼›ç„¶åå‘ŠçŸ¥æ‰§è¡Œå™¨æ‰§è¡Œå®Œæˆäº†ï¼Œéšæ—¶å¯ä»¥æäº¤äº‹åŠ¡ã€‚&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Tips: è¿™é‡Œä¼šå‡ºç°redo log fileå†™æ»¡çš„æƒ…å†µï¼Œbuffer å†™å…¥ä¼šhangä½ï¼ŒMySQLå°±ä¼šåœä¸‹æ‰‹å¤´çš„ä»»åŠ¡ï¼Œå…ˆæŠŠè„é¡µåˆ·åˆ°ç£ç›˜é‡Œï¼Œæ‰èƒ½ç»§ç»­å¹²æ´»ï¼Œä¼šå¯¼è‡´MySQLçš„æœåŠ¡å™¨çš„tpsæœ‰æ˜æ˜¾çš„æ³¢åŠ¨ï¼› é»˜è®¤å¼€å¯äº†innodb_adaptive_flushing ç®—æ³•è¿›è¡Œä¼˜åŒ–ï¼Œåœ¨redo log fileè¿˜æ²¡æœ‰æ»¡çš„æ—¶å€™ï¼Œä¼šæ ¹æ®redo log fileç”Ÿæˆçš„é€Ÿåº¦å’Œåˆ·æ–°é¢‘ç‡æ¥å°†redo log fileä¸­çš„è„é¡µåˆ·å…¥ç£ç›˜è¡¨ç©ºé—´æ–‡ä»¶ä¸­ï¼›&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;2. mysql binlog äº‹åŠ¡2pcåè°ƒè€… å¤„ç† æäº¤commité˜¶æ®µï¼š&lt;/strong&gt;(tc_log-&amp;gt;commit)&lt;/p&gt;
&lt;p&gt;è°ƒç”¨æµç¨‹ï¼šTC_LOG::enum_result MYSQL_BIN_LOG::commit(THD *thd, bool all) â†’&lt;a href=&#34;https://github.com/mysql/mysql-server/blob/8.0/sql/binlog.cc#L8717&#34;&gt;int MYSQL_BIN_LOG::ordered_commit(THD *thd, bool all, bool skip_commit)&lt;/a&gt;  , å¦‚æœæ²¡æœ‰å¼€å¯log_binï¼Œæ²¡æœ‰bin logæ–‡ä»¶ï¼Œç›´æ¥è·³è‡³commité˜¶æ®µï¼›&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;ç»„æäº¤&lt;/strong&gt; (æµç¨‹è§ä»£ç ä¸­ä»‹ç» &lt;a href=&#34;https://github.com/mysql/mysql-server/blob/8.0/sql/binlog.h#L568-L641&#34;&gt;ordered_commit&lt;/a&gt; )ï¼šç»„æäº¤ç¬¬ä¸€çœ¼çœ‹ç€æœ‰ç‚¹æ‡µé€¼ï¼Œå¯ä»¥ç»“åˆè¿™ç‰‡æ–‡ç«  &lt;a href=&#34;https://developer.aliyun.com/article/617776&#34;&gt;[å›¾è§£MySQL]MySQLç»„æäº¤(group commit)&lt;/a&gt; äº†è§£ï¼›ä¸»è¦æ˜¯ä¸ºäº†æå‡äº‹åŠ¡ååé‡è®¾è®¡çš„æ–¹æ¡ˆ(&lt;strong&gt;åŸåˆ™ï¼šå°½é‡å‡å°‘ç£ç›˜IO, åˆ©ç”¨æŒä¹…ç›˜çš„ç‰¹æ€§é¡ºåºå†™&lt;/strong&gt;)ï¼›å¦‚åŒæœ¨æ¡¶æ•ˆåº”ä¸€æ ·ï¼Œredo log å’Œ binlog ä¸¤è€…å…¶ä¸­æœ‰ä¸€ä¸ªæ²¡æœ‰ç»„æäº¤ï¼Œéƒ½ä¼šé™ä½äº‹åŠ¡ååé‡ï¼Œæ‰€ä»¥æœ€å¥½çš„æ–¹å¼redo log å’Œ binlog ä¸¤è€…éƒ½ç»„é˜Ÿæäº¤; mysqlè®¾è®¡è€…å°†ç»„æäº¤ä»flushé˜¶æ®µå¼€å§‹ä¼˜åŒ–ï¼Œå°†å…¶åˆ†ä¸ºå‡ ä¸ªé˜¶æ®µï¼š flush é˜¶æ®µã€sync é˜¶æ®µã€(replicationå¤åˆ¶é˜¶æ®µ) ã€commit é˜¶æ®µï¼›å…¶ä¸­replicationå¤åˆ¶é˜¶æ®µä»¥HOOKçš„æ–¹å¼åŠ¨æ€è¿è¡Œå¯¹äºçš„replicationå¤åˆ¶ç­–ç•¥ï¼Œé»˜è®¤æ˜¯å¼‚æ­¥å¤åˆ¶ã€‚&lt;/p&gt;
&lt;p&gt;&lt;code&gt;binlog_order_commits&lt;/code&gt;å‚æ•°æ§åˆ¶innodb commité¡ºåºå’Œbinlogå†™å…¥é¡ºåºæ˜¯å¦ä¸€è‡´ï¼Œé»˜è®¤å¯ç”¨ä¿è¯é¡ºåºä¸€è‡´ï¼Œæ–¹ä¾¿å¤‡ä»½å’Œå¿«é€Ÿæ¢å¤ï¼›å’Œbinlogç»„æäº¤é…åˆä½¿ç”¨ï¼Œè¿™ä¸ªå‚æ•°æ¥è‡ªå®˜ç½‘çš„ä»‹ç»ï¼š&lt;/p&gt;
&lt;p&gt;å½“åœ¨å¤åˆ¶æºæœåŠ¡å™¨ä¸Šå¯ç”¨æ­¤å˜é‡æ—¶ï¼ˆè¿™æ˜¯é»˜è®¤è®¾ç½®ï¼‰ï¼Œå‘é€ç»™å­˜å‚¨å¼•æ“çš„äº‹åŠ¡æäº¤æŒ‡ä»¤åœ¨å•ä¸ªleaderçº¿ç¨‹ä¸Šè¢«åºåˆ—åŒ–ï¼Œå› æ­¤äº‹åŠ¡æ€»æ˜¯æŒ‰ç…§å†™å…¥binlogçš„ç›¸åŒé¡ºåºæäº¤ã€‚ç¦ç”¨æ­¤å˜é‡å…è®¸ä½¿ç”¨å¤šä¸ªçº¿ç¨‹å‘å‡ºäº‹åŠ¡æäº¤æŒ‡ä»¤ã€‚ä¸binlogç»„æäº¤ç»“åˆä½¿ç”¨ï¼Œè¿™å¯ä»¥é˜²æ­¢å•ä¸ªäº‹åŠ¡çš„æäº¤ç‡æˆä¸ºååé‡çš„ç“¶é¢ˆï¼Œå› æ­¤å¯èƒ½ä¼šäº§ç”Ÿæ€§èƒ½æ”¹è¿›ã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Flushé˜¶æ®µï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;è°ƒç”¨æµç¨‹ï¼šTC_LOG::enum_result MYSQL_BIN_LOG::commit(THD *thd, bool all) â†’&lt;a href=&#34;&#34;&gt;int MYSQL_BIN_LOG::ordered_commit(THD *thd, bool all, bool skip_commit)&lt;/a&gt;  â†’  &lt;a href=&#34;https://github.com/mysql/mysql-server/blob/8.0/sql/binlog.cc#L8301&#34;&gt;int MYSQL_BIN_LOG::process_flush_stage_queue&lt;/a&gt; ;&lt;/p&gt;
&lt;p&gt;RUN_HOOK å»è·å–åŠ è½½çš„æ’ä»¶ï¼Œrpl handler Binlog_storage_delegate::after_flush FOREACH_OBSERVERå® éå†observeråˆ—è¡¨Observer_info-&amp;gt;observerè°ƒç”¨å¯¹åº”replicationæ’ä»¶å‡½æ•°&lt;/p&gt;
&lt;p&gt;æœ€ç»ˆè°ƒç”¨&lt;a href=&#34;https://github.com/mysql/mysql-server/blob/8.0/storage/innobase/os/os0file.cc#L2847&#34;&gt;os_file_fsync_posix&lt;/a&gt; flush redolog to disk ; æ ¹æ®ä¸åŒçš„æ“ä½œç³»ç»Ÿæ¥è°ƒç”¨ï¼Œunixæ“ä½œç³»ç»Ÿè°ƒç”¨fsync/fdatasyncå‡½æ•°åˆ·ç›˜, fsyncä¼šç¡®ä¿OS cacheä¸­çš„æ•°æ®ç›´åˆ°å†™ç£ç›˜æ“ä½œç»“æŸæ‰ä¼šè¿”å›ï¼Œå¹¶ä¸”å†™å…¥å…ƒæ•°æ®ï¼Œè€Œfdatasyncä¸ä¼š; å¦‚æœæƒ³ä¸èµ°OS cacheç›´æ¥å†™ç£ç›˜ï¼Œå¯¹æ‰“å¼€/åˆ›å»ºçš„æ–‡ä»¶å¥æŸ„åŠ ä¸ŠO_DIRECTå±æ€§ï¼Œä¸€èˆ¬ç”¨äºå†™ç³»ç»Ÿè¡¨ç©ºé—´æ•°æ®è½ç›˜ï¼›&lt;/p&gt;
&lt;p&gt;æ­¤æ—¶process_flush_stage_queueå¤„ç†ä¼šå½¢æˆä¸€ç»„é˜Ÿåˆ—ï¼Œç”±ç»„leader(ä¸€ä¸ªç»„ä¸­æœ€æ—©å¼€å§‹çš„äº‹åŠ¡)ä¾æ¬¡ä¸ºåˆ«çš„çº¿ç¨‹å†™binlogæ–‡ä»¶ åœ¨å‡†å¤‡å†™binlogå‰ï¼Œä¼šå…ˆè°ƒç”¨ha_flush_logs -&amp;gt; innobase_flush_logsæ¥å£ï¼Œå°†å­˜å‚¨çš„æ—¥å¿—å†™åˆ°æœ€æ–°çš„LSNï¼›ç„¶åå†å†™binlogåˆ°æ–‡ä»¶; è¿™æ ·åšçš„ç›®çš„æ˜¯ä¸ºäº†æå‡ç»„æäº¤çš„æ•ˆç‡ã€‚&lt;/p&gt;
&lt;ol start=&#34;6&#34;&gt;
&lt;li&gt;æ‰§è¡Œå™¨ è°ƒç”¨innodbå­˜å‚¨å¼•æ“innobase_flush_logs-&amp;gt;log_flush_low-&amp;gt;redo_space_flush-&amp;gt;os_file_flush-&amp;gt;&lt;a href=&#34;https://github.com/mysql/mysql-server/blob/8.0/storage/innobase/os/os0file.cc#L2847&#34;&gt;os_file_fsync_posix&lt;/a&gt; æ¥å£ å°† redo/undo log bufferä¸­çš„æ•°æ®å†™å…¥redo/undo log file ç£ç›˜ä¸­ï¼›&lt;/li&gt;
&lt;li&gt;æ‰§è¡Œå™¨ è°ƒç”¨ MYSQL_BIN_LOG::flush_thread_caches å°† thread caches binlogç¼“å†²æ•°æ®  å†™å…¥ bin log(xid,GTID)ä¸­(è¿˜æœªåˆ·ç›˜),é€šè¿‡ &lt;code&gt;show variables like &#39;%binlog_cache%&#39;;&lt;/code&gt;æŸ¥çœ‹ç¼“å†²å¤§å°ï¼› å¹¶ä¸”è®¾ç½®å¥½äº‹åŠ¡çš„å†™å…¥ä½ç½®m_trans_end_posï¼Œå½“äº‹åŠ¡æäº¤commité˜¶æ®µçš„æ—¶å€™ï¼Œç›´æ¥è·å–ä½ç½®æäº¤ï¼›&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;strong&gt;Sync_binlogé˜¶æ®µï¼š&lt;/strong&gt; &lt;a href=&#34;https://github.com/mysql/mysql-server/blob/8.0/sql/binlog.cc#L8506&#34;&gt;std::pair&amp;lt;bool, bool&amp;gt; MYSQL_BIN_LOG::sync_binlog_file(bool force)&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;RUN_HOOK å»è·å–åŠ è½½çš„æ’ä»¶ï¼Œrpl handler Binlog_storage_delegate::after_sync FOREACH_OBSERVERå®éå†observeråˆ—è¡¨Observer_info-&amp;gt;observerè°ƒç”¨å¯¹åº”replicationæ’ä»¶å‡½æ•°ï¼›&lt;/p&gt;
&lt;p&gt;æœ€ç»ˆè°ƒç”¨ &lt;a href=&#34;https://github.com/mysql/mysql-server/blob/8.0/mysys/my_sync.cc#L84&#34;&gt;int my_sync(File fd, myf my_flags)&lt;/a&gt;  Sync binlog data in file to disk&lt;/p&gt;
&lt;p&gt;å¦‚æœ&lt;code&gt;sync_binlog&lt;/code&gt;è®¡æ•°è¶…è¿‡é…ç½®å€¼ï¼Œåˆ™è¿›è¡Œä¸€æ¬¡æ–‡ä»¶fsyncï¼Œn&amp;gt;1 å¼€å¯ç»„æäº¤ï¼Œå‚æ•°&lt;code&gt;sync_binlog&lt;/code&gt;çš„å«ä¹‰ä¸æ˜¯æŒ‡çš„è¿™ä¹ˆå¤šä¸ªäº‹åŠ¡ä¹‹ååšä¸€æ¬¡fsyncï¼Œè€Œæ˜¯å¤šä¸ªäº‹åŠ¡ä¸€ç»„ä¹‹ååšä¸€æ¬¡fsyncï¼Œ&lt;code&gt;binlog_group_commit_sync_delay&lt;/code&gt;,&lt;code&gt;binlog_group_commit_sync_no_delay_count&lt;/code&gt; è¿™äº›å‚æ•°è§å®˜ç½‘æ–‡æ¡£ï¼›&lt;/p&gt;
&lt;ol start=&#34;8&#34;&gt;
&lt;li&gt;å¼€å§‹ç”Ÿæˆè¿™ä¸ªæ—¶é—´ç‚¹çš„é€»è¾‘æ“ä½œæ—¥å¿—æ ¼å¼ï¼Œé€šè¿‡&lt;code&gt;sync_binlog&lt;/code&gt; flushç­–ç•¥å¼‚æ­¥å°†thead cachesä¸­çš„æ•°æ®æ‰¹é‡å†™å…¥åˆ°ç£ç›˜binlogæ–‡ä»¶binlog.**/binlog.indexä¸­ï¼› é€šè¿‡ &lt;code&gt;show binlog events;&lt;/code&gt;æ¥æŸ¥çœ‹binlogæ–‡ä»¶ç›¸å…³çš„ä¿¡æ¯ï¼Œä¹Ÿå¯ä»¥å¯¹å•ä¸ªæ–‡ä»¶æŸ¥çœ‹ï¼›&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;strong&gt;Async/Semisync/Group å¼‚æ­¥/åŠåŒæ­¥/ç»„å¤åˆ¶é˜¶æ®µï¼š&lt;/strong&gt; (å†™æ“ä½œéƒ½åœ¨ä¸»ä¸Š)&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;å¼‚æ­¥å¤åˆ¶&lt;/strong&gt;ï¼šä¸»åº“åœ¨è®°å½•å®Œbinlogï¼Œæ‰§è¡Œå®Œè‡ªå·±çš„äº‹åŠ¡ä¹‹åå°±ä¼šç›´æ¥è¿”å›ï¼Œmysqlä¸»ä»æ¨¡å¼é»˜è®¤æ˜¯å¼‚æ­¥å¤åˆ¶ï¼›å¼‚æ­¥å¤åˆ¶æµç¨‹å¦‚ä¸‹å›¾ï¼š&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://dev.mysql.com/doc/refman/8.0/en/images/async-replication-diagram.png&#34; alt=&#34;async-replication-diagram&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;åŠåŒæ­¥å¤åˆ¶&lt;/strong&gt;ï¼šä¸»çš„äº‹åŠ¡éœ€è¦ç­‰ä¸€å°ä»åŒæ­¥binlogæ—¥å¿—æäº¤åˆ°Relay Logä¸­(sync_relay=1)ï¼Œè¿”å›ackï¼Œä¸»åº“æäº¤äº‹åŠ¡ï¼›åŠåŒæ­¥æµç¨‹å¦‚ä¸‹å›¾ï¼š&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://dev.mysql.com/doc/refman/8.0/en/images/semisync-replication-diagram.png&#34; alt=&#34;semisync-replication-diagram&#34;&gt;&lt;/p&gt;
&lt;p&gt;ä»MySQL5.5å¼€å§‹ ä»¥æ’ä»¶çš„å½¢å¼æ”¯æŒåŠåŒæ­¥å¤åˆ¶ï¼›å¦‚æœéœ€è¦æ”¯æŒï¼Œä¸»ä»éƒ½éœ€è¦å®‰è£…åŠåŒæ­¥æ’ä»¶åº“ï¼›å¯¹åº”çš„ä»£ç åœ¨&lt;a href=&#34;https://github.com/mysql/mysql-server/tree/8.0/plugin/semisync&#34;&gt;plugin/semisync&lt;/a&gt;æ–‡ä»¶å¤¹ä¸­ã€‚&lt;/p&gt;
&lt;p&gt;ä¸» &lt;code&gt;install plugin rpl_semi_sync_master soname &#39;semisync_master.so&#39;;&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;ä» &lt;code&gt;install plugin rpl_semi_sync_slave soname &#39;semisync_slave.so&#39;;&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;å¹¶ä¸”æ‰“å¼€åŠåŒæ­¥å¤åˆ¶ï¼Œ&lt;code&gt;set global rpl_semi_sync_master_enabled=1;&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;å…¶ä¸­é€šè¿‡å‚æ•°&lt;code&gt;rpl_semi_sync_master_wait_point&lt;/code&gt;æ¥å†³å®šä»€ä¹ˆæ—¶å€™æäº¤äº‹åŠ¡ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;after_sync&lt;/strong&gt; ä¸»åº“å…ˆä¸æäº¤äº‹åŠ¡ï¼Œç­‰å¾…æŸä¸€ä¸ªä»åº“è¿”å›äº†ç»“æœä¹‹åï¼Œå†æäº¤äº‹åŠ¡ï¼Œåœ¨è¿”å›ç»“æ„é€šçŸ¥å®¢æˆ·ç«¯ã€‚è¿™æ ·ä¸€æ¥ï¼Œå¦‚æœä»åº“åœ¨æ²¡æœ‰ä»»ä½•è¿”å›çš„æƒ…å†µä¸‹å®•æœºäº†ï¼Œmasterè¿™è¾¹ä¹Ÿæ— æ³•æäº¤äº‹åŠ¡ã€‚ä¸»ä»ä»ç„¶æ˜¯ä¸€è‡´çš„ï¼Œmysql5.7ä¹‹åé»˜è®¤å€¼ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;after_commit&lt;/strong&gt; ä¸»åº“å…ˆæäº¤äº‹åŠ¡ï¼Œç­‰å¾…ä»åº“è¿”å›ç»“æœå†é€šçŸ¥å®¢æˆ·ç«¯ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;ç»„å¤åˆ¶&lt;/strong&gt;ï¼šåŸºäºåŸç”Ÿå¤åˆ¶åŠ paxos åè®®ï¼Œæä¾›ä¸€è‡´æ•°æ®å®‰å…¨ä¿è¯ï¼Œä¸€ç§å¯ç”¨äºå®ç°å®¹é”™ç³»ç»Ÿçš„æŠ€æœ¯ï¼›å…·ä½“è¯¦æƒ…è§å®˜æ–¹æ–‡æ¡£ï¼š&lt;a href=&#34;https://dev.mysql.com/doc/refman/8.0/en/group-replication.html&#34;&gt;MySQL8.0 Group Replication&lt;/a&gt;ï¼›ç»„å¤åˆ¶æµç¨‹å¦‚ä¸‹å›¾ï¼š&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://dev.mysql.com/doc/refman/8.0/en/images/gr-replication-diagram.png&#34; alt=&#34;gr-replication-diagram&#34;&gt;&lt;/p&gt;
&lt;p&gt;MySQL 5.7.17ç‰ˆæœ¬ä¸­å¼•å…¥MySQL ç»„å¤åˆ¶ï¼ŒåŒæ ·ä¹Ÿæ˜¯ä»¥æ’ä»¶çš„å½¢å¼æ”¯æŒ; å¯¹åº”çš„ä»£ç åœ¨&lt;a href=&#34;https://github.com/mysql/mysql-server/tree/8.0/plugin/group_replication&#34;&gt;plugin/group_replication&lt;/a&gt;æ–‡ä»¶å¤¹ä¸­ã€‚ä¸€ç»„å‰¯æœ¬æœºå™¨å®‰è£…æ’ä»¶éƒ½æ˜¯&lt;code&gt;INSTALL PLUGIN group_replication SONAME &#39;group_replication.so&#39;;&lt;/code&gt;&lt;/p&gt;
&lt;ol start=&#34;8&#34;&gt;
&lt;li&gt;å¦‚æœå¼€å¯çš„ä¸»ä»å¤åˆ¶(é»˜è®¤å¼‚æ­¥)1:nï¼Œä¸»åº“ä¼šç­‰å¾…ä»åº“I/Oçº¿ç¨‹å»ºç«‹è¿æ¥ä¹‹åï¼Œåˆ›å»ºbinlog dumpçº¿ç¨‹ï¼Œé€šçŸ¥slaveæœ‰æ•°æ®æ›´æ–°ï¼Œå½“I/Oçº¿ç¨‹è¯·æ±‚æ—¥å¿—å†…å®¹æ—¶ï¼Œä¼šå°†æ­¤æ—¶çš„binlogåç§°å’Œå½“å‰æ›´æ–°çš„ä½ç½®posåŒæ—¶ä¼ ç»™slaveçš„I/Oçº¿ç¨‹, æŠŠbinlog eventå‘é€ç»™ä»åº“I/Oçº¿ç¨‹ï¼Œä»åº“I/Oçº¿ç¨‹è·å–åˆ°binlog eventä¹‹åå°†å…¶å†™å…¥åˆ°è‡ªå·±çš„Relay Logä¸­ï¼Œç„¶åä»åº“å¯åŠ¨SQLçº¿ç¨‹ï¼Œå°†Relayä¸­çš„æ•°æ®è¿›è¡Œé‡æ”¾ï¼Œå®Œæˆä»åº“çš„æ•°æ®æ›´æ–°ï¼›ä¸ºäº†ä¿è¯ä¸é‡å¤æ›´æ–°ï¼Œbinlog/relaylog ä¸­è®°å½•äº†GTIDï¼ˆmysql5.6åŠ å…¥ï¼‰, å…¨å±€å”¯ä¸€, å¦‚æœrelaylogä¸­å·²æœ‰GTID, åˆ™æ‰§è¡ŒGTIDè‡ªåŠ¨è·³è¿‡ï¼Œæ„å‘³ç€åœ¨æºä¸Šæäº¤çš„äº‹åŠ¡åªèƒ½åœ¨å‰¯æœ¬ä¸Šåº”ç”¨ä¸€æ¬¡ï¼Œè¿™æœ‰åŠ©äºä¿è¯ä¸€è‡´æ€§;&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;å¦å¤–å¦‚æœä¸»ä»å¤åˆ¶è¿‡ç¨‹çªç„¶ä¸­æ–­äº†ï¼Œæˆ–è€…ä¸»ä»åˆ‡æ¢äº†ï¼Œé‡å¯ä¹‹åå‘ç°SQLçº¿ç¨‹å®é™…æ‰§è¡Œåˆ°ä½ç½®å’Œæ•°æ®åº“è®°å½•çš„ä¸ä¸€è‡´ï¼›mysql5.6ä¹‹åå°†å¤åˆ¶çš„è¿›åº¦æ”¾åœ¨ç³»ç»Ÿçš„&lt;code&gt;mysql.slave_relay_log_info&lt;/code&gt;innodbè¡¨é‡Œï¼Œå¹¶ä¸”æŠŠæ›´æ–°è¿›åº¦ã€SQLçº¿ç¨‹æ‰§è¡Œç”¨æˆ·äº‹åŠ¡ç»‘å®šæˆä¸€ä¸ªäº‹åŠ¡æ‰§è¡Œã€‚å³ä½¿å®•æœºäº†ï¼Œå¯ä»¥é€šè¿‡MySQLå†…å»ºçš„å´©æºƒæ¢å¤æœºåˆ¶æ¥ä½¿å®é™…æ‰§è¡Œçš„ä½ç½®å’Œæ•°æ®åº“ä¿å­˜çš„è¿›åº¦æ¢å¤åˆ°ä¸€è‡´ã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Commité˜¶æ®µ:&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;è°ƒç”¨æµç¨‹ï¼šint MYSQL_BIN_LOG::finish_commit(THD *thd) -&amp;gt; ha_commit_low -&amp;gt; innobase_commit -&amp;gt; &lt;a href=&#34;https://github.com/mysql/mysql-server/blob/8.0/storage/innobase/trx/trx0trx.cc#L2199&#34;&gt;void trx_commit(trx_t *trx)&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;RUN_HOOK å»è·å–åŠ è½½çš„æ’ä»¶ï¼Œrpl handler Trans_delegate::after_commit  FOREACH_OBSERVERå®éå†observeråˆ—è¡¨Observer_info-&amp;gt;observerè°ƒç”¨å¯¹åº”replicationæ’ä»¶å‡½æ•°ï¼›&lt;/p&gt;
&lt;ol start=&#34;9&#34;&gt;
&lt;li&gt;
&lt;p&gt;åªæœ‰binlogå†™å…¥ç£ç›˜æˆåŠŸä¹‹åï¼Œæ‰§è¡Œå™¨æ‰ä¼šè°ƒç”¨innodbå­˜å‚¨å¼•æ“æ¥å£ï¼Œä»é˜Ÿåˆ—ä¸­è·å–äº‹åŠ¡ç»„ä¾æ¬¡è¿›è¡Œinnodb commit æäº¤é‡Šæ”¾äº‹åŠ¡ï¼Œå°†redo logä¸­å·²ç»prepareçš„äº‹åŠ¡æäº¤å†™å…¥commitæ ‡è®°ï¼Œå¹¶ä¸”å†™å…¥binlogä½ç‚¹ï¼›æœ€åè°ƒç”¨MYSQL_BIN_LOG::rotate æ˜¯å¦åˆ‡æ¢binlogæ–‡ä»¶(åœ¨åˆ‡æ¢æ–‡ä»¶æœŸé—´ï¼Œä½¿ç”¨ä¸€ä¸ªé˜²æ­¢æ–°çš„æäº¤ç»„æ‰§è¡Œåˆ·æ–°é˜¶æ®µçš„é”ï¼Œå¹¶ç­‰å¾…ç›´åˆ°å‡†å¤‡å¥½çš„äº‹åŠ¡çš„è®¡æ•°å™¨å˜ä¸º0ï¼Œç„¶åæ‰åˆ›å»ºæ–°æ–‡ä»¶)ï¼Œå¦‚æœåˆ‡æˆæ–°æ–‡ä»¶ï¼Œ è°ƒç”¨MYSQL_BIN_LOG::purge()åˆ·ç›˜ï¼›ç»“æŸordered_commit ç»„æäº¤æµç¨‹,è¿”å›æäº¤ï¼›&lt;/p&gt;
&lt;p&gt;Tips: Commité˜¶æ®µä¸ç”¨åˆ·ç›˜ï¼ŒFlushé˜¶æ®µä¸­çš„redo logåˆ·ç›˜å·²ç»è¶³å¤Ÿä¿è¯æ•°æ®åº“å´©æºƒæ—¶çš„æ•°æ®å®‰å…¨äº†; Commité˜¶æ®µé˜Ÿåˆ—çš„ä½œç”¨æ˜¯æ‰¿æ¥Syncé˜¶æ®µçš„äº‹åŠ¡ï¼Œå®Œæˆæœ€åçš„å¼•æ“æäº¤ï¼Œä½¿å¾—Syncå¯ä»¥å°½æ—©çš„å¤„ç†ä¸‹ä¸€ç»„äº‹åŠ¡ï¼Œæœ€å¤§åŒ–ç»„æäº¤çš„æ•ˆç‡ã€‚&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h4 id=&#34;æ•´ä½“æ›´æ–°æµç¨‹&#34;&gt;æ•´ä½“æ›´æ–°æµç¨‹ï¼š&lt;/h4&gt;
&lt;p&gt;&lt;img src=&#34;https://raw.githubusercontent.com/weedge/mypic/master/mysql-innodb-w.drawio.png&#34; alt=&#34;mysql-innodb-w&#34;&gt;&lt;/p&gt;
&lt;h3 id=&#34;å´©æºƒæ¢å¤&#34;&gt;å´©æºƒæ¢å¤&lt;/h3&gt;
&lt;p&gt;æ›´æ–°æµç¨‹ä¸­å†™å…¥redo logçš„è¿‡ç¨‹æ‹†æˆäº†ä¸¤ä¸ªæ­¥éª¤prepareå’Œcommit ä¸¤ä¸ªé˜¶æ®µï¼›å¦‚æœä¸ä½¿ç”¨ä¸¤é˜¶æ®µæäº¤ï¼Œæ•°æ®åº“çš„çŠ¶æ€å°±æœ‰å¯èƒ½å’Œç”¨å®ƒçš„æ—¥å¿—æ¢å¤å‡ºæ¥çš„åº“çš„çŠ¶æ€ä¸ä¸€è‡´ã€‚åœ¨å´©æºƒæ¢å¤ä¸­ï¼Œ&lt;!-- raw HTML omitted --&gt;æ˜¯ä»¥ binlog ä¸­çš„ xid å’Œ redolog ä¸­çš„ xid è¿›è¡Œæ¯”è¾ƒï¼Œxid åœ¨ binlog é‡Œå­˜åœ¨åˆ™æäº¤ï¼Œä¸å­˜åœ¨åˆ™å›æ»šï¼Œä»¥åŠåˆ¤æ–­redo logä¸­æ˜¯å¦æœ‰commitæ ‡è¯†&lt;!-- raw HTML omitted --&gt;ï¼›å´©æºƒæ¢å¤æ—¶å…·ä½“çš„æƒ…å†µ:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;binlogæ— è®°å½•ï¼Œredologæ— è®°å½•ï¼šåœ¨redologå†™ä¹‹å‰crash, æ— prepareçŠ¶æ€ï¼Œæ— undo log è®°å½•ï¼Œæ¢å¤æ“ä½œï¼šæ— ï¼Œæ— éœ€å…³å¿ƒï¼›&lt;/li&gt;
&lt;li&gt;binlogæ— è®°å½•ï¼Œredologæ— è®°å½•ï¼šåœ¨redologå†™ä¹‹å‰crash, æ— prepareçŠ¶æ€ï¼Œæœ‰undo log è®°å½•ï¼Œæ¢å¤æ“ä½œï¼šé€šè¿‡undo logå›æ»šäº‹åŠ¡ï¼›&lt;/li&gt;
&lt;li&gt;binlogæœ‰è®°å½•ï¼Œredologæœ‰è®°å½•ï¼šredologçŠ¶æ€prepareï¼Œ åˆ™åˆ¤æ–­å¯¹åº”çš„äº‹åŠ¡æ˜¯å¦å­˜åœ¨å®Œæ•´çš„binlogï¼Œæ¢å¤æ“ä½œï¼šå¦‚æœæ˜¯, åˆ™æäº¤äº‹åŠ¡ï¼Œå¦åˆ™, é€šè¿‡undo logå›æ»šäº‹åŠ¡;&lt;/li&gt;
&lt;li&gt;å¦‚æœredo logé‡Œé¢çš„äº‹åŠ¡æ˜¯å®Œæ•´çš„, ä¹Ÿå°±æ˜¯æœ‰äº†commitæ ‡è¯†, æ¢å¤æ“ä½œï¼šç›´æ¥æäº¤äº‹åŠ¡ï¼›&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&#34;æ€»ç»“&#34;&gt;æ€»ç»“&lt;/h2&gt;
&lt;p&gt;å¯¹äºéœ€è¦æŒä¹…åŒ–çš„æ•°æ®åº“ç³»ç»Ÿï¼Œé¿å…ä¸äº†äº‹åŠ¡åœ¨å¤„ç†è¿‡ç¨‹ä¸­ï¼Œçªç„¶ä¸­æ–­çš„æƒ…å†µï¼›WALé€šè¿‡é¢„å†™æ—¥å¿—çš„æ–¹å¼åœ¨äº‹åŠ¡æäº¤ä¹‹å‰ï¼Œéœ€è¦æŠŠä¿®æ”¹é‡æ”¾è®°å½•å’Œæ’¤é”€è¯¦ç»†è®°å½•å†™å…¥æ—¥å¿—æ–‡ä»¶ä¸­ï¼Œä»¥ä¾¿åœ¨æ•…éšœåæ¢å¤æ•°æ®ï¼›äº‹åŠ¡å¼€å§‹åï¼Œæ‰€æœ‰å¯¹æ•°æ®åº“çš„ä¿®æ”¹åœ¨å‘é€åˆ°ç¼“å†²æ± ä¹‹å‰éƒ½è¢«è®°å½•åœ¨å†…å­˜ä¸­çš„WALç¼“å†²åŒºä¸­ï¼›äº‹åŠ¡æäº¤ä¹‹å‰ï¼Œå¿…é¡»æŠŠWALç¼“å†²åŒºåˆ·æ–°åˆ°ç£ç›˜ã€‚mysql innodbå­˜å‚¨å¼•æ“å¼•å…¥redo/undo logæ–‡ä»¶æ¥æ”¯æŒäº‹åŠ¡æŒä¹…æ€§å’ŒåŸå­æ€§ï¼Œç”±äºmysql binlogç”¨æ¥å½’æ¡£æ•°æ®è®°å½•æ¢å¤å’Œå¤åˆ¶ï¼Œä¸ºäº†ä¿è¯å†™å…¥ä¸¤ä»½æ—¥å¿—redo log, binlog æœ€ç»ˆæ¢å¤æ•°æ®æ˜¯ä¸€è‡´çš„ï¼Œé‡‡ç”¨ä¸¤é˜¶æ®µæäº¤æœºåˆ¶ï¼Œé€šè¿‡æºç äº†è§£äº†äº›æ•´ä½“WALçš„å®ç°ï¼›ä»¥åŠå´©æºƒæ—¶å€™éœ€è¦ç”¨æ—¥å¿—è¿›è¡Œæ¢å¤ã€‚(å…¶ä»–æŒä¹…åŒ–å­˜å‚¨ç³»ç»Ÿçš„WALå®ç°ï¼Œå¾…ç»­)&lt;/p&gt;
&lt;h2 id=&#34;references&#34;&gt;references&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;&lt;a href=&#34;https://en.wikipedia.org/wiki/Write-ahead_logging&#34;&gt;Write-ahead_logging&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://en.wikipedia.org/wiki/Algorithms_for_Recovery_and_Isolation_Exploiting_Semantics&#34;&gt;ARIES:Algorithms_for_Recovery_and_Isolation_Exploiting_Semantics&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://cs.stanford.edu/people/chrismre/cs345/rl/aries.pdf&#34;&gt;aries.pdf&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/OceanBase-Partner/lectures-on-dbms-implementation/blob/main/lecture-6.md#642-%E7%BC%93%E5%86%B2%E6%B1%A0%E7%AE%A1%E7%90%86%E7%AD%96%E7%95%A5&#34;&gt;ç¼“å†²æ± ç®¡ç†ç­–ç•¥&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://mesl.ucsd.edu/pubs/SOSP2013-MARS.pdf&#34;&gt;From ARIES to MARS: Transaction Support for Next-Generation, Solid-State Drives.pdf&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://repository.bilkent.edu.tr/bitstream/handle/11693/37609/Implications%20of%20non-volatile%20memory%20as%20primary%20storage%20for%20database%20management%20systems.pdf&#34;&gt;Implications of Non-Volatile Memory as Primary Storage for Database Management Systems.pdf&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://infoscience.epfl.ch/record/170505/files/aether-smpfulltext.pdf&#34;&gt;Scalability of write-ahead logging on multicore and multisocket hardware.pdf&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://www.vldb.org/pvldb/vol10/p337-arulraj.pdf&#34;&gt;WBL.pdf&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://www.youtube.com/watch?v=S9nctHdkggk&#34;&gt;ARIES Overview, Types of Log Records, ARIES Helper Structures&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://www.youtube.com/watch?v=4VGkRXVM5fk&#34;&gt;ARIES Database Recovery (CMU Databases Systems / Fall 2019)&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://dev.mysql.com/doc/internals/en/binary-log.html&#34;&gt;mysql binary-log&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://mysql.taobao.org/monthly/2021/10/01/&#34;&gt;MySQL Â· å¼•æ“ç‰¹æ€§ Â· åº–ä¸è§£InnoDBä¹‹UNDO LOG&lt;/a&gt;  &lt;a href=&#34;http://catkang.github.io/2020/02/27/mysql-redo.html&#34;&gt;åº–ä¸è§£InnoDBä¹‹REDO LOG&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://mysql.taobao.org/monthly/2020/05/09/&#34;&gt;MySQL Â· å¼•æ“ç‰¹æ€§ Â· åŸºäºGTIDå¤åˆ¶å®ç°çš„å·¥ä½œåŸç†&lt;/a&gt;  &lt;a href=&#34;http://mysql.taobao.org/monthly/2020/05/07/&#34;&gt;MySQL Â· æºç åˆ†æ Â· å†…éƒ¨ XA å’Œç»„æäº¤&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://time.geekbang.org/column/article/73161&#34;&gt;æ—¥å¿—å’Œç´¢å¼•ç›¸å…³é—®é¢˜&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://developer.aliyun.com/article/617776&#34;&gt;[å›¾è§£MySQL]MySQLç»„æäº¤(group commit)&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://mysql.taobao.org/monthly/2018/07/01/&#34;&gt;MySQL Â· å¼•æ“ç‰¹æ€§ Â· WALé‚£äº›äº‹å„¿&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://zhuanlan.zhihu.com/p/372300181&#34;&gt;æ— å¤„ä¸åœ¨çš„ MySQL XA äº‹åŠ¡&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://dev.mysql.com/doc/refman/8.0/en/server-option-variable-reference.html&#34;&gt;Server Option, System Variable, and Status Variable Reference&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://icyfenix.cn/architect-perspective/general-architecture/transaction/local.html&#34;&gt;å‡¤å‡°æ¶æ„-æœ¬åœ°äº‹åŠ¡&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;</description>
      
    </item>
    
  </channel>
</rss>
