<!DOCTYPE html>
<html lang="zh-cn" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>设计-配置平台 - 时间飘过</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="weedge" />
  <meta name="description" content="介绍 业务服务在启动时加载配置，配置分为静态配置和动态配置，静态配置如服务监听的端口，日志路径，访问依赖服务单元不同云(region / zone) 域名地址等；动态配置包括业务配置，流程管理配置，策略配置等；静态配置服务启动之后不会更改，而动态配置在服务启动运行时可以动态热加载；将配置的内容和版本进行分离，关注配置的管理而无需关注配置的内容，配置内容用户可以自定义配置内容，使用json-schema进行校验，提供自定义配置内容json给后台ui前端进行单个整体配置的交互，配置后台只需加载json-schema进行校验提交内容，json-schema由用户上传提供地址即可。
" />

  <meta name="keywords" content="工作, 技术, 生活" />






<meta name="generator" content="Hugo 0.88.1" />


<link rel="canonical" href="https://weedge.github.io/post/conf/" />





<link rel="icon" href="/favicon.ico" />











<link rel="stylesheet" href="/sass/jane.min.fa4b2b9f31b5c6d0b683db81157a9226e17b06e61911791ab547242a4a0556f2.css" integrity="sha256-&#43;ksrnzG1xtC2g9uBFXqSJuF7BuYZEXkatUckKkoFVvI=" media="screen" crossorigin="anonymous">





<meta property="og:title" content="设计-配置平台" />
<meta property="og:description" content="介绍
业务服务在启动时加载配置，配置分为静态配置和动态配置，静态配置如服务监听的端口，日志路径，访问依赖服务单元不同云(region / zone) 域名地址等；动态配置包括业务配置，流程管理配置，策略配置等；静态配置服务启动之后不会更改，而动态配置在服务启动运行时可以动态热加载；将配置的内容和版本进行分离，关注配置的管理而无需关注配置的内容，配置内容用户可以自定义配置内容，使用json-schema进行校验，提供自定义配置内容json给后台ui前端进行单个整体配置的交互，配置后台只需加载json-schema进行校验提交内容，json-schema由用户上传提供地址即可。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://weedge.github.io/post/conf/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-11-18T10:26:23+08:00" />
<meta property="article:modified_time" content="2021-11-18T10:26:23+08:00" />

<meta itemprop="name" content="设计-配置平台">
<meta itemprop="description" content="介绍
业务服务在启动时加载配置，配置分为静态配置和动态配置，静态配置如服务监听的端口，日志路径，访问依赖服务单元不同云(region / zone) 域名地址等；动态配置包括业务配置，流程管理配置，策略配置等；静态配置服务启动之后不会更改，而动态配置在服务启动运行时可以动态热加载；将配置的内容和版本进行分离，关注配置的管理而无需关注配置的内容，配置内容用户可以自定义配置内容，使用json-schema进行校验，提供自定义配置内容json给后台ui前端进行单个整体配置的交互，配置后台只需加载json-schema进行校验提交内容，json-schema由用户上传提供地址即可。"><meta itemprop="datePublished" content="2021-11-18T10:26:23+08:00" />
<meta itemprop="dateModified" content="2021-11-18T10:26:23+08:00" />
<meta itemprop="wordCount" content="4444">
<meta itemprop="keywords" content="design,conf," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="设计-配置平台"/>
<meta name="twitter:description" content="介绍
业务服务在启动时加载配置，配置分为静态配置和动态配置，静态配置如服务监听的端口，日志路径，访问依赖服务单元不同云(region / zone) 域名地址等；动态配置包括业务配置，流程管理配置，策略配置等；静态配置服务启动之后不会更改，而动态配置在服务启动运行时可以动态热加载；将配置的内容和版本进行分离，关注配置的管理而无需关注配置的内容，配置内容用户可以自定义配置内容，使用json-schema进行校验，提供自定义配置内容json给后台ui前端进行单个整体配置的交互，配置后台只需加载json-schema进行校验提交内容，json-schema由用户上传提供地址即可。"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->




</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">时间飘过</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://weedge.github.io/">主页</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://weedge.github.io/post/">归档</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://weedge.github.io/tags/">标签</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://weedge.github.io/categories/">分类</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://weedge.github.io/about/">About</a>
          
        
      </li>
    

    
  </ul>
</nav>


  
    






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

  

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      时间飘过
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://weedge.github.io/">主页</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://weedge.github.io/post/">归档</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://weedge.github.io/tags/">标签</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://weedge.github.io/categories/">分类</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://weedge.github.io/about/">About</a>
          

        

      </li>
    

    
    

    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">设计-配置平台</h1>
      
      <div class="post-meta">
        <time datetime="2021-11-18" class="post-time">
          2021-11-18
        </time>
        <div class="post-category">
            <a href="https://weedge.github.io/categories/%E6%8A%80%E6%9C%AF/"> 技术 </a>
            
          </div>
        

        
        

        
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#介绍">介绍</a></li>
        <li><a href="#目标">目标</a></li>
        <li><a href="#功能">功能</a></li>
        <li><a href="#整体交互框架">整体交互框架</a></li>
        <li><a href="#数据库核心动态配置表设计">数据库核心动态配置表设计</a></li>
        <li><a href="#场景模拟">场景模拟</a></li>
        <li><a href="#接口">接口</a></li>
        <li><a href="#施工">施工</a></li>
        <li><a href="#总结">总结</a></li>
        <li><a href="#qa">Q&amp;A</a></li>
        <li><a href="#references">references</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      <h3 id="介绍">介绍</h3>
<p>业务服务在启动时加载配置，配置分为静态配置和动态配置，静态配置如服务监听的端口，日志路径，访问依赖服务单元不同云(region / zone) 域名地址等；动态配置包括业务配置，流程管理配置，策略配置等；静态配置服务启动之后不会更改，而动态配置在服务启动运行时可以动态热加载；将配置的内容和版本进行分离，关注配置的管理而无需关注配置的内容，配置内容用户可以自定义配置内容，使用json-schema进行校验，提供自定义配置内容json给后台ui前端进行单个整体配置的交互，配置后台只需加载json-schema进行校验提交内容，json-schema由用户上传提供地址即可。</p>
<h3 id="目标">目标</h3>
<p>通过配置后台，业务服务流程可控，可配置，可视化，隔离已有业务场景配置，提高人效；</p>
<h3 id="功能">功能</h3>
<h4 id="后台基础功能">后台基础功能</h4>
<ol>
<li>后台管理发布生产环境的动态配置，包括新增，修改，审核，发布，回滚等功能；</li>
<li>多人发布的时候，检查当前的版本是否已经发布，并进行版本diff;</li>
<li>配置是服务接口维度进行操作管理， 以服务粒度进行整体发布；</li>
<li>提供获取当前已发布的服务配置接口，用于订阅端拉取；</li>
<li>提供RBAC权限管理;</li>
</ol>
<h4 id="动态配置热加载功能">动态配置热加载功能</h4>
<p><strong>业务服务配置获取方案：</strong></p>
<ol>
<li>服务配置修改发布，通过发布/订阅模式(Pub-Sub Pattern)通知业务服务进行加载；可用组件为支持pub/sub命令的redis协议kv服务，或者通过get(mget)/set(mset) incr(seq)命令进行模拟实现；</li>
<li>服务配置修改发布，通过观察者模式(Observer Pattern) watch机制通知业务服务进行实时加载；可以使用etcdv3的watch机制实现;</li>
</ol>
<p>两种方案都可以，看是否有对应的高可用组件服务支持；如果都有，建议使用etcdv3(client 3.4+)的watch机制，通过长链接来通知变更事件。</p>
<p><strong>加载方式有两种实现方案：</strong></p>
<ol>
<li>
<p>通过部署单独agent进程来获取配置进行解析写入指定配置路径文件中(重启时)和共享内存中(运行时)，先写文件，成功了，在写共享内存；然后由业务服务读取；</p>
<p>优点：方便单独维护，无需业务方关心，只需关心加载配置的路径在后台维护，以及共享内存中的配置结构；</p>
<p>缺点：多了一次进程之间的交互；业务方代码中需要有读取共享内存的逻辑考虑；</p>
</li>
<li>
<p>提供配置加载lib库，由业务方启动逻辑代码中调用；将获取配置进行解析写入指定配置路径文件中，加载到业务进程配置结构中使用即可；</p>
<p>优点：业务方直接调用lib库中的方法，无需关心加载逻辑；</p>
<p>缺点：假如业务方是不同的语言编写，需要提供不同语言版本的lib库方法；</p>
</li>
</ol>
<p>总体来说，2种方案都可行，如果统一技术栈，比如使用golang进行开发，可以选用第二种方案；</p>
<p>但是这样就可以了么？还有业务集群配置一致性需要考虑到，比如业务集群某台机器突然抽风，未加载最新的配置，打到这台机器的请求和其他正常加载配置的机器的请求逻辑会有所不同，导致整体服务接口不是幂等的，会出现不一致的情况；可以借鉴一下 <a href="https://github.com/XiaoMi/Gaea/blob/master/docs/config-reloading.md">gaea配置热加载设计与实现</a>；</p>
<p><strong>配置一致性方案：</strong></p>
<p>通过两阶段提交的方式，由业务服务侧提供prepare接口和commit接口；</p>
<p>准备阶段：conf-dashboard模块发布的时候获取业务服务的ip列表并发调用每个业务服务ip的prepare接口，开始触发业务服务本地配置的更新流程，首先通过conf-dashboard模块获取最新版本和当前版本比较，如果相同就无需比较了，否则从获取配置接口获取配置进行更新；更新流程不是直接替换线上正在使用的文件，而是生成一个准备文件进行提交时替换；每个prepare接口同步调用返回结果都ok了，进入下一步提交阶段，如果其中一个返回失败，发布失败，展现失败详情；</p>
<p>提交阶段：prepare成功后；conf-dashboard模块继续并发调用的commit接口，开始文件替换，加载至缓存配置结构中；这个操作比较快，都提交成功之后，发布成功，否则发布失败，展现失败详情；</p>
<p>失败处理：如果某台机器发布失败，可以排查下具体原因之后(原因应尽量在prepare和commit接口中详细给出)，看是否跳过继续发布还是会滚，重复发布不影响，有md5和版本比较；</p>
<p>tips: 如果发布机器很多，并发力度根据conf-dashboard模块部署机器接口负载，可以自适应调整降低；</p>
<p><strong>兜底检查更新方案：</strong></p>
<p>配置发布成功后，调用业务服务机器的meta接口获取最新更新文件信息，进行兜底检查确认；</p>
<p>业务服务开启兜底定时任务获取从con-dashboard获取配置版本，配置信息进行兜底更新, 每隔10～30分钟执行一次；</p>
<p>tips: 请求conf-dashboard获取配置信息的接口随机打散，防止并发流量对conf-dashboard模块的影响；</p>
<p>定时任务流程图如下：</p>
<p><img src="https://raw.githubusercontent.com/weedge/mypic/master/confmg.drawio.png" alt="cron-confmg"></p>
<h3 id="整体交互框架">整体交互框架</h3>
<p><img src="https://raw.githubusercontent.com/weedge/mypic/master/config-arch.drawio.png" alt="config-arch"></p>
<h3 id="数据库核心动态配置表设计">数据库核心动态配置表设计</h3>
<p>当前服务版本和当前conf版本是1对多的场景，而历史服务快照版本和历史conf快照版本是多对多的场景；</p>
<p>如图所示：</p>
<p><img src="https://raw.githubusercontent.com/weedge/mypic/master/config-version.png" alt="config-version"></p>
<p>服务类型枚举表 service_type</p>
<table>
<thead>
<tr>
<th>枚举值</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>无</td>
</tr>
</tbody>
</table>
<p>配置类型枚举表 conf_type</p>
<table>
<thead>
<tr>
<th>枚举值</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>无</td>
</tr>
</tbody>
</table>
<p>枚举值由配置平台统一分配管理</p>
<p>当前服务版本表 tb_service_cur_ver</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>类型</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>id</td>
<td>bigint</td>
<td>主键</td>
</tr>
<tr>
<td>service_type</td>
<td>tinyint</td>
<td>服务类型 比如：0.无 1.liveme 2.livestation</td>
</tr>
<tr>
<td>clusterName</td>
<td>string</td>
<td>服务集群名称</td>
</tr>
<tr>
<td>cur_ver</td>
<td>bigint</td>
<td>服务当前版本</td>
</tr>
<tr>
<td>max_ver</td>
<td>bigint</td>
<td>最大版本</td>
</tr>
<tr>
<td>pub_time</td>
<td>uint</td>
<td>发布时间</td>
</tr>
<tr>
<td>create_time</td>
<td>uint</td>
<td>创建时间</td>
</tr>
<tr>
<td>update_time</td>
<td>uint</td>
<td>更新时间</td>
</tr>
</tbody>
</table>
<p>当前conf版本表 tb_conf_cur_ver</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>类型</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>id</td>
<td>bigint</td>
<td>主键</td>
</tr>
<tr>
<td>cur_service_ver_id</td>
<td>bigint</td>
<td>当前服务版本 id</td>
</tr>
<tr>
<td>conf_type</td>
<td>tinyint</td>
<td>conf类型，比如：<!-- raw HTML omitted -->0.无 <!-- raw HTML omitted -->1.livemeDSL <!-- raw HTML omitted -->101.livestationAggrDSL 102.livestationSceneDSL</td>
</tr>
<tr>
<td>cur_ver</td>
<td>bigint</td>
<td>conf当前版本</td>
</tr>
<tr>
<td>max_ver</td>
<td>bigint</td>
<td>最大版本</td>
</tr>
<tr>
<td>conf_name</td>
<td>varchar(128)</td>
<td>conf名称</td>
</tr>
<tr>
<td>conf_target_path</td>
<td>varchar(128)</td>
<td>conf生成的目标路径</td>
</tr>
<tr>
<td>conf_val</td>
<td>varchar(8192)</td>
<td>conf当前内容</td>
</tr>
<tr>
<td>pub_time</td>
<td>uint</td>
<td>发布时间</td>
</tr>
<tr>
<td>create_time</td>
<td>uint</td>
<td>创建时间</td>
</tr>
<tr>
<td>update_time</td>
<td>uint</td>
<td>更新时间</td>
</tr>
</tbody>
</table>
<p>服务版本用户操作记录表 tb_service_op_record</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>类型</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>id</td>
<td>bigint</td>
<td>主键</td>
</tr>
<tr>
<td>service_type</td>
<td>tinyint</td>
<td>服务类型</td>
</tr>
<tr>
<td>clusterName</td>
<td>string</td>
<td>服务集群名称</td>
</tr>
<tr>
<td>check_status</td>
<td>tinyint</td>
<td>服务配置审核状态: 0.待审核 1.审核不通过 2.审核通过</td>
</tr>
<tr>
<td>op_uid</td>
<td>bigint</td>
<td>操作者uid</td>
</tr>
<tr>
<td>pub_time</td>
<td>uint</td>
<td>发布时间</td>
</tr>
<tr>
<td>create_time</td>
<td>uint</td>
<td>创建时间</td>
</tr>
<tr>
<td>update_time</td>
<td>uint</td>
<td>更新时间</td>
</tr>
</tbody>
</table>
<p>conf版本用户操作记录 tb_conf_op_record</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>类型</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>id</td>
<td>bigint</td>
<td>主键</td>
</tr>
<tr>
<td>service_op_id</td>
<td>bigint</td>
<td>服务版本操作 id</td>
</tr>
<tr>
<td>conf_type</td>
<td>tinyint</td>
<td>conf类型</td>
</tr>
<tr>
<td>conf_name</td>
<td>varchar(128)</td>
<td>conf名称</td>
</tr>
<tr>
<td>conf_target_path</td>
<td>varchar(128)</td>
<td>conf生成的目标路径</td>
</tr>
<tr>
<td>conf_val</td>
<td>varchar(8192)</td>
<td>conf当前内容</td>
</tr>
<tr>
<td>is_del</td>
<td>tinyint</td>
<td>是否删除，0.可用，1.不可用</td>
</tr>
<tr>
<td>pub_time</td>
<td>uint</td>
<td>发布时间</td>
</tr>
<tr>
<td>create_time</td>
<td>uint</td>
<td>创建时间</td>
</tr>
<tr>
<td>update_time</td>
<td>uint</td>
<td>更新时间</td>
</tr>
</tbody>
</table>
<p>服务历史版本快照表 tb_service_ver_snapshot</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>类型</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>id</td>
<td>bigint</td>
<td>主键</td>
</tr>
<tr>
<td>service_type</td>
<td>tinyint</td>
<td>服务类型</td>
</tr>
<tr>
<td>clusterName</td>
<td>string</td>
<td>服务集群名称</td>
</tr>
<tr>
<td>history_ver</td>
<td>bigint</td>
<td>服务历史版本</td>
</tr>
<tr>
<td>pub_time</td>
<td>uint</td>
<td>发布时间</td>
</tr>
<tr>
<td>create_time</td>
<td>uint</td>
<td>创建时间</td>
</tr>
<tr>
<td>update_time</td>
<td>uint</td>
<td>更新时间</td>
</tr>
</tbody>
</table>
<p>conf历史版本快照表 tb_conf_version_snapshot</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>类型</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>id</td>
<td>bigint</td>
<td>主键</td>
</tr>
<tr>
<td>conf_type</td>
<td>tinyint</td>
<td>conf类型</td>
</tr>
<tr>
<td>conf_name</td>
<td>varchar(128)</td>
<td>conf名称</td>
</tr>
<tr>
<td>history_ver</td>
<td>bigint</td>
<td>conf历史版本</td>
</tr>
<tr>
<td>conf_target_path</td>
<td>varchar(128)</td>
<td>conf生成的目标路径</td>
</tr>
<tr>
<td>conf_val</td>
<td>varchar(8192)</td>
<td>conf历史快照内容</td>
</tr>
<tr>
<td>pub_time</td>
<td>uint</td>
<td>发布时间</td>
</tr>
<tr>
<td>create_time</td>
<td>uint</td>
<td>创建时间</td>
</tr>
<tr>
<td>update_time</td>
<td>uint</td>
<td>更新时间</td>
</tr>
</tbody>
</table>
<p>服务conf历史版本关联表 tb_service_conf_ver_snapshot</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>类型</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>id</td>
<td>bigint</td>
<td>主键</td>
</tr>
<tr>
<td>service_ver_snapshot_id</td>
<td>bigint</td>
<td>服务历史版本快照 id</td>
</tr>
<tr>
<td>conf_ver_snapshot_id</td>
<td>bigint</td>
<td>conf历史版本快照 id</td>
</tr>
<tr>
<td>create_time</td>
<td>uint</td>
<td>创建时间</td>
</tr>
<tr>
<td>update_time</td>
<td>uint</td>
<td>更新时间</td>
</tr>
</tbody>
</table>
<h3 id="场景模拟">场景模拟</h3>
<ol>
<li>
<p>新增版本保存更新删除</p>
</li>
<li>
<p>审核</p>
</li>
<li>
<p>发布</p>
</li>
<li>
<p>回滚</p>
</li>
<li>
<p>获取当前服务conf版本配置</p>
<p>服务粒度整体版本文件一次拉取下来，这里是接口形式提供， 后续可以提供将可用版本以服务粒度打个包提交；如果后续有多服务一起捆绑打包，需要考虑上线依赖顺序，暂时不提供</p>
</li>
</ol>
<h3 id="接口">接口</h3>
<p>线下内网域名访问需要配置router模块中的ngx proxy配置，新增一个location /confdashboard 进行路由跳转；或者指定ip端口访问路径；</p>
<p>线上通过通过服务发现模块来获取confdashboard服务单元ip列表负载均衡进行访问；可以多机房部署，根据业务服务部署场景定；</p>
<h4 id="conf-dashboard-接口">conf-dashboard 接口</h4>
<p>提供给后台前端的CRUD接口不在这里描述，通过<a href="https://github.com/smallnest/gen">smallnest/gen</a>生成RESTful接口提供给前端使用就行，修改操作，根据不同的conf_type加载不同的json_schema进行校验，以及审核，发布接口；主要是提供给业务服务调用的接口实现，如下：</p>
<p>请求调用方式：http1.1 POST 或者 GRPC</p>
<p>公共返回参数：</p>
<table>
<thead>
<tr>
<th style="text-align:left">字段</th>
<th style="text-align:left">类型</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">errNo</td>
<td style="text-align:left">int</td>
<td style="text-align:left">错误号，默认为0</td>
</tr>
<tr>
<td style="text-align:left">errStr</td>
<td style="text-align:left">string</td>
<td style="text-align:left">错误描述</td>
</tr>
<tr>
<td style="text-align:left">data</td>
<td style="text-align:left">json</td>
<td style="text-align:left">返回响应数据</td>
</tr>
</tbody>
</table>
<ol>
<li>
<p>获取当前服务配置文件版本   /confdashboard/v1/getcurversion</p>
<p>请求：</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>参数是否必须</th>
<th>类型</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>serviceType</td>
<td>必须</td>
<td>tinyint</td>
<td>服务类型:0.无 1.liveme 2.livestation</td>
</tr>
</tbody>
</table>
<p>响应：</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>类型</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>curVer</td>
<td>int</td>
<td>当前版本</td>
</tr>
<tr>
<td>maxVer</td>
<td>int</td>
<td>最大版本</td>
</tr>
</tbody>
</table>
</li>
<li>
<p>获取当前服务文件配置内容   /confdashboard/v1/getcurserverconf</p>
<p>(服务粒度整体版本文件一次拉取下来，这里是接口形式给出对应配置数据，兜底定时轮训获取）</p>
<p>请求：</p>
<table>
<thead>
<tr>
<th style="text-align:left">字段</th>
<th>参数是否必须</th>
<th>类型</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">serviceType</td>
<td>必须</td>
<td>tinyint</td>
<td>服务类型:0.无 1.liveme 2.livestation</td>
</tr>
<tr>
<td style="text-align:left">confName</td>
<td>可选</td>
<td>string</td>
<td>服务本地配置文件名称</td>
</tr>
<tr>
<td style="text-align:left">confTargetPath</td>
<td>可选</td>
<td>string</td>
<td>服务本地配置路径</td>
</tr>
</tbody>
</table>
<p>响应data：</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>类型</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>downloadUrl</td>
<td>string</td>
<td>服务配置整体打包地址</td>
</tr>
<tr>
<td>confData</td>
<td>map<!-- raw HTML omitted -->confData<!-- raw HTML omitted -->(map&lt;{confTargetPath}/{confName}&gt;{confData})</td>
<td>服务配置列表</td>
</tr>
</tbody>
</table>
<p>confData</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>类型</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>version</td>
<td>int64</td>
<td>文件当前版本</td>
</tr>
<tr>
<td>data</td>
<td>[]byte</td>
<td>文件当前版本内容</td>
</tr>
</tbody>
</table>
</li>
<li>
<p>业务服务配置更新结果报告 /confdashboard/v1/reportBizServConf</p>
<p>请求：</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>参数是否必须</th>
<th>类型</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>serviceType</td>
<td>必须</td>
<td>tinyint</td>
<td>服务类型:0.无 1.liveme 2.livestation</td>
</tr>
<tr>
<td>reportInfos</td>
<td>必须</td>
<td>map<!-- raw HTML omitted -->reportInfo</td>
<td>业务服务配置更新结果报告列表</td>
</tr>
<tr>
<td>clusterName</td>
<td>必须</td>
<td>string</td>
<td>集群名称</td>
</tr>
</tbody>
</table>
<p>reportInfo</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>类型</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>version</td>
<td>int64</td>
<td>版本</td>
</tr>
<tr>
<td>confFilePath</td>
<td>string</td>
<td>业务配置文件路径（绝对路径）</td>
</tr>
<tr>
<td>md5sum</td>
<td>string</td>
<td>文件MD5值</td>
</tr>
<tr>
<td>confUpdateTime</td>
<td>string</td>
<td>业务配置文件更新时间</td>
</tr>
<tr>
<td>updateResultCode</td>
<td>int</td>
<td>0, 更新成功，1，更新失败</td>
</tr>
<tr>
<td>updateErrStr</td>
<td>string</td>
<td>更新失败原因</td>
</tr>
</tbody>
</table>
<p>响应data：</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>类型</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
</li>
</ol>
<h4 id="conf-agentlib-业务服务接口">conf-agent/lib 业务服务接口</h4>
<p>通过在业务服务机部署agent, 或者使用lib库封装函数的方式，最终都是需要提供获取配置的服务提供对应的接口，来保证整体服务配置的一致性，这里采用lib库封装函数提供给业务服务启动时调用这个函数的方式，是否启动单独启动端口是可选的，如果是在业务服务中启动，就用业务服务的端口，如果是单独agent方式启动，使用单独的端口；接口定义如下：</p>
<ol>
<li>
<p>获取配置开始准备替换工作 prepare接口 /{serviceType}/localconf/prepare</p>
</li>
<li>
<p>提交本地替换工作 commit接口 /{serviceType}/localconf/commit</p>
</li>
<li>
<p>获取本地配置文件元数据，比如md5,路径,版本等，meta接口 /{serviceType}/localconf/meta</p>
</li>
</ol>
<h3 id="施工">施工</h3>
<p>可以进行模块划分，按人力进行分工，可以用Project或者trello这些工具来管理整个项目需求，开发，测试，上线周期；也可以内部整合jira 和 wiki 等平台工具进行管理;</p>
<p>这个有点像建筑施工队，有了设计稿，推演几遍，满足整体需求和目标；剩下的是去实施了，实施的话需要，整体系统架构设计的建筑工程师👷，懂这行工具的专工👷，以及领队包工头👷，大项目可能还有项目监工👷‍♀️，监控进度，以及交互后的质量把控工程师👷；一起配合把事干好，让用户和老板满意。</p>
<h3 id="总结">总结</h3>
<p>前期业务为了满足快速业务迭代，业务动态配置可能都是随着业务服务一起上线，或者通过单独的代码库进行管理分开单独上线；这个可能会因为代码上线了，但是配置忘记上线的情况；或者只需要修改配置上线，而不需要修改代码，也需要单独部署一次业务服务，如果设计多个服务模块，不能及时响应了，不够KISS；为了满足业务集群配置化管理，配置平台需要管理业务动态配置来提高人效，保证业务集群上线配置的整体一致，通过后台页面来管理配置和历史配置，追踪配置的修改情况；需要注意的是，第一次上线的配置，可以先在测试环境配置平台上配置好，测试好之后，在到线上平台配置发布上线，然后在部署业务服务代码；发布配置也需要在线上未接入流量的机器上，测试之后才能上。</p>
<h3 id="qa">Q&amp;A</h3>
<ol>
<li>
<p>为什么不直接用etcd来管理配置呢？去掉mysql, 配置直接存etcd不行么？</p>
<p>主要是因为mysql用来提供管理配置实体的关系，用于后台页面修改使用；如果是k8s中的场景，可以直接使用etcd来存放；</p>
</li>
<li>
<p>如果业务服务部署在pod容器中, 怎么更新配置呢？</p>
<p>一种方案是 可以采用agent的方式，agent通过DaemonSet容器化部署, agent与业务pod之间通过共享内存的方式进行通信更新配置；</p>
</li>
</ol>
<h3 id="references">references</h3>
<ol>
<li><a href="https://github.com/Qihoo360/QConf/wiki">QConf</a></li>
<li><a href="https://www.apolloconfig.com/#/zh/design/apollo-design">apollo</a></li>
<li><a href="http://icyfenix.cn/distribution/connect/service-discovery.html">凤凰架构-service-discovery</a></li>
<li><a href="https://time.geekbang.org/column/article/341060">etcd-watch</a></li>
<li><a href="https://redisbook.readthedocs.io/en/latest/feature/pubsub.html">redis-pub/sub</a></li>
</ol>
    </div>

    
    
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">weedge</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
      2021-11-18
      
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>


    
    

    <footer class="post-footer">
      <div class="post-tags">
          <a href="https://weedge.github.io/tags/design/">design</a>
          <a href="https://weedge.github.io/tags/conf/">conf</a>
          
        </div>

      
      <nav class="post-nav">
        
        
          <a class="next" href="/post/ping/">
            <span class="next-text nav-default">工具盒子-ping/traceroute</span>
            <span class="prev-text nav-mobile">下一篇</span>
            
            <i class="iconfont">
              <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311 0.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889 0.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-0.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"></path>
</svg>

            </i>
          </a>
      </nav>
    </footer>
  </article>

  
  

  
  

  

  
  

  

  

  

    

  

        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="icon-links">
  
  
    <a href="mailto:weege007@gmail.com" rel="me noopener" class="iconfont"
      title="email" >
      <svg class="icon" viewBox="0 0 1451 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M664.781909 681.472759 0 97.881301C0 3.997201 71.046997 0 71.046997 0L474.477909 0 961.649408 0 1361.641813 0C1361.641813 0 1432.688811 3.997201 1432.688811 97.881301L771.345323 681.472759C771.345323 681.472759 764.482731 685.154773 753.594283 688.65053L753.594283 688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858L682.561621 688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759L664.781909 681.472759ZM718.063616 811.603883C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633 0 212.052267 0 212.052267L0 942.809523C0 942.809523 0 1024 83.726336 1024L682.532949 1024 753.579947 1024 1348.948139 1024C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523L1432.688811 212.052267C1432.688811 212.052267 893.138176 701.759633 817.019477 767.734955 777.248 802.205449 742.347691 811.03081 718.063616 811.603883L718.063616 811.603883Z"></path>
</svg>

    </a>
  
    <a href="https://github.com/weedge" rel="me noopener" class="iconfont"
      title="github"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M512 12.672c-282.88 0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667 0-12.16-0.426667-44.373333-0.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333 0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333 0 0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52 0.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667 0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72 0 68.522667-0.64 123.562667-0.64 140.202666 0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"></path>
</svg>

    </a>
  
    <a href="https://weibo.com/weedge" rel="me noopener" class="iconfont"
      title="weibo"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M385.714286 733.714286q12-19.428571 6.285714-39.428571t-25.714286-28.571429q-19.428571-8-41.714286-0.571429t-34.285714 26.285714q-12.571429 19.428571-7.428571 39.142857t24.571429 28.857143 42.571429 1.428571 35.714286-27.142857zm53.714286-69.142857q4.571429-7.428571 2-15.142857t-10-10.571429q-8-2.857143-16.285714 2.857143t-12.285714 10.571429q-9.714286 17.714286 7.428571 25.714286 8 2.857143 16.571429 2.857143t12.571429-10.571429zm99.428571 61.142857q-25.714286 58.285714-90.285714 85.714286t-128 6.857143q-61.142857-19.428571-84.285714-72.285714t3.714286-107.142857q26.857143-53.142857 86.571429-79.428571t120.285714-10.857143q63.428571 16.571429 90.571429 68.285714t1.428571 108.857143zm178.285714-91.428571q-5.142857-54.857143-50.857143-97.142857t-119.142857-62.285714-156.857143-12q-127.428571 13.142857-211.142857 80.857143t-75.714286 151.142857q5.142857 54.857143 50.857143 97.142857t119.142857 62.285714 156.857143 12q127.428571-13.142857 211.142857-80.857143t75.714286-151.142857zm176 2.285714q0 38.857143-21.142857 79.714286t-62.285714 78.285714-96.285714 67.142857-129.142857 47.428571-154.571429 17.714286-157.142857-19.142857-137.428571-53.142857-98-86.285714-37.142857-114q0-65.714286 39.714286-140t112.857143-147.428571q96.571429-96.571429 195.142857-134.857143t140.857143 4q37.142857 36.571429 11.428571 119.428571-2.285714 8-0.571429 11.428571t5.714286 4 8.285714 2.857143 7.714286-2l3.428571-1.142857q79.428571-33.714286 140.571429-33.714286t87.428571 34.857143q25.714286 36 0 101.714286-1.142857 7.428571-2.571429 11.428571t2.571429 7.142857 6.857143 4.285714 9.714286 3.428571q32.571429 10.285714 58.857143 26.857143t45.714286 46.571429 19.428571 66.571429zm-42.285714-356.571429q24 26.857143 31.142857 62t-3.714286 67.142857q-4.571429 13.142857-16.857143 19.428571t-25.428571 2.285714q-13.142857-4.571429-19.428571-16.857143t-2.285714-25.428571q11.428571-36-13.714286-63.428571t-61.142857-20q-13.714286 2.857143-25.714286-4.571429t-14.285714-21.142857q-2.857143-13.714286 4.571429-25.428571t21.142857-14.571429q34.285714-7.428571 68 3.142857t57.714286 37.428571zm103.428571-93.142857q49.714286 54.857143 64.285714 127.142857t-7.714286 138q-5.142857 15.428571-19.428571 22.857143t-29.714286 2.285714-22.857143-19.428571-2.857143-29.714286q16-46.857143 5.714286-98.285714t-45.714286-90.285714q-35.428571-39.428571-84.571429-54.571429t-98.857143-4.857143q-16 3.428571-29.714286-5.428571t-17.142857-24.857143 5.428571-29.428571 24.857143-16.857143q70.285714-14.857143 139.428571 6.571429t118.857143 76.857143z"></path>
</svg>

    </a>


<a href="https://weedge.github.io/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
   
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
      2013 -
    2021
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        weedge
        
      </span></span>

  
  

  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont">
        
        <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

      </i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js" integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin="anonymous"></script>












  
    <script type="text/javascript" src="/js/load-photoswipe.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  















</body>
</html>
