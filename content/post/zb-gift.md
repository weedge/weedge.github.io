---
author: "weedge"
title: "è®¾è®¡-ç›´æ’­é—´èµ é€ç¤¼ç‰©åŠŸèƒ½"
date: 2022-11-21T10:26:23+08:00
tags: [
	"ç›´æ’­",
]
categories: [
	"æŠ€æœ¯",
]

---

{{< neteasemusic id="1933940116" >}}

## èƒŒæ™¯

ç›´æ’­çº¿ä¸Šäº’åŠ¨ï¼Œå·²æˆä¸ºå½“ä¸‹ç”Ÿæ´»çš„ä¸€éƒ¨åˆ†ï¼Œç‰¹åˆ«æ˜¯å—ç–«æƒ…å½±å“ï¼Œæˆä¸ºäº’è”ç½‘çš„ä¸»è¦æµé‡å…¥å£ï¼›ç ”ç©¶äº†ä¸‹å„ä¸ªå¹³å°ç›´æ’­é—´é€ç¤¼ç‰©çš„åŠŸèƒ½ï¼Œå‘ç°å¤§åŒå°å¼‚ï¼Œåœ¨ç¤¼ç‰©åˆ†ç»„ï¼Œä¸€äº›å®šåˆ¶åŒ–çš„ç¤¼ç‰©æœ‰åŒºåˆ†ï¼Œæ•´ä½“äº¤äº’æµç¨‹å¤§è‡´ç›¸åŒï¼Œä¸»è¦æ˜¯ç›´æ’­é—´ä¸»æ’­ä¸Šæ’­ï¼Œç”¨æˆ·é€šè¿‡ç¤¼ç‰©æ‰“èµç»™ä¸»æ’­ä»¬(ä¸€ä¸ªç›´æ’­é—´å¯èƒ½æœ‰å¤šåä¸»æ’­åœ¨äº’åŠ¨)ï¼Œç¤¼ç‰©æ˜¯é€šè¿‡è™šæ‹Ÿå¸(**å¸) æ¢ç®—ï¼Œæ—©æœŸäº’è”ç½‘ç”¨æˆ·çº¿ä¸Šäº’åŠ¨ç¤¼ç‰©ï¼Œç©å®¶æœ€å¤šçš„åº”è¯¥æ˜¯QQå¸äº†ï¼Œåªä¸è¿‡ä»¥å‰çš„æ‰“èµèµ é€åœºæ™¯æ˜¯åœ¨web2.0åˆšå¼€å§‹çš„æ—¶å€™ï¼Œäº¤äº’çš„å¤§å¤šæ˜¯æ–‡å­—å’Œå›¾ç‰‡ï¼Œç›¸å…³äº§å“åœºæ™¯ï¼Œè™šæ‹Ÿç©ºé—´(ä¸ªäººç©ºé—´ï¼Œåšå®¢ï¼Œç§èœç­‰å¨±ä¹äº’åŠ¨åœºæ™¯)ï¼›éšç€åº•å±‚ç½‘ç»œåŸºå»ºçš„å‘å±•ï¼Œ4Gä¹‹åå‡ºç°äº†å¤§é‡çš„è§†é¢‘ç½‘ç«™ï¼Œç”¨æˆ·å¯ä»¥å½•ä¸€äº›è§†é¢‘å†…å®¹æ¥äº’åŠ¨ï¼›åˆ°åæ¥éŸ³è§†é¢‘æµåª’ä½“çš„å‘å±•ï¼Œç›¸å…³çš„åœ¨çº¿ç›´æ’­é—´å¼€å§‹æ¶Œç°ï¼Œç”¨æˆ·ä¹‹é—´äº«å—ä¸€æ³¢ç›´æ’­çº¢åˆ©å¸¦æ¥çš„äº’åŠ¨ï¼Œå½“ç„¶å½±å“ç›¸å¯¹äºå‰é¢çš„å½¢å¼æ›´åŠ å®æ—¶å’Œç›´æ¥ï¼›ç°åœ¨çš„5Gå’Œæœªæ¥6Gï¼Œä»¥åŠç‰©è”ç½‘éƒ½ä¼šç»™ç›´æ’­å½¢å¼å¸¦æ¥æ–°çš„äº’åŠ¨åœºæ™¯,æ¯”å¦‚ï¼šè™šæ‹Ÿä¼šåœºï¼Œäººæœºäº’åŠ¨ï¼›å…¶ä¸­æ—©æœŸåŸ¹å…»èµ·æ¥çš„æ‰“èµé€ç¤¼è¡Œä¸ºåŠŸèƒ½ç»å¸¸ç”¨äºæœ‰ä¸»æ’­çš„å¨±ä¹äº’åŠ¨ç›´æ’­ä¸­ï¼Œä¹Ÿæ˜¯å¢å€¼ç›ˆåˆ©çš„ä¸€éƒ¨åˆ†ï¼›

tips: é™¤äº†é€ç¤¼åŠŸèƒ½ï¼Œæ ¹æ®ä¸åŒç›´æ’­åœºæ™¯ï¼Œè¿˜æœ‰è¯­éŸ³è§†é¢‘è¿éº¦ï¼Œç”µå•†å¸¦è´§å•†å“ï¼Œæ²¡æœ‰ä¸»æ’­ï¼ŒèŠ‚ç›®ç›´æ’­/è½¬æ’­ï¼Œä¼šè®®ç›´æ’­ï¼Œè‡ªä¹ å®¤ï¼ŒåŸºæœ¬çš„ç‚¹èµï¼Œè®¡æ•°ï¼ŒèŠå¤©åŸºç¡€æœåŠ¡åŠŸèƒ½ï¼›è¿˜æœ‰äº›æŠ½å¥–åŠŸèƒ½ï¼Œç­”é¢˜åŠŸèƒ½(æ•™è‚²ç±»ç›´æ’­å±…å¤š)ï¼ŒæŠ•ç¥¨ï¼Œçº¢åŒ…è¿™äº›åŠŸèƒ½æœåŠ¡å¯åœ¨å¼€æ’­æ—¶è®¾ç½®ï¼Œæ˜¯å¦å¯ç”¨ï¼›æœ‰ç”¨æˆ·åŸºç¡€çš„æµé‡å¹³å°å¯èƒ½è¿˜ä¼šä»¥ç«ä»·æ’åçš„æ–¹å¼æ¨èä¸€æ³¢ï¼›è¿™äº›åŠŸèƒ½å¯ä»¥ä½œä¸ºä¸€ä¸ªå¯ç®¡ç†çš„æ’ä»¶ï¼Œé€šè¿‡ç»„åˆçš„æ–¹å¼åº”ç”¨äºç›´æ’­ä¸­ï¼Œæ–¹ä¾¿ç®¡ç†ï¼Œåç»­å¯ä»¥æ·»åŠ æ–°åŠŸèƒ½æ»¡è¶³æŸç±»å‹ç›´æ’­åœºæ™¯ã€‚

<!--more-->

## éœ€æ±‚è®¾è®¡

è®¾è®¡ä¸€ä¸ªç®€å•ç¤¼ç‰©æ‰“èµåŠŸèƒ½: Aç”¨æˆ·(è§‚ä¼—)èµ é€ç¤¼ç‰©ç»™Bç”¨æˆ·(ä¸»æ’­)ï¼Œå¯ä»¥ç»™å¤šä¸ªä¸»æ’­èµ é€ç¤¼ç‰©ï¼›

### åˆ†æ

ç¤¼ç‰©ï¼šç›´æ’­å¹³å°é€šè¿‡è™šæ‹Ÿå¸æ¥ç»Ÿä¸€ç­‰ä»·äº¤æ¢çš„è™šæ‹Ÿç‰©å“ï¼Œè€Œè™šæ‹Ÿå¸æ˜¯éœ€è¦é€šè¿‡ç”¨æˆ·å……å€¼è´­ä¹°ï¼›å‘é€ç¤¼ç‰©å¯ä»¥è·å¾—ä¸€äº›ç§¯åˆ†ï¼›

Aç”¨æˆ·å‘é€ç¤¼ç‰©ç»™Bç”¨æˆ·ï¼ŒAçš„è™šæ‹Ÿå¸æ‰£é™¤ï¼ŒBçš„è™šæ‹Ÿå¸ç›¸åº”å¢åŠ ï¼›éœ€è¦ä¿è¯èµ é€å’Œæ”¶åˆ°çš„æ•°é‡ä¸€è‡´ï¼›

éœ€è¦è€ƒè™‘å¹¶å‘åœºæ™¯ï¼Œå¯¹äºçƒ­é—¨ä¸»æ’­é«˜å³°æœŸçš„æµé‡å€¼100wè§‚ä¼—ç”¨æˆ·åœ¨çº¿äº’åŠ¨ï¼Œæ¯ç§’é€ç¤¼çš„è¯·æ±‚æ•°é‡ä¹Ÿå¯èƒ½é«˜äºè¿™ä¸ªå€¼ï¼Œç”¨æˆ·å¯èƒ½è¿å‡»é€å‡ºå¤šæ¬¡(è¿å‡»è¡Œä¸ºå®¢æˆ·ç«¯å¯ä»¥ç¼“å†²ä¸€æ¬¡å‘é€ç»™åç«¯)ï¼Œ è€Œä¸”ä¸ºäº†ä¿è¯æ•°æ®ä¸€è‡´å’Œååï¼Œå°½é‡å‡å°‘é”çš„ä½¿ç”¨ï¼Œæˆ–è€…è¯´é‡‡ç”¨[OCC](https://en.wikipedia.org/wiki/Optimistic_concurrency_control)ï¼Œä¹è§‚é”çš„æ–¹å¼æ¥å¤„ç†äº‹åŠ¡ï¼Œäº¤ç”±ä¸šåŠ¡æœåŠ¡ç¨‹åºæ¥å¤„ç†ï¼Œå°½é‡å‡å°‘æˆ–å‡çŸ­æ•°æ®åº“ä¸­å¿ƒå­˜å‚¨æœåŠ¡ä¸Šçš„é”æ“ä½œï¼ŒåŸç†å°±æ˜¯ï¼šå¤¯ä¸»åï¼Œå°±å‘†èŒäº†ï¼Œèµ„æºæœªé‡Šæ”¾ï¼Œè¯·æ±‚èµ„æºä¸€å¢å¤šï¼Œå¯¼è‡´æ•´ä¸ªæœåŠ¡ååä¸‹é™ï¼Œä¸€ç›´æŒç»­ä¸‹å»éšæ—¶éƒ½ä¼šdownæ‰ï¼Œè€Œä¸”é”æ˜¯å»ºç«‹åœ¨ç´¢å¼•æ•°æ®ä¹‹ä¸Šçš„ï¼Œ å¦‚æœæ²¡æœ‰ç›¸å…³é™çº§å¤„ç†ï¼Œå¼„ä¸å¥½æ•´ä½“æœåŠ¡å°±[galigeigei](https://www.youtube.com/watch?v=4m48GqaOz90)ï¼›

100W è§‚ä¼—Aå‘åŒä¸€ä¸ªä¸»æ’­B èµ é€ç¤¼ç‰©ï¼Œå¯¹äºä¸»æ’­Bçš„è™šæ‹Ÿå¸ç´¯è®¡å†™æ“ä½œæ¯”è¾ƒå¤§ï¼ŒåŒä¸€æ—¶é—´å¯èƒ½100W+çš„w æ“ä½œ ä¸»æ’­B è™šæ‹Ÿå¸è¿™æ¡è®°å½•ï¼Œå¦‚æœç›´æ¥åŒæ­¥æ“ä½œåœ¨æ•°æ®åº“å±‚é¢ä¼šå‡ºç°è¡Œé”ï¼Œä¼šç­‰å¾…å¤¯ä¸»æ•´ä¸ªèµ é€æµç¨‹ï¼Œæ‰€ä»¥éœ€è¦æŠŠè¿™äº›é›†ä¸­å†™ï¼Œé€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥å»æ›´æ–°è™šæ‹Ÿå¸æ•°ç›®ï¼Œè¿›è€Œæé«˜è§‚ä¼—é€ç¤¼æ¥å£çš„ååé‡ï¼Œ

è§‚ä¼—è™½ç„¶æ“ä½œè‡ªå·±çš„è™šæ‹Ÿå¸æ•°ç›®è¡Œè®°å½•ï¼Œä½†æ˜¯ç›´æ¥æ“ä½œæ•°æ®åº“ï¼Œå³ä½¿å¯¹ç”¨æˆ·èµ„äº§è¡¨è¿›è¡Œåˆ†åº“åˆ†è¡¨æ“ä½œï¼Œä¹Ÿä¼šæœ‰å¤§é‡çš„ç£ç›˜i/oï¼Œæ‰€ä»¥ç›´æ’­é—´çš„äº’åŠ¨æ•°æ®ç›´æ¥åœ¨ç¼“å­˜ä¸­æ“ä½œï¼ŒæŠŠè§‚ä¼—çš„æ“ä½œè®°å½•æ¶ˆæ¯é˜Ÿåˆ—çš„æ–¹å¼å¼‚æ­¥è½åº“ï¼›

ç¼“å­˜çš„æ–¹å¼æ“ä½œï¼Œéœ€è¦æŠŠè§‚ä¼—çš„ç”¨æˆ·èµ„äº§ä¿¡æ¯å‰ç½®é¢„çƒ­è‡³ç¼“å­˜ä¸­ï¼Œç›´æ’­ä¸­ç›´æ¥æ“ä½œç¼“å­˜ï¼Œ æ“ä½œç¼“å­˜éœ€è¦ä¿è¯å¹¶å‘æ“ä½œäº‹åŠ¡çš„åŸå­æ€§ï¼Œä¿è¯è§‚ä¼—çš„è™šæ‹Ÿå¸ä¸èƒ½å¤šæ‰£æˆ–è€…å°‘æ‰£ï¼›

å¹¶å‘åœºæ™¯ä¸‹ï¼Œä¸ºäº†å‡å°‘å¤§é‡ç”¨æˆ·å†²å‡»åº•å±‚æ•°æ®åº“ï¼Œå‡å°‘ç£ç›˜io, é€ç¤¼ç‰©è¿™äº›äº’åŠ¨ç›´æ¥è¯»å†™ç”¨æˆ·ç¼“å­˜æ•°æ®ï¼Œè¿™äº›ç¼“å­˜æ•°æ®çš„æ“ä½œç±»å‹åˆ†ä¸ºæ˜¯/å¦æ›´æ–°é¢‘ç¹ï¼›

æ›´æ–°ä¸é¢‘ç¹æ•°æ®ï¼šç”¨æˆ·ï¼Œç›´æ’­é—´ï¼Œç‰©æ–™è¯¦æƒ…ç­‰ä¿¡æ¯ï¼Œè¿™äº›ç¼“å­˜æ•°æ®åœ¨è¿›å…¥ç›´æ’­é—´çš„æ—¶å€™ç›´æ¥ä»æ•°æ®åº“ä»¥cacheAside patternè·å–å¡«å……ï¼Œå¡«å……çš„æ—¶å€™é‡‡ç”¨singleflightæ–¹å¼ï¼›ç‰©æ–™ä¿¡æ¯è¿˜å¯ä»¥æœåŠ¡æœ¬åœ°ç¼“å­˜ä¸€ä»½ï¼›å˜æ›´æ•°æ®æ—¶ï¼Œè¿œç«¯ç¼“å­˜æ•°æ®å¯ä»¥é€šè¿‡CDCè®¢é˜…æ•°æ®åº“æ“ä½œæ—¥å¿—(æ¯”å¦‚ï¼šbinlog)æ¥ä¸»åŠ¨å¼‚æ­¥æ›´æ–°ç¼“å­˜æ•°æ®ï¼Œæˆ–è€…ä½¿ç”¨å»¶æ—¶åŒåˆ æ¥è¢«åŠ¨æ›´æ–°ï¼Œæœ¬åœ°ç¼“å­˜å¯æ ¹æ®é€šè¿‡æ§åˆ¶å¹³é¢é…ç½®ä¸‹å‘æ¥è§¦å‘ä»è¿œç«¯ç¼“å­˜æ›´æ–°æ•°æ®ï¼›

æ›´æ–°é¢‘ç¹æ•°æ®ï¼š è¿™ä¸ªä¸»è¦å‘ç”Ÿåœ¨ç”¨æˆ·ç›´æ’­äº’åŠ¨ï¼Œèµ é€ç¤¼ç‰©åœºæ™¯ï¼Œå¤šæ¬¡å¹¶å‘æ“ä½œï¼Œå˜æ›´çš„å®ä½“æ•°æ® è§‚ä¼—/ä¸»æ’­è™šæ‹Ÿèµ„äº§æ‰£é™¤/å¢åŠ ï¼Œè¿™äº›æ•°æ®ä»¥writeThrough/Behind partternæ–¹å¼ç›´æ¥æ›´æ–°ç¼“å­˜ï¼Œé˜Ÿåˆ—å¼‚æ­¥è½åº“ï¼›å› ä¸ºç›´æ’­åœºæ™¯ç”¨æˆ·çš„æ•°æ®éƒ½åœ¨ç¼“å­˜ä¸­ï¼Œæ•°æ®å®æ—¶æ›´æ–°æŸ¥çœ‹ï¼Œä¸å½±å“ç”¨æˆ·ä½“éªŒï¼›ç›´æ’­ç›‘æ§åå°ä»æ•°æ®åº“é‡Œè®¢é˜…è¿‘å®æ—¶æŸ¥çœ‹ç”¨æˆ·çš„è™šæ‹Ÿèµ„äº§ï¼Œä¼šæœ‰ä¸€ä¸ªæ‰¹é‡çª—å£çš„å¤„ç†å»¶è¿Ÿï¼›

ç¼“å­˜æ•°æ®åˆå§‹åŒ–ï¼Œå¯ä»¥åœ¨ç”¨æˆ·åˆšæ‰“å¼€appçš„æ—¶å€™åˆå§‹åŒ–ï¼Œä¹Ÿå¯ä»¥åœ¨è¿›å…¥/åˆ›å»ºå¥½ç›´æ’­é—´çš„æ—¶å€™åˆå§‹åŒ–å¥½ç”¨æˆ·ç›´æ’­é—´ç¼“å­˜æ•°æ®ï¼›

ä»¥ä¸Šå¯ä»¥å°†æ“ä½œåˆ†2ä¸ªå…³é”®æ­¥éª¤ï¼š è§‚ä¼—èµ é€ç¤¼ç‰©å’Œå¼‚æ­¥æ›´æ–°è§‚ä¼—å’Œä¸»æ’­çš„èµ„äº§ä¿¡æ¯ï¼›é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—æ¥è§£è€¦ï¼Œæé«˜é€ç¤¼æ¥å£ååå’Œè¯·æ±‚å“åº”å»¶è¿Ÿï¼Œä»¥åŠä»¥pullæ–¹å¼æ¶ˆè´¹ï¼Œç¼“è§£æ•°æ®åº“å®ä¾‹çš„è¯»å†™å‹åŠ›ï¼›

è§‚ä¼—èµ é€ç¤¼ç‰©ï¼š ç¤¼ç‰©æ˜¯é€šè¿‡è™šæ‹Ÿè´§å¸è¿›è¡Œç­‰ä»·äº¤æ¢çš„ï¼Œé€šè¿‡ç¤¼ç‰©idè·å–åˆ°å¯¹åº”æ¶ˆè´¹çš„è™šæ‹Ÿèµ„äº§ï¼Œå¯¹ä¸­å¿ƒè¿œç«¯ç¼“å­˜åˆ†ç‰‡ä¸­çš„è§‚ä¼—è™šæ‹Ÿèµ„äº§è¿›è¡Œäº‹åŠ¡æ‰£é™¤å¤„ç†ï¼Œäº‹åŠ¡æäº¤ä¹‹åï¼Œå‘é€äº‹åŠ¡æ¶ˆæ¯ï¼›è¿™é‡Œé‡‡ç”¨casæ–¹å¼å¤„ç†ï¼Œä¸€ç§æ˜¯watch key(string è¯»å†™ioæ˜¯O(1), ä¸ç”¨hashæ˜¯å› ä¸ºè¯»å–å…¨éƒ¨èµ„äº§ä¿¡æ¯ioæ˜¯O(n))+äº‹åŠ¡æ–¹å¼ï¼Œä¸€ç§æ˜¯luaçš„å½¢å¼ç›´æ¥å†™ä¸šåŠ¡æäº¤è„šæœ¬ç»™redisæ ¸å¿ƒä¸»çº¿ç¨‹å»å¤„ç†ï¼›è¿™é‡Œå¯èƒ½ä¼šæƒ³åˆ°ç›´æ¥ç”¨ hash incråŸå­æ“ä½œï¼Œä½†æ˜¯è¿™é‡Œä¸è¡Œï¼Œå› ä¸ºéœ€è¦è¯»å‡ºkeyå¯¹åº”çš„è™šæ‹Ÿèµ„äº§ï¼Œç”¨äºåˆ¤æ–­è™šæ‹Ÿèµ„æºæ˜¯å¦å……è¶³ï¼Œè¯»å‡ºæ¥åœ¨æ‰£é™¤å†™å…¥ï¼Œéœ€è¦ä¸€èµ·æ‰§è¡Œï¼Œä¿è¯äº‹åŠ¡åŸå­æ€§ï¼›é™¤äº†æ ¸å¿ƒæµç¨‹ï¼Œè¿˜æœ‰å‘é€ç¤¼ç‰©æˆåŠŸåï¼Œéœ€è¦æ¨é€æ¶ˆæ¯åˆ°ç›´æ’­é—´ï¼Œæ ¹æ®äº§å“ç¤¼å“ç­–ç•¥åˆ¤æ–­æ˜¯å¦å±•ç¤ºç‰¹æ•ˆ; ä»¥åŠå¢åŠ ç”¨æˆ·æ´»åŠ¨ç§¯åˆ†ï¼Œå¢åŠ äº’åŠ¨ç§¯ææ€§ï¼›

å¼‚æ­¥æ›´æ–°è§‚ä¼—å’Œä¸»æ’­æ•°æ®åº“è½åœ°èµ„äº§ä¿¡æ¯ï¼šä¸ºäº†å‡å°‘å¯¹æ•°æ®åº“çš„è¡Œé”çš„å¹¶å‘å‹åŠ›ï¼Œå¯é‡‡ç”¨CASçš„æ–¹å¼æ¥æ›´æ–°æ•°æ®åº“çš„æ•°æ®ï¼Œå‰ææ˜¯å•ä¸ªç”¨æˆ·èµ„äº§æ“ä½œï¼Œå¦‚æœæƒ³å•ä¸ªäº‹åŠ¡å•ä¸ªäº‹åŠ¡å¤„ç†ï¼Œå¯ä»¥é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—äº‹åŠ¡æ¶ˆæ¯æ–¹å¼ä¸²èµ·æ¥(pipeline)ï¼›å¦‚æœæ˜¯å¤šä¸ªç”¨æˆ·èµ„äº§æ“ä½œåœ¨åŒä¸€æœåŠ¡äº‹ç‰©é‡Œæ“ä½œçš„è¯ï¼Œåˆ™ä¸èƒ½ä½¿ç”¨CASçš„æ–¹å¼å¤„ç†äº†ï¼Œåªèƒ½ä»¥æ•´ä½“äº‹åŠ¡æ–¹å¼å¤„ç†(é»˜è®¤RRçº§åˆ«)ï¼›

æ¶ˆæ¯é˜Ÿåˆ—ï¼šæ¶‰åŠåˆ°é‡‘é’±ï¼Œä¸ºäº†æé«˜ååï¼Œéœ€è¦ä¿è¯æ•°æ®å‡†ç¡®ï¼Œæ•°æ®æœ€ç»ˆä¸€è‡´([**BASE**](https://www.allthingsdistributed.com/2008/12/eventually_consistent.html))ï¼Œé‡‡ç”¨æ”¯æŒäº‹åŠ¡æ¶ˆæ¯çš„åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ¯”å¦‚ï¼š[rocketMQ**äº‹åŠ¡æ¶ˆæ¯**](https://rocketmq.apache.org/zh/docs/featureBehavior/04transactionmessage/)ï¼Œè¿™é‡Œå¯èƒ½æœ‰ä¸ªç–‘é—®å¦‚æœåˆšå¼€å§‹å‘é€äº‹åŠ¡æ¶ˆæ¯å°±å¤±è´¥äº†ï¼Œå¯èƒ½æ˜¯ç½‘ç»œæŠ–åŠ¨,æˆ–è€…æœåŠ¡è´Ÿè½½é«˜ç­‰åŸå› ï¼Œä¸€èˆ¬æ˜¯å¯ç”¨failoveræƒé‡[æŒ‡æ•°é€€é¿](https://en.wikipedia.org/wiki/Exponential_backoff)ç­–ç•¥é‡è¯•åˆ°ä¸åŒæœºæˆ¿çš„rocketMQé›†ç¾¤ï¼Œå¯ä»¥æŸ¥çœ‹[æ¶ˆæ¯å‘é€é‡è¯•æœºåˆ¶](https://rocketmq.apache.org/zh/docs/featureBehavior/05sendretrypolicy#%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81%E9%87%8D%E8%AF%95%E6%9C%BA%E5%88%B6) å’Œ [æœ€ä½³å®è·µ](https://rocketmq.apache.org/zh/docs/bestPractice/15bestpractice), [timeouts-retries-and-backoff-with-jitter](https://aws.amazon.com/cn/builders-library/timeouts-retries-and-backoff-with-jitter/)ï¼›å¦‚æœé‡è¯•è¿˜æ˜¯å¤±è´¥æ‰“å°é”™è¯¯æ—¥å¿—è®°å½•å‘é€è¯¦æƒ…ï¼Œé€šè¿‡å®æ—¶æ•°æ®æµå°†å¼‚å¸¸è¡Œä¸ºå†™å…¥dbä¸­ï¼Œä»¥ä¾¿åç»­è¡¥å‘ï¼›

Tips: å¦‚æœä½¿ç”¨é˜¿é‡Œäº‘rocketMQ, éœ€è¦æ³¨æ„æ”¯æŒç‰ˆæœ¬æä¾›çš„SDKï¼Œ5.0 ç‰ˆæœ¬ [client SDK](https://github.com/apache/rocketmq-clients) ; 4.0ç›¸å…³ç‰ˆæœ¬æœ‰äº›å¼€å‘è¯­è¨€ä¸æ”¯æŒtcpæ–¹å¼ï¼Œä»…æä¾›httpçš„æ–¹å¼(ä¼šå°‘äº†ä¸€äº›åŠŸèƒ½ï¼Œæ¯”å¦‚æ‰¹é‡å‘é€æ™®é€šæ¶ˆæ¯)ï¼›é€‰ç”¨æ–°ç‰ˆçš„5.0ç‰ˆæœ¬çš„SDKå¼€å‘(golangç‰ˆclient SDKå¯ä»¥ç”¨æ¥ç”Ÿäº§æ¶ˆæ¯ï¼Œå¯¹åº”æ¶ˆæ¯ç±»å‹éƒ½å·²æ”¯æŒ); å¦‚æœæœ‰è‡ªå»ºè¿ç»´èƒ½åŠ›ï¼Œç›´æ¥ä½¿ç”¨å¼€æºæ–¹æ¡ˆæ¥æ­å»ºä¸€å¥—ï¼Œæ¯”å¦‚ç”¨[rocketMQ on aws](https://www.amazonaws.cn/solutions/apache-rocketmq-on-aws/)ï¼Œç„¶åå¯ä»¥åŸºäºOTELçš„metricæ ‡å‡†é‡‡é›†åˆ°Promethuesä¸­ï¼Œé€šè¿‡GrafanaåŠ ä¸Šç›‘æ§æŠ¥è­¦(ç›‘æ§ç³»ç»Ÿä¹Ÿå¯ä»¥è‡ªå»ºï¼Œæˆ–è€…ç”¨äº‘æœåŠ¡æ¯”å¦‚aliyun ARMSï¼ŒåŒæ ·åˆ†å¸ƒå¼db/cacheä¹Ÿæœ‰ç›¸åº”ç›‘æ§è§£å†³æ–¹æ¡ˆ,æ•°æ®æŒ‡æ ‡é‡‡é›†ä¸ŠæŠ¥ä»¥pullæ–¹å¼å±…å¤š,ç›¸å¯¹äºä¸šåŠ¡æœåŠ¡å¸¸è§ä»¥pushæ–¹å¼)ï¼›å¹¶ä¸”ä½¿ç”¨5.0å¯ä»¥å®ç°ä¸€å±‚mq-proxy(æœ¬åœ°ä»£ç†å’Œä¸­å¿ƒä»£ç†)ï¼Œè®¡ç®—å­˜å‚¨åˆ†ç¦»;

é¢˜å¤–è¯: ç°åœ¨åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—[kafka-streams](https://kafka.apache.org/33/documentation/streams/architecture), [rocketmq-streams](https://github.com/apache/rocketmq-streams) æ”¯æŒæ•°æ®æµ(stream)å¤„ç†å¤§æ•°æ®å®æ—¶åœºæ™¯ï¼Œæ”¯æŒä¸€äº›ç®€å•ç®—å­æ“ä½œå’ŒSQL([ksql](https://github.com/confluentinc/ksql), [rsql](https://github.com/alibaba/rsqldb))ï¼›è¿™ä¸ªå’Œflinkå¯¹åº”åŠŸèƒ½æ˜¯é‡åˆäº†ï¼Œflinkä¹Ÿåœ¨å¾€table storeä¸Šå‘åŠ›æ»¡è¶³æ•°æ®å †ç§¯çš„èƒ½åŠ›; ä¸€æ³¢æµï½

### è°ƒç ”

ä»¥pcç«¯æŠ“httpåŒ…ä¸ºä¾‹ï¼Œæ‰‹æœºç«¯æ¥å£ä¸€æ ·ï¼Œä¼ è¾“æ ¼å¼å¯èƒ½ä¸åŒï¼Œpb/json

#### æŠ–éŸ³æ¥å£

```shell
curl 'https://live.douyin.com/webcast/gift/send/?aid=6383&live_id=1&device_platform=web&language=zh-CN&enter_from=web_live&cookie_enabled=true&screen_width=2048&screen_height=1152&browser_language=zh-CN&browser_platform=MacIntel&browser_name=Chrome&browser_version=107.0.0.0&browser_online=true&engine_name=Blink&engine_version=107.0.0.0&os_name=Mac+OS&os_version=10.15.7&cpu_core_num=8&device_memory=8&platform=PC&downlink=10&effective_type=4g&round_trip_time=50&channel=channel_pc_web&app_name=douyin_web&webid=7167235205950047744&user_agent=Mozilla%2F5.0+(Macintosh%3B+Intel+Mac+OS+X+10_15_7)+AppleWebKit%2F537.36+(KHTML,+like+Gecko)+Chrome%2F107.0.0.0+Safari%2F537.36&fp=verify_lam4f5i1_plZJSYeB_iUgU_4z2o_9JHF_d7Z0Z60sLg33&did=0&referer=https:%2F%2Flive.douyin.com%2F444452144000%3Fcover_type%3D0%26enter_from_merge%3Dweb_live%26enter_method%3Dweb_card%26game_name%3D%26is_recommend%3D1%26live_type%3Dgame%26more_detail%3D%26request_id%3D2022111814283801020916816201004237%26room_id%3D7167220081737468683%26stream_type%3Dvertical%26title_type%3D1%26web_live_page%3Dhot_live%26web_live_tab%3Dall&target=&device_id=7167235205950047744&msToken=aOEoMNHAEI98H45Z0n-zUTffiNgv7HNkGU0lwFptk-JBg00tEs0I74G4sYXgG670cAdhSmXNcKlRU3-QaxW7Pflt-p8YAmyU5eC3EGJQfp7Mk7JpmP_P&X-Bogus=DFSzswVL0qCmAcoQS8MuBN7TlqS8&_signature=_02B4Z6wo00001Heu8JQAAIDD43irmgubdKx3rvQAAH6ktTtRdH7gtQJWp3SjldUkeBB51lpkXUQ700UnFEXODUicQ0r1ccxSxq4OwWIjvxuNe8Acl-gJzChe99W43SojHkPp9aa82Qzi9VoTd2' \
  -H 'authority: live.douyin.com' \
  -H 'accept: application/json, text/plain, */*' \
  -H 'accept-language: zh-CN,zh;q=0.9,en;q=0.8,zh-TW;q=0.7' \
  -H 'content-type: application/x-www-form-urlencoded' \
  -H 'cookie: xgplayer_user_id=502915240928; csrf_session_id=f5161482adac52884f25a91fa758d7b0; ttcid=5cd5ff73751f4ab39911c85e57f9ca7479; passport_csrf_token=46e48d1e7b4df245f8caab8a34b64935; passport_csrf_token_default=46e48d1e7b4df245f8caab8a34b64935; home_can_add_dy_2_desktop=%220%22; n_mh=Qo43cptpX41bfwDmWyVyRUGMZnsucxhgcWJqKjjWkvI; sso_uid_tt=a84f8e3ae1f0c8301f5a882b05abe3f0; sso_uid_tt_ss=a84f8e3ae1f0c8301f5a882b05abe3f0; toutiao_sso_user=a28a6e92e7dc7d690b4f6b9a59077692; toutiao_sso_user_ss=a28a6e92e7dc7d690b4f6b9a59077692; passport_assist_user=Cjyr0IY04IJK-7Hxgl87vzPKZIfpFS29oAG2arITfMftUANM_d6SDxwAksiJEuVqZgZdE_BYyvcjLLGAQaYaSAo8zVwGiPnNM3S7eRNlXwMkuS7yNVm17pbNfKqXsXj3Rgk9Nm08DWh_PY0JRbH8FQeLxabRAoqM4bPJTzQ8EM_DoQ0Yia_WVCIBAxToQPk%3D; sid_ucp_sso_v1=1.0.0-KGIxM2FlNmE2MDdiNWE5MDA1YmIwZjg5OWVkNTUxMTBhMzdhYWE2OTIKHQjhrMGYrgIQt8vcmwYY7zEgDDDHuNHRBTgGQPQHGgJobCIgYTI4YTZlOTJlN2RjN2Q2OTBiNGY2YjlhNTkwNzc2OTI; ssid_ucp_sso_v1=1.0.0-KGIxM2FlNmE2MDdiNWE5MDA1YmIwZjg5OWVkNTUxMTBhMzdhYWE2OTIKHQjhrMGYrgIQt8vcmwYY7zEgDDDHuNHRBTgGQPQHGgJobCIgYTI4YTZlOTJlN2RjN2Q2OTBiNGY2YjlhNTkwNzc2OTI; passport_auth_status=ba24f5319c0f02c6232d484fd51c2187%2C; passport_auth_status_ss=ba24f5319c0f02c6232d484fd51c2187%2C; sid_guard=ea2e466c926c317f4f552f0d3982a458%7C1668752823%7C5184000%7CTue%2C+17-Jan-2023+06%3A27%3A03+GMT; uid_tt=23c596f546d448da13c0098152ef5d17; uid_tt_ss=23c596f546d448da13c0098152ef5d17; sid_tt=ea2e466c926c317f4f552f0d3982a458; sessionid=ea2e466c926c317f4f552f0d3982a458; sessionid_ss=ea2e466c926c317f4f552f0d3982a458; sid_ucp_v1=1.0.0-KDRiMzcyMDVkZmZhMWIxNjhjNDM4YjBiZDA4Y2E5ZTBmN2IxNTE1NjIKFwjhrMGYrgIQt8vcmwYY7zEgDDgGQPQHGgJsZiIgZWEyZTQ2NmM5MjZjMzE3ZjRmNTUyZjBkMzk4MmE0NTg; ssid_ucp_v1=1.0.0-KDRiMzcyMDVkZmZhMWIxNjhjNDM4YjBiZDA4Y2E5ZTBmN2IxNTE1NjIKFwjhrMGYrgIQt8vcmwYY7zEgDDgGQPQHGgJsZiIgZWEyZTQ2NmM5MjZjMzE3ZjRmNTUyZjBkMzk4MmE0NTg; FOLLOW_NUMBER_YELLOW_POINT_INFO=%22MS4wLjABAAAAt_v5oVMmcxuNnLLRzi6Ey1GKVQr_2XVFt2jPbkhZPI8%2F1668787200000%2F0%2F1668752826051%2F0%22; strategyABtestKey=%221668752909.101%22; __ac_nonce=06377261b0070042789c9; __ac_signature=_02B4Z6wo00f01JfP74gAAIDDAxm0hJMbmiiX7-sAAEaJTk9YXvYiEKlcYbhZnUTqyIVISJ6Z9uR3UEye00i7MfEP1dAywrmbnaQAIP3m1.7zOA8BmpqIWhyYJal-u6k6LMxVpsCtyakYsz3325; live_can_add_dy_2_desktop=%221%22; tt_scid=PpJHVbeNWnhY54EQ6vWraqXl5A8SZDtl3dn9JTaQQNLPo37ztPaJz.xoJHxyhNYScf8e; s_v_web_id=verify_lam4f5i1_plZJSYeB_iUgU_4z2o_9JHF_d7Z0Z60sLg33; ttwid=1%7C-XDacSDIgDIHmJqBxLj6Op91O91Ww4nvf96AveJpNeE%7C1668752951%7C0275ac24a410dd06b5f87dc4d84188f6eedaf20ed69cc9d0e979559df7df461e; download_guide=%223%2F20221118%22; odin_tt=3a02e4ad7a6c9042e1c42ece6d0d4a1aeeb37ed334f3450eb4adf57a6d0e09938523f8954816d90d557b27f5d3cbea85; msToken=1GTirdFSckP7H_txAPOKIMLWleKhlwccm-ts_3OviXegeQ2cr0B56jMAqfB3SqEGnxPEBjXRWsmg-sxVW3okb1s-acOAnBkIVDA_47g5aZFOqMKEzI-N; msToken=aOEoMNHAEI98H45Z0n-zUTffiNgv7HNkGU0lwFptk-JBg00tEs0I74G4sYXgG670cAdhSmXNcKlRU3-QaxW7Pflt-p8YAmyU5eC3EGJQfp7Mk7JpmP_P' \
  -H 'origin: https://live.douyin.com' \
  -H 'referer: https://live.douyin.com/444452144000' \
  -H 'sec-ch-ua: "Google Chrome";v="107", "Chromium";v="107", "Not=A?Brand";v="24"' \
  -H 'sec-ch-ua-mobile: ?0' \
  -H 'sec-ch-ua-platform: "macOS"' \
  -H 'sec-fetch-dest: empty' \
  -H 'sec-fetch-mode: cors' \
  -H 'sec-fetch-site: same-origin' \
  -H 'user-agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/107.0.0.0 Safari/537.36' \
  -H 'x-secsdk-csrf-token: 000100000001c39118162052c6b50f6dadb067cc07c073c9b93f035ea22242c67c43f5951903172899f1bc355042' \
  --data-raw 'room_id=7167220081737468683&to_room_id=7167220081737468683&sec_to_user_id=MS4wLjABAAAAOgGR5D9qmmPglgaT08-30j8vnjeeAdmgXhJY_8Q7oLk&to_episode_id=0&send_type=4&send_scene=1&gift_source=0&buff_level=0&count=1&price=2&gift_id=2002&is_first_combo=true' \
  --compressed -iv
```

å“åº”

 ```json
{
  "data": {
    "message": "Insufficient Fund",
    "prompts": "ä½™é¢ä¸è¶³"
  },
  "extra": {
    "now": 1668755929438
  },
  "status_code": 40001
}
 ```



#### å¿«æ‰‹æ¥å£

è¯·æ±‚

```shell
curl 'https://live.kuaishou.com/live_graphql' \
  -H 'Accept-Language: zh-CN,zh;q=0.9,en;q=0.8,zh-TW;q=0.7' \
  -H 'Connection: keep-alive' \
  -H 'Cookie: clientid=3; did=web_0d47b6546f1fd39fe4d1236703ae2b16; kuaishou.live.bfb1s=9b8f70844293bed778aade6e0a8f9942; client_key=65890b29; kpn=GAME_ZONE; userId=553458447; kuaishou.live.web_st=ChRrdWFpc2hvdS5saXZlLndlYi5zdBKgAV6EW8_dkcqveTyN6yy6uaMZd7O2c9rYOi19Fb3FhhOTPjtHtkb7lPQxQ4QaygTV0J-_Z0E7-4E5lFUZ2MRRzwjNAgbEEeSbf5duEVRtpGJnR_EEjJeZ3yyPMWPsJelIVcpSHGX02esKljXrWSXcbMWU709r4hxtaNHdMQtnvmLt1nijHxRE7lio0ZRYM5n-EK65VJq2EUpFqHFY_jFqxm0aEhrHsWfESUHgv806qk-5eqStgCIgOVwse70J74NPwA2TbGfOv-Ze0M-TVQJ0kHcHOHiTkKooBTAB; kuaishou.live.web_ph=75bafd83e69f9caf80b760c47f7b9c976d31; userId=553458447; ksliveShowClipTip=true' \
  -H 'Origin: https://live.kuaishou.com' \
  -H 'Referer: https://live.kuaishou.com/u/YiGe6666' \
  -H 'Sec-Fetch-Dest: empty' \
  -H 'Sec-Fetch-Mode: cors' \
  -H 'Sec-Fetch-Site: same-origin' \
  -H 'User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/107.0.0.0 Safari/537.36' \
  -H 'accept: */*' \
  -H 'content-type: application/json' \
  -H 'sec-ch-ua: "Google Chrome";v="107", "Chromium";v="107", "Not=A?Brand";v="24"' \
  -H 'sec-ch-ua-mobile: ?0' \
  -H 'sec-ch-ua-platform: "macOS"' \
  --data-raw '{"operationName":"SendTokenGift","variables":{"e":"UJfUx05OooLVLeaLzurAD7t0ycf7qHV57YPA64hWOh5Nslk4cNv5GCO5UIhUfygGimZNaBMDaQF7CWigSoxuOG4KmX6PBg7Nw/BxK3lCQ/MeVM8H3VRD7RIv7A9H4Zt+z/43c25jpTuaQrjLpxrWXzNYORIKJRjga9ZUGPCbNwatxYFMuVGEJcn8SZxFdd2rr1HMsQV2HXhl1PcILcXZ5fcnu7+VARIIj26snB4TOiQ=","iv":"yLelD2PBybOSK8LM","giftId":114,"liveStreamId":"sOuGkqrHrOs","count":1,"comboKey":"IZLFwC_9lDBi2YL6_1668754497884","giftToken":"CkMQj7b0hwIaNIECAoICgwLHAgmLAowCjQIOENsBnAGfAt8B4AEhoQLhAakCKXFysgLyAfYBtwL3AfgB+QEgNCi36OokEIzc0szIMBqQARbIi9FshY8J3yb72Pi3Kf3b4VlRZ8dHHr2d64OWA545YQ6SBsTaqA6ERQ9DQbGDCXK3L5MoVtVL/wy4cLlD+XTMYIYjEYUU/0IwTbvhrTXWdll64SIP1APvRQXCjDugMBShDAqlMCBPqREhchX0t8tXHhYO2h+h6k3+kwe3yAdSioapP7i5NxtuLxCFTYPiVA=="},"query":"mutation SendTokenGift($e: String, $iv: String, $giftId: Int, $liveStreamId: ID, $count: Int, $comboKey: String, $giftToken: String) {\n  sendTokenGift(e: $e, iv: $iv, giftId: $giftId, liveStreamId: $liveStreamId, count: $count, comboKey: $comboKey, giftToken: $giftToken) {\n    result\n    ksCoin\n    styleType\n    __typename\n  }\n}\n"}' \
  --compressed -iv
```

å“åº”

```json
{
  "data": {
    "sendTokenGift": {
      "result": 1,//æˆåŠŸ
      "ksCoin": 0,
      "styleType": null,
      "__typename": "SendGiftResult"
    }
  }
}
```

å¿«æ‰‹ç»™ç«¯ä¸Šçš„æ¥å£ä½¿ç”¨çš„[graphql](https://spec.graphql.org/draft/)ç»Ÿä¸€ä¸­å¿ƒåŒ–äº†å…¥å£ï¼Œæ–¹ä¾¿åç»­è§„èŒƒåŒ–ç®¡ç†æ¥å£ï¼›æ•´ä½“äº¤äº’ä¹Ÿæœ‰äº›å·®åˆ«ï¼Œä¸€ä¸ªæ˜¯åç½®åˆ¤æ–­ï¼Œä¸€ä¸ªæ˜¯å‰ç½®åˆ¤æ–­ç¤¼ç‰©æ˜¯å¦å¯ä»¥èµ é€ï¼Œä½†æ˜¯å¯¹äºèµ é€ç¤¼ç‰©æ¥å£è¿˜æ˜¯éœ€è¦åˆ¤æ–­æ˜¯å¦æ»¡è¶³èµ é€çš„é‡‘é¢ï¼›å‰ç½®å¯¹äºç”¨æˆ·ä½“éªŒä¼šå¥½äº›ï¼Œå°‘äº†äº›äº¤äº’å§; æ¥å£æ•°æ®éƒ½æœ‰tokenåŠ å¯†éªŒè¯ï¼Œé˜²æ­¢ä¸‰æ–¹é»‘äº§ä¸­é€”æ‹¦æˆªï¼Œåè€…å¯¹æ•´ä½“èµ é€æ•°æ®ä¹Ÿæ˜¯å‹ç¼©åŠ å¯†äº†(ç”¨æˆ·è¡Œä¸ºæ‰“ç‚¹æ•°æ®ä¹Ÿæ˜¯å‹ç¼©ä¸ŠæŠ¥çš„)ï¼›

Tips: è²Œä¼¼ç¤¼ç‰©çš„ä»·æ ¼åœ¨å„ä¸ªç›´æ’­å¹³å°éƒ½ä¸€æ ·çš„ï¼Œä¸åƒå•†å“ä»·æ ¼æœ‰ç›¸å¯¹æ³¢åŠ¨ï¼Œåªæ˜¯ä¼šæœ‰äº›ç›´æ’­åœºæ™¯å®šåˆ¶åŒ–çš„ç¤¼ç‰©ï¼Œæœ‰ç§éç†æ€§æƒ…æ„Ÿå†²åŠ¨æ¶ˆè´¹çš„æ„Ÿè§‰ï¼Œæç›´æ’­ç±»ç”¨æˆ·äº§å“ï¼Œç¤¾ä¼šå¿ƒç†å­¦è²Œä¼¼æŒºé‡è¦çš„ï¼Œè€é“å¸¦ä¸€æ³¢èŠ‚å¥ 666ï½



### è®¾è®¡

#### æ•´ä½“è®¾è®¡æœåŠ¡æ¨¡å—æµç¨‹

![](https://raw.githubusercontent.com/weedge/mypic/master/%E7%9B%B4%E6%92%AD%E4%BA%92%E5%8A%A8-%E8%B5%A0%E9%80%81%E7%A4%BC%E7%89%A9%E8%AE%BE%E8%AE%A1.drawio.png)



#### DB

**gift ç¤¼ç‰©è¡¨**ï¼šæœ‰é™é›†ï¼Œè¿™ä¸ªç‰©æ–™æ•°ç›®æ˜¯å›ºå®šçš„ï¼Œæ²¡æœ‰SKUè¿™ä¸€æ¦‚å¿µï¼Œå¯ä»¥ç›´æ¥å®šä¹‰å¥½é…ç½®ä¹‹åï¼Œç›´æ¥å­˜æ”¾åœ¨æ•°æ®åº“ä¸­ï¼›ä¾¿äºåç»­ç¼“å­˜è‡³è¿œç«¯æˆ–è€…æœåŠ¡æœ¬åœ°ï¼›

| å­—æ®µ         | ç±»å‹      | æè¿°                                          |
| ------------ | --------- | --------------------------------------------- |
| giftId       | int64     | UK  å”¯ä¸€é”®                                    |
| name         | string    | ç¤¼ç‰©åç§°                                      |
| currencyCn   | int       | ä»·æ ¼ï¼šè™šæ‹Ÿè´§å¸æ•°ç›®                            |
| unit         | int       | è™šæ‹Ÿè´§å¸åº¦é‡å•ä½ï¼Œå¯¹åº”èµ„äº§ç±»å‹ï¼šé‡‘å¸/é’»çŸ³/Xå¸ |
| giftCategory | string    | ç¤¼ç‰©ç±»åˆ«                                      |
| iconUrl      | string    | ç¤¼ç‰©iconåœ°å€                                  |
| sendRule     | string    | èµ é€è§„åˆ™                                      |
| effectsUrl   | string    | ç¤¼ç‰©ç‰¹æ•ˆåœ°å€                                  |
| createdAt    | timestamp | åˆ›å»ºæ—¶é—´                                      |
| updatedAt    | timestamp | æ›´æ–°æ—¶é—´                                      |



**user_asset ç”¨æˆ·æ‹¥æœ‰çš„è™šæ‹Ÿèµ„äº§è¡¨**ï¼š  ç”¨æˆ·å½“å‰æ‹¥æœ‰çš„è™šæ‹Ÿå¸ä½™é¢ï¼Œ å»ºåº“å»ºè¡¨æŒ‰ç…§userIdè¿›è¡Œhash åˆ†åº“åˆ†è¡¨åˆ†åŒº/åˆ†ç‰‡(Region) (å†™æ›´æ–°çƒ­ç‚¹) æ•°æ®é‡æŒ‰ä¸­å›½æ€»äººå£è®¡ç®—ï¼Œä¸€å¼ ç‰©ç†è¡¨å­˜æ”¾1000wæ•°æ®

| å­—æ®µ      | ç±»å‹      | æè¿°                                          |
| --------- | --------- | --------------------------------------------- |
| userId    | int64     | ç”¨æˆ·id                                        |
| assetCn   | int       | èµ„äº§æ•°é‡                                      |
| assetType | int       | èµ„äº§ç±»å‹ 1. é‡‘å¸ 2.é’»çŸ³ 3. Xå¸ ~~4. Xä¼˜æƒ å·~~ |
| version   | int64     | æ›´æ–°ç‰ˆæœ¬                                      |
| createdAt | timestamp | åˆ›å»ºæ—¶é—´                                      |
| updatedAt | timestamp | æ›´æ–°æ—¶é—´                                      |

```sql
/* local mysql innodb(index B+TREE) */
create database `pay{$dbpartitions}`
CREATE TABLE `pay{$dbpartitions}`.`user_assert`
(
    `userId` bigint unsigned NOT NULL DEFAULT '0',
    `assetCn` bigint unsigned NOT NULL DEFAULT '0',
    `assetType` tinyint unsigned NOT NULL DEFAULT '0',
    `version` bigint unsigned NOT NULL DEFAULT '0',
    `createdAt` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `updatedAt` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY `uk_user_assertType` (`userId`,`assetType`)
) ENGINE=InnoDB  DEFAULT CHARSET=utf8mb4 partition by hash ( `userId` ) partitions 16;
create table `pay{$dbpartitions}`.`user_assert${tbpartitions}` like  `user_assert`;


/* create table add this for tidb tikv(index LSM-TREE) */
/* eg: partitions*2^min(SHARD_ROW_ID_BITS,PRE_SPLIT_REGIONS) = 128 regions, echo regions 96MB(compressed) */
/* if don't use regions, those regions will be recycled */
/*T! SHARD_ROW_ID_BITS=4 PRE_SPLIT_REGIONS=3 */
CREATE TABLE `user_asset`
(
    `userId` bigint unsigned NOT NULL DEFAULT '0',
    `assetCn` bigint unsigned NOT NULL DEFAULT '0',
    `assetType` tinyint unsigned NOT NULL DEFAULT '0',
    `version` bigint unsigned NOT NULL DEFAULT '0',
    `createdAt` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `updatedAt` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY `uk_user_assetType` (`userId`,`assetType`)
) DEFAULT CHARSET=utf8mb4 SHARD_ROW_ID_BITS=4 PRE_SPLIT_REGIONS=3 partition by hash ( `userId` ) partitions 16;
show table user_asset regions;


/* create db table for polardb-x innodb(index B+TREE) */
/* PARTITION_MODE drds/sharding (db,table), auto/partitioning use partitioning */
/* create database `pay` PARTITION_MODE=sharding; */
create database `pay` PARTITION_MODE=partitioning;
CREATE TABLE `pay`.`user_asset`
(
    `userId` bigint unsigned NOT NULL DEFAULT '0',
    `assetCn` bigint unsigned NOT NULL DEFAULT '0',
    `assetType` tinyint unsigned NOT NULL DEFAULT '0',
    `version` bigint unsigned NOT NULL DEFAULT '0',
    `createdAt` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `updatedAt` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY `uk_user_assetType` (`userId`,`assetType`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 partition by hash ( `userId` ) partitions 128;
/*dbpartition by hash(`userId`) tbpartition by hash(`userId`) tbpartitions 16*/

show table info from `pay`.`user_asset`;
show topology from `pay`.`user_asset`;
show rule from `pay`.`user_asset`;
SHOW NODE;
show db status;
show table status;
```

å¯¹äº**å•ä¸ªç”¨æˆ·èµ„äº§ä¿®æ”¹**ï¼›å¦‚æœå­˜åœ¨ **select èµ„äº§ï¼Œç„¶åæ ¹æ®ä¸åŒäº§å“ç­–ç•¥è¿›è¡Œä¸šåŠ¡é€»è¾‘è®¡ç®—å‡ºæ›´æ–°åèµ„äº§ï¼Œæœ€åupdate æ›´æ–°** åœºæ™¯ï¼Œåœ¨å¹¶å‘åœºæ™¯ä¸‹ï¼Œä¸‰ç§æ–¹å¼ï¼š

1. æœåŠ¡ç›´æ¥é€šè¿‡åˆ†å¸ƒå¼é”æ¥å¤„ç†ï¼Œè¿™ç§æ–¹å¼ä¸èƒ½é˜²ä½å…¶ä»–å…¶ä»–æœåŠ¡æˆ–è€…è„šæœ¬ç›´æ¥æ“ä½œæ•°æ®åº“çš„æƒ…å†µï¼Œé™¤éåœ¨æ“ä½œä¹‹å‰ä¹Ÿå»è·å–ä¸€æ¬¡é”ï¼Œè€Œä¸”å¼•å…¥å¤–éƒ¨ä¾èµ–ï¼›å¯ä»¥è€ƒè™‘è‡ªä¸¾æ–¹å¼ï¼ŒæœåŠ¡èµ„æºå®ä¾‹è‡ªå·±æ¥ä¸Šé”ï¼›

2. æ‚²è§‚é” select for updateäº‹åŠ¡å®ç°

 ```sql
SET AUTOCOMMIT=0; 
BEGINï¼›
	a = SELECT assetCn FROM user_asset WHERE userId={$userId} and assetType={$assetType} FOR UPDATE;  
	update user_asset set assetCn=a.assetCn+{$incrCn} where userId={$userId} and assetType={$assetType}; 
COMMIT;
 ```

3. ä¹è§‚é” CASçš„æ–¹å¼ï¼Œæ²¡æœ‰æ›´æ–°ç»§ç»­å¾ªç¯ï¼Œç›´åˆ°æ›´æ–°ok

```sql
a = SELECT assetCn FROM user_asset WHERE userId={$userId} and assetType={$assetType};
#$oldAssetCn = a.assetCn
#$newAssetCn = a.assetCn+$incrCn
#if $newAssetCn>=0 ->update
update user_asset set assetCn={$newAssetCn} where userId={$userId} and assetType={$assetType} and assetCn = {$oldAssetCn} 
```

å­˜åœ¨ABAé—®é¢˜ï¼š

> è€ƒè™‘å¦‚ä¸‹æ“ä½œï¼š
>
> å¹¶å‘1ï¼ˆä¸Šï¼‰ï¼šè·å–å‡ºæ•°æ®çš„åˆå§‹å€¼æ˜¯Aï¼Œåç»­è®¡åˆ’å®æ–½CASä¹è§‚é”ï¼ŒæœŸæœ›æ•°æ®ä»æ˜¯Açš„æ—¶å€™ï¼Œä¿®æ”¹æ‰èƒ½æˆåŠŸ
>
> å¹¶å‘2ï¼šå°†æ•°æ®ä¿®æ”¹æˆB
>
> å¹¶å‘3ï¼šå°†æ•°æ®ä¿®æ”¹å›A
>
> å¹¶å‘1ï¼ˆä¸‹ï¼‰ï¼šCASä¹è§‚é”ï¼Œæ£€æµ‹å‘ç°åˆå§‹å€¼è¿˜æ˜¯Aï¼Œè¿›è¡Œæ•°æ®ä¿®æ”¹
>
> å¹¶å‘1åœ¨ä¿®æ”¹æ•°æ®æ—¶ï¼Œè™½ç„¶è¿˜æ˜¯Aï¼Œä½†å·²ç»ä¸æ˜¯åˆå§‹æ¡ä»¶çš„Aäº†ï¼Œä¸­é—´å‘ç”Ÿäº†Aå˜Bï¼ŒBåˆå˜Açš„å˜åŒ–ï¼Œæ­¤Aå·²ç»éå½¼Aï¼Œæ•°æ®å´æˆåŠŸä¿®æ”¹ï¼Œå¯èƒ½å¯¼è‡´é”™è¯¯
>
> ABAé—®é¢˜å¯¼è‡´çš„åŸå› ï¼Œæ˜¯CASè¿‡ç¨‹ä¸­åªç®€å•è¿›è¡Œäº†â€œå€¼â€çš„æ ¡éªŒï¼Œå†æœ‰äº›æƒ…å†µä¸‹ï¼Œâ€œå€¼â€ç›¸åŒä¸ä¼šå¼•å…¥é”™è¯¯çš„ä¸šåŠ¡é€»è¾‘ï¼ˆä¾‹å¦‚åº“å­˜ï¼‰ï¼Œæœ‰äº›æƒ…å†µä¸‹ï¼Œâ€œå€¼â€è™½ç„¶ç›¸åŒï¼Œå´å·²ç»ä¸æ˜¯åŸæ¥çš„æ•°æ®äº†ã€‚

åŠ ä¸Šç‰ˆæœ¬å­—æ®µversion, å¯¹ç‰ˆæœ¬è¿›è¡ŒCASæ›´æ–°

```sql
a = SELECT assetCn,version FROM user_asset WHERE userId={$userId} and assetType={$assetType};
#$oldAssetCn = a.assetCn
#$oldVersion = a.version
#$newAssetCn = a.assetCn+$incrCn
#if $newAssetCn>=0 ->update
#$newVersion = $oldVersion+1
update user_asset set assetCn={$newAssetCn} and version={$newVersion} where userId={$userId} and assetType={$assetType} and version = {$oldVersion} 
```

æƒ³ä¸€æƒ³ï¼šmysqlä¸ºäº†é«˜å¯ç”¨å’Œè¯»å†™åˆ†ç¦»ï¼Œç”Ÿäº§ç¯å¢ƒéƒ¨ç½²çš„å®ä¾‹é›†ç¾¤æ˜¯ä¸»ä»æ¶æ„ï¼Œå­˜åœ¨ä¸»ä»å»¶è¿Ÿï¼Œå…¶å®è¿™ä¸ªæ˜¯ä¸å½±å“çš„ï¼Œæœ€ç»ˆéƒ½æ˜¯CASçš„updateæ›´æ–°ï¼Œæ›´æ–°æˆåŠŸä¼šè¿”å›affect rowsä¸º1ï¼Œæ²¡æœ‰æ›´æ–°åˆ™ä¸º0ï¼›

Notice: 

1. select for update åŠ æ’æ–¥é”å’Œæ‰€å»ºçš„ç´¢å¼•æœ‰å…³(é—´éš”(gap)é”ï¼Œä¸´é”®(next-key)é”ï¼Œé”è¡Œ/è¡¨)

2. å¦‚æœä½¿ç”¨mongodbæ¥å­˜æ”¾ï¼Œç›´æ¥ä½¿ç”¨findAndModifyæ¥æ“ä½œå³å¯ï¼Œå½“ç„¶é˜²æ­¢é‡å¤æ•°æ®ï¼Œéœ€è¦åŠ å”¯ä¸€ç´¢å¼•(é”æ–‡æ¡£)

**user_asset_record ç”¨æˆ·è™šæ‹Ÿå¸äº¤æ˜“æµæ°´è¡¨**ï¼šè®°å½•è™šæ‹Ÿå¸å¢åŠ å’Œå‡å°‘æ•°æ®è¯¦æƒ…ï¼Œè¿™ä¸ªæä¾›åå°æŸ¥çœ‹ï¼Œç”¨äºé‡å¤è¯·æ±‚å¹‚ç­‰å¤„ç†ï¼Œ å»ºåº“å»ºè¡¨æŒ‰ç…§userIdè¿›è¡Œhash åˆ†åº“åˆ†è¡¨åˆ†åŒº / åˆ†ç‰‡(Region)ï¼› (å†™æ’å…¥çƒ­ç‚¹) , notice: è¿™é‡Œå†—ä½™è®¾è®¡äº†ï¼Œå¯ä»¥æŒ‰ç…§ç¬¬ä¸‰èŒƒå¼ï¼Œä¸€ä¸ªäº‹ä»¶æœ‰å¤šäººå‚ä¸ï¼Œä¸€ä¸ªäººå¯ä»¥å‚ä¸å¤šä¸ªäº‹ä»¶ï¼Œåˆ†å‡ºä¸€ä¸ªç”¨æˆ·äº‹ä»¶å…³è”è¡¨(user_event)ï¼Œä¸€ä¸ªäº‹ä»¶è¡¨(event_record)ï¼›ä¸»è¦æ˜¯æ–¹ä¾¿æŒ‰ç”¨æˆ·ç»´åº¦è·å–æµæ°´è®°å½•ï¼›è¿™é‡Œå¦‚æœæ ‡å‡†å­—æ®µæ¢æˆå­˜æ”¾æ“ä½œç”¨æˆ·opUserå’Œæ¥å—ç”¨æˆ·toUserï¼Œå¦‚æœæŒ‰ç…§opUserç»´åº¦æ‹†åˆ†ï¼ŒæŸ¥è¯¢toUserçš„æµæ°´æ•°æ®å°±ä¸æ–¹ä¾¿ï¼Œè™½ç„¶polardb-xå¯ä»¥ä½¿ç”¨[å…¨å±€äºŒçº§ç´¢å¼•](https://help.aliyun.com/document_detail/311522.html)æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä½†æ˜¯æ¢ä¸ªå»ºè¡¨ç»´åº¦æ€è·¯æ—¢å¯ä»¥æ»¡è¶³å½“å‰è¿™ä¸ªä¸šåŠ¡åœºæ™¯ï¼ŒåŒæ—¶ä¹Ÿé€šç”¨ç»Ÿä¸€ä½¿ç”¨userIdè¿›è¡Œæ‹†åˆ†ï¼Œå¦‚æœæ˜¯ToBåœºæ™¯ï¼Œå¯ä»¥ä½¿ç”¨ç§Ÿæˆ·id(tenantId)åˆ†åº“(ç‰©ç†åº“)ï¼Œç”¨æˆ·userIdåˆ†è¡¨ï¼Œè¿™é‡ŒToCåœºæ™¯ç”¨æˆ·ç»´åº¦ï¼Œç›´æ¥userIdåˆ†åŒºå³å¯ã€‚

| å­—æ®µ       | ç±»å‹      | æè¿°                                                         |
| ---------- | --------- | ------------------------------------------------------------ |
| userId     | int64     | ç”¨æˆ·id                                                       |
| opUserType | int64     | 1.æ“ä½œè€…ï¼Œ2.æ¥æ”¶è€…                                           |
| bizId      | int64     | ç›´æ’­åœºæ™¯ï¼šroomIdï¼Œå……å€¼åœºæ™¯ï¼šè®¢å•Id                           |
| bizType    | int       | ä¸šåŠ¡ç±»å‹ï¼š1.ç›´æ’­äº’åŠ¨ï¼Œ2.å……å€¼                                 |
| eventId    | string    | äº‹ä»¶Id: ç›´æ’­äº’åŠ¨åœºæ™¯ä¸‹ï¼Œäº’åŠ¨äº‹ä»¶id ç”¨äºè´¯å½»æ•´ä¸ªé€ç¤¼ç‰©æµæ°´é“¾è·¯,è¿›è¡Œå¹‚ç­‰å¤„ç†; ç”¨æˆ·å……å€¼åœºæ™¯ä¸‹ï¼Œè®¢å•äº‹ä»¶id,  UUID |
| eventType  | string    | äº‹ä»¶ç±»å‹ï¼ŒinteractGift,  orderApple, orderWX, orderAlipay, orderDouyin |
| objId      | string    | æ“ä½œå¯¹è±¡id, giftId, transactionId/outOrderNo                 |
| record     | string    | è®°å½•è¡Œä¸º                                                     |
| recordOp   | string    | æ“ä½œè®°å½• è™šæ‹Ÿå¸å¢åŠ å’Œå‡å°‘                                    |
| createdAt  | timestamp | åˆ›å»ºæ—¶é—´                                                     |
| updatedAt  | timestamp | æ›´æ–°æ—¶é—´                                                     |

```sql
/* local mysql innodb(index B+TREE) */
create table `pay{$dbpartitions}`.`user_assert_record`
(
    `userId` bigint unsigned not null default '0',
    `opUserType` tinyint unsigned not null default '0',
    `bizId` bigint unsigned not null default '0',
    `bizType` tinyint unsigned not null default '0',
    `objId` varchar(128) not null default '',
    `eventId` varchar(128) not null default '',
    `eventType` varchar(128) not null default '',
    `record` varchar(256) not null default '',
    `recordOp` varchar(64) not null default '',
    `createdAt` timestamp not null  DEFAULT CURRENT_TIMESTAMP,
    `updatedAt` timestamp not null default CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY `uk_user_opUserType_event` (`userId`,`opUserType`,`eventId`)
)engine=InnoDB default charset=utf8mb4 partition by hash(`userId`) PARTITIONS 16 ;
create table `pay{$dbpartitions}`.`user_assert_record${tbpartitions}` like  `user_assert_record`;


/* create table add this for tidb tikv(index LSM-TREE) */
/* eg: partitions*2^min(SHARD_ROW_ID_BITS,PRE_SPLIT_REGIONS) = 256 regions, echo regions 96MB(compressed) */
/* if don't use regions, those regions will be recycled */
/*T! SHARD_ROW_ID_BITS=4 PRE_SPLIT_REGIONS=5 */
create table `pay`.`user_asset_record`
(
    `userId` bigint unsigned not null default '0',
    `opUserType` tinyint unsigned not null default '0',
    `bizId` bigint unsigned not null default '0',
    `bizType` tinyint unsigned not null default '0',
    `objId` varchar(128) not null default '',
    `eventId` varchar(128) not null default '',
    `eventType` varchar(128) not null default '',
    `record` varchar(256) not null default '',
    `recordOp` varchar(64) not null default '',
    `createdAt` timestamp not null  DEFAULT CURRENT_TIMESTAMP,
    `updatedAt` timestamp not null default CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY `uk_user_opUserType_event` (`userId`,`opUserType`,`eventId`)
)engine=InnoDB default charset=utf8mb4 SHARD_ROW_ID_BITS=4 PRE_SPLIT_REGIONS=5
    PARTITION BY HASH (`userId`) PARTITIONS 16;
show table user_asset_record regions;


/* create db table for polardb-x innodb(index B+TREE) or tokudb(index Fractal tree) or x-engine(index LSM-TREE) ,for this scene use innodb */
/* PARTITION_MODE drds/sharding (db,table), auto/partitioning use partitioning */
/* create database `pay` PARTITION_MODE=sharding; */
create database `pay` PARTITION_MODE=partitioning;
create table `pay`.`user_asset_record`
(
    `userId` bigint unsigned not null default '0',
    `opUserType` tinyint unsigned not null default '0',
    `bizId` bigint unsigned not null default '0',
    `bizType` tinyint unsigned not null default '0',
    `objId` varchar(128) not null default '',
    `eventId` varchar(128) not null default '',
    `eventType` varchar(128) not null default '',
    `record` varchar(256) not null default '',
    `recordOp` varchar(64) not null default '',
    `createdAt` timestamp not null  DEFAULT CURRENT_TIMESTAMP,
    `updatedAt` timestamp not null default CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY `uk_user_opUserType_event` (`userId`,`opUserType`,`eventId`)
)engine=InnoDB /*tokudb/xengine*/ default PARTITION BY HASH (`userId`) PARTITIONS 256;
/*dbpartition by hash(`userId`) tbpartition by hash(`userId`) tbpartitions 16*/

show table info from `pay`.`user_asset_record`;
show topology from `pay`.`user_asset_record`;
show rule from `pay`.`user_asset_record`;
SHOW NODE;
show db status;
show table status;
```

èµ„æºè¯„ä¼°ï¼šç”¨æŠ–éŸ³çœ‹ä¸‹å¡å¡”å°”ä¸–ç•Œæ¯ï¼Œæ”¯æŒä¸‹æ¢…è€æ¿çš„é˜¿æ ¹å»·ğŸ‡¦ğŸ‡·é˜Ÿç›´æ’­ï¼Œå»ä¼°ç®—ä¸‹å§ï½ï½

Tips: é‡‡ç”¨åˆ†å¸ƒå¼æ•°æ®åº“ï¼Œå¯¹å…¶èµ„æºè¯„ä¼°ï¼Œå»ºè¡¨ï¼Œç´¢å¼•ï¼Œäº‹åŠ¡ï¼ŒæŸ¥è¯¢ä¼˜åŒ–ç­‰æ“ä½œï¼›è¯·å‚è€ƒè§„èŒƒå’Œæœ€ä½³å®è·µï¼š[tibd æœ€ä½³å®è·µ](https://docs.pingcap.com/zh/tidb/stable/tidb-best-practices) [TiDB é«˜å¹¶å‘å†™å…¥åœºæ™¯æœ€ä½³å®è·µ](https://docs.pingcap.com/zh/tidb/stable/high-concurrency-best-practices) [tidbå¼€å‘è§„èŒƒ](https://cn.pingcap.com/best-practice-detail/best-practices-for-developing-applications-with-tidb) [palordb-xæœ€ä½³å®è·µ](https://help.aliyun.com/document_detail/308293.html) ;

é¢˜å¤–è¯ï¼šTidb åº•å±‚å­˜å‚¨tikvåˆ†ç‰‡é‡‡ç”¨çš„èŒƒå›´åˆ†ç‰‡ï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®šåˆ†ç‰‡æ•°ï¼Œé»˜è®¤1ä¸ªï¼Œå½“tikvä¸Šä¸€ä¸ªregionå†™æ»¡äº†ï¼Œä¼šåŠ¨æ€åˆ†è£‚å‡ºä¸€ä¸ªæ–°çš„region, å¯ä»¥æå‰åˆ†é…å¥½åˆ†ç‰‡æ•°ï¼Œä»¥é˜²æ½®æ±æµé‡çƒ­ç‚¹å†™å…¥ï¼Œæ¯”å¦‚è¿™é‡Œçš„çƒ­é—¨ä¸»æ’­èµ„äº§ä¿¡æ¯ï¼Œä»¥åŠèµ„äº§æµæ°´è®°å½•ï¼Œé€šè¿‡é…ç½® SHARD_ROW_ID_BITS å‚æ•°é€šè¿‡tidbè‡ªèº«æœåŠ¡éšè—ROW_ID hashæ‰“æ•£å†™å…¥çƒ­ç‚¹ï¼Œç±»ä¼¼mrä»»åŠ¡æ•°æ®å€¾æ–œæ—¶çš„å†æ¬¡hashæ‰“æ•£ï¼Œä¸redis/ç¨‹åºä¸­çš„map rehashä¸åŒï¼Œredis rehashè§£å†³ç¢°æ’æŸ¥æ‰¾æ•ˆç‡ä½å’Œç©ºé—´ä½¿ç”¨ç‡ä½é—®é¢˜ï¼Œé€šè¿‡loadFactoré˜ˆå€¼ï¼Œè§¦å‘æ‰©å®¹å’Œç¼©å®¹ï¼Œgolangä¸­map rehashä»…è§¦å‘æ‰©å®¹ï¼Œè¿™é‡Œæ‰€è°ˆçš„æ˜¯æµé‡å€¾æ–œå¯¼è‡´è´Ÿè½½ä¸å‡è¡¡é‡æ–°rehashï¼› è€Œpolardb-xçš„è´Ÿè½½æ‰©å®¹ åˆ™ç±»ä¼¼äºredisçš„rehashæœºåˆ¶æ‰©å®¹ï¼Œæ•°æ®å€¾æ–œçš„é—®é¢˜æ˜¯ä¸èƒ½é€šè¿‡æ‰©å®¹æ¥è§£å†³ï¼Œå¯å‚è€ƒ[polardb-xå¦‚ä½•åˆ†ææ•°æ®åˆ†å¸ƒä¸å‡è¡¡](https://help.aliyun.com/document_detail/309469.html)ã€‚

åœ¨æ”¯ä»˜ä¸­å°ï¼ŒæŸä¸ªäº’åŠ¨æ¶‰åŠåˆ°å¤šä¸ªç”¨æˆ·èµ„äº§çš„å˜æ›´ï¼Œéœ€è¦æŠŠå¤šä¸ªå†™æ“ä½œå…³è”åˆ°ä¸€ä¸ªæœ¬åœ°äº‹åŠ¡è¿›è¡Œå¤„ç†ï¼Œä¿è¯æ•°æ®æ‰£å‡å’Œå¢å‡ä¸€è‡´ï¼Œéœ€è¦å¼€å¯æœ¬åœ°äº‹åŠ¡æ¥å¤„ç†å¤šè¡¨æ•°æ®ï¼›ä»¥ä¸‹gistä¸ºå¹¶å‘mysqlæœ¬åœ°äº‹åŠ¡å¤„ç†æµ‹è¯•demo

{{< gist weedge 1700dd7053a87a4ab35ba4fce0ebea6a >}}

{{< gist weedge fd731ce8549cd99ccfc9491f6025ae8e >}}



#### Cache

##### keyè®¾è®¡ï¼š

| åç§°                     | key                                                     | type        | value            | ex   | æ˜¯å¦é¢‘ç¹æ›´æ–° | è¯´æ˜                                                         |
| ------------------------ | ------------------------------------------------------- | ----------- | ---------------- | ---- | ------------ | ------------------------------------------------------------ |
| ç”¨æˆ·è™šæ‹Ÿèµ„äº§ä¿¡æ¯         | I.asset.{userId}.{assetType.string()}                   | string/hash | user_asset(json) | 1 d  | Y            | type: String vs Hash tradeoff <br />1. String å¯¹äºredisè¯»è¯¦æƒ…æ•°æ®æ•ˆç‡é«˜ï¼Œä½†æ˜¯å†™æ“ä½œèµ„äº§æ•°ç›®éœ€è¦json decode/encode get/setï¼Œå¦‚æœæ“ä½œæ˜¯åœ¨ä¸šåŠ¡åº”ç”¨é€»è¾‘æœåŠ¡å™¨ä¸Šæ“ä½œå¯ä»¥ä½¿ç”¨(æœ‰å¯¹åº”ä¼˜åŒ–jsonåº“)ï¼Œç»“åˆwatch+äº‹åŠ¡casæ–¹å¼; <br />2. Hash ç›¸å¯¹stringè¯»è¯¦æƒ…æ•°æ®æ•ˆç‡ä½äº›ï¼Œä½†æ˜¯å†™æ“ä½œèµ„äº§æ•°ç›®ä»…éœ€hincrby(hget/hset)æ“ä½œå³å¯ï¼Œå¦‚æœæ“ä½œæ˜¯åœ¨æ•°æ®ä¸­å¿ƒredisä¸Šæ‰§è¡Œluaè„šæœ¬åŸå­æ“ä½œå¯ä»¥ä½¿ç”¨ï¼Œredis lua ä½¿ç”¨cjsonåº“ç›¸å¯¹è§£ææ•ˆç‡ä½äº›ï¼Œç‰¹åˆ«æ˜¯å¤§jsonï¼Œå‚è€ƒ[sproto](https://blog.codingnow.com/2014/07/sproto.html)ï¼Œå¹¶å‘é‡å¤§å®¹æ˜“å¢åŠ redisæ•°æ®ä¸­å¿ƒè´Ÿè½½ï¼Œé™ä½ååï¼› ç»“åˆå…·ä½“åœºæ™¯ä½¿ç”¨(å°½é‡è®¡ç®—å­˜å‚¨åˆ†ç¦») |
| ç¤¼ç‰©ä¿¡æ¯                 | I.gift.{giftId}                                         | string      | gift(json)       | 7 d  | N            |                                                              |
| ç”¨æˆ·ä¿¡æ¯                 | I.user.{userId}                                         | string      | user(json)       | 1 d  | N            |                                                              |
| ç›´æ’­é—´ä¿¡æ¯               | I.room.{roomId}                                         | string      | room(json)       | 1 d  | N            |                                                              |
| è·å–ç”¨æˆ·è™šæ‹Ÿèµ„äº§åˆ†å¸ƒå¼é” | L.asset.{userId}.{tag}   <br />(tag:assetType.String()) | string      | token            | 60 s | N            | APå‹é”ï¼ŒåŠ é”å•ä¸ªçº¿ç¨‹ä»dbä¸­è·å–æ•°æ®å†™å…¥ç¼“å­˜ï¼Œåˆå§‹åŒ–é€ç¤¼ç”¨æˆ·èµ„äº§ä¿¡æ¯ï¼Œé”çš„æ˜¯çƒ­æ›´æ–°èµ„æºï¼›å­˜åœ¨æ•°æ®å¤åˆ¶çš„å»¶è¿Ÿå¯èƒ½å¸¦æ¥çš„æ•°æ®å†™åè¯»ï¼ˆread-after-writeï¼‰ä¸ä¸€è‡´é—®é¢˜ï¼Œæ‰€ä»¥**ä»followerè¯»å–æ•°æ®å¿…é¡»æ˜¯å¼ºä¸€è‡´æ€§è¯»(tidbæ”¯æŒ)/å…¨å±€ä¸€è‡´æ€§è¯»(polardb-xæ”¯æŒ)ï¼Œå¦åˆ™ä»leader/masterä¸Šè¯»å–**ï¼›<br />è¿™é‡Œä½¿ç”¨redlockï¼Œå¦‚æœè¿è¡Œé”å¤±æ•ˆå¤šæ¬¡è¯»å†™å…¥ç¼“å­˜å¹‚ç­‰æ“ä½œ,ç«äº‰æ¡ä»¶æ˜¯å¯ä»¥æ¥å—ï¼Œç›´æ¥ç”¨å•é›†ç¾¤å®ä¾‹redlockå°±è¡Œï¼›å¦åˆ™éœ€è¦å¤šé›†ç¾¤redlockåŠ é”ï¼Œå…·ä½“è¯¦æƒ…ï¼š[distributed-locks](https://redis.io/docs/manual/patterns/distributed-locks/) PS: ç±»ä¼¼ä½¿ç”¨æ•°æ®åº“é”ä¹Ÿå¯ä»¥ä½¿ç”¨redlockç®—æ³•æ¥å®ç°åˆ†å¸ƒå¼å¯é åŠ é”;  é”çš„ç²’åº¦ï¼Œå¯ä»¥å…ˆåˆ†æ•£åˆ°æœ¬åœ°é”(éœ€è¦åŠ ç­‰å¾…è¶…æ—¶æ—¶é—´ï¼Œé˜²æ­¢å¤¯ä¸»æœåŠ¡ï¼Œè¶…æ—¶ä¸Šæ¸¸å¯ä»¥é‡è¯•)ï¼Œç„¶ååˆ†å¸ƒå¼é”åªæœ‰å•ä¸ªçº¿ç¨‹è·å–æ•°æ®å»è®¾ç½®ç¼“å­˜ï¼Œé™ä½åˆ†å¸ƒå¼é”çš„ç«äº‰ï¼Œæœ€å¤šéƒ¨ç½²è¿›ç¨‹å®ä¾‹æ•°ç›®ç«äº‰,é«˜å¹¶å‘åœºæ™¯ä¸‹å¾ˆå¤§å¹…åº¦å‡å°‘ç½‘ç»œIOã€‚ å¦‚ä¸‹åœºæ™¯ï¼š**å¾ˆå¤šè§‚ä¼—ç»™çƒ­é—¨å¥³ä¸»æ’­é€ç¤¼ç‰©ï¼Œè¿™ä¸ªå¥³ä¸»æ’­åŒæ—¶ç»™çƒ­é—¨ç”·ä¸»æ’­é€ç¤¼ç‰©** |
| èµ„äº§å˜æ›´æ¶ˆæ¯             | M.asset.{userId}.{eventId}                              | string      | 1                | 1 d  | N            | 1. ä¿è¯å¹‚ç­‰ï¼šç±»ä¼¼Once done åŸå­æ“ä½œ(eventäº‹åŠ¡ç»´åº¦)ï¼› <br />2.äº‹åŠ¡æ¶ˆæ¯å›è°ƒRCå¯è§(åŸå­æ“ä½œ) |
|                          |                                                         |             |                  |      |              |                                                              |

èµ„æºè¯„ä¼°ï¼šç”¨æŠ–éŸ³çœ‹ä¸‹å¡å¡”å°”ä¸–ç•Œæ¯ï¼Œæ”¯æŒä¸‹æ¢…è€æ¿çš„é˜¿æ ¹å»·ğŸ‡¦ğŸ‡·é˜Ÿç›´æ’­ï¼Œå»ä¼°ç®—ä¸‹å§ï½ï½

å¹¶å‘åœºæ™¯ï¼š

1. ç¼“å­˜ä»dbä¸­è·å–

2. é¢‘ç¹å¢/å‡ç”¨æˆ·è™šæ‹Ÿèµ„äº§ç¼“å­˜å­˜é‡æ•°æ®

çƒ­key:

1. ç”¨æˆ·ç»´åº¦çš„ç”¨æˆ·è™šæ‹Ÿèµ„äº§ä¿¡æ¯ï¼Œé€šè¿‡userIdè¿›è¡Œåˆ†æ•£å³å¯ï¼Œ å¦‚æœå¤šç”¨æˆ·/ç§Ÿæˆ· å¯¹ å…±äº«ç¼“å­˜èµ„æºé¢‘ç¹æ“ä½œ(æ¯”å¦‚ ä¼˜æƒ å·/å•†å·)ï¼Œçªç ´äº†å•rediså®ä¾‹çš„è¯»å†™ç“¶é¢ˆï¼Œéœ€è¦å¯¹keyè¿›è¡Œå†æ¬¡åˆ‡åˆ†ï¼›å¦‚æœæ˜¯è¯»å¤šåœºæ™¯ï¼Œæ›´æ–°ä¸é¢‘ç¹ç¼“å­˜å¯ä»¥ç¼“å­˜åœ¨æœ¬åœ°æœåŠ¡è¿›ç¨‹ä¸­ï¼›

å¤§key:

1. å­˜æ”¾çš„valueå€¼æ¯”è¾ƒå¤§ï¼Œä¸€èˆ¬æ˜¯list, setï¼Œzset, hashè¿™äº›é›†åˆç»“æ„ï¼Œå­˜å‚¨çš„item/fieldæ•°ç›®ä¸€èˆ¬åœ¨5000ä¸ªå·¦å³ï¼Œéœ€è¦æŒ‰æ¯”ä¾‹åˆ‡åˆ†ï¼Œè¯»æ”¾å¤§çš„é—®é¢˜å¯ä»¥å¹¶å‘æ§åˆ¶è¯»å–ï¼›

watch+äº‹åŠ¡ï¼ŒluaåŸå­æ“ä½œ demoä»£ç å¦‚ä¸‹ï¼š

{{< gist weedge 2b473c5baf0ac59d8d0c8b1ddc5692f5 >}}

{{< gist weedge c2d830dceef4163acc6dd749a05493db >}}

#### æ¶ˆæ¯é˜Ÿåˆ—

##### Topic

| åç§°                     | è¯»/å†™é˜Ÿåˆ—æ•°  | æ¶ˆæ¯ç±»å‹ | æ¶ˆæ¯key | æ¶ˆæ¯tag                         | è¯´æ˜             |
| ------------------------ | ------------ | -------- | ------- | ------------------------------- | ---------------- |
| TOPIC_ASSET_CHANGE_EVENT | default: 8/8 | äº‹åŠ¡æ¶ˆæ¯ | eventId | {eventType} ( \|\| é—´éš”å¤šä¸ªtag) | ç”¨æˆ·äº‹ä»¶èµ„äº§å˜æ›´ |
|                          |              |          |         |                                 |                  |

Tips: 

1. topic tag: é•¿åº¦ä¸èƒ½è¶…è¿‡ 127 (Byte.MAX_VALUE )ï¼›
2. è¯»å†™é˜Ÿåˆ—æ•°ç”±æ¶ˆè´¹é›†ç¾¤å’Œç”Ÿäº§é›†ç¾¤ååé‡å†³å®šï¼Œå¼€å‘å¯ä»¥ä½¿ç”¨é»˜è®¤8/8ï¼›
3. äº‹åŠ¡æ¶ˆæ¯ä¸æ”¯æŒæ‰¹é‡ç”Ÿäº§å’Œå»¶æ—¶ç”Ÿäº§ï¼Œå³ä½¿åœ¨ç”Ÿäº§ä¾§è®¾ç½®å»¶æ—¶å‘é€äº‹åŠ¡æ¶ˆæ¯ï¼Œrocketmq 4.7.0ä¹‹åçš„ä¸ä¼šç”Ÿæ•ˆï¼Œ[commit](https://github.com/GenerousMan/rocketmq/commit/5a584d056a07350911954dd269bb1ee5c80dfd11) ;
4. [RocketMQäº‹åŠ¡æ¶ˆæ¯æ”¹è¿›](https://github.com/apache/rocketmq/wiki/RIP-50-RocketMQ-Transaction-Message-Improvement) è¿™ä¸ªæ”¹è¿›ææ¡ˆæš‚æ—¶è¿˜æœªå‘å¸ƒï¼›

##### Message

| å­—æ®µ        | ç±»å‹   | è¯´æ˜                                                        |
| ----------- | ------ | ----------------------------------------------------------- |
| eventId     | string | å˜æ›´äº‹ä»¶id                                                  |
| opUserId    | int64  | æ“ä½œè€…id                                                    |
| eventType   | string | å˜æ›´äº‹ä»¶ç±»å‹ï¼ŒinteractGift                                  |
| messageBody | string | æ¶ˆæ¯æ•°æ®ï¼Œæ›´å…·æ¶ˆæ¯äº‹ä»¶ç±»å‹å®šä¹‰ï¼Œæ ¼å¼å¯ä»¥ä¸ºjson ä»¥ä¾¿è·Ÿè¸ªæŸ¥çœ‹ |

producer GroupName/GroupID: P_GID_GIFT_ASSET_CHANGE

consumer GroupName/GroupID: C_GID_GIFT_ASSET_CHANGE   5.0ç‰ˆæœ¬å°½é‡é‡‡ç”¨[POP consumeræ¨¡å¼](https://mp.weixin.qq.com/s/UFWULymSblrs1hIGP5e7YQ) , æ¯”å¦‚æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤åˆ‡æ¢æˆ`POP`æ¨¡å¼ï¼š

```shell
./mqadmin setConsumeMode -c DefaultCluster -t test -g testGroup -m POP -n namesrv:9876
```

æ¶ˆæ¯å¤§å°ä¸èƒ½è¶…è¿‡4M, å¯å‚è€ƒ [5.0ç‰ˆé™åˆ¶](https://help.aliyun.com/document_detail/440347.html)

æ¶ˆæ¯é‡è¯•é»˜è®¤16æ¬¡, è®¾ç½®é‡è¯•å»¶è¿Ÿçº§åˆ«(level)ï¼Œè®¾ç½®çš„å»¶è¿Ÿçº§åˆ«ä¸‹æ ‡(level-1)å¦‚ä¸‹å»¶è¿Ÿæ•°ç»„`delayLevelArray`ï¼š

`[1s, 5s, 10s, 30s, 1m, 2m, 3m, 4m, 5m, 6m, 7m, 8m, 9m, 10m, 20m, 30m, 1h, 2h]`

å¦‚æœä¸åœ¨æŒ‡å®šå»¶è¿Ÿçº§åˆ«å†…ï¼Œä½¿ç”¨é»˜è®¤ `delayLevelArray[2:]`å»¶è¿Ÿæ•°ç»„ä¾æ¬¡é‡è¯•16æ¬¡ï¼›

##### æ¶ˆè´¹ä¾§éœ€è¦å…³æ³¨çš„å‚æ•°

| åç§°                       | é»˜è®¤ | è¯´æ˜                                                         |
| -------------------------- | ---- | ------------------------------------------------------------ |
| pullBatchSize              | 32   | æ¯æ¬¡å‘èµ·pullè¯·æ±‚åˆ°brokerï¼Œå®¢æˆ·ç«¯éœ€è¦æŒ‡å®šä¸€ä¸ªæœ€å¤§batch sizeï¼Œè¡¨ç¤ºè¿™ä¸€æ¬¡æ‹‰å–æ¶ˆæ¯æœ€å¤šæ‰¹é‡æ‹‰å–å¤šå°‘æ¡ï¼›èŒƒå›´åœ¨ [1,1024]; ä¸ºäº†æé«˜ååï¼Œä¸€èˆ¬éƒ½å¤§äº1 |
| consumeMessageBatchMaxSize | 1    | æ‰¹é‡æ¶ˆè´¹çš„æœ€å¤§æ¶ˆæ¯æ¡æ•°ï¼›èŒƒå›´åœ¨ [1,1024]ï¼›å¦‚æœæ¶ˆè´¹é€»è¾‘æ”¯æŒæ‰¹é‡å¤„ç†ï¼Œå¯ä»¥è®¾ç½®å€¼å¤§äº1ï¼› å¤„ç†ä¸šåŠ¡é€»è¾‘çš„æ‰¹é‡msgsçš„æœ€å¤§å¤§å°æ˜¯consumeMessageBatchMaxSizeå’ŒpullBatchSizeçš„è¾ƒå°å€¼ã€‚ |
| maxReconsumeTimes          | -1   | -1 é»˜è®¤16æ¬¡é‡è¯•ï¼›0æˆ–è€…å°äº-1 ä¸é‡è¯•ï¼›å¤§äº0ï¼Œåˆ™ä¸ºè®¾ç½®çš„é‡è¯•æ¬¡æ•° |
|                            |      |                                                              |

æ¶ˆè´¹ä¾§ä»broker pull messageæµç¨‹ï¼š

```
NewPushConsumer -> GetOrNewRocketMQClient -> GetOrNewRocketMQClient-> æ³¨å†ŒRegisterRequestFunc  ReqResetConsumerOffsetäº‹ä»¶çš„å›è°ƒfunc -> è§¦å‘ resetOffset -> ResetOffset-> resume -> doBalance -> updateProcessQueueTableå†™å…¥æ‹‰å»è¯·æ±‚åˆ°prCHä¸­

Start -> RegisterConsumer -> start
å¼‚æ­¥ select è½®è®­ä»prChä¸­è·å–æ‹‰å»è¯·æ±‚pr -> å¼‚æ­¥ pullMessage(pr)->
	å¼‚æ­¥ select è½®è®­å¤„ç†prä¸­çš„å¤„ç†é˜Ÿåˆ—å’Œæ¶ˆæ¯é˜Ÿåˆ— submitToConsume(pr.pq, pr.mq) (ä¸€ä¸ªæ˜¯é¡ºåºorderlyå¤„ç†ï¼Œä¸€ä¸ªæ˜¯æ™®é€šcurrentlyå¤„ç†)
	
	->pq.putMessage(msgs)ä»brokerä¸­è¯·æ±‚çš„æ¶ˆæ¯æ”¾å…¥å¤„ç†é˜Ÿåˆ—ä¸­çš„msgChä¸­
	
	->æ™®é€šå¤„ç†consumeMessageCurrently() -> pq.getMessages ä»å¤„ç†é˜Ÿåˆ—ä¸­çš„msgChä¸­è·å–æ¶ˆæ¯-> 
		æ‹‰å–åˆ°çš„ä¸€æ‰¹æ¶ˆæ¯ä¼šæ‹†åˆ†æˆNï¼ˆå–å†³äºconsumeMessageBatchMaxSizeï¼‰ä¸ªå°æ‰¹æ¶ˆæ¯subMsgs -> 
		å¼‚æ­¥ consumeInner(ctx,subMsgs) -> è°ƒç”¨ä¸šåŠ¡å®šä¹‰çš„å›è°ƒä¸šåŠ¡å‡½æ•°callback.f(ctx, subMsgs...)->
	å¤„ç†å®Œæˆè¿”å›å“åº”
```

å¯¹äºæ™®é€šæ¶ˆæ¯çš„å¤„ç†ï¼Œå¯ä»¥çœ‹å‡ºæ‰¹é‡æ‹‰å»æ‹†åˆ†æˆN(PullBatchSize/min(ConsumeMessageBatchMaxSize,PullBatchSize))ä¸ªæ‰¹é‡msgs, æ¯æ¬¡è·å–æ‰¹é‡msgså¤„ç†éƒ½æ˜¯å¹¶å‘çš„ï¼Œä¸ä¼šç›¸äº’ç­‰å¾…ï¼›æ‹‰å®Œä¸€æ‰¹è§¦å‘åç§»äº‹ä»¶ç»§ç»­æ‹‰å»ä¸‹ä¸€æ‰¹åˆ°æœ¬åœ°pré˜Ÿåˆ—ä¸­ï¼Œç›´åˆ°brokeré˜Ÿåˆ—ä¸­æ²¡æœ‰å¯æ¶ˆè´¹çš„æ•°æ®ï¼›é‡è¯•æœ‰å¯¹åº”topicé‡è¯•é˜Ÿåˆ—ä¸ä¼šé˜»å¡å½“å‰topicé˜Ÿåˆ—çš„æ­£å¸¸æ¶ˆè´¹ï¼›

å…¶ä»–å‚è€ƒï¼š[å®¢æˆ·ç«¯é…ç½®è¯¦è§£](https://zhuanlan.zhihu.com/p/27397055)

##### RocketMQ é‡è¯•, æ­»ä¿¡, ç³»ç»Ÿ Topic

| åç§°                           | è¯´æ˜                                                         |      |
| ------------------------------ | ------------------------------------------------------------ | ---- |
| %RETRY%C_GID_GIFT_ASSET_CHANGE | å¯¹åº”æ¶ˆè´¹ç»„é‡è¯•topicï¼Œé‡è¯•æ¬¡æ•°é»˜è®¤16æ¬¡                        |      |
| %DLQ%C_GID_GIFT_ASSET_CHANGE   | å¯¹åº”æ¶ˆè´¹ç»„æ­»ä¿¡é˜Ÿåˆ—topic, è¶…è¿‡é‡è¯•æ¬¡æ•°æ”¾å…¥è¯¥é˜Ÿåˆ—ä¸­            |      |
| SCHEDULE_TOPIC_XXXX            | å»¶è¿Ÿæ¶ˆæ¯é˜Ÿåˆ—topic                                            |      |
| *TBW102*                       | é»˜è®¤ç”¨äºåˆ›å»ºä¸å­˜åœ¨topicæ—¶ä½¿ç”¨è¿™ä¸ªé»˜è®¤topicæ¥åˆ›å»º             |      |
| RMQ_SYS_TRACE_TOPIC            | å¼€å¯æ¶ˆæ¯è·Ÿè¸ªçš„topic ç”¨äºæ¶ˆæ¯è½¨è¿¹                             |      |
| RMQ_SYS_TRANS_HALF_TOPIC       | è®°å½•æ‰€æœ‰çš„åŠäº‹åŠ¡æ¶ˆæ¯ï¼Œæ¶ˆè´¹ç«¯ä¸å¯è§                           |      |
| RMQ_SYS_TRANS_OP_HALF_TOPIC    | è®°å½•å·²ç»COMMITæˆ–ROLLBACKçš„åŠäº‹åŠ¡æ¶ˆæ¯ï¼Œtagsæ˜¯"d" é€»è¾‘åˆ é™¤     |      |
| TRANS_CHECK_MAX_TIME_TOPIC     | æœªçŸ¥çŠ¶æ€çš„äº‹åŠ¡æ¶ˆæ¯è¶…è¿‡æœ€å¤§å›æŸ¥æ¬¡æ•°ï¼Œé»˜è®¤15æ¬¡ï¼Œä¼šå­˜åœ¨è¿™ä¸ªé˜Ÿåˆ— |      |

å…·ä½“ç”Ÿäº§ï¼Œæ¶ˆè´¹ç”¨æˆ·èµ„äº§äº‹åŠ¡æ¶ˆæ¯demoå¦‚ä¸‹: (demoä¸­ä½¿ç”¨ [rocketmq-client-go](https://github.com/apache/rocketmq-client-go) **å®¢æˆ·ç«¯ç”Ÿäº§æ¶ˆè´¹é…ç½®äº† traceï¼Œrocketmq brokerä¹Ÿéœ€è¦é…ç½®traceTopicEnable=trueï¼Œç”¨äºæŸ¥çœ‹æ¶ˆæ¯è½¨è¿¹**ï¼›é™¤æ­¤ä¹‹å¤–ï¼Œå¯ä»¥åœ¨æ¶ˆæ¯å±æ€§ä¸­åŠ ä¸Šå…¨é“¾è·¯è¿½è¸ªçš„traceIdï¼Œç”¨äºæ•´ä½“ç³»ç»ŸæœåŠ¡è¿›è¡Œä¸²è”ï¼Œå¦‚æœæƒ³æŠŠrocketmqå®¢æˆ·ç«¯ç”Ÿäº§å’Œæ¶ˆè´¹åŠ å…¥OTELè¿›è¡Œå…¨é“¾è·¯è¿½è¸ª, å¯ä»¥å‚è€ƒ **[kafka-otel-sarama](https://github.com/open-telemetry/opentelemetry-go-contrib/tree/main/instrumentation/github.com/Shopify/sarama/otelsarama)** å®ç°ä¸éš¾)

{{< gist weedge fcbc8e4a2889c6230d62f6f35de6862d >}}

{{< gist weedge 37839a2fcb3c11f77228ce43a713dee7 >}}

#### API

å‰å°ç»Ÿä¸€å…¥å£æ¥å£å‚æ•°å®‰å…¨éªŒè¯

æ¥å£å…¬å…±å“åº” BaseResp

| å­—æ®µ    | ç±»å‹               | è¯´æ˜                       |
| ------- | ------------------ | -------------------------- |
| errCode | int                | é”™è¯¯ç ï¼Œ0ä»£è¡¨æˆåŠŸï¼Œé0é”™è¯¯ |
| errMsg  | string             | é”™è¯¯ä¿¡æ¯                   |
| extra   | Map<string,string> | é¢å¤–ä¿¡æ¯                   |

errCodeåˆ†é…ï¼š

| æœåŠ¡ | åˆ†é…èŒƒå›´      | è¯´æ˜ |
| ---- | ------------- | ---- |
| äº’åŠ¨ | [10000,20000) |      |
| æ”¯ä»˜ | [20000,30000) |      |
| æ¶ˆæ¯ | [30000,40000) |      |

äº’åŠ¨ä¸­å°ï¼š

1. èµ é€ç¤¼ç‰©æ¥å£
2. è·å–ç›´æ’­é—´ç¤¼ç‰©åˆ—è¡¨æ¥å£

æ”¯ä»˜ä¸­å°ï¼š

1. **å˜æ›´ç”¨æˆ·è™šæ‹Ÿèµ„äº§æ¥å£**

BizAssetChangesReq è¯·æ±‚ï¼š(æ‰¹é‡å¹¶å‘æ§åˆ¶ç»Ÿä¸€æ”¶æ•›è‡³æ”¯ä»˜ä¸­å°ï¼Œè°ƒç”¨æ–¹æ— é¡»å¹¶å‘è·å–)

| å­—æ®µ            | ç±»å‹                        | è¯´æ˜             |
| :-------------- | --------------------------- | ---------------- |
| bizAssetChanges | list<\BizEventAssetChange/> | ä¸šåŠ¡èµ„äº§å˜æ›´åˆ—è¡¨ |

BizEventAssetChange

| å­—æ®µ              | ç±»å‹                | è¯´æ˜                                                         |
| ----------------- | ------------------- | ------------------------------------------------------------ |
| eventId           | string              | æ“ä½œäº‹ä»¶id                                                   |
| opUserId          | int64               | æ“ä½œè€…id                                                     |
| eventType         | string              | äº‹ä»¶ç±»å‹: interactGift,  orderApple, orderWX, orderAlipay, orderDouyin |
| bizId             | int64               | ä¸šåŠ¡åœºæ™¯id: ç›´æ’­(roomId), å……å€¼(orderId)                      |
| bizType           | int                 | ä¸šåŠ¡ç±»å‹ 1.ç›´æ’­ï¼Œ2.å……å€¼                                      |
| objId             | string              | æ“ä½œå¯¹è±¡id, giftId, transactionId/outOrderNo                 |
| opUserAssetChange | UserAssetChangeInfo | æ“ä½œç”¨æˆ·èµ„äº§å˜æ›´                                             |
| toUserAssetChange | UserAssetChangeInfo | å¯¹æ–¹ç”¨æˆ·èµ„äº§å˜æ›´                                             |

UserAssetChangeInfo

| å­—æ®µ      | ç±»å‹  | è¯´æ˜                |
| --------- | ----- | ------------------- |
| userId    | int64 | ç”¨æˆ·id              |
| assetType | int   | èµ„äº§ç±»å‹            |
| incr      | int   | +å¢åŠ /-å‡å°‘å¤šå°‘èµ„äº§ |
|           |       |                     |

BizAssetChangesResp å“åº”

| å­—æ®µ                  | ç±»å‹                            | è¯´æ˜             |
| --------------------- | ------------------------------- | ---------------- |
| bizAssetChangeResList | list<\BizEventAssetChangerRes/> | èµ„äº§å˜æ›´ç»“æœåˆ—è¡¨ |
| baseResp              | BaseResp                        | å…¬å…±å“åº”ä¿¡æ¯     |

BizEventAssetChangerRes

| å­—æ®µ        | ç±»å‹      | è¯´æ˜             |
| ----------- | --------- | ---------------- |
| eventId     | string    | æ“ä½œäº‹ä»¶id       |
| opUserAsset | UserAsset | æ“ä½œè€…çš„ç”¨æˆ·èµ„äº§ |
| changeRes   | bool      | 1 æˆåŠŸï¼Œ 0 å¤±è´¥  |
| failMsg     | string    | å¤±è´¥ä¿¡æ¯         |

UserAsset

| å­—æ®µ      | ç±»å‹  | è¯´æ˜     |
| --------- | ----- | -------- |
| userId    | int64 | ç”¨æˆ·id   |
| assetType | int   | èµ„äº§ç±»å‹ |
| assetCn   | int   | èµ„äº§æ•°   |

2. è·å–ç”¨æˆ·è™šæ‹Ÿèµ„äº§æ¥å£

3. è·å–ç”¨æˆ·èµ„äº§å˜æ›´æµæ°´æ¥å£
4. **æ›´æ–°æ•°æ®åº“ä¸­çš„ç”¨æˆ·èµ„äº§ æ¶ˆè´¹é€»è¾‘**

æ¶ˆæ¯æœåŠ¡ï¼š https://weedge.github.io/post/jxzbim/



### å¼€å‘

å€ŸåŠ©å¼€æºå·¥å…·ï¼Œä»0åˆ°1å¼€å§‹æ­å»ºè“å›¾ï¼Œ>1ç”±ä¸šåŠ¡é©±åŠ¨å®å›¾

1. æ­å»ºæœ¬åœ°åŸºç¡€ç¯å¢ƒï¼Œtidb/polardb-x, redis, rocketmq 1d

   ```shell
   #just for mac os local brew install
   brew install redis
   brew install mysql
   #list services to view is ok 
   brew services list
   ```

   ```yaml
   #redis-cluster-single-docker-compose.yaml
   #https://github.com/bitnami/bitnami-docker-redis-cluster/issues/3
   version: "3"
   name: "single-redis-cluster"
   services:
     redis-cluster:
       image: grokzen/redis-cluster:latest
       ports:
         - "26379-26384:26379-26384"
       environment:
         - "INITIAL_PORT=26379"
         - "MASTERS=3"
         - "SLAVES_PER_MASTER=1"
         - "SENTINEL=false"
         - "REDIS_CLUSTER_IP=0.0.0.0"
         - "IP=0.0.0.0"
         - "BIND_ADDRESS=0.0.0.0"
   ```

   ```shell
   # redis-cluster docker local deploy
   docker-compose -f redis-cluster-single-docker-compose.yaml up -d
   # check cluster state is ok 
   redis-cli -c -p 26379 cluster info
   
   # rocketmq docker local deploy    
   # https://github.com/apache/rocketmq-docker
   git clone https://github.com/apache/rocketmq-docker.git
   cd image-build
   sh build-image.sh 5.0.0 alpine
   cd ..
   sh stage.sh 5.0.0
   cd stages/5.0.0
   # change data/broker/conf/broker.conf add brokerIP1={localIp}, add traceTopicEnable=true
   # docker run -d -v `pwd`/data/broker/logs:/home/rocketmq/logs -v `pwd`/data/broker/store:/home/rocketmq/store -v `pwd`/data/broker/conf/broker.conf:/opt/rocketmq-5.0.0/conf/broker.conf --name rmqbroker --link rmqnamesrv:namesrv -e "NAMESRV_ADDR=namesrv:9876" -p 10909:10909 -p 10911:10911 -p 10912:10912 apache/rocketmq:5.0.0${TAG_SUFFIX} sh mqbroker -c /opt/rocketmq-5.0.0/conf/broker.conf
   # run simple single node docker
   ./play-docker.sh alpine
   
   # rocketmq dashboard local deploy
   docker pull apacherocketmq/rocketmq-dashboard:latest
   docker run -d --name rocketmq-dashboard -e "JAVA_OPTS=-Drocketmq.namesrv.addr={localIp}:9876" -p 8181:8080 -t apacherocketmq/rocketmq-dashboard:latest
   # view http://127.0.0.1:8181/
   
   #tidb local deploy
   # notice:
   # docker is not support
   # u should use deploy local tidb by tiup tool
   # see this https://docs.pingcap.com/tidb/dev/quick-start-with-tidb
   tiup playground
   
   #polardb-x docker local deploy by pxd tool
   #see this 
   
   pxd tryout
   ```

2. æµ‹è¯•demo, redis clusteré›†ç¾¤ä¸‹çš„ç¼“å­˜äº‹åŠ¡å’Œ tidbåˆ†å¸ƒå¼ç¼“å­˜äº‹åŠ¡ï¼Œrocketmq åˆ†å¸ƒå¼æ¶ˆæ¯äº‹åŠ¡ï¼›

3. æ ¸å¿ƒæœåŠ¡æ¨¡å—å¼€å‘æ”¯ä»˜ä¸­å°æ¥å£ 

4. ç¼–å†™makefile, dockerfile, æ‰“åŒ…æˆdockeré•œåƒï¼Œ æ•´ä½“è§£å†³æ–¹æ¡ˆä¾èµ–ç»„ä»¶ä¹Ÿå¯ä»¥é€šè¿‡docker-composeéƒ¨ç½²è‡³dockerå®¹å™¨ä¸­

5. ç¼–å†™ç›¸å…³k8sèµ„æº (configmap,secret,deployment+service,ingress)é€šè¿‡minikube/kind éƒ¨ç½²è‡³æœ¬åœ°k8sé›†ç¾¤ 

6. å°†æœåŠ¡ç½‘æ ¼åŒ–istio(xdsæµæ§, å¯ç”¨äºå…¨é“¾è·¯ç›‘æ§, A/Bæµ‹è¯•ï¼Œç‰¹åˆ«æ˜¯äº§å“æ–°ç‰¹æ€§/æ¨¡å‹ç­–ç•¥åœºæ™¯)  (like this: https://mp.weixin.qq.com/s/SAn-H5p53IfvSy_Y3Mcz_Q)

7. k8s/istio operator

å¼€æºå¼€å‘æ¡†æ¶å’Œç»„ä»¶é€‰æ‹©(åœ¨æ ‡å‡†åŒ–ï¼Œè§„èŒƒæ¨¡å—åŒ–çš„å‰æä¸‹ï¼Œå°½é‡è‡ªåŠ¨åŒ–ï¼Œæé«˜ç ”å‘æ•ˆèƒ½ï¼Œfocus on æ ¸å¿ƒä¸šåŠ¡é€»è¾‘)

1. å¼€å‘è¯­è¨€ï¼šgolang + lua5.1([redis lua debugging](https://redis.io/docs/manual/programmability/lua-debugging/)) + shell 

2. å¼€å‘æ¡†æ¶ï¼š[kitex](https://www.cloudwego.io/zh/docs/kitex/overview/)(ç»Ÿä¸€è§„èŒƒåŒ–äº†RPCæ¡†æ¶ï¼Œæ”¯æŒgRPCå’Œthriftçš„è„šæ‰‹æ¶ï¼Œå¸¸æ”¯æŒå†…éƒ¨å¾®æœåŠ¡ï¼Œæ³›åŒ–è°ƒç”¨+ proxyless xdsæµæ§, å‚è€ƒ[brpc](https://mp.weixin.qq.com/s/G8vmlJyaimux_K-548kFbA)) + [hertz](https://www.cloudwego.io/zh/docs/hertz/overview/)(httpåè®®æ¡†æ¶ï¼Œå¸¸æ”¯æŒå¤–éƒ¨ä¸šåŠ¡å‰/åå°, æ•°æ®æ¸²æŸ“,è¯·æ±‚æ ¡éªŒ)

3. DBï¼šmysql, é«˜å¯ç”¨é›†ç¾¤æ–¹æ¡ˆï¼šä¸æ¨èè‡ªå»ºsharding+proxyçš„æ–¹å¼ï¼›æ¨èä½¿ç”¨æ”¯æŒmysqlåè®®çš„åˆ†å¸ƒå¼æ•°æ®åº“ï¼Œä¸”æ— éœ€åœ¨ä¸šåŠ¡ä»£ç ä¸­è€ƒè™‘åˆ†åº“åˆ†è¡¨æ“ä½œï¼Œä»¥åŠåˆ†åº“åˆ†è¡¨çš„åˆ†å¸ƒå¼äº‹åŠ¡ï¼›æ¯”å¦‚ï¼šå¼€æºæ–¹æ¡ˆ [tidb](https://docs.pingcap.com/zh/)(shared nothing,scale out)ï¼Œäº‘å‚å•†ï¼š[polardb-x](https://polardbx.com/document) (shared nothing, scale out)/[aurora mysql](https://docs.aws.amazon.com/zh_cn/AmazonRDS/latest/AuroraUserGuide/Aurora.AuroraMySQL.html) (shared disk, scale up, auroraç›¸å…³è§£è¯»å¯ä»¥çœ‹ä¸‹[mit 6.824 Cloud Replicated DB, Aurora](youtube.com/watch?v=jJSh54J1s5o)),   [gorm](https://gorm.io/)

   Tips: å¯¹åº”åˆ†å¸ƒå¼äº‹åŠ¡æ“ä½œtidbæœ‰æ‰€ä¸åŒï¼Œtidbå’ŒåŸç”Ÿçš„mysql innodbå¼•æ“äº‹åŠ¡æ“ä½œsqlè¯­å¥æœ‰äº›åŒºåˆ«: [tidb transaction](https://docs.pingcap.com/zh/tidb/dev/transaction-overview), [tidb-gorm-sample](https://docs.pingcap.com/zh/tidb/dev/dev-guide-sample-application-golang)ï¼›[polardb-x åˆ†å¸ƒå¼äº‹åŠ¡](https://doc.polardbx.com/features/topics/distributed-transaction.html) å’Œ aurora åˆ™åŸç”Ÿæ”¯æŒäº‹åŠ¡æ“ä½œsqlè¯­å¥;

4. Cache:  redis, é«˜å¯ç”¨é›†ç¾¤æ–¹æ¡ˆ å¼€æºæ–¹æ¡ˆ[redis-cluster](https://redis.io/docs/management/scaling/), [redis-cluster-proxy](https://github.com/RedisLabs/redis-cluster-proxy)ï¼›äº‘å‚å•†proxyä»£ç†æ–¹å¼ï¼š[é˜¿é‡Œäº‘redis](https://help.aliyun.com/document_detail/52228.html),  æˆ–è€…æ”¯æŒredis clusteråè®® åº•å±‚åˆ©ç”¨rocksdb/leveldb ä½œä¸ºkvå­˜å‚¨å¼•æ“çš„å¼€æºæ–¹æ¡ˆï¼Œæ¯”å¦‚[kvrocks](https://github.com/apache/incubator-kvrocks)(watchå‘½ä»¤æš‚æœªæ”¯æŒï¼Œå¯ä»¥ä½¿ç”¨luaè„šæœ¬å‘½ä»¤),  [go-redis](https://redis.uptrace.dev/guide/)

5. MQ: rocketMQ, [rocketmq-client-go](https://github.com/apache/rocketmq-client-go),  å¦‚æœä½¿ç”¨é˜¿é‡Œäº‘rocketMQä½¿ç”¨å¯¹åº”[client SDK](https://github.com/apache/rocketmq-clients/tree/master/golang) (producerå·²æ”¯æŒå…¨éƒ¨æ¶ˆæ¯ç±»å‹)

6. æœåŠ¡ç¼–æ’æµé‡æ²»ç†ï¼š[k8s](https://kubernetes.io/zh-cn/docs/home/) + [istio](https://istio.io/latest/docs/) 

tips: åœ¨æœ¬åœ°å¼€å‘ï¼Œå¯ä»¥é€šè¿‡docker compose æœ¬åœ°éƒ¨ç½²ï¼› è¿˜å¯ä»¥é€šè¿‡docker+minikube/kind+helm æ¥éƒ¨ç½²æœ¬åœ°èŠ‚ç‚¹çš„å¤špodé›†ç¾¤ç‰ˆæœ¬æ•°æ®åº“(mysql/tidb/polardb-x)ï¼Œredis-clusterï¼Œä»¥åŠé›†ç¾¤ç‰ˆrocketMQï¼›ä»¥åŠå¼€å‘å®Œä¸šåŠ¡æœåŠ¡åº”ç”¨åï¼Œä¹Ÿå¯ä»¥éƒ¨ç½²åœ¨æœ¬åœ°podçš„å®¹å™¨ä¸­, ä»¥ä¾¿åç»­CI/CDè‡ªåŠ¨åŒ–é›†æˆéƒ¨ç½²è‡³å¤šäº‘å®¹å™¨æœåŠ¡/è‡ªæ‰˜ç®¡çš„å®¹å™¨æœåŠ¡ä¸­ï¼Œå…·ä½“å¯å‚è€ƒ[k8s ci/cd](https://jimmysong.io/kubernetes-handbook/practice/ci-cd.html) , GitOpså®è·µ: [github-jenkins-argo](https://cloudyuga.guru/blog/jenkins-argo) , [ä½¿ç”¨gitlab,Jenkinså’ŒArgocdå®ç°CI/CD](https://www.jokerbai.com/archives/ji-yu-jenkins-he-argocd-shi-xian-devops), [ä½¿ç”¨argo rolloutså®ç°é‡‘ä¸é›€å‘å¸ƒ](https://www.jokerbai.com/archives/shi-yong-argorollouts-shi-xian-jin-si-que-fa-bu)

æ— çŠ¶æ€æœåŠ¡å¿«é€Ÿå¼€å‘è¿­ä»£å¤§è‡´è‡ªåŠ¨åŒ–æ„å»ºéƒ¨ç½²å¦‚ä¸‹ï¼š

CI:  begin -> build(local makefile/test build, dockerfile build) -> push docker registry(è‡ªå»º[harbor](https://goharbor.io/docs/2.6.0/)æˆ–è€…äº‘æœåŠ¡) -> end  (gitlab/jenkins CI)

CD: åˆ†å¼€å‘ï¼Œæµ‹è¯•ï¼Œé¢„å‘å’Œç”Ÿäº§ç¯å¢ƒï¼Œå¼€å‘ï¼Œæµ‹è¯•ç›´æ¥å•podéƒ¨ç½²å®ä¾‹ï¼›é¢„å‘åŒpod;  ç”Ÿäº§ç¯å¢ƒåˆ™åˆ†é˜¶æ®µéƒ¨ç½²å’Œå›æ»šï¼šè“ç»¿éƒ¨ç½²/é‡‘ä¸é›€(ç°åº¦)éƒ¨ç½² ([argo CD](https://argo-cd.readthedocs.io/en/stable/), [argo Rollouts](https://argoproj.github.io/argo-rollouts/))

æœ‰çŠ¶æ€æ•°æ®å­˜å‚¨æœåŠ¡é€šè¿‡operatoréƒ¨ç½²ï¼š

polardb-x operator: https://doc.polardbx.com/operator/

Tidb-operator: https://github.com/pingcap/tidb-operator

Redis-cluster:   https://github.com/bitnami/charts/tree/main/bitnami/redis-cluster , https://kubedb.com/docs/v2022.10.18/guides/redis/clustering/redis-cluster/

RocketMQ-operator on k8s: https://github.com/apache/rocketmq-operator

é¢˜å¤–è¯ï¼šæˆ–è€…è¿›ä¸€æ­¥çš„ç›´æ¥ä½¿ç”¨æ— æœåŠ¡serverless å‡½æ•°è®¡ç®—ï¼Œå¼€æºæ–¹æ¡ˆ[**Knative**](https://www.cncf.io/online-programs/event-driven-architecture-with-knative-events/) [openfaas on k8s](https://docs.openfaas.com/deployment/kubernetes/), æˆ–è€…ä½¿ç”¨äº‘æœåŠ¡æ¯”å¦‚[aws lambda](https://aws.amazon.com/cn/campaigns/lambda/)(transform, not transport data), ä¸“æ³¨äºä¸šåŠ¡é€»è¾‘ï¼Œå‡å°‘'èƒ¶æ°´'ä»£ç ï¼Œç¼ºå°‘äº†å¼€å‘æ¡†æ¶çš„ä¾èµ–ï¼Œå¸¸ç”¨äºæ•°æ®äº‹ä»¶å¤„ç†,æ¯”å¦‚ç›´æ’­éŸ³è§†é¢‘ç¦»çº¿/å®æ—¶å¤„ç†ï¼ˆDevOps->AppOps)ï¼Œ **[AWS re:Invent 2022 - Best practices for advanced serverless developers](https://www.youtube.com/watch?v=PiQ_eZFO2GU&list=PL2yQDdvlhXf_lYR5Ntvr9V5iVYv5rcbNc&index=6)**, **[The Complete AWS SAM workshop](https://catalog.workshops.aws/complete-aws-sam/en-US)**ã€‚

**ä»£ç åœ°å€**ï¼š https://github.com/weedge/craftsman/tree/main/cloudwego

ä»£ç ç»“æ„ï¼š(æ”¾åœ¨ä¸€ä¸ªgitä»“åº“(svn)ä¸­ä¸»è¦æ˜¯ä¸ºäº†æ–¹ä¾¿æäº¤å¼€å‘æŸ¥çœ‹æ•´ä½“å¼€å‘æ¡†æ¶å“ˆï¼Œå¦‚æœæƒ³å¤šäººç©å¯ä»¥å»ºä¸ªç»„ç»‡æ‹†åˆ†å“ˆ,é€šè¿‡submoduleç»„åˆåœ¨ä¸€èµ·CP git flowï¼Œg*yhub)

```
â”œâ”€â”€ aws	-------------- use aws cloud develop, focus on biz logic by use lambda / step functions
â”‚Â Â  â””â”€â”€ cdk ------ deploy infrastructure ECS, VPC, EKS, S3, cache,db/search,mq etc for severless 
â”œâ”€â”€ cloudwego	----------------- use cloudwego framwork develop
â”‚Â Â  â”œâ”€â”€ common	----------------- biz common for idl,dto,dict enum; rpc service/client, pkg
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ idl
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ kitex_gen
â”‚Â Â  â”‚Â Â  â”‚Â Â  â”œâ”€â”€ base
â”‚Â Â  â”‚Â Â  â”‚Â Â  â”œâ”€â”€ common
â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ payment
â”‚Â Â  â”‚Â Â  â”‚Â Â      â”œâ”€â”€ base
â”‚Â Â  â”‚Â Â  â”‚Â Â      â”œâ”€â”€ da
â”‚Â Â  â”‚Â Â  â”‚Â Â      â”‚Â Â  â””â”€â”€ paymentservice
â”‚Â Â  â”‚Â Â  â”‚Â Â      â””â”€â”€ station
â”‚Â Â  â”‚Â Â  â”‚Â Â          â””â”€â”€ paymentservice
â”‚Â Â  â”‚Â Â  â””â”€â”€ pkg
â”‚Â Â  â”‚Â Â      â””â”€â”€ constants
â”‚Â Â  â”œâ”€â”€ kitex-contrib ------------------------ kitex rpc framwork contrib (add new)
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ gorm
â”‚Â Â  â”‚Â Â  â””â”€â”€ obs-opentelemetry
â”‚Â Â  â”‚Â Â      â””â”€â”€ logging
â”‚Â Â  â”‚Â Â          â””â”€â”€ zap
â”‚Â Â  â””â”€â”€ payment		---------------------------- app payment have http ui/gateway, rpc station,da service/server
â”‚Â Â      â”œâ”€â”€ bin		---- go build cmd output to bin
â”‚Â Â      â”œâ”€â”€ build	---- makefile, dockerfile,docker-compose.yml to build, run
â”‚Â Â      â”œâ”€â”€ cmd		---- main.go to load da/station/gw cmd to run
â”‚Â Â      â”‚Â Â  â”œâ”€â”€ da
â”‚Â Â      â”‚Â Â  â”œâ”€â”€ gw
â”‚Â Â      â”‚Â Â  â””â”€â”€ station
â”‚Â Â      â”œâ”€â”€ conf	---------- env biz config for local/dev/test/pre/stress/gray/prod 
â”‚Â Â      â”‚Â Â  â”œâ”€â”€ dev
â”‚Â Â      â”‚Â Â  â”œâ”€â”€ gray
â”‚Â Â      â”‚Â Â  â”œâ”€â”€ local
â”‚Â Â      â”‚Â Â  â”œâ”€â”€ pre
â”‚Â Â      â”‚Â Â  â”œâ”€â”€ prod
â”‚Â Â      â”‚Â Â  â”œâ”€â”€ stress
â”‚Â Â      â”‚Â Â  â””â”€â”€ test
â”‚Â Â      â”œâ”€â”€ data	-------------- sql data, encode/decode meta data
â”‚Â Â      â”œâ”€â”€ docs	-------------- app help doc
â”‚Â Â      â”œâ”€â”€ internal ----------- internal don't be used by out package, code biz logic
â”‚Â Â      â”‚Â Â  â”œâ”€â”€ da	------------------------ dal 
â”‚Â Â      â”‚Â Â  â”‚Â Â  â”œâ”€â”€ consumer ---- event drive consumer
â”‚Â Â      â”‚Â Â  â”‚Â Â  â”œâ”€â”€ dao      ---- db table data persistence op
â”‚Â Â      â”‚Â Â  â”‚Â Â  â”œâ”€â”€ domain   ---- domain entries, interface, errors
â”‚Â Â      â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ mocks ---- mock for test
â”‚Â Â      â”‚Â Â  â”‚Â Â  â”œâ”€â”€ model    ---- table entry model 
â”‚Â Â      â”‚Â Â  â”‚Â Â  â”œâ”€â”€ repository ---- impl domain db repository interface
â”‚Â Â      â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ mysql
â”‚Â Â      â”‚Â Â  â”‚Â Â  â””â”€â”€ usecase ----- biz logic use repositories 
â”‚Â Â      â”‚Â Â  â”œâ”€â”€ gw	------------------------ ui/gateway
â”‚Â Â      â”‚Â Â  â”‚Â Â  â””â”€â”€ middleware -------- middleware handle
â”‚Â Â      â”‚Â Â  â””â”€â”€ station -------------------- biz logic station by using cache 
â”‚Â Â      â”‚Â Â      â””â”€â”€ consumer ---- event drive consumer for cache
â”‚Â Â      â”‚Â Â      â”œâ”€â”€ domain   ---- domain entries, interface, errors
â”‚Â Â      â”‚Â Â      â”œâ”€â”€ repository ---- impl domain cache, mq produce repository interface
â”‚Â Â      â”‚Â Â      â”‚Â Â  â”œâ”€â”€ redis
â”‚Â Â      â”‚Â Â      â”‚Â Â  â”‚Â Â  â””â”€â”€ lua
â”‚Â Â      â”‚Â Â      â”‚Â Â  â””â”€â”€ rmq
â”‚Â Â      â”‚Â Â      â””â”€â”€ usecase  ----- biz logic use repositories 
â”‚Â Â      â”œâ”€â”€ manifests -------------- k8s/istio configmap,secret,deployment+service,ingress resource workload and traffic/flow control
â”‚Â Â      â”‚Â Â  â”œâ”€â”€ traffic
â”‚Â Â      â”‚Â Â  â”‚Â Â  â””â”€â”€ istio
â”‚Â Â      â”‚Â Â  â””â”€â”€ workloads
â”‚Â Â      â””â”€â”€ pkg --------------------- app common pkg
â”‚Â Â          â”œâ”€â”€ configparser
â”‚Â Â          â”œâ”€â”€ constants
â”‚Â Â          â”œâ”€â”€ injectors
â”‚Â Â          â”œâ”€â”€ subscriber
â”‚Â Â          â”œâ”€â”€ utils
â”‚Â Â          â”‚Â Â  â”œâ”€â”€ logutils
â”‚Â Â          â”‚Â Â  â””â”€â”€ netutils
â”‚Â Â          â””â”€â”€ version 
â”œâ”€â”€ kratos	----------------- use kratos framwork develop
â””â”€â”€ opentelemetry-go-contrib ----- otel go contrib just for new one, if change, it's not origin, u can fork, go mod edit -replace
```

æœåŠ¡å¯ä»¥é€šè¿‡å¤šä¸ªserviceç»„åˆæˆä¸€ä¸ªå•ä½“serverï¼Œä¹Ÿå¯ä»¥ä»ä¸€ä¸ªå•ä½“serveræ‹†åˆ†æˆå¤šä¸ªå¾®æœåŠ¡serverï¼Œä»¥ä¾¿ä¼ä¸šå†…éƒ¨ç»„ç»‡æ¶æ„æ¥è°ƒæ•´æœåŠ¡(åŸºäºä¸Šä¸‹æ–‡è½¯ä»¶æ¶æ„åŸåˆ™ **[Conway's law](https://martinfowler.com/bliki/ConwaysLaw.html)**)

æœåŠ¡å†…éƒ¨å„ä¸ªæ¨¡å—ç»„ä»¶é‡‡ç”¨DDD [clean-architecture](https://blog.cleancoder.com/uncle-bob/2012/08/13/the-clean-architecture.html) æ¶æ„ï¼Œæ¥å£éš”ç¦»å®ç°ï¼Œä¾èµ–åè½¬(**[Dependency Inversion Principle](http://en.wikipedia.org/wiki/Dependency_inversion_principle)**)ï¼Œæœ¨æœ‰å¾ªç¯ä¾èµ–ï¼Œæ—¢æ–¹ä¾¿mockï¼Œä¹Ÿæ–¹ä¾¿ç»„è£…ï¼Œgolangéƒ½æ˜¯ä»¥ç»„åˆæ–¹å¼æ¥æ„å»ºï¼Œé¢å‘å¯¹è±¡ç¼–ç¨‹è¯­è¨€ java/c++ é€šè¿‡æ¥å£/ç»§æ‰¿æ¥å®ç°å¤šæ€ï¼Œgolangåˆ™æ²¡æœ‰ç»§æ‰¿é€šè¿‡æ¥å£çš„æ–¹å¼æ¥å®ç°å¤šæ€ï¼Œå‰è€…æ˜¯è¿è¡Œæ—¶æŸ¥æ‰¾ç¼–è¯‘æ—¶ç”Ÿæˆçš„å‡½æ•°è¡¨(itable/vtable)è¿›è¡ŒåŠ¨æ€ç»‘å®šï¼Œåè€…åˆ™æ˜¯ç¼–è¯‘æ—¶æŒ‡é’ˆç›´æ¥è¿›è¡Œç»‘å®š(å®ç°æ¥å£åˆ†æŒ‡é’ˆç±»å‹å’Œç»“æ„ä½“ç±»å‹ï¼Œåè€…æœ‰å‚æ•°æ‹·è´æ“ä½œï¼Œå¼€å‘ä¸­ä½¿ç”¨å‰è€…æŒ‡é’ˆç±»å‹ï¼›ç¼–è¯‘æ—¶éç©ºinterface ifaceä¸­çš„itab.interæŒ‡å‘å¯¹åº”æ¥å£å, itab.\_type æŒ‡å‘å¯¹åº”å®ä¾‹å¯¹è±¡ä»¥åŠå‡½æ•°æ•°ç»„æŒ‡é’ˆfunæŒ‡å‘å¯¹åº”ç»“æ„å®ä½“ä¸­çš„å®ç°æ–¹æ³•ï¼›è¿è¡Œæ—¶å°†åˆå§‹åŒ–å®ä¾‹å¯¹è±¡åˆ†é…åœ¨å †ä¸­ï¼Œç„¶åå°†å®ä¾‹åŒ–å¯¹è±¡æŒ‡é’ˆèµ‹ç»™itab._type, è°ƒç”¨å¯¹åº”å®ä½“çš„å‡½æ•°æ–¹æ³•æ—¶åœ¨åˆ†é…çš„æ ˆç©ºé—´ä¸­è¿›è¡Œè¿è¡Œï¼›é€šè¿‡ [go tool complie](https://golang.google.cn/src/cmd/compile/doc.go?h=go+tool+compile) åœ¨å¯¹åº”ç¡¬ä»¶å¹³å°æŸ¥çœ‹ç¼–è¯‘çš„Plan9æ±‡ç¼–ä»£ç ä¸ºå‡†)ï¼Œä»¥ç»„åˆçš„æ–¹å¼æ„å»ºé¡¹ç›®(åŸåˆ™: **ä»»ä½•æ„é€ å‡½æ•°éƒ½ä¸åº”è°ƒç”¨å¦ä¸€ä¸ªæ„é€ å‡½æ•°**, åœ¨ç¨‹åºåˆå§‹åŒ–æ—¶è¿›è¡Œæ„é€ æ³¨å…¥å®ä½“)ï¼Œä»¥é˜²ç±»ç»§æ‰¿è¿‡åº¦æŠ½è±¡è®¾è®¡ï¼›interfaceç›¸å…³å¯å‚è€ƒï¼š[golang-oop-tutorial](https://www.toptal.com/go/golang-oop-tutorial) [go-interface](https://halfrost.com/go_interface/) [golang-assembly](https://github.com/cch123/golang-notes/blob/master/assembly.md) **[go-internals-interfaces](https://github.com/teh-cmc/go-internals/blob/master/chapter2_interfaces/README.md)** **[generics-can-make-your-go-code-slower](https://planetscale.com/blog/generics-can-make-your-go-code-slower)**

 å°½é‡ä½¿ç”¨å·¥å…·æ¥ç”Ÿæˆè§„èŒƒåŒ–ï¼Œç»“æ„åŒ–çš„ä»£ç ; å¸¸ç”¨å·¥å…·å¦‚ä¸‹ï¼š

1. [gorm-gen](https://gorm.io/gen/index.html) diyç”Ÿæˆæ•°æ®åº“æŒä¹…è®¿é—®å±‚æ¨¡å‹,å¯ä»¥ç”¨sqlæ¥æ¨æ¼”ä¸šåŠ¡é€»è¾‘ï¼Œç„¶åç›´æ¥ç”Ÿæˆå¯¹åº”daoæ“ä½œmodel/entryè¯»å†™æ–¹æ³•ï¼Œæä¾›ç»™ä¸Šå±‚repository è¿›è¡Œæ¥å£å®ä¾‹åŒ–æ³¨å…¥ï¼Œå¦‚æœä¸šåŠ¡é€»è¾‘éç®€å•çš„CURD, æä¾›ä¸€å±‚usecaseæ¥åˆ†ç¦»ä¸šåŠ¡å…·ä½“å®ç°ï¼Œä»¥åŠç»„åˆrepositoryæ¥å®ç°å…·ä½“ä¸šåŠ¡åœºæ™¯é€»è¾‘ï¼Œå®ç° domainé¢†åŸŸé©±åŠ¨ æ»¡è¶³ ä¸šåŠ¡å¯¹å†…å¯¹å¤–çš„apiæ¥å£ ä»¥åŠ äº‹ä»¶é©±åŠ¨ï¼›
2.  [wire ](https://github.com/google/wire/blob/main/docs/guide.md)ä¾èµ–æ³¨å…¥ï¼Œå°†db/cache/mq/rpc/http client -> dao, repository  -> usecase -> api/subscribe handler  -> service  => server ä¾æ¬¡æ³¨å…¥å®ä½“ç»„è£…æˆserverï¼Œæä¾›æœåŠ¡ï¼›
3. [GoMock mockgen](https://github.com/golang/mock)(golangå®˜æ–¹å‡ºå“)ï¼Œå¯ä»¥ç»“åˆ [mockery](github.com/vektra/mockery) (ç›¸å¯¹å¼€å‘å‹å¥½)å·¥å…·æ¥mock æ¥å£ ï¼Œ è¿™æ ·åœ¨å‰æœŸä¸ç”¨å®ç°å…·ä½“åœºæ™¯å®ä½“ç±»ï¼Œç›´æ¥å¯ä»¥æµ‹è¯•é©±åŠ¨(BDD/TDD)è¿›è¡Œä¸šåŠ¡é€»è¾‘æ¨æ¼”ï¼›å¯ä»¥è®¤ä¸ºå‰æœŸæ­å¼€å‘æ¡†æ¶æ¶å­ï¼Œä¸ä»…éœ€è¦æ»¡è¶³ç°åœ¨éœ€æ±‚ï¼Œè€Œä¸”éœ€è¦å¯¹åç»­æ˜“å˜éœ€æ±‚å¯è¿›è¡Œæ‰©å±•å¼€å‘ï¼Œæ— éœ€æ”¹åŠ¨ä»¥å¾€é€»è¾‘(ä¸šåŠ¡é€»è¾‘å®ä½“åˆç†æŠ½è±¡ä»¥åŠå¯¹åº”æ–¹æ³•æ¥å£)ï¼›ä¹Ÿå¯ä»¥ä½¿ç”¨hackçš„æ–¹å¼ é€šè¿‡ [gomonkey](https://bou.ke/blog/monkey-patching-in-go/) è¿›è¡Œæ‰“æ¡©æ³¨å…¥è¿›è¡Œmockï¼Œè™½ç„¶ç®€å•ç›´æ¥ï¼Œä½†æ˜¯ä¾èµ–åº•å±‚ç¼–è¯‘ç¡¬ä»¶å¹³å°æ¶æ„,æœ‰é™åˆ¶ä¸æ¨èï¼›
4. [ginkgo](https://onsi.github.io/ginkgo/) ç¼–å†™å…¬æœ‰å‡½æ•°æµ‹è¯•ç”¨ä¾‹ï¼Œè¦†ç›–ä¸šåŠ¡é€»è¾‘åˆ†æ”¯

æ€»ä¹‹ä¿æŒ **KISS** å§¿åŠ¿ï¼Œè®©å·¥å…·æ¥è§£æ”¾ç”Ÿäº§åŠ›ï¼ˆå¥½çš„å·¥å…·å¯ä»¥è§„èŒƒåŒ–å†™ä»£ç æµç¨‹, å‰ææ˜¯å·¥ç¨‹æœ€ä½³å®è·µæ²‰æ·€ï¼‰ã€‚

> Keep it simple stupid â€œK.I.S.Sâ€

é™„ï¼š[google golang style](https://google.github.io/styleguide/go/)  , [Deprecation notices in Go](https://rakyll.org/deprecated/) ,  [GOMM](https://research.swtch.com/gomm) , [Go Memory Allocator](https://medium.com/@ankur_anand/a-visual-guide-to-golang-memory-allocator-from-ground-up-e132258453ed) , [gc-guide](https://tip.golang.org/doc/gc-guide) , [garbage-collection-in-go](https://www.ardanlabs.com/blog/2018/12/garbage-collection-in-go-part1-semantics.html) , [scheduling-in-go](https://www.ardanlabs.com/blog/2018/08/scheduling-in-go-part2.html) , [channel-closing](https://go101.org/article/channel-closing.html) , [Understanding Channels](https://www.google.com.hk/search?q=kavya%20golang#fpstate=ive&vld=cid:089b5108,vid:KBZlN0izeiY)



### æµ‹è¯•

åŸºæœ¬åŠŸèƒ½é€»è¾‘æµ‹è¯•ï¼Œå¹¶å‘åœºæ™¯ä¸‹çš„æ‰£å‡å’Œæ–°å¢æ•°æ®ä¸€è‡´ï¼›ç„¶ååŠ ä¸Š ä¸šåŠ¡/åŸºç¡€æœåŠ¡/ä¸­é—´ä»¶æœåŠ¡ç›‘æ§ï¼Œæ—¥å¿—ï¼Œåœ¨å¼€å§‹å‹æµ‹ï¼Œç»™å‡ºæ€§èƒ½æŠ¥å‘Šï¼Œè°ƒä¼˜ï¼›æœ€ç»ˆç»™å‡ºæ¥å£/æ•´ä½“æœåŠ¡ååå’Œå»¶æ—¶ä¸Šé™ï¼Œé‡‡ç”¨æœåŠ¡æµæ§å¯¹æœåŠ¡æ¥å£åŠ ä¸Šæ¥å£/æœåŠ¡é™æµï¼Œä»¥åŠè¶…æ—¶é‡è¯•ï¼ŒæœåŠ¡ç›¸å…³é™çº§ç­–ç•¥ï¼›ç„¶åæ¨¡æ‹Ÿçº¿ä¸Šåœºæ™¯ç»§ç»­å‹æµ‹ï¼Œè§¦å‘å¯¹åº”æŠ¥è­¦å’Œé™æµï¼Œé™çº§ç­–ç•¥ï¼›

1. æ¨¡å—æµ‹è¯•, ä¸»è¦æ˜¯ pkgä¸­çš„åŸºç¡€å‡½æ•°benchmarkæµ‹è¯•ï¼Œä»¥åŠinternalä¸­çš„ä¸šåŠ¡é€»è¾‘æµ‹è¯•

2. åŠ ä¸ŠæœåŠ¡ç›‘æ§ï¼Œæ—¥å¿—ï¼ŒæŠ¥è­¦ï¼Œé‡ç‚¹å…³æ³¨æ ¸å¿ƒé“¾è·¯æŒ‡æ ‡ï¼šèµ„æºU.S.E, åº”ç”¨R.E.D; å‚è€ƒ: [**Monitoring SREâ€™s Golden Signals**](http://www.infoq.com/articles/monitoring-SRE-golden-signals), [monitoring_golden-signals L.E.T.S](https://sre.google/sre-book/monitoring-distributed-systems/#xref_monitoring_golden-signals)

3. å•ä¸ªæ¥å£å‹æµ‹, ä¸»è¦æ˜¯æ¥å£ä¸­æ“ä½œæ•°æ®ä¸­å¿ƒdbçš„è¯»å†™ååï¼Œä»¥åŠå¼•å…¥ç¼“å­˜åï¼Œè¿›è¡Œå¼‚æ­¥å¤„ç†çš„è¯»å†™åå

4. æ ¸å¿ƒå‰ç«¯æ¥å£æ•´ä½“å‹æµ‹, éœ€è¦æµé‡å’Œæ•°æ®å­˜å‚¨ç¯å¢ƒéš”ç¦»ï¼Œæ•´ä½“é€šè¿‡æœåŠ¡æ²»ç†æ¡†æ¶è¿›è¡Œæµæ§ï¼Œæ‰“ä¸Šstressæ ‡ç­¾æŸ“è‰²ï¼Œè¯·æ±‚æµé‡å’Œæ•°æ®æµé€šè¿‡stressæ ‡ç­¾å°†æ•°æ®å­˜æ”¾äºå½±å­é€»è¾‘å­˜å‚¨(cache KV, è¡¨/é›†åˆ/ç´¢å¼•ï¼Œé˜Ÿåˆ—)ä¸­; å‚è€ƒï¼š[Rhino](https://mp.weixin.qq.com/s/vofrpFGvnptj3MNAv1hQ-w) [Quake](https://tech.meituan.com/2018/09/27/quake-introduction.html)

5. æ··æ²Œæµ‹è¯•ï¼Œå°½é‡è¦†ç›–è§¦å‘è¾¹ç•Œåœºæ™¯ï¼Œé¢å‘æ•…éšœç¼–ç¨‹ï¼Œæµ‹è¯•; å‚è€ƒï¼š[æ··æ²Œå·¥ç¨‹å®è·µ](https://mp.weixin.qq.com/s/kZ_sDdrbc-_trVLNCWXyYw)

6. ä¸šåŠ¡åŠŸèƒ½è°ƒä¼˜ï¼šä¼˜å…ˆä¸šåŠ¡åŠŸèƒ½å¤§æ–¹å‘è°ƒä¼˜ï¼Œåˆ†å¸ƒå¼æ•°æ®åº“ä¸‹çš„æŸ¥è¯¢è¯­å¥ï¼Œç®—å­ä¸‹æ¨ï¼Œç´¢å¼•æ•ˆç‡ (ç©ºé—´æ¢æ—¶é—´ï¼Œk/v æ“ä½œ B+tree,LSM-tree)

7. Profiling è°ƒä¼˜ï¼šé€šè¿‡ç›¸å…³trace/perfå·¥å…·å…³æ³¨è€—æ—¶ï¼Œä½¿ç”¨ç³»ç»Ÿå†…æ ¸ä¼˜åŒ–çš„è°ƒç”¨å‡½æ•°ï¼Œä»¥åŠç³»ç»Ÿå‚æ•°è°ƒæ•´ï¼Œå†…å­˜(å‡å°‘gcï¼Œé¢‘ç¹æ“ä½œå°å¯¹è±¡æ± åŒ–å¤ç”¨ï¼Œå†…å­˜åˆ†é…ç®¡ç†ï¼Œå±€éƒ¨æ€§åŸåˆ™)ï¼Œcpu(äº²å’Œæ€§)ï¼ŒI/O(ç½‘ç»œï¼Œç£ç›˜I/O å°½é‡å¼‚æ­¥å¤„ç†,) ï¼Œbuff(ç¼“å†²ï¼Œbatch)ç­‰

   tips: ä¸šåŠ¡æ•´ä½“è®¾è®¡æ–¹æ¡ˆokçš„æƒ…å†µä¸‹ï¼ŒåŒæœºæˆ¿æ•´ä½“æ€§èƒ½ä¼˜åŒ–æ”¶ç›Šï¼š ç¡¬ä»¶(cpu/GPUæµ®ç‚¹è¿ç®—/TPUï¼Œå†…å­˜/nvmï¼Œç£ç›˜/ssdï¼Œç½‘å¡å¸¦å®½æ‹†è§£åŒ…æ ¡éªŒ) > å†…æ ¸ç³»ç»Ÿè°ƒç”¨ > ä¸šåŠ¡ä»£ç (æ•°æ®ç»“æ„,è¯­è¨€å±‚é¢ç¼–è¯‘ä¼˜åŒ–opcode)

   

## æ€»ç»“

é¢å¯¹å¤§é‡å¹¶å‘è¯·æ±‚çš„ç”¨æˆ·äº¤äº’åœºæ™¯ï¼Œæ¶‰åŠåˆ°ç”¨æˆ·é‡‘é¢ç­‰äº‹åŠ¡åœºæ™¯ï¼Œæ•´ä½“æ€è·¯æ˜¯é¢„çƒ­å¿«é€Ÿè·¯å¾„å“åº”ç”¨æˆ·çš„äº¤äº’è¯·æ±‚è¡Œä¸ºï¼Œç„¶åå¼‚æ­¥é˜Ÿåˆ—è§£è€¦ï¼Œæ‰§è¡Œæ…¢è·¯å¾„ï¼Œæ…¢è·¯å¾„ä¸Šé€šè¿‡æœ¬åœ°äº‹åŠ¡(åŒæœåŠ¡å¤šè¡¨æ›´æ–°)ï¼Œæˆ–è€…åˆ†å¸ƒå¼äº‹åŠ¡(å¤šæœåŠ¡å¯¹åº”è¡¨æ›´æ–°)ï¼Œæ¥ä¿è¯æ•°æ®æ•´ä½“ä¸€è‡´ï¼Œå°½é‡é€šè¿‡æ‰¹é‡å¤„ç†(å•åˆ†ç‰‡äº‹åŠ¡ç»„æäº¤)æé«˜ååï¼›å¿«è·¯å¾„å°½é‡ä½¿ç”¨åŸå­æ“ä½œ(æœåŠ¡ä¸»é€»è¾‘å•çº¿ç¨‹æ‰§è¡Œ)æˆ–è€…ä¹è§‚é”ç”¨æˆ·ç¨‹åºè‡ªæ—‹æ‰§è¡Œäº‹åŠ¡ï¼ŒæŒ‰ç”¨æˆ·ç»´åº¦åˆ‡åˆ†å‡å°‘block, ä»¥åŠé€šè¿‡æå‰è§„åˆ’åˆ†å¸ƒå¼å­˜å‚¨å‡åŒ€æ‰“æ•£è¯»å†™çƒ­ç‚¹(åˆ†åº“åˆ†è¡¨åˆ†åŒºåˆ†ç‰‡/æ§½Region/Slot)ï¼Œè§„é¿èŠ‚ç‚¹è´Ÿè½½å€¾æ–œä¸å‡è¡¡é—®é¢˜(å¤§æµé‡,å¤§æ•°æ®),å¤šç»´åº¦æŸ¥è¯¢çš„è¯å¯ä»¥é‡‡ç”¨æ•°æ®å¼‚æ„æ–¹å¼(ç©ºé—´æ¢æ—¶é—´)ï¼Œå¦‚æœæ¶‰åŠåˆ°è·¨æ•°æ®ä¸­å¿ƒåˆ™éœ€è¦è€ƒè™‘æ•°æ®åŒæ„è¿ç§»é—®é¢˜(æ¯”å¦‚å›½é™…åŒ–æ•°æ®éšç§*PIPL* *GDPR*)ï¼›å¯¹äºæ•°æ®å¹¶å‘åŒæ­¥è·å–è‡³ç¼“å­˜ï¼Œåˆ™éœ€è¦åŠ åˆ†å¸ƒå¼äº’æ–¥é”è‡ªæ—‹blockä¸€æ®µæ—¶é—´ï¼Œé˜²æ­¢å¹¶å‘æ“ä½œåŠ é”å°½é‡å‰ç½®å¤„ç†(warm up to run fast~),å‡å°‘blockï¼›æœ¬è´¨ä¸Šéƒ½æ˜¯å°†å¹¶è¡Œå˜æˆä¸²è¡Œï¼Œåªä¸è¿‡å†…å­˜æ“ä½œæ¯”ç£ç›˜,ç½‘ç»œIOæ“ä½œè¦å¿«å¾ˆå¤š(ç†è®ºä¸Šï¼Œluaè„šæœ¬åœ¨masterä¸»çº¿ç¨‹å†…å­˜ä¸­åŸå­æ‰§è¡Œç›¸å¯¹watch+äº‹åŠ¡æ–¹å¼å¤„ç†æ•ˆç‡è¦é«˜äº›)ï¼›è¿˜æœ‰æœåŠ¡å¼‚å¸¸æ—¶çš„é™çº§æªæ–½ï¼Œä»¥åŠæœåŠ¡è¿‡è½½æ—¶çš„é™æµï¼Œä»¥åŠæ¶ˆæ¯æ•°æ®æµçš„åå‹æªæ–½ã€‚

é¢˜å¤–è¯ï¼šæ²¡æœ‰é“¶å¼¹ï¼Œå……åˆ†åˆ©ç”¨å¼€æº(å·¥ç¨‹è§„èŒƒ) â˜ï¸çº¢åˆ©(ç¡¬ä»¶è®¡ç®—å­˜å‚¨èµ„æº)ï¼› *çº¸ä¸Šå¾—æ¥ç»ˆè§‰æµ…ï¼Œç»çŸ¥æ­¤äº‹è¦èº¬è¡Œ*ï¼Œ step by step, maybe day day up~  hope expand your horizons



## å‚è€ƒ

1. https://mp.weixin.qq.com/s/Cmw3QExqCfBAz9V0AlsS9A

2. https://aws.amazon.com/cn/builders-library/timeouts-retries-and-backoff-with-jitter/

3. https://mp.weixin.qq.com/s/jznfR9Jc-U-uCXioHXjeew , https://mp.weixin.qq.com/s/AV4E0Y9d4k5VYTL7n2TNug , https://mp.weixin.qq.com/s/cT9b2GDsUinVNoA6gyqs_g

4. http://www.52im.net/thread-3515-1-1.html#26 , http://www.52im.net/thread-3994-1-1.html , http://www.52im.net/thread-3376-1-1.html

5. https://coolshell.cn/articles/8239.html, https://time.geekbang.org/column/article/4050

6. **https://redis.io/docs/manual/transactions/ , https://redis.io/docs/manual/programmability/ , https://redis.io/docs/reference/cluster-spec/ , https://redis.com/blog/redis-clustering-best-practices-with-keys/**

7. https://martinfowler.com/articles/serverless.html  https://jimmysong.io/kubernetes-handbook/usecases/serverless.html , https://www.youtube.com/playlist?list=PL2yQDdvlhXf_lYR5Ntvr9V5iVYv5rcbNc

8. https://github.com/apache/incubator-kvrocks/wiki/Kvrocks-%E9%9B%86%E7%BE%A4%E6%96%B9%E6%A1%88%E7%AE%80%E4%BB%8B  https://www.qin.news/kvrocks-qian-xi/

9. **https://tidb.net/blog/09cc69f4 , https://cn.pingcap.com/best-practice-detail/best-practices-for-developing-applications-with-tidb** 

10. **https://mp.weixin.qq.com/s/UFWULymSblrs1hIGP5e7YQ , https://github.com/apache/rocketmq/wiki/RIP-50-RocketMQ-Transaction-Message-Improvement** , **https://xie.infoq.cn/article/ad16bac16b4c172e268225cfa**

11. https://www.youtube.com/playlist?list=PLy7NrYWoggjziYQIDorlXjTvvwweTYoNC , https://www.youtube.com/watch?v=vgPFzblBh7w&list=PL8t1FdN2Tj3ZVAzTY-FvsS0qy-mEfRdoj&index=5 , https://www.youtube.com/watch?v=-U9E1PhrM3o

12. **https://tonybai.com/2022/08/15/developing-kubernetes-operators-in-go-part1/**

13. **https://github.com/istio/istio/tree/master/samples/bookinfo , https://github.com/cloudwego/biz-demo**

14. https://mp.weixin.qq.com/s/n4eVf2KZRIp2yKACk88qJA
